<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Federal Business Development Dashboard</title>
    <!-- Include all necessary libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
    <!-- NEW: Add required plugins for enhanced features -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0/dist/chartjs-chart-treemap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background-color: #f5f7fa;
            padding: 20px;
        }
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .dashboard-title {
            color: #2c3e50;
            font-size: 24px;
            font-weight: 600;
        }
        .dashboard-subtitle {
            color: #7f8c8d;
            font-size: 16px;
            margin-top: 5px;
        }
        .file-input-container {
            margin-bottom: 20px;
            padding: 25px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        .file-input-heading {
            font-size: 20px;
            margin-bottom: 10px;
            color: #2c3e50;
            text-align: center;
        }
        .file-input-instructions {
            margin-bottom: 20px;
            color: #7f8c8d;
            font-size: 16px;
            text-align: center;
        }
        .file-input-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        .file-input-button {
            display: inline-block;
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .file-input-button:hover {
            background-color: #2980b9;
        }
        input[type="file"] {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }
        #file-name-display {
            padding: 8px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-width: 250px;
            text-align: left;
            color: #666;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        .dashboard-card {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .full-width {
            grid-column: span 2;
        }
        .flex-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .search-container {
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }
        .search-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .results-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 10px;
        }
        .result-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
            position: relative;
        }
        .result-item:hover {
            background-color: #f8f9fa;
        }
        .result-item:last-child {
            border-bottom: none;
        }
        .stat-card {
            flex: 1;
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #2980b9;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            color: #7f8c8d;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 60px;
            font-weight: 600;
            color: #7f8c8d;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden {
            display: none !important;
        }
        .metric-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .filter-btn {
            padding: 6px 12px;
            background-color: #f1f1f1;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .filter-btn.active {
            background-color: #2980b9;
            color: white;
        }
        #mapContainer {
            height: 400px;
            width: 100%;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 14px;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        .view-details-btn {
            display: inline-block;
            padding: 4px 8px;
            background-color: #2980b9;
            color: white;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 5px;
        }
        #activeFilterIndicator {
            background-color: #f8f9fa;
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .clear-filter-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .error-message {
            color: #e74c3c;
            text-align: center;
            padding: 10px;
            font-weight: 600;
            background-color: #fadbd8;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success-message {
            color: #27ae60;
            text-align: center;
            padding: 10px;
            font-weight: 600;
            background-color: #d5f5e3;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status-message {
            text-align: center;
            padding: 10px;
            font-weight: 500;
            background-color: #f8f9fa;
            border-radius: 4px;
            margin: 10px 0;
            color: #7f8c8d;
        }
        .download-link {
            margin-top: 15px;
            text-align: center;
        }
        .download-link a {
            color: #2980b9;
            text-decoration: none;
            display: inline-block;
            padding: 10px 15px;
            background-color: #f5f7fa;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .download-link a:hover {
            background-color: #e8eaed;
            text-decoration: underline;
        }
        #manual-upload-section {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .highlight-section {
            animation: highlight-pulse 2s ease-in-out;
        }
        @keyframes highlight-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
            50% { box-shadow: 0 0 0 8px rgba(231, 76, 60, 0.3); }
        }

        /* NEW STYLES FOR ENHANCED FEATURES */
        .tab-container {
            margin-bottom: 20px;
        }
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }
        .tab {
            padding: 10px 15px;
            background-color: #f5f7fa;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 600;
            border: 1px solid #ddd;
            border-bottom: none;
        }
        .tab.active {
            background-color: #fff;
            color: #2980b9;
            border-bottom: 2px solid #fff;
            position: relative;
            z-index: 1;
        }
        .tab-content {
            background-color: #fff;
            border-radius: 0 8px 8px 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            min-height: 400px;
            border: 1px solid #ddd;
            margin-top: -1px;
        }
        .tab-page {
            display: none;
        }
        .tab-page.active {
            display: block;
        }
        
        /* Treemap styles */
        .chart-legend {
            display: flex;
            justify-content: center;
            margin-top: 10px;
            gap: 20px;
        }
        .legend-item {
            display: flex;
            align-items: center;
        }
        .legend-color {
            display: inline-block;
            width: 15px;
            height: 15px;
            margin-right: 5px;
        }

        /* Calendar styles */
        .calendar-container {
            display: flex;
            flex-direction: column;
            height: 450px;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
        }
        .calendar-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .calendar-nav-btn {
            padding: 6px 12px;
            background-color: #f1f1f1;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            height: 100%;
            overflow-y: auto;
        }
        .calendar-day {
            min-height: 80px;
            background-color: #f8f9fa;
            border-radius: 4px;
            padding: 5px;
            font-size: 12px;
        }
        .calendar-day-header {
            font-weight: 600;
            text-align: center;
            padding: 5px 0;
            background-color: #2980b9;
            color: white;
            border-radius: 4px;
        }
        .calendar-date {
            font-weight: 600;
            margin-bottom: 5px;
        }
        .calendar-event {
            padding: 3px 5px;
            background-color: #3498db;
            color: white;
            border-radius: 3px;
            margin-bottom: 3px;
            font-size: 11px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .calendar-event:hover {
            background-color: #2980b9;
        }
        .event-tooltip {
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-width: 300px;
            display: none;
        }
        
        /* Prime profile card styles */
        .prime-card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
            max-height: 650px;
            overflow-y: auto;
        }
        .prime-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .prime-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .prime-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        .prime-card-name {
            font-weight: 600;
            font-size: 16px;
            color: #2c3e50;
        }
        .prime-card-actions {
            display: flex;
            gap: 5px;
        }
        .prime-card-action {
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 11px;
        }
        .prime-card-body {
            font-size: 13px;
            color: #555;
        }
        .prime-card-stat {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .prime-card-footer {
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
        }
        .prime-card-tag {
            display: inline-block;
            background-color: #e8eaed;
            padding: 2px 6px;
            border-radius: 10px;
            margin-right: 5px;
            margin-bottom: 5px;
            font-size: 11px;
        }
        .prime-card-tags {
            margin-top: 10px;
        }

        /* Map styles */
        .map-container {
            height: 450px;
            position: relative;
            overflow: hidden;
            border-radius: 8px;
        }
        .map-base {
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA5ODAgNjEwIj48cGF0aCBmaWxsPSIjZjhmOWZhIiBzdHJva2U9IiNkZGQiIGQ9Ik0yMTMsNDg1LjVsLTEwLTEuNWwtNi41LTguNWwtMi0xMC41bC01LTUuNWwtMS41LTctNS0yLTUtNy01LTJsLTExLjUtNy41bDIuNS0xMGwtOS0xMy41YzAsMCwtMi41LTMuNSwtMy01LjVzLTIsLTctMiwtN2wzLjUtOGwxMS0xMWwxMS41LDNsNC41LDdsNS41LDEuNWwzLTUuNWwyLTkuNWwtMi41LTlsLTctN2wtMi41LTExLjVsOS0ybDUtMC41bDQuNS01LjVsLTIuNS0xNC41bDQsLTIzLjVsLTAtMTFsLTcuNS0xMGwtMS41LTExLjVsLTguNS0xM2wtNi41LTEuNWwtNS0xM2wtMTMsMWwtMTAuNS03LjVsLTEsLTExLjVsLTQuNS0xMWwtMTEtNi41bC05LTAuNWwtMTAuNSw2bC01LDE2LjVsLTUuNSwxM2wtMTAsLTEwLjVsLTEzLDZsLTYuNSw4LjVsLTEzLDRsLTE2LDkuNWwtMTAuNSwxM2wtNiwxbC0zLDEwLjVsMi41LDEzLjVsLTAuNSw5bC03LjUsMTkuNWwtMTUsMy41bC01LjUsOGwtMTUuNSw0LjVsLTgsNGwtMTkuNSwxLjVsLTguNSw0LjVsLTE1LDExLjVsLTIuNSwxOGw3LDE4LjVsOC4yLDUtMywxMGwxOCw3bDQuNSw3LjVsMTMuNSw0LjVsNi41LDExLjVsMTAsMTFsNi41LDEwLjVsOC4zLDEwLjVsOS41LDEwLjVsNy41LDExLjVsMCw5bDYsMGwxMi41LDVsMTMsMGw2LDguNWw5LjUsNmwxNC41LDguNWwxNy41LDVsMTIsNC41bDIwLDEwLjVsMTIuNSwxMy41bDIuNSw3LjVsMTEuNSwxMmwxMSw2LjVsOCwxbDEuNSw2LjVsLTQuNSw5bDIsOGwxMSw4bDYsMTJsMTYsOGw1LTYuNWwwLTlsMTMsLTEwLjVsMTMsLTEzLjVsNC0wLjVsNi41LDJsLTEsMTUuNWw2LjUsLTRsOS41LC0xMC41bDEwLC0xNC41bC01LC0xMmwtMTIuNSwtMTVsMS41LC0xMC41bC04LC0zLjVsLTUsLTEybDEwLC05TDIxMyw0ODUuNXoiLz48cGF0aCBmaWxsPSIjZjhmOWZhIiBzdHJva2U9IiNkZGQiIGQ9Ik02OTYuNSwxOTYuNWwtMTEtMTEuNWwtNS41LTExbC0xMi01LjVsLTEwLjUsLTJsLTEyLDYuNWwtNi41LDIuNWwtNi41LTEuNWwtMjYtNWwtMTAuNS0xMmwtMTQsLTJsLTYsMGwtNS41LDNsLTExLDNsLTI3LC0xMWwtMTIuNSw0LjVsLTgsLTFsLTEzLDEzbC05LDExbC01LC0xbC00LC05LjVsLTguNSwwbC0xOC41LC0wLjVsLTcuNSwtNmwtOC41LC0xMWwtMzEsLTkuNWwtNiwxMGwtOCwxLjVsLTMsLTEuNWwtMzgsLTQzLjVsLTQsLTEybC0xMC41LC00LjVsLTkuNSwtMC41bC05LC01LjVsLTE4LDEuNWwtMTIsMTBsLTI0LDFsLTYuNSwxMGwtMjUuNSw3LjVsLTYuNSwxMy41bC0yLDEwbC0xMiw5bC0zLDEwLjVsMS41LDhsLTEwLjUsMy41bC0wLjUsMTEuNWwtNy41LDYuNWwtNy41LDIwLjVsLTE0LjUsMTEuNWwtMTQsNGwtOS41LDExLjVsLTEwLDIuNWwtMTYuNSwtMS41bC0xMy45LC0xMS41bC0xMS41LDFsLTExLDYuNWwtMTgsNGwtMyw4LjVsLTcuNiw2LjVsLTkuNSw5LjVsLTAuNSw5LjVsLTYsMGwtMTAsNS41bC0yLDUuNWwtMTEuNSw3bC0xMS41LDEybC03LDEzbC02LjUsOC41bC0xMi41LC0yLjVsLTUuNSwtOWwtNC4yLC0xNS41bC04LjUsLTEyLjVsLTIuMywtMTJsMTEuNSwtMy41bDkuNSwtOS41bDYuNSwtMTFsMC41LC0xM2wtNSwtMTQuNWwtNC44LC0xMmwtNy41LC05LjVsLTEwLC0xMGwtNi0xMy41bC05LjUsMGwtNiwxMGwtOCw0LjVsLTYuNSw5LjVsMSw5LjVsLTgsNGwtMTYsLTYuNWwtMTcsLTFsLTEwLC0zLjVsLTguNSwtMTBsLTMuNSwtMjUuNWwtNC41LC0xM2wtNS41LC0zLjVsLTEwLDJsLTEwLjUsOWwtMTgsNy41bDIuNSwtOWwtMS41LC05LjVsLTQuNSwtOGwtMTYsLTEuNWwtNywtNGwtMTAuNywtMTdsMiwtMTBsLTcsLTkuNWwtMC41LC05bC01LjgsLTRsLTcuNSwtMTFsLTcsLTMuNWwtMTMsN2wxNC41LDIwLjVsMSw5LjVsLTEuNSw5LjVsLTkuNSw5LjVsLTQsMTEuNWwtMTEuNSw5bC00LjUsMTNsLTEuNSwxMi41bC02LjgsMS41bDIuMywyOGwzLjUsMTNsNiwyLjVsNywxMmw5LjUsMWwxNy41LDEwLjVsMyw3LjVsLTQsMTQuNWwtNC41LDkuNWwtMC41LDlsNy4yLDEyLjVsMiw5LjVsLTUsMTcuNWwxLjgsMTQsNSwxM2wtMSwxMGwzLjUsMTMuNWw5LjUsMTMuNWwwLDExbDQsMTNsOC41LDE0LjVsMTIuNSwxOGw1LDEwLjVsOC41LDEwLjVsMi41LDEwLjVsLTEsMThsNiwxOGwxNyw4LjVsLTEuNSw5bDQsMTBsNy41LDEuNWwxOS41LDE1LjVsMTEuNSwyNGwxMS41LDAuNWwxMC41LDguNWw4LDEuNWw1LjUsMTAuNWw3LjUsMTBsNiwybC0xLjUsMTkuNWwxLjUsMTJsLTcuNSwxM2wtMiw4LjVsLTExLjUsMTFsLTUsOGwxLDExbDIxLDE0LjVsNiwzbDcuNSwtNC41bDYsOWwxOCw3bDMsMTlsMCwxMGwxNyw2bDYuNiw5LjVsMTYuOSw3LDUsMTRsMTMuNSwtMmwxNSwtNmwxMS41LS41bDcuNSwxMWwyNCwxNi41bDIsMTJsMTkuNSw4bDQuNSw3LjVsNi41LDFsMTAuNSwtOGwxNC41LDVsNywxNC41bDEzLDExLjVsMTIuNSw0LjVsMTQuNSwybDEwLC0xMGwxMywyLjVsMTIuNSwtNC41bDkuNSw2bDEwLDZsMTMsLTVsLTIuNSwtOS41bDMsLTExLjVsNy41LC02LjVsNiwwbDYuNSw3LjVsMTYuNSwtMS41bDgsMmwtNi41LC0xM2wxLC0xM2wtMy41LC0xMi41bC01LC0xMS41bDYsLTcuNWwtMC41LC05LjVsLTgsLTEwbC0xLC0xMC41bDYuNSwtMTJsLTMuNSwtMjkuNWwtNC41LC0xN2wtMTAuNSwtNi41bC00LjUsLTEyLjVsNi41LC05LjVsLTAsLTEwbC01LC0xMC41bC0xLC0xM2w2LC0xOGwxLjUsLTE0LjVsLTIuNSwtOGwtMTEsLTkuNWwxMi41LC02LjVsLTUsLTEwLjVsLTEuNSwtOWwtMTEsLTExLjVsMTAsLTEwbDMsLTExLjVsLTIsLTEwLjVsLTYuNSwtOC41bC0xNywtOGwxLjUsMTJsLTIuNSw5bC05LDJsLTUuNSwxMGwtNy41LC0xNWwzLC0xM2wtNSwtOC41bDUuNSwtMTBsOCwtNi41bDgsMGwxMiwtN2wwLC0xMC41bDUuNSwtOGwxMC41LDFsMTMsLTRsMTcuNSwybDYsLTQuNWwxNSwtMWw3LjUsNC41bDE0LC0zbDEyLjUsMmw1LC0xLjVsNywtMThsMjMuNSwtMGwxMC41LC0xMS41bDcsLTFsMTUsMC41bDgsLTQuNWw5LC02LjVsLTIuNSwtOGwtMTAsLTRsLTYuMjUsLTYuNzVsMTEuMjUsLTEuNzVsNy41LDJsNSwxNC41bDcsOC41bDQuNSw4LjVsLTEuNSw5LjVsNiw5LjVsNy41LDRMNjk2LjUsMTk2LjV6Ii8+PHBhdGggZmlsbD0iI2Y4ZjlmYSIgc3Ryb2tlPSIjZGRkIiBkPSJNODgwLDI0MGwtMTAuNSwtMTMuNWwtMTMuNSwtNC41bC0xMSwtMTIuNWwtNywtOGwtMTUsLTYuNWwtNy41LC0xMS41bC0xNSwtMi41bC0xMywtMTdsLTEwLC01bC0xMywtMy41bC05LC0zLjVsLTgsMS41bC0xMy41LC0zbC03LDEuNWwtOS41LC0xLjVsLTkuNSwtNy41bC0xNSwxLjVsLTEwLjUsLTNsLTEzLjUsNmwtNy41LC0xLjVsLTExLjUsNS41bC05LC0zbC01LjUsMTVsLTQuNSw2LjVsLTgsMTJsLTgsNmwtMTYsOGwtMTYuNSwyLjVsLTE0LC0wLjVsLTExLjcsMTUuNWwxNS43LDIuNWw2LDExLjVsMTIuNSwzbDEzLDZsNy41LDguNWw2LDEzbDEyLjUsM2w5LjUsMTIuNWwxMS41LDcuNWwxMS41LS01bDMsMTAuNWwxNC41LC0wLjVsMTQsNWwxNy41LC01bDEyLjUsNy41bDEwLC0xMi41bDkuNSwwbDQsOGwxMywxLjVsNi41LC00bDEyLjUsMi41bDExLC0xLjVsNC41LDVsMTAsLTAuNWwxNi41LC01bDkuNSwzbDI0LC02LjVsMTMuNSw2LjVsMTUsLTAuNWwyMi41LC04LjVsMC41LC0yOGwxMiwtMi41bDYuNSwtNS41bDEwLjUsLTQuNWwyLC01LjVsMTEsLTcuNUw4ODAsMjQweiIvPjwvc3ZnPg==');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        .map-marker {
            position: absolute;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #e74c3c;
            transform: translate(-50%, -50%);
        }
        .map-legend {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 12px;
        }
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1;
        }
        .region-table {
            margin-top: 15px;
            max-height: 250px;
            overflow-y: auto;
        }
        
        /* Subcontracting plan styles */
        .subplan-chart-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .subplan-chart {
            flex: 1;
            height: 300px;
        }
        .subplan-table {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        .subplan-info {
            background-color: #f5f7fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.5;
        }
        
        /* Filter panel styles */
        .filter-panel {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .filter-panel-title {
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .filter-group {
            margin-bottom: 15px;
        }
        .filter-label {
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 12px;
        }
        .filter-select, .filter-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        .filter-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .filter-btn-apply {
            background-color: #2980b9;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        .filter-btn-clear {
            background-color: #f1f1f1;
            color: #555;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .modal-title {
            font-weight: 600;
            font-size: 18px;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        .modal-body {
            margin-bottom: 15px;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Expert mode toggle */
        .expert-mode-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #2980b9;
            color: white;
            padding: 8px 12px;
            border-radius: 50px;
            font-size: 13px;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            .full-width {
                grid-column: span 1;
            }
            .flex-row {
                flex-direction: column;
            }
            .tab-container {
                overflow-x: auto;
            }
            .tabs {
                min-width: 600px;
            }
            .prime-card-container {
                grid-template-columns: 1fr;
            }
            .subplan-chart-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="dashboard-header">
            <div>
                <h1 class="dashboard-title">Federal Business Development Dashboard</h1>
                <p class="dashboard-subtitle">Prime to Subcontractor Teaming Opportunities</p>
            </div>
        </div>

        <div class="file-input-container">
            <div id="autoload-section">
                <div id="processingIndicator" class="loading">
                    <div class="spinner"></div>
                    <span>Processing data...</span>
                </div>
                <p id="autoload-status" class="status-message">Attempting to load data from S3 bucket...</p>
            </div>
            
            <div id="manual-upload-section" class="hidden">
                <h3 class="file-input-heading">Upload Federal Contractor CSV Data</h3>
                <p class="file-input-instructions">If auto-loading fails or you want to use a different file, you can manually upload <code>sbaall.csv</code></p>
                
                <div class="file-input-wrapper">
                    <input type="file" id="csvFileInput" accept=".csv">
                    <label for="csvFileInput" class="file-input-button">Choose CSV File</label>
                    <span id="file-name-display">No file selected</span>
                </div>
                
                <div id="errorMessage" class="error-message hidden">
                    Error processing file.
                </div>
                <div id="successMessage" class="success-message hidden">
                    File processed successfully.
                </div>
                
                <div class="download-link">
                    <a href="https://subhoodata.s3.us-east-1.amazonaws.com/data/sbaall.csv" download>Download sbaall.csv from S3</a>
                </div>
            </div>
        </div>
        
        <div id="dashboardContent" class="hidden">
            <div class="flex-row">
                <div class="stat-card">
                    <div class="stat-value" id="totalContractsValue">0</div>
                    <div class="stat-label">Total Contracts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalValueValue">$0</div>
                    <div class="stat-label">Total Contract Value</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgContractValue">$0</div>
                    <div class="stat-label">Average Contract Value</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="uniquePrimesValue">0</div>
                    <div class="stat-label">Unique Prime Contractors</div>
                </div>
            </div>

            <!-- NEW: Enhanced Filter Panel -->
            <div class="filter-panel">
                <div class="filter-panel-title">Advanced Filtering Options</div>
                <div class="flex-row" style="margin-bottom: 10px;">
                    <div class="filter-group" style="flex: 1;">
                        <div class="filter-label">NAICS Code</div>
                        <select id="naicsFilter" class="filter-select">
                            <option value="">All NAICS Codes</option>
                        </select>
                    </div>
                    <div class="filter-group" style="flex: 1;">
                        <div class="filter-label">Department/Agency</div>
                        <select id="agencyFilter" class="filter-select">
                            <option value="">All Departments/Agencies</option>
                        </select>
                    </div>
                    <div class="filter-group" style="flex: 1;">
                        <div class="filter-label">State</div>
                        <select id="stateFilter" class="filter-select">
                            <option value="">All States</option>
                        </select>
                    </div>
                </div>
                <div class="flex-row" style="margin-bottom: 10px;">
                    <div class="filter-group" style="flex: 1;">
                        <div class="filter-label">Contract Type</div>
                        <select id="contractTypeFilter" class="filter-select">
                            <option value="">All Contract Types</option>
                        </select>
                    </div>
                    <div class="filter-group" style="flex: 1;">
                        <div class="filter-label">Subcontract Plan</div>
                        <select id="subcontractPlanFilter" class="filter-select">
                            <option value="">All Subcontract Plans</option>
                        </select>
                    </div>
                    <div class="filter-group" style="flex: 1;">
                        <div class="filter-label">Contract Value Range</div>
                        <select id="valueRangeFilter" class="filter-select">
                            <option value="">All Values</option>
                            <option value="0-100000">Under $100K</option>
                            <option value="100000-1000000">$100K - $1M</option>
                            <option value="1000000-10000000">$1M - $10M</option>
                            <option value="10000000-100000000">$10M - $100M</option>
                            <option value="100000000-">Over $100M</option>
                        </select>
                    </div>
                </div>
                <div class="filter-actions">
                    <button id="clearFiltersBtn" class="filter-btn-clear">Clear Filters</button>
                    <button id="applyFiltersBtn" class="filter-btn-apply">Apply Filters</button>
                </div>
            </div>

            <div class="search-container">
                <h2 class="card-title">Prime Contractor Search</h2>
                <input type="text" id="primeSearchInput" class="search-input" placeholder="Search for a prime contractor...">
                <div id="searchResults" class="results-container"></div>
            </div>
            
            <div id="activeFilterIndicator" class="hidden">
                Filtered by: [Prime Name]
                <button class="clear-filter-btn" onclick="clearPrimeFilter()">Clear Filter</button>
            </div>

            <!-- NEW: Enhanced Feature Navigation Tabs -->
            <div class="tab-container">
                <div class="tabs">
                    <div class="tab active" data-tab="dashboard">Dashboard Overview</div>
                    <div class="tab" data-tab="naics-analysis">NAICS Analysis</div>
                    <div class="tab" data-tab="recompete-calendar">Recompete Calendar</div>
                    <div class="tab" data-tab="prime-profiles">Prime Profiles</div>
                    <div class="tab" data-tab="region-finder">Regional Focus</div>
                    <div class="tab" data-tab="subplan-explorer">Subcontract Plans</div>
                </div>
                
                <div class="tab-content">
                    <!-- Dashboard Overview Tab -->
                    <div class="tab-page active" id="dashboard-tab">
                        <div class="dashboard-grid">
                            <div class="dashboard-card">
                                <h2 class="card-title">Top Prime Contractors by Contract Value</h2>
                                <div class="chart-container">
                                    <canvas id="primeContractorsChart"></canvas>
                                </div>
                            </div>

                            <div class="dashboard-card">
                                <h2 class="card-title">Department Contract Distribution</h2>
                                <div class="chart-container">
                                    <canvas id="departmentChart"></canvas>
                                </div>
                            </div>

                            <div class="dashboard-card">
                                <h2 class="card-title">NAICS Code Distribution</h2>
                                <div class="metric-filters" id="naicsFilters">
                                    <button class="filter-btn active" data-filter="count">By Count</button>
                                    <button class="filter-btn" data-filter="value">By Value</button>
                                </div>
                                <div class="chart-container">
                                    <canvas id="naicsChart"></canvas>
                                </div>
                            </div>

                            <div class="dashboard-card">
                                <h2 class="card-title">Geographic Contract Distribution</h2>
                                <div class="metric-filters" id="stateFilters">
                                    <button class="filter-btn active" data-filter="count">By Count</button>
                                    <button class="filter-btn" data-filter="value">By Value</button>
                                </div>
                                <div class="chart-container">
                                    <canvas id="stateChart"></canvas>
                                </div>
                            </div>

                            <div class="dashboard-card">
                                <h2 class="card-title">Contract Type Breakdown</h2>
                                <div class="chart-container">
                                    <canvas id="contractTypeChart"></canvas>
                                </div>
                            </div>

                            <div class="dashboard-card">
                                <h2 class="card-title">Contract Value Range Distribution</h2>
                                <div class="chart-container">
                                    <canvas id="valueRangeChart"></canvas>
                                </div>
                            </div>

                            <div class="dashboard-card full-width">
                                <h2 class="card-title">Contract Timeline Forecast</h2>
                                <div class="chart-container">
                                    <canvas id="timelineChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- NAICS Analysis Tab -->
                    <div class="tab-page" id="naics-analysis-tab">
                        <div class="dashboard-card full-width">
                            <h2 class="card-title">NAICS Code Drill-Down Analysis</h2>
                            <p style="margin-bottom: 15px; font-size: 14px;">
                                This treemap visualization helps you identify which prime contractors specialize in specific industries based on NAICS codes. 
                                Larger boxes represent higher contract values, allowing you to quickly identify the most active contractors in your industry.
                            </p>
                            <div class="chart-container" style="height: 450px;">
                                <canvas id="naicsTreemapChart"></canvas>
                            </div>
                            <div id="naicsTreemapLegend" class="chart-legend"></div>
                            
                            <div style="margin-top: 20px;">
                                <h3 style="font-size: 16px; margin-bottom: 10px;">NAICS Code Details</h3>
                                <div class="filter-group" style="max-width: 300px; margin-bottom: 15px;">
                                    <select id="naicsDetailSelector" class="filter-select">
                                        <option value="">Select a NAICS Code</option>
                                    </select>
                                </div>
                                <div id="naicsDetailContent">
                                    <p class="status-message">Select a NAICS code to view details</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recompete Calendar Tab -->
                    <div class="tab-page" id="recompete-calendar-tab">
                        <div class="dashboard-card full-width">
                            <h2 class="card-title">Recompete Opportunity Calendar</h2>
                            <p style="margin-bottom: 15px; font-size: 14px;">
                                Track upcoming contract completion dates to identify potential recompete opportunities. 
                                Plan your business development activities based on when prime contracts will be renewed.
                            </p>
                            <div class="calendar-container">
                                <div class="calendar-header">
                                    <div class="calendar-controls">
                                        <button id="calendarPrevBtn" class="calendar-nav-btn">←</button>
                                        <h3 id="calendarTitle">May 2025</h3>
                                        <button id="calendarNextBtn" class="calendar-nav-btn">→</button>
                                    </div>
                                    <div>
                                        <select id="calendarViewSelector" class="filter-select" style="max-width: 150px;">
                                            <option value="month">Monthly View</option>
                                            <option value="quarter">Quarterly View</option>
                                            <option value="year">Yearly View</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="calendarGrid" class="calendar-grid">
                                    <!-- Calendar will be generated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Prime Profiles Tab -->
                    <div class="tab-page" id="prime-profiles-tab">
                        <div class="dashboard-card full-width">
                            <h2 class="card-title">Prime Contractor Profile Cards</h2>
                            <p style="margin-bottom: 15px; font-size: 14px;">
                                Detailed profile cards for each prime contractor showing key metrics and patterns. 
                                Quickly assess potential teaming partners based on their contract history, agency relationships, and NAICS diversity.
                            </p>
                            <div class="flex-row" style="margin-bottom: 15px;">
                                <div class="filter-group" style="flex: 1; max-width: 250px;">
                                    <div class="filter-label">Sort By</div>
                                    <select id="primeCardSortBy" class="filter-select">
                                        <option value="value">Total Contract Value</option>
                                        <option value="count">Number of Contracts</option>
                                        <option value="avg">Average Contract Size</option>
                                        <option value="name">Company Name</option>
                                    </select>
                                </div>
                                <div class="filter-group" style="flex: 2;">
                                    <div class="filter-label">Quick Search</div>
                                    <input type="text" id="primeCardSearch" class="filter-input" placeholder="Type to filter prime contractors...">
                                </div>
                            </div>
                            <div class="prime-card-container" id="primeCardContainer">
                                <!-- Prime contractor cards will be generated here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Regional Focus Tab -->
                    <div class="tab-page" id="region-finder-tab">
                        <div class="dashboard-card full-width">
                            <h2 class="card-title">Regional Focus Finder</h2>
                            <p style="margin-bottom: 15px; font-size: 14px;">
                                Visualize geographic concentration of contracts to identify regional opportunities.
                                Find prime contractors that operate in your area or areas you want to target.
                            </p>
                            <div class="map-container">
                                <div class="map-controls">
                                    <select id="mapViewSelector" class="filter-select" style="max-width: 180px;">
                                        <option value="count">Contract Count</option>
                                        <option value="value">Contract Value</option>
                                    </select>
                                </div>
                                <div class="map-base" id="mapBase">
                                    <!-- Map markers will be generated here -->
                                </div>
                                <div class="map-legend" id="mapLegend">
                                    <!-- Legend will be generated here -->
                                </div>
                            </div>
                            <div class="region-table">
                                <table id="regionTable">
                                    <thead>
                                        <tr>
                                            <th>State</th>
                                            <th>Contracts</th>
                                            <th>Value</th>
                                            <th>Top Prime</th>
                                            <th>Top NAICS</th>
                                        </tr>
                                    </thead>
                                    <tbody id="regionTableBody">
                                        <!-- Table rows will be generated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Subcontract Plans Tab -->
                    <div class="tab-page" id="subplan-explorer-tab">
                        <div class="dashboard-card full-width">
                            <h2 class="card-title">Subcontracting Plan Explorer</h2>
                            <p style="margin-bottom: 15px; font-size: 14px;">
                                Identify prime contractors with mandatory small business subcontracting requirements.
                                Focus your business development efforts on primes with the highest potential for subcontracting.
                            </p>
                            <div class="subplan-info">
                                <strong>What are Subcontracting Plans?</strong> Federal contracts over $750,000 ($1.5M for construction) typically require prime contractors 
                                to have subcontracting plans that specify goals for small business participation. These plans are a legal commitment 
                                by the prime contractor to provide subcontracting opportunities for small businesses across various socioeconomic categories.
                            </div>
                            <div class="subplan-chart-container">
                                <div class="subplan-chart">
                                    <h3 style="font-size: 14px; margin-bottom: 10px; text-align: center;">Subcontracting Plan Types</h3>
                                    <div class="chart-container">
                                        <canvas id="subplanTypesChart"></canvas>
                                    </div>
                                </div>
                                <div class="subplan-chart">
                                    <h3 style="font-size: 14px; margin-bottom: 10px; text-align: center;">Top Departments with Subcontracting Plans</h3>
                                    <div class="chart-container">
                                        <canvas id="subplanDepartmentsChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <h3 style="font-size: 16px; margin: 15px 0 10px;">Prime Contractors with Subcontracting Plans</h3>
                            <div class="subplan-table">
                                <table id="subplanTable">
                                    <thead>
                                        <tr>
                                            <th>Prime Contractor</th>
                                            <th>Subcontract Plan Type</th>
                                            <th>Contract Count</th>
                                            <th>Total Value</th>
                                            <th>Top NAICS</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="subplanTableBody">
                                        <!-- Table rows will be generated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal for detailed views -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Details</h2>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Modal content will be generated here -->
            </div>
            <div class="modal-footer">
                <button class="filter-btn-clear" id="modalCloseBtn">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Expert mode toggle -->
    <div class="expert-mode-toggle" id="expertModeToggle">
        Expert Mode: Off
    </div>

    <script>
        // --- DOM Elements ---
        const processingIndicator = document.getElementById('processingIndicator');
        const autoloadStatus = document.getElementById('autoload-status');
        const manualUploadSection = document.getElementById('manual-upload-section');
        const dashboardContent = document.getElementById('dashboardContent');
        const csvFileInput = document.getElementById('csvFileInput');
        const fileNameDisplay = document.getElementById('file-name-display');
        const errorMessageDiv = document.getElementById('errorMessage');
        const successMessageDiv = document.getElementById('successMessage');

// --- Global Variables ---
let parsedData = [];
const charts = {};
let activeFilter = null;
let expertMode = false;
const S3_CSV_URL = 'https://subhoodata.s3.us-east-1.amazonaws.com/data/sbaall.csv';

// --- State Coordinates for Map (approximate centers) ---
const stateCoordinates = {
    'AL': {x: 575, y: 330}, 'AK': {x: 120, y: 240}, 'AZ': {x: 165, y: 310},
    'AR': {x: 500, y: 320}, 'CA': {x: 75, y: 250}, 'CO': {x: 300, y: 250},
    'CT': {x: 790, y: 170}, 'DE': {x: 760, y: 210}, 'FL': {x: 650, y: 380},
    'GA': {x: 620, y: 330}, 'HI': {x: 250, y: 380}, 'ID': {x: 180, y: 180},
    'IL': {x: 520, y: 240}, 'IN': {x: 560, y: 240}, 'IA': {x: 470, y: 220},
    'KS': {x: 420, y: 270}, 'KY': {x: 580, y: 270}, 'LA': {x: 490, y: 360},
    'ME': {x: 830, y: 130}, 'MD': {x: 740, y: 220}, 'MA': {x: 800, y: 160},
    'MI': {x: 560, y: 190}, 'MN': {x: 470, y: 170}, 'MS': {x: 530, y: 340},
    'MO': {x: 490, y: 270}, 'MT': {x: 250, y: 150}, 'NE': {x: 420, y: 230},
    'NV': {x: 130, y: 220}, 'NH': {x: 810, y: 150}, 'NJ': {x: 770, y: 190},
    'NM': {x: 250, y: 310}, 'NY': {x: 750, y: 170}, 'NC': {x: 680, y: 280},
    'ND': {x: 390, y: 150}, 'OH': {x: 600, y: 230}, 'OK': {x: 420, y: 310},
    'OR': {x: 90, y: 160}, 'PA': {x: 700, y: 210}, 'RI': {x: 810, y: 170},
    'SC': {x: 650, y: 310}, 'SD': {x: 390, y: 190}, 'TN': {x: 580, y: 300},
    'TX': {x: 380, y: 350}, 'UT': {x: 180, y: 240}, 'VT': {x: 790, y: 140},
    'VA': {x: 700, y: 250}, 'WA': {x: 100, y: 120}, 'WV': {x: 650, y: 240},
    'WI': {x: 510, y: 180}, 'WY': {x: 300, y: 200}, 'DC': {x: 730, y: 230}
};

// --- Utility Functions ---
function formatCurrency(value) {
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }).format(value);
}

function parseCurrencyValue(valueStr) {
    if (!valueStr) return 0;
    return parseFloat(String(valueStr).replace(/[$,\s]/g, '')) || 0;
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    if (isNaN(date.getTime())) return '';
    return new Intl.DateTimeFormat('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
    }).format(date);
}

function showProcessing(message) {
    const processingIndicator = document.getElementById('processingIndicator');
    const autoloadStatus = document.getElementById('autoload-status');
    
    processingIndicator.classList.remove('hidden');
    processingIndicator.querySelector('span').textContent = message || 'Processing data...';
    autoloadStatus.textContent = message || 'Processing data...';
    autoloadStatus.classList.remove('hidden');
    autoloadStatus.style.color = '#7f8c8d'; // Default color
}

function hideProcessing() {
    document.getElementById('processingIndicator').classList.add('hidden');
}

function showErrorMessage(message, isAutoloadError = false) {
    const autoloadStatus = document.getElementById('autoload-status');
    const manualUploadSection = document.getElementById('manual-upload-section');
    const errorMessageDiv = document.getElementById('errorMessage');
    const successMessageDiv = document.getElementById('successMessage');
    
    if (isAutoloadError) {
        autoloadStatus.textContent = `Error: ${message}`;
        autoloadStatus.style.color = '#e74c3c'; // Red for error
        manualUploadSection.classList.remove('hidden');
        manualUploadSection.classList.add('highlight-section');
    } else {
        errorMessageDiv.textContent = message;
        errorMessageDiv.classList.remove('hidden');
        successMessageDiv.classList.add('hidden');
    }
    hideProcessing();
}

function showSuccessMessage(message, isAutoloadSuccess = false) {
    const autoloadStatus = document.getElementById('autoload-status');
    const successMessageDiv = document.getElementById('successMessage');
    const errorMessageDiv = document.getElementById('errorMessage');
    
    if (isAutoloadSuccess) {
        autoloadStatus.textContent = message;
        autoloadStatus.style.color = '#27ae60'; // Green for success
    } else {
        successMessageDiv.textContent = message;
        successMessageDiv.classList.remove('hidden');
        errorMessageDiv.classList.add('hidden');
    }
    hideProcessing();
}

// --- Custom Export Functions ---
function exportToCsv(data, filename) {
    // Convert JSON data to CSV string
    const csvRows = [];
    
    // Get the headers
    const headers = Object.keys(data[0]);
    csvRows.push(headers.join(','));
    
    // Add the data rows
    for (const row of data) {
        const values = headers.map(header => {
            const val = row[header];
            // Handle commas, quotes, etc.
            return `"${String(val).replace(/"/g, '""')}"`;
        });
        csvRows.push(values.join(','));
    }
    
    // Create CSV content and download
    const csvString = csvRows.join('\n');
    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    
    // Create download link
    const link = document.createElement('a');
    if (link.download !== undefined) {
        // Feature detection
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

function exportDashboardToPdf() {
    // Using jsPDF library
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        orientation: 'landscape',
        unit: 'px',
        format: [1100, 800]
    });
    
    // Add title
    doc.setFontSize(22);
    doc.text('Federal Business Development Dashboard Report', 40, 40);
    
    // Add date
    doc.setFontSize(12);
    const today = new Date();
    doc.text(`Generated on: ${today.toLocaleDateString()}`, 40, 60);
    
    // Add filter info
    if (activeFilter) {
        doc.text(`Filtered by: ${activeFilter}`, 40, 80);
    }
    
    // Add statistics
    doc.setFontSize(16);
    doc.text('Key Statistics', 40, 110);
    
    doc.setFontSize(12);
    doc.text(`Total Contracts: ${document.getElementById('totalContractsValue').textContent}`, 40, 130);
    doc.text(`Total Value: ${document.getElementById('totalValueValue').textContent}`, 40, 150);
    doc.text(`Average Contract: ${document.getElementById('avgContractValue').textContent}`, 40, 170);
    doc.text(`Unique Primes: ${document.getElementById('uniquePrimesValue').textContent}`, 40, 190);
    
    // Convert charts to images and add them
    let yPosition = 220;
    
    // Use html2canvas to capture charts
    const chartIds = ['primeContractorsChart', 'departmentChart', 'naicsChart', 'stateChart'];
    
    // Unfortunately, async operations can't be easily captured in this sequence
    // In real implementation, we'd use Promise.all and async/await
    doc.text('Note: Charts would be included in the actual PDF export', 40, yPosition);
    
    // Save the PDF
    doc.save('federal-bd-dashboard-report.pdf');
}

// --- Advanced Data Analysis Functions ---
function calculateGrowthTrends(data) {
    // Group contracts by year
    const yearlyContracts = {};
    
    data.forEach(record => {
        if (record['Period of Performance Start Date']) {
            const date = new Date(record['Period of Performance Start Date']);
            if (!isNaN(date.getTime())) {
                const year = date.getFullYear();
                
                if (!yearlyContracts[year]) {
                    yearlyContracts[year] = {
                        count: 0,
                        value: 0,
                        naics: {}
                    };
                }
                
                const value = parseCurrencyValue(record['Base and All Options Value (Total Contract Value)']);
                yearlyContracts[year].count++;
                yearlyContracts[year].value += value;
                
                // Track NAICS code
                if (record['NAICS Code']) {
                    const naicsCode = record['NAICS Code'];
                    
                    if (!yearlyContracts[year].naics[naicsCode]) {
                        yearlyContracts[year].naics[naicsCode] = {
                            count: 0,
                            value: 0
                        };
                    }
                    
                    yearlyContracts[year].naics[naicsCode].count++;
                    yearlyContracts[year].naics[naicsCode].value += value;
                }
            }
        }
    });
    
    // Sort years
    const sortedYears = Object.keys(yearlyContracts).sort();
    
    // Calculate year-over-year growth
    const growthData = [];
    
    for (let i = 1; i < sortedYears.length; i++) {
        const currentYear = sortedYears[i];
        const previousYear = sortedYears[i-1];
        
        const currentValue = yearlyContracts[currentYear].value;
        const previousValue = yearlyContracts[previousYear].value;
        
        const valueGrowth = previousValue > 0 ? 
            ((currentValue - previousValue) / previousValue) * 100 : 0;
        
        const currentCount = yearlyContracts[currentYear].count;
        const previousCount = yearlyContracts[previousYear].count;
        
        const countGrowth = previousCount > 0 ? 
            ((currentCount - previousCount) / previousCount) * 100 : 0;
        
        growthData.push({
            yearFrom: previousYear,
            yearTo: currentYear,
            previousValue,
            currentValue,
            valueGrowth,
            previousCount,
            currentCount,
            countGrowth
        });
    }
    
    return {
        yearlyContracts,
        growthData
    };
}

function analyzeCompetitivePosition(data, primeName) {
    // Find the prime's data
    const primeData = data.filter(record => record['Legal Business Name'] === primeName);
    
    // Get the prime's departments and NAICS codes
    const primeDepts = new Set();
    const primeNaics = new Set();
    
    primeData.forEach(record => {
        if (record['Contracting Department Name']) {
            primeDepts.add(record['Contracting Department Name']);
        }
        
        if (record['NAICS Code']) {
            primeNaics.add(record['NAICS Code']);
        }
    });
    
    // Find competitors in the same departments and NAICS codes
    const competitors = {};
    
    data.forEach(record => {
        const recordPrime = record['Legal Business Name'];
        
        if (recordPrime !== primeName) {
            let isCompetitor = false;
            
            // Check if competitor operates in same department
            if (record['Contracting Department Name'] && 
                primeDepts.has(record['Contracting Department Name'])) {
                isCompetitor = true;
            }
            
            // Check if competitor operates in same NAICS
            if (record['NAICS Code'] && 
                primeNaics.has(record['NAICS Code'])) {
                isCompetitor = true;
            }
            
            if (isCompetitor) {
                if (!competitors[recordPrime]) {
                    competitors[recordPrime] = {
                        name: recordPrime,
                        contracts: 0,
                        totalValue: 0,
                        departments: new Set(),
                        naics: new Set(),
                        sharedDepartments: new Set(),
                        sharedNaics: new Set()
                    };
                }
                
                const value = parseCurrencyValue(record['Base and All Options Value (Total Contract Value)']);
                competitors[recordPrime].contracts++;
                competitors[recordPrime].totalValue += value;
                
                if (record['Contracting Department Name']) {
                    competitors[recordPrime].departments.add(record['Contracting Department Name']);
                    
                    if (primeDepts.has(record['Contracting Department Name'])) {
                        competitors[recordPrime].sharedDepartments.add(record['Contracting Department Name']);
                    }
                }
                
                if (record['NAICS Code']) {
                    competitors[recordPrime].naics.add(record['NAICS Code']);
                    
                    if (primeNaics.has(record['NAICS Code'])) {
                        competitors[recordPrime].sharedNaics.add(record['NAICS Code']);
                    }
                }
            }
        }
    });
    
    // Sort competitors by total value
    const sortedCompetitors = Object.values(competitors)
        .sort((a, b) => b.totalValue - a.totalValue);
    
    return {
        prime: {
            name: primeName,
            contracts: primeData.length,
            totalValue: primeData.reduce((sum, record) => 
                sum + parseCurrencyValue(record['Base and All Options Value (Total Contract Value)']), 0),
            departments: Array.from(primeDepts),
            naics: Array.from(primeNaics)
        },
        competitors: sortedCompetitors
    };
}

// --- Data Loading and Initialization ---
function processAndInitialize(data) {
    if (!data || data.length === 0) {
        // If autoload was attempted and failed, the message is already set by showErrorMessage
        // If manual upload resulted in no data, show message in manual section
        const isAutoloadAttempted = !document.getElementById('manual-upload-section').classList.contains('hidden');
        showErrorMessage('No data to display.', isAutoloadAttempted);
        return;
    }
    
    parsedData = data;
    activeFilter = null; 
    document.getElementById('activeFilterIndicator').classList.add('hidden');
    
    document.getElementById('dashboardContent').classList.remove('hidden');
    document.getElementById('manual-upload-section').classList.remove('highlight-section'); 

    // Populate filter dropdowns
    populateFilterOptions();
    
    // Initialize all charts and features
    initializeCharts(parsedData);
    
    // Hide processing indicator
    showSuccessMessage('Data loaded and processed successfully!', true);
    hideProcessing();
}

function loadDataFromS3() {
    showProcessing('Attempting to load data from S3...');
    console.log('Attempting to load data from S3 (using fetch):', S3_CSV_URL);

    fetch(S3_CSV_URL, {
        method: 'GET',
        mode: 'cors', // Important for cross-origin requests
        cache: 'no-cache', // Ensures fresh data
        headers: {
            'Accept': 'text/csv',
        }
    })
    .then(response => {
        if (!response.ok) {
            // Construct a detailed error message
            let errorDetail = `HTTP error ${response.status} (${response.statusText || 'Status text not available'})`;
            if (response.status === 0) {
                errorDetail = "Network error or CORS issue. Check browser console and S3 bucket CORS configuration.";
            } else if (response.status === 403) {
                errorDetail = "Access Forbidden (403). Check S3 bucket permissions and CORS.";
            } else if (response.status === 404) {
                errorDetail = "File Not Found (404) at the S3 URL.";
            }
            // Throw an error to be caught by the .catch block
            throw new Error(`Failed to fetch data from S3. ${errorDetail}`);
        }
        return response.text(); // Get the CSV content as text
    })
    .then(csvText => {
        if (!csvText || csvText.trim() === '') {
            console.warn('S3 file is empty or contains no data.');
            showErrorMessage('S3 file is empty or contains no data.', true);
            return; // Stop further processing
        }

        console.log('CSV text received from S3, parsing with PapaParse...');
        showProcessing('Parsing CSV data from S3...'); // Update status

        Papa.parse(csvText, {
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: function(results) {
                console.log('S3 CSV parsing complete, rows:', results.data ? results.data.length : 0);
                if (results.errors && results.errors.length > 0) {
                    console.error('S3 CSV parsing errors:', results.errors);
                    showErrorMessage('Error parsing CSV from S3: ' + results.errors[0].message, true);
                    return;
                }
                if (results.data && results.data.length > 0) {
                    showSuccessMessage('Data loaded and parsed successfully from S3!', true);
                    processAndInitialize(results.data);
                } else {
                    showErrorMessage('No data could be parsed from the S3 file.', true);
                }
            },
            error: function(error) { // This error is for PapaParse itself if csvText is malformed
                console.error('PapaParse error on S3 CSV text:', error);
                showErrorMessage('Error parsing CSV data from S3: ' + error.message, true);
            }
        });
    })
    .catch(error => { // Catches errors from fetch() or the .then() chain (e.g., network, CORS, HTTP errors)
        console.error('Fetch or S3 data processing error:', error);
        let errorMsg = error.message; 
        if (navigator.onLine === false && !errorMsg.includes("offline")) {
            errorMsg += " You also appear to be offline. Please check your internet connection.";
        }
        showErrorMessage(errorMsg, true);
    });
}

// --- Additional Export Functionality ---
window.exportCurrentView = function() {
    const activeTab = document.querySelector('.tab.active');
    const tabId = activeTab.getAttribute('data-tab');
    
    let exportData = [];
    let filename = 'federal-bd-export.csv';
    
    switch (tabId) {
        case 'naics-analysis':
            // Export NAICS data
            const naicsCode = document.getElementById('naicsDetailSelector').value;
            if (naicsCode) {
                const naicsData = parsedData.filter(record => record['NAICS Code'] == naicsCode);
                
                exportData = naicsData.map(record => ({
                    'Prime Contractor': record['Legal Business Name'],
                    'Contract ID': record['Procurement Instrument Identifier'],
                    'Agency': record['Contracting Department Name'],
                    'Value': parseCurrencyValue(record['Base and All Options Value (Total Contract Value)']),
                    'Start Date': formatDate(record['Period of Performance Start Date']),
                    'End Date': formatDate(record['Completion Date'])
                }));
                
                filename = `naics-${naicsCode}-export.csv`;
            } else {
                // Export NAICS summary
                const naicsSummary = {};
                
                parsedData.forEach(record => {
                    const naicsCode = record['NAICS Code'];
                    if (naicsCode) {
                        if (!naicsSummary[naicsCode]) {
                            naicsSummary[naicsCode] = {
                                'NAICS Code': naicsCode,
                                'NAICS Description': record['NAICS Description'] || '',
                                'Contract Count': 0,
                                'Total Value': 0
                            };
                        }
                        
                        naicsSummary[naicsCode]['Contract Count']++;
                        naicsSummary[naicsCode]['Total Value'] += parseCurrencyValue(record['Base and All Options Value (Total Contract Value)']);
                    }
                });
                
                exportData = Object.values(naicsSummary);
                filename = 'naics-summary-export.csv';
            }
            break;
            
        case 'recompete-calendar':
            // Export upcoming contract completions
            const nextYear = new Date();
            nextYear.setFullYear(nextYear.getFullYear() + 1);
            
            exportData = parsedData
                .filter(record => {
                    if (!record['Completion Date']) return false;
                    
                    const completionDate = new Date(record['Completion Date']);
                    const now = new Date();
                    
                    return !isNaN(completionDate.getTime()) && 
                           completionDate >= now && 
                           completionDate <= nextYear;
                })
                .map(record => ({
                    'Prime Contractor': record['Legal Business Name'],
                    'Contract ID': record['Procurement Instrument Identifier'],
                    'Agency': record['Contracting Department Name'],
                    'Value': parseCurrencyValue(record['Base and All Options Value (Total Contract Value)']),
                    'End Date': formatDate(record['Completion Date']),
                    'NAICS Code': record['NAICS Code']
                }));
                
            filename = 'upcoming-recompetes-export.csv';
            break;
            
        case 'prime-profiles':
            // Export prime contractor summary
            const primeContracts = {};
            
            parsedData.forEach(record => {
                const prime = record['Legal Business Name'];
                if (prime) {
                    if (!primeContracts[prime]) {
                        primeContracts[prime] = {
                            'Prime Contractor': prime,
                            'Contract Count': 0,
                            'Total Value': 0,
                            'Average Contract Value': 0,
                            'Agencies': new Set(),
                            'NAICS Codes': new Set()
                        };
                    }
                    
                    const value = parseCurrencyValue(record['Base and All Options Value (Total Contract Value)']);
                    primeContracts[prime]['Contract Count']++;
                    primeContracts[prime]['Total Value'] += value;
                    
                    if (record['Contracting Department Name']) {
                        primeContracts[prime]['Agencies'].add(record['Contracting Department Name']);
                    }
                    
                    if (record['NAICS Code']) {
                        primeContracts[prime]['NAICS Codes'].add(record['NAICS Code']);
                    }
                }
            });
            
            // Calculate average and convert sets to strings
            exportData = Object.values(primeContracts).map(prime => {
                prime['Average Contract Value'] = prime['Contract Count'] > 0 ? 
                    prime['Total Value'] / prime['Contract Count'] : 0;
                    
                prime['Agencies'] = Array.from(prime['Agencies']).join(', ');
                prime['NAICS Codes'] = Array.from(prime['NAICS Codes']).join(', ');
                
                return prime;
            });
                
            filename = 'prime-contractors-export.csv';
            break;
            
        case 'region-finder':
            // Export regional data
            const stateFilter = document.getElementById('stateFilter').value;
            
            if (stateFilter) {
                // Export specific state data
                exportData = parsedData
                    .filter(record => record['Principal Place of Performance State Code'] === stateFilter)
                    .map(record => ({
                        'Prime Contractor': record['Legal Business Name'],
                        'Contract ID': record['Procurement Instrument Identifier'],
                        'Agency': record['Contracting Department Name'],
                        'Value': parseCurrencyValue(record['Base and All Options Value (Total Contract Value)']),
                        'Start Date': formatDate(record['Period of Performance Start Date']),
                        'End Date': formatDate(record['Completion Date']),
                        'NAICS Code': record['NAICS Code']
                    }));
                    
                filename = `${stateFilter}-contracts-export.csv`;
            } else {
                // Export state summary
                const stateSummary = {};
                
                parsedData.forEach(record => {
                    const state = record['Principal Place of Performance State Code'];
                    if (state) {
                        if (!stateSummary[state]) {
                            stateSummary[state] = {
                                'State': state,
                                'Contract Count': 0,
                                'Total Value': 0
                            };
                        }
                        
                        stateSummary[state]['Contract Count']++;
                        stateSummary[state]['Total Value'] += parseCurrencyValue(record['Base and All Options Value (Total Contract Value)']);
                    }
                });
                
                exportData = Object.values(stateSummary);
                filename = 'state-summary-export.csv';
            }
            break;
            
        case 'subplan-explorer':
            // Export subcontracting plan data
            const subplanPrimes = {};
            
            parsedData.forEach(record => {
                const prime = record['Legal Business Name'];
                const subplan = record['Subcontract Plan'];
                
                if (prime && subplan && subplan !== 'Not Specified' && subplan !== 'No subcontracting') {
                    if (!subplanPrimes[prime]) {
                        subplanPrimes[prime] = {
                            'Prime Contractor': prime,
                            'Subcontract Plan Type': subplan,
                            'Contract Count': 0,
                            'Total Value': 0,
                            'NAICS Codes': new Set()
                        };
                    }
                    
                    const value = parseCurrencyValue(record['Base and All Options Value (Total Contract Value)']);
                    subplanPrimes[prime]['Contract Count']++;
                    subplanPrimes[prime]['Total Value'] += value;
                    
                    if (record['NAICS Code']) {
                        subplanPrimes[prime]['NAICS Codes'].add(record['NAICS Code']);
                    }
                }
            });
            
            // Convert sets to strings
            exportData = Object.values(subplanPrimes).map(prime => {
                prime['NAICS Codes'] = Array.from(prime['NAICS Codes']).join(', ');
                return prime;
            });
                
            filename = 'subcontracting-plans-export.csv';
            break;
            
        default:
            // Default export - current filtered data
            exportData = parsedData.map(record => ({
                'Prime Contractor': record['Legal Business Name'],
                'Contract ID': record['Procurement Instrument Identifier'],
                'Agency': record['Contracting Department Name'],
                'Value': parseCurrencyValue(record['Base and All Options Value (Total Contract Value)']),
                'Start Date': formatDate(record['Period of Performance Start Date']),
                'End Date': formatDate(record['Completion Date']),
                'NAICS Code': record['NAICS Code'],
                'Subcontract Plan': record['Subcontract Plan']
            }));
                
            filename = 'federal-bd-export.csv';
    }
    
    if (exportData.length > 0) {
        exportToCsv(exportData, filename);
    } else {
        alert('No data available to export.');
    }
};

// --- Add Export Button to Each Tab ---
function addExportButtons() {
    const tabPages = document.querySelectorAll('.tab-page');
    
    tabPages.forEach(page => {
        const exportBtn = document.createElement('button');
        exportBtn.className = 'filter-btn-apply';
        exportBtn.style.position = 'absolute';
        exportBtn.style.top = '15px';
        exportBtn.style.right = '15px';
        exportBtn.textContent = 'Export Data';
        exportBtn.onclick = window.exportCurrentView;
        
        // Make sure the page has position relative for absolute positioning
        page.style.position = 'relative';
        
        page.appendChild(exportBtn);
    });
}

// Call this function when the DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    setupFilters();
    loadDataFromS3();
    
    // Add export buttons to tabs
    addExportButtons();
    
    // Check for URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const naicsParam = urlParams.get('naics');
    const primeParam = urlParams.get('prime');
    const stateParam = urlParams.get('state');
    
    // Handle URL parameters after data is loaded
    if (naicsParam || primeParam || stateParam) {
        // Set up a timer to check if data is loaded
        const checkDataInterval = setInterval(() => {
            if (parsedData.length > 0) {
                clearInterval(checkDataInterval);
                
                if (naicsParam) {
                    document.getElementById('naicsFilter').value = naicsParam;
                    document.querySelector('.tab[data-tab="naics-analysis"]').click();
                } else if (primeParam) {
                    applyPrimeFilter(primeParam);
                } else if (stateParam) {
                    document.getElementById('stateFilter').value = stateParam;
                    document.querySelector('.tab[data-tab="region-finder"]').click();
                }
                
                applyAdvancedFilters();
            }
        }, 500);
    }
});
</script>
</body>
</html>