<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Subhoo - Federal Prime Contractor Database</title>
    <script src="https://cdn.tailwindcss.com"></script>
<!-- JavaScript Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<!-- MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<!-- SEO Meta Tags -->
<meta name="description" content="Subhoo helps small businesses discover federal subcontracting opportunities by visualizing prime contractors with mandatory subcontracting plans from the SBA's official directory.">
<meta name="keywords" content="federal contracting, subcontractor intelligence, USASpending, government contracts, prime contractors, federal sales, business development, small business">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://subhoo.com/">
<!-- Preconnect to External Domains -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
<link rel="preconnect" href="https://www.googletagmanager.com">
<link rel="preconnect" href="https://cdnjs.cloudflare.com">
<link rel="preconnect" href="https://d3js.org">
<link rel="preconnect" href="https://unpkg.com">
<!-- Favicon -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<meta name="theme-color" content="#252327" class="theme-color">
<!-- Open Graph / Facebook -->
<meta property="og:type" content="website" />
<meta property="og:url" content="https://subhoo.com/" />
<meta property="og:title" content="Subhoo - Federal Prime Contractor Database" />
<meta property="og:description" content="Discover federal subcontracting opportunities by visualizing prime contractors with mandatory small business participation plans. Search, explore, and connect with potential prime partners." />
<meta property="og:image" content="https://subhoo.com/subhoo.png">
<meta property="og:locale" content="en_US">
<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Subhoo - Federal Prime Contractor Database" />
<meta name="twitter:description" content="Discover federal subcontracting opportunities by visualizing prime contractors with mandatory small business participation plans. Search, explore, and connect with potential prime partners." />
<meta name="twitter:image" content="https://subhoo.com/subhoo.png" />
<!-- Security Headers -->
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2W258XTWJG"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-2W258XTWJG');
</script>
<!-- Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "Subhoo",
  "url": "https://subhoo.com/",
  "description": "Federal Prime Contractor Database with Subcontracting Plans",
  "potentialAction": {
    "@type": "SearchAction",
    "target": "https://subhoo.com/search?q={search_term_string}",
    "query-input": "required name=search_term_string"
  }
}
</script>
<style>
:root {
  font-family: Inter, sans-serif;
  font-feature-settings: 'liga' 1, 'calt' 1;
  /* Modern Government with Clear Differentiation */
  --deep-blue: #211c26;      /* Very dark purple */
  --navy-purple: #342f3a;    /* Dark purple */
  --purple: #49434e;         /* Deep purple */
  --pink: #5f5864;           /* Medium purple */
  --coral: #756f7b;          /* Purple-gray */
  --orange: #8c8692;         /* Medium lavender-gray */
  
  /* Additional colors from the palette */
  --lavender-1: #a49daa;     /* Lavender-gray */
  --lavender-2: #bdb6c3;     /* Light lavender */
  --lavender-3: #d6cfdc;     /* Pale lavender */
  
  /* Neutral Gray Palette - updated to use the lavender tints */
  --white: #ffffff;
  --seasalt: #f7f7fa;           /* Very pale lavender-white */
  --antiflash-white: #f0eef4;   /* Pale lavender-white */
  --platinum: #e4e1e9;          /* Light lavender */
  --french-gray: #d6cfdc;       /* Pale lavender */
  --french-gray-2: #bdb6c3;     /* Light lavender */
  --slate-gray: #a49daa;        /* Lavender-gray */
  --outer-space: #8c8692;       /* Medium lavender-gray */
  --onyx: #49434e;              /* Deep purple */
  --eerie-black: #342f3a;       /* Dark purple */
  
  /* Light Mode Colors - updated to use your new palette */
  --background: var(--antiflash-white);      /* Pale lavender-white */
  --content-background: var(--white);        /* White */
  --on-accent: #ffffff;                      /* White text on accent */
  --accent: var(--navy-purple);              /* Dark purple */
  --accent-hover: var(--deep-blue);          /* Very dark purple */
  --accent-secondary: rgba(52, 47, 58, 0.15);  /* Dark purple with opacity */
  --gradient-bg-start: rgba(52, 47, 58, 0.08); /* Dark purple with less opacity */
  --gradient-bg-end: rgba(52, 47, 58, 0);      /* Transparent dark purple */
  
  /* Text colors */
  --text-primary: var(--eerie-black);        /* Dark purple */
  --text-secondary: var(--onyx);             /* Deep purple */
  --text-tertiary: var(--slate-gray);        /* Lavender-gray */
  
  /* Border colors - updated to better match your palette */
  --border-level-1: rgba(189, 182, 195, 0.3); /* Light lavender with opacity */
  --border-level-2: rgba(189, 182, 195, 0.5); /* Light lavender with more opacity */
  --border-level-3: rgba(189, 182, 195, 0.8); /* Light lavender with high opacity */
  
  /* Surface levels - updated to match your palette */
  --surface-level-1: var(--content-background);
  --surface-level-2: rgba(214, 207, 220, 0.3); /* Pale lavender with opacity */
  --surface-level-3: rgba(214, 207, 220, 0.5); /* Pale lavender with more opacity */
  
  /* Chart colors updated to your 9-color palette */
  --chart-accent-1: #211c26;  /* Very dark purple */
  --chart-accent-2: #342f3a;  /* Dark purple */
  --chart-accent-3: #49434e;  /* Deep purple */
  --chart-accent-4: #5f5864;  /* Medium purple */
  --chart-accent-5: #756f7b;  /* Purple-gray */
  --chart-highlight: #8c8692; /* Medium lavender-gray */
  --chart-extra-1: #a49daa;   /* Lavender-gray */
  --chart-extra-2: #bdb6c3;   /* Light lavender */
  --chart-extra-3: #d6cfdc;   /* Pale lavender */
  
  /* UI variables */
  --header-font-weight: 600;
  --button-font-weight: 500;
  --space-m: 12px;
  
  /* Layout variables */
  --sidebar-width: 280px;
  --sidebar-width-collapsed: 60px;
  --topbar-height: 60px;
}

/* Dark Mode Colors - completely revised for the purple palette */
html.dark {
  /* Background colors */
  --background: #1a171e;              /* Nearly black-purple background */
  --content-background: #26212d;      /* Very dark purple content area */
  
  /* Accent colors - using lighter colors from the palette for better visibility */
  --accent: #a49daa;                  /* Lavender-gray */ 
  --accent-hover: #bdb6c3;            /* Light lavender */
  --accent-secondary: rgba(164, 157, 170, 0.3);   /* Lavender-gray with opacity */
  --gradient-bg-start: rgba(164, 157, 170, 0.15); /* Lavender-gray with less opacity */
  --gradient-bg-end: rgba(164, 157, 170, 0);      /* Transparent lavender-gray */
  
  /* Text colors - explicitly light for dark mode */
  --text-primary: #f0eef4;            /* Pale lavender-white */
  --text-secondary: #d6cfdc;          /* Pale lavender */
  --text-tertiary: #bdb6c3;           /* Light lavender */
  
  /* Border colors */
  --border-level-1: rgba(95, 88, 100, 0.35);    /* Medium purple with opacity */
  --border-level-2: rgba(95, 88, 100, 0.55);    /* Medium purple with more opacity */
  --border-level-3: rgba(117, 111, 123, 0.75);  /* Purple-gray with high opacity */
  
  /* Surface levels for cards, etc. */
  --surface-level-1: var(--content-background);  /* Very dark purple */
  --surface-level-2: rgba(52, 47, 58, 0.8);      /* Dark purple with high opacity */
  --surface-level-3: rgba(73, 67, 78, 0.6);      /* Deep purple with medium opacity */
  
  /* Chart colors match the exact palette */
  --chart-accent-1: #211c26;  /* Very dark purple */
  --chart-accent-2: #342f3a;  /* Dark purple */
  --chart-accent-3: #49434e;  /* Deep purple */
  --chart-accent-4: #5f5864;  /* Medium purple */
  --chart-accent-5: #756f7b;  /* Purple-gray */
  --chart-highlight: #8c8692; /* Medium lavender-gray */
  --chart-extra-1: #a49daa;   /* Lavender-gray */
  --chart-extra-2: #bdb6c3;   /* Light lavender */
  --chart-extra-3: #d6cfdc;   /* Pale lavender */
}

/* Force sidebar and content backgrounds in dark mode */
html.dark .sidebar,
html.dark .sidebar-header,
html.dark .sidebar-content,
html.dark .sidebar-footer {
  background-color: var(--background) !important;
  border-color: var(--border-level-2) !important;
}

html.dark .main-content,
html.dark .dashboard-card,
html.dark .chart-container,
html.dark .section-header {
  background-color: var(--content-background) !important;
}

/* Force lighter text colors in dark mode */
html.dark .text-[var(--text-primary)],
html.dark .text-[var(--accent)],
html.dark h1, html.dark h2, html.dark h3, html.dark h4,
html.dark .font-bold, html.dark .font-semibold, html.dark .font-extrabold,
html.dark #currentFilterDescription,
html.dark #totalContractsValue,
html.dark #totalValueValue,
html.dark #avgContractValue,
html.dark #uniquePrimesValue {
  color: var(--text-primary) !important;
}

/* Force accent color on buttons */
html.dark .btn-primary,
html.dark .action-btn,
html.dark button.bg-[var(--accent)] {
  background-color: var(--accent) !important;
  color: var(--onyx) !important; /* Dark text on light buttons for contrast */
}
/* ===== BASE LAYOUT ===== */
body {
  background-color: var(--surface-level-1);
  color: var(--text-primary);
  transition: background-color 0.3s ease, color 0.3s ease;
  margin: 0;
  padding: 0;
  height: 100vh;
  overflow: hidden;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}
/* App container and dashboard layout */
.app-wrapper {
    max-width: 1600px;
  margin-left: auto !important;
  margin-right: auto !important;
  margin-top: 20px;
  margin-bottom: 20px;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 8px 30px rgba(0, 31, 63, 0.1);
  display: flex;
  height: calc(100vh - 40px);
  position: relative;
  background-color: var(--background);
}
/* Add these useful button styles that match your chart colors */
.btn-primary {
  background-color: var(--accent);
  color: var(--on-accent);
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  transition: background-color 0.2s;
}
.btn-primary:hover {
  background-color: var(--accent-hover);
}
.btn-secondary {
  background-color: var(--accent-secondary);
  color: var(--accent);
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  transition: background-color 0.2s;
}
.btn-secondary:hover {
  background-color: rgba(68, 78, 134, 0.25);
}
  /* UI variables */
  --header-font-weight: 600;
  --button-font-weight: 500;
  --space-m: 12px;
  /* Layout variables */
  --sidebar-width: 280px;
  --sidebar-width-collapsed: 60px;
  --topbar-height: 60px;
}
/* Smallest screens */
@media (max-width: 480px) {
  #sankeyChart, #contractorMap {
    height: 300px !important;
  }
  .dashboard-card {
    padding: 0.75rem !important;
  }
  #unifiedSearchInput {
    font-size: 14px;
    padding: 0.5rem !important;
  }
  .stat-card {
    padding: 0.75rem !important;
  }
  .stat-card .text-2xl {
    font-size: 1.25rem !important;
  }
}
/* ===== PRINT STYLES ===== */
@media print {
  .dashboard-card {
    break-inside: avoid;
    page-break-inside: avoid;
  }
  button, .action-btn, .filter-btn, #themeToggleBtn, #shareViewBtn {
    display: none !important;
  }
  body, .dashboard-container {
    background-color: white !important;
    color: black !important;
  }
  @page {
    margin: 1cm;
  }
}
/* Mobile breakpoints */
@media (max-width: 767px) {
  #sankeyChart, #contractorMap {
    height: 350px !important;
  }
  .chart-container {
    height: 250px !important;
  }
  .table-responsive th,
  .table-responsive td {
    padding: 4px 6px;
    font-size: 11px;
  }
  .dashboard-card {
    padding: 1rem !important;
  }
  .modal-content {
    padding: 1rem;
  }
  #primeProfilesContainer {
    max-height: 60vh;
  }
  button, 
  .filter-btn, 
  #themeToggleBtn, 
  #shareViewBtn,
  .suggestion-item {
    min-height: 44px; /* Minimum height for touch targets */
  }
  #clearSearchBtn {
    height: 44px;
    width: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .stat-card {
    margin-bottom: 0.5rem;
  }
  /* Further optimization for mobile */
  .sidebar-content {
    padding: 0.5rem;
  }
  .sidebar-search {
    padding: 0 0.5rem;
  }
  /* Ensure header is compact */
  .sidebar-header {
    padding: 0.5rem;
    height: auto;
  }
}
/* Further optimizations for very small screens */
@media (max-width: 640px) {
  /* Make buttons horizontal */
  .sidebar-content .flex.flex-wrap {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    gap: 0.25rem;
  }
  .app-wrapper {
    margin: 0;
    border-radius: 0;
    height: 100vh;
  }
  .sidebar {
    width: 0;
    border-right: none;
  }
  .main-content {
    margin-left: 0;
    width: 100%;
    padding: 0.5rem;
  }
  .sidebar.expanded {
    width: 100%;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
  }
  .dashboard-cards {
    grid-template-columns: 1fr;
  }
  .chart-container {
    height: 250px;
  }
  #sankeyChart {
    height: 400px !important;
  }
  .section-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }
  .section-header .action-btn {
    align-self: flex-end;
  }
  .table-responsive {
    margin-left: -1rem;
    margin-right: -1rem;
    width: calc(100% + 2rem);
    padding: 0 0.5rem;
  }
  .table-responsive th,
  .table-responsive td {
    padding: 0.25rem 0.5rem;
    font-size: 0.7rem;
    white-space: nowrap;
  }
}
.dashboard-container {
  display: flex;
  width: 100%;
  height: 100%;
  overflow: hidden;
  border-radius: 12px;
}
#dashboardContent {
  display: flex;
  flex-direction: column;
  min-height: calc(100vh - 200px);
}
/* Main Content */
.main-content {
  margin-left: var(--sidebar-width);
  width: calc(100% - var(--sidebar-width));
  height: 100%;
  overflow-y: auto;
  transition: margin-left 0.3s ease, width 0.3s ease;
  padding: 1rem;
  border-radius: 0 12px 12px 0;
  flex: 1;
  background-color: var(--background);
}
.main-content-expanded {
  margin-left: var(--sidebar-width-collapsed);
  width: calc(100% - var(--sidebar-width-collapsed));
}
/* Sidebar Styles */
.sidebar {
  width: var(--sidebar-width);
  height: 100%;
  background-color: var(--background);
  border-right: 1px solid var(--border-level-2);
  transition: width 0.3s ease;
  overflow-y: auto;
  overflow-x: hidden;
  position: absolute;
  top: 0;
  left: 0;
  z-index: 40;
  display: flex;
  flex-direction: column;
}
.sidebar-collapsed {
  width: var(--sidebar-width-collapsed);
}
.sidebar-header {
  padding: 1rem;
  border-bottom: 1px solid var(--border-level-2);
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: var(--topbar-height);
}
.sidebar-header button {
  opacity: 0.8;
  transition: opacity 0.2s, background-color 0.2s;
}
.sidebar-header button:hover {
  opacity: 1;
}
.sidebar-content {
  padding: 1rem;
  flex: 1;
  overflow-y: auto;
}
.sidebar-footer {
  padding: 1rem;
  border-top: 1px solid var(--border-level-2);
  font-size: 0.75rem;
}
/* Toggle Button for Sidebar */
.toggle-sidebar {
  background: none;
  border: none;
  color: var(--text-primary);
  cursor: pointer;
  padding: 0.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
}
/* Collapsed Sidebar Adjustments */
.sidebar-collapsed .sidebar-header {
  justify-content: center;
  padding: 1rem 0.5rem;
}
.sidebar-collapsed .sidebar-header .flex {
  display: none;
}
.sidebar-collapsed .toggle-sidebar {
  margin-left: 0;
}
.sidebar-collapsed .sidebar-footer {
  padding: 0.5rem;
  text-align: center;
  font-size: 0;
}
.sidebar-collapsed .sidebar-content {
  padding: 0.5rem;
}
/* Toggle Button in Main Content */
.sidebar-collapsed ~ .main-content #expandSidebarBtn {
  display: block;
}
/* ===== COMPONENTS ===== */
/* Cards */
.dashboard-card {
  background-color: var(--surface-level-1) !important;
  border: 1px solid var(--border-level-1);
  border-radius: 0.5rem;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  padding: 1rem;
}
.dashboard-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}
/* Search Input */
.sidebar-search {
  position: relative;
  margin-bottom: 1.5rem;
}
.sidebar-search input::placeholder {
  opacity: 0.7;
}
.sidebar-search button.text-xs {
  font-weight: 500;
  white-space: nowrap;
}
.search-input {
  width: 100%;
  padding: 0.75rem 2.5rem 0.75rem 0.75rem;
  border: 1px solid var(--border-level-2);
  border-radius: 0.375rem;
  background-color: var(--background);
  color: var(--text-primary);
  font-size: 0.875rem;
}
.search-clear-btn {
  position: absolute;
  right: 0.5rem;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: var(--text-tertiary);
  cursor: pointer;
}
/* Search suggestions styling */
.search-suggestions {
  position: absolute;
  width: 100%;
  max-height: 240px;
  overflow-y: auto;
  background-color: var(--background);
  border: 1px solid var(--border-level-2);
  border-top: none;
  border-radius: 0 0 0.375rem 0.375rem;
  z-index: 50;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  padding: 0.25rem 0;
}
.suggestion-item {
  padding: 0.5rem 0.75rem;
  cursor: pointer;
  display: flex;
  color: var(--text-secondary);
  align-items: center;
  justify-content: space-between;
  font-size: 0.85rem;
  border-bottom: 1px solid var(--border-level-1);
}
.suggestion-item:last-child {
  border-bottom: none;
}
.suggestion-item:hover {
  background-color: var(--surface-level-2);
}
.suggestion-text {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 70%;
}
.type-label {
  padding: 0.15rem 0.4rem;
  border-radius: 0.25rem;
  font-size: 0.65rem;
  background-color: var(--surface-level-1);
  color: var(--text-primary);
  display: inline-block;
  font-weight: 500;
  text-align: center;
  min-width: 45px;
}
/* Filter Elements */
.filter-group {
  margin-bottom: 1.5rem;
}
.filter-group-title {
  font-weight: var(--header-font-weight);
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.filter-label {
  font-size: 0.75rem;
  color: var(--text-secondary);
  margin-bottom: 0.25rem;
}
.filter-btn-group {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}
/* Hide specific filter groups */
.filter-group:has(#resetMapBtn), 
.filter-group:has(#resetSankeyBtn) {
  display: none !important;
}
/* Buttons */
.filter-btn {
  padding: 0.375rem 0.75rem;
  font-size: 0.75rem;
  border-radius: 0.25rem;
  background-color: var(--surface-level-2);
  border: 1px solid var(--border-level-2);
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s;
}
.filter-btn.active {
  background-color: var(--accent) !important;
  color: var(--on-accent) !important;
  border-color: var(--accent) !important;
}
.filter-btn:hover {
  background-color: var(--surface-level-3);
}
.action-btn {
  padding: 0.5rem 1rem;
  background-color: var(--accent);
  color: var(--on-accent);
  border-radius: 0.375rem;
  font-weight: var(--button-font-weight);
  transition: background-opacity 0.2s;
}
.action-btn:hover {
  opacity: 0.9;
}
.secondary-btn {
  padding: 0.375rem 0.75rem;
  background-color: var(--surface-level-2);
  color: var(--text-secondary);
  border-radius: 0.375rem;
  transition: background-color 0.2s;
}
.secondary-btn:hover {
  background-color: var(--surface-level-3);
}
/* Focus styles */
.filter-btn:focus,
button:focus,
input[type="text"]:focus,
select:focus,
a:focus {
  outline: none;
  box-shadow: 0 0 0 2px var(--background), 0 0 0 4px var(--chart-accent-1) !important;
}
/* Active Filter Indicators */
.active-filters {
  padding: 0.75rem;
  border-radius: 0.375rem;
  background-color: var(--accent-secondary);
  margin-bottom: 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}
.active-filter-tag {
  display: flex;
  align-items: center;
  background-color: var(--accent);
  color: var(--on-accent);
  padding: 0.25rem 0.5rem;
  border-radius: 0.25rem;
  font-size: 0.75rem;
  max-width: 100%;
}
.active-filter-tag span {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex: 1;
}
.clear-filter-btn {
  background: none;
  border: none;
  color: var(--on-accent);
  margin-left: 0.5rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
#activeFilterIndicator {
  background-color: var(--accent-secondary);
  color: var(--accent);
  border: 1px solid var(--accent);
}
#activeFilterIndicator button {
  background-color: var(--accent);
  color: var(--on-accent);
}
#activeFilterIndicator button:hover {
  background-color: rgba(132, 88, 179, 0.8);
}
/* ===== VISUALIZATION COMPONENTS ===== */
/* Charts & Visualizations */
.chart-container {
  position: relative;
  height: 300px;
  width: 100%;
}
.chart-no-data {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--text-primary);
  background-color: var(--surface-level-1) !important;
  border: 1px dashed var(--border-level-2);
  border-radius: 0.375rem;
  text-align: center;
  padding: 1rem;
}
.chart-no-data svg {
  width: 3rem;
  height: 3rem;
  margin-bottom: 0.5rem;
  color: var(--text-tertiary);
}
/* Full width visualization */
.full-width-viz {
  max-width: 100%;
  width: 100%;
  overflow: hidden;
  margin-left: 0;
  margin-right: 0;
}
#sankeySection {
  overflow: hidden;
}
#sankeyWrapper {
  overflow: hidden;
}
#sankeyChart {
  max-width: 100%;
}
.leaflet-tile {
  filter: grayscale(80%) brightness(95%) contrast(105%);
}
/* Custom marker styling */
.custom-marker {
  border-radius: 50%;
  width: 100%;
  height: 100%;
  box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.7), 0 0 0 2px rgba(0, 0, 0, 0.2); /* White inner border, dark outer border */
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.custom-marker:hover {
  transform: scale(1.5);
  box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.9), 0 0 0 3px rgba(0, 0, 0, 0.3);
  z-index: 1000 !important;
}
/* Cluster styling */
.custom-cluster {
  background-color: transparent;
  border: none;
}
.cluster-icon {
  color: #fff;
  border-radius: 50%;
  text-align: center;
  line-height: 30px;
  width: 30px;
  height: 30px;
  font-size: 12px;
  font-weight: bold;
  box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5);
}
.cluster-icon.medium {
  width: 40px;
  height: 40px;
  line-height: 40px;
  font-size: 14px;
}
.cluster-icon.large {
  width: 50px;
  height: 50px;
  line-height: 50px;
  font-size: 16px;
}
/* Sankey & Maps */
#sankeyChart, #contractorMap {
  height: 700px;
}
/* ===== TABLES ===== */
.table-responsive {
  display: block;
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: thin;
  scrollbar-color: var(--border-level-2) transparent;
}
.table-responsive::-webkit-scrollbar {
  height: 6px;
}
.table-responsive::-webkit-scrollbar-track {
  background: transparent;
}
.table-responsive::-webkit-scrollbar-thumb {
  background-color: var(--border-level-2);
  border-radius: 3px;
}
.table-responsive thead th {
  position: sticky;
  top: 0;
  z-index: 10;
  background-color: var(--surface-level-1);
  color: var(--text-secondary);
  border-bottom: 1px solid var(--border-level-2);
  cursor: pointer;
}
.table-responsive th:hover {
  background-color: var(--surface-level-2);
}
.table-responsive tbody {
  background-color: var(--background);
}
.table-responsive td {
  border-bottom: 1px solid var(--border-level-1);
}
/* Table text colors */
.table-responsive th,
.table-responsive td {
  color: var(--text-primary);
}
.table-responsive th {
  color: var(--text-secondary);
}
.table-responsive a {
  color: var(--accent);
}
/* Ensure modal tables follow the same rules */
#primeDetailContractsTableContainer th,
#primeDetailContractsTableContainer td,
#specializationContractsTable th,
#specializationContractsTable td,
#contractExpirationTableBody th,
#contractExpirationTableBody td {
  color: var(--text-primary);
}
/* ===== MODALS ===== */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background-color: rgba(0,0,0,0.75);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
  padding: 1rem;
}
.modal-content {
  background-color: var(--background);
  color: var(--text-primary);
  border-radius: 0.5rem;
  box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
  padding: 1.5rem;
  max-width: 90vw;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
}
.modal-content-lg { max-width: 60rem; }
.modal-content-md { max-width: 48rem; }
.modal-close-btn {
  position: absolute;
  top: 0.75rem;
  right: 0.75rem;
  background: none;
  border: none;
  font-size: 1.5rem;
  color: var(--text-tertiary);
  cursor: pointer;
  padding: 0.25rem;
}
.modal-close-btn:hover {
  color: var(--text-primary);
}
/* ===== UTILITIES ===== */
.spinner {
  border: 4px solid var(--surface-level-3);
  width: 24px;
  height: 24px;
  border-radius: 50%;
  border-left-color: var(--accent);
  animation: spin 1s linear infinite;
  margin-right: 10px;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
#processingIndicator.flex {
  display: flex;
}
.highlight-section {
  animation: pulse-highlight 1.5s ease-in-out;
}
@keyframes pulse-highlight {
  0%, 100% { box-shadow: 0 0 0 rgba(108, 117, 125, 0); }
  50% { box-shadow: 0 0 15px rgba(108, 117, 125, 0.5); }
}
#page-loader {
  transition: opacity 0.3s ease-out;
}
.timeout-message {
  display: none;
  text-align: center;
  margin-top: 1rem;
  padding: 0.5rem 1rem;
  background-color: var(--accent-secondary);
  border-radius: 0.375rem;
  font-size: 0.875rem;
}
#page-loader.timeout .timeout-message {
  display: block;
}
#manual-upload-section.timeout-show {
  display: block !important;
}
/* ===== WELCOME TITLE STYLES ===== */
.welcome-title {
  line-height: 1.4;
  animation: fadeIn 0.5s ease-in-out;
}
.welcome-title .greeting {
  color: var(--chart-accent-1);
  font-weight: 700;
  display: inline;
}
.welcome-title .description {
  font-weight: normal;
  font-size: 0.9em;
  opacity: 0.85;
  display: inline;
  margin-left: 0.25rem;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-5px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes subtle-pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}
.sidebar-search button.text-xs:first-of-type {
  animation: subtle-pulse 2s ease-in-out;
}
/* ===== CURRENT VIEW TITLE ===== */
#currentViewTitle {
  /* Use the deep purple consistently across both themes */
  background-color: var(--navy-purple) !important; /* Deep purple */
  border: none !important; /* Remove the border */
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important; /* Optional: add shadow for depth */
}

/* Apply consistent text colors regardless of theme */
#currentViewTitle {
  color: #ffffff !important; /* White text for contrast on purple */
}

#currentViewTitle * {
  color: #ffffff !important;
}

#currentFilterDescription {
  font-weight: 900 !important;
  font-size: 2.5rem !important;
  line-height: 1.1 !important;
  letter-spacing: -0.02em !important;
  color: #ffffff !important;
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif !important;
}

/* Secondary and tertiary text with consistent opacity */
#currentViewTitle .text-[var(--text-secondary)] {
  color: rgba(255, 255, 255, 0.7) !important;
}

#currentViewTitle .text-[var(--text-tertiary)] {
  color: rgba(255, 255, 255, 0.5) !important;
}

/* Force the same appearance in both light and dark mode */
html.dark #currentViewTitle,
html:not(.dark) #currentViewTitle {
  background-color: var(--navy-purple) !important;
  border: none !important;
}

html.dark #currentFilterDescription,
html:not(.dark) #currentFilterDescription {
  color: #ffffff !important;
}

/* Remove any theme-specific overrides that might interfere */
html:not(.dark) #currentViewTitle #currentFilterDescription {
  color: #ffffff !important;
}
/* ===== THEME-SPECIFIC OVERRIDES ===== */
/* Light theme specifics */
html:not(.dark) #currentViewTitle #currentFilterDescription {
  color: white !important;
}
/* Dark theme overrides */
html.dark body {
  background-color: #121212;
}
html.dark .dashboard-card {
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
}
html.dark .dashboard-card:hover {
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
}
html.dark .chart-no-data {
  background-color: var(--surface-level-1) !important;
  border-color: var(--border-level-2);
  color: var(--text-secondary);
}
html.dark .table-responsive::-webkit-scrollbar-thumb {
  background-color: var(--border-level-3);
}
html.dark .table-responsive::-webkit-scrollbar-track {
  background-color: var(--background);
}
html.dark .filter-btn:focus,
html.dark button:focus,
html.dark input[type="text"]:focus,
html.dark select:focus {
  box-shadow: 0 0 0 3px rgba(222, 226, 230, 0.3);
  outline: none;
}
html.dark section.bg-[var(--surface-level-1)] {
  background-color: var(--surface-level-1);
}
html.dark footer img[src*="powered-by-aws-white.png"] {
  filter: brightness(0.8);
}
html.dark #primeDetailContractsTableContainer th,
html.dark #specializationContractsTable th,
html.dark #contractExpirationTableBody th {
  color: var(--text-secondary);
}
html.dark #primeDetailContractsTableContainer td,
html.dark #specializationContractsTable td,
html.dark #contractExpirationTableBody td {
  color: var(--text-primary);
}
html.dark .table-responsive tbody tr:hover {
  background-color: var(--surface-level-2);
}
/* Theme toggle icons */
#themeIconMoon {
  display: none;
}
html.dark #themeIconSun {
  display: none;
}
html.dark #themeIconMoon {
  display: block;
}
/* ===== RESPONSIVE LAYOUT OPTIMIZATION ===== */
/* Mobile sidebar toggle */
.mobile-sidebar-toggle {
  position: fixed;
  bottom: 1rem;
  right: 1rem;
  z-index: 50;
  background-color: var(--accent);
  color: var(--on-accent);
  border-radius: 50%;
  width: 3rem;
  height: 3rem;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
}
/* Desktop layout (1025px and above) */
@media (min-width: 1025px) {
  .sidebar {
    width: var(--sidebar-width);
    transform: translateX(0);
    pointer-events: auto;
  }
  .main-content {
    margin-left: var(--sidebar-width);
    width: calc(100% - var(--sidebar-width));
  }
  .mobile-sidebar-toggle,
  .sidebar-header #toggleSidebarBtn {
    display: none;
  }
}
/* Tablet and mobile layout (1024px and below) */
@media (max-width: 1024px) {
  /* Document layout fixes */
  html, body {
    height: auto;
    width: 100% !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    position: relative !important;
  }
  /* Container layout fixes */
  .app-wrapper, .dashboard-container {
    flex-direction: column;
    height: auto;
    min-height: unset;
    overflow: visible;
    max-height: none;
    width: 100% !important;
    max-width: 100% !important;
    margin: 0 auto !important; /* Changed from "margin: 0 !important" */
    overflow-x: hidden !important;
  }
  /* Sidebar optimizations */
  .sidebar {
    position: static;
    width: 100%;
    height: auto;
    transform: none !important;
    border-right: none;
    border-bottom: 1px solid var(--border-level-2);
    box-shadow: none;
    background-color: var(--background);
    overflow: visible;
    z-index: 10;
    max-height: none;
  }
  .sidebar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    height: auto;
  }
  /* Main content fixes */
  .main-content {
    margin-left: 0 !important;
    width: 100% !important;
    max-width: 100vw !important;
    overflow-x: hidden !important;
    box-sizing: border-box !important;
    overflow: visible;
    height: auto;
    padding: 0.5rem !important;
  }
  /* Content container optimizations */
  .sidebar-content {
    max-height: none;
    overflow: visible;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    max-width: 100% !important;
    overflow-x: hidden !important;
  }
  /* Hide non-essential elements */
  .mobile-sidebar-toggle,
  .shoutouts, 
  .connect-card,
  #activeFilterIndicator:empty,
  .sidebar-footer {
    display: none !important;
  }
  /* Disable transitions for better performance */
  .sidebar, .main-content {
    transition: none;
  }
  /* Quick Pick buttons optimization */
  .sidebar-content .flex.flex-wrap button {
    display: none;
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
    white-space: nowrap;
  }
  .sidebar-content .flex.flex-wrap button:nth-child(-n+5) {
    display: inline-flex;
  }
  /* More button for hidden options */
  .sidebar-content .flex.flex-wrap::after {
    content: "More...";
    display: inline-block;
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
    background-color: var(--surface-level-2);
    color: var(--text-secondary);
    border-radius: 0.375rem;
    cursor: pointer;
    white-space: nowrap;
  }
  /* Search bar optimizations */
  .sidebar-search {
    padding: 0.75rem 1rem;
    margin-bottom: 0.5rem;
    width: 100% !important;
    display: block !important;
    box-sizing: border-box !important;
  }
  .sidebar-search .relative {
    position: relative !important;
    display: flex !important;
    align-items: center !important;
    width: 100% !important;
  }
  .sidebar .search-input,
  #unifiedSearchInput {
    height: 44px;
    font-size: 16px; /* Prevents zoom on iOS */
    width: 100% !important;
    display: block !important;
    box-sizing: border-box !important;
    padding-left: 2.5rem !important; /* Space for the icon */
    padding-right: 2.5rem !important; /* Space for clear button */
  }
  /* Search icon positioning */
  .sidebar-search .absolute:first-child,
  .sidebar-search .inset-y-0.left-0,
  .search-clear-btn + div,
  .sidebar-search svg:first-of-type {
    position: absolute !important;
    left: 0.75rem !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    right: auto !important;
    bottom: auto !important;
  }
  /* Clear button positioning */
  #clearSearchBtn,
  .search-clear-btn,
  .sidebar-search .absolute:last-child,
  .sidebar-search .inset-y-0.right-0 {
    position: absolute !important;
    right: 0.75rem !important;
    left: auto !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    bottom: auto !important;
    min-width: 44px !important;
    min-height: 44px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
  /* Search suggestions container */
  #unifiedSearchSuggestions {
    width: calc(100% - 1rem) !important;
    max-width: calc(100vw - 1rem) !important;
    left: 0.5rem !important;
    right: 0.5rem !important;
    box-sizing: border-box !important;
  }
  /* Sidebar content styling */
  .sidebar-content > div {
    margin-bottom: 0.5rem;
  }
  .sidebar-content h3 {
    font-size: 0.75rem;
    margin-bottom: 0.25rem;
  }
  /* Compact reset button */
  #globalResetBtn {
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.8rem;
  }
  /* Fix overflow issues for various components */
  .dashboard-card,
  .chart-container,
  .grid,
  .flex,
  svg,
  canvas {
    max-width: 100% !important;
    box-sizing: border-box !important;
    overflow-x: hidden !important;
  }
  /* SVG specific fixes */
  svg {
    overflow: visible !important; /* Allow markers/elements to appear outside bounds */
    min-width: 0 !important; /* Allow SVG to shrink below intrinsic size */
  }
  /* Table responsiveness */
  .table-responsive {
    max-width: 100vw !important;
    overflow-x: auto !important;
    -webkit-overflow-scrolling: touch !important;
  }
  /* Fix grid layouts */
  .grid {
    grid-template-columns: 1fr !important; /* Force single column on mobile */
  }
  /* Dashboard content container */
  #dashboardContent {
    max-width: 100vw !important;
    overflow-x: hidden !important;
  }
  /* Remove margin classes that could cause overflow */
  [class*="mx-"], [class*="ml-"], [class*="mr-"] {
    margin-left: 0 !important;
    margin-right: 0 !important;
  }
  /* Modals and popovers */
  .modal-content,
  .tooltip,
  .popup,
  [class*="fixed"],
  [class*="absolute"] {
    max-width: 95vw !important;
  }
  /* Search icon size */
  .sidebar-search svg {
    width: 16px !important;
    height: 16px !important;
  }
}
/* Tablet/Desktop specific breakpoint */
@media (max-width: 1023px) {
  #sankeyChart, #contractorMap {
    height: 450px;
  }
}
/* Mobile specific breakpoint */
@media (max-width: 767px) {
  #sankeyChart, #contractorMap {
    height: 350px !important;
  }
  /* Further height optimizations */
  .chart-container {
    height: 250px !important;
  }
  /* Table text sizing */
  .table-responsive th,
  .table-responsive td {
    padding: 4px 6px;
    font-size: 11px;
  }
  /* Card adjustments */
  .dashboard-card {
    padding: 1rem !important;
  }
  /* Other mobile-specific adjustments */
  .modal-content {
    padding: 1rem;
  }
  #primeProfilesContainer {
    max-height: 60vh;
  }
  /* Touch target sizing */
  button, 
  .filter-btn, 
  #themeToggleBtn, 
  #shareViewBtn,
  .suggestion-item {
    min-height: 44px;
  }
  /* Other mobile tweaks */
  .stat-card {
    margin-bottom: 0.5rem;
  }
}
/* Very small screens */
@media (max-width: 640px) {
  /* Horizontal button layout */
  .sidebar-content .flex.flex-wrap {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    gap: 0.25rem;
  }
  /* Height adjustments */
  #sankeyChart {
    height: 400px !important;
  }
  /* Header layout */
  .section-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }
  .section-header .action-btn {
    align-self: flex-end;
  }
  /* Table adjustments */
  .table-responsive {
    margin-left: -1rem;
    margin-right: -1rem;
    width: calc(100% + 2rem);
    padding: 0 0.5rem;
  }
  .table-responsive th,
  .table-responsive td {
    padding: 0.25rem 0.5rem;
    font-size: 0.7rem;
    white-space: nowrap;
  }
  /* Condensed sidebar padding */
  .sidebar-header, 
  .sidebar-content, 
  .sidebar-footer {
    padding-left: 0.5rem !important;
    padding-right: 0.5rem !important;
  }
  /* Search container margin removal */
  .sidebar-search {
    margin-left: 0 !important;
    margin-right: 0 !important;
  }
}
/* Extra small screens */
@media (max-width: 480px) {
  #sankeyChart, #contractorMap {
    height: 300px !important;
  }
  .dashboard-card {
    padding: 0.75rem !important;
  }
  #unifiedSearchInput {
    font-size: 14px;
    padding: 0.5rem !important;
  }
  .stat-card {
    padding: 0.75rem !important;
  }
  .stat-card .text-2xl {
    font-size: 1.25rem !important;
  }
}
/* Mobile specific improvements */
@media (max-width: 767px) {
  /* Search container enhancements */
  .sidebar-search {
    padding: 12px 16px;
    background-color: var(--surface-level-1);
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    margin: 10px;
    position: relative;
    z-index: 100;
  }
  /* Search input styling */
  #unifiedSearchInput,
  .search-input {
    width: 100%;
    height: 44px; /* Larger touch target */
    font-size: 16px; /* Prevents zoom on iOS */
    padding: 0 40px; /* Space for icons */
    border-radius: 8px;
    border: 1px solid var(--border-level-2);
    background-color: var(--background);
    color: var(--text-primary);
    box-shadow: none;
    -webkit-appearance: none; /* Removes default styling on iOS */
  }
  /* Search icon positioning */
  .search-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    color: var(--accent);
    pointer-events: none;
  }
  /* Clear button positioning and styling */
  .search-clear-btn,
  #clearSearchBtn {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: none;
    border: none;
    color: var(--text-tertiary);
    cursor: pointer;
    border-radius: 50%;
  }
  /* Search suggestions container */
  #unifiedSearchSuggestions,
  .search-suggestions {
    top: 100%;
    margin-top: 4px;
    width: 100%;
    max-height: 60vh; /* Larger on mobile for better scrolling */
    overflow-y: auto;
    background-color: var(--surface-level-1);
    border: 1px solid var(--border-level-2);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 1000;
  }
  /* Search suggestion items */
  .suggestion-item {
    padding: 12px 16px; /* Larger touch targets */
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border-level-1);
  }
  /* Active filters area */
  .active-filters {
    margin: 12px;
    padding: 12px;
    border-radius: 8px;
    background-color: var(--accent-secondary);
  }
  /* Filter tags */
  .active-filter-tag {
    height: 36px; /* Larger for better touch targets */
    border-radius: 6px;
    margin-bottom: 8px;
  }
  /* Make buttons more tappable */
  button, 
  .filter-btn, 
  .action-btn,
  a[role="button"] {
    min-height: 44px;
    padding: 10px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
    touch-action: manipulation; /* Improves touch responsiveness */
  }
  /* Make table cells more readable */
  .table-responsive td,
  .table-responsive th {
    padding: 12px;
    font-size: 14px;
    white-space: normal;
  }
  /* Improve spacing for cards */
  .dashboard-card {
    padding: 16px;
    margin-bottom: 16px;
    border-radius: 8px;
  }
  /* Improve chart containers */
  .chart-container {
    height: 300px;
    margin-bottom: 16px;
  }
  /* Fix map height for better visibility */
  #contractorMap {
    height: 350px;
  }
}
/* Extra small screens */
@media (max-width: 375px) {
  /* Further adjust spacing */
  .sidebar-search {
    padding: 8px 12px;
    margin: 8px;
  }
  .dashboard-card {
    padding: 12px;
    margin-bottom: 12px;
  }
  /* Smaller font sizes for very small screens */
  body {
    font-size: 14px;
  }
  .table-responsive td,
  .table-responsive th {
    padding: 8px;
    font-size: 12px;
  }
}
/* Search input text color fixes for dark mode */
html.dark .search-input,
html.dark #unifiedSearchInput {
  color: var(--text-primary); /* Uses your dark mode text color variable */
  background-color: var(--surface-level-1); /* Uses your dark mode surface color */
  border-color: var(--border-level-2); /* Uses your dark mode border color */
}
/* Placeholder text color in dark mode */
html.dark .search-input::placeholder,
html.dark #unifiedSearchInput::placeholder {
  color: var(--text-tertiary); /* Use a lighter color for placeholder text */
  opacity: 0.7;
}
/* Active state styling in dark mode */
html.dark .search-input:focus,
html.dark #unifiedSearchInput:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(149, 81, 150, 0.2); /* Using your purple accent with transparency */
  outline: none;
}
/* Ensure search icons are visible in dark mode */
html.dark .search-icon,
html.dark .search-clear-btn,
html.dark #clearSearchBtn {
  color: var(--text-secondary);
}
/* Hover state for clear button in dark mode */
html.dark .search-clear-btn:hover,
html.dark #clearSearchBtn:hover {
  color: var(--text-primary);
  background-color: var(--surface-level-2);
}
/* Search suggestions styling in dark mode */
html.dark #unifiedSearchSuggestions,
html.dark .search-suggestions {
  background-color: var(--surface-level-1);
  border-color: var(--border-level-2);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}
html.dark .suggestion-item {
  border-bottom-color: var(--border-level-2);
}
html.dark .suggestion-item:hover {
  background-color: var(--surface-level-2);
}
/* Make sure suggestion text is visible */
html.dark .suggestion-text {
  color: var(--text-primary);
}
html.dark .type-label {
  background-color: var(--surface-level-2);
  color: var(--text-secondary);
}
/* ===== CONSISTENT BUTTON STYLING ACROSS THEMES ===== */

/* Reset All Filters button - this targets the exact ID in your code */
#globalResetBtn {
  background-color: var(--purple) !important; /* Deep purple */
  color: #ffffff !important; /* White text */
  border: none !important;
}

/* LinkedIn Connect button - this targets the specific element in your sidebar */
.connect-card a[href*="linkedin.com"] {
  background-color: var(--purple) !important; /* Deep purple */
  color: #ffffff !important; /* White text */
  border: none !important;
}

/* Hover states (optional but recommended for consistent UX) */
#globalResetBtn:hover,
.connect-card a[href*="linkedin.com"]:hover {
  background-color: var(--navy-purple) !important; /* Slightly darker on hover */
  color: #ffffff !important;
}

/* Ensure these styles apply in both light and dark modes */
html.dark #globalResetBtn,
html:not(.dark) #globalResetBtn,
html.dark .connect-card a[href*="linkedin.com"],
html:not(.dark) .connect-card a[href*="linkedin.com"] {
  background-color: var(--purple) !important;
  color: #ffffff !important;
}
/* ADD this CSS to optimize the title area for mobile */

/* Mobile-specific optimizations for the current view title */
@media (max-width: 767px) {
  /* Make the title section more compact */
  #currentViewTitle {
    padding: 0.75rem !important; /* Reduced from 1rem+ */
  }
  
  /* Significantly smaller title font on mobile */
  #currentFilterDescription {
    font-size: 1.125rem !important; /* Much smaller than 2.5rem */
    line-height: 1.2 !important; /* Tighter line height */
    font-weight: 700 !important; /* Slightly lighter than 900 */
    letter-spacing: -0.01em !important; /* Less dramatic letter spacing */
    margin-bottom: 0.25rem !important; /* Small bottom margin */
  }
  
  /* Adjust the grid layout to give more space to stats */
  #currentViewTitle.lg\\:col-span-2 {
    /* On mobile, make the title take less vertical space */
    min-height: auto !important;
    height: auto !important;
  }
  
  /* Make sure the stats grid is more compact too */
  .stat-card {
    padding: 0.5rem !important; /* Even more compact */
  }
  
  .stat-card .text-2xl {
    font-size: 1rem !important; /* Smaller stat numbers */
    line-height: 1.1 !important;
  }
  
  .stat-card .text-xs {
    font-size: 0.65rem !important; /* Smaller labels */
  }
  
  /* Optional: Make the entire title/stats section shorter */
  .grid.grid-cols-1.lg\\:grid-cols-3.gap-6.mb-6.items-stretch {
    margin-bottom: 1rem !important; /* Less margin below */
    gap: 0.75rem !important; /* Smaller gaps */
  }
}

/* Even more aggressive optimization for very small screens */
@media (max-width: 480px) {
  #currentViewTitle {
    padding: 0.5rem !important;
  }
  
  #currentFilterDescription {
    font-size: 1rem !important; /* Very compact on small screens */
    line-height: 1.15 !important;
  }
  
  .stat-card {
    padding: 0.375rem !important;
  }
  
  .stat-card .text-2xl {
    font-size: 0.875rem !important;
  }
  
  .stat-card .text-xs {
    font-size: 0.6rem !important;
  }
}
</style>

</head>
<body>
    <div id="globalProcessingIndicator" class="hidden">
        <div class="global-spinner"></div>
        <span class="text-sm text-[var(--text-secondary)]">Processing...</span>
    </div>
<div class="app-wrapper">
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="dashboardSidebar">
            <!-- Sidebar Header -->
<!-- Sidebar Header -->
<div class="sidebar-header">
    <!-- Logo and Title -->
    <div class="flex flex-col">
        <h1 class="text-xl font-extrabold text-[var(--accent)]" style="letter-spacing: -0.05em;">Subhoo.</h1>
        <p class="text-xs text-[var(--text-secondary)]">Federal Contractor Intelligence</p>
    </div>
    <!-- Icon Controls -->
    <div class="flex items-center space-x-2">
        <!-- Theme Toggle -->
        <button id="themeToggleBtn" title="Toggle Light/Dark Mode" class="p-1.5 rounded-md hover:bg-[var(--surface-level-2)] transition-colors">
            <svg id="themeIconSun" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[var(--text-secondary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
            <svg id="themeIconMoon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[var(--text-secondary)] hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
        </button>
        <!-- Share Link -->
        <button id="shareViewBtn" title="Share Current View" class="p-1.5 rounded-md hover:bg-[var(--surface-level-2)] transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[var(--text-secondary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
            </svg>
        </button>
    </div>
</div>
            <!-- Sidebar Content -->
            <div class="sidebar-content">
<!-- Search Input -->
<div class="sidebar-search mb-4">
  <h3 class="text-md font-bold text-[var(--accent)] mb-2">Search</h3>
  <!-- Enhanced input container -->
  <div class="relative w-full bg-white dark:bg-[var(--surface-level-2)] rounded-lg shadow-sm overflow-hidden border border-[var(--border-level-2)]">
    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[var(--text-tertiary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
    </div>
    <!-- Keep your existing ID for functionality -->
    <input type="text" id="unifiedSearchInput" 
          class="block w-full py-2.5 pl-10 pr-10 text-sm placeholder-[var(--text-tertiary)] bg-transparent border-0 focus:outline-none focus:ring-0" 
          placeholder="Prime, NAICS, Agency..." />
    <!-- Keep your existing clear button -->
    <button id="clearSearchBtn" class="absolute inset-y-0 right-0 pr-3 flex items-center text-[var(--text-tertiary)] hover:text-[var(--text-secondary)]">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>
  <!-- Keep your existing suggestions container -->
  <div id="unifiedSearchSuggestions" class="search-suggestions hidden"></div>
</div>
                <!-- Active Filters -->
                <div id="activeFilterIndicator" class="active-filters hidden">
                    <div class="text-sm font-medium text-[var(--text-secondary)] mb-2">Active Filters:</div>
                </div>
                <!-- Reset Button -->
                <button id="globalResetBtn" class="w-full mb-4 px-4 py-2 bg-[var(--accent)] text-[var(--on-accent)] rounded hover:bg-opacity-90 transition text-sm font-medium">
                    Reset All Filters
                </button>
                <!-- Map Controls -->
                <div class="filter-group">
                    <div class="filter-group-title">
                        <span>Map Controls</span>
                    </div>
                    <button id="resetMapBtn" class="w-full mb-2 px-3 py-1 bg-[var(--surface-level-2)] text-[var(--text-secondary)] rounded hover:bg-[var(--surface-level-3)] transition text-sm">
                        Reset Map View
                    </button>
                </div>
                <!-- Sankey Chart Controls -->
                <div class="filter-group">
                    <div class="filter-group-title">
                        <span>Sankey Chart</span>
                    </div>
                    <button id="resetSankeyBtn" class="w-full mb-2 px-3 py-1 bg-[var(--surface-level-2)] text-[var(--text-secondary)] rounded hover:bg-[var(--surface-level-3)] transition text-sm">
                        Reset Sankey View
                    </button>
                </div>
  <!-- Prime contractors section -->
<div class="mb-3">
  <h3 class="text-sm font-semibold text-[var(--text-secondary)] mb-2">Top Prime Contractors</h3>
  <div class="flex flex-wrap gap-1.5">
    <button onclick="setUnifiedSearchTerm('LOCKHEED MARTIN CORPORATION', 'primeName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">Lockheed</button>
    <button onclick="setUnifiedSearchTerm('RAYTHEON COMPANY', 'primeName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">RTX</button>
    <button onclick="setUnifiedSearchTerm('GENERAL DYNAMICS INFORMATION TECHNOLOGY, INC.', 'primeName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">GDIT</button>
    <button onclick="setUnifiedSearchTerm('NORTHROP GRUMMAN SYSTEMS CORPORATION', 'primeName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">NGC</button>
    <button onclick="setUnifiedSearchTerm('LEIDOS, INC.', 'primeName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">Leidos</button>
    <button onclick="setUnifiedSearchTerm('HUNTINGTON INGALLS INC', 'primeName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">HII</button>
    <button onclick="setUnifiedSearchTerm('BOOZ ALLEN HAMILTON INC.', 'primeName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">BAH</button>
    <button onclick="setUnifiedSearchTerm('SCIENCE APPLICATIONS INTERNATIONAL CORPORATION', 'primeName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">SAIC</button>
    <button onclick="setUnifiedSearchTerm('CACI, INC. - FEDERAL', 'primeName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">CACI</button>
    <button onclick="setUnifiedSearchTerm('PERATON INC.', 'primeName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">Peraton</button>
    <button onclick="setUnifiedSearchTerm('BAE SYSTEMS TECHNOLOGY SOLUTIONS & SERVICES INC.', 'primeName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">BAE</button>
    <button onclick="setUnifiedSearchTerm('ACCENTURE FEDERAL SERVICES LLC', 'primeName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">AFS</button>
    <button onclick="setUnifiedSearchTerm('CGI FEDERAL INC.', 'primeName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">CGI</button>
    <button onclick="setUnifiedSearchTerm('CARAHSOFT TECHNOLOGY CORP.', 'primeName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">Carahsoft</button>
  </div>
</div>
<!-- Agencies section -->
<div>
  <h3 class="text-sm font-semibold text-[var(--text-secondary)] mb-2">Top Agencies</h3>
  <div class="flex flex-wrap gap-1.5">
    <button onclick="setUnifiedSearchTerm('DEPT OF DEFENSE', 'departmentName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">DoD</button>
    <button onclick="setUnifiedSearchTerm('DEPT OF THE ARMY', 'agencyName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">ARMY</button>
    <button onclick="setUnifiedSearchTerm('DEPT OF THE NAVY', 'agencyName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">USN</button>
    <button onclick="setUnifiedSearchTerm('DEPT OF THE AIR FORCE', 'agencyName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">USAF</button>
    <button onclick="setUnifiedSearchTerm('HEALTH AND HUMAN SERVICES, DEPARTMENT OF', 'departmentName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">HHS</button>
    <button onclick="setUnifiedSearchTerm('VETERANS AFFAIRS, DEPARTMENT OF', 'departmentName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">VA</button>
    <button onclick="setUnifiedSearchTerm('HOMELAND SECURITY, DEPARTMENT OF', 'departmentName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">DHS</button>
    <button onclick="setUnifiedSearchTerm('ENERGY, DEPARTMENT OF', 'departmentName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">ENERGY</button>
    <button onclick="setUnifiedSearchTerm('TRANSPORTATION, DEPARTMENT OF', 'departmentName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">DOT</button>
    <button onclick="setUnifiedSearchTerm('JUSTICE, DEPARTMENT OF', 'departmentName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">DOJ</button>
    <button onclick="setUnifiedSearchTerm('FEDERAL BUREAU OF INVESTIGATION', 'agencyName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">FBI</button>
    <button onclick="setUnifiedSearchTerm('TREASURY, DEPARTMENT OF THE', 'departmentName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">TREAS</button>
    <button onclick="setUnifiedSearchTerm('NATIONAL AERONAUTICS AND SPACE ADMINISTRATION', 'departmentName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">NASA</button>
    <button onclick="setUnifiedSearchTerm('GENERAL SERVICES ADMINISTRATION', 'departmentName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">GSA</button>
  </div>
</div>
            </div>
<!-- Manual Upload Section (Moved from main content) -->
                <div id="manual-upload-section" class="hidden mb-4 p-3 bg-[var(--surface-level-2)] rounded-lg">
                    <h3 class="text-sm font-semibold text-[var(--text-primary)] mb-2" style="font-weight: var(--header-font-weight);">Manual CSV Upload</h3>
                    <div class="flex flex-col items-start gap-2 mb-2">
                        <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                        <label for="csvFileInput" class="w-full px-3 py-2 bg-[var(--accent)] text-[var(--on-accent)] rounded-md cursor-pointer hover:bg-opacity-90 text-center text-xs" style="font-weight: var(--button-font-weight);">Choose CSV File</label>
                        <span id="file-name-display" class="text-xs text-[var(--text-secondary)] p-2 border border-[var(--border-level-2)] rounded-md w-full truncate">No file selected</span>
                    </div>
                    <div id="errorMessage" class="text-red-600 bg-red-100 dark:bg-red-900 dark:text-red-300 p-2 rounded-md hidden mb-2 text-xs"></div>
                    <div id="successMessage" class="text-green-600 bg-green-100 dark:bg-green-900 dark:text-green-300 p-2 rounded-md hidden mb-2 text-xs"></div>
                </div>
                <!-- S3 Load Error -->
                <div id="s3LoadError" class="text-red-600 bg-red-100 dark:bg-red-900 dark:text-red-300 p-2 rounded-md mb-4 hidden text-xs"></div>
<div class="connect-card mt-4 p-3"> 
  <!-- Content section with floating image -->
  <div class="relative mb-2">
    <!-- Floating image -->
    <img src="markgs.jpg" alt="Mark Profile Picture" class="w-12 h-12 rounded-full object-cover border-2 border-[var(--accent)] shadow-md float-left mr-3 mb-1">
    <!-- Text content that wraps around the image -->
    <p class="text-xs text-[var(--text-secondary)]">
     Hi, Im Mark. Federal primes with contracts over $750K must create SBA subcontracting plans. Subhoo helps you find those primes, follow the money, and unlock more opportunities. Reach out if I can help.
    </p>
  </div>
  <!-- Action buttons - LinkedIn as primary -->
  <div class="flex w-full space-x-2">
    <a href="https://www.linkedin.com/in/markflournoy/" class="flex-1 px-3 py-1.5 text-center bg-[var(--accent)] text-[var(--on-accent)] rounded hover:bg-opacity-90 transition text-xs font-medium flex items-center justify-center" target="_blank" rel="noopener noreferrer">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="currentColor" viewBox="0 0 24 24">
        <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
      </svg>
      Connect
    </a>
    <a href="mailto:mark@subhoo.com" class="flex-1 px-3 py-1.5 text-center bg-[var(--surface-level-2)] text-[var(--text-secondary)] rounded hover:bg-[var(--surface-level-3)] transition text-xs font-medium flex items-center justify-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
      </svg>
      Email
    </a>
  </div>
</div>
<!-- Original footer -->
<div class="sidebar-footer">
  <p class="text-[var(--text-primary)]"> 2025 Subhoo | All data from <a href="https://www.sba.gov" target="_blank" rel="noopener noreferrer" class="text-[var(--text-primary)] hover:underline">SBA.gov</a></p>
</div>
</aside>
        <!-- Main Content -->
        <main class="main-content" id="dashboardMainContent">
            <!-- Main content toggle button - only visible when sidebar is collapsed -->
            <button id="expandSidebarBtn" class="fixed top-4 left-4 z-30 p-2 rounded-md bg-[var(--accent)] text-[var(--on-accent)] shadow-md hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
                </svg>
            </button>
            <!-- KPI STATS SECTION -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6 items-stretch">
              <!-- Title Block: spans 2/3, top-aligned -->
              <div id="currentViewTitle" class="bg-[var(--surface-level-1)] p-4 md:p-6 rounded-lg shadow-md border border-[var(--border-level-1)] h-full lg:col-span-2 flex flex-col justify-start">
                <h1 id="currentFilterDescription" class="text-xl md:text-xl font-bold text-[var(--accent)]">
                  Try Search.
                </h1>
              </div>
              <!-- KPI Block: 1/3 in 2x2 grid -->
              <section id="statisticsSection" class="grid grid-cols-2 gap-4 h-full">
                <div class="stat-card bg-[var(--surface-level-1)] p-3 md:p-4 rounded-lg shadow border border-[var(--border-level-1)]">
                  <div class="text-2xl md:text-3xl font-bold text-[var(--accent)]" id="totalContractsValue">0</div>
                  <div class="text-xs md:text-sm text-[var(--text-secondary)]">Total Contracts</div>
                </div>
                <div class="stat-card bg-[var(--surface-level-1)] p-3 md:p-4 rounded-lg shadow border border-[var(--border-level-1)]">
                  <div class="text-2xl md:text-3xl font-bold text-[var(--accent)]" id="totalValueValue">$0</div>
                  <div class="text-xs md:text-sm text-[var(--text-secondary)]">Total Contract Value</div>
                </div>
                <div class="stat-card bg-[var(--surface-level-1)] p-3 md:p-4 rounded-lg shadow border border-[var(--border-level-1)]">
                  <div class="text-2xl md:text-3xl font-bold text-[var(--accent)]" id="avgContractValue">$0</div>
                  <div class="text-xs md:text-sm text-[var(--text-secondary)]">Average Contract Value</div>
                </div>
                <div class="stat-card bg-[var(--surface-level-1)] p-3 md:p-4 rounded-lg shadow border border-[var(--border-level-1)]">
                  <div class="text-2xl md:text-3xl font-bold text-[var(--accent)]" id="uniquePrimesValue">0</div>
                  <div class="text-xs md:text-sm text-[var(--text-secondary)]">Total Primes</div>
                </div>
              </section>
			  </div>
            <!-- KEY ANALYSIS CHARTS - NEW 3x3 GRID -->
            <section class="mb-6">
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                <!-- Chart 1: Top Prime Contractors -->
                <div id="primeContractorsChartCard" class="dashboard-card p-4 md:p-6">
                  <div class="flex justify-between items-center mb-3">
                    <h3 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Top Prime Contractors</h3>
                    <span class="text-[var(--text-tertiary)] cursor-help" title="Shows the top 10 prime contractors by total contract value">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </span>
                  </div>
                  <div class="chart-container h-[280px]"><canvas id="primeContractorsChart"></canvas></div>
                </div>
                <!-- Chart 2: Prime Market Share -->
                <div id="marketShareChartCard" class="dashboard-card p-4 md:p-6"> 
                  <div class="flex justify-between items-center mb-3">
                    <h3 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Prime Market Share</h3>
                    <span class="text-[var(--text-tertiary)] cursor-help" title="Market share percentage of prime contractors based on current filters">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </span>
                  </div>
                  <div class="chart-container h-[280px]"><canvas id="marketShareChart"></canvas></div>
                </div>
                <!-- Chart 3: Top NAICS -->
                <div class="dashboard-card p-4 md:p-6">
                  <div class="flex justify-between items-center mb-3">
                    <h3 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Top NAICS</h3>
                    <span class="text-[var(--text-tertiary)] cursor-help" title="Top NAICS codes by total contract value">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </span>
                  </div>
                  <div class="chart-container h-[280px]"><canvas id="naicsChart_main"></canvas></div>
                </div>
                <!-- Chart 4: Dept. Distribution -->
                <div class="dashboard-card p-4 md:p-6">
                  <div class="flex justify-between items-center mb-3">
                    <h3 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Dept. Distribution</h3>
                    <span class="text-[var(--text-tertiary)] cursor-help" title="Distribution of contract value by department">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </span>
                  </div>
                  <div class="chart-container h-[280px]"><canvas id="departmentChart"></canvas></div>
                </div>
                <!-- Chart 5: State Contracts -->
                <div class="dashboard-card p-4 md:p-6"> 
                  <div class="flex justify-between items-center mb-2">
                    <h3 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Contract Values by State</h3>
                    <span class="text-[var(--text-tertiary)] cursor-help" title="Contract distribution by state">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </span>
                  </div>
                  <div class="chart-container h-[280px]"><canvas id="stateContractsChart_main"></canvas></div>
                </div>
                <!-- Chart 6: Contract Timeline -->
                <div class="dashboard-card p-4 md:p-6"> 
                  <div class="flex justify-between items-center mb-3">
                    <h3 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Contract Timeline</h3>
                    <span class="text-[var(--text-tertiary)] cursor-help" title="Timeline of contract starts and endings by year">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </span>
                  </div>
                  <div class="chart-container h-[280px]"><canvas id="timelineChart"></canvas></div>
                </div>
                <!-- Chart 7: Contract Types - HIDDEN -->
                <div class="dashboard-card p-4 md:p-6 hidden">
                  <div class="flex justify-between items-center mb-3">
                    <h3 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Contract Types</h3>
                    <span class="text-[var(--text-tertiary)] cursor-help" title="Distribution of contracts by type">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </span>
                  </div>
                  <div class="chart-container h-[280px]"><canvas id="contractTypeChart_main"></canvas></div>
                </div>
                <!-- Chart 8: Top Agencies - HIDDEN -->
                <div class="dashboard-card p-4 md:p-6 hidden">
                  <div class="flex justify-between items-center mb-3">
                    <h3 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Top Agencies</h3>
                    <span class="text-[var(--text-tertiary)] cursor-help" title="Top contracting agencies by value">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </span>
                  </div>
                  <div class="chart-container h-[280px]"><canvas id="topAgenciesChart"></canvas></div>
                </div>
              </div>
            </section>
			<!-- SPECIALIZED VISUALIZATIONS ROW - Side by Side -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
  <!-- NAICS Specialization Heatmap - 1st column -->
  <div class="dashboard-card p-4 md:p-6">
    <div class="flex justify-between items-center mb-4">
      <div>
        <h3 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">NAICS Specialization Heatmap</h3>
        <p class="text-xs text-[var(--text-secondary)]">Shows which prime contractors specialize in specific NAICS codes</p>
      </div>
    </div>
    <div class="flex justify-center overflow-hidden h-[450px]">
      <div class="overflow-x-auto w-full">
        <svg id="primeSpecializationHeatmap" class="w-full h-[450px]" preserveAspectRatio="xMinYMin meet" viewBox="0 0 900 550"></svg>
      </div>
    </div>
    <p class="text-xs text-[var(--text-tertiary)] mt-2 italic">Click on any cell to see detailed contract information below</p>
  </div>
  <!-- Upcoming Contract Expirations - 2nd column -->
  <div class="dashboard-card p-4 md:p-6">
    <div class="flex justify-between items-center mb-4">
      <div>
        <h3 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Upcoming Contract Expirations</h3>
        <p class="text-xs text-[var(--text-secondary)]">Forecast of contract expirations by month and agency</p>
      </div>
    </div>
    <div class="chart-container h-[450px]">
      <canvas id="contractOpportunityForecastChart"></canvas>
    </div>
    <p class="text-xs text-[var(--text-tertiary)] mt-2 italic">Click on any month to see detailed contract opportunities below</p>
  </div>
</div>
<!-- DETAILS SECTION - Initially hidden, appears when user clicks -->
<div class="mb-6">
  <!-- Specialization Details Section - Initially hidden -->
  <div id="specializationDetailsSection" class="dashboard-card p-4 md:p-6 hidden mb-6">
    <div class="bg-[var(--surface-level-2)] p-4 rounded-md mb-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <p class="text-sm font-semibold">Prime Contractor:</p>
          <p id="specDetailsPrime" class="text-md font-bold text-[var(--accent)]">-</p>
        </div>
        <div>
          <p class="text-sm font-semibold">NAICS:</p>
          <p id="specDetailsNaics" class="text-md">-</p>
        </div>
        <div>
          <p class="text-sm font-semibold">Specialization Index:</p>
          <p id="specDetailsIndex" class="text-md font-bold">-</p>
          <p id="specDetailsIndexNote" class="text-xs text-[var(--text-secondary)]">-</p>
        </div>
        <div>
          <p class="text-sm font-semibold">Total Value:</p>
          <p id="specDetailsTotalValue" class="text-md">-</p>
        </div>
      </div>
    </div>
    <div class="flex justify-between items-center mb-3">
      <h4 class="font-semibold">Contract Details (<span id="specDetailsContractCount">0</span> contracts)</h4>
      <div>
        <button id="filterBySelectionBtn" class="px-3 py-1 bg-[var(--accent)] text-[var(--on-accent)] rounded hover:bg-opacity-90 transition text-xs">
          Filter Dashboard by Selection
        </button>
      </div>
    </div>
    <div class="table-responsive max-h-96 overflow-y-auto">
      <table class="min-w-full divide-y divide-[var(--border-level-1)] text-xs">
        <thead class="bg-[var(--surface-level-2)]">
          <tr>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]">PIID</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]">Agency</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]">Office</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]">Value</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]">Start Date</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]">End Date</th>
          </tr>
        </thead>
        <tbody id="specializationContractsTable" class="bg-[var(--background)] divide-y divide-[var(--border-level-1)]">
          <!-- Table rows will be populated dynamically -->
        </tbody>
      </table>
    </div>
    <!-- Pagination Controls -->
    <div id="specDetailsPagination" class="mt-4 flex justify-between items-center text-xs">
      <button id="prevSpecPageBtn" class="px-3 py-1 bg-[var(--surface-level-2)] text-[var(--text-secondary)] rounded hover:bg-[var(--surface-level-3)] disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
      <span>Page <span id="currentSpecPage">1</span> of <span id="totalSpecPages">1</span></span>
      <button id="nextSpecPageBtn" class="px-3 py-1 bg-[var(--surface-level-2)] text-[var(--text-secondary)] rounded hover:bg-[var(--surface-level-3)] disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
    </div>
  </div>
  <!-- Contract Expiration Details - Initially hidden -->
  <div id="contractExpirationDetails" class="dashboard-card p-4 md:p-6 hidden">
    <h4 id="expirationDetailsTitle" class="text-md font-semibold text-[var(--accent)] mb-3">Contract Expirations for <span id="selectedMonth">Month Year</span></h4>
    <div class="flex justify-between items-center mb-3">
      <div>
        <span class="text-sm text-[var(--text-secondary)]">Total opportunities: <span id="totalOpportunities">0</span></span>
        <span class="text-sm text-[var(--text-secondary)] ml-4">Total value: <span id="totalOpportunitiesValue">$0</span></span>
      </div>
      <div>
        <select id="opportunitySortSelect" class="text-sm border border-[var(--border-level-2)] rounded px-2 py-1 bg-[var(--background)]">
          <option value="value-desc">Sort by Value (High to Low)</option>
          <option value="value-asc">Sort by Value (Low to High)</option>
          <option value="date-asc">Sort by Date (Earliest First)</option>
          <option value="date-desc">Sort by Date (Latest First)</option>
          <option value="prime-asc">Sort by Prime (A-Z)</option>
          <option value="prime-desc">Sort by Prime (Z-A)</option>
        </select>
      </div>
    </div>
    <div class="table-responsive max-h-96 overflow-y-auto">
      <table class="min-w-full divide-y divide-[var(--border-level-1)] text-xs">
        <thead class="bg-[var(--surface-level-2)]">
          <tr>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]">Prime</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]">Agency</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]">Office</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]">PIID</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]">NAICS</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]">NAICS Desc.</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]">Value</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]">End Date</th>
          </tr>
        </thead>
        <tbody id="contractExpirationTableBody" class="bg-[var(--background)] divide-y divide-[var(--border-level-1)]">
          <!-- Table rows will be populated dynamically -->
        </tbody>
      </table>
    </div>
    <!-- Pagination Controls -->
    <div id="opportunityPagination" class="mt-4 flex justify-between items-center text-xs">
      <button id="prevOpportunityPageBtn" class="px-3 py-1 bg-[var(--surface-level-2)] text-[var(--text-secondary)] rounded hover:bg-[var(--surface-level-3)] disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
      <span>Page <span id="currentOpportunityPage">1</span> of <span id="totalOpportunityPages">1</span></span>
      <button id="nextOpportunityPageBtn" class="px-3 py-1 bg-[var(--surface-level-2)] text-[var(--text-secondary)] rounded hover:bg-[var(--surface-level-3)] disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
    </div>
  </div>
</div>
			        <!-- PRIME PROFILES SECTION -->
            <section id="primeProfilesSection" class="bg-[var(--surface-level-1)] p-4 md:p-6 rounded-lg shadow-md mb-6 border border-[var(--border-level-1)]">
              <h2 class="text-lg md:text-xl font-semibold text-[var(--accent)] mb-4" style="font-weight: var(--header-font-weight);">Prime Contractor Profiles</h2>
              <p class="text-xs md:text-sm text-[var(--text-secondary)] mb-3">Displaying profiles based on current search/filter. Click a prime name to filter the entire dashboard to that prime. Use search to refine this list.</p>
              <div id="primeProfilesContainer" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3 md:gap-4 max-h-[70vh] overflow-y-auto"></div>
            </section>
            <!-- PRIME DETAIL VIEW SECTION -->
            <section id="primeDetailViewSection" class="bg-[var(--surface-level-1)] p-4 md:p-6 rounded-lg shadow-md mb-6 border border-[var(--border-level-1)] hidden">
              <div class="flex justify-between items-center mb-4">
                <h2 id="primeDetailTitle" class="text-xl md:text-2xl font-bold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Prime Contractor Details</h2>
                <button onclick="clearAllFilters()" class="px-3 py-1 bg-[var(--surface-level-2)] text-[var(--text-secondary)] rounded hover:bg-[var(--surface-level-3)] transition">
                  Back to All Primes
                </button>
              </div>
              <div id="primeDetailStats" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 text-sm md:text-base">
              </div>
              <h3 class="text-lg font-semibold text-[var(--text-primary)] mt-6 mb-2" style="font-weight: var(--header-font-weight);">Contracts List for this Prime</h3>
              <div id="primeDetailContractsTableContainer" class="table-responsive max-h-96 overflow-y-auto">
              </div>
            </section>
<!-- MAJOR VISUALIZATIONS SECTION - FULL WIDTH ROWS -->
<section class="mb-6">
  <!-- Row 1: Funding Flow -->
  <div class="dashboard-card p-4 md:p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
      <div>
        <h3 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Funding Flow Visualization</h3>
        <p class="text-xs text-[var(--text-secondary)]">Shows top awards by total contract value from agencies to prime contractors</p>
      </div>
    </div>
    <div id="sankeyWrapper" class="w-full rounded-md mt-2">
      <svg id="sankeyChart" class="w-full h-[500px]" viewBox="0 0 1000 600" preserveAspectRatio="xMidYMid meet"></svg>
    </div>
    <p class="text-xs text-[var(--text-tertiary)] mt-2 italic">Click on any node to filter the dashboard by agency or prime</p>
  </div>
  <!-- Row 3: Office-Prime Relationship Network -->
<div class="dashboard-card p-4 md:p-6 mb-6"> <!-- Added mb-6 here -->
  <div class="flex justify-between items-center mb-4">
    <div>
      <h3 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Office-Prime Relationship Network</h3>
      <p class="text-xs text-[var(--text-secondary)]">Visualizes connections between contracting offices and prime contractors</p>
    </div>
  </div>
  <div class="overflow-x-auto">
    <svg id="contractingOfficeRelationshipMap" class="w-full h-[700px]" preserveAspectRatio="xMidYMid meet" viewBox="0 0 900 700"></svg>
  </div>
  <p class="text-xs text-[var(--text-tertiary)] mt-2 italic">Drag nodes to reposition. Click on any node to filter the dashboard.</p>
</div>
  <!-- Row 2: Prime Contractor Map -->
  <div class="dashboard-card p-4 md:p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
      <div>
        <h3 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Prime Contractor Map</h3>
        <p class="text-xs text-[var(--text-secondary)]">Geographic distribution of prime contractors</p>
      </div>
    </div>
    <div id="contractorMap" style="height: 500px; width: 100%;" class="rounded border border-[var(--border-level-2)]"></div>
  </div>
</section>
<!-- Footer as a styled card -->
<footer class="mt-6 mb-6">
  <div class="dashboard-card p-4 md:p-6 rounded-lg shadow-md border border-[var(--border-level-1)] bg-[var(--surface-level-1)]">
    <!-- Shoutouts section -->
    <div class="flex flex-col">
      <h3 class="text-md font-semibold text-[var(--accent)] mb-3 text-center">A few shoutouts!</h3>
      <!-- Mobile-friendly grid layout for shoutouts -->
      <div class="grid grid-cols-2 md:grid-cols-5 gap-3 text-center text-xs">
        <div class="p-2 bg-[var(--surface-level-2)] rounded">
          <span class="block text-[var(--accent)]">So What?!</span>
          <span class="text-[var(--text-secondary)]">@rodstedt</span>
        </div>
		<div class="p-2 bg-[var(--surface-level-2)] rounded">
          <span class="block text-[var(--accent)]">Dark Mode</span>
          <span class="text-[var(--text-secondary)]">@dongkyup</span>
        </div>
        <div class="p-2 bg-[var(--surface-level-2)] rounded">
          <span class="block text-[var(--accent)]">Why?</span>
          <span class="text-[var(--text-secondary)]">@mpben</span>
        </div>
        <div class="p-2 bg-[var(--surface-level-2)] rounded">
          <span class="block text-[var(--accent)]">Think Big</span>
          <span class="text-[var(--text-secondary)]">@ecbrown</span>
        </div>
        <div class="p-2 bg-[var(--surface-level-2)] rounded">
          <span class="block text-[var(--accent)]">Dive Deep</span>
          <span class="text-[var(--text-secondary)]">@datkd</span>
        </div>
      </div>
    </div>
  </div>
</footer>
            <div id="processingIndicator" class="hidden items-center text-[var(--text-secondary)] mt-4">
                <div class="spinner"></div>
                <span class="ml-2 text-sm">Processing data...</span>
            </div>
            <!-- Required containers - Fixed to prevent scrollbar issues -->
            <div id="s3LoadError" class="text-red-600 bg-red-100 dark:bg-red-900 dark:text-red-300 p-3 rounded-md mt-3 hidden text-sm" style="display: none; height: 0; margin: 0; padding: 0; overflow: hidden;"></div>
            <div id="dashboardContent" class="hidden" style="display: none; height: 0; margin: 0; padding: 0; overflow: hidden;"></div>
        </main>
    </div>
    <!-- Modals and Tooltips -->
    <div id="genericModal" class="modal-backdrop hidden">
        <div id="genericModalContent" class="modal-content">
            <button id="genericModalCloseBtn" class="modal-close-btn">&times;</button>
            <h2 id="genericModalTitle" class="text-xl font-semibold text-[var(--accent)] mb-4" style="font-weight: var(--header-font-weight);">Modal Title</h2>
            <div id="genericModalBody" class="text-[var(--text-secondary)]">
            </div>
        </div>    
    </div>
    <div class="event-tooltip"></div>
    <div id="shareToast" class="fixed bottom-5 right-5 bg-[var(--accent)] text-[var(--on-accent)] py-2 px-4 rounded-md shadow-lg hidden transition-opacity duration-300">
        Link copied to clipboard!
    </div>
    <div id="page-loader" class="fixed inset-0 z-50 flex items-center justify-center bg-[var(--background)]">
      <div class="flex flex-col items-center">
        <div class="spinner w-16 h-16 border-4 border-[var(--border-level-2)] border-t-[var(--accent)] rounded-full animate-spin"></div>
        <p class="mt-4 text-[var(--text-primary)]">Loading Subhoo...</p>
        <div class="hidden mt-4 p-3 bg-[var(--accent-secondary)] rounded-md text-sm" id="loader-timeout-message">
          <p class="text-[var(--text-secondary)]">Loading is taking longer than expected.</p>
          <p class="text-[var(--text-secondary)]">If you're testing locally, you'll need to upload a CSV.</p>
          <button onclick="forceShowManualUpload()" class="mt-2 px-3 py-1 bg-[var(--accent)] text-[var(--on-accent)] rounded text-sm">
            Show Upload Option
          </button>
        </div>
      </div>
    </div>
</div>
</body>
<script>
 // --- DOM Elements ---
const processingIndicator = document.getElementById('processingIndicator'); 
const manualUploadSection = document.getElementById('manual-upload-section');
const dashboardContent = document.getElementById('dashboardContent');
const csvFileInput = document.getElementById('csvFileInput');
const fileNameDisplay = document.getElementById('file-name-display');
const errorMessageDiv = document.getElementById('errorMessage');
const successMessageDiv = document.getElementById('successMessage');
const s3LoadErrorDiv = document.getElementById('s3LoadError');
const unifiedSearchInput = document.getElementById('unifiedSearchInput'); 
const unifiedSearchSuggestions = document.getElementById('unifiedSearchSuggestions'); 
const activeFilterIndicator = document.getElementById('activeFilterIndicator');
const primeProfilesContainer = document.getElementById('primeProfilesContainer');
const primeProfilesSearchInput = document.getElementById('primeProfilesSearchInput');
const globalTooltipEl = document.querySelector('.event-tooltip');
// Modal Elements
const genericModal = document.getElementById('genericModal');
const genericModalContent = document.getElementById('genericModalContent');
const genericModalTitle = document.getElementById('genericModalTitle');
const genericModalBody = document.getElementById('genericModalBody');
const genericModalCloseBtn = document.getElementById('genericModalCloseBtn');
// Prime Detail View Section Elements
const primeDetailViewSection = document.getElementById('primeDetailViewSection');
const primeDetailTitle = document.getElementById('primeDetailTitle');
const primeDetailStats = document.getElementById('primeDetailStats');
const primeDetailContractsTableContainer = document.getElementById('primeDetailContractsTableContainer');
// Theme Toggle and Share Buttons
const themeToggleBtn = document.getElementById('themeToggleBtn');
const themeIconSun = document.getElementById('themeIconSun');
const themeIconMoon = document.getElementById('themeIconMoon');
const shareViewBtn = document.getElementById('shareViewBtn');
const shareToast = document.getElementById('shareToast');
// Function to generate a dynamic welcome message with current day
function generateWelcomeTitle(data) {
  // Get current day of week
  const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  const today = new Date();
  const dayName = days[today.getDay()];
  // Calculate statistics - distinct count of contracts and primes
  const contractCount = data.length;
  const primeCount = new Set(data.map(r => r['Legal Business Name']).filter(Boolean)).size;
  // Format numbers with commas
  const formattedContractCount = contractCount.toLocaleString();
  const formattedPrimeCount = primeCount.toLocaleString();
  // Generate random greetings for variety
  const greetings = [
    `Happy ${dayName}! Welcome to Subhoo.`,
    `It's ${dayName}! Ready to explore federal contracts?`,
    `Yep, it's ${dayName}!`,
    `${dayName}'s a great day for contract intelligence!`
  ];
  // Choose a random greeting
  const greeting = greetings[Math.floor(Math.random() * greetings.length)];
  // Generate random descriptions for variety
  const descriptions = [
    `Search and click to analyze over ${formattedContractCount} contracts across ${formattedPrimeCount} Federal Prime Contractors.`,
    `Explore ${formattedContractCount} contracts and ${formattedPrimeCount} Prime Contractors with required subcontracting plans.`,
    `Discover subcontracting opportunities among ${formattedPrimeCount} primes with ${formattedContractCount} active federal contracts.`
  ];
  // Choose a random description
  const description = descriptions[Math.floor(Math.random() * descriptions.length)];
  // Return the complete welcome message
  return `<span class="greeting">${greeting}</span> <span class="description">${description}</span>`;
}
function updateDashboardTitle(titleText, isWelcome = false) {
  const titleElement = document.getElementById('currentFilterDescription');
  const titleContainer = document.getElementById('currentViewTitle');
  if (!titleElement || !titleContainer) return;
  // If it's the welcome state or no title provided, show the welcome message
  if (isWelcome || !titleText || titleText.trim() === '') {
    titleElement.innerHTML = generateWelcomeTitle(parsedData);
    titleElement.classList.add('welcome-title');
    // Apply welcome background style
    titleContainer.classList.remove('title-container-default');
    titleContainer.classList.add('title-container-welcome');
  } else {
    // For filtered views, show the filter description
    titleElement.innerHTML = titleText;
    titleElement.classList.remove('welcome-title');
    // Restore default background
    titleContainer.classList.remove('title-container-welcome');
    titleContainer.classList.add('title-container-default');
  }
}
// --- Global Variables ---
let parsedData = [];
const charts = {}; 
const S3_CSV_URL = 'https://subhoodata.s3.us-east-1.amazonaws.com/data/sba24.csv';
let currentMainStateChartFilter = 'value';
const ITEMS_PER_PAGE_MODAL_TABLE = 10; 
let currentPrimeDetailViewPage = 1; 
let isViewingSpecificPrime = false; 
let specificPrimeName = null;      
let currentPrimeDetailSort = { column: 'endDate', order: 'desc' }; 
let contractorMap; 
let contractorClusterGroup;

// --- Utility Functions ---
function formatCurrency(value) {
    if (isNaN(parseFloat(value))) { 
        return '$0';
    }
    const num = parseFloat(value);
    if (Math.abs(num) >= 1.0e+9) { 
        return '$' + (num / 1.0e+9).toFixed(1) + 'B';
    }
    if (Math.abs(num) >= 1.0e+6) { 
        return '$' + (num / 1.0e+6).toFixed(1) + 'M';
    }
    if (Math.abs(num) >= 1.0e+3) { 
        return '$' + (num / 1.0e+3).toFixed(1) + 'K';
    }
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0 
    }).format(num);
}
function parseCurrencyValue(valueStr) { if (!valueStr) return 0; return parseFloat(String(valueStr).replace(/[$,\s]/g, '')) || 0; }
function formatDate(dateStr) { if (!dateStr) return ''; const date = new Date(dateStr); return isNaN(date.getTime()) ? '' : new Intl.DateTimeFormat('en-US', { year: 'numeric', month: 'short', day: 'numeric' }).format(date); }
function createAwardLink(piid) {
    if (!piid || typeof piid !== 'string' || piid.trim() === '' || piid.toLowerCase() === 'n/a') {
        return piid || 'N/A'; 
    }
    const encodedPiid = encodeURIComponent(piid.trim());
    return `<a href="https://www.fpds.gov/ezsearch/fpdsportal?indexName=awardfull&templateName=1.5.3&s=FPDS&q=${encodedPiid}&x=18&y=15" target="_blank" rel="noopener noreferrer" class="text-[var(--accent)] hover:underline">${piid}</a>`;
}
function createEntityLink(entityId, entityName) {
    if (!entityId || typeof entityId !== 'string' || entityId.trim() === '' || entityId.toLowerCase() === 'n/a') {
        return entityName || entityId || 'N/A'; 
    }
    const encodedEntityId = encodeURIComponent(entityId.trim());
    return `<a href="https://www.fpds.gov/ezsearch/fpdsportal?s=FPDS&q=${encodedEntityId}&x=0&y=0" target="_blank" rel="noopener noreferrer" class="text-[var(--accent)] hover:underline">${entityName || entityId}</a>`;
}
function showProcessingBriefly() { processingIndicator.classList.remove('hidden'); processingIndicator.classList.add('flex'); }
function hideProcessing() { processingIndicator.classList.add('hidden'); processingIndicator.classList.remove('flex');}
function showErrorMessage(message, isAutoloadError = false) {
    if (isAutoloadError) {
        manualUploadSection.classList.remove('hidden');
        s3LoadErrorDiv.textContent = `S3 Auto-load failed: ${message}. Please use manual upload option above.`;
        s3LoadErrorDiv.classList.remove('hidden');
    } else {
        errorMessageDiv.textContent = message; errorMessageDiv.classList.remove('hidden');
        successMessageDiv.classList.add('hidden');
    }
    hideProcessing(); 
}
function showSuccessMessage(message, isAutoloadSuccess = false) {
    if (isAutoloadSuccess) {
        s3LoadErrorDiv.classList.add('hidden');
        // Ensure manual upload section is completely hidden on auto success
        if (manualUploadSection) {
            manualUploadSection.classList.add('hidden');
            manualUploadSection.style.display = 'none';
        }
    } else {
        successMessageDiv.textContent = message; 
        successMessageDiv.classList.remove('hidden');
        errorMessageDiv.classList.add('hidden');
    }
    hideProcessing();
}
// --- Data Processing and Chart Initialization ---
function cleanupCharts() { Object.keys(charts).forEach(key => { if (charts[key]) { charts[key].destroy(); charts[key] = null; } }); }
function processAndInitialize(data) {
  try {
    if (!data || data.length === 0) { 
      showErrorMessage('No data to display. Please try manual upload or check the S3 source.', true); 
      return; 
    }
    
    parsedData = data; 
    activeFilterIndicator.classList.add('hidden');
    
    if (manualUploadSection) {
      manualUploadSection.classList.add('hidden');
      manualUploadSection.style.display = 'none';
    }
    
    s3LoadErrorDiv.classList.add('hidden');
    primeDetailViewSection.classList.add('hidden');
    dashboardContent.classList.remove('hidden');
    dashboardContent.classList.add('data-loaded');
    
    const pageLoader = document.getElementById('page-loader');
    if (pageLoader) {
      pageLoader.style.opacity = '0';
      pageLoader.style.pointerEvents = 'none';
      setTimeout(function() { 
        pageLoader.style.display = 'none'; 
      }, 300);
    }
    
    updateDashboardTitle('', true);
    getChartColors(); 
    cleanupCharts(); 
    initializeChartDefaults();
    initializeCoreVisuals(parsedData);
    setupUnifiedSearch();
    initializePrimeProfilesSection(parsedData);
    initializeContractorMap(data);
    showSuccessMessage('Data loaded and dashboard initialized.', true);
    applyInitialTheme();
    
    // REMOVED: applyFiltersFromURL(); 
    
    // DIRECT URL handling with debug logs
    setTimeout(() => {
      console.log('Checking URL for filters...');
      const urlParams = new URLSearchParams(window.location.search);
      const searchParam = urlParams.get('search');
      const filterTypeParam = urlParams.get('filterType');
      const filterValueParam = urlParams.get('filterValue');
      
      console.log('URL params found:', { searchParam, filterTypeParam, filterValueParam });
      
      if (filterTypeParam && filterValueParam) {
        const decodedValue = decodeURIComponent(filterValueParam.replace(/\+/g, ' '));
        console.log('Applying filter type with value:', decodedValue);
        if (unifiedSearchInput) unifiedSearchInput.value = decodedValue;
        applyFilter(decodedValue, filterTypeParam, decodedValue);
      } else if (searchParam) {
        const decodedSearch = decodeURIComponent(searchParam.replace(/\+/g, ' '));
        console.log('Applying search with term:', decodedSearch);
        if (unifiedSearchInput) unifiedSearchInput.value = decodedSearch;
        applyFilter(decodedSearch);
      } else {
        console.log('No URL parameters to apply');
      }
    }, 1000);
    
  } catch (error) {
    console.error("Error during processAndInitialize:", error);
    showErrorMessage("An error occurred while initializing the dashboard. Please try refreshing.", false);
  } finally {
    hideProcessing();
  }
}
// --- S3 Data Loading ---
function loadDataFromS3() { 
    showProcessingBriefly(); 
    // Add timeout for better error handling
    const timeoutPromise = new Promise((_, reject) => {
        setTimeout(() => reject(new Error("Request timed out")), 20000);
    });
    // Flag to track if S3 loading has completed one way or another
    window.s3LoadingComplete = false;
    Promise.race([
        fetch(S3_CSV_URL, { mode: 'cors', cache: 'no-cache', headers: { 'Accept': 'text/csv' } }),
        timeoutPromise
    ])
    .then(response => {
        if (!response.ok) {
            let errorDetail = `HTTP error ${response.status}`;
            if (response.status === 0) errorDetail = "Network error or CORS issue.";
            else if (response.status === 403) errorDetail = "Access Forbidden (403).";
            else if (response.status === 404) errorDetail = "File Not Found (404).";
            throw new Error(`S3 Load Error: ${errorDetail}`);
        }
        return response.text();
    })
    .then(csvText => {
        if (!csvText || csvText.trim() === '') { 
            window.s3LoadingComplete = true;
            showErrorMessage('S3 file is empty.', true); 
            return; 
        }
        Papa.parse(csvText, {
            header: true,
            dynamicTyping: true, 
            skipEmptyLines: true,
            complete: results => {
                window.s3LoadingComplete = true;
                if (results.errors && results.errors.length > 0) { 
                    showErrorMessage('Error parsing CSV from S3: ' + results.errors[0].message, true); 
                    return; 
                }
                if (results.data && results.data.length > 0) processAndInitialize(results.data);
                else showErrorMessage('No data parsed from S3 file.', true);
            },
            error: error => {
                window.s3LoadingComplete = true;
                showErrorMessage('Error parsing CSV data from S3: ' + error.message, true);
            }
        });
    })
    .catch(error => {
        window.s3LoadingComplete = true;
        let errorMsg = error.message; 
        if (navigator.onLine === false && !errorMsg.includes("offline")) errorMsg += " You may also be offline.";
        showErrorMessage(errorMsg, true); 
    });
    // Fallback timeout - if S3 loading hasn't completed after 12 seconds, show manual upload
    setTimeout(() => {
        if (!window.s3LoadingComplete) {
            window.s3LoadingComplete = true;
            showErrorMessage('S3 loading timed out. Please use manual upload.', true);
            manualUploadSection.classList.add('timeout-show');
        }
    }, 12000);
}
// Initialize Chart.js defaults for better mobile experience
function initializeChartDefaults() {
  // Better touch handling for all charts
  Chart.defaults.interaction = {
    mode: 'nearest',
    intersect: false,
    axis: 'xy'
  };
  // Adjust font sizes for mobile
  const isMobile = window.innerWidth < 768;
  Chart.defaults.font.size = isMobile ? 10 : 12;
  // Set defaults for better mobile UX
  Chart.defaults.plugins.tooltip.enabled = true;
  Chart.defaults.plugins.tooltip.displayColors = true;
  Chart.defaults.responsive = true;
  Chart.defaults.maintainAspectRatio = false;
}
function initializeContractorMap(data) {
  // Define your custom color scale
const customColorScale = [
  '#213a45', // Deep blue
  '#5e6276', // Blue-purple
  '#856c85', // Purple
  '#b38595', // Pink
  '#d99184', // Coral
  '#ccb9b3'  // Orange
];
  if (!contractorMap) {
    contractorMap = L.map('contractorMap').setView([39.8283, -98.5795], 3);
    // Use the Streets style from MapTiler instead of OpenStreetMap
    L.tileLayer('https://api.maptiler.com/maps/openstreetmap/{z}/{x}/{y}.jpg?key=6aiOr0BMGcTLjUNBbDsy', {
  attribution: '&copy; <a href="https://www.maptiler.com/">MapTiler</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
  tileSize: 512,
  zoomOffset: -1,
  maxZoom: 18
}).addTo(contractorMap);
  }
  if (contractorClusterGroup) {
    contractorClusterGroup.clearLayers();
  } else {
    contractorClusterGroup = L.markerClusterGroup({
      maxClusterRadius: 40,
      disableClusteringAtZoom: 10,
      iconCreateFunction: function (cluster) {
        const count = cluster.getChildCount();
        let size = 'small';
        let color = customColorScale[1]; // Navy purple
        if (count > 100) {
          size = 'large';
          color = customColorScale[0]; // Deep blue
        } else if (count > 20) {
          size = 'medium';
          color = customColorScale[2]; // Purple
        }
        return new L.DivIcon({
          html: `<div class="cluster-icon ${size}" style="background-color: ${color};">${count}</div>`,
          className: 'custom-cluster',
          iconSize: [30, 30]
        });
      }
    });
    contractorMap.addLayer(contractorClusterGroup);
  }
  const seenCoords = new Set();
  const isMobile = window.innerWidth < 768;
  const dataToProcess = isMobile && data.length > 500 ? data.slice(0, 500) : data;
  dataToProcess.forEach(row => {
    const location = row.Location;
    if (!location || !row["Legal Business Name"]) return;
    const [latStr, lngStr] = location.split(',').map(s => s.trim());
    const lat = parseFloat(latStr);
    const lng = parseFloat(lngStr);
    if (isNaN(lat) || isNaN(lng) || lat === 0 || lng === 0) return;
    const coordKey = `${lat.toFixed(4)}|${lng.toFixed(4)}`;
    if (seenCoords.has(coordKey)) return;
    seenCoords.add(coordKey);
    const businessName = row["Legal Business Name"];
    const city = row["Vendor Address City"] || "";
    const state = row["Vendor Address State"] || "";
    const locationText = city && state ? `${city}, ${state}` : "";
    const tooltipText = `${businessName}${locationText ? `  ${locationText}` : ""}`;
    const popupText = `<strong>${businessName}</strong>${locationText ? `<br>${locationText}` : ""}`;
    // Get contract value if available
    let value = 0;
    if (row["Base and All Options Value (Total Contract Value)"]) {
      value = parseCurrencyValue(row["Base and All Options Value (Total Contract Value)"]);
    }
    // Pass value to determine marker color
    const marker = createStyledMarker(lat, lng, businessName, value);
    marker.bindPopup(popupText);
    contractorClusterGroup.addLayer(marker);
  });
  if (contractorClusterGroup && contractorClusterGroup.getLayers().length > 0) {
    contractorMap.fitBounds(contractorClusterGroup.getBounds(), {
      padding: [30, 30],
      maxZoom: 3
    });
  }
  setTimeout(() => {
    contractorMap.invalidateSize();
  }, 200);
}
function createStyledMarker(lat, lng, label, value) {
  // Get the appropriate color based on value
  const color = getMarkerColor(value);
  const markerHtml = `<div class="custom-marker" title="${label}" style="background-color: ${color};"></div>`;
  return L.marker([lat, lng], {
    icon: L.divIcon({
      className: '',
      html: markerHtml,
      iconSize: [12, 12],
      iconAnchor: [6, 6]
    })
  });
}
function getMarkerColor(value) {
  // Use your custom color scale to determine marker color based on value
  if (value > 1000000000) return '#003f5c'; // Deep blue for >$1B
  if (value > 500000000) return '#444e86';  // Navy purple for >$500M
  if (value > 100000000) return '#955196';  // Purple for >$100M
  if (value > 50000000) return '#dd5182';   // Pink for >$50M
  if (value > 10000000) return '#ff6e54';   // Coral for >$10M
  return '#ffa600';                        // Orange for the rest
}
// Helper function to parse currency values
function parseCurrencyValue(valueStr) {
  if (!valueStr) return 0;
  if (typeof valueStr === 'number') return valueStr;
  // Remove currency symbols and commas, then parse as float
  return parseFloat(valueStr.toString().replace(/[$,]/g, '')) || 0;
}
// --- Unified Search, Suggestions, and Filtering Logic ---
function applyFilter(searchTerm, filterType = null, filterValue = null) { 
    try {
        let filteredData;
        let displaySearchTerm = searchTerm; 
        // Find chart containers
        const marketShareCard = document.getElementById('marketShareChartCard');
        const primeContractorsCard = document.getElementById('primeContractorsChartCard');
        // Get the chart grid for layout adjustments
        const chartGrid = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-3.gap-4.md\\:gap-6');
        if (filterType === 'primeName') {
            isViewingSpecificPrime = true; 
            specificPrimeName = filterValue || searchTerm; 
            const primeToFilter = specificPrimeName;
            filteredData = parsedData.filter(record => (record['Legal Business Name']?.toLowerCase() || '') === primeToFilter.toLowerCase());
            displaySearchTerm = `Prime: ${primeToFilter}`;
            renderPrimeDetailView(primeToFilter, filteredData); // This will show the section
            // Update the title
            updateDashboardTitle(`Viewing contracts for ${primeToFilter}`);
            // Completely hide prime-specific charts
            if(marketShareCard) marketShareCard.classList.add('hidden');
            if(primeContractorsCard) primeContractorsCard.classList.add('hidden');
            // Adjust the chart grid layout
            if (chartGrid) {
                // Change from 3-column to 2-column layout for large screens
                chartGrid.classList.remove('lg:grid-cols-3');
                chartGrid.classList.add('lg:grid-cols-2');
                // Move more important charts to the top positions
                const visibleCharts = Array.from(chartGrid.children).filter(card => 
                    !card.classList.contains('hidden')
                );
                // Reorder the visible charts
                visibleCharts.forEach((chart, index) => {
                    chart.style.order = index;
                });
            }
        } else if (filterType) { 
            isViewingSpecificPrime = false; 
            specificPrimeName = null;
            primeDetailViewSection.classList.add('hidden'); // Hide prime detail for other filters
            // Restore visibility of prime charts
            if(marketShareCard) marketShareCard.classList.remove('hidden');
            if(primeContractorsCard) primeContractorsCard.classList.remove('hidden');
            // Restore original grid layout
            if (chartGrid) {
                chartGrid.classList.remove('lg:grid-cols-2');
                chartGrid.classList.add('lg:grid-cols-3');
                // Reset any order modifications
                Array.from(chartGrid.children).forEach(chart => {
                    chart.style.order = '';
                });
            }
            const termToMatch = (filterValue || searchTerm).toLowerCase();
            // UPDATED: Special handling for NAICS description keywords
            if (filterType === 'naicsDesc') {
                // For NAICS description, we want to filter for any description containing the keyword
                filteredData = parsedData.filter(record => {
                    const naicsDesc = (record['NAICS Description'] || '').toLowerCase();
                    return naicsDesc.includes(termToMatch);
                });
            } else {
                // Handle all other filter types normally
                filteredData = parsedData.filter(record => {
                    let recordValue = '';
                    switch (filterType) {
                        case 'naicsCode': recordValue = String(record['NAICS Code'] || '').toLowerCase(); break;
                        case 'departmentName': recordValue = record['Contracting Department Name']?.toLowerCase() || ''; break; 
                        case 'agencyName': recordValue = record['Contracting Agency Name']?.toLowerCase() || ''; break;
                        case 'officeName': recordValue = record['Contracting Office Name']?.toLowerCase() || ''; break;
                        case 'stateCode': recordValue = record['Principal Place of Performance State Code']?.toLowerCase() || ''; break;
                        case 'contractType': recordValue = record['Award or Indefinite Delivery Vehicle Type']?.toLowerCase() || ''; break; 
                        default: return false;
                    }
                    if (filterValue) return recordValue === termToMatch; 
                    return recordValue.includes(termToMatch); 
                });
            }
            // Format the display search term for different filter types
            let filterTypeDisplay = "";
            switch (filterType) {
                case 'naicsCode': filterTypeDisplay = "NAICS Code"; break;
                case 'naicsDesc': filterTypeDisplay = "NAICS Keyword"; break; // CHANGED: From "Description" to "Keyword"
                case 'departmentName': filterTypeDisplay = "Department"; break;
                case 'agencyName': filterTypeDisplay = "Agency"; break;
                case 'officeName': filterTypeDisplay = "Office"; break;
                case 'stateCode': filterTypeDisplay = "State"; break;
                case 'contractType': filterTypeDisplay = "Contract Type"; break;
                default: filterTypeDisplay = filterType.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
            }
            displaySearchTerm = `${filterTypeDisplay}: ${filterValue || searchTerm}`;
            // Update the title - using our dedicated function 
            updateDashboardTitle(`Filtered by ${displaySearchTerm} (${filteredData.length.toLocaleString()} results)`);
        } else { // ENHANCED: General keyword search with better acronym handling
            isViewingSpecificPrime = false; 
            specificPrimeName = null;
            primeDetailViewSection.classList.add('hidden');
            
            // Restore visibility of prime charts
            if(marketShareCard) marketShareCard.classList.remove('hidden');
            if(primeContractorsCard) primeContractorsCard.classList.remove('hidden');
            
            // Restore original grid layout
            if (chartGrid) {
                chartGrid.classList.remove('lg:grid-cols-2');
                chartGrid.classList.add('lg:grid-cols-3');
                Array.from(chartGrid.children).forEach(chart => {
                    chart.style.order = '';
                });
            }

            if (!searchTerm || searchTerm.trim() === '') {
                clearAllFilters(); 
                return;
            }
            
            // ENHANCED: Expand acronyms before processing
            const expandedTerm = expandAcronyms(searchTerm);
            const isExpanded = expandedTerm !== searchTerm;
            
            console.log(`Search: "${searchTerm}" ${isExpanded ? ` "${expandedTerm}"` : '(no expansion)'}`);
            
            // Create comprehensive search terms including both original and expanded
            const searchTermsToUse = isExpanded ? 
                `${searchTerm} ${expandedTerm}`.toLowerCase() : 
                searchTerm.toLowerCase();
            
            const keywords = searchTermsToUse.split(' ').filter(k => k.length >= 1); // Allow single letters for better matching
            
            // ENHANCED: More flexible filtering that handles partial matches
            filteredData = parsedData.filter(record => {
                return keywords.every(keyword => { // Changed from 'every' to 'some' for more flexible matching
                    const primeName = record['Legal Business Name']?.toLowerCase() || '';
                    const naicsCode = String(record['NAICS Code'] || '').toLowerCase();
                    const naicsDesc = record['NAICS Description']?.toLowerCase() || '';
                    const departmentName = record['Contracting Department Name']?.toLowerCase() || '';
                    const agencyName = record['Contracting Agency Name']?.toLowerCase() || '';
                    const officeName = record['Contracting Office Name']?.toLowerCase() || '';
                    const stateCode = record['Principal Place of Performance State Code']?.toLowerCase() || '';
                    const contractorCity = record['Vendor Address City']?.toLowerCase() || '';
                    
                    return primeName.includes(keyword) || 
                           naicsCode.includes(keyword) ||
                           naicsDesc.includes(keyword) || 
                           departmentName.includes(keyword) ||
                           agencyName.includes(keyword) || 
                           officeName.includes(keyword) ||
                           contractorCity.includes(keyword) ||
                           (keyword.length === 2 && stateCode === keyword) ||
                           (keyword.length > 2 && stateCode.includes(keyword));
                });
            });
            
            // If we get no results with expanded terms, try just the original term
            if (filteredData.length === 0 && isExpanded) {
                console.log("No results with expanded terms, trying original term only");
                const originalKeywords = searchTerm.toLowerCase().split(' ').filter(k => k.length >= 1);
                
                filteredData = parsedData.filter(record => {
                    return originalKeywords.some(keyword => {
                        const primeName = record['Legal Business Name']?.toLowerCase() || '';
                        const naicsCode = String(record['NAICS Code'] || '').toLowerCase();
                        const naicsDesc = record['NAICS Description']?.toLowerCase() || '';
                        const departmentName = record['Contracting Department Name']?.toLowerCase() || '';
                        const agencyName = record['Contracting Agency Name']?.toLowerCase() || '';
                        const officeName = record['Contracting Office Name']?.toLowerCase() || '';
                        const stateCode = record['Principal Place of Performance State Code']?.toLowerCase() || '';
                        const contractorCity = record['Vendor Address City']?.toLowerCase() || '';
                        
                        return primeName.includes(keyword) || 
                               naicsCode.includes(keyword) ||
                               naicsDesc.includes(keyword) || 
                               departmentName.includes(keyword) ||
                               agencyName.includes(keyword) || 
                               officeName.includes(keyword) ||
                               contractorCity.includes(keyword) ||
                               (keyword.length === 2 && stateCode === keyword) ||
                               (keyword.length > 2 && stateCode.includes(keyword));
                    });
                });
            }
            
            const displayTerm = isExpanded ? `"${searchTerm}" (expanded to include ${expandedTerm})` : `"${searchTerm}"`;
            updateDashboardTitle(`Search results for ${displayTerm} (${filteredData.length.toLocaleString()} results)`);
        }
        // Initialize visualizations with filtered data
		console.log(`Filter applied: ${filteredData.length} results found`);
        initializeCoreVisuals(filteredData, isViewingSpecificPrime); 
        initializePrimeProfilesSection(filteredData); 
        initializeContractorMap(filteredData);
        renderSankeyChart(filteredData);
        createPrimeSpecializationHeatmap(filteredData);
		createContractingOfficeRelationshipMap(filteredData);
		createContractOpportunityForecast(filteredData);
		updateActiveFilterIndicator(displaySearchTerm, filteredData.length);
        unifiedSearchSuggestions.innerHTML = ''; 
        unifiedSearchSuggestions.classList.add('hidden');
    } catch (error) {
        console.error("Error during filter application:", error);
    }
}
// Improved canvas recreation function that works even when canvas was replaced with "No data" message
function recreateChartCanvas(canvasId) {
  // First, try to find the container through the chart's data structure
  let container;
  // Try to find container even if the canvas doesn't exist anymore
  if (charts[canvasId] && charts[canvasId].canvas && charts[canvasId].canvas.parentElement) {
    // Chart instance exists and has a canvas with a parent
    container = charts[canvasId].canvas.parentElement;
  } else {
    // Try to find the container directly
    container = document.getElementById(canvasId)?.parentElement;
    // If that didn't work, look for a chart-container that contains a "no data" message
    if (!container) {
      // Find all chart containers
      const chartContainers = document.querySelectorAll('.chart-container');
      // Look through chart containers for one that might be our target
      for (const potentialContainer of chartContainers) {
        // If this container has the "no data" message
        if (potentialContainer.querySelector('.chart-no-data')) {
          // Store a reference to use later
          container = potentialContainer;
          console.log(`Found container with "no data" message that might be for ${canvasId}`);
          break;
        }
      }
    }
  }
  // If we still don't have a container, try a more direct approach
  if (!container) {
    // For the contract opportunity chart specifically
    if (canvasId === 'contractOpportunityForecastChart') {
      // Try to find its specific parent container
      const opportunityCard = document.querySelector('.dashboard-card:has(.chart-container:has(.chart-no-data), h3:contains("Upcoming Contract Expirations"))');
      if (opportunityCard) {
        container = opportunityCard.querySelector('.chart-container');
        console.log("Found opportunity chart container through card heading");
      }
    }
  }
  if (!container) {
    console.error(`Container for ${canvasId} not found using any method`);
    return false;
  }
  // Clear any existing chart instance
  if (charts[canvasId]) {
    charts[canvasId].destroy();
    charts[canvasId] = null;
  }
  // Remove the existing content
  container.innerHTML = '';
  // Create a new canvas with the proper ID
  const canvas = document.createElement('canvas');
  canvas.id = canvasId;
  container.appendChild(canvas);
  console.log(`Canvas ${canvasId} recreated successfully`);
  return true;
}
function clearAllFilters() {
  // Reset the filter state
currentFilterState = {
    searchTerm: '',
    expandedTerm: '',
    filterType: null,
    filterValue: null,
    resultCount: 0,
    isActive: false
};
  try {
    console.log("Starting filter reset process");
    // Reset search interface
    unifiedSearchInput.value = '';
    activeFilterIndicator.classList.add('hidden');
    unifiedSearchSuggestions.innerHTML = '';
    unifiedSearchSuggestions.classList.add('hidden');
	updateDashboardTitle('', true);
    // Hide all detail views
    primeDetailViewSection.classList.add('hidden'); 
    isViewingSpecificPrime = false; 
    specificPrimeName = null;
    // Close all detail sections
    if (typeof closeAllDetailSections === 'function') {
      closeAllDetailSections();
    } else {
      // Fallback if function doesn't exist
      const specializationDetailsSection = document.getElementById('specializationDetailsSection');
      if (specializationDetailsSection) specializationDetailsSection.classList.add('hidden');
      const contractExpirationDetails = document.getElementById('contractExpirationDetails');
      if (contractExpirationDetails) contractExpirationDetails.classList.add('hidden');
    }
    // Reset ALL state variables
    currentSpecializationData = { prime: null, naics: null, naicsDescription: null, specializationIndex: 0, totalValue: 0, contracts: [] };
    currentSpecPage = 1;
    currentOpportunityData = [];
    currentOpportunityPage = 1;
    currentPrimeDetailViewPage = 1;
    currentPrimeDetailSort = { column: 'endDate', order: 'desc' };
    // Reset chart visibility and layout
    // 1. Make sure chart visibility is correct
    const marketShareCard = document.getElementById('marketShareChartCard');
    const primeContractorsCard = document.getElementById('primeContractorsChartCard');
    if(marketShareCard) marketShareCard.classList.remove('hidden');
    if(primeContractorsCard) primeContractorsCard.classList.remove('hidden');
    // 2. Restore original grid layout
    const chartGrid = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-3.gap-4.md\\:gap-6, .grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-2.gap-4.md\\:gap-6');
    if (chartGrid) {
      // Ensure we're back to 3-column layout
      chartGrid.classList.remove('lg:grid-cols-2');
      chartGrid.classList.add('lg:grid-cols-3');
      // Reset order on all chart cards
      const allCharts = chartGrid.querySelectorAll('.dashboard-card');
      allCharts.forEach(chart => {
        chart.style.order = '';
      });
    }
    // Reset the dashboard title
    updateDashboardTitle('', true);
    // Reset D3 visualizations first
    if (typeof relationshipMapSimulation !== 'undefined' && relationshipMapSimulation) {
      relationshipMapSimulation.stop();
      relationshipMapSimulation = null;
    }
    d3.select('#contractingOfficeRelationshipMap').selectAll('*').remove();
    d3.select('#sankeyChart').selectAll('*').remove();
    d3.select('#primeSpecializationHeatmap').selectAll('*').remove();
    d3.selectAll('.d3-relationship-tooltip').remove();
    d3.selectAll('.heatmap-tooltip').remove();
    // Explicitly destroy all chart instances
    Object.keys(charts).forEach(chartId => {
      if (charts[chartId]) {
        charts[chartId].destroy();
        charts[chartId] = null;
      }
    });
    // Reset map view
    if (contractorMap) {
      contractorMap.setView([39.8283, -98.5795], 3);
    }
    // IMPORTANT: Recreate all chart canvases before initializing visualizations
    console.log("Recreating chart canvases");
    // List all chart canvas IDs that need recreation
    const chartCanvasIds = [
      'primeContractorsChart',
      'marketShareChart',
      'naicsChart_main',
      'stateContractsChart_main',
      'departmentChart',
      'timelineChart',
      'contractTypeChart_main',
      'topAgenciesChart',
      'contractOpportunityForecastChart'
    ];
    // Recreate each canvas
    chartCanvasIds.forEach(canvasId => {
      recreateChartCanvas(canvasId);
    });
    console.log("All chart canvases recreated, now initializing visualizations");
    // Now reinitialize everything with the full dataset
    initializeCoreVisuals(parsedData, false);
    initializePrimeProfilesSection(parsedData);
    initializeContractorMap(parsedData);
    // Handle D3 visualizations that need to be explicitly recreated
    renderSankeyChart(parsedData);
    createPrimeSpecializationHeatmap(parsedData);
    createContractingOfficeRelationshipMap(parsedData);
    // CRITICAL FIX: First verify the canvas exists, then create with longer delay
    const opportunityForecastCanvas = document.getElementById('contractOpportunityForecastChart');
    if (!opportunityForecastCanvas) {
      console.log("Opportunity forecast canvas not found, attempting to recreate");
      recreateChartCanvas('contractOpportunityForecastChart');
    }
    // Use a longer delay for the opportunity forecast chart
    console.log("Scheduling opportunity forecast chart creation");
    setTimeout(() => {
      if (document.getElementById('contractOpportunityForecastChart')) {
        console.log("Creating opportunity forecast chart");
        createContractOpportunityForecast(parsedData);
      } else {
        console.error("Opportunity forecast canvas not found after timeout");
        // Last resort - try one more time with a final recreation and longer timeout
        recreateChartCanvas('contractOpportunityForecastChart');
        setTimeout(() => {
          if (document.getElementById('contractOpportunityForecastChart')) {
            console.log("Final attempt to create opportunity forecast chart");
            createContractOpportunityForecast(parsedData);
          } else {
            console.error("Opportunity forecast canvas not found after final attempt");
          }
        }, 500);
      }
    }, 300);
    // Force a layout recalculation after changing visibility and grid layout
    setTimeout(() => {
      window.dispatchEvent(new Event('resize'));
    }, 100);
    console.log("All filters and visualizations reset complete");
  } catch (error) {
    console.error("Error during clearing filters:", error);
  }
}
function updateActiveFilterIndicator(searchTerm, count) {
    const activeFilterIndicator = document.getElementById('activeFilterIndicator');
    if (searchTerm && searchTerm.trim() !== '') {
        // Update the sidebar filter indicator
        activeFilterIndicator.innerHTML = `
          <div class="text-sm font-medium text-[var(--text-secondary)] mb-2">Active Filters:</div>
          <div class="active-filter-tag">
            <span>${searchTerm}</span>
            <button onclick="clearAllFilters()" class="clear-filter-btn">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          <div class="text-xs text-[var(--text-secondary)]">${count.toLocaleString()} results</div>
        `;
        activeFilterIndicator.classList.remove('hidden');
        // Note: We now update the main title via the dedicated function in each filter type handler
    } else {
        activeFilterIndicator.classList.add('hidden');
        // Reset the main content title to default via dedicated function
        updateDashboardTitle('', true);
    }
}
function selectSearchSuggestion(term, type, originalValue) { 
    unifiedSearchInput.value = originalValue; 
    applyFilter(originalValue, type, originalValue); 
    unifiedSearchSuggestions.innerHTML = '';
    unifiedSearchSuggestions.classList.add('hidden');
}
// Enhanced Agency and Department Acronym Dictionary with Partial Matching
const AGENCY_ACRONYM_MAP = {
  // Major Departments
  'dod': 'DEPT OF DEFENSE',
  'defense': 'DEPT OF DEFENSE',
  'army': 'DEPT OF THE ARMY',
  'navy': 'DEPT OF THE NAVY',
  'usn': 'DEPT OF THE NAVY',
  'airforce': 'DEPT OF THE AIR FORCE',
  'usaf': 'DEPT OF THE AIR FORCE',
  'air force': 'DEPT OF THE AIR FORCE',
  'spaceforce': 'DEPT OF THE AIR FORCE',
  'ussf': 'DEPT OF THE AIR FORCE',
  
  // Justice Department
  'doj': 'JUSTICE, DEPARTMENT OF',
  'justice': 'JUSTICE, DEPARTMENT OF',
  'fbi': 'FEDERAL BUREAU OF INVESTIGATION',
  'dea': 'DRUG ENFORCEMENT ADMINISTRATION',
  'atf': 'BUREAU OF ALCOHOL, TOBACCO, FIREARMS AND EXPLOSIVES',
  'bop': 'FEDERAL BUREAU OF PRISONS',
  'usms': 'U.S. MARSHALS SERVICE',
  'marshals': 'U.S. MARSHALS SERVICE',
  
  // Homeland Security
  'dhs': 'HOMELAND SECURITY, DEPARTMENT OF',
  'homeland': 'HOMELAND SECURITY, DEPARTMENT OF',
  'tsa': 'TRANSPORTATION SECURITY ADMINISTRATION',
  'ice': 'U.S. IMMIGRATION AND CUSTOMS ENFORCEMENT',
  'cbp': 'U.S. CUSTOMS AND BORDER PROTECTION',
  'customs': 'U.S. CUSTOMS AND BORDER PROTECTION',
  'border patrol': 'U.S. CUSTOMS AND BORDER PROTECTION',
  'uscg': 'U.S. COAST GUARD',
  'coast guard': 'U.S. COAST GUARD',
  'fema': 'FEDERAL EMERGENCY MANAGEMENT AGENCY',
  'secret service': 'U.S. SECRET SERVICE',
  'usss': 'U.S. SECRET SERVICE',
  
  // Health and Human Services
  'hhs': 'HEALTH AND HUMAN SERVICES, DEPARTMENT OF',
  'health': 'HEALTH AND HUMAN SERVICES, DEPARTMENT OF',
  'cdc': 'CENTERS FOR DISEASE CONTROL AND PREVENTION',
  'fda': 'FOOD AND DRUG ADMINISTRATION',
  'nih': 'NATIONAL INSTITUTES OF HEALTH',
  'cms': 'CENTERS FOR MEDICARE & MEDICAID SERVICES',
  
  // Veterans Affairs
  'va': 'VETERANS AFFAIRS, DEPARTMENT OF',
  'veterans': 'VETERANS AFFAIRS, DEPARTMENT OF',
  'dva': 'VETERANS AFFAIRS, DEPARTMENT OF',
  
  // Transportation
  'dot': 'TRANSPORTATION, DEPARTMENT OF',
  'transportation': 'TRANSPORTATION, DEPARTMENT OF',
  'faa': 'FEDERAL AVIATION ADMINISTRATION',
  'aviation': 'FEDERAL AVIATION ADMINISTRATION',
  'fhwa': 'FEDERAL HIGHWAY ADMINISTRATION',
  'nhtsa': 'NATIONAL HIGHWAY TRAFFIC SAFETY ADMINISTRATION',
  'fra': 'FEDERAL RAILROAD ADMINISTRATION',
  
  // Treasury
  'treasury': 'TREASURY, DEPARTMENT OF THE',
  'tres': 'TREASURY, DEPARTMENT OF THE',
  'irs': 'INTERNAL REVENUE SERVICE',
  
  // Energy
  'doe': 'ENERGY, DEPARTMENT OF',
  'energy': 'ENERGY, DEPARTMENT OF',
  
  // Agriculture
  'usda': 'AGRICULTURE, DEPARTMENT OF',
  'agriculture': 'AGRICULTURE, DEPARTMENT OF',
  'fsis': 'FOOD SAFETY AND INSPECTION SERVICE',
  'forest service': 'FOREST SERVICE',
  
  // Interior
  'doi': 'INTERIOR, DEPARTMENT OF THE',
  'interior': 'INTERIOR, DEPARTMENT OF THE',
  'nps': 'NATIONAL PARK SERVICE',
  'parks': 'NATIONAL PARK SERVICE',
  'usgs': 'U.S. GEOLOGICAL SURVEY',
  'blm': 'BUREAU OF LAND MANAGEMENT',
  
  // Commerce
  'doc': 'COMMERCE, DEPARTMENT OF',
  'commerce': 'COMMERCE, DEPARTMENT OF',
  'noaa': 'NATIONAL OCEANIC AND ATMOSPHERIC ADMINISTRATION',
  'weather': 'NATIONAL OCEANIC AND ATMOSPHERIC ADMINISTRATION',
  'census': 'BUREAU OF THE CENSUS',
  'nist': 'NATIONAL INSTITUTE OF STANDARDS AND TECHNOLOGY',
  
  // Labor
  'dol': 'LABOR, DEPARTMENT OF',
  'labor': 'LABOR, DEPARTMENT OF',
  'osha': 'OCCUPATIONAL SAFETY AND HEALTH ADMINISTRATION',
  
  // Education
  'ed': 'EDUCATION, DEPARTMENT OF',
  'education': 'EDUCATION, DEPARTMENT OF',
  
  // Housing
  'hud': 'HOUSING AND URBAN DEVELOPMENT, DEPARTMENT OF',
  'housing': 'HOUSING AND URBAN DEVELOPMENT, DEPARTMENT OF',
  
  // State Department
  'state': 'STATE, DEPARTMENT OF',
  'dos': 'STATE, DEPARTMENT OF',
  
  // Independent Agencies
  'nasa': 'NATIONAL AERONAUTICS AND SPACE ADMINISTRATION',
  'space': 'NATIONAL AERONAUTICS AND SPACE ADMINISTRATION',
  'epa': 'ENVIRONMENTAL PROTECTION AGENCY',
  'environment': 'ENVIRONMENTAL PROTECTION AGENCY',
  'gsa': 'GENERAL SERVICES ADMINISTRATION',
  'sba': 'SMALL BUSINESS ADMINISTRATION',
  'small business': 'SMALL BUSINESS ADMINISTRATION',
  'ssa': 'SOCIAL SECURITY ADMINISTRATION',
  'social security': 'SOCIAL SECURITY ADMINISTRATION',
  'usps': 'U.S. POSTAL SERVICE',
  'postal': 'U.S. POSTAL SERVICE',
  'post office': 'U.S. POSTAL SERVICE',
  
  // Intelligence
  'cia': 'CENTRAL INTELLIGENCE AGENCY',
  'nsa': 'NATIONAL SECURITY AGENCY',
  'dni': 'OFFICE OF THE DIRECTOR OF NATIONAL INTELLIGENCE',
  
  // Financial
  'sec': 'SECURITIES AND EXCHANGE COMMISSION',
  'fdic': 'FEDERAL DEPOSIT INSURANCE CORPORATION',
  'fed': 'FEDERAL RESERVE SYSTEM',
  'federal reserve': 'FEDERAL RESERVE SYSTEM',
  
  // Regulatory
  'fcc': 'FEDERAL COMMUNICATIONS COMMISSION',
  'ftc': 'FEDERAL TRADE COMMISSION',
  'nlrb': 'NATIONAL LABOR RELATIONS BOARD'
};

function expandAcronyms(searchTerm) {
  const lowerTerm = searchTerm.toLowerCase().trim();
  
  // First, check for exact acronym match
  if (AGENCY_ACRONYM_MAP[lowerTerm]) {
    return AGENCY_ACRONYM_MAP[lowerTerm];
  }
  
  // Handle multi-word terms where one word might be an acronym
  const words = lowerTerm.split(/\s+/);
  let hasExpansion = false;
  const expandedWords = words.map(word => {
    // Remove common punctuation
    const cleanWord = word.replace(/[.,;:!?]/g, '');
    if (AGENCY_ACRONYM_MAP[cleanWord]) {
      hasExpansion = true;
      return AGENCY_ACRONYM_MAP[cleanWord];
    }
    return word;
  });
  
  // If we expanded something, return the expanded version
  if (hasExpansion) {
    return expandedWords.join(' ');
  }
  
  // If no exact match, try partial matching for common cases
  if (words.length > 1) {
    const partiallyExpanded = words.map(word => {
      const cleanWord = word.replace(/[.,;:!?]/g, '');
      return AGENCY_ACRONYM_MAP[cleanWord] || word;
    });
    
    // Only return if at least one word was expanded
    const anyExpanded = partiallyExpanded.some((word, index) => word !== words[index]);
    if (anyExpanded) {
      return partiallyExpanded.join(' ');
    }
  }
  
  // Return original if no expansions found
  return searchTerm;
}
// Enhanced Unified Search Implementation with Acronym Support
function setupUnifiedSearch() {
  // Helper function to escape regex special characters
  function escapeRegExp(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }
  
  // Use a more efficient debounce for mobile
  const isMobile = window.innerWidth < 768;
  const debounceTime = isMobile ? 400 : 300;
  
  unifiedSearchInput.addEventListener('input', _.debounce(function() {
    const searchTerm = this.value.toLowerCase().trim();
    unifiedSearchSuggestions.innerHTML = '';

    if (searchTerm.length < 2) {
      unifiedSearchSuggestions.classList.add('hidden');
      return;
    }

    // ACRONYM ENHANCEMENT: Expand acronyms before processing
    const expandedTerm = expandAcronyms(searchTerm);
    const useExpanded = expandedTerm !== searchTerm;
    
    // Use both original and expanded terms for tokenization
    const searchTokens = (useExpanded ? 
      `${searchTerm} ${expandedTerm}` : searchTerm)
      .toLowerCase()
      .split(/\s+/)
      .filter(token => token.length >= 2);
    
    // Create a Map to store unique suggestions with their scores
    const suggestions = new Map();
    
    // Fewer suggestions on mobile
    const maxSuggestions = isMobile ? 8 : 15;
    
    // Enhanced scoring mechanism that considers acronym matches
    const calculateScore = (text, token, isExpanded = false) => {
      if (!text) return 0;
      
      const lowerText = String(text).toLowerCase();
      
      // Higher scores for expanded acronym matches
      const baseScore = isExpanded ? 12 : 10;
      const partialScore = isExpanded ? 10 : 8;
      const containsScore = isExpanded ? 8 : 6;
      const includesScore = isExpanded ? 6 : 4;
      
      // Exact match gets highest score
      if (lowerText === token) return baseScore;
      
      // Starts with token gets high score
      if (lowerText.startsWith(token)) return partialScore;
      
      // Contains token as a whole word gets medium score
      if (new RegExp(`\\b${token}\\b`).test(lowerText)) return containsScore;
      
      // Contains token gets lower score
      if (lowerText.includes(token)) return includesScore;
      
      // No match
      return 0;
    };

    parsedData.forEach(record => {
      if (suggestions.size >= maxSuggestions) return;

      // Fields to search with their importance weights
      const searchFields = [
        { key: 'Legal Business Name', type: 'primeName', weight: 1.0 },
        { key: 'NAICS Code', type: 'naicsCode', weight: 0.8 },
        { key: 'NAICS Description', type: 'naicsDesc', weight: 0.8 },
        { key: 'Contracting Department Name', type: 'departmentName', weight: 1.2 }, // Higher weight for departments
        { key: 'Contracting Agency Name', type: 'agencyName', weight: 1.2 }, // Higher weight for agencies
        { key: 'Contracting Office Name', type: 'officeName', weight: 0.7 },
        { key: 'Principal Place of Performance State Code', type: 'stateCode', weight: 0.6 }
      ];
      
      searchFields.forEach(field => {
        const value = record[field.key];
        if (!value) return;
        
        const textValue = String(value);
        const uniqueKey = `${field.type}-${textValue}`;
        
        // Skip if we've already processed this suggestion
        if (suggestions.has(uniqueKey)) return;
        
        // Calculate relevance score for all search tokens
        let totalScore = 0;
        let matchedAllTokens = true;
        
        // Check original search term tokens
        const originalTokens = searchTerm.toLowerCase().split(/\s+/).filter(t => t.length >= 2);
        for (const token of originalTokens) {
          const score = calculateScore(textValue, token, false);
          if (score === 0) {
            matchedAllTokens = false;
            break;
          }
          totalScore += score * field.weight;
        }
        
        // If original didn't match but we have an expansion, try expanded terms
        if (!matchedAllTokens && useExpanded) {
          const expandedTokens = expandedTerm.toLowerCase().split(/\s+/).filter(t => t.length >= 2);
          totalScore = 0;
          matchedAllTokens = true;
          
          for (const token of expandedTokens) {
            const score = calculateScore(textValue, token, true); // Mark as expanded
            if (score === 0) {
              matchedAllTokens = false;
              break;
            }
            totalScore += score * field.weight;
          }
        }
        
        // For single token searches, we only need a match
        // For multi-token searches, all tokens must match
        const isMatch = originalTokens.length === 1
          ? totalScore > 0
          : matchedAllTokens;
        
        if (isMatch) {
          suggestions.set(uniqueKey, {
            text: textValue,
            type: field.type,
            originalValue: textValue,
            score: totalScore,
            isAcronymMatch: useExpanded && matchedAllTokens
          });
        }
      });
      
      // Special handling for NAICS description words
      if (searchTokens.length > 0 && suggestions.size < maxSuggestions) {
        const naicsDesc = record['NAICS Description'] || '';
        const naicsWords = naicsDesc.split(/\s+/).filter(word => word.length > 3);
        
        naicsWords.forEach(word => {
          const uniqueKey = `naicsDesc-${word}`;
          if (suggestions.has(uniqueKey)) return;
          
          let totalScore = 0;
          let matchedAllTokens = true;
          
          for (const token of searchTokens) {
            const score = calculateScore(word, token, useExpanded);
            if (score === 0) {
              matchedAllTokens = false;
              break;
            }
            totalScore += score * 0.7;
          }
          
          const isMatch = searchTokens.length === 1
            ? totalScore > 0
            : matchedAllTokens;
          
          if (isMatch) {
            suggestions.set(uniqueKey, {
              text: word,
              type: 'naicsDesc',
              originalValue: word,
              score: totalScore,
              isAcronymMatch: useExpanded
            });
          }
        });
      }
    });

    if (suggestions.size > 0) {
      // Sort suggestions by score (highest first)
      const sortedSuggestions = Array.from(suggestions.values())
        .sort((a, b) => b.score - a.score)
        .slice(0, maxSuggestions);
      
      unifiedSearchSuggestions.classList.remove('hidden');
      
      sortedSuggestions.forEach(sugg => {
        const item = document.createElement('div');
        item.className = 'suggestion-item hover:bg-[var(--surface-level-2)]';
        
        // Add visual indicator for acronym matches
        if (sugg.isAcronymMatch) {
          item.style.borderLeft = '3px solid var(--accent)';
          item.style.paddingLeft = '8px';
        }
        
        // Add a span for the suggestion text with ellipsis
        const textSpan = document.createElement('span');
        textSpan.className = 'suggestion-text';
        
        // Highlight matching parts - use expanded term if it was used
        let highlightedText = sugg.text;
        const tokensToHighlight = useExpanded ? 
          expandedTerm.toLowerCase().split(/\s+/).filter(t => t.length >= 2) :
          searchTerm.toLowerCase().split(/\s+/).filter(t => t.length >= 2);
          
        tokensToHighlight.forEach(token => {
          if (token.length < 2) return;
          
          const regex = new RegExp('(' + escapeRegExp(token) + ')', 'gi');
          highlightedText = highlightedText.replace(regex, '<strong>$1</strong>');
        });
        
        textSpan.innerHTML = highlightedText;
        item.appendChild(textSpan);
        
        const typeLabel = document.createElement('span');
        typeLabel.className = 'type-label bg-[var(--surface-level-1)] text-[var(--text-tertiary)]';
        
        // Convert type to display name, add acronym indicator
        let displayType = sugg.type;
        if (sugg.type === 'primeName') displayType = 'Prime';
        else if (sugg.type === 'naicsCode') displayType = 'NAICS';
        else if (sugg.type === 'naicsDesc') displayType = 'Desc';
        else if (sugg.type === 'departmentName') displayType = sugg.isAcronymMatch ? 'Dept*' : 'Dept';
        else if (sugg.type === 'agencyName') displayType = sugg.isAcronymMatch ? 'Agency*' : 'Agency';
        else if (sugg.type === 'officeName') displayType = 'Office';
        else if (sugg.type === 'stateCode') displayType = 'State';
        
        typeLabel.textContent = displayType;
        item.appendChild(typeLabel);

        item.onclick = () => selectSearchSuggestion(sugg.text, sugg.type, sugg.originalValue);
        unifiedSearchSuggestions.appendChild(item);
      });
      
      // Add acronym help text if expansion occurred
      if (useExpanded) {
        const helpItem = document.createElement('div');
        helpItem.className = 'p-2 text-xs text-[var(--text-tertiary)] border-t border-[var(--border-level-1)] italic';
        helpItem.innerHTML = ` Expanded "${searchTerm}" to "${expandedTerm}"`;
        unifiedSearchSuggestions.appendChild(helpItem);
      }
      
    } else if (searchTerm.length >= 2) {
      unifiedSearchSuggestions.classList.remove('hidden');
      let message = "No specific suggestions. Press Enter to search all fields.";
      
      // Show expansion info even if no matches
      if (useExpanded) {
        message = `Searching for "${expandedTerm}" (expanded from "${searchTerm}"). Press Enter to search all fields.`;
      }
      
      unifiedSearchSuggestions.innerHTML = `
        <div class="p-2 text-sm text-[var(--text-tertiary)]">
          ${message}
        </div>`;
    }
  }, debounceTime));

  // Enhanced Enter key handling that uses acronym expansion
  unifiedSearchInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      let searchTerm = this.value.trim();
      
      // Don't search if input is empty
      if (!searchTerm) return;
      
      // Expand acronyms before searching
      const expandedTerm = expandAcronyms(searchTerm);
      if (expandedTerm !== searchTerm) {
        console.log(`Expanding "${searchTerm}" to "${expandedTerm}" for search`);
        searchTerm = expandedTerm;
        // Optionally update the input to show the expansion
        // this.value = expandedTerm;
      }
      
      // Use the existing applyFilter function
      applyFilter(searchTerm);
      
      unifiedSearchSuggestions.innerHTML = '';
      unifiedSearchSuggestions.classList.add('hidden');
    }
  });

  // Add touch-specific event handling
  if ('ontouchstart' in window) {
    document.addEventListener('touchstart', function(event) {
      if (!unifiedSearchInput.contains(event.target) && !unifiedSearchSuggestions.contains(event.target)) {
        unifiedSearchSuggestions.classList.add('hidden');
      }
    });
  } else {
    document.addEventListener('click', function(event) {
      if (!unifiedSearchInput.contains(event.target) && !unifiedSearchSuggestions.contains(event.target)) {
        unifiedSearchSuggestions.classList.add('hidden');
      }
    });
  }
  
  // Add clear button functionality
  const clearSearchBtn = document.getElementById('clearSearchBtn');
  if (clearSearchBtn) {
    clearSearchBtn.addEventListener('click', function() {
      unifiedSearchInput.value = '';
      unifiedSearchSuggestions.innerHTML = '';
      unifiedSearchSuggestions.classList.add('hidden');
      clearAllFilters();
    });
  }
}
// --- Initialize Core Visualizations ---
function initializeCoreVisuals(data, isPrimeView = false) { 
    updateStatistics(data);
    const marketShareCard = document.getElementById('marketShareChartCard');
    const primeContractorsCard = document.getElementById('primeContractorsChartCard');
    if (isPrimeView) {
        if (charts.marketShareChart) { charts.marketShareChart.destroy(); charts.marketShareChart = null; }
        if (marketShareCard && marketShareCard.querySelector('.chart-container')) marketShareCard.querySelector('.chart-container').innerHTML = `<div class="chart-no-data">Market share not applicable for single prime view.</div>`;
        if (charts.primeContractorsChart) { charts.primeContractorsChart.destroy(); charts.primeContractorsChart = null; }
        if (primeContractorsCard && primeContractorsCard.querySelector('.chart-container')) primeContractorsCard.querySelector('.chart-container').innerHTML = `<div class="chart-no-data">Top primes not applicable for single prime view.</div>`;
    } else {
        if (marketShareCard && !marketShareCard.querySelector('canvas#marketShareChart')) { 
            marketShareCard.querySelector('.chart-container').innerHTML = `<canvas id="marketShareChart"></canvas>`;
        }
        createMarketShareChart(data); 
        if (primeContractorsCard && !primeContractorsCard.querySelector('canvas#primeContractorsChart')) { 
            primeContractorsCard.querySelector('.chart-container').innerHTML = `<canvas id="primeContractorsChart"></canvas>`;
        }
        createPrimeContractorsChart(data);
    }
    createDepartmentChart(data); 
    createNaicsChart_main(data);
    createContractTypeChart_main(data);
    createStateContractsChart_main(data, currentMainStateChartFilter);
    createTopAgenciesChart(data); 
    createTimelineChart(data); 
    renderSankeyChart(data);
	createContractOpportunityForecast(data);
    createPrimeSpecializationHeatmap(data);
    createContractingOfficeRelationshipMap(data);
}
// --- Statistics Update ---
function updateStatistics(data) { 
    if (!data || data.length === 0) {
        ['totalContractsValue', 'totalValueValue', 'avgContractValue', 'uniquePrimesValue'].forEach(id => document.getElementById(id).textContent = '0');
        return;
    }
    document.getElementById('totalContractsValue').textContent = data.length.toLocaleString();
    let totalValue = 0, contractsWithValue = 0;
    data.forEach(r => { const v = parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']); if (v>0) {totalValue+=v; contractsWithValue++;}});
    document.getElementById('totalValueValue').textContent = formatCurrency(totalValue);
    document.getElementById('avgContractValue').textContent = formatCurrency(contractsWithValue > 0 ? totalValue / contractsWithValue : 0);
    document.getElementById('uniquePrimesValue').textContent = new Set(data.map(r => r['Legal Business Name']).filter(Boolean)).size.toLocaleString();
}
function getCSSVariable(name) {
  return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
}
// --- Chart Color Palette (Derived from CSS Variables) ---
let chartPrimaryColor, chartSecondaryColor, chartTertiaryColor, chartNeutralColor, chartAccentColor;
let chartGrays = [];
function getChartColors() {
    chartPrimaryColor   = '#2c1642'; 
    chartSecondaryColor = '#2c2653'; 
    chartTertiaryColor  = '#2a3663'; 
    chartNeutralColor   = '#274672'; 
    chartAccentColor    = chartPrimaryColor;

    chartGrays = [
        '#25557f',
        '#26658a',
        getComputedStyle(document.documentElement).getPropertyValue('--surface-level-2').trim()
    ];
}
// --- Optional Chart Color Overrides ---
let overrideChartHighlightColor = '#8c8a9c';   // Override for max value (e.g., desaturated blue)
let overrideChartNeutralColor = null;         // Optional override for all other bars
// --- CSS Fallback Getter ---
function getCSSVariable(name) {
    return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
}
// --- Simple Highlight Palette (max = lava or override, others = neutral or fallback)
function getHighlightColors(dataArray) {
    const highlight = overrideChartHighlightColor || '#e63946';
    const neutral = overrideChartNeutralColor || getCSSVariable('--chart-accent-2') || '#adb5bd';
    const maxVal = Math.max(...dataArray);
    return dataArray.map(value => value === maxVal ? highlight : neutral);
}
// --- Rotating Monochrome + Highlight (for pie/donut/bar sets)
function getRotatingHighlightPalette(values) {
    const maxVal = Math.max(...values);
    const baseColors = [
        chartPrimaryColor,
        chartSecondaryColor,
        chartTertiaryColor,
        chartNeutralColor,
        chartGrays[0],
        chartGrays[1],
        chartGrays[2],
        '#dee2e6', '#ced4da', '#adb5bd'
    ];
    const highlight = overrideChartHighlightColor || '#e63946';
    return values.map((v, i) => v === maxVal ? highlight : baseColors[i % baseColors.length]);
}
function createChart(canvasId, type, data, options, noDataMessage = "No data available for current selection.") {
  const canvasElement = document.getElementById(canvasId);
  if (!canvasElement) return;
  const chartContainer = canvasElement.parentElement;
  let isEmpty = true;
  if (data?.datasets?.length > 0) {
    isEmpty = data.datasets.every(ds =>
      !ds.data || ds.data.length === 0 || ds.data.every(val => val === 0 || val === null)
    );
  }
  if (isEmpty) {
    chartContainer.innerHTML = `
      <div class="chart-no-data">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
        </svg>
        <span>${noDataMessage}</span>
      </div>
    `;
    if (charts[canvasId]) {
      charts[canvasId].destroy();
      charts[canvasId] = null;
    }
    return;
  } else if (chartContainer.querySelector('.chart-no-data')) {
    chartContainer.innerHTML = `<canvas id="${canvasId}"></canvas>`;
  }
  const ctx = document.getElementById(canvasId).getContext('2d');
  if (charts[canvasId]) charts[canvasId].destroy();
  charts[canvasId] = new Chart(ctx, { type, data, options });
}
function createPrimeContractorsChart(data) {
  // Define your custom color scale
const customColorScale = [
  '#213a45', // Deep blue
  '#5e6276', // Blue-purple
  '#856c85', // Purple
  '#b38595', // Pink
  '#d99184', // Coral
  '#ccb9b3'  // Orange
];
  const canvasElement = document.getElementById('primeContractorsChart');
  if (!canvasElement) return; 
  const primeValues = {};
  data.forEach(r => {
    if (r['Legal Business Name']) {
      const val = parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
      primeValues[r['Legal Business Name']] = (primeValues[r['Legal Business Name']] || 0) + val;
    }
  });
  const sorted = Object.entries(primeValues).sort((a, b) => b[1] - a[1]).slice(0, 10);
  const labels = sorted.map(i => i[0]);
  const values = sorted.map(i => i[1]);
  const maxVal = Math.max(...values);
  // Use the custom color scale for the chart
  // Create a function that generates colors from the custom scale
  function getCustomChartColors(dataValues) {
    // Create a copy of the custom color scale that can be repeated if needed
    const extendedColorScale = [...customColorScale];
    // If there are more values than colors, repeat the colors
    while (extendedColorScale.length < dataValues.length) {
      extendedColorScale.push(...customColorScale);
    }
    // Return enough colors for all data points
    return extendedColorScale.slice(0, dataValues.length);
  }
  const chartColors = getCustomChartColors(values);
  const chartData = {
    labels,
    datasets: [{
      label: 'Contract Value',
      data: values,
      backgroundColor: chartColors
    }]
  };
  const chartOptions = {
    indexAxis: 'y',
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { display: false },
      tooltip: {
        callbacks: {
          label: c => formatCurrency(c.raw)
        }
      }
    },
    scales: {
      x: {
        ticks: {
          callback: val => formatCurrency(val)
        },
        grid: {
          display: false // Remove X axis grid lines
        }
      },
      y: {
        ticks: {
          autoSkip: false,
          callback: function (val) {
            const label = this.getLabelForValue(val);
            return label.length > 18 ? label.substring(0, 15) + '...' : label;
          }
        },
        grid: {
          display: false // Remove Y axis grid lines
        }
      }
    },
    onClick: (event, elements) => {
      if (elements.length > 0) {
        const primeName = chartData.labels[elements[0].index];
        setUnifiedSearchTerm(primeName, 'primeName');
      }
    }
  };
  createChart('primeContractorsChart', 'bar', chartData, chartOptions);
}
function createNaicsChart_main(data) {
  // Define your custom color scale
const customColorScale = [
  '#213a45', // Deep blue
  '#5e6276', // Blue-purple
  '#856c85', // Purple
  '#b38595', // Pink
  '#d99184', // Coral
  '#ccb9b3'  // Orange
];
  const naicsValues = {};
  const naicsDesc = {}; // To store full descriptions for tooltips or richer interactions if needed
  data.forEach(r => {
    if (r['NAICS Code']) {
      const naicsKey = String(r['NAICS Code']);
      naicsValues[naicsKey] = (naicsValues[naicsKey] || 0) + parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
      if (!naicsDesc[naicsKey]) {
        naicsDesc[naicsKey] = r['NAICS Description'] || 'N/A';
      }
    }
  });
  const sorted = Object.entries(naicsValues).sort((a, b) => b[1] - a[1]).slice(0, 10);
  // Store the original NAICS codes for click events
  const originalNaicsCodes = sorted.map(i => i[0]); 
  // Create display labels (NAICS Code - Short Description)
  // This part creates the labels that will be fed to the chart.
  // We will then apply a similar truncation logic as the primeContractorsChart in the ticks callback.
  const displayLabels = sorted.map(i => {
    const code = i[0];
    const description = naicsDesc[code] || '';
    // Initial short form for the data label, further truncation in ticks if needed
    return `${code} - ${description.substring(0, 30)}${description.length > 30 ? '...' : ''}`; 
  });
  const values = sorted.map(i => i[1]);
  // Create a function to generate colors from the custom scale
  function getCustomChartColors(dataValues) {
    // Create a copy of the custom color scale that can be repeated if needed
    const extendedColorScale = [...customColorScale];
    // If there are more values than colors, repeat the colors
    while (extendedColorScale.length < dataValues.length) {
      extendedColorScale.push(...customColorScale);
    }
    // Return enough colors for all data points
    return extendedColorScale.slice(0, dataValues.length);
  }
  const chartColors = getCustomChartColors(values);
  const chartData = { 
    labels: displayLabels, // Use the formatted displayLabels
    datasets: [{ 
      label: 'Contract Value', 
      data: values, 
      backgroundColor: chartColors
    }] 
  };
  const chartOptions = {
    indexAxis: 'y',
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { display: false }, // Consistent with primeContractorsChart
      tooltip: {
        callbacks: {
          label: function(context) { // Consistent tooltip formatting
            let label = context.dataset.label || '';
            if (label) {
              label += ': ';
            }
            if (context.parsed.x !== null) { // For horizontal bar chart, value is on x-axis
              label += formatCurrency(context.parsed.x);
            }
            // Optionally, add full NAICS description to tooltip
            // const originalLabel = context.label; // This is the displayLabel "CODE - DESC..."
            // const code = originalLabel.split(' - ')[0];
            // if (naicsDesc[code]) {
            //    label += `\n${naicsDesc[code]}`; // Add full description on a new line
            // }
            return label;
          }
        }
      }
    },
    scales: {
      x: { 
        ticks: { 
          callback: v => formatCurrency(v), // Consistent with primeContractorsChart
          font: {
            size: 10 // Adjust this size as needed (e.g., 10, 9)
          },
          maxRotation: 0, // Prevent label rotation
          minRotation: 0, // Prevent label rotation
          autoSkipPadding: 10 // Optional: Adjust padding if autoSkip is on
        },
        grid: {
          display: false // Remove X axis grid lines
        }
      },
      y: { 
        ticks: {
          autoSkip: false,
          font: { size: 10 },
          callback: function (val) {
            const label = this.getLabelForValue(val);
            const maxLength = 28; 
            return label.length > maxLength ? label.substring(0, maxLength - 3) + '...' : label;
          }
        },
        grid: {
          display: false // Remove Y axis grid lines
        }
      }
    },
    onClick: (event, elements) => {
      if (elements.length > 0) {
        const dataIndex = elements[0].index;
        const naicsCode = originalNaicsCodes[dataIndex]; 
        if (naicsCode) {
          setUnifiedSearchTerm(naicsCode, 'naicsCode'); 
        }
      }
    }
  };
  createChart('naicsChart_main', 'bar', chartData, chartOptions); // Ensure createChart is defined
}
function createStateContractsChart_main(data, filterType = 'count') { 
  // Define your custom color scale
const customColorScale = [
  '#213a45', // Deep blue
  '#5e6276', // Blue-purple
  '#856c85', // Purple
  '#b38595', // Pink
  '#d99184', // Coral
  '#ccb9b3'  // Orange
];
  const stateData = {}; 
  data.forEach(r => {
    const state = r['Principal Place of Performance State Code'];
    if (state) {
      if (!stateData[state]) stateData[state] = { count: 0, value: 0 };
      stateData[state].count++;
      stateData[state].value += parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
    }
  });
  const sorted = Object.entries(stateData).sort((a, b) => b[1][filterType] - a[1][filterType]).slice(0, 10);
  const labels = sorted.map(i => i[0]);
  const values = sorted.map(i => i[1][filterType]);
  const maxVal = Math.max(...values);
  // Create a function to generate colors from the custom scale
  function getCustomChartColors(dataValues) {
    // Create a copy of the custom color scale that can be repeated if needed
    const extendedColorScale = [...customColorScale];
    // If there are more values than colors, repeat the colors
    while (extendedColorScale.length < dataValues.length) {
      extendedColorScale.push(...customColorScale);
    }
    // Return enough colors for all data points
    return extendedColorScale.slice(0, dataValues.length);
  }
  const stateColors = getCustomChartColors(values);
  const chartData = {
    labels,
    datasets: [{
      label: filterType === 'count' ? 'Number of Contracts' : 'Total Contract Value',
      data: values,
      backgroundColor: stateColors
    }]
  };
  const chartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { display: false },
      tooltip: {
        callbacks: {
          label: c =>
            filterType === 'count'
              ? c.raw.toLocaleString()
              : formatCurrency(c.raw)
        }
      }
    },
    scales: {
      x: {
        grid: {
          display: false // Remove X axis grid lines
        }
      },
      y: {
        ticks: {
          callback: v =>
            filterType === 'count'
              ? v.toLocaleString()
              : formatCurrency(v)
        },
        grid: {
          display: false // Remove Y axis grid lines
        }
      }
    },
    onClick: (event, elements) => {
      if (elements.length > 0) {
        const stateCode = chartData.labels[elements[0].index];
        setUnifiedSearchTerm(stateCode, 'stateCode'); 
      }
    }
  };
  createChart('stateContractsChart_main', 'bar', chartData, chartOptions);
}
function createTimelineChart(data) {
  // Define your custom color scale
const customColorScale = [
  '#213a45', // Deep blue
  '#5e6276', // Blue-purple
  '#856c85', // Purple
  '#b38595', // Pink
  '#d99184', // Coral
  '#ccb9b3'  // Orange
];
  const startYears = {}; 
  const endYears = {};
  data.forEach(record => {
    if (record['Period of Performance Start Date']) { 
      const d = new Date(record['Period of Performance Start Date']); 
      if (!isNaN(d.getTime())) { 
        const y = d.getFullYear(); 
        if (y > 2000 && y < 2030) startYears[y] = (startYears[y] || 0) + 1; 
      }
    }
    if (record['Completion Date']) { 
      const d = new Date(record['Completion Date']); 
      if (!isNaN(d.getTime())) { 
        const y = d.getFullYear(); 
        if (y > 2000 && y < 2030) endYears[y] = (endYears[y] || 0) + 1; 
      }
    }
  });
  const allYears = new Set([...Object.keys(startYears), ...Object.keys(endYears)].map(Number));
  const sortedYears = Array.from(allYears).sort((a, b) => a - b);
  const labels = [], startCounts = [], endCounts = [];
  sortedYears.forEach(year => { 
    labels.push(year.toString()); 
    startCounts.push(startYears[year] || 0); 
    endCounts.push(endYears[year] || 0); 
  });
  // Use the custom color scale instead of the previous colors
  const startColorBorder = customColorScale[1]; // Navy purple
  const startColorFill = `${customColorScale[1]}33`; // Navy purple with 20% opacity
  const endColorBorder = customColorScale[4]; // Coral
  const endColorFill = `${customColorScale[4]}33`; // Coral with 20% opacity
  const chartData = { 
    labels, 
    datasets: [ 
      { 
        label: 'Contracts Starting', 
        data: startCounts, 
        borderColor: startColorBorder, 
        backgroundColor: startColorFill,
        fill: true, 
        tension: 0.4,
        pointRadius: 0, 
        pointHitRadius: 10, 
        pointHoverRadius: 5 
      }, 
      { 
        label: 'Contracts Ending', 
        data: endCounts, 
        borderColor: endColorBorder, 
        backgroundColor: endColorFill, 
        fill: true, 
        tension: 0.4,
        pointRadius: 0,
        pointHitRadius: 10,
        pointHoverRadius: 5
      }  
    ] 
  };
  const chartOptions = { 
    responsive: true,
    maintainAspectRatio: false,
    plugins: { 
      legend: { display: true, position: 'top' },
      tooltip: { 
        callbacks: { 
          label: ctx => `${ctx.dataset.label || ''}: ${ctx.parsed.y.toLocaleString()}` 
        } 
      }
    }, 
    scales: { 
      y: { 
        beginAtZero: true,
        ticks: { callback: val => val.toLocaleString() },
        grid: {
          display: false // Remove Y axis grid lines
        }
      },
      x: { // X-axis for the years
        ticks: {
          callback: function(value, index, ticks) {
            // 'value' is the index here, 'this.getLabelForValue(value)' gets the actual label (year string)
            const yearLabel = this.getLabelForValue(value);
            if (yearLabel && typeof yearLabel === 'string' && yearLabel.length === 4 && !isNaN(yearLabel)) {
              return "'" + yearLabel.substring(2); // Get last two digits, e.g., '22
            }
            return yearLabel; // Fallback for other labels if any
          },
          maxRotation: 0, // Prevent label rotation
          minRotation: 0  // Prevent label rotation
        },
        grid: {
          display: false // Remove X axis grid lines
        }
      }
    } 
  };
  createChart('timelineChart', 'line', chartData, chartOptions);
}
function createDepartmentChart(data) {
  // Define your custom color scale
const customColorScale = [
  '#213a45', // Deep blue
  '#5e6276', // Blue-purple
  '#856c85', // Purple
  '#b38595', // Pink
  '#d99184', // Coral
  '#ccb9b3'  // Orange
];
  const deptValues = {};
  data.forEach(r => {
    if (r['Contracting Department Name']) {
      const dept = r['Contracting Department Name'];
      deptValues[dept] = (deptValues[dept] || 0) + parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
    }
  });
  const sorted = Object.entries(deptValues).sort((a, b) => b[1] - a[1]).slice(0, 10);
  const labels = sorted.map(i => i[0]);
  const values = sorted.map(i => i[1]);
  const maxVal = Math.max(...values);
  // Create a function to generate colors from the custom scale
  function getCustomChartColors(dataValues) {
    // Create a copy of the custom color scale that can be repeated if needed
    const extendedColorScale = [...customColorScale];
    // If there are more values than colors, repeat the colors
    while (extendedColorScale.length < dataValues.length) {
      extendedColorScale.push(...customColorScale);
    }
    // Return enough colors for all data points
    return extendedColorScale.slice(0, dataValues.length);
  }
  const departmentColors = getCustomChartColors(values);
  const chartData = {
    labels,
    datasets: [{
      data: values,
      backgroundColor: departmentColors
    }]
  };
  const chartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'right',
        labels: { boxWidth: 12, font: { size: 10 } }
      },
      tooltip: {
        callbacks: {
          label: c => `${c.label || ''}: ${formatCurrency(c.raw)}`
        }
      }
    },
    onClick: (event, elements) => {
      if (elements.length > 0) {
        const departmentName = chartData.labels[elements[0].index];
        setUnifiedSearchTerm(departmentName, 'departmentName');
      }
    }
  };
  createChart('departmentChart', 'pie', chartData, chartOptions);
}
function createMarketShareChart(data) {
  // Define your custom color scale
const customColorScale = [
  '#213a45', // Deep blue
  '#5e6276', // Blue-purple
  '#856c85', // Purple
  '#b38595', // Pink
  '#d99184', // Coral
  '#ccb9b3'  // Orange
];
  const canvasElement = document.getElementById('marketShareChart');
  if (!canvasElement) return; 
  const primeValues = {}
  data.forEach(r => {
    if (r['Legal Business Name']) {
      const name = r['Legal Business Name'];
      primeValues[name] = (primeValues[name] || 0) + parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
    }
  });
  const sortedPrimes = Object.entries(primeValues).sort((a, b) => b[1] - a[1]);
  const chartLabels = [];
  const values = [];
  sortedPrimes.forEach((item, index) => {
    if (index < 5) {
      chartLabels.push(item[0]);
      values.push(item[1]);
    }
  });
  if (sortedPrimes.length > 5) {
    const otherVal = sortedPrimes.slice(5).reduce((sum, item) => sum + item[1], 0);
    if (otherVal > 0) {
      chartLabels.push('Others');
      values.push(otherVal);
    }
  }
  const maxVal = Math.max(...values);
  // Create a function to generate colors from the custom scale
  function getCustomChartColors(dataValues) {
    // Create a copy of the custom color scale that can be repeated if needed
    const extendedColorScale = [...customColorScale];
    // If there are more values than colors, repeat the colors
    while (extendedColorScale.length < dataValues.length) {
      extendedColorScale.push(...customColorScale);
    }
    // Return enough colors for all data points
    return extendedColorScale.slice(0, dataValues.length);
  }
  const chartColors = getCustomChartColors(values);
  const chartData = {
    labels: chartLabels,
    datasets: [{
      label: 'Prime Share',
      data: values,
      backgroundColor: chartColors
    }]
  };
  const chartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'right',
        labels: {
          boxWidth: 12,
          font: { size: 10 }
        }
      },
      tooltip: {
        callbacks: {
          label: ctx => {
            const raw = ctx.raw;
            const total = values.reduce((a, b) => a + b, 0);
            const percent = ((raw / total) * 100).toFixed(1);
            return `${ctx.label || ''}: ${formatCurrency(raw)} (${percent}%)`;
          }
        }
      }
    },
    // ADD THIS CLICK HANDLER
    onClick: (event, elements) => {
      if (elements.length > 0) {
        const primeName = chartData.labels[elements[0].index];
        // Don't filter if clicking the "Others" slice
        if (primeName !== 'Others') {
          setUnifiedSearchTerm(primeName, 'primeName');
        } else {
          // Optional: Could show a modal with a list of other primes
          console.log("Clicked 'Others' slice - contains:", 
            sortedPrimes.slice(5).map(item => item[0]));
        }
      }
    }
  };
  createChart('marketShareChart', 'pie', chartData, chartOptions);
}
function createContractTypeChart_main(data) { 
    const contractTypes = {};
    data.forEach(r => {
        const type = r['Award or Indefinite Delivery Vehicle Type'];
        if (type) contractTypes[type] = (contractTypes[type] || 0) + 1;
    });
    const sortedContractTypes = Object.entries(contractTypes).sort((a, b) => b[1] - a[1]);
    const labels = sortedContractTypes.map(item => item[0]);
    const values = sortedContractTypes.map(item => item[1]);
    const maxVal = Math.max(...values);
    const baseColors = [
        chartPrimaryColor,
        chartSecondaryColor,
        chartTertiaryColor,
        chartNeutralColor,
        chartGrays[0],
        chartGrays[1],
        chartGrays[2],
        '#dee2e6',
        '#ced4da',
        '#adb5bd'
    ];
    const contractTypeColors = getRotatingHighlightPalette(values);
    const chartData = { 
        labels,
        datasets: [{
            data: values,
            backgroundColor: contractTypeColors
        }]
    };
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'right',
                labels: {
                    boxWidth: 12,
                    font: { size: 10 }
                }
            },
            tooltip: {
                callbacks: {
                    label: c => `${c.label || ''}: ${c.raw.toLocaleString()}`
                }
            }
        },
        onClick: (event, elements) => {
            if (elements.length > 0) {
                const contractType = chartData.labels[elements[0].index];
                setUnifiedSearchTerm(contractType, 'contractType'); 
            }
        }
    };
    createChart('contractTypeChart_main', 'doughnut', chartData, chartOptions);
}
function createTopAgenciesChart(data) {
    const agencyValues = {}
    data.forEach(r => {
        const agency = r['Contracting Agency Name'];
        if (agency) {
            agencyValues[agency] = (agencyValues[agency] || 0) + parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
        }
    });
    const sorted = Object.entries(agencyValues).sort((a, b) => b[1] - a[1]).slice(0, 10);
    const labels = sorted.map(item => item[0]);
    const values = sorted.map(item => item[1]);
    const maxVal = Math.max(...values);
    const baseColors = [
        chartPrimaryColor,
        chartSecondaryColor,
        chartTertiaryColor,
        chartNeutralColor,
        chartGrays[0],
        chartGrays[1],
        chartGrays[2],
        '#dee2e6',
        '#ced4da',
        '#adb5bd'
    ];
    const chartColors = getRotatingHighlightPalette(values);
    const chartData = {
        labels,
        datasets: [{
            label: 'Contract Value',
            data: values,
            backgroundColor: chartColors
        }]
    };
    const chartOptions = {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: ctx => formatCurrency(ctx.raw) } }
        },
        scales: {
            x: { ticks: { callback: val => formatCurrency(val) } },
            y: {
                ticks: {
                    autoSkip: false,
                    callback: function (val) {
                        const label = this.getLabelForValue(val);
                        return label.length > 20 ? label.substring(0, 17) + '.' : label;
                    }
                }
            }
        },
        onClick: (event, elements) => {
            if (elements.length > 0) {
                const agencyName = chartData.labels[elements[0].index];
                setUnifiedSearchTerm(agencyName, 'agencyName');
            }
        }
    };
    createChart('topAgenciesChart', 'bar', chartData, chartOptions);
}
function renderSankeyChart(data) {
  // Define your custom color scale
const customColorScale = [
  '#213a45', // Deep blue
  '#5e6276', // Blue-purple
  '#856c85', // Purple
  '#b38595', // Pink
  '#d99184', // Coral
  '#ccb9b3'  // Orange
];
  console.log("Starting Sankey chart rendering with", data?.length || 0, "records");
  // Exit early if no data or container
  if (!data || !data.length) {
    console.warn("No data available for Sankey chart");
    return;
  }
  const sankeyContainer = document.getElementById('sankeyChart');
  if (!sankeyContainer) {
    console.error("Sankey chart container not found");
    return;
  }
  // Ensure d3 and d3-sankey are loaded
  if (typeof d3 === 'undefined' || !d3.sankey) {
    console.error("Required libraries not loaded: d3 or d3-sankey missing");
    // Try to load again with a delay
    setTimeout(() => renderSankeyChart(data), 2000);
    return;
  }
  // Optimize for mobile
  const isMobile = window.innerWidth < 768;
  const entityLimit = isMobile ? 8 : 12; // Fewer entities on mobile
  
  // Always make sure processing indicator is hidden after we're done
  const ensureProcessingHidden = () => {
    if (processingIndicator) {
      processingIndicator.classList.add('hidden');
      processingIndicator.classList.remove('flex');
    }
  };
  // Error display helper
  const showSankeyError = (errorMsg) => {
    console.error("Sankey chart error:", errorMsg);
    const sankeyWrapper = document.getElementById('sankeyWrapper');
    if (sankeyWrapper) {
      sankeyWrapper.innerHTML = `
        <div class="chart-no-data">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
          </svg>
          <span>${errorMsg}</span>
        </div>`;
    }
    ensureProcessingHidden();
  };
  // Handle empty data case
  if (!data || data.length === 0) {
    showSankeyError("No data available for sankey chart");
    return;
  }
  try {
    // Reference the SVG element correctly
    const svg = d3.select("#sankeyChart");
    svg.selectAll("*").remove();
    // Get actual container width - VERY IMPORTANT FOR SIZING
    const sankeyWrapper = document.getElementById('sankeyWrapper');
    const containerWidth = sankeyWrapper ? sankeyWrapper.clientWidth : 1000;
    
    // MOBILE FIX: Adjust height and margins based on device
    let height, width, legendHeight, chartTopMargin;
    
    if (isMobile) {
      // Mobile: Shorter chart, smaller legend
      height = 350;
      width = Math.max(containerWidth - 10, 300);
      legendHeight = 20; // Smaller legend
      chartTopMargin = 25; // Less space for legend
    } else {
      // Desktop: Original sizing
      height = 600;
      width = Math.max(containerWidth - 10, 800);
      legendHeight = 30;
      chartTopMargin = legendHeight + 10;
    }
    
    console.log("Sankey container width:", containerWidth, "chart width:", width, "height:", height);
    // Set SVG width and height appropriately
    svg.attr("width", width)
       .attr("height", height)
       .attr("viewBox", `0 0 ${width} ${height}`)
       .attr("preserveAspectRatio", "xMidYMid meet");
    // AGENCY to CONTRACTOR relationship
    const agencyTotals = {};
    const contractorTotals = {};
    data.forEach(row => {
      const agency = row["Contracting Agency Name"];
      const contractor = row["Legal Business Name"];
      const amount = parseCurrencyValue(row["Base and All Options Value (Total Contract Value)"]);
      if (agency && amount) {
        agencyTotals[agency] = (agencyTotals[agency] || 0) + amount;
      }
      if (contractor && amount) {
        contractorTotals[contractor] = (contractorTotals[contractor] || 0) + amount;
      }
    });
    // Get top agencies and contractors by value - LIMIT BASED ON DEVICE
    const getTopEntities = (totals, limit) => {
      return Object.entries(totals)
        .sort((a, b) => b[1] - a[1])
        .slice(0, limit)
        .map(entry => entry[0]);
    };
    const topAgencies = getTopEntities(agencyTotals, entityLimit);
    const topContractors = getTopEntities(contractorTotals, entityLimit);
    // Filter data to only include top agencies and contractors
    let processData = data.filter(row => {
      return topAgencies.includes(row["Contracting Agency Name"]) && 
             topContractors.includes(row["Legal Business Name"]);
    });
    // If we have no data after filtering, show error
    if (processData.length === 0) {
      showSankeyError("No significant data flows to display");
      return;
    }
    // Create nodes and links
    const nodeMap = new Map();
    const links = [];
    // First pass: collect nodes
    processData.forEach(row => {
      const agency = row["Contracting Agency Name"];
      const contractor = row["Legal Business Name"];
      if (agency) nodeMap.set(agency, { name: agency, type: "agency" });
      if (contractor) nodeMap.set(contractor, { name: contractor, type: "contractor" });
    });
    // Convert to array and create index
    const nodes = Array.from(nodeMap.values());
    const nodeIndex = new Map();
    nodes.forEach((node, i) => {
      node.id = i;
      nodeIndex.set(node.name, i);
    });
    // Create links between agencies and contractors
    const rawLinks = [];
    processData.forEach(row => {
      const agency = row["Contracting Agency Name"];
      const contractor = row["Legal Business Name"];
      const amount = parseCurrencyValue(row["Base and All Options Value (Total Contract Value)"]);
      if (agency && contractor && amount > 0 && 
          nodeIndex.has(agency) && nodeIndex.has(contractor)) {
        // Store raw connection info for highlighting later
        rawLinks.push({
          sourceName: agency,
          targetName: contractor,
          value: amount
        });
        // Look for existing link
        const existingLink = links.find(link => 
          link.source === nodeIndex.get(agency) && 
          link.target === nodeIndex.get(contractor)
        );
        if (existingLink) {
          existingLink.value += amount;
        } else {
          links.push({ 
            source: nodeIndex.get(agency), 
            target: nodeIndex.get(contractor), 
            value: amount 
          });
        }
      }
    });
    // Find the top value link
    const sortedLinks = [...links].sort((a, b) => b.value - a.value);
    const topLink = sortedLinks.length > 0 ? sortedLinks[0] : null;
    // Get the source and target names for the top link
    let topSourceName = null;
    let topTargetName = null;
    if (topLink) {
      // Find the node names from indices
      for (const [name, id] of nodeIndex.entries()) {
        if (id === topLink.source) topSourceName = name;
        if (id === topLink.target) topTargetName = name;
      }
    }
    // Filter small links to reduce clutter
    let minLinkValue = 0;
    if (links.length > 30) {
      minLinkValue = d3.quantile(links.map(l => l.value).sort(d3.ascending), 0.15);
    }
    const filteredLinks = links.filter(link => link.value > minLinkValue);
    // Get colors from custom color scale
    function getNodeColor(d) {
      if (d.name === topSourceName || d.name === topTargetName) {
        return customColorScale[4]; // Coral for highlighting
      }
      return d.type === "agency" ? customColorScale[1] : customColorScale[5]; // Navy purple for agencies, Orange for contractors
    }
    function getLinkColor(d) {
      if (d.source.name === topSourceName && d.target.name === topTargetName) {
        return customColorScale[4]; // Coral for highlighting top link
      }
      return customColorScale[2]; // Purple for normal links
    }
    // MOBILE FIX: Adjust sankey margins based on available space
    const sankeyMargins = isMobile 
      ? [[10, 15], [width - 10, height - chartTopMargin - 15]] // Tighter margins on mobile
      : [[10, 20], [width - 10, height - 20]]; // Original margins on desktop
    // Setup the sankey generator
    const sankey = d3.sankey()
      .nodeId(d => d.id)
      .nodeWidth(isMobile ? 15 : 20) // Thinner nodes on mobile
      .nodePadding(isMobile ? 8 : 10) // Less padding on mobile
      .extent(sankeyMargins);
    // Generate the sankey data
    const graph = sankey({
      nodes: nodes,
      links: filteredLinks.map(d => Object.assign({}, d))
    });
    // MOBILE FIX: Conditionally show legend based on screen size
    if (!isMobile) {
      // Add a legend container with improved positioning (desktop only)
      const legendContainer = svg.append("g")
        .attr("class", "sankey-legend")
        .attr("transform", `translate(20, 10)`);
      // Add background rectangle for the legend to ensure visibility
      legendContainer.append("rect")
        .attr("width", width - 40)
        .attr("height", legendHeight)
        .attr("fill", "var(--surface-level-1)")
        .attr("opacity", 0.3)
        .attr("rx", 4);
      // Add legend items
      const legendItems = [
        { label: "Agencies", color: customColorScale[1], type: "rect" },
        { label: "Contractors", color: customColorScale[5], type: "rect" },
        { label: "Top Flow", color: customColorScale[4], type: "line" }
      ];
      const legendItemWidth = Math.min(150, (width - 60) / legendItems.length);
      legendItems.forEach((item, i) => {
        const g = legendContainer.append("g")
          .attr("transform", `translate(${20 + i * legendItemWidth}, 7)`);
        if (item.type === "rect") {
          g.append("rect")
            .attr("width", 14)
            .attr("height", 14)
            .attr("fill", item.color);
        } else {
          g.append("line")
            .attr("x1", 0)
            .attr("y1", 7)
            .attr("x2", 14)
            .attr("y2", 7)
            .attr("stroke", item.color)
            .attr("stroke-width", 3);
        }
        g.append("text")
          .attr("x", 20)
          .attr("y", 10)
          .attr("font-size", "10px")
          .attr("text-anchor", "start")
          .attr("alignment-baseline", "middle")
          .attr("fill", "var(--text-primary)")
          .text(item.label);
      });
    } else {
      // Mobile: No legend, set chartTopMargin to minimal value
      chartTopMargin = 10;
    }
    // Draw the links with proper highlighting for the top value
    svg.append("g")
      .attr("fill", "none")
      .attr("stroke-opacity", 0.4)
      .attr("transform", `translate(0, ${chartTopMargin})`) // Move down to avoid legend
      .selectAll("path")
      .data(graph.links)
      .join("path")
      .attr("d", d3.sankeyLinkHorizontal())
      .attr("stroke", d => getLinkColor(d))
      .attr("stroke-width", d => Math.max(1, d.width))
      .append("title")
      .text(d => `${d.source.name}  ${d.target.name}\n$${d.value.toLocaleString()}`);
    // Draw the nodes with highlighting
    svg.append("g")
      .attr("transform", `translate(0, ${chartTopMargin})`) // Move down to avoid legend
      .selectAll("rect")
      .data(graph.nodes)
      .join("rect")
      .attr("x", d => d.x0)
      .attr("y", d => d.y0)
      .attr("height", d => Math.max(1, d.y1 - d.y0))
      .attr("width", d => d.x1 - d.x0)
      .attr("fill", d => getNodeColor(d))
      .attr("opacity", 0.8)
      .style("stroke", "white")
      .style("stroke-width", 0.5)
      .style("cursor", "pointer")
      .on("click", function(event, d) {
        // If node is an agency (left side)
        if (d.x0 < width / 2) {
          setUnifiedSearchTerm(d.name, 'agencyName');
        } 
        // If node is a contractor (right side)
        else {
          setUnifiedSearchTerm(d.name, 'primeName');
        }
      })
      .append("title")
      .text(d => `${d.name}\n$${d.value.toLocaleString()}`);
    // Add node labels - with better mobile handling
    svg.append("g")
      .attr("transform", `translate(0, ${chartTopMargin})`) // Move down to avoid legend
      .selectAll("text")
      .data(graph.nodes)
      .join("text")
      .attr("x", d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
      .attr("y", d => (d.y1 + d.y0) / 2)
      .attr("dy", "0.35em")
      .attr("text-anchor", d => d.x0 < width / 2 ? "start" : "end")
      .text(d => {
        // MOBILE FIX: Much shorter labels on mobile to prevent clipping
        const maxLength = isMobile ? 10 : 30;
        const truncateAt = isMobile ? 7 : 27;
        return d.name.length > maxLength ? 
          d.name.substring(0, truncateAt) + "..." : 
          d.name;
      })
      .attr("font-size", isMobile ? "7px" : "11px") // Smaller font on mobile
      .attr("fill", getCSSVariable('--text-primary'));
    console.log("Sankey chart render complete");
    ensureProcessingHidden();
  } catch (error) {
    showSankeyError(`Error rendering sankey chart: ${error.message}`);
    console.error(error);
  }
}
function addResizeListener() {
  // Debounce function to prevent excessive redraws
  const debounce = (func, delay) => {
    let debounceTimer;
    return function() {
      const context = this;
      const args = arguments;
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => func.apply(context, args), delay);
    };
  };
  // Handle window resize
  window.addEventListener('resize', debounce(() => {
    if (parsedData && parsedData.length > 0) {
      console.log("Window resized, redrawing visualizations");
      // IMPROVED: Get current filtered data more reliably
      let currentData = parsedData;
      // Check if there's an active filter by checking the search input
      const currentSearchTerm = unifiedSearchInput.value.trim();
      const isActiveFilter = !document.getElementById('activeFilterIndicator').classList.contains('hidden');
      if (isActiveFilter && currentSearchTerm) {
        // Use the currently filtered data - DO NOT recreate the filter
        // We'll use the data that was already filtered by the click event
        return; // Skip redrawing the Sankey on resize when a filter is active
      }
      // Only redraw essential visualizations on mobile to improve performance
      const isMobile = window.innerWidth < 768;
      // Always redraw the map
      if (contractorMap) {
        setTimeout(() => {
          contractorMap.invalidateSize();
        }, 100);
      }
    }
  }, 250)); // 250ms debounce
}
function initializePrimeProfilesSection(data) { 
    const profiles = {};
    data.forEach(r => {
        const name = r['Legal Business Name']; if (!name) return;
        if (!profiles[name]) profiles[name] = { name: name, contracts: 0, totalValue: 0, naics: new Set(), agencies: new Set(), uei: r['Unique Entity ID'] }; 
        profiles[name].contracts++; profiles[name].totalValue += parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
        if(r['NAICS Code']) profiles[name].naics.add(String(r['NAICS Code'])); 
        if(r['Contracting Agency Name']) profiles[name].agencies.add(r['Contracting Agency Name']);
    });
    // Just render the cards with all the data - no filter parameter needed
    renderCards();
    function renderCards() {
        primeProfilesContainer.innerHTML = ''; 
        let count = 0;
        // Just use the data passed to the function, which is already filtered by unified search
        Object.values(profiles)
            .sort((a,b) => b.totalValue - a.totalValue)
            .forEach(p => { 
                count++;
                const card = document.createElement('div');
                card.className = 'p-3 md:p-4 bg-[var(--surface-level-2)] rounded-lg border border-[var(--border-level-1)] shadow hover:shadow-lg transition-shadow duration-150'; 
                card.innerHTML = `
                    <h4 class="font-semibold text-[var(--accent)] truncate cursor-pointer hover:underline" title="${p.name}" onclick="setUnifiedSearchTerm('${p.name.replace(/'/g, "\\'")}', 'primeName')">${p.name}</h4>
                    <p class="text-xs md:text-sm">Contracts: ${p.contracts.toLocaleString()}</p>
                    <p class="text-xs md:text-sm">Value: ${formatCurrency(p.totalValue)}</p>
                    <p class="text-xs mt-1 truncate" title="Top NAICS: ${Array.from(p.naics).slice(0,3).join(', ')}">Top NAICS: ${Array.from(p.naics).slice(0,3).join(', ')}</p>
                    <p class="text-xs mt-1 truncate" title="Top Agencies: ${Array.from(p.agencies).slice(0,2).join(', ')}">Top Agencies: ${Array.from(p.agencies).slice(0,2).join(', ')}</p>
                    <a href="https://www.google.com/search?q=${encodeURIComponent(p.name + ' official website')}" target="_blank" rel="noopener noreferrer" 
                       class="mt-2 mr-1 text-xs bg-[var(--surface-level-3)] text-[var(--text-primary)] px-2 py-1 rounded hover:bg-[var(--surface-level-3)_hover] transition-colors duration-150 ease-in-out focus:ring-2 focus:ring-offset-2 ring-[var(--accent)] focus:outline-none inline-block"
                       style="font-weight: var(--button-font-weight); text-decoration: none;">
                       Find Website
                    </a>
                    <button class="mt-2 text-xs bg-[var(--accent)] text-[var(--on-accent)] px-2 py-1 rounded hover:bg-opacity-90 transition-colors duration-150 ease-in-out focus:ring-2 focus:ring-offset-2 ring-[var(--accent)] focus:outline-none" 
                            style="font-weight: var(--button-font-weight);" 
                            onclick="setUnifiedSearchTerm('${p.name.replace(/'/g, "\\'")}', 'primeName')">
                        Filter Dashboard by this Prime
                    </button>
                `; 
                primeProfilesContainer.appendChild(card);
        });
        if(count === 0) primeProfilesContainer.innerHTML = `<p class="p-4 col-span-full text-center text-[var(--text-secondary)]">No primes match current filters.</p>`;
    }
}
function renderPrimeDetailView(primeName, primeSpecificData) {
    if (!primeName || primeSpecificData.length === 0) {
        primeDetailViewSection.classList.add('hidden');
        return;
    }
    primeDetailTitle.textContent = `Details for: ${primeName}`;
    const primeRecord = primeSpecificData[0]; 
    const primeUEI = primeRecord ? primeRecord['Unique Entity ID'] : 'N/A';
    const parentUEI = primeRecord ? primeRecord['Ultimate Parent Unique Entity ID'] : 'N/A';
    const parentName = primeRecord ? primeRecord['Ultimate Parent Legal Business Name'] : 'N/A';
    let totalValue = 0;
    primeSpecificData.forEach(c => {
        totalValue += parseCurrencyValue(c['Base and All Options Value (Total Contract Value)']);
    });
    // Update the current view title using our dedicated function
    updateDashboardTitle(`Viewing contracts for prime: ${primeName}`);
    primeDetailStats.innerHTML = `
        <p><strong>UEI:</strong> ${createEntityLink(primeUEI, primeUEI)}</p> 
        ${parentName && parentName !== 'N/A' ? `<p><strong>Parent:</strong> ${createEntityLink(parentUEI, parentName)}</p>` : ''}
        <p><strong>Total Contracts (current view):</strong> ${primeSpecificData.length.toLocaleString()}</p>
        <p><strong>Total Value (current view):</strong> ${formatCurrency(totalValue)}</p>
        <p><strong>Avg. Contract Value (current view):</strong> ${formatCurrency(primeSpecificData.length > 0 ? totalValue / primeSpecificData.length : 0)}</p>
		<p class="mt-2">
            <a href="https://www.google.com/search?q=${encodeURIComponent(primeName + ' official website')}" target="_blank" rel="noopener noreferrer" 
               class="text-[var(--accent)] hover:underline font-medium">
               Search for ${primeName} Website
            </a>
        </p>
    `;
    currentPrimeDetailViewPage = 1; 
    renderPrimeDetailContractsTable(primeSpecificData, currentPrimeDetailViewPage); 
    primeDetailViewSection.classList.remove('hidden');
}
function renderPrimeDetailContractsTable(contracts, page) {
    const start = (page - 1) * ITEMS_PER_PAGE_MODAL_TABLE;
    const end = start + ITEMS_PER_PAGE_MODAL_TABLE;
    // Sort contracts before slicing for pagination
    const sortedContracts = sortPrimeDetailData(contracts, currentPrimeDetailSort.column, currentPrimeDetailSort.order);
    const pageContracts = sortedContracts.slice(start, end);
    let tableHTML = `<div class="table-responsive"><table class="min-w-full divide-y divide-[var(--border-level-1)] text-xs">
        <thead class="bg-[var(--surface-level-2)]"><tr>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]" data-sort-prime="id">PIID ${currentPrimeDetailSort.column === 'id' ? (currentPrimeDetailSort.order === 'asc' ? '' : '') : ''}</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]" data-sort-prime="agency">Agency ${currentPrimeDetailSort.column === 'agency' ? (currentPrimeDetailSort.order === 'asc' ? '' : '') : ''}</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]" data-sort-prime="office">Office ${currentPrimeDetailSort.column === 'office' ? (currentPrimeDetailSort.order === 'asc' ? '' : '') : ''}</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]" data-sort-prime="naicsCode">NAICS ${currentPrimeDetailSort.column === 'naicsCode' ? (currentPrimeDetailSort.order === 'asc' ? '' : '') : ''}</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]" data-sort-prime="naicsDesc">NAICS Desc. ${currentPrimeDetailSort.column === 'naicsDesc' ? (currentPrimeDetailSort.order === 'asc' ? '' : '') : ''}</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]" data-sort-prime="value">Value ${currentPrimeDetailSort.column === 'value' ? (currentPrimeDetailSort.order === 'asc' ? '' : '') : ''}</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]" data-sort-prime="endDate">End Date ${currentPrimeDetailSort.column === 'endDate' ? (currentPrimeDetailSort.order === 'asc' ? '' : '') : ''}</th>
        </tr></thead><tbody class="bg-[var(--background)] divide-y divide-[var(--border-level-1)]">`;
    pageContracts.forEach(c => {
        tableHTML += `<tr>
            <td class="px-2 py-1 whitespace-nowrap">${createAwardLink(c['Procurement Instrument Identifier'])}</td>
            <td class="px-2 py-1 whitespace-nowrap">${c['Contracting Agency Name'] || 'N/A'}</td>
            <td class="px-2 py-1 whitespace-nowrap">${c['Contracting Office Name'] || 'N/A'}</td>
            <td class="px-2 py-1">${c['NAICS Code'] || 'N/A'}</td>
            <td class="px-2 py-1 whitespace-normal max-w-xs truncate" title="${c['NAICS Description'] || ''}">${c['NAICS Description'] ? c['NAICS Description'].substring(0,50) + (c['NAICS Description'].length > 50 ? '...' : '') : 'N/A'}</td>
            <td class="px-2 py-1 whitespace-nowrap">${formatCurrency(parseCurrencyValue(c['Base and All Options Value (Total Contract Value)']))}</td>
            <td class="px-2 py-1 whitespace-nowrap">${formatDate(c['Completion Date'])}</td>
        </tr>`;
    });
    tableHTML += `</tbody></table></div>`;
    const totalPages = Math.ceil(contracts.length / ITEMS_PER_PAGE_MODAL_TABLE);
    if (totalPages > 1) {
         tableHTML += `<div class="mt-3 flex justify-between items-center text-xs">
            <button id="prevPageBtnPrimeDetailView" class="px-2 py-1 border border-[var(--border-level-2)] rounded ${page === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-[var(--surface-level-2)] transition-colors'}" ${page === 1 ? 'disabled' : ''}>Previous</button>
            <span>Page ${page} of ${totalPages}</span>
            <button id="nextPageBtnPrimeDetailView" class="px-2 py-1 border border-[var(--border-level-2)] rounded ${page === totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-[var(--surface-level-2)] transition-colors'}" ${page === totalPages ? 'disabled' : ''}>Next</button>
        </div>`;
    }
    primeDetailContractsTableContainer.innerHTML = tableHTML;
    document.querySelectorAll('#primeDetailContractsTableContainer th[data-sort-prime]').forEach(th => {
        th.onclick = () => { 
            const sortColumn = th.dataset.sortPrime;
            if (currentPrimeDetailSort.column === sortColumn) {
                currentPrimeDetailSort.order = currentPrimeDetailSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentPrimeDetailSort.column = sortColumn;
                currentPrimeDetailSort.order = 'asc';
            }
            currentPrimeDetailViewPage = 1; 
            // Re-fetch the original primeSpecificData for sorting, not just the 'contracts' (which might be a page)
            const primeSpecificDataForSort = parsedData.filter(r => r['Legal Business Name'] === specificPrimeName);
            const sortedContracts = sortPrimeDetailData(primeSpecificDataForSort, currentPrimeDetailSort.column, currentPrimeDetailSort.order);
            renderPrimeDetailContractsTable(sortedContracts, currentPrimeDetailViewPage);
        };
    });
    if (document.getElementById('prevPageBtnPrimeDetailView')) {
        document.getElementById('prevPageBtnPrimeDetailView').onclick = () => {
            if (currentPrimeDetailViewPage > 1) { 
                currentPrimeDetailViewPage--; 
                const primeSpecificDataForSort = parsedData.filter(r => r['Legal Business Name'] === specificPrimeName);
                const sortedContracts = sortPrimeDetailData(primeSpecificDataForSort, currentPrimeDetailSort.column, currentPrimeDetailSort.order);
                renderPrimeDetailContractsTable(sortedContracts, currentPrimeDetailViewPage); 
            }
        };
    }
    if (document.getElementById('nextPageBtnPrimeDetailView')) {
        document.getElementById('nextPageBtnPrimeDetailView').onclick = () => {
            const primeSpecificDataForSort = parsedData.filter(r => r['Legal Business Name'] === specificPrimeName);
            const totalPagesForButton = Math.ceil(primeSpecificDataForSort.length / ITEMS_PER_PAGE_MODAL_TABLE);
            if (currentPrimeDetailViewPage < totalPagesForButton) { 
                currentPrimeDetailViewPage++; 
                const sortedContracts = sortPrimeDetailData(primeSpecificDataForSort, currentPrimeDetailSort.column, currentPrimeDetailSort.order);
                renderPrimeDetailContractsTable(sortedContracts, currentPrimeDetailViewPage); 
            }
        };
    }
}
function sortPrimeDetailData(data, column, order) {
    return [...data].sort((a, b) => {
        let valA, valB;
        switch (column) {
            case 'id':
                valA = a['Procurement Instrument Identifier'] || '';
                valB = b['Procurement Instrument Identifier'] || '';
                break;
            case 'agency':
                valA = a['Contracting Agency Name'] || '';
                valB = b['Contracting Agency Name'] || '';
                break;
            case 'office':
                valA = a['Contracting Office Name'] || '';
                valB = b['Contracting Office Name'] || '';
                break;
            case 'naicsCode':
                valA = String(a['NAICS Code'] || '');
                valB = String(b['NAICS Code'] || '');
                break;
            case 'naicsDesc':
                valA = a['NAICS Description'] || '';
                valB = b['NAICS Description'] || '';
                break;
            case 'value':
                valA = parseCurrencyValue(a['Base and All Options Value (Total Contract Value)']);
                valB = parseCurrencyValue(b['Base and All Options Value (Total Contract Value)']);
                break;
            case 'endDate':
                valA = new Date(a['Completion Date'] || 0).getTime();
                valB = new Date(b['Completion Date'] || 0).getTime();
                break;
            default:
                return 0;
        }
        if (typeof valA === 'string') valA = valA.toLowerCase();
        if (typeof valB === 'string') valB = valB.toLowerCase();
        if (valA < valB) return order === 'asc' ? -1 : 1;
        if (valA > valB) return order === 'asc' ? 1 : -1;
        return 0;
    });
}
function setUnifiedSearchTerm(term, type = 'primeName') { 
    unifiedSearchInput.value = term;
    applyFilter(term, type, term); 
}
// --- File Input Handling ---
csvFileInput.addEventListener('change', function(e) { 
    const file = e.target.files[0]; 
    if (!file) { 
        fileNameDisplay.textContent = 'No file'; 
        return; 
    }
    fileNameDisplay.textContent = file.name; 
    showProcessingBriefly();
    Papa.parse(file, {
        header: true, 
        dynamicTyping: true, 
        skipEmptyLines: true,
        complete: results => {
            if (results.errors && results.errors.length > 0) { 
                showErrorMessage('CSV Error: ' + results.errors[0].message); 
                return; 
            }
            if (results.data && results.data.length > 0) {
                showSuccessMessage('File processed!', false); 
                processAndInitialize(results.data);
                // Explicitly hide the manual upload section
                if (manualUploadSection) {
                    manualUploadSection.classList.add('hidden');
                    manualUploadSection.style.display = 'none';
                }
                s3LoadErrorDiv.classList.add('hidden'); 
            } else {
                showErrorMessage('No data in file.');
            }
        },
        error: error => showErrorMessage('CSV Parse Fail: ' + error.message)
    });
});
// --- Theme Toggle & Share View Logic ---
function applyInitialTheme() {
    document.documentElement.classList.remove('dark');
    localStorage.removeItem('theme'); 
    if (themeIconSun && themeIconMoon) { 
        themeIconSun.classList.remove('hidden');
        themeIconMoon.classList.add('hidden');
    }
    
    // CRITICAL FIX: Only update chart defaults if data is loaded AND no active search
    // During initial load, we don't want to trigger any filter logic
    if (parsedData && parsedData.length > 0 && !currentFilterState.isActive) {
        updateChartDefaults();
    } else {
        // Just update the chart color defaults without touching the data
        const styles = getComputedStyle(document.documentElement);
        const textColor = styles.getPropertyValue('--text-secondary').trim(); 
        const gridColor = styles.getPropertyValue('--border-level-2').trim(); 
        Chart.defaults.color = textColor;
        Chart.defaults.borderColor = gridColor;
        getChartColors(); // Update your custom chart colors too
    }
}
if (themeToggleBtn) {
    themeToggleBtn.addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
        if (document.documentElement.classList.contains('dark')) {
            localStorage.setItem('theme', 'dark');
            if(themeIconSun) themeIconSun.classList.add('hidden');
            if(themeIconMoon) themeIconMoon.classList.remove('hidden');
        } else {
            localStorage.setItem('theme', 'light');
            if(themeIconSun) themeIconSun.classList.remove('hidden');
            if(themeIconMoon) themeIconMoon.classList.add('hidden');
        }
        getChartColors(); 
        updateChartDefaults();
    });
}

function updateChartDefaults() {
    const isDarkMode = document.documentElement.classList.contains('dark');
    const styles = getComputedStyle(document.documentElement);
    const textColor = styles.getPropertyValue('--text-secondary').trim(); 
    const gridColor = styles.getPropertyValue('--border-level-2').trim(); 
    
    // Update Chart.js global defaults
    Chart.defaults.color = textColor;
    Chart.defaults.borderColor = gridColor;
    
    // Update existing charts' colors without changing data
    Object.keys(charts).forEach(chartKey => {
        if (charts[chartKey] && charts[chartKey].update) {
            try {
                // Update chart colors
                if (charts[chartKey].options.scales) {
                    if (charts[chartKey].options.scales.x) {
                        charts[chartKey].options.scales.x.ticks = charts[chartKey].options.scales.x.ticks || {};
                        charts[chartKey].options.scales.x.ticks.color = textColor;
                        charts[chartKey].options.scales.x.grid = charts[chartKey].options.scales.x.grid || {};
                        charts[chartKey].options.scales.x.grid.color = gridColor;
                    }
                    if (charts[chartKey].options.scales.y) {
                        charts[chartKey].options.scales.y.ticks = charts[chartKey].options.scales.y.ticks || {};
                        charts[chartKey].options.scales.y.ticks.color = textColor;
                        charts[chartKey].options.scales.y.grid = charts[chartKey].options.scales.y.grid || {};
                        charts[chartKey].options.scales.y.grid.color = gridColor;
                    }
                }
                
                // Update legend colors
                if (charts[chartKey].options.plugins && charts[chartKey].options.plugins.legend) {
                    charts[chartKey].options.plugins.legend.labels = charts[chartKey].options.plugins.legend.labels || {};
                    charts[chartKey].options.plugins.legend.labels.color = textColor;
                }
                
                // Update the chart with new colors (no animation to be fast)
                charts[chartKey].update('none');
            } catch (error) {
                console.warn(`Error updating chart ${chartKey}:`, error);
            }
        }
    });
    
    // Update D3 visualizations colors
    updateD3VisualizationColors();
}

// Add this helper function to update D3 visualization colors:
function updateD3VisualizationColors() {
    // Update Sankey chart text colors
    d3.selectAll('#sankeyChart text')
        .style('fill', getCSSVariable('--text-primary'));
    
    // Update relationship map text colors
    d3.selectAll('#contractingOfficeRelationshipMap text')
        .style('fill', getCSSVariable('--text-primary'));
    
    // Update heatmap text colors
    d3.selectAll('#primeSpecializationHeatmap text')
        .style('fill', getCSSVariable('--text-primary'));
    
    // Update any legend colors
    d3.selectAll('.legend text')
        .style('fill', getCSSVariable('--text-primary'));
}
shareViewBtn.addEventListener('click', () => {
    const url = new URL(window.location.href);
    
    // Clear existing search parameters
    url.searchParams.delete('search'); 
    url.searchParams.delete('filterType'); 
    url.searchParams.delete('filterValue'); 
    
    // Get current search state
    const currentSearchTermInBar = unifiedSearchInput.value.trim();
    
    // Check if we're viewing a specific prime
    if (isViewingSpecificPrime && specificPrimeName) { 
        url.searchParams.set('filterType', 'primeName');
        url.searchParams.set('filterValue', specificPrimeName);
    } else if (currentSearchTermInBar) { 
        // For general searches, use the search parameter
        url.searchParams.set('search', currentSearchTermInBar);
    }
    
    // Copy to clipboard with error handling
    if (navigator.clipboard && navigator.clipboard.writeText) {
        // Modern clipboard API
        navigator.clipboard.writeText(url.toString()).then(() => {
            showShareToast('Link copied to clipboard!');
        }).catch(err => {
            console.error('Failed to copy URL: ', err);
            fallbackCopyToClipboard(url.toString());
        });
    } else {
        // Fallback for older browsers
        fallbackCopyToClipboard(url.toString());
    }
});

// ADD these helper functions:
function showShareToast(message) {
    const shareToast = document.getElementById('shareToast');
    if (shareToast) {
        shareToast.textContent = message;
        shareToast.classList.remove('hidden');
        setTimeout(() => {
            shareToast.classList.add('hidden');
        }, 2000);
    } else {
        // Fallback alert if toast element is missing
        alert(message);
    }
}

function fallbackCopyToClipboard(text) {
    // Create a temporary textarea element
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showShareToast('Link copied to clipboard!');
        } else {
            showShareToast('Please copy the URL from your browser bar');
        }
    } catch (err) {
        console.error('Fallback copy failed: ', err);
        showShareToast('Please copy the URL from your browser bar');
    }
    
    document.body.removeChild(textArea);
}

function applyFiltersFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const searchParam = urlParams.get('search');
    const filterTypeParam = urlParams.get('filterType');
    const filterValueParam = urlParams.get('filterValue');
    
    if (filterTypeParam && filterValueParam) {
        // Decode URL-encoded values
        const decodedValue = decodeURIComponent(filterValueParam.replace(/\+/g, ' '));
        unifiedSearchInput.value = decodedValue; 
        applyFilter(decodedValue, filterTypeParam, decodedValue);
    } else if (searchParam) {
        // Decode URL-encoded search term
        const decodedSearch = decodeURIComponent(searchParam.replace(/\+/g, ' '));
        unifiedSearchInput.value = decodedSearch;
        applyFilter(decodedSearch); 
    }
    
    // Add highlighting to prime profile section when search is active
    if (unifiedSearchInput.value && unifiedSearchInput.value.trim() !== '') {
        document.getElementById('primeProfilesSection').classList.add('highlight-section');
    } else {
        document.getElementById('primeProfilesSection').classList.remove('highlight-section');
    }
}
document.getElementById('resetMapBtn').addEventListener('click', () => {
  if (contractorMap) {
    // Reset the view to default zoom level (using 3 for more zoomed out)
    contractorMap.setView([39.8283, -98.5795], 3);
    console.log("Map view reset");
  }
});
document.getElementById('resetSankeyBtn').addEventListener('click', () => {
  // Clear any active filters
  unifiedSearchInput.value = '';
  clearAllFilters();
  // Re-render sankey with full dataset
  renderSankeyChart(parsedData);
});
// Clear search button
document.getElementById('clearSearchBtn').addEventListener('click', () => {
    unifiedSearchInput.value = '';
    clearAllFilters();
});
// Global reset button
document.getElementById('globalResetBtn').addEventListener('click', () => {
    // Clear search input
    unifiedSearchInput.value = '';
    // Clear all filters and reset views
    clearAllFilters();
    // Reset map view
    if (contractorMap) {
        contractorMap.setView([39.8283, -98.5795], 3);
    }
});
// Variables for the opportunity details table pagination
let currentOpportunityData = [];
let currentOpportunityPage = 1;
const itemsPerOpportunityPage = 10;
let currentOpportunitySortConfig = { field: 'value', order: 'desc' };
// === Enhanced Contract Opportunity Forecast ===
function createContractOpportunityForecast(data) {
  console.log("Creating opportunity forecast chart with", data.length, "records");
  // Define your custom color scale
const customColorScale = [
  '#213a45', // Deep blue
  '#5e6276', // Blue-purple
  '#856c85', // Purple
  '#b38595', // Pink
  '#d99184', // Coral
  '#ccb9b3'  // Orange
];
  // First, ensure we have a valid canvas element to work with
  let chartContainer = document.querySelector('.chart-container:has(#contractOpportunityForecastChart)');
  // If we can't find the canvas, try to find its container another way
  if (!chartContainer) {
    // Look for container with the "No data available" message
    const noDataContainers = Array.from(document.querySelectorAll('.chart-container'))
      .filter(container => container.querySelector('.chart-no-data'));
    // Find the specific container for our chart - look for the heading text
    chartContainer = Array.from(document.querySelectorAll('.dashboard-card'))
      .find(card => 
        card.textContent.includes('Upcoming Contract Expirations') && 
        card.querySelector('.chart-container')
      )?.querySelector('.chart-container');
    if (!chartContainer) {
      console.error("Cannot find opportunity forecast chart container");
      return;
    }
    // Clear container and recreate the canvas
    console.log("Recreating opportunity forecast canvas element");
    chartContainer.innerHTML = '<canvas id="contractOpportunityForecastChart"></canvas>';
  }
  // Make sure the chart is destroyed if it exists
  if (charts.contractOpportunityForecastChart) {
    try {
      charts.contractOpportunityForecastChart.destroy();
    } catch (e) {
      console.warn("Error destroying previous chart:", e);
    }
    charts.contractOpportunityForecastChart = null;
  }
  // Group contracts by month for the next 24 months
  const today = new Date();
  const nextTwoYears = {};
  const agencies = {};
  // Initialize next 24 months
  for (let i = 0; i < 24; i++) {
    const futureDate = new Date(today);
    futureDate.setMonth(today.getMonth() + i);
    const yearMonth = `${futureDate.getFullYear()}-${(futureDate.getMonth() + 1).toString().padStart(2, '0')}`;
    nextTwoYears[yearMonth] = { 
      total: 0, 
      agencies: {},
      contracts: []
    };
  }
  // Process contracts ending in next 24 months
  data.forEach(contract => {
    if (!contract['Completion Date']) return;
    const endDate = new Date(contract['Completion Date']);
    if (isNaN(endDate.getTime())) return;
    // Skip if contract already ended
    if (endDate < today) return;
    // Skip if contract ends more than 24 months in the future
    const monthsDiff = (endDate.getFullYear() - today.getFullYear()) * 12 + (endDate.getMonth() - today.getMonth());
    if (monthsDiff > 24) return;
    const yearMonth = `${endDate.getFullYear()}-${(endDate.getMonth() + 1).toString().padStart(2, '0')}`;
    if (!nextTwoYears[yearMonth]) return;
    const agency = contract['Contracting Agency Name'] || 'Unknown';
    const value = parseCurrencyValue(contract['Base and All Options Value (Total Contract Value)']);
    nextTwoYears[yearMonth].total += value;
    if (!nextTwoYears[yearMonth].agencies[agency]) {
      nextTwoYears[yearMonth].agencies[agency] = 0;
    }
    nextTwoYears[yearMonth].agencies[agency] += value;
    // Track all agencies for the legend
    if (!agencies[agency]) agencies[agency] = 0;
    agencies[agency] += value;
    // Store contract details for this month
    nextTwoYears[yearMonth].contracts.push({
      prime: contract['Legal Business Name'],
      agency: contract['Contracting Agency Name'],
      office: contract['Contracting Office Name'],
      piid: contract['Procurement Instrument Identifier'],
      naics: contract['NAICS Code'],
      naicsDesc: contract['NAICS Description'],
      value: value,
      endDate: endDate
    });
  });
  // Check if we have any contracts for charting
  const hasContractsExpiring = Object.values(nextTwoYears).some(month => month.total > 0);
  if (!hasContractsExpiring) {
    console.log("No expiring contracts to display");
    // Show no data message but keep a reference to recreate later
    chartContainer.innerHTML = `
      <div class="chart-no-data">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
        </svg>
        <span>No data available for current selection.</span>
      </div>
    `;
    return;
  }
  // Double check for canvas element again after potential recreations
  const chartElement = document.getElementById('contractOpportunityForecastChart');
  if (!chartElement) {
    console.error("Canvas element still not found after recreation attempts");
    // Try one more time with direct creation
    chartContainer.innerHTML = '<canvas id="contractOpportunityForecastChart"></canvas>';
    // Check if we succeeded
    if (!document.getElementById('contractOpportunityForecastChart')) {
      console.error("Failed to create canvas element - cannot continue");
      return;
    }
  }
  // Convert to Chart.js format
  const labels = Object.keys(nextTwoYears).sort();
  // Get top agencies by value
  const isSmallScreen = window.innerWidth <= 1024;
  const topAgencyLimit = isSmallScreen ? 3 : 5; // ADJUSTED: Fewer agencies on small screens
  const topAgencies = Object.entries(agencies)
    .sort((a, b) => b[1] - a[1])
    .slice(0, topAgencyLimit)
    .map(entry => entry[0]);
  // Create datasets for chart using custom color scale
  const datasets = topAgencies.map((agency, index) => {
    const agencyData = labels.map(month => {
      return nextTwoYears[month].agencies[agency] || 0;
    });
    // Use the custom color scale with index modulo to cycle through colors
    const colorIndex = index % customColorScale.length;
    const color = customColorScale[colorIndex];
    return {
      label: agency,
      data: agencyData,
      backgroundColor: color,
      borderColor: color,
      borderWidth: 1,
      borderRadius: 4,
    };
  });
  // Add "Other" category if needed
  const otherData = labels.map(month => {
    const monthTotal = nextTwoYears[month].total;
    const topAgenciesTotal = topAgencies.reduce((sum, agency) => {
      return sum + (nextTwoYears[month].agencies[agency] || 0);
    }, 0);
    return monthTotal - topAgenciesTotal;
  });
  // Only add Others if there's actually data
  if (otherData.some(value => value > 0)) {
    datasets.push({
      label: 'Other Agencies',
      data: otherData,
      backgroundColor: customColorScale[3], // Pink color for "Other"
      borderColor: customColorScale[3],
      borderWidth: 1,
      borderRadius: 4,
    });
  }
  // Format x-axis labels as "MMM YY"
  const formattedLabels = labels.map(ym => {
    const [year, month] = ym.split('-');
    try {
      const dateObj = new Date(parseInt(year), parseInt(month) - 1, 1);
      // ADJUSTED: Shorter date format
      return dateObj.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
    } catch (e) {
      console.warn("Error formatting date label:", e);
      return ym; // Fallback to raw format
    }
  });
  const chartData = {
    labels: formattedLabels,
    datasets: datasets
  };
  // ADJUSTED: Modified chart options for side-by-side layout and removed grid lines
  const chartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      tooltip: {
        callbacks: {
          label: function(context) {
            return `${context.dataset.label}: ${formatCurrency(context.raw)}`;
          },
          footer: function(tooltipItems) {
            const dataIndex = tooltipItems[0].dataIndex;
            const total = tooltipItems.reduce((sum, item) => sum + item.raw, 0);
            return `Total Value: ${formatCurrency(total)}`;
          }
        }
      },
      title: {
        display: false, // ADJUSTED: Removed title to save space
      },
      legend: {
        position: 'bottom', // ADJUSTED: Moved legend to bottom
        labels: {
          boxWidth: 10, // ADJUSTED: Smaller box size
          font: {
            size: 9 // ADJUSTED: Smaller font
          }
        }
      }
    },
    scales: {
      x: {
        stacked: true,
        ticks: {
          maxRotation: 45,
          minRotation: 45,
          font: {
            size: 8 // ADJUSTED: Smaller font
          }
        },
        grid: {
          display: false // Remove X axis grid lines
        }
      },
      y: {
        stacked: true,
        ticks: {
          callback: function(value) {
            return formatCurrency(value);
          },
          font: {
            size: 9 // ADJUSTED: Smaller font
          }
        },
        grid: {
          display: false // Remove Y axis grid lines
        }
      }
    },
    onClick: function(event, elements) {
      if (elements.length > 0) {
        const index = elements[0].index;
        const month = labels[index];
        // Update opportunity details table with the clicked month's data
        updateOpportunityDetailsTable(month, nextTwoYears[month]);
      }
    }
  };
  try {
    // Use our enhanced chart creation function
    createChart('contractOpportunityForecastChart', 'bar', chartData, chartOptions);
    console.log("Opportunity forecast chart created successfully");
  } catch (error) {
    console.error("Error creating opportunity forecast chart:", error);
    // Display error message in the container
    chartContainer.innerHTML = `
      <div class="chart-no-data">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
        </svg>
        <span>Error creating chart. Please try refreshing the page.</span>
      </div>
    `;
  }
}
// Enhanced opportunity table controls initialization
function initializeOpportunityTableControls() {
  console.log("Initializing opportunity table controls");
  // Event listener for sorting select
  const sortSelect = document.getElementById('opportunitySortSelect');
  if (sortSelect) {
    sortSelect.addEventListener('change', function() {
      try {
        const [field, order] = this.value.split('-');
        currentOpportunitySortConfig = { field, order };
        currentOpportunityPage = 1; // Reset to first page
        renderOpportunityTable();
      } catch (error) {
        console.error("Error handling sort change:", error);
      }
    });
  } else {
    console.warn("Sort select element not found");
  }
  // Event listeners for pagination
  const prevBtn = document.getElementById('prevOpportunityPageBtn');
  const nextBtn = document.getElementById('nextOpportunityPageBtn');
  if (prevBtn) {
    prevBtn.addEventListener('click', function() {
      if (currentOpportunityPage > 1) {
        currentOpportunityPage--;
        renderOpportunityTable();
      }
    });
  } else {
    console.warn("Previous page button not found");
  }
  if (nextBtn) {
    nextBtn.addEventListener('click', function() {
      const totalPages = Math.ceil(currentOpportunityData.length / itemsPerOpportunityPage);
      if (currentOpportunityPage < totalPages) {
        currentOpportunityPage++;
        renderOpportunityTable();
      }
    });
  } else {
    console.warn("Next page button not found");
  }
  // Add global refresh handler - this makes sure tables can be re-initialized
  // even if the DOM is regenerated after filtering
  document.addEventListener('refreshOpportunityControls', function() {
    console.log("Refreshing opportunity controls due to DOM changes");
    initializeOpportunityTableControls();
  });
}
// Function to render the opportunity table
function renderOpportunityTable() {
  const tableBody = document.getElementById('contractExpirationTableBody');
  if (!tableBody || !currentOpportunityData.length) return;
  // Sort the data
  const sortedData = sortOpportunityData(currentOpportunityData, currentOpportunitySortConfig);
  // Paginate
  const totalPages = Math.ceil(sortedData.length / itemsPerOpportunityPage);
  const start = (currentOpportunityPage - 1) * itemsPerOpportunityPage;
  const end = start + itemsPerOpportunityPage;
  const pageData = sortedData.slice(start, end);
  // Update pagination display
  const currentPageEl = document.getElementById('currentOpportunityPage');
  const totalPagesEl = document.getElementById('totalOpportunityPages');
  const prevBtn = document.getElementById('prevOpportunityPageBtn');
  const nextBtn = document.getElementById('nextOpportunityPageBtn');
  if (currentPageEl) currentPageEl.textContent = currentOpportunityPage;
  if (totalPagesEl) totalPagesEl.textContent = totalPages;
  if (prevBtn) prevBtn.disabled = currentOpportunityPage <= 1;
  if (nextBtn) nextBtn.disabled = currentOpportunityPage >= totalPages;
  // Hide pagination if only one page
  const paginationEl = document.getElementById('opportunityPagination');
  if (paginationEl) {
    paginationEl.style.display = totalPages <= 1 ? 'none' : 'flex';
  }
  // Generate table rows
  let html = '';
  pageData.forEach(contract => {
    html += `
      <tr>
        <td class="px-2 py-1 whitespace-nowrap">${contract.prime || 'N/A'}</td>
        <td class="px-2 py-1 whitespace-nowrap">${contract.agency || 'N/A'}</td>
        <td class="px-2 py-1 whitespace-nowrap">${contract.office || 'N/A'}</td>
        <td class="px-2 py-1 whitespace-nowrap">${createAwardLink(contract.piid)}</td>
        <td class="px-2 py-1 whitespace-nowrap">${contract.naics || 'N/A'}</td>
        <td class="px-2 py-1 whitespace-normal max-w-xs truncate" title="${contract.naicsDesc || ''}">${contract.naicsDesc ? contract.naicsDesc.substring(0,30) + (contract.naicsDesc.length > 30 ? '...' : '') : 'N/A'}</td>
        <td class="px-2 py-1 whitespace-nowrap">${formatCurrency(contract.value)}</td>
        <td class="px-2 py-1 whitespace-nowrap">${formatDate(contract.endDate)}</td>
      </tr>
    `;
  });
  // If no data, show a message
  if (pageData.length === 0) {
    html = `<tr><td colspan="8" class="px-2 py-4 text-center">No contracts found for this month</td></tr>`;
  }
  tableBody.innerHTML = html;
  // Initialize table controls (sorting and pagination)
  if (!window.opportunityControlsInitialized) {
    initializeOpportunityTableControls();
    window.opportunityControlsInitialized = true;
  }
}
// === Updated Contract Opportunity Details Function ===
function updateOpportunityDetailsTable(yearMonth, data) {
  // ADDED: Hide the other detail section first
  document.getElementById('specializationDetailsSection').classList.add('hidden');
  // Show the table section
  const detailsSection = document.getElementById('contractExpirationDetails');
  if (detailsSection) {
    detailsSection.classList.remove('hidden');
  }
  // Update title
  const [year, month] = yearMonth.split('-');
  const monthName = new Date(parseInt(year), parseInt(month) - 1, 1).toLocaleDateString('en-US', { month: 'long' });
  const selectedMonthEl = document.getElementById('selectedMonth');
  if (selectedMonthEl) {
    selectedMonthEl.textContent = `${monthName} ${year}`;
  }
  // Update total opportunities info
  const totalOpportunitiesEl = document.getElementById('totalOpportunities');
  const totalOpportunitiesValueEl = document.getElementById('totalOpportunitiesValue');
  if (totalOpportunitiesEl) {
    totalOpportunitiesEl.textContent = data.contracts.length.toLocaleString();
  }
  if (totalOpportunitiesValueEl) {
    totalOpportunitiesValueEl.textContent = formatCurrency(data.total);
  }
  // Store current data for pagination and sorting
  currentOpportunityData = [...data.contracts];
  currentOpportunityPage = 1; // Reset to first page
  // Check if data exists but it's empty
  if (currentOpportunityData.length === 0) {
    console.log("No contract data for this month:", yearMonth);
  }
  // Render the table with the current sort configuration
  renderOpportunityTable();
  // ADDED: Scroll to the details section
  setTimeout(() => {
    detailsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 100);
}
// Function to ensure table controls are initialized
function initializeOpportunityTableControls() {
  console.log("Initializing opportunity table controls");
  // Event listener for sorting select
  const sortSelect = document.getElementById('opportunitySortSelect');
  if (sortSelect) {
    sortSelect.addEventListener('change', function() {
      const [field, order] = this.value.split('-');
      currentOpportunitySortConfig = { field, order };
      currentOpportunityPage = 1; // Reset to first page
      renderOpportunityTable();
    });
  } else {
    console.warn("Sort select element not found");
  }
  // Event listeners for pagination
  const prevBtn = document.getElementById('prevOpportunityPageBtn');
  const nextBtn = document.getElementById('nextOpportunityPageBtn');
  if (prevBtn) {
    prevBtn.addEventListener('click', function() {
      if (currentOpportunityPage > 1) {
        currentOpportunityPage--;
        renderOpportunityTable();
      }
    });
  } else {
    console.warn("Previous page button not found");
  }
  if (nextBtn) {
    nextBtn.addEventListener('click', function() {
      const totalPages = Math.ceil(currentOpportunityData.length / itemsPerOpportunityPage);
      if (currentOpportunityPage < totalPages) {
        currentOpportunityPage++;
        renderOpportunityTable();
      }
    });
  } else {
    console.warn("Next page button not found");
  }
}
// === Contract Opportunity Details Function ===
function updateOpportunityDetailsTable(yearMonth, data) {
  // ADDED: Hide the other detail section first
  document.getElementById('specializationDetailsSection').classList.add('hidden');
  // Show the table section
  const detailsSection = document.getElementById('contractExpirationDetails');
  if (detailsSection) {
    detailsSection.classList.remove('hidden');
  }
  // Update title
  const [year, month] = yearMonth.split('-');
  const monthName = new Date(parseInt(year), parseInt(month) - 1, 1).toLocaleDateString('en-US', { month: 'long' });
  const selectedMonthEl = document.getElementById('selectedMonth');
  if (selectedMonthEl) {
    selectedMonthEl.textContent = `${monthName} ${year}`;
  }
  // Update total opportunities info
  const totalOpportunitiesEl = document.getElementById('totalOpportunities');
  const totalOpportunitiesValueEl = document.getElementById('totalOpportunitiesValue');
  if (totalOpportunitiesEl) {
    totalOpportunitiesEl.textContent = data.contracts.length.toLocaleString();
  }
  if (totalOpportunitiesValueEl) {
    totalOpportunitiesValueEl.textContent = formatCurrency(data.total);
  }
  // Store current data for pagination and sorting
  currentOpportunityData = [...data.contracts];
  currentOpportunityPage = 1; // Reset to first page
  // Render the table with the current sort configuration
  renderOpportunityTable();
  // ADDED: Scroll to the details section
  setTimeout(() => {
    detailsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 100);
}
// === Additional Helper Functions ===
// Function to close all detail sections
function closeAllDetailSections() {
  // Hide both detail sections
  document.getElementById('specializationDetailsSection').classList.add('hidden');
  document.getElementById('contractExpirationDetails').classList.add('hidden');
}
// Add close buttons to detail sections
function addCloseButtonsToDetailSections() {
  // For specialization details
  const specDetailsHeader = document.querySelector('#specializationDetailsSection .flex.justify-between');
  if (specDetailsHeader && !specDetailsHeader.querySelector('.detail-close-btn')) {
    const closeButton = document.createElement('button');
    closeButton.innerHTML = '&times;';
    closeButton.className = 'detail-close-btn px-2 py-1 bg-[var(--surface-level-2)] text-[var(--text-secondary)] rounded hover:bg-[var(--surface-level-3)] ml-2';
    closeButton.addEventListener('click', function() {
      document.getElementById('specializationDetailsSection').classList.add('hidden');
    });
    specDetailsHeader.appendChild(closeButton);
  }
  // For contract expiration details
  const expDetailsHeader = document.querySelector('#expirationDetailsTitle');
  if (expDetailsHeader && expDetailsHeader.parentNode && !expDetailsHeader.parentNode.querySelector('.detail-close-btn')) {
    const closeButton = document.createElement('button');
    closeButton.innerHTML = '&times;';
    closeButton.className = 'detail-close-btn px-2 py-1 bg-[var(--surface-level-2)] text-[var(--text-secondary)] rounded hover:bg-[var(--surface-level-3)] absolute top-4 right-4';
    closeButton.addEventListener('click', function() {
      document.getElementById('contractExpirationDetails').classList.add('hidden');
    });
    expDetailsHeader.parentNode.style.position = 'relative';
    expDetailsHeader.parentNode.appendChild(closeButton);
  }
}
// Resize handler for responsive layout
const handleVisualResizeDebounced = _.debounce(function() {
  // Only adjust layout if visualizations exist
  if (document.getElementById('primeSpecializationHeatmap') && 
      document.getElementById('contractOpportunityForecastChart')) {
    // Check if we're on a small screen
    const isSmallScreen = window.innerWidth <= 1024;
    // DON'T modify the heatmap SVG viewBox - let it naturally resize
    // Only adjust other elements if needed
    // For Chart.js, we rely on its built-in responsiveness
    // Adjust layout of detail sections if needed
    const detailSections = document.querySelectorAll('#specializationDetailsSection, #contractExpirationDetails');
    detailSections.forEach(section => {
      // Add any responsive adjustments needed for detail sections
    });
    // Only re-render other visualizations if absolutely necessary
    if (isSmallScreen) {
      // On small screens, we might want to simplify the visualizations
      // or make other adjustments
    }
  }
}, 250);
// Register the resize handler
window.addEventListener('resize', handleVisualResizeDebounced);
function initializeResponsiveHeatmap() {
  // We don't need to modify viewBox on resize - just ensure text sizing is appropriate
  const heatmapResizeHandler = _.debounce(function() {
    if (parsedData && parsedData.length > 0) {
      console.log("Window resized - adjusting heatmap text only if needed");
      const heatmapSvg = d3.select('#primeSpecializationHeatmap');
      if (!heatmapSvg.empty()) {
        const isSmallScreen = window.innerWidth <= 1024;
        // Only adjust text sizes or axis labels if needed
        heatmapSvg.selectAll("text")
          .style("font-size", isSmallScreen ? "6px" : "7px");
        // DO NOT change viewBox or preserveAspectRatio
        // DO NOT redraw the entire heatmap
      }
    }
  }, 250);
  // Register the heatmap resize handler
  window.addEventListener('resize', heatmapResizeHandler);
}

function sortOpportunityData(data, sortConfig) {
  return [...data].sort((a, b) => {
    let valA, valB;
    switch (sortConfig.field) {
      case 'value':
        valA = a.value;
        valB = b.value;
        break;
      case 'date':
        valA = new Date(a.endDate).getTime();
        valB = new Date(b.endDate).getTime();
        break;
      case 'prime':
        valA = a.prime || '';
        valB = b.prime || '';
        break;
      default:
        return 0;
    }
    if (typeof valA === 'string' && typeof valB === 'string') {
      valA = valA.toLowerCase();
      valB = valB.toLowerCase();
    }
    if (sortConfig.order === 'asc') {
      return valA < valB ? -1 : valA > valB ? 1 : 0;
    } else {
      return valA > valB ? -1 : valA < valB ? 1 : 0;
    }
  });
}
// Variables for specialization details table pagination
let currentSpecializationData = {
  prime: null,
  naics: null,
  naicsDescription: null,
  specializationIndex: 0,
  totalValue: 0,
  contracts: []
};
let currentSpecPage = 1;
const itemsPerSpecPage = 10;
// Updated heatmap function to maximize space usage
function createPrimeSpecializationHeatmap(data) {
  // Define your custom color scale
const customColorScale = [
  '#213a45', // Deep blue
  '#5e6276', // Blue-purple
  '#856c85', // Purple
  '#b38595', // Pink
  '#d99184', // Coral
  '#ccb9b3'  // Orange
];
  const primeValues = {};
  data.forEach(r => {
    if (r['Legal Business Name']) {
      const val = parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
      primeValues[r['Legal Business Name']] = (primeValues[r['Legal Business Name']] || 0) + val;
    }
  });
  const topPrimes = Object.entries(primeValues)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10)
    .map(entry => entry[0]);
  // Get top 10 NAICS codes by total value
  const naicsValues = {};
  data.forEach(r => {
    if (r['NAICS Code']) {
      const naicsKey = String(r['NAICS Code']);
      naicsValues[naicsKey] = (naicsValues[naicsKey] || 0) + parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
    }
  });
  const topNaics = Object.entries(naicsValues)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10)
    .map(entry => entry[0]);
  // Create a mapping of NAICS codes to descriptions
  const naicsDescriptions = {};
  data.forEach(r => {
    if (r['NAICS Code'] && r['NAICS Description']) {
      naicsDescriptions[String(r['NAICS Code'])] = r['NAICS Description'];
    }
  });
  // Calculate total spending
  const totalSpending = Object.values(primeValues).reduce((sum, val) => sum + val, 0);
  // Calculate NAICS percentage of total spending
  const naicsPercentages = {};
  topNaics.forEach(naics => {
    naicsPercentages[naics] = naicsValues[naics] / totalSpending;
  });
  // Calculate prime spending by NAICS
  const primeNaicsSpending = {};
  topPrimes.forEach(prime => {
    primeNaicsSpending[prime] = {};
    topNaics.forEach(naics => {
      primeNaicsSpending[prime][naics] = 0;
    });
  });
  data.forEach(r => {
    const prime = r['Legal Business Name'];
    const naics = String(r['NAICS Code']);
    if (topPrimes.includes(prime) && topNaics.includes(naics)) {
      const value = parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
      primeNaicsSpending[prime][naics] += value;
    }
  });
  // Calculate specialization index
  const specializationIndex = {};
  const heatmapData = [];
  topPrimes.forEach(prime => {
    specializationIndex[prime] = {};
    const primeTotal = primeValues[prime];
    topNaics.forEach(naics => {
      const primeNaicsPercentage = primeNaicsSpending[prime][naics] / primeTotal;
      const index = primeNaicsPercentage / naicsPercentages[naics];
      specializationIndex[prime][naics] = index;
      heatmapData.push({
        prime: prime,
        naics: naics,
        description: naicsDescriptions[naics],
        value: primeNaicsSpending[prime][naics],
        index: index
      });
    });
  });
  // MAXIMIZED SPACE: Minimal margins to maximize heatmap area
  const margin = { top: 5, right: 2, bottom: 40, left: 90 };
  // Get the container dimensions
  const heatmapElement = document.getElementById('primeSpecializationHeatmap');
  if (!heatmapElement) return;
  // Get the parent container to determine available space
  const containerWidth = heatmapElement.parentElement.clientWidth || 900;
  const containerHeight = heatmapElement.parentElement.clientHeight || 450;
  // Use more of the available space
  const width = containerWidth - margin.left - margin.right - 5; // Even smaller buffer
  const height = containerHeight - margin.top - margin.bottom - 5;
  // Clear previous content
  d3.select(heatmapElement).selectAll("*").remove();
  // Set SVG attributes ONCE (don't repeat this)
  const svgElement = d3.select(heatmapElement)
    .attr("width", "100%") 
    .attr("height", "100%")
    .attr("viewBox", `0 0 ${containerWidth} ${containerHeight}`)
    .attr("preserveAspectRatio", "none");
  // Then create a group element inside the SVG for the chart content
  const svg = svgElement.append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);
  // Create scales
  const x = d3.scaleBand()
    .range([0, width])
    .domain(topNaics)
    .padding(0.02); // Reduced padding between cells
  const y = d3.scaleBand()
    .range([0, height])
    .domain(topPrimes)
    .padding(0.02); // Reduced padding between cells
  // Find actual data range for color scale
  const specialIndices = heatmapData.map(d => d.index);
  const minIndex = Math.min(...specialIndices) || 0;
  const maxIndex = Math.max(...specialIndices) || 3;
  // Create a better domain range
  const colorDomain = [
    minIndex,
    minIndex + (maxIndex - minIndex) * 0.25,
    minIndex + (maxIndex - minIndex) * 0.5,
    minIndex + (maxIndex - minIndex) * 0.75,
    maxIndex
  ];
  // Use custom color scale instead of theme colors
  const heatmapPalette = [
    customColorScale[0],  // Deep blue for lowest values
    customColorScale[1],  // Navy purple
    customColorScale[2],  // Purple
    customColorScale[3],  // Pink
    customColorScale[4]   // Coral for highest values
  ];
  // Create a color scale
  const color = d3.scaleLinear()
    .domain(colorDomain)
    .range(heatmapPalette);
  // Add X axis labels - more compact
  svg.append("g")
    .attr("class", "x-axis")
    .style("font-size", "8px")
    .style("color", "var(--text-primary)")
    .attr("transform", `translate(0,${height})`)
    .call(d3.axisBottom(x).tickSize(0))
    .selectAll("text")
    .style("text-anchor", "middle")
    .style("fill", "var(--text-primary)")
    .attr("transform", "translate(0,5)");
  // Add Y axis labels with classes for easier selection
  svg.append("g")
    .attr("class", "y-axis")
    .style("font-size", "8px")
    .style("color", "var(--text-primary)")
    .call(d3.axisLeft(y).tickSize(0).tickFormat(d => {
      const maxLength = 10;
      return d.length > maxLength ? 
        d.substring(0, maxLength) + '...' : 
        d;
    }))
    .selectAll("text")
    .style("fill", "var(--text-primary)")
    .attr("dx", "-3")
    .select(function() { return this.parentNode.parentNode; })
    .select(".domain")
    .remove();
  // Create tooltip
  d3.selectAll(".heatmap-tooltip").remove();
  const tooltip = d3.select("body")
    .append("div")
    .attr("class", "tooltip heatmap-tooltip")
    .style("opacity", 0)
    .style("background-color", "var(--surface-level-1)")
    .style("border", "1px solid var(--border-level-2)")
    .style("border-radius", "5px")
    .style("padding", "8px")
    .style("color", "var(--text-primary)")
    .style("position", "absolute")
    .style("z-index", 1000)
    .style("font-size", "11px")
    .style("pointer-events", "none")
    .style("display", "none");
  // Create heatmap cells with larger size
  svg.selectAll()
    .data(heatmapData)
    .enter()
    .append("rect")
    .attr("x", d => x(d.naics))
    .attr("y", d => y(d.prime))
    .attr("width", x.bandwidth())
    .attr("height", y.bandwidth())
    .style("fill", d => color(d.index))
    .style("stroke", "var(--border-level-2)")
    .style("stroke-width", 0.5) // Thinner borders
    .style("opacity", 0.9)
    .style("cursor", "pointer")
    .on("mouseover", function(event, d) {
      d3.select(this)
        .style("stroke", customColorScale[5]) // Orange for highlighting
        .style("stroke-width", 1.5)
        .style("opacity", 1);
      tooltip.transition()
        .duration(200)
        .style("opacity", .9)
        .style("display", "block");
      // Show full name in tooltip since we truncated on y-axis
      tooltip.html(`
        <strong>${d.prime}</strong><br/>
        <span>${d.naics} - ${d.description}</span><br/>
        <span>Specialization Index: ${d.index.toFixed(2)}</span><br/>
        <span>Contract Value: ${formatCurrency(d.value)}</span>
      `)
        .style("left", (event.pageX + 10) + "px")
        .style("top", (event.pageY - 28) + "px");
    })
    .on("mouseout", function() {
      d3.select(this)
        .style("stroke", "var(--border-level-2)")
        .style("stroke-width", 0.5)
        .style("opacity", 0.9);
      tooltip.transition()
        .duration(500)
        .style("opacity", 0)
        .on("end", () => tooltip.style("display", "none"));
    })
    .on("click", function(event, d) {
      showSpecializationDetails(d.prime, d.naics, d.description, d.index, d.value);
    });
  // Compact legend at the bottom
  const legendWidth = 200;
  const legendHeight = 10;
  const legend = svg.append("g")
    .attr("transform", `translate(${width/2 - legendWidth/2}, ${height + 35})`);
  const legendX = d3.scaleLinear()
    .domain([minIndex, maxIndex])
    .range([0, legendWidth]);
  const legendXAxis = d3.axisBottom(legendX)
    .tickSize(3)
    .ticks(3)
    .tickFormat(d => d.toFixed(1))
    .tickPadding(3);
  const defs = legend.append("defs");
  const linearGradient = defs.append("linearGradient")
    .attr("id", "linear-gradient");
  linearGradient.selectAll("stop")
    .data([
      {offset: "0%", color: heatmapPalette[0]},
      {offset: "25%", color: heatmapPalette[1]},
      {offset: "50%", color: heatmapPalette[2]},
      {offset: "75%", color: heatmapPalette[3]},
      {offset: "100%", color: heatmapPalette[4]}
    ])
    .enter().append("stop")
    .attr("offset", d => d.offset)
    .attr("stop-color", d => d.color);
  legend.append("rect")
    .attr("width", legendWidth)
    .attr("height", legendHeight)
    .style("fill", "url(#linear-gradient)");
  legend.append("g")
    .attr("transform", `translate(0,${legendHeight})`)
    .style("font-size", "7px")
    .call(legendXAxis);
  // Minimal legend labels
  legend.append("text")
    .attr("x", 0)
    .attr("y", legendHeight + 20)
    .attr("text-anchor", "start")
    .style("font-size", "7px")
    .style("fill", "var(--text-primary)")
    .text("Less");
  legend.append("text")
    .attr("x", legendWidth)
    .attr("y", legendHeight + 20)
    .attr("text-anchor", "end")
    .style("font-size", "7px")
    .style("fill", "var(--text-primary)")
    .text("More");
  // Add NAICS descriptions as tooltips for column headers
  svg.selectAll(".naics-tooltip")
    .data(topNaics)
    .enter()
    .append("title")
    .attr("class", "naics-tooltip")
    .text(d => `${d} - ${naicsDescriptions[d]}`);
  // Add a minimal instruction at the bottom
  svg.append("text")
    .attr("x", width / 2)
    .attr("y", height + 60)
    .attr("text-anchor", "middle")
    .style("font-size", "7px")
    .style("font-style", "italic")
    .style("fill", "var(--text-primary)")
    .text("Click any cell for details");
  // Initialize the filter button event handler
  initializeSpecializationControls();
}
function initializeSpecializationControls() {
  // Add click handler for the filter button
  const filterBtn = document.getElementById('filterBySelectionBtn');
  if (filterBtn) {
    filterBtn.addEventListener('click', function() {
      if (currentSpecializationData.prime && currentSpecializationData.naics) {
        // Apply filters for both prime and NAICS
        const primeName = currentSpecializationData.prime;
        const naicsCode = currentSpecializationData.naics;
        // We'll use a custom combined filter to achieve filtering by both Prime and NAICS
        customFilterByPrimeAndNaics(primeName, naicsCode);
      }
    });
  }
  // Add handlers for pagination
  const prevBtn = document.getElementById('prevSpecPageBtn');
  const nextBtn = document.getElementById('nextSpecPageBtn');
  if (prevBtn) {
    prevBtn.addEventListener('click', function() {
      if (currentSpecPage > 1) {
        currentSpecPage--;
        renderSpecializationTable();
      }
    });
  }
  if (nextBtn) {
    nextBtn.addEventListener('click', function() {
      const totalPages = Math.ceil(currentSpecializationData.contracts.length / itemsPerSpecPage);
      if (currentSpecPage < totalPages) {
        currentSpecPage++;
        renderSpecializationTable();
      }
    });
  }
}
function customFilterByPrimeAndNaics(primeName, naicsCode) {
  // Update the search input with the prime name
  if (unifiedSearchInput) {
    unifiedSearchInput.value = primeName;
  }
  // Filter the data for both prime and NAICS
  const filteredData = parsedData.filter(record => {
    return record['Legal Business Name'] === primeName && 
           String(record['NAICS Code']) === naicsCode;
  });
  // Update the UI with filtered data
  if (filteredData.length > 0) {
    // Create a descriptive filter name
    const displaySearchTerm = `Prime: ${primeName}, NAICS: ${naicsCode}`;
    // Update dashboard title
    updateDashboardTitle(`Filtered by ${displaySearchTerm} (${filteredData.length.toLocaleString()} results)`);
    // Update all visualizations with filtered data
    initializeCoreVisuals(filteredData, true); // true because we're viewing a specific prime
    initializePrimeProfilesSection(filteredData);
    if (typeof initializeContractExpirationCalendarSection === 'function') {
      initializeContractExpirationCalendarSection(filteredData);
    }
    initializeContractorMap(filteredData);
    renderSankeyChart(filteredData);
    // Update the active filter indicator
    updateActiveFilterIndicator(displaySearchTerm, filteredData.length);
    // Hide search suggestions
    if (unifiedSearchSuggestions) {
      unifiedSearchSuggestions.innerHTML = '';
      unifiedSearchSuggestions.classList.add('hidden');
    }
  }
}
function showSpecializationDetails(prime, naics, naicsDescription, specializationIndex, totalValue) {
  // Get all contracts for this prime and NAICS
  const contracts = [];
  parsedData.forEach(r => {
    if (r['Legal Business Name'] === prime && String(r['NAICS Code']) === naics) {
      contracts.push({
        piid: r['Procurement Instrument Identifier'],
        agency: r['Contracting Agency Name'],
        office: r['Contracting Office Name'],
        value: parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']),
        startDate: formatDate(r['Period of Performance Start Date']),
        endDate: formatDate(r['Completion Date'])
      });
    }
  });
  // Sort by value (highest first)
  contracts.sort((a, b) => b.value - a.value);
  // Store the current data for pagination
  currentSpecializationData = {
    prime: prime,
    naics: naics,
    naicsDescription: naicsDescription,
    specializationIndex: specializationIndex,
    totalValue: totalValue,
    contracts: contracts
  };
  // Reset to first page
  currentSpecPage = 1;
  // Hide the other detail section first
  document.getElementById('contractExpirationDetails').classList.add('hidden');
  // Show the details section
  const detailsSection = document.getElementById('specializationDetailsSection');
  if (detailsSection) {
    detailsSection.classList.remove('hidden');
  }
  // Update the details
  const primeName = document.getElementById('specDetailsPrime');
  const naicsInfo = document.getElementById('specDetailsNaics');
  const indexValue = document.getElementById('specDetailsIndex');
  const indexNote = document.getElementById('specDetailsIndexNote');
  const totalValueEl = document.getElementById('specDetailsTotalValue');
  const contractCount = document.getElementById('specDetailsContractCount');
  if (primeName) primeName.textContent = prime;
  if (naicsInfo) naicsInfo.textContent = `${naics} - ${naicsDescription}`;
  if (indexValue) {
    indexValue.textContent = specializationIndex.toFixed(2);
    indexValue.className = specializationIndex > 1 ? 
      'text-md font-bold text-[var(--accent)]' : 
      'text-md font-bold';
  }
  if (indexNote) {
    indexNote.textContent = specializationIndex > 1 ? 
      'Above average specialization' : 
      'Below average specialization';
  }
  if (totalValueEl) totalValueEl.textContent = formatCurrency(totalValue);
  if (contractCount) contractCount.textContent = contracts.length;
  // Render the table
  renderSpecializationTable();
  // Scroll to the details section
  setTimeout(() => {
    detailsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 100);
}
function renderSpecializationTable() {
  const tableBody = document.getElementById('specializationContractsTable');
  if (!tableBody) return;
  // Get current page of contracts
  const start = (currentSpecPage - 1) * itemsPerSpecPage;
  const end = start + itemsPerSpecPage;
  const pageContracts = currentSpecializationData.contracts.slice(start, end);
  // Update pagination controls
  const totalPages = Math.ceil(currentSpecializationData.contracts.length / itemsPerSpecPage);
  const currentPageEl = document.getElementById('currentSpecPage');
  const totalPagesEl = document.getElementById('totalSpecPages');
  const prevBtn = document.getElementById('prevSpecPageBtn');
  const nextBtn = document.getElementById('nextSpecPageBtn');
  if (currentPageEl) currentPageEl.textContent = currentSpecPage;
  if (totalPagesEl) totalPagesEl.textContent = totalPages;
  if (prevBtn) prevBtn.disabled = currentSpecPage <= 1;
  if (nextBtn) nextBtn.disabled = currentSpecPage >= totalPages;
  // Hide pagination if only one page
  const paginationEl = document.getElementById('specDetailsPagination');
  if (paginationEl) {
    paginationEl.style.display = totalPages <= 1 ? 'none' : 'flex';
  }
  // Generate table HTML
  let html = '';
  pageContracts.forEach(contract => {
    html += `
      <tr>
        <td class="px-2 py-1 whitespace-nowrap">${createAwardLink(contract.piid)}</td>
        <td class="px-2 py-1 whitespace-nowrap">${contract.agency || 'N/A'}</td>
        <td class="px-2 py-1 whitespace-nowrap">${contract.office || 'N/A'}</td>
        <td class="px-2 py-1 whitespace-nowrap">${formatCurrency(contract.value)}</td>
        <td class="px-2 py-1 whitespace-nowrap">${contract.startDate || 'N/A'}</td>
        <td class="px-2 py-1 whitespace-nowrap">${contract.endDate || 'N/A'}</td>
      </tr>
    `;
  });
  tableBody.innerHTML = html || '<tr><td colspan="6" class="px-2 py-4 text-center">No contracts found</td></tr>';
}
// Global variable to track simulation state
let relationshipMapSimulation = null;
let isSimulationPaused = false;
let originalNodePositions = new Map(); // Store original positions for reset

function createContractingOfficeRelationshipMap(data) {
  // Clean up any existing tooltips from previous renders
  d3.selectAll(".d3-relationship-tooltip").remove();
  console.log("Starting relationship map render with", data.length, "records");
  
  // ROBUST DATA VALIDATION - More lenient thresholds
  if (!data || data.length === 0) {
    console.warn("No data provided to relationship map");
    showRelationshipMapError("No data available for relationship visualization");
    return;
  }

  // Check if we have minimum required data
  const hasContractors = data.some(row => row["Legal Business Name"]);
  const hasAgencies = data.some(row => row["Contracting Agency Name"] || row["Contracting Department Name"]);
  
  if (!hasContractors || !hasAgencies) {
    console.warn("Insufficient relationship data - missing contractors or agencies");
    showRelationshipMapError("Insufficient data for relationship visualization");
    return;
  }
  
  // Define your custom color scale
  const customColorScale = [
    '#213a45', // Deep blue
    '#5e6276', // Blue-purple
    '#856c85', // Purple
    '#b38595', // Pink
    '#d99184', // Coral
    '#ccb9b3'  // Orange
  ];
  
  try {
    // ADAPTIVE LIMITS - Adjust based on data size
    const dataSize = data.length;
    let topDeptLimit, topAgencyLimit, topOfficeLimit, topContractorLimit;
    
    if (dataSize < 50) {
      // Small dataset - very permissive limits
      topDeptLimit = 3;
      topAgencyLimit = 5;
      topOfficeLimit = 8;
      topContractorLimit = 8;
    } else if (dataSize < 200) {
      // Medium dataset
      topDeptLimit = 4;
      topAgencyLimit = 7;
      topOfficeLimit = 10;
      topContractorLimit = 10;
    } else {
      // Large dataset - original limits
      topDeptLimit = 5;
      topAgencyLimit = 10;
      topOfficeLimit = 15;
      topContractorLimit = 15;
    }
    
    // HIERARCHICAL APPROACH: Capture the full government contracting hierarchy
    const departments = {};
    const agencies = {};
    const offices = {};
    const contractors = {};
    
    // Hierarchy mapping
    const agencyToDept = {};
    const officeToAgency = {};
    
    // Process each contract record
    data.forEach(row => {
      // Extract entities from each row
      const dept = row["Contracting Department Name"];
      const agency = row["Contracting Agency Name"];
      const office = row["Contracting Office Name"];
      const contractor = row["Legal Business Name"];
      
      // Skip if essential data is missing
      if (!contractor) return;
      
      // Process contractor
      if (!contractors[contractor]) {
        contractors[contractor] = {
          id: contractor,
          type: "contractor",
          value: 0,
          connections: 0
        };
      }
      const value = parseCurrencyValue(row["Base and All Options Value (Total Contract Value)"]);
      contractors[contractor].value += value;
      
      // Process department if present
      if (dept) {
        if (!departments[dept]) {
          departments[dept] = {
            id: dept,
            type: "department",
            value: 0,
            connections: 0
          };
        }
        departments[dept].value += value;
      }
      
      // Process agency if present and establish dept relationship
      if (agency) {
        if (!agencies[agency]) {
          agencies[agency] = {
            id: agency,
            type: "agency",
            value: 0,
            connections: 0
          };
        }
        agencies[agency].value += value;
        // Link agency to department
        if (dept) {
          agencyToDept[agency] = dept;
        }
      }
      
      // Process office if present and establish agency relationship
      if (office) {
        if (!offices[office]) {
          offices[office] = {
            id: office,
            type: "office",
            value: 0,
            connections: 0
          };
        }
        offices[office].value += value;
        // Link office to agency
        if (agency) {
          officeToAgency[office] = agency;
        }
      }
    });
    
    // FLEXIBLE ENTITY SELECTION - Take what we can get
    const availableDepts = Object.values(departments).sort((a, b) => b.value - a.value);
    const availableAgencies = Object.values(agencies).sort((a, b) => b.value - a.value);
    const availableOffices = Object.values(offices).sort((a, b) => b.value - a.value);
    const availableContractors = Object.values(contractors).sort((a, b) => b.value - a.value);
    
    // Take as many as we can, up to the limits
    const topDepts = availableDepts.slice(0, Math.min(topDeptLimit, availableDepts.length));
    const topAgencies = availableAgencies.slice(0, Math.min(topAgencyLimit, availableAgencies.length));
    const topOffices = availableOffices.slice(0, Math.min(topOfficeLimit, availableOffices.length));
    const topContractors = availableContractors.slice(0, Math.min(topContractorLimit, availableContractors.length));
    
    console.log(`Relationship map entities: ${topDepts.length} depts, ${topAgencies.length} agencies, ${topOffices.length} offices, ${topContractors.length} contractors`);
    
    // Step 3: Build hierarchical links with more flexible approach
    const links = [];
    const topDeptIds = topDepts.map(d => d.id);
    const topAgencyIds = topAgencies.map(a => a.id);
    const topOfficeIds = topOffices.map(o => o.id);
    const topContractorIds = topContractors.map(c => c.id);
    
    // Department to Agency links
    topAgencyIds.forEach(agencyId => {
      const deptId = agencyToDept[agencyId];
      if (deptId && topDeptIds.includes(deptId)) {
        links.push({
          source: deptId,
          target: agencyId,
          value: agencies[agencyId].value,
          type: "dept-agency"
        });
      }
    });
    
    // Agency to Office links
    topOfficeIds.forEach(officeId => {
      const agencyId = officeToAgency[officeId];
      if (agencyId && topAgencyIds.includes(agencyId)) {
        links.push({
          source: agencyId,
          target: officeId,
          value: offices[officeId].value,
          type: "agency-office"
        });
      }
    });
    
    // ENHANCED: Direct agency to contractor links if no offices
    if (topOfficeIds.length === 0 && topAgencyIds.length > 0) {
      console.log("No offices found, creating direct agency-contractor links");
      data.forEach(row => {
        const contractor = row["Legal Business Name"];
        const agency = row["Contracting Agency Name"];
        if (!contractor || !topContractorIds.includes(contractor)) return;
        if (!agency || !topAgencyIds.includes(agency)) return;
        
        const value = parseCurrencyValue(row["Base and All Options Value (Total Contract Value)"]);
        
        // Check if link already exists
        let existingLink = links.find(l => l.source === agency && l.target === contractor);
        if (existingLink) {
          existingLink.value += value;
        } else {
          links.push({
            source: agency,
            target: contractor,
            value: value,
            type: "agency-contractor"
          });
        }
      });
    } else {
      // Office to Contractor links (original approach)
      data.forEach(row => {
        const contractor = row["Legal Business Name"];
        const office = row["Contracting Office Name"];
        if (!contractor || !topContractorIds.includes(contractor)) return;
        if (!office || !topOfficeIds.includes(office)) return;
        
        const value = parseCurrencyValue(row["Base and All Options Value (Total Contract Value)"]);
        
        // Check if link already exists
        let existingLink = links.find(l => l.source === office && l.target === contractor);
        if (existingLink) {
          existingLink.value += value;
        } else {
          links.push({
            source: office,
            target: contractor,
            value: value,
            type: "office-contractor"
          });
        }
      });
    }
    
    // FALLBACK: If still no links, create department-contractor links
    if (links.length === 0 && topDeptIds.length > 0) {
      console.log("No office or agency links found, creating direct department-contractor links");
      data.forEach(row => {
        const contractor = row["Legal Business Name"];
        const dept = row["Contracting Department Name"];
        if (!contractor || !topContractorIds.includes(contractor)) return;
        if (!dept || !topDeptIds.includes(dept)) return;
        
        const value = parseCurrencyValue(row["Base and All Options Value (Total Contract Value)"]);
        
        // Check if link already exists
        let existingLink = links.find(l => l.source === dept && l.target === contractor);
        if (existingLink) {
          existingLink.value += value;
        } else {
          links.push({
            source: dept,
            target: contractor,
            value: value,
            type: "dept-contractor"
          });
        }
      });
    }
    
    // Step 4: Create the combined nodes list
    const allNodes = [...topDepts, ...topAgencies, ...topOffices, ...topContractors];
    
    console.log(`Final relationship map: ${allNodes.length} nodes, ${links.length} links`);
    
    // FINAL CHECK - More lenient requirements
    if (allNodes.length < 2 || links.length === 0) {
      console.warn(`Insufficient entities for visualization: ${allNodes.length} nodes, ${links.length} links`);
      showRelationshipMapError("Not enough related entities found for meaningful visualization");
      return;
    }
    
    // Clear any existing error state and render the visualization
    renderRelationshipVisualization(allNodes, links, customColorScale);
    
  } catch (error) {
    console.error("Error in relationship map:", error);
    showRelationshipMapError(`Error rendering relationship map: ${error.message}`);
  }
}

// Helper function to show error messages
function showRelationshipMapError(errorMsg) {
  const relationshipMapSvg = document.getElementById('contractingOfficeRelationshipMap');
  if (relationshipMapSvg) {
    // Clear previous content
    d3.select(relationshipMapSvg).selectAll("*").remove();
    
    // Add styled error message
    const svg = d3.select(relationshipMapSvg);
    const container = relationshipMapSvg.parentElement;
    const containerWidth = container ? container.clientWidth : 900;
    const containerHeight = 400;
    
    svg.attr("width", containerWidth)
       .attr("height", containerHeight)
       .attr("viewBox", `0 0 ${containerWidth} ${containerHeight}`)
       .attr("preserveAspectRatio", "xMidYMid meet");
    
    // Background
    svg.append("rect")
      .attr("width", "100%")
      .attr("height", "100%")
      .attr("fill", "var(--surface-level-1)")
      .attr("opacity", 0.1);
    
    // Icon
    svg.append("text")
      .attr("x", "50%")
      .attr("y", "40%")
      .attr("text-anchor", "middle")
      .attr("dominant-baseline", "middle")
      .style("font-size", "48px")
      .style("fill", "var(--text-tertiary)")
      .style("opacity", 0.5)
      .text("");
    
    // Error message
    svg.append("text")
      .attr("x", "50%")
      .attr("y", "55%")
      .attr("text-anchor", "middle")
      .attr("dominant-baseline", "middle")
      .style("font-size", "14px")
      .style("fill", "var(--text-secondary)")
      .text(errorMsg);
    
    // Helpful tip
    svg.append("text")
      .attr("x", "50%")
      .attr("y", "65%")
      .attr("text-anchor", "middle")
      .attr("dominant-baseline", "middle")
      .style("font-size", "11px")
      .style("fill", "var(--text-tertiary)")
      .style("font-style", "italic")
      .text("Try searching for a larger agency or removing filters");
  }
}

// Separate function to render the actual visualization (keeping the original logic)
function renderRelationshipVisualization(allNodes, links, customColorScale) {
  // Reference the SVG element correctly
  const svg = d3.select("#contractingOfficeRelationshipMap");
  svg.selectAll("*").remove();
  
  // Get actual container width - VERY IMPORTANT FOR SIZING
  const container = document.getElementById('contractingOfficeRelationshipMap').parentElement;
  const containerWidth = container ? container.clientWidth : 900;
  const isDesktop = window.innerWidth >= 1024;
  const containerHeight = isDesktop ? 700 : 600;
  
  // Update SVG attributes
  svg.attr("width", containerWidth)
     .attr("height", containerHeight)
     .attr("viewBox", `0 0 ${containerWidth} ${containerHeight}`)
     .attr("preserveAspectRatio", "xMidYMid meet");
  
  // ADD CONTROL PANEL at the top
  const controlPanel = svg.append("g")
    .attr("class", "control-panel")
    .attr("transform", "translate(10, 10)");
  
  // Background for control panel
  const controlBg = controlPanel.append("rect")
    .attr("width", 200)
    .attr("height", 60)
    .attr("fill", "var(--surface-level-1)")
    .attr("stroke", "var(--border-level-2)")
    .attr("stroke-width", 1)
    .attr("rx", 5)
    .attr("opacity", 0.95);
  
  // Pause/Resume button
  const pauseBtn = controlPanel.append("g")
    .attr("class", "pause-btn")
    .attr("transform", "translate(10, 15)")
    .style("cursor", "pointer");
  
  pauseBtn.append("rect")
    .attr("width", 80)
    .attr("height", 25)
    .attr("fill", "var(--accent)")
    .attr("rx", 3);
  
  const pauseBtnText = pauseBtn.append("text")
    .attr("x", 40)
    .attr("y", 16)
    .attr("text-anchor", "middle")
    .attr("fill", "var(--on-accent)")
    .style("font-size", "10px")
    .style("font-weight", "500")
    .text("Pause Physics");
  
  // Reset button
  const resetBtn = controlPanel.append("g")
    .attr("class", "reset-btn")
    .attr("transform", "translate(100, 15)")
    .style("cursor", "pointer");
  
  resetBtn.append("rect")
    .attr("width", 80)
    .attr("height", 25)
    .attr("fill", "var(--surface-level-2)")
    .attr("stroke", "var(--border-level-2)")
    .attr("stroke-width", 1)
    .attr("rx", 3);
  
  resetBtn.append("text")
    .attr("x", 40)
    .attr("y", 16)
    .attr("text-anchor", "middle")
    .attr("fill", "var(--text-primary)")
    .style("font-size", "10px")
    .style("font-weight", "500")
    .text("Reset Layout");
  
  // Instructions
  controlPanel.append("text")
    .attr("x", 10)
    .attr("y", 52)
    .attr("fill", "var(--text-secondary)")
    .style("font-size", "9px")
    .text("Pause physics to arrange nodes manually");
  
  // Create the main container group (adjusted for control panel)
  const g = svg.append("g")
    .attr("class", "network-container")
    .attr("transform", `translate(${containerWidth / 2}, ${(containerHeight + 70) / 2})`); // Offset for control panel
  
  // Create tooltip
  const tooltip = d3.select("body")
    .append("div")
    .attr("class", "tooltip d3-relationship-tooltip")
    .style("opacity", 0)
    .style("background-color", "var(--surface-level-1)")
    .style("border", "1px solid var(--border-level-2)")
    .style("border-radius", "5px")
    .style("padding", "10px")
    .style("color", "var(--text-primary)")
    .style("position", "absolute")
    .style("z-index", 1000)
    .style("font-size", "12px")
    .style("pointer-events", "none")
    .style("display", "none");
  
  // Use objects, not indices for D3 v7+
  const nodes = allNodes.map(node => Object.assign({}, node));
  
  // Create links with direct object references
  const forceLinks = [];
  links.forEach(rel => {
    // Find the actual source and target node objects
    const sourceNode = nodes.find(n => n.id === rel.source);
    const targetNode = nodes.find(n => n.id === rel.target);
    
    // Only create the link if both nodes exist
    if (sourceNode && targetNode) {
      forceLinks.push({
        source: sourceNode,
        target: targetNode,
        value: rel.value,
        type: rel.type
      });
    }
  });
  
  // Get node color function using custom color scale
  function getNodeColor(d) {
    switch(d.type) {
      case "department":
        return customColorScale[0]; // Deep blue
      case "agency":
        return customColorScale[1]; // Navy purple
      case "office":
        return customColorScale[2]; // Purple
      case "contractor":
        return customColorScale[5]; // Orange for contractors
      default:
        return customColorScale[0];
    }
  }
  
  // Get link color function using custom color scale
  function getLinkColor(d) {
    if (d.type === "dept-agency") return customColorScale[0]; // Deep blue
    if (d.type === "agency-office") return customColorScale[1]; // Navy purple
    if (d.type === "dept-contractor") return customColorScale[0]; // Deep blue
    if (d.type === "agency-contractor") return customColorScale[1]; // Navy purple
    return customColorScale[2]; // Purple for office-contractor
  }
  
  // Create link width scale
  const linkWidthScale = d3.scaleLinear()
    .domain([0, d3.max(forceLinks, d => d.value) || 1])
    .range([1, 8]);
  
  // Create node size scale
  const nodeSizeScale = d3.scaleSqrt()
    .domain([0, d3.max(nodes, d => d.value) || 1])
    .range([6, 20]);
  
  // ENHANCED SIMULATION with better initial positioning
  relationshipMapSimulation = d3.forceSimulation(nodes)
    .force("link", d3.forceLink(forceLinks)
      .id(d => d.id)
      .distance(d => {
        // Different distances for different hierarchy levels
        if (d.type === "dept-agency") return 100;
        if (d.type === "agency-office") return 130;
        if (d.type === "dept-contractor") return 150;
        if (d.type === "agency-contractor") return 140;
        return 180; // office-contractor
      })
      .strength(0.5))
    .force("charge", d3.forceManyBody().strength(-500))
    .force("center", d3.forceCenter(0, 0))
    .force("collide", d3.forceCollide(d => nodeSizeScale(d.value) + 30))
    .force("x", d3.forceX().strength(0.08))
    .force("y", d3.forceY().strength(0.08));
  
  // Store original positions after initial simulation
  relationshipMapSimulation.on("end", () => {
    originalNodePositions.clear();
    nodes.forEach(d => {
      originalNodePositions.set(d.id, { x: d.x, y: d.y });
    });
  });
  
  // Continue with the rest of the visualization logic...
  // [Rest of the original rendering code remains the same]
  
  // Draw links with different colors for hierarchy levels
  const link = g.append("g")
    .attr("class", "links")
    .selectAll("line")
    .data(forceLinks)
    .enter()
    .append("line")
    .attr("stroke-width", d => linkWidthScale(d.value))
    .attr("stroke", d => getLinkColor(d))
    .attr("stroke-opacity", 0.6)
    .attr("stroke-dasharray", d => d.type === "dept-agency" ? "5,5" : "none")
    .on("mouseover", function(event, d) {
      d3.select(this)
        .attr("stroke", customColorScale[4]) // Coral for highlighting
        .attr("stroke-opacity", 1);
      tooltip.style("display", "block")
        .transition()
        .duration(200)
        .style("opacity", .9);
      tooltip.html(`
        <strong>${d.source.id}</strong>  <strong>${d.target.id}</strong><br/>
        <span>Total Value: ${formatCurrency(d.value)}</span>
      `)
        .style("left", (event.pageX + 10) + "px")
        .style("top", (event.pageY - 28) + "px");
    })
    .on("mouseout", function(event, d) {
      // Restore original color
      d3.select(this)
        .attr("stroke", getLinkColor(d))
        .attr("stroke-opacity", 0.6);
      tooltip.transition()
        .duration(200)
        .style("opacity", 0)
        .on("end", () => tooltip.style("display", "none"));
    });
  
  // Create node groups with ENHANCED DRAG BEHAVIOR
  const node = g.append("g")
    .attr("class", "nodes")
    .selectAll("g")
    .data(nodes)
    .enter()
    .append("g")
    .call(d3.drag()
      .on("start", dragstarted)
      .on("drag", dragged)
      .on("end", dragended))
    .on("click", function(event, d) {
      tooltip.style("display", "none");
      tooltip.style("opacity", 0);
      setTimeout(() => {
        let filterType = 'primeName';
        if (d.type === "contractor") {
          filterType = 'primeName';
        } else if (d.type === "office") {
          filterType = 'officeName';
        } else if (d.type === "agency") {
          filterType = 'agencyName';
        } else if (d.type === "department") {
          filterType = 'departmentName';
        }
        setUnifiedSearchTerm(d.id, filterType);
      }, 100);
    });
  
  // Add different shapes for different entity types
  node.each(function(d) {
    const el = d3.select(this);
    if (d.type === "department") {
      // Pentagon for Departments
      el.append("polygon")
        .attr("points", function() {
          const r = nodeSizeScale(d.value);
          return drawPentagon(0, 0, r);
        })
        .attr("fill", getNodeColor(d))
        .attr("stroke", "white")
        .attr("stroke-width", 1.5);
    } else if (d.type === "agency") {
      // Triangle for Agencies
      el.append("polygon")
        .attr("points", function() {
          const r = nodeSizeScale(d.value);
          return `0,${-r} ${r*0.866},${r*0.5} ${-r*0.866},${r*0.5}`;
        })
        .attr("fill", getNodeColor(d))
        .attr("stroke", "white")
        .attr("stroke-width", 1.5);
    } else if (d.type === "office") {
      // Square for Offices
      const r = nodeSizeScale(d.value);
      el.append("rect")
        .attr("x", -r/2)
        .attr("y", -r/2)
        .attr("width", r)
        .attr("height", r)
        .attr("fill", getNodeColor(d))
        .attr("stroke", "white")
        .attr("stroke-width", 1.5);
    } else {
      // Circle for Contractors
      el.append("circle")
        .attr("r", nodeSizeScale(d.value))
        .attr("fill", getNodeColor(d))
        .attr("stroke", "white")
        .attr("stroke-width", 1.5);
    }
  });
  
  // Helper function to draw a pentagon
  function drawPentagon(x, y, r) {
    const points = [];
    for (let i = 0; i < 5; i++) {
      points.push([
        x + r * Math.sin(2 * Math.PI * i / 5),
        y - r * Math.cos(2 * Math.PI * i / 5)
      ]);
    }
    return points.map(p => p.join(",")).join(" ");
  }
  
  // First, add background rectangles for text
  node.append("rect")
    .attr("class", "text-background")
    .attr("x", d => {
      const nodeSize = nodeSizeScale(d.value);
      if (d.type === "department" || d.type === "agency") {
        return nodeSize + 3;
      }
      return nodeSize + 1;
    })
    .attr("y", -10)
    .attr("width", 0)  // Will update after text is added
    .attr("height", 20)
    .attr("fill", "var(--background)")
    .attr("opacity", 0.85)
    .attr("rx", 3)
    .attr("ry", 3);
  
  // Add text labels to nodes with increased character limit
  const textElements = node.append("text")
    .attr("dx", d => {
      // Adjust based on node shape
      const nodeSize = nodeSizeScale(d.value);
      if (d.type === "department" || d.type === "agency") {
        return nodeSize + 5;
      }
      return nodeSize + 3;
    })
    .attr("dy", ".35em")
    .text(d => {
      const name = d.id;
      // Increase character limit - show more text
      const charLimit = isDesktop ? 40 : 25;
      const truncateAt = isDesktop ? 37 : 22;
      return name.length > charLimit ? name.substring(0, truncateAt) + '...' : name;
    })
    .style("font-size", "10px")
    .style("fill", getCSSVariable('--text-primary'))
    .style("pointer-events", "none");
  
  // After adding text, calculate the actual text width and update the background rectangles
  textElements.each(function(d) {
    const textWidth = this.getComputedTextLength();
    // Find the corresponding background rectangle and update its width
    d3.select(this.parentNode)
      .select("rect.text-background")
      .attr("width", textWidth + 6); // Add some padding
  });
  
  // Add hover effects for nodes
  node.on("mouseover", function(event, d) {
    // Highlight the node
    d3.select(this).select("circle, rect, polygon")
      .attr("stroke", customColorScale[4]) // Use coral for highlight
      .attr("stroke-width", 2);
    
    // Show tooltip with full entity name
    tooltip.style("display", "block")
      .transition()
      .duration(200)
      .style("opacity", .9);
    const entityType = d.type.charAt(0).toUpperCase() + d.type.slice(1);
    tooltip.html(`
      <strong>${entityType}:</strong> ${d.id}<br/>
      <span>Total Value: ${formatCurrency(d.value)}</span>
    `)
      .style("left", (event.pageX + 10) + "px")
      .style("top", (event.pageY - 28) + "px");
  })
  .on("mouseout", function() {
    // Remove highlight
    d3.select(this).select("circle, rect, polygon")
      .attr("stroke", "white")
      .attr("stroke-width", 1.5);
    // Hide tooltip
    tooltip.transition()
      .duration(200)
      .style("opacity", 0)
      .on("end", () => tooltip.style("display", "none"));
  });
  
  // BUTTON EVENT HANDLERS
  pauseBtn.on("click", function() {
    isSimulationPaused = !isSimulationPaused;
    
    if (isSimulationPaused) {
      relationshipMapSimulation.stop();
      pauseBtnText.text("Resume Physics");
      pauseBtn.select("rect").attr("fill", "var(--surface-level-2)");
      pauseBtnText.attr("fill", "var(--text-primary)");
    } else {
      relationshipMapSimulation.alpha(0.3).restart();
      pauseBtnText.text("Pause Physics");
      pauseBtn.select("rect").attr("fill", "var(--accent)");
      pauseBtnText.attr("fill", "var(--on-accent)");
    }
  });
  
  resetBtn.on("click", function() {
    // Reset to original positions
    nodes.forEach(d => {
      const original = originalNodePositions.get(d.id);
      if (original) {
        d.fx = null; // Remove fixed position
        d.fy = null;
        d.x = original.x;
        d.y = original.y;
      }
    });
    
    // Restart simulation
    isSimulationPaused = false;
    relationshipMapSimulation.alpha(1).restart();
    
    // Update button state
    pauseBtnText.text("Pause Physics");
    pauseBtn.select("rect").attr("fill", "var(--accent)");
    pauseBtnText.attr("fill", "var(--on-accent)");
  });
  
  // Add legend (adjusted for control panel)
  const legendMargin = { top: 90, left: 20 }; // Adjusted for control panel
  const legend = svg.append("g")
    .attr("class", "legend")
    .attr("transform", `translate(${legendMargin.left}, ${legendMargin.top})`);
  
  const legendItems = [
    { type: "department", label: "Departments", shape: "pentagon", color: customColorScale[0] },
    { type: "agency", label: "Agencies", shape: "triangle", color: customColorScale[1] },
    { type: "office", label: "Offices", shape: "square", color: customColorScale[2] },
    { type: "contractor", label: "Prime Contractors", shape: "circle", color: customColorScale[5] }
  ];
  
  legendItems.forEach((item, i) => {
    const yPos = i * 25;
    const g = legend.append("g").attr("transform", `translate(0, ${yPos})`);
    
    if (item.shape === "circle") {
      g.append("circle")
        .attr("r", 6)
        .attr("cx", 6)
        .attr("cy", 0)
        .attr("fill", item.color);
    } else if (item.shape === "square") {
      g.append("rect")
        .attr("x", 0)
        .attr("y", -6)
        .attr("width", 12)
        .attr("height", 12)
        .attr("fill", item.color);
    } else if (item.shape === "triangle") {
      g.append("polygon")
        .attr("points", "6,0 12,10 0,10")
        .attr("transform", "translate(0, -8)")
        .attr("fill", item.color);
    } else if (item.shape === "pentagon") {
      g.append("polygon")
        .attr("points", drawPentagon(6, 0, 6))
        .attr("fill", item.color);
    }
    
    g.append("text")
      .attr("x", 20)
      .attr("y", 4)
      .text(item.label)
      .style("font-size", "12px")
      .style("fill", getCSSVariable('--text-primary'));
  });
  
  // Add line style legend
  const lineStyleLegend = svg.append("g")
    .attr("class", "line-legend")
    .attr("transform", `translate(${legendMargin.left}, ${legendMargin.top + 120})`);
  
  // Department to Agency link
  lineStyleLegend.append("line")
    .attr("x1", 0)
    .attr("y1", 0)
    .attr("x2", 30)
    .attr("y2", 0)
    .attr("stroke-width", 3)
    .attr("stroke", customColorScale[0])
    .attr("stroke-dasharray", "5,5");
  lineStyleLegend.append("text")
    .attr("x", 40)
    .attr("y", 4)
    .text("Dept  Agency")
    .style("font-size", "10px")
    .style("fill", getCSSVariable('--text-primary'));
  
  // Agency to Office link
  lineStyleLegend.append("line")
    .attr("x1", 0)
    .attr("y1", 20)
    .attr("x2", 30)
    .attr("y2", 20)
    .attr("stroke-width", 3)
    .attr("stroke", customColorScale[1]);
  lineStyleLegend.append("text")
    .attr("x", 40)
    .attr("y", 24)
    .text("Agency  Office")
    .style("font-size", "10px")
    .style("fill", getCSSVariable('--text-primary'));
  
  // Office to Contractor link
  lineStyleLegend.append("line")
    .attr("x1", 0)
    .attr("y1", 40)
    .attr("x2", 30)
    .attr("y2", 40)
    .attr("stroke-width", 3)
    .attr("stroke", customColorScale[2]);
  lineStyleLegend.append("text")
    .attr("x", 40)
    .attr("y", 44)
    .text("Office  Contractor")
    .style("font-size", "10px")
    .style("fill", getCSSVariable('--text-primary'));
  
  // Update positions during simulation
  relationshipMapSimulation.on("tick", () => {
    // Only update if simulation is not paused
    if (!isSimulationPaused) {
      // Constrain nodes within bounds
      nodes.forEach(d => {
        const baseRadius = nodeSizeScale(d.value);
        const radius = baseRadius + 40; // Add space for text
        d.x = Math.max(-containerWidth/2 + radius, Math.min(containerWidth/2 - radius, d.x));
        d.y = Math.max(-containerHeight/2 + radius + 35, Math.min(containerHeight/2 - radius - 35, d.y)); // Account for control panel
      });
      
      // Update link positions
      link
        .attr("x1", d => d.source.x)
        .attr("y1", d => d.source.y)
        .attr("x2", d => d.target.x)
        .attr("y2", d => d.target.y);
      
      // Update node positions
      node
        .attr("transform", d => `translate(${d.x},${d.y})`);
    }
  });
  
  // Start simulation with higher alpha
  relationshipMapSimulation.alpha(1).restart();
  
  // ENHANCED DRAG FUNCTIONS with persistent positioning
  function dragstarted(event, d) {
    if (!isSimulationPaused && !event.active) {
      relationshipMapSimulation.alphaTarget(0.3).restart();
    }
    d.fx = d.x;
    d.fy = d.y;
    // Hide tooltip while dragging
    tooltip.style("display", "none").style("opacity", 0);
  }
  
  function dragged(event, d) {
    d.fx = event.x;
    d.fy = event.y;
    
    // If simulation is paused, manually update positions
    if (isSimulationPaused) {
      d.x = event.x;
      d.y = event.y;
      
      // Manually update this node's position
      d3.select(this).attr("transform", `translate(${d.x},${d.y})`);
      
      // Update connected links
      link
        .filter(l => l.source === d || l.target === d)
        .attr("x1", l => l.source.x)
        .attr("y1", l => l.source.y)
        .attr("x2", l => l.target.x)
        .attr("y2", l => l.target.y);
    }
  }
  
  function dragended(event, d) {
    if (!isSimulationPaused && !event.active) {
      relationshipMapSimulation.alphaTarget(0);
    }
    // Keep the node fixed at its dragged position
    // Don't set fx/fy to null - this allows user arrangement to persist
  }
}
// Add this function to hide empty charts and rearrange the layout
function adjustChartsVisibility(isPrimeView = false) {
  // Get chart cards
  const marketShareCard = document.getElementById('marketShareChartCard');
  const primeContractorsCard = document.getElementById('primeContractorsChartCard');
  // Get the grid container that holds all chart cards
  const chartGrid = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-3.gap-4.md\\:gap-6');
  if (isPrimeView) {
    // Hide prime-specific charts
    if (marketShareCard) marketShareCard.classList.add('hidden');
    if (primeContractorsCard) primeContractorsCard.classList.add('hidden');
    // Rearrange the grid for better layout
    if (chartGrid) {
      // Change from 3-column to 2-column layout for large screens
      chartGrid.classList.remove('lg:grid-cols-3');
      chartGrid.classList.add('lg:grid-cols-2');
    }
    // Move more important charts to the top positions
    // This assumes your charts are direct children of the grid
    const visibleCharts = Array.from(chartGrid.children).filter(card => 
      !card.classList.contains('hidden')
    );
    // Reorder the visible charts
    visibleCharts.forEach((chart, index) => {
      chart.style.order = index;
    });
  } else {
    // Show all charts for non-prime view
    if (marketShareCard) marketShareCard.classList.remove('hidden');
    if (primeContractorsCard) primeContractorsCard.classList.remove('hidden');
    // Restore original grid layout
    if (chartGrid) {
      chartGrid.classList.remove('lg:grid-cols-2');
      chartGrid.classList.add('lg:grid-cols-3');
    }
    // Reset any order modifications
    Array.from(chartGrid.children).forEach(chart => {
      chart.style.order = '';
    });
  }
}
document.addEventListener('DOMContentLoaded', function() {
  getChartColors();
  initializeChartDefaults();
  const storedTheme = localStorage.getItem('theme');
  if (storedTheme === 'dark') {
    document.documentElement.classList.add('dark');
    if(themeIconSun) themeIconSun.classList.add('hidden');
    if(themeIconMoon) themeIconMoon.classList.remove('hidden');
  }
  const sidebar = document.getElementById('dashboardSidebar');
  const mainContent = document.getElementById('dashboardMainContent');
  const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
  const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
  const isDesktop = window.innerWidth >= 1025;
  // For desktop: sidebar is always visible
  // For mobile/tablet: sidebar is hidden by default
  if (!isDesktop) {
    mainContent.style.marginLeft = '0';
    mainContent.style.width = '100%';
  }
  // Handle changing window size
  window.addEventListener('resize', function() {
    const nowDesktop = window.innerWidth >= 1025;
    if (nowDesktop !== isDesktop) {
      location.reload();
    }
  });
  if (typeof addCloseButtonsToDetailSections === 'function') {
    addCloseButtonsToDetailSections();
  }
  if (typeof closeAllDetailSections === 'function') {
    closeAllDetailSections();
  }
  const contractExpirationDetails = document.getElementById('contractExpirationDetails');
  if (contractExpirationDetails && typeof initializeOpportunityTableControls === 'function') {
    initializeOpportunityTableControls();
  }
  if ('ontouchstart' in window) {
    document.querySelectorAll('button, .filter-btn').forEach(el => {
      el.addEventListener('touchstart', function() {
        this.classList.add('active-touch');
      });
      el.addEventListener('touchend', function() {
        this.classList.remove('active-touch');
      });
    });
  }
  if (typeof handleVisualResizeDebounced === 'function') {
    window.addEventListener('resize', handleVisualResizeDebounced);
  }
  initializeResponsiveHeatmap();
  addResizeListener();
  // Close sidebar when clicking outside on mobile
  document.addEventListener('click', function(event) {
    if (!isDesktop && 
        sidebar && sidebar.classList.contains('expanded') && 
        !sidebar.contains(event.target) && 
        event.target !== mobileSidebarToggle &&
        event.target !== toggleSidebarBtn) {
      sidebar.classList.remove('expanded');
    }
  });
  // Close sidebar with Escape key
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape' && sidebar && sidebar.classList.contains('expanded')) {
      sidebar.classList.remove('expanded');
    }
  });
  loadDataFromS3();
  setTimeout(function() {
    var loader = document.getElementById('page-loader');
    if (loader) {
      loader.style.opacity = '0';
      loader.style.pointerEvents = 'none';
      setTimeout(function() {
        loader.style.display = 'none';
      }, 300);
    }
  }, 3000);
});
// Add after your DOM ready function
function setupMobileQuickPicks() {
  // Only run on mobile
  if (window.innerWidth > 1024) return;
  // Get all Quick Pick sections
  const quickPickSections = document.querySelectorAll('.sidebar-content > div');
  quickPickSections.forEach(section => {
    const buttonContainer = section.querySelector('.flex.flex-wrap');
    if (!buttonContainer) return;
    // Add click handler to the "More..." text
    const moreButtonArea = document.createElement('span');
    moreButtonArea.className = 'text-xs px-2 py-1 bg-[var(--surface-level-2)] hover:bg-[var(--surface-level-3)] rounded text-[var(--text-secondary)] cursor-pointer';
    moreButtonArea.textContent = 'More...';
    moreButtonArea.style.whiteSpace = 'nowrap';
    moreButtonArea.addEventListener('click', function() {
      // Toggle visibility of all buttons
      const buttons = buttonContainer.querySelectorAll('button');
      let showing = false;
      buttons.forEach((btn, index) => {
        if (index >= 5) {
          btn.style.display = btn.style.display === 'none' ? 'inline-flex' : 'none';
          showing = btn.style.display !== 'none';
        }
      });
      // Update the text based on state
      this.textContent = showing ? 'Less...' : 'More...';
    });
    buttonContainer.appendChild(moreButtonArea);
  });
}
// Call this function after DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  // Your existing code...
  // Add this at the end
  setupMobileQuickPicks();
});
</script>
</html>