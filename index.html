<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Subhoo - Federal Prime Contractor Database</title>
    <script src="https://cdn.tailwindcss.com"></script>
<!-- JavaScript Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
<!-- MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<!-- SEO Meta Tags -->
<meta name="description" content="Subhoo helps small businesses discover federal subcontracting opportunities by visualizing prime contractors with mandatory subcontracting plans from the SBA's official directory.">
<meta name="keywords" content="federal contracting, subcontractor intelligence, USASpending, government contracts, prime contractors, federal sales, business development, small business">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://subhoo.com/">
<!-- Preconnect to External Domains -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap" rel="stylesheet">
<link rel="preconnect" href="https://www.googletagmanager.com">
<link rel="preconnect" href="https://cdnjs.cloudflare.com">
<link rel="preconnect" href="https://d3js.org">
<link rel="preconnect" href="https://unpkg.com">
<!-- Favicon -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<meta name="theme-color" content="#252327" class="theme-color">
<!-- Open Graph / Facebook -->
<meta property="og:type" content="website" />
<meta property="og:url" content="https://subhoo.com/" />
<meta property="og:title" content="Subhoo - Federal Prime Contractor Database" />
<meta property="og:description" content="Discover federal subcontracting opportunities by visualizing prime contractors with mandatory small business participation plans. Search, explore, and connect with potential prime partners." />
<meta property="og:image" content="https://subhoo.com/subhoo.png">
<meta property="og:locale" content="en_US">
<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Subhoo - Federal Prime Contractor Database" />
<meta name="twitter:description" content="Discover federal subcontracting opportunities by visualizing prime contractors with mandatory small business participation plans. Search, explore, and connect with potential prime partners." />
<meta name="twitter:image" content="https://subhoo.com/subhoo.png" />
<!-- Security Headers -->
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2W258XTWJG"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-2W258XTWJG');
</script>
<!-- Structured Data -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "Subhoo",
  "url": "https://subhoo.com/",
  "description": "Federal Prime Contractor Database with Subcontracting Plans",
  "potentialAction": {
    "@type": "SearchAction",
    "target": "https://subhoo.com/search?q={search_term_string}",
    "query-input": "required name=search_term_string"
  }
}
</script>
<style>
:root {
  font-family: Inter, sans-serif;
  font-feature-settings: 'liga' 1, 'calt' 1;
  /* Modern Government with Clear Differentiation */
  --deep-blue: #211c26;      /* Very dark purple */
  --navy-purple: #342f3a;    /* Dark purple */
  --purple: #49434e;         /* Deep purple */
  --pink: #5f5864;           /* Medium purple */
  --coral: #756f7b;          /* Purple-gray */
  --orange: #8c8692;         /* Medium lavender-gray */
  
  /* Additional colors from the palette */
  --lavender-1: #a49daa;     /* Lavender-gray */
  --lavender-2: #bdb6c3;     /* Light lavender */
  --lavender-3: #d6cfdc;     /* Pale lavender */
  
  /* Neutral Gray Palette - updated to use the lavender tints */
  --white: #ffffff;
  --seasalt: #f7f7fa;           /* Very pale lavender-white */
  --antiflash-white: #f0eef4;   /* Pale lavender-white */
  --platinum: #e4e1e9;          /* Light lavender */
  --french-gray: #d6cfdc;       /* Pale lavender */
  --french-gray-2: #bdb6c3;     /* Light lavender */
  --slate-gray: #a49daa;        /* Lavender-gray */
  --outer-space: #8c8692;       /* Medium lavender-gray */
  --onyx: #49434e;              /* Deep purple */
  --eerie-black: #342f3a;       /* Dark purple */
  
  /* Light Mode Colors - updated to use your new palette */
  --background: var(--antiflash-white);      /* Pale lavender-white */
  --content-background: var(--white);        /* White */
  --on-accent: #ffffff;                      /* White text on accent */
  --accent: var(--navy-purple);              /* Dark purple */
  --accent-hover: var(--deep-blue);          /* Very dark purple */
  --accent-secondary: rgba(52, 47, 58, 0.15);  /* Dark purple with opacity */
  --gradient-bg-start: rgba(52, 47, 58, 0.08); /* Dark purple with less opacity */
  --gradient-bg-end: rgba(52, 47, 58, 0);      /* Transparent dark purple */
  
  /* Text colors */
  --text-primary: var(--eerie-black);        /* Dark purple */
  --text-secondary: var(--onyx);             /* Deep purple */
  --text-tertiary: var(--slate-gray);        /* Lavender-gray */
  
  /* Border colors - updated to better match your palette */
  --border-level-1: rgba(189, 182, 195, 0.3); /* Light lavender with opacity */
  --border-level-2: rgba(189, 182, 195, 0.5); /* Light lavender with more opacity */
  --border-level-3: rgba(189, 182, 195, 0.8); /* Light lavender with high opacity */
  
  /* Surface levels - updated to match your palette */
  --surface-level-1: var(--content-background);
  --surface-level-2: rgba(214, 207, 220, 0.3); /* Pale lavender with opacity */
  --surface-level-3: rgba(214, 207, 220, 0.5); /* Pale lavender with more opacity */
  
  /* Chart colors updated to your 9-color palette */
  --chart-accent-1: #211c26;  /* Very dark purple */
  --chart-accent-2: #342f3a;  /* Dark purple */
  --chart-accent-3: #49434e;  /* Deep purple */
  --chart-accent-4: #5f5864;  /* Medium purple */
  --chart-accent-5: #756f7b;  /* Purple-gray */
  --chart-highlight: #8c8692; /* Medium lavender-gray */
  --chart-extra-1: #a49daa;   /* Lavender-gray */
  --chart-extra-2: #bdb6c3;   /* Light lavender */
  --chart-extra-3: #d6cfdc;   /* Pale lavender */
  
  /* UI variables */
  --header-font-weight: 600;
  --button-font-weight: 500;
  --space-m: 12px;
  
  /* Layout variables */
  --sidebar-width: 280px;
  --sidebar-width-collapsed: 60px;
  --topbar-height: 60px;
}

/* Dark Mode Colors - completely revised for the purple palette */
html.dark {
  /* Background colors */
  --background: #1a171e;              /* Nearly black-purple background */
  --content-background: #26212d;      /* Very dark purple content area */
  
  /* Accent colors - using lighter colors from the palette for better visibility */
  --accent: #a49daa;                  /* Lavender-gray */ 
  --accent-hover: #bdb6c3;            /* Light lavender */
  --accent-secondary: rgba(164, 157, 170, 0.3);   /* Lavender-gray with opacity */
  --gradient-bg-start: rgba(164, 157, 170, 0.15); /* Lavender-gray with less opacity */
  --gradient-bg-end: rgba(164, 157, 170, 0);      /* Transparent lavender-gray */
  
  /* Text colors - explicitly light for dark mode */
  --text-primary: #f0eef4;            /* Pale lavender-white */
  --text-secondary: #d6cfdc;          /* Pale lavender */
  --text-tertiary: #bdb6c3;           /* Light lavender */
  
  /* Border colors */
  --border-level-1: rgba(95, 88, 100, 0.35);    /* Medium purple with opacity */
  --border-level-2: rgba(95, 88, 100, 0.55);    /* Medium purple with more opacity */
  --border-level-3: rgba(117, 111, 123, 0.75);  /* Purple-gray with high opacity */
  
  /* Surface levels for cards, etc. */
  --surface-level-1: var(--content-background);  /* Very dark purple */
  --surface-level-2: rgba(52, 47, 58, 0.8);      /* Dark purple with high opacity */
  --surface-level-3: rgba(73, 67, 78, 0.6);      /* Deep purple with medium opacity */
  
  /* Chart colors match the exact palette */
  --chart-accent-1: #211c26;  /* Very dark purple */
  --chart-accent-2: #342f3a;  /* Dark purple */
  --chart-accent-3: #49434e;  /* Deep purple */
  --chart-accent-4: #5f5864;  /* Medium purple */
  --chart-accent-5: #756f7b;  /* Purple-gray */
  --chart-highlight: #8c8692; /* Medium lavender-gray */
  --chart-extra-1: #a49daa;   /* Lavender-gray */
  --chart-extra-2: #bdb6c3;   /* Light lavender */
  --chart-extra-3: #d6cfdc;   /* Pale lavender */
}

/* Force sidebar and content backgrounds in dark mode */
html.dark .sidebar,
html.dark .sidebar-header,
html.dark .sidebar-content,
html.dark .sidebar-footer {
  background-color: var(--background) !important;
  border-color: var(--border-level-2) !important;
}

html.dark .main-content,
html.dark .dashboard-card,
html.dark .chart-container,
html.dark .section-header {
  background-color: var(--content-background) !important;
}

/* Force lighter text colors in dark mode */
html.dark .text-[var(--text-primary)],
html.dark .text-[var(--accent)],
html.dark h1, html.dark h2, html.dark h3, html.dark h4,
html.dark .font-bold, html.dark .font-semibold, html.dark .font-extrabold,
html.dark #currentFilterDescription,
html.dark #totalContractsValue,
html.dark #totalValueValue,
html.dark #avgContractValue,
html.dark #uniquePrimesValue {
  color: var(--text-primary) !important;
}

/* Force accent color on buttons */
html.dark .btn-primary,
html.dark .action-btn,
html.dark button.bg-[var(--accent)] {
  background-color: var(--accent) !important;
  color: var(--onyx) !important; /* Dark text on light buttons for contrast */
}
/* ===== BASE LAYOUT ===== */
body {
  background-color: var(--surface-level-1);
  color: var(--text-primary);
  transition: background-color 0.3s ease, color 0.3s ease;
  margin: 0;
  padding: 0;
  height: 100vh;
  overflow: hidden;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}
/* App container and dashboard layout */
.app-wrapper {
    max-width: 1600px;
  margin-left: auto !important;
  margin-right: auto !important;
  margin-top: 20px;
  margin-bottom: 20px;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 8px 30px rgba(0, 31, 63, 0.1);
  display: flex;
  height: calc(100vh - 40px);
  position: relative;
  background-color: var(--background);
}
/* Add these useful button styles that match your chart colors */
.btn-primary {
  background-color: var(--accent);
  color: var(--on-accent);
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  transition: background-color 0.2s;
}
.btn-primary:hover {
  background-color: var(--accent-hover);
}
.btn-secondary {
  background-color: var(--accent-secondary);
  color: var(--accent);
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  transition: background-color 0.2s;
}
.btn-secondary:hover {
  background-color: rgba(68, 78, 134, 0.25);
}
  /* UI variables */
  --header-font-weight: 600;
  --button-font-weight: 500;
  --space-m: 12px;
  /* Layout variables */
  --sidebar-width: 280px;
  --sidebar-width-collapsed: 60px;
  --topbar-height: 60px;
}
/* Smallest screens */
@media (max-width: 480px) {
  #sankeyChart, #contractorMap {
    height: 300px !important;
  }
  .dashboard-card {
    padding: 0.75rem !important;
  }
  #unifiedSearchInput {
    font-size: 14px;
    padding: 0.5rem !important;
  }
  .stat-card {
    padding: 0.75rem !important;
  }
  .stat-card .text-2xl {
    font-size: 1.25rem !important;
  }
}
/* ===== PRINT STYLES ===== */
@media print {
  .dashboard-card {
    break-inside: avoid;
    page-break-inside: avoid;
  }
  button, .action-btn, .filter-btn, #themeToggleBtn, #shareViewBtn {
    display: none !important;
  }
  body, .dashboard-container {
    background-color: white !important;
    color: black !important;
  }
  @page {
    margin: 1cm;
  }
}
/* Mobile breakpoints */
@media (max-width: 767px) {
  #sankeyChart, #contractorMap {
    height: 350px !important;
  }
  .chart-container {
    height: 250px !important;
  }
  .table-responsive th,
  .table-responsive td {
    padding: 4px 6px;
    font-size: 11px;
  }
  .dashboard-card {
    padding: 1rem !important;
  }
  .modal-content {
    padding: 1rem;
  }
  #primeProfilesContainer {
    max-height: 60vh;
  }
  button, 
  .filter-btn, 
  #themeToggleBtn, 
  #shareViewBtn,
  .suggestion-item {
    min-height: 44px; /* Minimum height for touch targets */
  }
  #clearSearchBtn {
    height: 44px;
    width: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .stat-card {
    margin-bottom: 0.5rem;
  }
  /* Further optimization for mobile */
  .sidebar-content {
    padding: 0.5rem;
  }
  .sidebar-search {
    padding: 0 0.5rem;
  }
  /* Ensure header is compact */
  .sidebar-header {
    padding: 0.5rem;
    height: auto;
  }
}
/* Further optimizations for very small screens */
@media (max-width: 640px) {
  /* Make buttons horizontal */
  .sidebar-content .flex.flex-wrap {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    gap: 0.25rem;
  }
  .app-wrapper {
    margin: 0;
    border-radius: 0;
    height: 100vh;
  }
  .sidebar {
    width: 0;
    border-right: none;
  }
  .main-content {
    margin-left: 0;
    width: 100%;
    padding: 0.5rem;
  }
  .sidebar.expanded {
    width: 100%;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
  }
  .dashboard-cards {
    grid-template-columns: 1fr;
  }
  .chart-container {
    height: 250px;
  }
  #sankeyChart {
    height: 400px !important;
  }
  .section-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }
  .section-header .action-btn {
    align-self: flex-end;
  }
  .table-responsive {
    margin-left: -1rem;
    margin-right: -1rem;
    width: calc(100% + 2rem);
    padding: 0 0.5rem;
  }
  .table-responsive th,
  .table-responsive td {
    padding: 0.25rem 0.5rem;
    font-size: 0.7rem;
    white-space: nowrap;
  }
}
.dashboard-container {
  display: flex;
  width: 100%;
  height: 100%;
  overflow: hidden;
  border-radius: 12px;
}
#dashboardContent {
  display: flex;
  flex-direction: column;
  min-height: calc(100vh - 200px);
}
/* Main Content */
.main-content {
  margin-left: var(--sidebar-width);
  width: calc(100% - var(--sidebar-width));
  height: 100%;
  overflow-y: auto;
  transition: margin-left 0.3s ease, width 0.3s ease;
  padding: 1rem;
  border-radius: 0 12px 12px 0;
  flex: 1;
  background-color: var(--background);
}
.main-content-expanded {
  margin-left: var(--sidebar-width-collapsed);
  width: calc(100% - var(--sidebar-width-collapsed));
}
/* Sidebar Styles */
.sidebar {
  width: var(--sidebar-width);
  height: 100%;
  background-color: var(--background);
  border-right: 1px solid var(--border-level-2);
  transition: width 0.3s ease;
  overflow-y: auto;
  overflow-x: hidden;
  position: absolute;
  top: 0;
  left: 0;
  z-index: 40;
  display: flex;
  flex-direction: column;
}
.sidebar-collapsed {
  width: var(--sidebar-width-collapsed);
}
.sidebar-header {
  padding: 1rem;
  border-bottom: 1px solid var(--border-level-2);
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: var(--topbar-height);
}
.sidebar-header button {
  opacity: 0.8;
  transition: opacity 0.2s, background-color 0.2s;
}
.sidebar-header button:hover {
  opacity: 1;
}
.sidebar-content {
  padding: 1rem;
  flex: 1;
  overflow-y: auto;
}
.sidebar-footer {
  padding: 1rem;
  border-top: 1px solid var(--border-level-2);
  font-size: 0.75rem;
}
/* Toggle Button for Sidebar */
.toggle-sidebar {
  background: none;
  border: none;
  color: var(--text-primary);
  cursor: pointer;
  padding: 0.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
}
/* Collapsed Sidebar Adjustments */
.sidebar-collapsed .sidebar-header {
  justify-content: center;
  padding: 1rem 0.5rem;
}
.sidebar-collapsed .sidebar-header .flex {
  display: none;
}
.sidebar-collapsed .toggle-sidebar {
  margin-left: 0;
}
.sidebar-collapsed .sidebar-footer {
  padding: 0.5rem;
  text-align: center;
  font-size: 0;
}
.sidebar-collapsed .sidebar-content {
  padding: 0.5rem;
}
/* Toggle Button in Main Content */
.sidebar-collapsed ~ .main-content #expandSidebarBtn {
  display: block;
}
/* ===== COMPONENTS ===== */
/* Cards */
.dashboard-card {
  background-color: var(--surface-level-1) !important;
  border: 1px solid var(--border-level-1);
  border-radius: 0.5rem;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  padding: 1rem;
}
.dashboard-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}
/* Search Input */
.sidebar-search {
  position: relative;
  margin-bottom: 1.5rem;
}
.sidebar-search input::placeholder {
  opacity: 0.7;
}
.sidebar-search button.text-xs {
  font-weight: 500;
  white-space: nowrap;
}
.search-input {
  width: 100%;
  padding: 0.75rem 2.5rem 0.75rem 0.75rem;
  border: 1px solid var(--border-level-2);
  border-radius: 0.375rem;
  background-color: var(--background);
  color: var(--text-primary);
  font-size: 0.875rem;
}
.search-clear-btn {
  position: absolute;
  right: 0.5rem;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: var(--text-tertiary);
  cursor: pointer;
}
/* Search suggestions styling */
.search-suggestions {
  position: absolute;
  width: 100%;
  max-height: 240px;
  overflow-y: auto;
  background-color: var(--background);
  border: 1px solid var(--border-level-2);
  border-top: none;
  border-radius: 0 0 0.375rem 0.375rem;
  z-index: 50;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  padding: 0.25rem 0;
}
.suggestion-item {
  padding: 0.5rem 0.75rem;
  cursor: pointer;
  display: flex;
  color: var(--text-secondary);
  align-items: center;
  justify-content: space-between;
  font-size: 0.85rem;
  border-bottom: 1px solid var(--border-level-1);
}
.suggestion-item:last-child {
  border-bottom: none;
}
.suggestion-item:hover {
  background-color: var(--surface-level-2);
}
.suggestion-text {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 70%;
}
.type-label {
  padding: 0.15rem 0.4rem;
  border-radius: 0.25rem;
  font-size: 0.65rem;
  background-color: var(--surface-level-1);
  color: var(--text-primary);
  display: inline-block;
  font-weight: 500;
  text-align: center;
  min-width: 45px;
}
/* Filter Elements */
.filter-group {
  margin-bottom: 1.5rem;
}
.filter-group-title {
  font-weight: var(--header-font-weight);
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.filter-label {
  font-size: 0.75rem;
  color: var(--text-secondary);
  margin-bottom: 0.25rem;
}
.filter-btn-group {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}
/* Hide specific filter groups */
.filter-group:has(#resetMapBtn), 
.filter-group:has(#resetSankeyBtn) {
  display: none !important;
}
/* Buttons */
.filter-btn {
  padding: 0.375rem 0.75rem;
  font-size: 0.75rem;
  border-radius: 0.25rem;
  background-color: var(--surface-level-2);
  border: 1px solid var(--border-level-2);
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.2s;
}
.filter-btn.active {
  background-color: var(--accent) !important;
  color: var(--on-accent) !important;
  border-color: var(--accent) !important;
}
.filter-btn:hover {
  background-color: var(--surface-level-3);
}
.action-btn {
  padding: 0.5rem 1rem;
  background-color: var(--accent);
  color: var(--on-accent);
  border-radius: 0.375rem;
  font-weight: var(--button-font-weight);
  transition: background-opacity 0.2s;
}
.action-btn:hover {
  opacity: 0.9;
}
.secondary-btn {
  padding: 0.375rem 0.75rem;
  background-color: var(--surface-level-2);
  color: var(--text-secondary);
  border-radius: 0.375rem;
  transition: background-color 0.2s;
}
.secondary-btn:hover {
  background-color: var(--surface-level-3);
}
/* Focus styles */
.filter-btn:focus,
button:focus,
input[type="text"]:focus,
select:focus,
a:focus {
  outline: none;
  box-shadow: 0 0 0 2px var(--background), 0 0 0 4px var(--chart-accent-1) !important;
}
/* Active Filter Indicators */
.active-filters {
  padding: 0.75rem;
  border-radius: 0.375rem;
  background-color: var(--accent-secondary);
  margin-bottom: 1rem;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}
.active-filter-tag {
  display: flex;
  align-items: center;
  background-color: var(--accent);
  color: var(--on-accent);
  padding: 0.25rem 0.5rem;
  border-radius: 0.25rem;
  font-size: 0.75rem;
  max-width: 100%;
}
.active-filter-tag span {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex: 1;
}
.clear-filter-btn {
  background: none;
  border: none;
  color: var(--on-accent);
  margin-left: 0.5rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}
#activeFilterIndicator {
  background-color: var(--accent-secondary);
  color: var(--accent);
  border: 1px solid var(--accent);
}
#activeFilterIndicator button {
  background-color: var(--accent);
  color: var(--on-accent);
}
#activeFilterIndicator button:hover {
  background-color: rgba(132, 88, 179, 0.8);
}
/* ===== VISUALIZATION COMPONENTS ===== */
/* Charts & Visualizations */
.chart-container {
  position: relative;
  height: 300px;
  width: 100%;
}
.chart-no-data {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--text-primary);
  background-color: var(--surface-level-1) !important;
  border: 1px dashed var(--border-level-2);
  border-radius: 0.375rem;
  text-align: center;
  padding: 1rem;
}
.chart-no-data svg {
  width: 3rem;
  height: 3rem;
  margin-bottom: 0.5rem;
  color: var(--text-tertiary);
}
/* Full width visualization */
.full-width-viz {
  max-width: 100%;
  width: 100%;
  overflow: hidden;
  margin-left: 0;
  margin-right: 0;
}
#sankeySection {
  overflow: hidden;
}
#sankeyWrapper {
  overflow: hidden;
}
#sankeyChart {
  max-width: 100%;
}
.leaflet-tile {
  filter: grayscale(80%) brightness(95%) contrast(105%);
}
/* Custom marker styling */
.custom-marker {
  border-radius: 50%;
  width: 100%;
  height: 100%;
  box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.7), 0 0 0 2px rgba(0, 0, 0, 0.2); /* White inner border, dark outer border */
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.custom-marker:hover {
  transform: scale(1.5);
  box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.9), 0 0 0 3px rgba(0, 0, 0, 0.3);
  z-index: 1000 !important;
}
/* Cluster styling */
.custom-cluster {
  background-color: transparent;
  border: none;
}
.cluster-icon {
  color: #fff;
  border-radius: 50%;
  text-align: center;
  line-height: 30px;
  width: 30px;
  height: 30px;
  font-size: 12px;
  font-weight: bold;
  box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.5);
}
.cluster-icon.medium {
  width: 40px;
  height: 40px;
  line-height: 40px;
  font-size: 14px;
}
.cluster-icon.large {
  width: 50px;
  height: 50px;
  line-height: 50px;
  font-size: 16px;
}
/* Sankey & Maps */
#sankeyChart, #contractorMap {
  height: 700px;
}
/* ===== TABLES ===== */
.table-responsive {
  display: block;
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: thin;
  scrollbar-color: var(--border-level-2) transparent;
}
.table-responsive::-webkit-scrollbar {
  height: 6px;
}
.table-responsive::-webkit-scrollbar-track {
  background: transparent;
}
.table-responsive::-webkit-scrollbar-thumb {
  background-color: var(--border-level-2);
  border-radius: 3px;
}
.table-responsive thead th {
  position: sticky;
  top: 0;
  z-index: 10;
  background-color: var(--surface-level-1);
  color: var(--text-secondary);
  border-bottom: 1px solid var(--border-level-2);
  cursor: pointer;
}
.table-responsive th:hover {
  background-color: var(--surface-level-2);
}
.table-responsive tbody {
  background-color: var(--background);
}
.table-responsive td {
  border-bottom: 1px solid var(--border-level-1);
}
/* Table text colors */
.table-responsive th,
.table-responsive td {
  color: var(--text-primary);
}
.table-responsive th {
  color: var(--text-secondary);
}
.table-responsive a {
  color: var(--accent);
}
/* Ensure modal tables follow the same rules */
#primeDetailContractsTableContainer th,
#primeDetailContractsTableContainer td,
#specializationContractsTable th,
#specializationContractsTable td,
#contractExpirationTableBody th,
#contractExpirationTableBody td {
  color: var(--text-primary);
}
/* ===== MODALS ===== */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background-color: rgba(0,0,0,0.75);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
  padding: 1rem;
}
.modal-content {
  background-color: var(--background);
  color: var(--text-primary);
  border-radius: 0.5rem;
  box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
  padding: 1.5rem;
  max-width: 90vw;
  width: 100%;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
}
.modal-content-lg { max-width: 60rem; }
.modal-content-md { max-width: 48rem; }
.modal-close-btn {
  position: absolute;
  top: 0.75rem;
  right: 0.75rem;
  background: none;
  border: none;
  font-size: 1.5rem;
  color: var(--text-tertiary);
  cursor: pointer;
  padding: 0.25rem;
}
.modal-close-btn:hover {
  color: var(--text-primary);
}
/* ===== UTILITIES ===== */
.spinner {
  border: 4px solid var(--surface-level-3);
  width: 24px;
  height: 24px;
  border-radius: 50%;
  border-left-color: var(--accent);
  animation: spin 1s linear infinite;
  margin-right: 10px;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
#processingIndicator.flex {
  display: flex;
}
.highlight-section {
  animation: pulse-highlight 1.5s ease-in-out;
}
@keyframes pulse-highlight {
  0%, 100% { box-shadow: 0 0 0 rgba(108, 117, 125, 0); }
  50% { box-shadow: 0 0 15px rgba(108, 117, 125, 0.5); }
}
#page-loader {
  transition: opacity 0.3s ease-out;
}
.timeout-message {
  display: none;
  text-align: center;
  margin-top: 1rem;
  padding: 0.5rem 1rem;
  background-color: var(--accent-secondary);
  border-radius: 0.375rem;
  font-size: 0.875rem;
}
#page-loader.timeout .timeout-message {
  display: block;
}
#manual-upload-section.timeout-show {
  display: block !important;
}
/* ===== WELCOME TITLE STYLES ===== */
.welcome-title {
  line-height: 1.4;
  animation: fadeIn 0.5s ease-in-out;
}
.welcome-title .greeting {
  color: var(--chart-accent-1);
  font-weight: 700;
  display: inline;
}
.welcome-title .description {
  font-weight: normal;
  font-size: 0.9em;
  opacity: 0.85;
  display: inline;
  margin-left: 0.25rem;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-5px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes subtle-pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}
.sidebar-search button.text-xs:first-of-type {
  animation: subtle-pulse 2s ease-in-out;
}
/* ===== CURRENT VIEW TITLE ===== */
#currentViewTitle {
  /* Use the deep purple consistently across both themes */
  background-color: var(--navy-purple) !important; /* Deep purple */
  border: none !important; /* Remove the border */
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important; /* Optional: add shadow for depth */
}

/* Apply consistent text colors regardless of theme */
#currentViewTitle {
  color: #ffffff !important; /* White text for contrast on purple */
}

#currentViewTitle * {
  color: #ffffff !important;
}

#currentFilterDescription {
  font-weight: 900 !important;
  font-size: 2.5rem !important;
  line-height: 1.1 !important;
  letter-spacing: -0.02em !important;
  color: #ffffff !important;
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif !important;
}

/* Secondary and tertiary text with consistent opacity */
#currentViewTitle .text-[var(--text-secondary)] {
  color: rgba(255, 255, 255, 0.7) !important;
}

#currentViewTitle .text-[var(--text-tertiary)] {
  color: rgba(255, 255, 255, 0.5) !important;
}

/* Force the same appearance in both light and dark mode */
html.dark #currentViewTitle,
html:not(.dark) #currentViewTitle {
  background-color: var(--navy-purple) !important;
  border: none !important;
}

html.dark #currentFilterDescription,
html:not(.dark) #currentFilterDescription {
  color: #ffffff !important;
}

/* Remove any theme-specific overrides that might interfere */
html:not(.dark) #currentViewTitle #currentFilterDescription {
  color: #ffffff !important;
}
/* ===== THEME-SPECIFIC OVERRIDES ===== */
/* Light theme specifics */
html:not(.dark) #currentViewTitle #currentFilterDescription {
  color: white !important;
}
/* Dark theme overrides */
html.dark body {
  background-color: #121212;
}
html.dark .dashboard-card {
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
}
html.dark .dashboard-card:hover {
  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
}
html.dark .chart-no-data {
  background-color: var(--surface-level-1) !important;
  border-color: var(--border-level-2);
  color: var(--text-secondary);
}
html.dark .table-responsive::-webkit-scrollbar-thumb {
  background-color: var(--border-level-3);
}
html.dark .table-responsive::-webkit-scrollbar-track {
  background-color: var(--background);
}
html.dark .filter-btn:focus,
html.dark button:focus,
html.dark input[type="text"]:focus,
html.dark select:focus {
  box-shadow: 0 0 0 3px rgba(222, 226, 230, 0.3);
  outline: none;
}
html.dark section.bg-[var(--surface-level-1)] {
  background-color: var(--surface-level-1);
}
html.dark footer img[src*="powered-by-aws-white.png"] {
  filter: brightness(0.8);
}
html.dark #primeDetailContractsTableContainer th,
html.dark #specializationContractsTable th,
html.dark #contractExpirationTableBody th {
  color: var(--text-secondary);
}
html.dark #primeDetailContractsTableContainer td,
html.dark #specializationContractsTable td,
html.dark #contractExpirationTableBody td {
  color: var(--text-primary);
}
html.dark .table-responsive tbody tr:hover {
  background-color: var(--surface-level-2);
}
/* Theme toggle icons */
#themeIconMoon {
  display: none;
}
html.dark #themeIconSun {
  display: none;
}
html.dark #themeIconMoon {
  display: block;
}
/* ===== RESPONSIVE LAYOUT OPTIMIZATION ===== */
/* Mobile sidebar toggle */
.mobile-sidebar-toggle {
  position: fixed;
  bottom: 1rem;
  right: 1rem;
  z-index: 50;
  background-color: var(--accent);
  color: var(--on-accent);
  border-radius: 50%;
  width: 3rem;
  height: 3rem;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
}
/* Desktop layout (1025px and above) */
@media (min-width: 1025px) {
  .sidebar {
    width: var(--sidebar-width);
    transform: translateX(0);
    pointer-events: auto;
  }
  .main-content {
    margin-left: var(--sidebar-width);
    width: calc(100% - var(--sidebar-width));
  }
  .mobile-sidebar-toggle,
  .sidebar-header #toggleSidebarBtn {
    display: none;
  }
}
/* Tablet and mobile layout (1024px and below) */
@media (max-width: 1024px) {
  /* Document layout fixes */
  html, body {
    height: auto;
    width: 100% !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
    position: relative !important;
  }
  /* Container layout fixes */
  .app-wrapper, .dashboard-container {
    flex-direction: column;
    height: auto;
    min-height: unset;
    overflow: visible;
    max-height: none;
    width: 100% !important;
    max-width: 100% !important;
    margin: 0 auto !important; /* Changed from "margin: 0 !important" */
    overflow-x: hidden !important;
  }
  /* Sidebar optimizations */
  .sidebar {
    position: static;
    width: 100%;
    height: auto;
    transform: none !important;
    border-right: none;
    border-bottom: 1px solid var(--border-level-2);
    box-shadow: none;
    background-color: var(--background);
    overflow: visible;
    z-index: 10;
    max-height: none;
  }
  .sidebar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    height: auto;
  }
  /* Main content fixes */
  .main-content {
    margin-left: 0 !important;
    width: 100% !important;
    max-width: 100vw !important;
    overflow-x: hidden !important;
    box-sizing: border-box !important;
    overflow: visible;
    height: auto;
    padding: 0.5rem !important;
  }
  /* Content container optimizations */
  .sidebar-content {
    max-height: none;
    overflow: visible;
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    max-width: 100% !important;
    overflow-x: hidden !important;
  }
  /* Hide non-essential elements */
  .mobile-sidebar-toggle,
  .shoutouts, 
  .connect-card,
  #activeFilterIndicator:empty,
  .sidebar-footer {
    display: none !important;
  }
  /* Disable transitions for better performance */
  .sidebar, .main-content {
    transition: none;
  }
  /* Quick Pick buttons optimization */
  .sidebar-content .flex.flex-wrap button {
    display: none;
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
    white-space: nowrap;
  }
  .sidebar-content .flex.flex-wrap button:nth-child(-n+5) {
    display: inline-flex;
  }
  /* More button for hidden options */
  .sidebar-content .flex.flex-wrap::after {
    content: "More...";
    display: inline-block;
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
    background-color: var(--surface-level-2);
    color: var(--text-secondary);
    border-radius: 0.375rem;
    cursor: pointer;
    white-space: nowrap;
  }
  /* Search bar optimizations */
  .sidebar-search {
    padding: 0.75rem 1rem;
    margin-bottom: 0.5rem;
    width: 100% !important;
    display: block !important;
    box-sizing: border-box !important;
  }
  .sidebar-search .relative {
    position: relative !important;
    display: flex !important;
    align-items: center !important;
    width: 100% !important;
  }
  .sidebar .search-input,
  #unifiedSearchInput {
    height: 44px;
    font-size: 16px; /* Prevents zoom on iOS */
    width: 100% !important;
    display: block !important;
    box-sizing: border-box !important;
    padding-left: 2.5rem !important; /* Space for the icon */
    padding-right: 2.5rem !important; /* Space for clear button */
  }
  /* Search icon positioning */
  .sidebar-search .absolute:first-child,
  .sidebar-search .inset-y-0.left-0,
  .search-clear-btn + div,
  .sidebar-search svg:first-of-type {
    position: absolute !important;
    left: 0.75rem !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    right: auto !important;
    bottom: auto !important;
  }
  /* Clear button positioning */
  #clearSearchBtn,
  .search-clear-btn,
  .sidebar-search .absolute:last-child,
  .sidebar-search .inset-y-0.right-0 {
    position: absolute !important;
    right: 0.75rem !important;
    left: auto !important;
    top: 50% !important;
    transform: translateY(-50%) !important;
    bottom: auto !important;
    min-width: 44px !important;
    min-height: 44px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
  /* Search suggestions container */
  #unifiedSearchSuggestions {
    width: calc(100% - 1rem) !important;
    max-width: calc(100vw - 1rem) !important;
    left: 0.5rem !important;
    right: 0.5rem !important;
    box-sizing: border-box !important;
  }
  /* Sidebar content styling */
  .sidebar-content > div {
    margin-bottom: 0.5rem;
  }
  .sidebar-content h3 {
    font-size: 0.75rem;
    margin-bottom: 0.25rem;
  }
  /* Compact reset button */
  #globalResetBtn {
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.8rem;
  }
  /* Fix overflow issues for various components */
  .dashboard-card,
  .chart-container,
  .grid,
  .flex,
  svg,
  canvas {
    max-width: 100% !important;
    box-sizing: border-box !important;
    overflow-x: hidden !important;
  }
  /* SVG specific fixes */
  svg {
    overflow: visible !important; /* Allow markers/elements to appear outside bounds */
    min-width: 0 !important; /* Allow SVG to shrink below intrinsic size */
  }
  /* Table responsiveness */
  .table-responsive {
    max-width: 100vw !important;
    overflow-x: auto !important;
    -webkit-overflow-scrolling: touch !important;
  }
  /* Fix grid layouts */
  .grid {
    grid-template-columns: 1fr !important; /* Force single column on mobile */
  }
  /* Dashboard content container */
  #dashboardContent {
    max-width: 100vw !important;
    overflow-x: hidden !important;
  }
  /* Remove margin classes that could cause overflow */
  [class*="mx-"], [class*="ml-"], [class*="mr-"] {
    margin-left: 0 !important;
    margin-right: 0 !important;
  }
  /* Modals and popovers */
  .modal-content,
  .tooltip,
  .popup,
  [class*="fixed"],
  [class*="absolute"] {
    max-width: 95vw !important;
  }
  /* Search icon size */
  .sidebar-search svg {
    width: 16px !important;
    height: 16px !important;
  }
}
/* Tablet/Desktop specific breakpoint */
@media (max-width: 1023px) {
  #sankeyChart, #contractorMap {
    height: 450px;
  }
}
/* Mobile specific breakpoint */
@media (max-width: 767px) {
  #sankeyChart, #contractorMap {
    height: 350px !important;
  }
  /* Further height optimizations */
  .chart-container {
    height: 250px !important;
  }
  /* Table text sizing */
  .table-responsive th,
  .table-responsive td {
    padding: 4px 6px;
    font-size: 11px;
  }
  /* Card adjustments */
  .dashboard-card {
    padding: 1rem !important;
  }
  /* Other mobile-specific adjustments */
  .modal-content {
    padding: 1rem;
  }
  #primeProfilesContainer {
    max-height: 60vh;
  }
  /* Touch target sizing */
  button, 
  .filter-btn, 
  #themeToggleBtn, 
  #shareViewBtn,
  .suggestion-item {
    min-height: 44px;
  }
  /* Other mobile tweaks */
  .stat-card {
    margin-bottom: 0.5rem;
  }
}
/* Very small screens */
@media (max-width: 640px) {
  /* Horizontal button layout */
  .sidebar-content .flex.flex-wrap {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    gap: 0.25rem;
  }
  /* Height adjustments */
  #sankeyChart {
    height: 400px !important;
  }
  /* Header layout */
  .section-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }
  .section-header .action-btn {
    align-self: flex-end;
  }
  /* Table adjustments */
  .table-responsive {
    margin-left: -1rem;
    margin-right: -1rem;
    width: calc(100% + 2rem);
    padding: 0 0.5rem;
  }
  .table-responsive th,
  .table-responsive td {
    padding: 0.25rem 0.5rem;
    font-size: 0.7rem;
    white-space: nowrap;
  }
  /* Condensed sidebar padding */
  .sidebar-header, 
  .sidebar-content, 
  .sidebar-footer {
    padding-left: 0.5rem !important;
    padding-right: 0.5rem !important;
  }
  /* Search container margin removal */
  .sidebar-search {
    margin-left: 0 !important;
    margin-right: 0 !important;
  }
}
/* Extra small screens */
@media (max-width: 480px) {
  #sankeyChart, #contractorMap {
    height: 300px !important;
  }
  .dashboard-card {
    padding: 0.75rem !important;
  }
  #unifiedSearchInput {
    font-size: 14px;
    padding: 0.5rem !important;
  }
  .stat-card {
    padding: 0.75rem !important;
  }
  .stat-card .text-2xl {
    font-size: 1.25rem !important;
  }
}
/* Mobile specific improvements */
@media (max-width: 767px) {
  /* Search container enhancements */
  .sidebar-search {
    padding: 12px 16px;
    background-color: var(--surface-level-1);
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    margin: 10px;
    position: relative;
    z-index: 100;
  }
  /* Search input styling */
  #unifiedSearchInput,
  .search-input {
    width: 100%;
    height: 44px; /* Larger touch target */
    font-size: 16px; /* Prevents zoom on iOS */
    padding: 0 40px; /* Space for icons */
    border-radius: 8px;
    border: 1px solid var(--border-level-2);
    background-color: var(--background);
    color: var(--text-primary);
    box-shadow: none;
    -webkit-appearance: none; /* Removes default styling on iOS */
  }
  /* Search icon positioning */
  .search-icon {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    width: 20px;
    height: 20px;
    color: var(--accent);
    pointer-events: none;
  }
  /* Clear button positioning and styling */
  .search-clear-btn,
  #clearSearchBtn {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: none;
    border: none;
    color: var(--text-tertiary);
    cursor: pointer;
    border-radius: 50%;
  }
  /* Search suggestions container */
  #unifiedSearchSuggestions,
  .search-suggestions {
    top: 100%;
    margin-top: 4px;
    width: 100%;
    max-height: 60vh; /* Larger on mobile for better scrolling */
    overflow-y: auto;
    background-color: var(--surface-level-1);
    border: 1px solid var(--border-level-2);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 1000;
  }
  /* Search suggestion items */
  .suggestion-item {
    padding: 12px 16px; /* Larger touch targets */
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border-level-1);
  }
  /* Active filters area */
  .active-filters {
    margin: 12px;
    padding: 12px;
    border-radius: 8px;
    background-color: var(--accent-secondary);
  }
  /* Filter tags */
  .active-filter-tag {
    height: 36px; /* Larger for better touch targets */
    border-radius: 6px;
    margin-bottom: 8px;
  }
  /* Make buttons more tappable */
  button, 
  .filter-btn, 
  .action-btn,
  a[role="button"] {
    min-height: 44px;
    padding: 10px 16px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
    touch-action: manipulation; /* Improves touch responsiveness */
  }
  /* Make table cells more readable */
  .table-responsive td,
  .table-responsive th {
    padding: 12px;
    font-size: 14px;
    white-space: normal;
  }
  /* Improve spacing for cards */
  .dashboard-card {
    padding: 16px;
    margin-bottom: 16px;
    border-radius: 8px;
  }
  /* Improve chart containers */
  .chart-container {
    height: 300px;
    margin-bottom: 16px;
  }
  /* Fix map height for better visibility */
  #contractorMap {
    height: 350px;
  }
}
/* Extra small screens */
@media (max-width: 375px) {
  /* Further adjust spacing */
  .sidebar-search {
    padding: 8px 12px;
    margin: 8px;
  }
  .dashboard-card {
    padding: 12px;
    margin-bottom: 12px;
  }
  /* Smaller font sizes for very small screens */
  body {
    font-size: 14px;
  }
  .table-responsive td,
  .table-responsive th {
    padding: 8px;
    font-size: 12px;
  }
}
/* Search input text color fixes for dark mode */
html.dark .search-input,
html.dark #unifiedSearchInput {
  color: var(--text-primary); /* Uses your dark mode text color variable */
  background-color: var(--surface-level-1); /* Uses your dark mode surface color */
  border-color: var(--border-level-2); /* Uses your dark mode border color */
}
/* Placeholder text color in dark mode */
html.dark .search-input::placeholder,
html.dark #unifiedSearchInput::placeholder {
  color: var(--text-tertiary); /* Use a lighter color for placeholder text */
  opacity: 0.7;
}
/* Active state styling in dark mode */
html.dark .search-input:focus,
html.dark #unifiedSearchInput:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgba(149, 81, 150, 0.2); /* Using your purple accent with transparency */
  outline: none;
}
/* Ensure search icons are visible in dark mode */
html.dark .search-icon,
html.dark .search-clear-btn,
html.dark #clearSearchBtn {
  color: var(--text-secondary);
}
/* Hover state for clear button in dark mode */
html.dark .search-clear-btn:hover,
html.dark #clearSearchBtn:hover {
  color: var(--text-primary);
  background-color: var(--surface-level-2);
}
/* Search suggestions styling in dark mode */
html.dark #unifiedSearchSuggestions,
html.dark .search-suggestions {
  background-color: var(--surface-level-1);
  border-color: var(--border-level-2);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}
html.dark .suggestion-item {
  border-bottom-color: var(--border-level-2);
}
html.dark .suggestion-item:hover {
  background-color: var(--surface-level-2);
}
/* Make sure suggestion text is visible */
html.dark .suggestion-text {
  color: var(--text-primary);
}
html.dark .type-label {
  background-color: var(--surface-level-2);
  color: var(--text-secondary);
}
/* ===== CONSISTENT BUTTON STYLING ACROSS THEMES ===== */

/* Reset All Filters button - this targets the exact ID in your code */
#globalResetBtn {
  background-color: var(--purple) !important; /* Deep purple */
  color: #ffffff !important; /* White text */
  border: none !important;
}

/* LinkedIn Connect button - this targets the specific element in your sidebar */
.connect-card a[href*="linkedin.com"] {
  background-color: var(--purple) !important; /* Deep purple */
  color: #ffffff !important; /* White text */
  border: none !important;
}

/* Hover states (optional but recommended for consistent UX) */
#globalResetBtn:hover,
.connect-card a[href*="linkedin.com"]:hover {
  background-color: var(--navy-purple) !important; /* Slightly darker on hover */
  color: #ffffff !important;
}

/* Ensure these styles apply in both light and dark modes */
html.dark #globalResetBtn,
html:not(.dark) #globalResetBtn,
html.dark .connect-card a[href*="linkedin.com"],
html:not(.dark) .connect-card a[href*="linkedin.com"] {
  background-color: var(--purple) !important;
  color: #ffffff !important;
}
/* ADD this CSS to optimize the title area for mobile */

/* Mobile-specific optimizations for the current view title */
@media (max-width: 767px) {
  /* Make the title section more compact */
  #currentViewTitle {
    padding: 0.75rem !important; /* Reduced from 1rem+ */
  }
  
  /* Significantly smaller title font on mobile */
  #currentFilterDescription {
    font-size: 1.125rem !important; /* Much smaller than 2.5rem */
    line-height: 1.2 !important; /* Tighter line height */
    font-weight: 700 !important; /* Slightly lighter than 900 */
    letter-spacing: -0.01em !important; /* Less dramatic letter spacing */
    margin-bottom: 0.25rem !important; /* Small bottom margin */
  }
  
  /* Adjust the grid layout to give more space to stats */
  #currentViewTitle.lg\\:col-span-2 {
    /* On mobile, make the title take less vertical space */
    min-height: auto !important;
    height: auto !important;
  }
  
  /* Make sure the stats grid is more compact too */
  .stat-card {
    padding: 0.5rem !important; /* Even more compact */
  }
  
  .stat-card .text-2xl {
    font-size: 1rem !important; /* Smaller stat numbers */
    line-height: 1.1 !important;
  }
  
  .stat-card .text-xs {
    font-size: 0.65rem !important; /* Smaller labels */
  }
  
  /* Optional: Make the entire title/stats section shorter */
  .grid.grid-cols-1.lg\\:grid-cols-3.gap-6.mb-6.items-stretch {
    margin-bottom: 1rem !important; /* Less margin below */
    gap: 0.75rem !important; /* Smaller gaps */
  }
}

/* Even more aggressive optimization for very small screens */
@media (max-width: 480px) {
  #currentViewTitle {
    padding: 0.5rem !important;
  }
  
  #currentFilterDescription {
    font-size: 1rem !important; /* Very compact on small screens */
    line-height: 1.15 !important;
  }
  
  .stat-card {
    padding: 0.375rem !important;
  }
  
  .stat-card .text-2xl {
    font-size: 0.875rem !important;
  }
  
  .stat-card .text-xs {
    font-size: 0.6rem !important;
  }
}
.clear-filter-btn {
  width: 20px;
  height: 20px;
  min-width: 20px;
  min-height: 20px;
  border-radius: 50%;
  background-color: var(--surface-level-3);
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  aspect-ratio: 1;
}

.clear-filter-btn:hover {
  background-color: var(--surface-level-2);
}
</style>

</head>
<body>
    <div id="globalProcessingIndicator" class="hidden">
        <div class="global-spinner"></div>
        <span class="text-sm text-[var(--text-secondary)]">Processing...</span>
    </div>
<div class="app-wrapper">
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="dashboardSidebar">
            <!-- Sidebar Header -->
<!-- Sidebar Header -->
<div class="sidebar-header">
    <!-- Logo and Title -->
    <div class="flex flex-col">
        <h1 class="text-xl font-extrabold text-[var(--accent)]" style="letter-spacing: -0.05em;">Subhoo.</h1>
        <p class="text-xs text-[var(--text-secondary)]">Federal Contractor Intelligence</p>
    </div>
    <!-- Icon Controls -->
    <div class="flex items-center space-x-2">
        <!-- Theme Toggle -->
        <button id="themeToggleBtn" title="Toggle Light/Dark Mode" class="p-1.5 rounded-md hover:bg-[var(--surface-level-2)] transition-colors">
            <svg id="themeIconSun" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[var(--text-secondary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
            <svg id="themeIconMoon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[var(--text-secondary)] hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
        </button>
        <!-- Share Link -->
        <button id="shareViewBtn" title="Share Current View" class="p-1.5 rounded-md hover:bg-[var(--surface-level-2)] transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[var(--text-secondary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
            </svg>
        </button>
    </div>
</div>
            <!-- Sidebar Content -->
            <div class="sidebar-content">
<!-- Search Input -->
<div class="sidebar-search mb-4">
  <h3 class="text-md font-bold text-[var(--accent)] mb-2">Search</h3>
  <!-- Enhanced input container -->
  <div class="relative w-full bg-white dark:bg-[var(--surface-level-2)] rounded-lg shadow-sm overflow-hidden border border-[var(--border-level-2)]">
    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[var(--text-tertiary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
    </div>
    <!-- Keep your existing ID for functionality -->
    <input type="text" id="unifiedSearchInput" 
          class="block w-full py-2.5 pl-10 pr-10 text-sm placeholder-[var(--text-tertiary)] bg-transparent border-0 focus:outline-none focus:ring-0" 
          placeholder="Prime, NAICS, Agency..." />
    <!-- Keep your existing clear button -->
    <button id="clearSearchBtn" class="absolute inset-y-0 right-0 pr-3 flex items-center text-[var(--text-tertiary)] hover:text-[var(--text-secondary)]">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>
  <!-- Keep your existing suggestions container -->
  <div id="unifiedSearchSuggestions" class="search-suggestions hidden"></div>
</div>
                <!-- Active Filters -->
                <div id="activeFilterIndicator" class="active-filters hidden">
                    <div class="text-sm font-medium text-[var(--text-secondary)] mb-2">Active Filters:</div>
                </div>
                <!-- Reset Button -->
                <button id="globalResetBtn" class="w-full mb-4 px-4 py-2 bg-[var(--accent)] text-[var(--on-accent)] rounded hover:bg-opacity-90 transition text-sm font-medium">
                    Reset All Filters
                </button>
                <!-- Map Controls -->
                <div class="filter-group">
                    <div class="filter-group-title">
                        <span>Map Controls</span>
                    </div>
                    <button id="resetMapBtn" class="w-full mb-2 px-3 py-1 bg-[var(--surface-level-2)] text-[var(--text-secondary)] rounded hover:bg-[var(--surface-level-3)] transition text-sm">
                        Reset Map View
                    </button>
                </div>
                <!-- Sankey Chart Controls -->
                <div class="filter-group">
                    <div class="filter-group-title">
                        <span>Sankey Chart</span>
                    </div>
                    <button id="resetSankeyBtn" class="w-full mb-2 px-3 py-1 bg-[var(--surface-level-2)] text-[var(--text-secondary)] rounded hover:bg-[var(--surface-level-3)] transition text-sm">
                        Reset Sankey View
                    </button>
                </div>
  <!-- Prime contractors section -->
<div class="mb-3">
  <h3 class="text-sm font-semibold text-[var(--text-secondary)] mb-2">Top Prime Contractors</h3>
  <div class="flex flex-wrap gap-1.5">
    <button onclick="setUnifiedSearchTerm('LOCKHEED MARTIN CORPORATION', 'primeName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">Lockheed</button>
    <button onclick="setUnifiedSearchTerm('RAYTHEON COMPANY', 'primeName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">RTX</button>
    <button onclick="setUnifiedSearchTerm('GENERAL DYNAMICS INFORMATION TECHNOLOGY, INC.', 'primeName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">GDIT</button>
    <button onclick="setUnifiedSearchTerm('NORTHROP GRUMMAN SYSTEMS CORPORATION', 'primeName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">NGC</button>
    <button onclick="setUnifiedSearchTerm('LEIDOS, INC.', 'primeName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">Leidos</button>
    <button onclick="setUnifiedSearchTerm('HUNTINGTON INGALLS INC', 'primeName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">HII</button>
    <button onclick="setUnifiedSearchTerm('BOOZ ALLEN HAMILTON INC.', 'primeName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">BAH</button>
    <button onclick="setUnifiedSearchTerm('SCIENCE APPLICATIONS INTERNATIONAL CORPORATION', 'primeName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">SAIC</button>
    <button onclick="setUnifiedSearchTerm('CACI, INC. - FEDERAL', 'primeName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">CACI</button>
    <button onclick="setUnifiedSearchTerm('PERATON INC.', 'primeName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">Peraton</button>
    <button onclick="setUnifiedSearchTerm('BAE SYSTEMS TECHNOLOGY SOLUTIONS & SERVICES INC.', 'primeName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">BAE</button>
    <button onclick="setUnifiedSearchTerm('ACCENTURE FEDERAL SERVICES LLC', 'primeName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">AFS</button>
    <button onclick="setUnifiedSearchTerm('CGI FEDERAL INC.', 'primeName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">CGI</button>
    <button onclick="setUnifiedSearchTerm('CARAHSOFT TECHNOLOGY CORP.', 'primeName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">Carahsoft</button>
  </div>
</div>
<!-- Agencies section -->
<div>
  <h3 class="text-sm font-semibold text-[var(--text-secondary)] mb-2">Top Agencies</h3>
  <div class="flex flex-wrap gap-1.5">
    <button onclick="setUnifiedSearchTerm('DEPT OF DEFENSE', 'departmentName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">DoD</button>
    <button onclick="setUnifiedSearchTerm('DEPT OF THE ARMY', 'agencyName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">ARMY</button>
    <button onclick="setUnifiedSearchTerm('DEPT OF THE NAVY', 'agencyName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">USN</button>
    <button onclick="setUnifiedSearchTerm('DEPT OF THE AIR FORCE', 'agencyName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">USAF</button>
    <button onclick="setUnifiedSearchTerm('HEALTH AND HUMAN SERVICES, DEPARTMENT OF', 'departmentName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">HHS</button>
    <button onclick="setUnifiedSearchTerm('VETERANS AFFAIRS, DEPARTMENT OF', 'departmentName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">VA</button>
    <button onclick="setUnifiedSearchTerm('HOMELAND SECURITY, DEPARTMENT OF', 'departmentName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">DHS</button>
    <button onclick="setUnifiedSearchTerm('ENERGY, DEPARTMENT OF', 'departmentName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">ENERGY</button>
    <button onclick="setUnifiedSearchTerm('TRANSPORTATION, DEPARTMENT OF', 'departmentName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">DOT</button>
    <button onclick="setUnifiedSearchTerm('JUSTICE, DEPARTMENT OF', 'departmentName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">DOJ</button>
    <button onclick="setUnifiedSearchTerm('FEDERAL BUREAU OF INVESTIGATION', 'agencyName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">FBI</button>
    <button onclick="setUnifiedSearchTerm('TREASURY, DEPARTMENT OF THE', 'departmentName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">TREAS</button>
    <button onclick="setUnifiedSearchTerm('NATIONAL AERONAUTICS AND SPACE ADMINISTRATION', 'departmentName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">NASA</button>
    <button onclick="setUnifiedSearchTerm('GENERAL SERVICES ADMINISTRATION', 'departmentName')" class="text-xs px-3 py-1 bg-[var(--accent-secondary)] text-[var(--accent)] hover:bg-opacity-90 rounded-md transition-colors">GSA</button>
  </div>
</div>
            </div>
<!-- Manual Upload Section (Moved from main content) -->
                <div id="manual-upload-section" class="hidden mb-4 p-3 bg-[var(--surface-level-2)] rounded-lg">
                    <h3 class="text-sm font-semibold text-[var(--text-primary)] mb-2" style="font-weight: var(--header-font-weight);">Manual CSV Upload</h3>
                    <div class="flex flex-col items-start gap-2 mb-2">
                        <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                        <label for="csvFileInput" class="w-full px-3 py-2 bg-[var(--accent)] text-[var(--on-accent)] rounded-md cursor-pointer hover:bg-opacity-90 text-center text-xs" style="font-weight: var(--button-font-weight);">Choose CSV File</label>
                        <span id="file-name-display" class="text-xs text-[var(--text-secondary)] p-2 border border-[var(--border-level-2)] rounded-md w-full truncate">No file selected</span>
                    </div>
                    <div id="errorMessage" class="text-red-600 bg-red-100 dark:bg-red-900 dark:text-red-300 p-2 rounded-md hidden mb-2 text-xs"></div>
                    <div id="successMessage" class="text-green-600 bg-green-100 dark:bg-green-900 dark:text-green-300 p-2 rounded-md hidden mb-2 text-xs"></div>
                </div>
                <!-- S3 Load Error -->
                <div id="s3LoadError" class="text-red-600 bg-red-100 dark:bg-red-900 dark:text-red-300 p-2 rounded-md mb-4 hidden text-xs"></div>
<div class="connect-card mt-4 p-3"> 
  <!-- Content section with floating image -->
  <div class="relative mb-2">
    <!-- Floating image -->
    <img src="markgs.jpg" alt="Mark Profile Picture" class="w-12 h-12 rounded-full object-cover border-2 border-[var(--accent)] shadow-md float-left mr-3 mb-1">
    <!-- Text content that wraps around the image -->
    <p class="text-xs text-[var(--text-secondary)]">
     Hi, I’m Mark. Federal primes with contracts over $750K must create SBA subcontracting plans. Subhoo helps you find those primes, follow the money, and unlock more opportunities. Reach out if I can help.
    </p>
  </div>
  <!-- Action buttons - LinkedIn as primary -->
  <div class="flex w-full space-x-2">
    <a href="https://www.linkedin.com/in/markflournoy/" class="flex-1 px-3 py-1.5 text-center bg-[var(--accent)] text-[var(--on-accent)] rounded hover:bg-opacity-90 transition text-xs font-medium flex items-center justify-center" target="_blank" rel="noopener noreferrer">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="currentColor" viewBox="0 0 24 24">
        <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
      </svg>
      Connect
    </a>
    <a href="mailto:mark@subhoo.com" class="flex-1 px-3 py-1.5 text-center bg-[var(--surface-level-2)] text-[var(--text-secondary)] rounded hover:bg-[var(--surface-level-3)] transition text-xs font-medium flex items-center justify-center">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
      </svg>
      Email
    </a>
  </div>
</div>
<!-- Original footer -->
<div class="sidebar-footer">
  <p class="text-[var(--text-primary)]">© 2025 Subhoo | All data from <a href="https://www.sba.gov" target="_blank" rel="noopener noreferrer" class="text-[var(--text-primary)] hover:underline">SBA.gov</a></p>
</div>
</aside>
        <!-- Main Content -->
        <main class="main-content" id="dashboardMainContent">
            <!-- Main content toggle button - only visible when sidebar is collapsed -->
            <button id="expandSidebarBtn" class="fixed top-4 left-4 z-30 p-2 rounded-md bg-[var(--accent)] text-[var(--on-accent)] shadow-md hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
                </svg>
            </button>
            <!-- KPI STATS SECTION -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6 items-stretch">
              <!-- Title Block: spans 2/3, top-aligned -->
              <div id="currentViewTitle" class="bg-[var(--surface-level-1)] p-4 md:p-6 rounded-lg shadow-md border border-[var(--border-level-1)] h-full lg:col-span-2 flex flex-col justify-start">
                <h1 id="currentFilterDescription" class="text-xl md:text-xl font-bold text-[var(--accent)]">
                  Try Search.
                </h1>
              </div>
              <!-- KPI Block: 1/3 in 2x2 grid -->
              <section id="statisticsSection" class="grid grid-cols-2 gap-4 h-full">
                <div class="stat-card bg-[var(--surface-level-1)] p-3 md:p-4 rounded-lg shadow border border-[var(--border-level-1)]">
                  <div class="text-2xl md:text-3xl font-bold text-[var(--accent)]" id="totalContractsValue">0</div>
                  <div class="text-xs md:text-sm text-[var(--text-secondary)]">Total Contracts</div>
                </div>
                <div class="stat-card bg-[var(--surface-level-1)] p-3 md:p-4 rounded-lg shadow border border-[var(--border-level-1)]">
                  <div class="text-2xl md:text-3xl font-bold text-[var(--accent)]" id="totalValueValue">$0</div>
                  <div class="text-xs md:text-sm text-[var(--text-secondary)]">Total Contract Value</div>
                </div>
                <div class="stat-card bg-[var(--surface-level-1)] p-3 md:p-4 rounded-lg shadow border border-[var(--border-level-1)]">
                  <div class="text-2xl md:text-3xl font-bold text-[var(--accent)]" id="avgContractValue">$0</div>
                  <div class="text-xs md:text-sm text-[var(--text-secondary)]">Average Contract Value</div>
                </div>
                <div class="stat-card bg-[var(--surface-level-1)] p-3 md:p-4 rounded-lg shadow border border-[var(--border-level-1)]">
                  <div class="text-2xl md:text-3xl font-bold text-[var(--accent)]" id="uniquePrimesValue">0</div>
                  <div class="text-xs md:text-sm text-[var(--text-secondary)]">Total Primes</div>
                </div>
              </section>
			  </div>
            <!-- KEY ANALYSIS CHARTS - NEW 3x3 GRID -->
            <section class="mb-6">
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
                <!-- Chart 1: Top Prime Contractors -->
                <div id="primeContractorsChartCard" class="dashboard-card p-4 md:p-6">
                  <div class="flex justify-between items-center mb-3">
                    <h3 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Top Prime Contractors</h3>
                    <span class="text-[var(--text-tertiary)] cursor-help" title="Shows the top 10 prime contractors by total contract value">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </span>
                  </div>
                  <div class="chart-container h-[280px]"><canvas id="primeContractorsChart"></canvas></div>
                </div>
                <!-- Chart 2: Prime Market Share -->
                <div id="marketShareChartCard" class="dashboard-card p-4 md:p-6"> 
                  <div class="flex justify-between items-center mb-3">
                    <h3 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Prime Market Share</h3>
                    <span class="text-[var(--text-tertiary)] cursor-help" title="Market share percentage of prime contractors based on current filters">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </span>
                  </div>
                  <div class="chart-container h-[280px]"><canvas id="marketShareChart"></canvas></div>
                </div>
                <!-- Chart 3: Top NAICS -->
                <div class="dashboard-card p-4 md:p-6">
                  <div class="flex justify-between items-center mb-3">
                    <h3 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Top NAICS</h3>
                    <span class="text-[var(--text-tertiary)] cursor-help" title="Top NAICS codes by total contract value">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </span>
                  </div>
                  <div class="chart-container h-[280px]"><canvas id="naicsChart_main"></canvas></div>
                </div>
                <!-- Chart 4: Dept. Distribution -->
                <div class="dashboard-card p-4 md:p-6">
                  <div class="flex justify-between items-center mb-3">
                    <h3 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Dept. Distribution</h3>
                    <span class="text-[var(--text-tertiary)] cursor-help" title="Distribution of contract value by department">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </span>
                  </div>
                  <div class="chart-container h-[280px]"><canvas id="departmentChart"></canvas></div>
                </div>
                <!-- Chart 5: State Contracts -->
                <div class="dashboard-card p-4 md:p-6"> 
                  <div class="flex justify-between items-center mb-2">
                    <h3 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Contract Values by State</h3>
                    <span class="text-[var(--text-tertiary)] cursor-help" title="Contract distribution by state">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </span>
                  </div>
                  <div class="chart-container h-[280px]"><canvas id="stateContractsChart_main"></canvas></div>
                </div>
                <!-- Chart 6: Contract Timeline -->
                <div class="dashboard-card p-4 md:p-6"> 
                  <div class="flex justify-between items-center mb-3">
                    <h3 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Contract Timeline</h3>
                    <span class="text-[var(--text-tertiary)] cursor-help" title="Timeline of contract starts and endings by year">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </span>
                  </div>
                  <div class="chart-container h-[280px]"><canvas id="timelineChart"></canvas></div>
                </div>
                <!-- Chart 7: Contract Types - HIDDEN -->
                <div class="dashboard-card p-4 md:p-6 hidden">
                  <div class="flex justify-between items-center mb-3">
                    <h3 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Contract Types</h3>
                    <span class="text-[var(--text-tertiary)] cursor-help" title="Distribution of contracts by type">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </span>
                  </div>
                  <div class="chart-container h-[280px]"><canvas id="contractTypeChart_main"></canvas></div>
                </div>
                <!-- Chart 8: Top Agencies - HIDDEN -->
                <div class="dashboard-card p-4 md:p-6 hidden">
                  <div class="flex justify-between items-center mb-3">
                    <h3 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Top Agencies</h3>
                    <span class="text-[var(--text-tertiary)] cursor-help" title="Top contracting agencies by value">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </span>
                  </div>
                  <div class="chart-container h-[280px]"><canvas id="topAgenciesChart"></canvas></div>
                </div>
              </div>
            </section>
			<!-- SPECIALIZED VISUALIZATIONS ROW - Side by Side -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
  <!-- NAICS Specialization Heatmap - 1st column -->
  <div class="dashboard-card p-4 md:p-6">
    <div class="flex justify-between items-center mb-4">
      <div>
        <h3 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">NAICS Specialization Heatmap</h3>
        <p class="text-xs text-[var(--text-secondary)]">Shows which prime contractors specialize in specific NAICS codes</p>
      </div>
    </div>
    <div class="flex justify-center overflow-hidden h-[450px]">
      <div class="overflow-x-auto w-full">
        <svg id="primeSpecializationHeatmap" class="w-full h-[450px]" preserveAspectRatio="xMinYMin meet" viewBox="0 0 900 550"></svg>
      </div>
    </div>
    <p class="text-xs text-[var(--text-tertiary)] mt-2 italic">Click on any cell to see detailed contract information below</p>
  </div>
  <!-- Upcoming Contract Expirations - 2nd column -->
  <div class="dashboard-card p-4 md:p-6">
    <div class="flex justify-between items-center mb-4">
      <div>
        <h3 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Upcoming Contract Expirations</h3>
        <p class="text-xs text-[var(--text-secondary)]">Forecast of contract expirations by month and agency</p>
      </div>
    </div>
    <div class="chart-container h-[450px]">
      <canvas id="contractOpportunityForecastChart"></canvas>
    </div>
    <p class="text-xs text-[var(--text-tertiary)] mt-2 italic">Click on any month to see detailed contract opportunities below</p>
  </div>
</div>
<!-- DETAILS SECTION - Initially hidden, appears when user clicks -->
<div class="mb-6">
  <!-- Specialization Details Section - Initially hidden -->
  <div id="specializationDetailsSection" class="dashboard-card p-4 md:p-6 hidden mb-6">
    <div class="bg-[var(--surface-level-2)] p-4 rounded-md mb-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <p class="text-sm font-semibold">Prime Contractor:</p>
          <p id="specDetailsPrime" class="text-md font-bold text-[var(--accent)]">-</p>
        </div>
        <div>
          <p class="text-sm font-semibold">NAICS:</p>
          <p id="specDetailsNaics" class="text-md">-</p>
        </div>
        <div>
          <p class="text-sm font-semibold">Specialization Index:</p>
          <p id="specDetailsIndex" class="text-md font-bold">-</p>
          <p id="specDetailsIndexNote" class="text-xs text-[var(--text-secondary)]">-</p>
        </div>
        <div>
          <p class="text-sm font-semibold">Total Value:</p>
          <p id="specDetailsTotalValue" class="text-md">-</p>
        </div>
      </div>
    </div>
    <div class="flex justify-between items-center mb-3">
      <h4 class="font-semibold">Contract Details (<span id="specDetailsContractCount">0</span> contracts)</h4>
      <div>
        <button id="filterBySelectionBtn" class="px-3 py-1 bg-[var(--accent)] text-[var(--on-accent)] rounded hover:bg-opacity-90 transition text-xs">
          Filter Dashboard by Selection
        </button>
      </div>
    </div>
    <div class="table-responsive max-h-96 overflow-y-auto">
      <table class="min-w-full divide-y divide-[var(--border-level-1)] text-xs">
        <thead class="bg-[var(--surface-level-2)]">
          <tr>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]">PIID</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]">Agency</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]">Office</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]">Value</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]">Start Date</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]">End Date</th>
          </tr>
        </thead>
        <tbody id="specializationContractsTable" class="bg-[var(--background)] divide-y divide-[var(--border-level-1)]">
          <!-- Table rows will be populated dynamically -->
        </tbody>
      </table>
    </div>
    <!-- Pagination Controls -->
    <div id="specDetailsPagination" class="mt-4 flex justify-between items-center text-xs">
      <button id="prevSpecPageBtn" class="px-3 py-1 bg-[var(--surface-level-2)] text-[var(--text-secondary)] rounded hover:bg-[var(--surface-level-3)] disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
      <span>Page <span id="currentSpecPage">1</span> of <span id="totalSpecPages">1</span></span>
      <button id="nextSpecPageBtn" class="px-3 py-1 bg-[var(--surface-level-2)] text-[var(--text-secondary)] rounded hover:bg-[var(--surface-level-3)] disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
    </div>
  </div>
  <!-- Contract Expiration Details - Initially hidden -->
  <div id="contractExpirationDetails" class="dashboard-card p-4 md:p-6 hidden">
    <h4 id="expirationDetailsTitle" class="text-md font-semibold text-[var(--accent)] mb-3">Contract Expirations for <span id="selectedMonth">Month Year</span></h4>
    <div class="flex justify-between items-center mb-3">
      <div>
        <span class="text-sm text-[var(--text-secondary)]">Total opportunities: <span id="totalOpportunities">0</span></span>
        <span class="text-sm text-[var(--text-secondary)] ml-4">Total value: <span id="totalOpportunitiesValue">$0</span></span>
      </div>
      <div>
        <select id="opportunitySortSelect" class="text-sm border border-[var(--border-level-2)] rounded px-2 py-1 bg-[var(--background)]">
          <option value="value-desc">Sort by Value (High to Low)</option>
          <option value="value-asc">Sort by Value (Low to High)</option>
          <option value="date-asc">Sort by Date (Earliest First)</option>
          <option value="date-desc">Sort by Date (Latest First)</option>
          <option value="prime-asc">Sort by Prime (A-Z)</option>
          <option value="prime-desc">Sort by Prime (Z-A)</option>
        </select>
      </div>
    </div>
    <div class="table-responsive max-h-96 overflow-y-auto">
      <table class="min-w-full divide-y divide-[var(--border-level-1)] text-xs">
        <thead class="bg-[var(--surface-level-2)]">
          <tr>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]">Prime</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]">Agency</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]">Office</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]">PIID</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]">NAICS</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]">NAICS Desc.</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]">Value</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]">End Date</th>
          </tr>
        </thead>
        <tbody id="contractExpirationTableBody" class="bg-[var(--background)] divide-y divide-[var(--border-level-1)]">
          <!-- Table rows will be populated dynamically -->
        </tbody>
      </table>
    </div>
    <!-- Pagination Controls -->
    <div id="opportunityPagination" class="mt-4 flex justify-between items-center text-xs">
      <button id="prevOpportunityPageBtn" class="px-3 py-1 bg-[var(--surface-level-2)] text-[var(--text-secondary)] rounded hover:bg-[var(--surface-level-3)] disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
      <span>Page <span id="currentOpportunityPage">1</span> of <span id="totalOpportunityPages">1</span></span>
      <button id="nextOpportunityPageBtn" class="px-3 py-1 bg-[var(--surface-level-2)] text-[var(--text-secondary)] rounded hover:bg-[var(--surface-level-3)] disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
    </div>
  </div>
</div>
<!-- MAJOR VISUALIZATIONS SECTION - FULL WIDTH ROWS -->
<section class="mb-6">
  <!-- Row 1: Funding Flow -->
  <div class="dashboard-card p-4 md:p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
      <div>
        <h3 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Funding Flow Visualization</h3>
        <p class="text-xs text-[var(--text-secondary)]">Shows top awards by total contract value from agencies to prime contractors</p>
      </div>
    </div>
    <div id="sankeyWrapper" class="w-full rounded-md mt-2">
      <svg id="sankeyChart" class="w-full h-[500px]" viewBox="0 0 1000 600" preserveAspectRatio="xMidYMid meet"></svg>
    </div>
    <p class="text-xs text-[var(--text-tertiary)] mt-2 italic">Click on any node to filter the dashboard by agency or prime</p>
  </div>
  <!-- Row 3: Office-Prime Relationship Network -->
<div class="dashboard-card p-4 md:p-6 mb-6"> <!-- Added mb-6 here -->
  <div class="flex justify-between items-center mb-4">
    <div>
      <h3 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Office-Prime Relationship Network</h3>
      <p class="text-xs text-[var(--text-secondary)]">Visualizes connections between contracting offices and prime contractors</p>
    </div>
  </div>
  <div class="overflow-x-auto">
    <svg id="contractingOfficeRelationshipMap" class="w-full h-[700px]" preserveAspectRatio="xMidYMid meet" viewBox="0 0 900 700"></svg>
  </div>
  <p class="text-xs text-[var(--text-tertiary)] mt-2 italic">Drag nodes to reposition. Click on any node to filter the dashboard.</p>
</div>
  <!-- Row 2: Prime Contractor Map -->
  <div class="dashboard-card p-4 md:p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
      <div>
        <h3 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Prime Contractor Map</h3>
        <p class="text-xs text-[var(--text-secondary)]">Geographic distribution of prime contractors</p>
      </div>
    </div>
    <div id="contractorMap" style="height: 500px; width: 100%;" class="rounded border border-[var(--border-level-2)]"></div>
  </div>
</section>
			        <!-- PRIME PROFILES SECTION -->
            <section id="primeProfilesSection" class="bg-[var(--surface-level-1)] p-4 md:p-6 rounded-lg shadow-md mb-6 border border-[var(--border-level-1)]">
              <h2 class="text-lg md:text-xl font-semibold text-[var(--accent)] mb-4" style="font-weight: var(--header-font-weight);">Prime Contractor Profiles</h2>
              <p class="text-xs md:text-sm text-[var(--text-secondary)] mb-3">Displaying profiles based on current search/filter. Click a prime name to filter the entire dashboard to that prime. Use search to refine this list.</p>
              <div id="primeProfilesContainer" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3 md:gap-4 max-h-[70vh] overflow-y-auto"></div>
            </section>
            <!-- PRIME DETAIL VIEW SECTION -->
            <section id="primeDetailViewSection" class="bg-[var(--surface-level-1)] p-4 md:p-6 rounded-lg shadow-md mb-6 border border-[var(--border-level-1)] hidden">
              <div class="flex justify-between items-center mb-4">
                <h2 id="primeDetailTitle" class="text-xl md:text-2xl font-bold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Prime Contractor Details</h2>
                <button onclick="clearAllFilters()" class="px-3 py-1 bg-[var(--surface-level-2)] text-[var(--text-secondary)] rounded hover:bg-[var(--surface-level-3)] transition">
                  Back to All Primes
                </button>
              </div>
              <div id="primeDetailStats" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 text-sm md:text-base">
              </div>
              <h3 class="text-lg font-semibold text-[var(--text-primary)] mt-6 mb-2" style="font-weight: var(--header-font-weight);">Contracts List for this Prime</h3>
              <div id="primeDetailContractsTableContainer" class="table-responsive max-h-96 overflow-y-auto">
              </div>
            </section>

<!-- Footer as a styled card -->
<footer class="mt-6 mb-6">
  <div class="dashboard-card p-4 md:p-6 rounded-lg shadow-md border border-[var(--border-level-1)] bg-[var(--surface-level-1)]">
    <!-- Shoutouts section -->
    <div class="flex flex-col">
      <h3 class="text-md font-semibold text-[var(--accent)] mb-3 text-center">A few shoutouts!</h3>
      <!-- Mobile-friendly grid layout for shoutouts -->
      <div class="grid grid-cols-2 md:grid-cols-5 gap-3 text-center text-xs">
        <div class="p-2 bg-[var(--surface-level-2)] rounded">
          <span class="block text-[var(--accent)]">So What?!</span>
          <span class="text-[var(--text-secondary)]">@rodstedt</span>
        </div>
		<div class="p-2 bg-[var(--surface-level-2)] rounded">
          <span class="block text-[var(--accent)]">Dark Mode</span>
          <span class="text-[var(--text-secondary)]">@dongkyup</span>
        </div>
        <div class="p-2 bg-[var(--surface-level-2)] rounded">
          <span class="block text-[var(--accent)]">Why?</span>
          <span class="text-[var(--text-secondary)]">@mpben</span>
        </div>
        <div class="p-2 bg-[var(--surface-level-2)] rounded">
          <span class="block text-[var(--accent)]">Think Big</span>
          <span class="text-[var(--text-secondary)]">@ecbrown</span>
        </div>
        <div class="p-2 bg-[var(--surface-level-2)] rounded">
          <span class="block text-[var(--accent)]">Dive Deep</span>
          <span class="text-[var(--text-secondary)]">@datkd</span>
        </div>
      </div>
    </div>
  </div>
</footer>
            <div id="processingIndicator" class="hidden items-center text-[var(--text-secondary)] mt-4">
                <div class="spinner"></div>
                <span class="ml-2 text-sm">Processing data...</span>
            </div>
            <!-- Required containers - Fixed to prevent scrollbar issues -->
            <div id="s3LoadError" class="text-red-600 bg-red-100 dark:bg-red-900 dark:text-red-300 p-3 rounded-md mt-3 hidden text-sm" style="display: none; height: 0; margin: 0; padding: 0; overflow: hidden;"></div>
            <div id="dashboardContent" class="hidden" style="display: none; height: 0; margin: 0; padding: 0; overflow: hidden;"></div>
        </main>
    </div>
    <!-- Modals and Tooltips -->
    <div id="genericModal" class="modal-backdrop hidden">
        <div id="genericModalContent" class="modal-content">
            <button id="genericModalCloseBtn" class="modal-close-btn">&times;</button>
            <h2 id="genericModalTitle" class="text-xl font-semibold text-[var(--accent)] mb-4" style="font-weight: var(--header-font-weight);">Modal Title</h2>
            <div id="genericModalBody" class="text-[var(--text-secondary)]">
            </div>
        </div>    
    </div>
    <div class="event-tooltip"></div>
    <div id="shareToast" class="fixed bottom-5 right-5 bg-[var(--accent)] text-[var(--on-accent)] py-2 px-4 rounded-md shadow-lg hidden transition-opacity duration-300">
        Link copied to clipboard!
    </div>
    <div id="page-loader" class="fixed inset-0 z-50 flex items-center justify-center bg-[var(--background)]">
      <div class="flex flex-col items-center">
        <div class="spinner w-16 h-16 border-4 border-[var(--border-level-2)] border-t-[var(--accent)] rounded-full animate-spin"></div>
        <p class="mt-4 text-[var(--text-primary)]">Loading Subhoo...</p>
        <div class="hidden mt-4 p-3 bg-[var(--accent-secondary)] rounded-md text-sm" id="loader-timeout-message">
          <p class="text-[var(--text-secondary)]">Loading is taking longer than expected.</p>
          <p class="text-[var(--text-secondary)]">If you're testing locally, you'll need to upload a CSV.</p>
          <button onclick="forceShowManualUpload()" class="mt-2 px-3 py-1 bg-[var(--accent)] text-[var(--on-accent)] rounded text-sm">
            Show Upload Option
          </button>
        </div>
      </div>
    </div>
</div>
</body>
<script>
const processingIndicator=document.getElementById("processingIndicator"),manualUploadSection=document.getElementById("manual-upload-section"),dashboardContent=document.getElementById("dashboardContent"),csvFileInput=document.getElementById("csvFileInput"),fileNameDisplay=document.getElementById("file-name-display"),errorMessageDiv=document.getElementById("errorMessage"),successMessageDiv=document.getElementById("successMessage"),s3LoadErrorDiv=document.getElementById("s3LoadError"),unifiedSearchInput=document.getElementById("unifiedSearchInput"),unifiedSearchSuggestions=document.getElementById("unifiedSearchSuggestions"),activeFilterIndicator=document.getElementById("activeFilterIndicator"),primeProfilesContainer=document.getElementById("primeProfilesContainer"),primeProfilesSearchInput=document.getElementById("primeProfilesSearchInput"),globalTooltipEl=document.querySelector(".event-tooltip"),genericModal=document.getElementById("genericModal"),genericModalContent=document.getElementById("genericModalContent"),genericModalTitle=document.getElementById("genericModalTitle"),genericModalBody=document.getElementById("genericModalBody"),genericModalCloseBtn=document.getElementById("genericModalCloseBtn"),primeDetailViewSection=document.getElementById("primeDetailViewSection"),primeDetailTitle=document.getElementById("primeDetailTitle"),primeDetailStats=document.getElementById("primeDetailStats"),primeDetailContractsTableContainer=document.getElementById("primeDetailContractsTableContainer"),themeToggleBtn=document.getElementById("themeToggleBtn"),themeIconSun=document.getElementById("themeIconSun"),themeIconMoon=document.getElementById("themeIconMoon"),shareViewBtn=document.getElementById("shareViewBtn"),shareToast=document.getElementById("shareToast");function generateWelcomeTitle(e){const t=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][(new Date).getDay()],a=e.length,r=new Set(e.map((e=>e["Legal Business Name"])).filter(Boolean)).size,n=a.toLocaleString(),o=r.toLocaleString(),i=[`Happy ${t}! Welcome to Subhoo.`,`It's ${t}! Ready to explore federal contracts?`,`Yep, it's ${t}!`,`${t}'s a great day for contract intelligence!`],s=[`Search and click to analyze over ${n} contracts across ${o} Federal Prime Contractors.`,`Explore ${n} contracts and ${o} Prime Contractors with required subcontracting plans.`,`Discover subcontracting opportunities among ${o} primes with ${n} active federal contracts.`];return`<span class="greeting">${i[Math.floor(Math.random()*i.length)]}</span> <span class="description">${s[Math.floor(Math.random()*s.length)]}</span>`}function updateDashboardTitle(e,t=!1){const a=document.getElementById("currentFilterDescription"),r=document.getElementById("currentViewTitle");a&&r&&(t||!e||""===e.trim()?(a.innerHTML=generateWelcomeTitle(parsedData),a.classList.add("welcome-title"),r.classList.remove("title-container-default"),r.classList.add("title-container-welcome")):(a.innerHTML=e,a.classList.remove("welcome-title"),r.classList.remove("title-container-welcome"),r.classList.add("title-container-default")))}let parsedData=[];const charts={},S3_CSV_URL="https://subhoodata.s3.us-east-1.amazonaws.com/data/sba24.csv";let currentMainStateChartFilter="value";const ITEMS_PER_PAGE_MODAL_TABLE=10;let contractorMap,contractorClusterGroup,currentPrimeDetailViewPage=1,isViewingSpecificPrime=!1,specificPrimeName=null,currentPrimeDetailSort={column:"endDate",order:"desc"},currentFilterState={searchTerm:"",expandedTerm:"",filterType:null,filterValue:null,resultCount:0,isActive:!1};function formatCurrency(e){if(isNaN(parseFloat(e)))return"$0";const t=parseFloat(e);return Math.abs(t)>=1e9?"$"+(t/1e9).toFixed(1)+"B":Math.abs(t)>=1e6?"$"+(t/1e6).toFixed(1)+"M":Math.abs(t)>=1e3?"$"+(t/1e3).toFixed(1)+"K":new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(t)}function parseCurrencyValue(e){return e&&parseFloat(String(e).replace(/[$,\s]/g,""))||0}function formatDate(e){if(!e)return"";const t=new Date(e);return isNaN(t.getTime())?"":new Intl.DateTimeFormat("en-US",{year:"numeric",month:"short",day:"numeric"}).format(t)}function createAwardLink(e){if(!e||"string"!=typeof e||""===e.trim()||"n/a"===e.toLowerCase())return e||"N/A";return`<a href="https://www.fpds.gov/ezsearch/fpdsportal?indexName=awardfull&templateName=1.5.3&s=FPDS&q=${encodeURIComponent(e.trim())}&x=18&y=15" target="_blank" rel="noopener noreferrer" class="text-[var(--accent)] hover:underline">${e}</a>`}function createEntityLink(e,t){if(!e||"string"!=typeof e||""===e.trim()||"n/a"===e.toLowerCase())return t||e||"N/A";return`<a href="https://www.fpds.gov/ezsearch/fpdsportal?s=FPDS&q=${encodeURIComponent(e.trim())}&x=0&y=0" target="_blank" rel="noopener noreferrer" class="text-[var(--accent)] hover:underline">${t||e}</a>`}function showProcessingBriefly(){processingIndicator.classList.remove("hidden"),processingIndicator.classList.add("flex")}function hideProcessing(){processingIndicator.classList.add("hidden"),processingIndicator.classList.remove("flex")}function showErrorMessage(e,t=!1){t?(manualUploadSection.classList.remove("hidden"),s3LoadErrorDiv.textContent=`S3 Auto-load failed: ${e}. Please use manual upload option above.`,s3LoadErrorDiv.classList.remove("hidden")):(errorMessageDiv.textContent=e,errorMessageDiv.classList.remove("hidden"),successMessageDiv.classList.add("hidden")),hideProcessing()}function showSuccessMessage(e,t=!1){t?(s3LoadErrorDiv.classList.add("hidden"),manualUploadSection&&(manualUploadSection.classList.add("hidden"),manualUploadSection.style.display="none")):(successMessageDiv.textContent=e,successMessageDiv.classList.remove("hidden"),errorMessageDiv.classList.add("hidden")),hideProcessing()}function cleanupCharts(){Object.keys(charts).forEach((e=>{charts[e]&&(charts[e].destroy(),charts[e]=null)}))}function processAndInitialize(e){try{if(!e||0===e.length)return void showErrorMessage("No data to display. Please try manual upload or check the S3 source.",!0);parsedData=e,activeFilterIndicator.classList.add("hidden"),manualUploadSection&&(manualUploadSection.classList.add("hidden"),manualUploadSection.style.display="none"),s3LoadErrorDiv.classList.add("hidden"),primeDetailViewSection.classList.add("hidden"),dashboardContent.classList.remove("hidden"),dashboardContent.classList.add("data-loaded");const t=document.getElementById("page-loader");t&&(t.style.opacity="0",t.style.pointerEvents="none",setTimeout((function(){t.style.display="none"}),300)),updateDashboardTitle("",!0),getChartColors(),cleanupCharts(),initializeChartDefaults(),initializeCoreVisuals(parsedData),setupUnifiedSearch(),initializePrimeProfilesSection(parsedData),initializeContractorMap(e),showSuccessMessage("Data loaded and dashboard initialized.",!0),applyInitialTheme(),setTimeout((()=>{processURLParameters()||console.log("No URL filters applied, showing default view")}),100)}catch(e){console.error("Error during processAndInitialize:",e),showErrorMessage("An error occurred while initializing the dashboard. Please try refreshing.",!1)}finally{hideProcessing()}}function processURLParameters(){console.log("Checking URL for filters...");const e=new URLSearchParams(window.location.search),t=e.get("search"),a=e.get("filterType"),r=e.get("filterValue");if(console.log("URL params found:",{searchParam:t,filterTypeParam:a,filterValueParam:r}),!parsedData||0===parsedData.length)return console.log("No data available for URL filtering"),!1;if(a&&r){const e=decodeURIComponent(r.replace(/\+/g," "));return console.log("Applying filterType:",a,"with value:",e),unifiedSearchInput&&(unifiedSearchInput.value=e),applyFilter(e,a,e),!0}if(t){const e=decodeURIComponent(t.replace(/\+/g," "));return console.log("Applying search with term:",e),unifiedSearchInput&&(unifiedSearchInput.value=e),applyFilter(e),!0}return console.log("No URL parameters to apply"),!1}function loadDataFromS3(){showProcessingBriefly();const e=new Promise(((e,t)=>{setTimeout((()=>t(new Error("Request timed out"))),2e4)}));window.s3LoadingComplete=!1,Promise.race([fetch(S3_CSV_URL,{mode:"cors",cache:"no-cache",headers:{Accept:"text/csv"}}),e]).then((e=>{if(!e.ok){let t=`HTTP error ${e.status}`;throw 0===e.status?t="Network error or CORS issue.":403===e.status?t="Access Forbidden (403).":404===e.status&&(t="File Not Found (404)."),new Error(`S3 Load Error: ${t}`)}return e.text()})).then((e=>{if(!e||""===e.trim())return window.s3LoadingComplete=!0,void showErrorMessage("S3 file is empty.",!0);Papa.parse(e,{header:!0,dynamicTyping:!0,skipEmptyLines:!0,complete:e=>{window.s3LoadingComplete=!0,e.errors&&e.errors.length>0?showErrorMessage("Error parsing CSV from S3: "+e.errors[0].message,!0):e.data&&e.data.length>0?processAndInitialize(e.data):showErrorMessage("No data parsed from S3 file.",!0)},error:e=>{window.s3LoadingComplete=!0,showErrorMessage("Error parsing CSV data from S3: "+e.message,!0)}})})).catch((e=>{window.s3LoadingComplete=!0;let t=e.message;!1!==navigator.onLine||t.includes("offline")||(t+=" You may also be offline."),showErrorMessage(t,!0)})),setTimeout((()=>{window.s3LoadingComplete||(window.s3LoadingComplete=!0,showErrorMessage("S3 loading timed out. Please use manual upload.",!0),manualUploadSection.classList.add("timeout-show"))}),12e3)}function initializeChartDefaults(){Chart.defaults.interaction={mode:"nearest",intersect:!1,axis:"xy"};const e=window.innerWidth<768;Chart.defaults.font.size=e?10:12,Chart.defaults.plugins.tooltip.enabled=!0,Chart.defaults.plugins.tooltip.displayColors=!0,Chart.defaults.responsive=!0,Chart.defaults.maintainAspectRatio=!1}function initializeContractorMap(e){const t=["#213a45","#5e6276","#856c85","#b38595","#d99184","#ccb9b3"];contractorMap||(contractorMap=L.map("contractorMap").setView([39.8283,-98.5795],3),L.tileLayer("https://api.maptiler.com/maps/openstreetmap/{z}/{x}/{y}.jpg?key=6aiOr0BMGcTLjUNBbDsy",{attribution:'&copy; <a href="https://www.maptiler.com/">MapTiler</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',tileSize:512,zoomOffset:-1,maxZoom:18}).addTo(contractorMap)),contractorClusterGroup?contractorClusterGroup.clearLayers():(contractorClusterGroup=L.markerClusterGroup({maxClusterRadius:40,disableClusteringAtZoom:10,iconCreateFunction:function(e){const a=e.getChildCount();let r="small",n=t[1];return a>100?(r="large",n=t[0]):a>20&&(r="medium",n=t[2]),new L.DivIcon({html:`<div class="cluster-icon ${r}" style="background-color: ${n};">${a}</div>`,className:"custom-cluster",iconSize:[30,30]})}}),contractorMap.addLayer(contractorClusterGroup));const a=new Set;(window.innerWidth<768&&e.length>500?e.slice(0,500):e).forEach((e=>{const t=e.Location;if(!t||!e["Legal Business Name"])return;const[r,n]=t.split(",").map((e=>e.trim())),o=parseFloat(r),i=parseFloat(n);if(isNaN(o)||isNaN(i)||0===o||0===i)return;const s=`${o.toFixed(4)}|${i.toFixed(4)}`;if(a.has(s))return;a.add(s);const c=e["Legal Business Name"],l=e["Vendor Address City"]||"",d=e["Vendor Address State"]||"",p=l&&d?`${l}, ${d}`:"",u=`<strong>${c}</strong>${p?`<br>${p}`:""}`;let m=0;e["Base and All Options Value (Total Contract Value)"]&&(m=parseCurrencyValue(e["Base and All Options Value (Total Contract Value)"]));const g=createStyledMarker(o,i,c,m);g.bindPopup(u),contractorClusterGroup.addLayer(g)})),contractorClusterGroup&&contractorClusterGroup.getLayers().length>0&&contractorMap.fitBounds(contractorClusterGroup.getBounds(),{padding:[30,30],maxZoom:3}),setTimeout((()=>{contractorMap.invalidateSize()}),200)}function createStyledMarker(e,t,a,r){const n=`<div class="custom-marker" title="${a}" style="background-color: ${getMarkerColor(r)};"></div>`;return L.marker([e,t],{icon:L.divIcon({className:"",html:n,iconSize:[12,12],iconAnchor:[6,6]})})}function getMarkerColor(e){return e>1e9?"#003f5c":e>5e8?"#444e86":e>1e8?"#955196":e>5e7?"#dd5182":e>1e7?"#ff6e54":"#ffa600"}function parseCurrencyValue(e){return e?"number"==typeof e?e:parseFloat(e.toString().replace(/[$,]/g,""))||0:0}function applyFilter(e,t=null,a=null){try{let r;currentFilterState={searchTerm:e||"",expandedTerm:expandAcronyms(e||""),filterType:t,filterValue:a,resultCount:0,isActive:!0};let n=e;const o=document.getElementById("marketShareChartCard"),i=document.getElementById("primeContractorsChartCard"),s=document.querySelector(".grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-3.gap-4.md\\:gap-6");if("primeName"===t){isViewingSpecificPrime=!0,specificPrimeName=a||e;const t=specificPrimeName;if(r=parsedData.filter((e=>(e["Legal Business Name"]?.toLowerCase()||"")===t.toLowerCase())),n=`Prime: ${t}`,renderPrimeDetailView(t,r),updateDashboardTitle(`Viewing contracts for ${t}`),o&&o.classList.add("hidden"),i&&i.classList.add("hidden"),s){s.classList.remove("lg:grid-cols-3"),s.classList.add("lg:grid-cols-2");Array.from(s.children).filter((e=>!e.classList.contains("hidden"))).forEach(((e,t)=>{e.style.order=t}))}}else if(t){isViewingSpecificPrime=!1,specificPrimeName=null,primeDetailViewSection.classList.add("hidden"),o&&o.classList.remove("hidden"),i&&i.classList.remove("hidden"),s&&(s.classList.remove("lg:grid-cols-2"),s.classList.add("lg:grid-cols-3"),Array.from(s.children).forEach((e=>{e.style.order=""})));const c=(a||e).toLowerCase();r="naicsDesc"===t?parsedData.filter((e=>(e["NAICS Description"]||"").toLowerCase().includes(c))):parsedData.filter((e=>{let r="";switch(t){case"naicsCode":r=String(e["NAICS Code"]||"").toLowerCase();break;case"departmentName":r=e["Contracting Department Name"]?.toLowerCase()||"";break;case"agencyName":r=e["Contracting Agency Name"]?.toLowerCase()||"";break;case"officeName":r=e["Contracting Office Name"]?.toLowerCase()||"";break;case"stateCode":r=e["Principal Place of Performance State Code"]?.toLowerCase()||"";break;case"contractType":r=e["Award or Indefinite Delivery Vehicle Type"]?.toLowerCase()||"";break;default:return!1}return a?r===c:r.includes(c)}));let l="";switch(t){case"naicsCode":l="NAICS Code";break;case"naicsDesc":l="NAICS Keyword";break;case"departmentName":l="Department";break;case"agencyName":l="Agency";break;case"officeName":l="Office";break;case"stateCode":l="State";break;case"contractType":l="Contract Type";break;default:l=t.replace(/([A-Z])/g," $1").replace(/^./,(e=>e.toUpperCase()))}n=`${l}: ${a||e}`,updateDashboardTitle(`Filtered by ${n} (${r.length.toLocaleString()} results)`)}else{if(isViewingSpecificPrime=!1,specificPrimeName=null,primeDetailViewSection.classList.add("hidden"),o&&o.classList.remove("hidden"),i&&i.classList.remove("hidden"),s&&(s.classList.remove("lg:grid-cols-2"),s.classList.add("lg:grid-cols-3"),Array.from(s.children).forEach((e=>{e.style.order=""}))),!e||""===e.trim())return void clearAllFilters();console.log("=== APPLYING GENERAL SEARCH ==="),console.log("Original search term:",e);const t=e.toLowerCase().split(/\s+/).filter((e=>e.length>=1));if(console.log("Original words:",t),r=parsedData.filter((e=>t.every((t=>{const a=e["Legal Business Name"]?.toLowerCase()||"",r=String(e["NAICS Code"]||"").toLowerCase(),n=e["NAICS Description"]?.toLowerCase()||"",o=e["Contracting Department Name"]?.toLowerCase()||"",i=e["Contracting Agency Name"]?.toLowerCase()||"",s=e["Contracting Office Name"]?.toLowerCase()||"",c=e["Principal Place of Performance State Code"]?.toLowerCase()||"",l=e["Vendor Address City"]?.toLowerCase()||"";return a.includes(t)||r.includes(t)||n.includes(t)||o.includes(t)||i.includes(t)||s.includes(t)||l.includes(t)||2===t.length&&c===t||t.length>2&&c.includes(t)})))),console.log("Results with original words (ALL must match):",r.length),0===r.length){console.log("No results with original words, trying with acronym expansion...");const e=t.map((e=>{const t=expandAcronyms(e);return t!==e?t.toLowerCase():e}));console.log("Expanded words:",e),r=parsedData.filter((t=>e.every((e=>{const a=`${t["Legal Business Name"]?.toLowerCase()||""} ${String(t["NAICS Code"]||"").toLowerCase()} ${t["NAICS Description"]?.toLowerCase()||""} ${t["Contracting Department Name"]?.toLowerCase()||""} ${t["Contracting Agency Name"]?.toLowerCase()||""} ${t["Contracting Office Name"]?.toLowerCase()||""} ${t["Principal Place of Performance State Code"]?.toLowerCase()||""} ${t["Vendor Address City"]?.toLowerCase()||""}`;return e.includes(" "),a.includes(e)})))),console.log("Results with acronym expansion:",r.length)}0===r.length&&(console.log("No results with expansion, trying flexible OR matching..."),r=parsedData.filter((e=>t.some((t=>{const a=e["Legal Business Name"]?.toLowerCase()||"",r=String(e["NAICS Code"]||"").toLowerCase(),n=e["NAICS Description"]?.toLowerCase()||"",o=e["Contracting Department Name"]?.toLowerCase()||"",i=e["Contracting Agency Name"]?.toLowerCase()||"",s=e["Contracting Office Name"]?.toLowerCase()||"",c=e["Principal Place of Performance State Code"]?.toLowerCase()||"",l=e["Vendor Address City"]?.toLowerCase()||"";return a.includes(t)||r.includes(t)||n.includes(t)||o.includes(t)||i.includes(t)||s.includes(t)||l.includes(t)||2===t.length&&c===t||t.length>2&&c.includes(t)})))),console.log("Results with flexible OR matching:",r.length));updateDashboardTitle(`Search results for ${`"${e}"`} (${r.length.toLocaleString()} results)`),console.log("=== END GENERAL SEARCH ===")}console.log(`Filter applied: ${r.length} results found`),initializeCoreVisuals(r,isViewingSpecificPrime),initializePrimeProfilesSection(r),initializeContractorMap(r),renderSankeyChart(r),createPrimeSpecializationHeatmap(r),createContractingOfficeRelationshipMap(r),createContractOpportunityForecast(r),updateActiveFilterIndicator(n,r.length),unifiedSearchSuggestions.innerHTML="",unifiedSearchSuggestions.classList.add("hidden"),currentFilterState.resultCount=r?r.length:0}catch(e){console.error("Error during filter application:",e)}}function recreateChartCanvas(e){let t;if(charts[e]&&charts[e].canvas&&charts[e].canvas.parentElement)t=charts[e].canvas.parentElement;else if(t=document.getElementById(e)?.parentElement,!t){const a=document.querySelectorAll(".chart-container");for(const r of a)if(r.querySelector(".chart-no-data")){t=r,console.log(`Found container with "no data" message that might be for ${e}`);break}}if(!t&&"contractOpportunityForecastChart"===e){const e=document.querySelector('.dashboard-card:has(.chart-container:has(.chart-no-data), h3:contains("Upcoming Contract Expirations"))');e&&(t=e.querySelector(".chart-container"),console.log("Found opportunity chart container through card heading"))}if(!t)return console.error(`Container for ${e} not found using any method`),!1;charts[e]&&(charts[e].destroy(),charts[e]=null),t.innerHTML="";const a=document.createElement("canvas");return a.id=e,t.appendChild(a),console.log(`Canvas ${e} recreated successfully`),!0}function clearAllFilters(){currentFilterState={searchTerm:"",expandedTerm:"",filterType:null,filterValue:null,resultCount:0,isActive:!1};try{if(console.log("Starting filter reset process"),unifiedSearchInput.value="",activeFilterIndicator.classList.add("hidden"),unifiedSearchSuggestions.innerHTML="",unifiedSearchSuggestions.classList.add("hidden"),updateDashboardTitle("",!0),primeDetailViewSection.classList.add("hidden"),isViewingSpecificPrime=!1,specificPrimeName=null,"function"==typeof closeAllDetailSections)closeAllDetailSections();else{const e=document.getElementById("specializationDetailsSection");e&&e.classList.add("hidden");const t=document.getElementById("contractExpirationDetails");t&&t.classList.add("hidden")}currentSpecializationData={prime:null,naics:null,naicsDescription:null,specializationIndex:0,totalValue:0,contracts:[]},currentSpecPage=1,currentOpportunityData=[],currentOpportunityPage=1,currentPrimeDetailViewPage=1,currentPrimeDetailSort={column:"endDate",order:"desc"};const e=document.getElementById("marketShareChartCard"),t=document.getElementById("primeContractorsChartCard");e&&e.classList.remove("hidden"),t&&t.classList.remove("hidden");const a=document.querySelector(".grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-3.gap-4.md\\:gap-6, .grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-2.gap-4.md\\:gap-6");if(a){a.classList.remove("lg:grid-cols-2"),a.classList.add("lg:grid-cols-3");a.querySelectorAll(".dashboard-card").forEach((e=>{e.style.order=""}))}updateDashboardTitle("",!0),void 0!==relationshipMapSimulation&&relationshipMapSimulation&&(relationshipMapSimulation.stop(),relationshipMapSimulation=null),d3.select("#contractingOfficeRelationshipMap").selectAll("*").remove(),d3.select("#sankeyChart").selectAll("*").remove(),d3.select("#primeSpecializationHeatmap").selectAll("*").remove(),d3.selectAll(".d3-relationship-tooltip").remove(),d3.selectAll(".heatmap-tooltip").remove(),Object.keys(charts).forEach((e=>{charts[e]&&(charts[e].destroy(),charts[e]=null)})),contractorMap&&contractorMap.setView([39.8283,-98.5795],3),console.log("Recreating chart canvases");["primeContractorsChart","marketShareChart","naicsChart_main","stateContractsChart_main","departmentChart","timelineChart","contractTypeChart_main","topAgenciesChart","contractOpportunityForecastChart"].forEach((e=>{recreateChartCanvas(e)})),console.log("All chart canvases recreated, now initializing visualizations"),initializeCoreVisuals(parsedData,!1),initializePrimeProfilesSection(parsedData),initializeContractorMap(parsedData),renderSankeyChart(parsedData),createPrimeSpecializationHeatmap(parsedData),createContractingOfficeRelationshipMap(parsedData);document.getElementById("contractOpportunityForecastChart")||(console.log("Opportunity forecast canvas not found, attempting to recreate"),recreateChartCanvas("contractOpportunityForecastChart")),console.log("Scheduling opportunity forecast chart creation"),setTimeout((()=>{document.getElementById("contractOpportunityForecastChart")?(console.log("Creating opportunity forecast chart"),createContractOpportunityForecast(parsedData)):(console.error("Opportunity forecast canvas not found after timeout"),recreateChartCanvas("contractOpportunityForecastChart"),setTimeout((()=>{document.getElementById("contractOpportunityForecastChart")?(console.log("Final attempt to create opportunity forecast chart"),createContractOpportunityForecast(parsedData)):console.error("Opportunity forecast canvas not found after final attempt")}),500))}),300),setTimeout((()=>{window.dispatchEvent(new Event("resize"))}),100),console.log("All filters and visualizations reset complete")}catch(e){console.error("Error during clearing filters:",e)}}function updateActiveFilterIndicator(e,t){const a=document.getElementById("activeFilterIndicator");e&&""!==e.trim()?(a.innerHTML=`\n          <div class="text-sm font-medium text-[var(--text-secondary)] mb-2">Active Filters:</div>\n          <div class="active-filter-tag">\n            <span>${e}</span>\n            <button onclick="clearAllFilters()" class="clear-filter-btn" type="button">\n              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />\n              </svg>\n            </button>\n          </div>\n          <div class="text-xs text-[var(--text-secondary)]">${t.toLocaleString()} results</div>\n        `,a.classList.remove("hidden")):(a.classList.add("hidden"),updateDashboardTitle("",!0))}function selectSearchSuggestion(e,t,a){unifiedSearchInput.value=a,applyFilter(a,t,a),unifiedSearchSuggestions.innerHTML="",unifiedSearchSuggestions.classList.add("hidden")}const AGENCY_ACRONYM_MAP={dod:"DEPT OF DEFENSE",defense:"DEPT OF DEFENSE",army:"DEPT OF THE ARMY",navy:"DEPT OF THE NAVY",usn:"DEPT OF THE NAVY",airforce:"DEPT OF THE AIR FORCE",usaf:"DEPT OF THE AIR FORCE","air force":"DEPT OF THE AIR FORCE",spaceforce:"DEPT OF THE AIR FORCE",ussf:"DEPT OF THE AIR FORCE",doj:"JUSTICE, DEPARTMENT OF",justice:"JUSTICE, DEPARTMENT OF",fbi:"FEDERAL BUREAU OF INVESTIGATION",dea:"DRUG ENFORCEMENT ADMINISTRATION",atf:"BUREAU OF ALCOHOL, TOBACCO, FIREARMS AND EXPLOSIVES",bop:"FEDERAL BUREAU OF PRISONS",usms:"U.S. MARSHALS SERVICE",marshals:"U.S. MARSHALS SERVICE",dhs:"HOMELAND SECURITY, DEPARTMENT OF",homeland:"HOMELAND SECURITY, DEPARTMENT OF",tsa:"TRANSPORTATION SECURITY ADMINISTRATION",ice:"U.S. IMMIGRATION AND CUSTOMS ENFORCEMENT",cbp:"U.S. CUSTOMS AND BORDER PROTECTION",customs:"U.S. CUSTOMS AND BORDER PROTECTION","border patrol":"U.S. CUSTOMS AND BORDER PROTECTION",uscg:"U.S. COAST GUARD","coast guard":"U.S. COAST GUARD",fema:"FEDERAL EMERGENCY MANAGEMENT AGENCY","secret service":"U.S. SECRET SERVICE",usss:"U.S. SECRET SERVICE",hhs:"HEALTH AND HUMAN SERVICES, DEPARTMENT OF",health:"HEALTH AND HUMAN SERVICES, DEPARTMENT OF",cdc:"CENTERS FOR DISEASE CONTROL AND PREVENTION",fda:"FOOD AND DRUG ADMINISTRATION",nih:"NATIONAL INSTITUTES OF HEALTH",cms:"CENTERS FOR MEDICARE & MEDICAID SERVICES",va:"VETERANS AFFAIRS, DEPARTMENT OF",veterans:"VETERANS AFFAIRS, DEPARTMENT OF",dva:"VETERANS AFFAIRS, DEPARTMENT OF",dot:"TRANSPORTATION, DEPARTMENT OF",transportation:"TRANSPORTATION, DEPARTMENT OF",faa:"FEDERAL AVIATION ADMINISTRATION",aviation:"FEDERAL AVIATION ADMINISTRATION",fhwa:"FEDERAL HIGHWAY ADMINISTRATION",nhtsa:"NATIONAL HIGHWAY TRAFFIC SAFETY ADMINISTRATION",fra:"FEDERAL RAILROAD ADMINISTRATION",treasury:"TREASURY, DEPARTMENT OF THE",tres:"TREASURY, DEPARTMENT OF THE",irs:"INTERNAL REVENUE SERVICE",doe:"ENERGY, DEPARTMENT OF",energy:"ENERGY, DEPARTMENT OF",usda:"AGRICULTURE, DEPARTMENT OF",agriculture:"AGRICULTURE, DEPARTMENT OF",fsis:"FOOD SAFETY AND INSPECTION SERVICE","forest service":"FOREST SERVICE",doi:"INTERIOR, DEPARTMENT OF THE",interior:"INTERIOR, DEPARTMENT OF THE",nps:"NATIONAL PARK SERVICE",parks:"NATIONAL PARK SERVICE",usgs:"U.S. GEOLOGICAL SURVEY",blm:"BUREAU OF LAND MANAGEMENT",doc:"COMMERCE, DEPARTMENT OF",commerce:"COMMERCE, DEPARTMENT OF",noaa:"NATIONAL OCEANIC AND ATMOSPHERIC ADMINISTRATION",weather:"NATIONAL OCEANIC AND ATMOSPHERIC ADMINISTRATION",census:"BUREAU OF THE CENSUS",nist:"NATIONAL INSTITUTE OF STANDARDS AND TECHNOLOGY",dol:"LABOR, DEPARTMENT OF",labor:"LABOR, DEPARTMENT OF",osha:"OCCUPATIONAL SAFETY AND HEALTH ADMINISTRATION",ed:"EDUCATION, DEPARTMENT OF",education:"EDUCATION, DEPARTMENT OF",hud:"HOUSING AND URBAN DEVELOPMENT, DEPARTMENT OF",housing:"HOUSING AND URBAN DEVELOPMENT, DEPARTMENT OF",state:"STATE, DEPARTMENT OF",dos:"STATE, DEPARTMENT OF",nasa:"NATIONAL AERONAUTICS AND SPACE ADMINISTRATION",space:"NATIONAL AERONAUTICS AND SPACE ADMINISTRATION",epa:"ENVIRONMENTAL PROTECTION AGENCY",environment:"ENVIRONMENTAL PROTECTION AGENCY",gsa:"GENERAL SERVICES ADMINISTRATION",sba:"SMALL BUSINESS ADMINISTRATION","small business":"SMALL BUSINESS ADMINISTRATION",ssa:"SOCIAL SECURITY ADMINISTRATION","social security":"SOCIAL SECURITY ADMINISTRATION",usps:"U.S. POSTAL SERVICE",postal:"U.S. POSTAL SERVICE","post office":"U.S. POSTAL SERVICE",cia:"CENTRAL INTELLIGENCE AGENCY",nsa:"NATIONAL SECURITY AGENCY",dni:"OFFICE OF THE DIRECTOR OF NATIONAL INTELLIGENCE",sec:"SECURITIES AND EXCHANGE COMMISSION",fdic:"FEDERAL DEPOSIT INSURANCE CORPORATION",fed:"FEDERAL RESERVE SYSTEM","federal reserve":"FEDERAL RESERVE SYSTEM",fcc:"FEDERAL COMMUNICATIONS COMMISSION",ftc:"FEDERAL TRADE COMMISSION",nlrb:"NATIONAL LABOR RELATIONS BOARD"};function expandAcronyms(e){const t=e.toLowerCase().trim(),a=t.split(/\s+/);if(1===a.length)return AGENCY_ACRONYM_MAP[t]?AGENCY_ACRONYM_MAP[t]:e;let r=!1;const n=a.map((e=>{const t=e.replace(/[.,;:!?]/g,"");return AGENCY_ACRONYM_MAP[t]?(r=!0,AGENCY_ACRONYM_MAP[t]):e}));return r?n.join(" "):e}function setupUnifiedSearch(){const e=window.innerWidth<768,t=e?400:300;unifiedSearchInput.addEventListener("input",_.debounce((function(){const t=this.value.toLowerCase().trim();if(unifiedSearchSuggestions.innerHTML="",t.length<2)return void unifiedSearchSuggestions.classList.add("hidden");const a=expandAcronyms(t),r=a!==t,n=(r?`${t} ${a}`:t).toLowerCase().split(/\s+/).filter((e=>e.length>=2)),o=new Map,i=e?8:15,s=(e,t,a=!1)=>{if(!e)return 0;const r=String(e).toLowerCase(),n=a?10:8,o=a?8:6,i=a?6:4;return r===t?a?12:10:r.startsWith(t)?n:new RegExp(`\\b${t}\\b`).test(r)?o:r.includes(t)?i:0};if(parsedData.forEach((e=>{if(o.size>=i)return;if([{key:"Legal Business Name",type:"primeName",weight:1},{key:"NAICS Code",type:"naicsCode",weight:.8},{key:"NAICS Description",type:"naicsDesc",weight:.8},{key:"Contracting Department Name",type:"departmentName",weight:1.2},{key:"Contracting Agency Name",type:"agencyName",weight:1.2},{key:"Contracting Office Name",type:"officeName",weight:.7},{key:"Principal Place of Performance State Code",type:"stateCode",weight:.6}].forEach((n=>{const i=e[n.key];if(!i)return;const c=String(i),l=`${n.type}-${c}`;if(o.has(l))return;let d=0,p=!0;const u=t.toLowerCase().split(/\s+/).filter((e=>e.length>=2));for(const e of u){const t=s(c,e,!1);if(0===t){p=!1;break}d+=t*n.weight}if(!p&&r){const e=a.toLowerCase().split(/\s+/).filter((e=>e.length>=2));d=0,p=!0;for(const t of e){const e=s(c,t,!0);if(0===e){p=!1;break}d+=e*n.weight}}(1===u.length?d>0:p)&&o.set(l,{text:c,type:n.type,originalValue:c,score:d,isAcronymMatch:r&&p})})),n.length>0&&o.size<i){(e["NAICS Description"]||"").split(/\s+/).filter((e=>e.length>3)).forEach((e=>{const t=`naicsDesc-${e}`;if(o.has(t))return;let a=0,i=!0;for(const t of n){const n=s(e,t,r);if(0===n){i=!1;break}a+=.7*n}(1===n.length?a>0:i)&&o.set(t,{text:e,type:"naicsDesc",originalValue:e,score:a,isAcronymMatch:r})}))}})),o.size>0){const e=Array.from(o.values()).sort(((e,t)=>t.score-e.score)).slice(0,i);if(unifiedSearchSuggestions.classList.remove("hidden"),e.forEach((e=>{const n=document.createElement("div");n.className="suggestion-item hover:bg-[var(--surface-level-2)]",e.isAcronymMatch&&(n.style.borderLeft="3px solid var(--accent)",n.style.paddingLeft="8px");const o=document.createElement("span");o.className="suggestion-text";let i=e.text;(r?a.toLowerCase().split(/\s+/).filter((e=>e.length>=2)):t.toLowerCase().split(/\s+/).filter((e=>e.length>=2))).forEach((e=>{if(e.length<2)return;const t=new RegExp("("+(e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+")"),"gi");i=i.replace(t,"<strong>$1</strong>")})),o.innerHTML=i,n.appendChild(o);const s=document.createElement("span");s.className="type-label bg-[var(--surface-level-1)] text-[var(--text-tertiary)]";let c=e.type;"primeName"===e.type?c="Prime":"naicsCode"===e.type?c="NAICS":"naicsDesc"===e.type?c="Desc":"departmentName"===e.type?c=e.isAcronymMatch?"Dept*":"Dept":"agencyName"===e.type?c=e.isAcronymMatch?"Agency*":"Agency":"officeName"===e.type?c="Office":"stateCode"===e.type&&(c="State"),s.textContent=c,n.appendChild(s),n.onclick=()=>selectSearchSuggestion(e.text,e.type,e.originalValue),unifiedSearchSuggestions.appendChild(n)})),r){const e=document.createElement("div");e.className="p-2 text-xs text-[var(--text-tertiary)] border-t border-[var(--border-level-1)] italic",e.innerHTML=`💡 Expanded "${t}" to "${a}"`,unifiedSearchSuggestions.appendChild(e)}}else if(t.length>=2){unifiedSearchSuggestions.classList.remove("hidden");let e="No specific suggestions. Press Enter to search all fields.";r&&(e=`Searching for "${a}" (expanded from "${t}"). Press Enter to search all fields.`),unifiedSearchSuggestions.innerHTML=`\n        <div class="p-2 text-sm text-[var(--text-tertiary)]">\n          ${e}\n        </div>`}}),t)),unifiedSearchInput.addEventListener("keypress",(function(e){if("Enter"===e.key){let e=this.value.trim();if(!e)return;const t=expandAcronyms(e);t!==e&&(console.log(`Expanding "${e}" to "${t}" for search`),e=t),applyFilter(e),unifiedSearchSuggestions.innerHTML="",unifiedSearchSuggestions.classList.add("hidden")}})),"ontouchstart"in window?document.addEventListener("touchstart",(function(e){unifiedSearchInput.contains(e.target)||unifiedSearchSuggestions.contains(e.target)||unifiedSearchSuggestions.classList.add("hidden")})):document.addEventListener("click",(function(e){unifiedSearchInput.contains(e.target)||unifiedSearchSuggestions.contains(e.target)||unifiedSearchSuggestions.classList.add("hidden")}));const a=document.getElementById("clearSearchBtn");a&&a.addEventListener("click",(function(){unifiedSearchInput.value="",unifiedSearchSuggestions.innerHTML="",unifiedSearchSuggestions.classList.add("hidden"),clearAllFilters()}))}function initializeCoreVisuals(e,t=!1){updateStatistics(e);const a=document.getElementById("marketShareChartCard"),r=document.getElementById("primeContractorsChartCard");t?(charts.marketShareChart&&(charts.marketShareChart.destroy(),charts.marketShareChart=null),a&&a.querySelector(".chart-container")&&(a.querySelector(".chart-container").innerHTML='<div class="chart-no-data">Market share not applicable for single prime view.</div>'),charts.primeContractorsChart&&(charts.primeContractorsChart.destroy(),charts.primeContractorsChart=null),r&&r.querySelector(".chart-container")&&(r.querySelector(".chart-container").innerHTML='<div class="chart-no-data">Top primes not applicable for single prime view.</div>')):(a&&!a.querySelector("canvas#marketShareChart")&&(a.querySelector(".chart-container").innerHTML='<canvas id="marketShareChart"></canvas>'),createMarketShareChart(e),r&&!r.querySelector("canvas#primeContractorsChart")&&(r.querySelector(".chart-container").innerHTML='<canvas id="primeContractorsChart"></canvas>'),createPrimeContractorsChart(e)),createDepartmentChart(e),createNaicsChart_main(e),createContractTypeChart_main(e),createStateContractsChart_main(e,currentMainStateChartFilter),createTopAgenciesChart(e),createTimelineChart(e),renderSankeyChart(e),createContractOpportunityForecast(e),createPrimeSpecializationHeatmap(e),createContractingOfficeRelationshipMap(e)}function updateStatistics(e){if(!e||0===e.length)return void["totalContractsValue","totalValueValue","avgContractValue","uniquePrimesValue"].forEach((e=>document.getElementById(e).textContent="0"));document.getElementById("totalContractsValue").textContent=e.length.toLocaleString();let t=0,a=0;e.forEach((e=>{const r=parseCurrencyValue(e["Base and All Options Value (Total Contract Value)"]);r>0&&(t+=r,a++)})),document.getElementById("totalValueValue").textContent=formatCurrency(t),document.getElementById("avgContractValue").textContent=formatCurrency(a>0?t/a:0),document.getElementById("uniquePrimesValue").textContent=new Set(e.map((e=>e["Legal Business Name"])).filter(Boolean)).size.toLocaleString()}function getCSSVariable(e){return getComputedStyle(document.documentElement).getPropertyValue(e).trim()}let chartPrimaryColor,chartSecondaryColor,chartTertiaryColor,chartNeutralColor,chartAccentColor,chartGrays=[];function getChartColors(){chartPrimaryColor="#2c1642",chartSecondaryColor="#2c2653",chartTertiaryColor="#2a3663",chartNeutralColor="#274672",chartAccentColor=chartPrimaryColor,chartGrays=["#25557f","#26658a",getComputedStyle(document.documentElement).getPropertyValue("--surface-level-2").trim()]}let overrideChartHighlightColor="#8c8a9c",overrideChartNeutralColor=null;function getCSSVariable(e){return getComputedStyle(document.documentElement).getPropertyValue(e).trim()}function getHighlightColors(e){const t=overrideChartHighlightColor||"#e63946",a=overrideChartNeutralColor||getCSSVariable("--chart-accent-2")||"#adb5bd",r=Math.max(...e);return e.map((e=>e===r?t:a))}function getRotatingHighlightPalette(e){const t=Math.max(...e),a=[chartPrimaryColor,chartSecondaryColor,chartTertiaryColor,chartNeutralColor,chartGrays[0],chartGrays[1],chartGrays[2],"#dee2e6","#ced4da","#adb5bd"],r=overrideChartHighlightColor||"#e63946";return e.map(((e,n)=>e===t?r:a[n%a.length]))}function createChart(e,t,a,r,n="No data available for current selection."){const o=document.getElementById(e);if(!o)return;const i=o.parentElement;let s=!0;if(a?.datasets?.length>0&&(s=a.datasets.every((e=>!e.data||0===e.data.length||e.data.every((e=>0===e||null===e))))),s)return i.innerHTML=`\n      <div class="chart-no-data">\n        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">\n          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />\n        </svg>\n        <span>${n}</span>\n      </div>\n    `,void(charts[e]&&(charts[e].destroy(),charts[e]=null));i.querySelector(".chart-no-data")&&(i.innerHTML=`<canvas id="${e}"></canvas>`);const c=document.getElementById(e).getContext("2d");charts[e]&&charts[e].destroy(),charts[e]=new Chart(c,{type:t,data:a,options:r})}function createPrimeContractorsChart(e){const t=["#213a45","#5e6276","#856c85","#b38595","#d99184","#ccb9b3"];if(!document.getElementById("primeContractorsChart"))return;const a={};e.forEach((e=>{if(e["Legal Business Name"]){const t=parseCurrencyValue(e["Base and All Options Value (Total Contract Value)"]);a[e["Legal Business Name"]]=(a[e["Legal Business Name"]]||0)+t}}));const r=Object.entries(a).sort(((e,t)=>t[1]-e[1])).slice(0,10),n=r.map((e=>e[0])),o=r.map((e=>e[1]));Math.max(...o);const i={labels:n,datasets:[{label:"Contract Value",data:o,backgroundColor:function(e){const a=[...t];for(;a.length<e.length;)a.push(...t);return a.slice(0,e.length)}(o)}]};createChart("primeContractorsChart","bar",i,{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:e=>formatCurrency(e.raw)}}},scales:{x:{ticks:{callback:e=>formatCurrency(e)},grid:{display:!1}},y:{ticks:{autoSkip:!1,callback:function(e){const t=this.getLabelForValue(e);return t.length>18?t.substring(0,15)+"...":t}},grid:{display:!1}}},onClick:(e,t)=>{if(t.length>0){setUnifiedSearchTerm(i.labels[t[0].index],"primeName")}}})}function createNaicsChart_main(e){const t=["#213a45","#5e6276","#856c85","#b38595","#d99184","#ccb9b3"],a={},r={};e.forEach((e=>{if(e["NAICS Code"]){const t=String(e["NAICS Code"]);a[t]=(a[t]||0)+parseCurrencyValue(e["Base and All Options Value (Total Contract Value)"]),r[t]||(r[t]=e["NAICS Description"]||"N/A")}}));const n=Object.entries(a).sort(((e,t)=>t[1]-e[1])).slice(0,10),o=n.map((e=>e[0])),i=n.map((e=>{const t=e[0],a=r[t]||"";return`${t} - ${a.substring(0,30)}${a.length>30?"...":""}`})),s=n.map((e=>e[1]));createChart("naicsChart_main","bar",{labels:i,datasets:[{label:"Contract Value",data:s,backgroundColor:function(e){const a=[...t];for(;a.length<e.length;)a.push(...t);return a.slice(0,e.length)}(s)}]},{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(e){let t=e.dataset.label||"";return t&&(t+=": "),null!==e.parsed.x&&(t+=formatCurrency(e.parsed.x)),t}}}},scales:{x:{ticks:{callback:e=>formatCurrency(e),font:{size:10},maxRotation:0,minRotation:0,autoSkipPadding:10},grid:{display:!1}},y:{ticks:{autoSkip:!1,font:{size:10},callback:function(e){const t=this.getLabelForValue(e);return t.length>28?t.substring(0,25)+"...":t}},grid:{display:!1}}},onClick:(e,t)=>{if(t.length>0){const e=t[0].index,a=o[e];a&&setUnifiedSearchTerm(a,"naicsCode")}}})}function createStateContractsChart_main(e,t="count"){const a=["#213a45","#5e6276","#856c85","#b38595","#d99184","#ccb9b3"],r={};e.forEach((e=>{const t=e["Principal Place of Performance State Code"];t&&(r[t]||(r[t]={count:0,value:0}),r[t].count++,r[t].value+=parseCurrencyValue(e["Base and All Options Value (Total Contract Value)"]))}));const n=Object.entries(r).sort(((e,a)=>a[1][t]-e[1][t])).slice(0,10),o=n.map((e=>e[0])),i=n.map((e=>e[1][t]));Math.max(...i);const s=function(e){const t=[...a];for(;t.length<e.length;)t.push(...a);return t.slice(0,e.length)}(i),c={labels:o,datasets:[{label:"count"===t?"Number of Contracts":"Total Contract Value",data:i,backgroundColor:s}]};createChart("stateContractsChart_main","bar",c,{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:e=>"count"===t?e.raw.toLocaleString():formatCurrency(e.raw)}}},scales:{x:{grid:{display:!1}},y:{ticks:{callback:e=>"count"===t?e.toLocaleString():formatCurrency(e)},grid:{display:!1}}},onClick:(e,t)=>{if(t.length>0){setUnifiedSearchTerm(c.labels[t[0].index],"stateCode")}}})}function createTimelineChart(e){const t=["#213a45","#5e6276","#856c85","#b38595","#d99184","#ccb9b3"],a={},r={};e.forEach((e=>{if(e["Period of Performance Start Date"]){const t=new Date(e["Period of Performance Start Date"]);if(!isNaN(t.getTime())){const e=t.getFullYear();e>2e3&&e<2030&&(a[e]=(a[e]||0)+1)}}if(e["Completion Date"]){const t=new Date(e["Completion Date"]);if(!isNaN(t.getTime())){const e=t.getFullYear();e>2e3&&e<2030&&(r[e]=(r[e]||0)+1)}}}));const n=new Set([...Object.keys(a),...Object.keys(r)].map(Number)),o=Array.from(n).sort(((e,t)=>e-t)),i=[],s=[],c=[];o.forEach((e=>{i.push(e.toString()),s.push(a[e]||0),c.push(r[e]||0)}));createChart("timelineChart","line",{labels:i,datasets:[{label:"Contracts Starting",data:s,borderColor:t[1],backgroundColor:`${t[1]}33`,fill:!0,tension:.4,pointRadius:0,pointHitRadius:10,pointHoverRadius:5},{label:"Contracts Ending",data:c,borderColor:t[4],backgroundColor:`${t[4]}33`,fill:!0,tension:.4,pointRadius:0,pointHitRadius:10,pointHoverRadius:5}]},{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"top"},tooltip:{callbacks:{label:e=>`${e.dataset.label||""}: ${e.parsed.y.toLocaleString()}`}}},scales:{y:{beginAtZero:!0,ticks:{callback:e=>e.toLocaleString()},grid:{display:!1}},x:{ticks:{callback:function(e,t,a){const r=this.getLabelForValue(e);return r&&"string"==typeof r&&4===r.length&&!isNaN(r)?"'"+r.substring(2):r},maxRotation:0,minRotation:0},grid:{display:!1}}}})}function createDepartmentChart(e){const t=["#213a45","#5e6276","#856c85","#b38595","#d99184","#ccb9b3"],a={};e.forEach((e=>{if(e["Contracting Department Name"]){const t=e["Contracting Department Name"];a[t]=(a[t]||0)+parseCurrencyValue(e["Base and All Options Value (Total Contract Value)"])}}));const r=Object.entries(a).sort(((e,t)=>t[1]-e[1])).slice(0,10),n=r.map((e=>e[0])),o=r.map((e=>e[1]));Math.max(...o);const i={labels:n,datasets:[{data:o,backgroundColor:function(e){const a=[...t];for(;a.length<e.length;)a.push(...t);return a.slice(0,e.length)}(o)}]};createChart("departmentChart","pie",i,{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"right",labels:{boxWidth:12,font:{size:10}}},tooltip:{callbacks:{label:e=>`${e.label||""}: ${formatCurrency(e.raw)}`}}},onClick:(e,t)=>{if(t.length>0){setUnifiedSearchTerm(i.labels[t[0].index],"departmentName")}}})}function createMarketShareChart(e){const t=["#213a45","#5e6276","#856c85","#b38595","#d99184","#ccb9b3"];if(!document.getElementById("marketShareChart"))return;const a={};e.forEach((e=>{if(e["Legal Business Name"]){const t=e["Legal Business Name"];a[t]=(a[t]||0)+parseCurrencyValue(e["Base and All Options Value (Total Contract Value)"])}}));const r=Object.entries(a).sort(((e,t)=>t[1]-e[1])),n=[],o=[];if(r.forEach(((e,t)=>{t<5&&(n.push(e[0]),o.push(e[1]))})),r.length>5){const e=r.slice(5).reduce(((e,t)=>e+t[1]),0);e>0&&(n.push("Others"),o.push(e))}Math.max(...o);const i=function(e){const a=[...t];for(;a.length<e.length;)a.push(...t);return a.slice(0,e.length)}(o),s={labels:n,datasets:[{label:"Prime Share",data:o,backgroundColor:i}]};createChart("marketShareChart","pie",s,{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"right",labels:{boxWidth:12,font:{size:10}}},tooltip:{callbacks:{label:e=>{const t=e.raw,a=(t/o.reduce(((e,t)=>e+t),0)*100).toFixed(1);return`${e.label||""}: ${formatCurrency(t)} (${a}%)`}}}},onClick:(e,t)=>{if(t.length>0){const e=s.labels[t[0].index];"Others"!==e?setUnifiedSearchTerm(e,"primeName"):console.log("Clicked 'Others' slice - contains:",r.slice(5).map((e=>e[0])))}}})}function createContractTypeChart_main(e){const t={};e.forEach((e=>{const a=e["Award or Indefinite Delivery Vehicle Type"];a&&(t[a]=(t[a]||0)+1)}));const a=Object.entries(t).sort(((e,t)=>t[1]-e[1])),r=a.map((e=>e[0])),n=a.map((e=>e[1])),o=(Math.max(...n),chartGrays[0],chartGrays[1],chartGrays[2],{labels:r,datasets:[{data:n,backgroundColor:getRotatingHighlightPalette(n)}]});createChart("contractTypeChart_main","doughnut",o,{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"right",labels:{boxWidth:12,font:{size:10}}},tooltip:{callbacks:{label:e=>`${e.label||""}: ${e.raw.toLocaleString()}`}}},onClick:(e,t)=>{if(t.length>0){setUnifiedSearchTerm(o.labels[t[0].index],"contractType")}}})}function createTopAgenciesChart(e){const t={};e.forEach((e=>{const a=e["Contracting Agency Name"];a&&(t[a]=(t[a]||0)+parseCurrencyValue(e["Base and All Options Value (Total Contract Value)"]))}));const a=Object.entries(t).sort(((e,t)=>t[1]-e[1])).slice(0,10),r=a.map((e=>e[0])),n=a.map((e=>e[1])),o=(Math.max(...n),chartGrays[0],chartGrays[1],chartGrays[2],{labels:r,datasets:[{label:"Contract Value",data:n,backgroundColor:getRotatingHighlightPalette(n)}]});createChart("topAgenciesChart","bar",o,{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:e=>formatCurrency(e.raw)}}},scales:{x:{ticks:{callback:e=>formatCurrency(e)}},y:{ticks:{autoSkip:!1,callback:function(e){const t=this.getLabelForValue(e);return t.length>20?t.substring(0,17)+".":t}}}},onClick:(e,t)=>{if(t.length>0){setUnifiedSearchTerm(o.labels[t[0].index],"agencyName")}}})}function renderSankeyChart(e){const t=["#213a45","#5e6276","#856c85","#b38595","#d99184","#ccb9b3"];if(console.log("Starting Sankey chart rendering with",e?.length||0,"records"),!e||!e.length)return void console.warn("No data available for Sankey chart");if(!document.getElementById("sankeyChart"))return void console.error("Sankey chart container not found");if("undefined"==typeof d3||!d3.sankey)return console.error("Required libraries not loaded: d3 or d3-sankey missing"),void setTimeout((()=>renderSankeyChart(e)),2e3);const a=window.innerWidth<768,r=a?8:12,n=()=>{processingIndicator&&(processingIndicator.classList.add("hidden"),processingIndicator.classList.remove("flex"))},o=e=>{console.error("Sankey chart error:",e);const t=document.getElementById("sankeyWrapper");t&&(t.innerHTML=`\n        <div class="chart-no-data">\n          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">\n            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />\n          </svg>\n          <span>${e}</span>\n        </div>`),n()};if(e&&0!==e.length)try{const i=d3.select("#sankeyChart");i.selectAll("*").remove();const s=document.getElementById("sankeyWrapper"),c=s?s.clientWidth:1e3;let l,d,p,u;a?(l=350,d=Math.max(c-10,300),p=20,u=25):(l=600,d=Math.max(c-10,800),p=30,u=p+10),console.log("Sankey container width:",c,"chart width:",d,"height:",l),i.attr("width",d).attr("height",l).attr("viewBox",`0 0 ${d} ${l}`).attr("preserveAspectRatio","xMidYMid meet");const m={},g={};e.forEach((e=>{const t=e["Contracting Agency Name"],a=e["Legal Business Name"],r=parseCurrencyValue(e["Base and All Options Value (Total Contract Value)"]);t&&r&&(m[t]=(m[t]||0)+r),a&&r&&(g[a]=(g[a]||0)+r)}));const h=(e,t)=>Object.entries(e).sort(((e,t)=>t[1]-e[1])).slice(0,t).map((e=>e[0])),f=h(m,r),y=h(g,r);let C=e.filter((e=>f.includes(e["Contracting Agency Name"])&&y.includes(e["Legal Business Name"])));if(0===C.length)return void o("No significant data flows to display");const S=new Map,E=[];C.forEach((e=>{const t=e["Contracting Agency Name"],a=e["Legal Business Name"];t&&S.set(t,{name:t,type:"agency"}),a&&S.set(a,{name:a,type:"contractor"})}));const v=Array.from(S.values()),A=new Map;v.forEach(((e,t)=>{e.id=t,A.set(e.name,t)}));const x=[];C.forEach((e=>{const t=e["Contracting Agency Name"],a=e["Legal Business Name"],r=parseCurrencyValue(e["Base and All Options Value (Total Contract Value)"]);if(t&&a&&r>0&&A.has(t)&&A.has(a)){x.push({sourceName:t,targetName:a,value:r});const e=E.find((e=>e.source===A.get(t)&&e.target===A.get(a)));e?e.value+=r:E.push({source:A.get(t),target:A.get(a),value:r})}}));const b=[...E].sort(((e,t)=>t.value-e.value)),N=b.length>0?b[0]:null;let I=null,w=null;if(N)for(const[e,t]of A.entries())t===N.source&&(I=e),t===N.target&&(w=e);let T=0;E.length>30&&(T=d3.quantile(E.map((e=>e.value)).sort(d3.ascending),.15));const D=E.filter((e=>e.value>T));const L=a?[[10,15],[d-10,l-u-15]]:[[10,20],[d-10,l-20]],P=d3.sankey().nodeId((e=>e.id)).nodeWidth(a?15:20).nodePadding(a?8:10).extent(L)({nodes:v,links:D.map((e=>Object.assign({},e)))});if(a)u=10;else{const e=i.append("g").attr("class","sankey-legend").attr("transform","translate(20, 10)");e.append("rect").attr("width",d-40).attr("height",p).attr("fill","var(--surface-level-1)").attr("opacity",.3).attr("rx",4);const a=[{label:"Agencies",color:t[1],type:"rect"},{label:"Contractors",color:t[5],type:"rect"},{label:"Top Flow",color:t[4],type:"line"}],r=Math.min(150,(d-60)/a.length);a.forEach(((t,a)=>{const n=e.append("g").attr("transform",`translate(${20+a*r}, 7)`);"rect"===t.type?n.append("rect").attr("width",14).attr("height",14).attr("fill",t.color):n.append("line").attr("x1",0).attr("y1",7).attr("x2",14).attr("y2",7).attr("stroke",t.color).attr("stroke-width",3),n.append("text").attr("x",20).attr("y",10).attr("font-size","10px").attr("text-anchor","start").attr("alignment-baseline","middle").attr("fill","var(--text-primary)").text(t.label)}))}i.append("g").attr("fill","none").attr("stroke-opacity",.4).attr("transform",`translate(0, ${u})`).selectAll("path").data(P.links).join("path").attr("d",d3.sankeyLinkHorizontal()).attr("stroke",(e=>function(e){return e.source.name===I&&e.target.name===w?t[4]:t[2]}(e))).attr("stroke-width",(e=>Math.max(1,e.width))).append("title").text((e=>`${e.source.name} → ${e.target.name}\n$${e.value.toLocaleString()}`)),i.append("g").attr("transform",`translate(0, ${u})`).selectAll("rect").data(P.nodes).join("rect").attr("x",(e=>e.x0)).attr("y",(e=>e.y0)).attr("height",(e=>Math.max(1,e.y1-e.y0))).attr("width",(e=>e.x1-e.x0)).attr("fill",(e=>function(e){return e.name===I||e.name===w?t[4]:"agency"===e.type?t[1]:t[5]}(e))).attr("opacity",.8).style("stroke","white").style("stroke-width",.5).style("cursor","pointer").on("click",(function(e,t){t.x0<d/2?setUnifiedSearchTerm(t.name,"agencyName"):setUnifiedSearchTerm(t.name,"primeName")})).append("title").text((e=>`${e.name}\n$${e.value.toLocaleString()}`)),i.append("g").attr("transform",`translate(0, ${u})`).selectAll("text").data(P.nodes).join("text").attr("x",(e=>e.x0<d/2?e.x1+6:e.x0-6)).attr("y",(e=>(e.y1+e.y0)/2)).attr("dy","0.35em").attr("text-anchor",(e=>e.x0<d/2?"start":"end")).text((e=>{const t=a?10:30,r=a?7:27;return e.name.length>t?e.name.substring(0,r)+"...":e.name})).attr("font-size",a?"7px":"11px").attr("fill",getCSSVariable("--text-primary")),console.log("Sankey chart render complete"),n()}catch(e){o(`Error rendering sankey chart: ${e.message}`),console.error(e)}else o("No data available for sankey chart")}function addResizeListener(){window.addEventListener("resize",((e,t)=>{let a;return function(){const r=this,n=arguments;clearTimeout(a),a=setTimeout((()=>e.apply(r,n)),t)}})((()=>{if(parsedData&&parsedData.length>0){console.log("Window resized, redrawing visualizations");const e=unifiedSearchInput.value.trim();if(!document.getElementById("activeFilterIndicator").classList.contains("hidden")&&e)return;window.innerWidth;contractorMap&&setTimeout((()=>{contractorMap.invalidateSize()}),100)}}),250))}function initializePrimeProfilesSection(e){const t={};e.forEach((e=>{const a=e["Legal Business Name"];a&&(t[a]||(t[a]={name:a,contracts:0,totalValue:0,naics:new Set,agencies:new Set,uei:e["Unique Entity ID"]}),t[a].contracts++,t[a].totalValue+=parseCurrencyValue(e["Base and All Options Value (Total Contract Value)"]),e["NAICS Code"]&&t[a].naics.add(String(e["NAICS Code"])),e["Contracting Agency Name"]&&t[a].agencies.add(e["Contracting Agency Name"]))})),function(){primeProfilesContainer.innerHTML="";let e=0;Object.values(t).sort(((e,t)=>t.totalValue-e.totalValue)).forEach((t=>{e++;const a=document.createElement("div");a.className="p-3 md:p-4 bg-[var(--surface-level-2)] rounded-lg border border-[var(--border-level-1)] shadow hover:shadow-lg transition-shadow duration-150",a.innerHTML=`\n                    <h4 class="font-semibold text-[var(--accent)] truncate cursor-pointer hover:underline" title="${t.name}" onclick="setUnifiedSearchTerm('${t.name.replace(/'/g,"\\'")}', 'primeName')">${t.name}</h4>\n                    <p class="text-xs md:text-sm">Contracts: ${t.contracts.toLocaleString()}</p>\n                    <p class="text-xs md:text-sm">Value: ${formatCurrency(t.totalValue)}</p>\n                    <p class="text-xs mt-1 truncate" title="Top NAICS: ${Array.from(t.naics).slice(0,3).join(", ")}">Top NAICS: ${Array.from(t.naics).slice(0,3).join(", ")}</p>\n                    <p class="text-xs mt-1 truncate" title="Top Agencies: ${Array.from(t.agencies).slice(0,2).join(", ")}">Top Agencies: ${Array.from(t.agencies).slice(0,2).join(", ")}</p>\n                    <a href="https://www.google.com/search?q=${encodeURIComponent(t.name+" official website")}" target="_blank" rel="noopener noreferrer" \n                       class="mt-2 mr-1 text-xs bg-[var(--surface-level-3)] text-[var(--text-primary)] px-2 py-1 rounded hover:bg-[var(--surface-level-3)_hover] transition-colors duration-150 ease-in-out focus:ring-2 focus:ring-offset-2 ring-[var(--accent)] focus:outline-none inline-block"\n                       style="font-weight: var(--button-font-weight); text-decoration: none;">\n                       Find Website\n                    </a>\n                    <button class="mt-2 text-xs bg-[var(--accent)] text-[var(--on-accent)] px-2 py-1 rounded hover:bg-opacity-90 transition-colors duration-150 ease-in-out focus:ring-2 focus:ring-offset-2 ring-[var(--accent)] focus:outline-none" \n                            style="font-weight: var(--button-font-weight);" \n                            onclick="setUnifiedSearchTerm('${t.name.replace(/'/g,"\\'")}', 'primeName')">\n                        Filter Dashboard by this Prime\n                    </button>\n                `,primeProfilesContainer.appendChild(a)})),0===e&&(primeProfilesContainer.innerHTML='<p class="p-4 col-span-full text-center text-[var(--text-secondary)]">No primes match current filters.</p>')}()}function renderPrimeDetailView(e,t){if(!e||0===t.length)return void primeDetailViewSection.classList.add("hidden");primeDetailTitle.textContent=`Details for: ${e}`;const a=t[0],r=a?a["Unique Entity ID"]:"N/A",n=a?a["Ultimate Parent Unique Entity ID"]:"N/A",o=a?a["Ultimate Parent Legal Business Name"]:"N/A";let i=0;t.forEach((e=>{i+=parseCurrencyValue(e["Base and All Options Value (Total Contract Value)"])})),updateDashboardTitle(`Viewing contracts for prime: ${e}`),primeDetailStats.innerHTML=`\n        <p><strong>UEI:</strong> ${createEntityLink(r,r)}</p> \n        ${o&&"N/A"!==o?`<p><strong>Parent:</strong> ${createEntityLink(n,o)}</p>`:""}\n        <p><strong>Total Contracts (current view):</strong> ${t.length.toLocaleString()}</p>\n        <p><strong>Total Value (current view):</strong> ${formatCurrency(i)}</p>\n        <p><strong>Avg. Contract Value (current view):</strong> ${formatCurrency(t.length>0?i/t.length:0)}</p>\n\t\t<p class="mt-2">\n            <a href="https://www.google.com/search?q=${encodeURIComponent(e+" official website")}" target="_blank" rel="noopener noreferrer" \n               class="text-[var(--accent)] hover:underline font-medium">\n               Search for ${e} Website\n            </a>\n        </p>\n    `,currentPrimeDetailViewPage=1,renderPrimeDetailContractsTable(t,currentPrimeDetailViewPage),primeDetailViewSection.classList.remove("hidden")}function renderPrimeDetailContractsTable(e,t){const a=(t-1)*ITEMS_PER_PAGE_MODAL_TABLE,r=a+ITEMS_PER_PAGE_MODAL_TABLE,n=sortPrimeDetailData(e,currentPrimeDetailSort.column,currentPrimeDetailSort.order).slice(a,r);let o=`<div class="table-responsive"><table class="min-w-full divide-y divide-[var(--border-level-1)] text-xs">\n        <thead class="bg-[var(--surface-level-2)]"><tr>\n            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]" data-sort-prime="id">PIID ${"id"===currentPrimeDetailSort.column?"asc"===currentPrimeDetailSort.order?"▲":"▼":""}</th>\n            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]" data-sort-prime="agency">Agency ${"agency"===currentPrimeDetailSort.column?"asc"===currentPrimeDetailSort.order?"▲":"▼":""}</th>\n            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]" data-sort-prime="office">Office ${"office"===currentPrimeDetailSort.column?"asc"===currentPrimeDetailSort.order?"▲":"▼":""}</th>\n            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]" data-sort-prime="naicsCode">NAICS ${"naicsCode"===currentPrimeDetailSort.column?"asc"===currentPrimeDetailSort.order?"▲":"▼":""}</th>\n            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]" data-sort-prime="naicsDesc">NAICS Desc. ${"naicsDesc"===currentPrimeDetailSort.column?"asc"===currentPrimeDetailSort.order?"▲":"▼":""}</th>\n            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]" data-sort-prime="value">Value ${"value"===currentPrimeDetailSort.column?"asc"===currentPrimeDetailSort.order?"▲":"▼":""}</th>\n            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]" data-sort-prime="endDate">End Date ${"endDate"===currentPrimeDetailSort.column?"asc"===currentPrimeDetailSort.order?"▲":"▼":""}</th>\n        </tr></thead><tbody class="bg-[var(--background)] divide-y divide-[var(--border-level-1)]">`;n.forEach((e=>{o+=`<tr>\n            <td class="px-2 py-1 whitespace-nowrap">${createAwardLink(e["Procurement Instrument Identifier"])}</td>\n            <td class="px-2 py-1 whitespace-nowrap">${e["Contracting Agency Name"]||"N/A"}</td>\n            <td class="px-2 py-1 whitespace-nowrap">${e["Contracting Office Name"]||"N/A"}</td>\n            <td class="px-2 py-1">${e["NAICS Code"]||"N/A"}</td>\n            <td class="px-2 py-1 whitespace-normal max-w-xs truncate" title="${e["NAICS Description"]||""}">${e["NAICS Description"]?e["NAICS Description"].substring(0,50)+(e["NAICS Description"].length>50?"...":""):"N/A"}</td>\n            <td class="px-2 py-1 whitespace-nowrap">${formatCurrency(parseCurrencyValue(e["Base and All Options Value (Total Contract Value)"]))}</td>\n            <td class="px-2 py-1 whitespace-nowrap">${formatDate(e["Completion Date"])}</td>\n        </tr>`})),o+="</tbody></table></div>";const i=Math.ceil(e.length/ITEMS_PER_PAGE_MODAL_TABLE);i>1&&(o+=`<div class="mt-3 flex justify-between items-center text-xs">\n            <button id="prevPageBtnPrimeDetailView" class="px-2 py-1 border border-[var(--border-level-2)] rounded ${1===t?"opacity-50 cursor-not-allowed":"hover:bg-[var(--surface-level-2)] transition-colors"}" ${1===t?"disabled":""}>Previous</button>\n            <span>Page ${t} of ${i}</span>\n            <button id="nextPageBtnPrimeDetailView" class="px-2 py-1 border border-[var(--border-level-2)] rounded ${t===i?"opacity-50 cursor-not-allowed":"hover:bg-[var(--surface-level-2)] transition-colors"}" ${t===i?"disabled":""}>Next</button>\n        </div>`),primeDetailContractsTableContainer.innerHTML=o,document.querySelectorAll("#primeDetailContractsTableContainer th[data-sort-prime]").forEach((e=>{e.onclick=()=>{const t=e.dataset.sortPrime;currentPrimeDetailSort.column===t?currentPrimeDetailSort.order="asc"===currentPrimeDetailSort.order?"desc":"asc":(currentPrimeDetailSort.column=t,currentPrimeDetailSort.order="asc"),currentPrimeDetailViewPage=1;renderPrimeDetailContractsTable(sortPrimeDetailData(parsedData.filter((e=>e["Legal Business Name"]===specificPrimeName)),currentPrimeDetailSort.column,currentPrimeDetailSort.order),currentPrimeDetailViewPage)}})),document.getElementById("prevPageBtnPrimeDetailView")&&(document.getElementById("prevPageBtnPrimeDetailView").onclick=()=>{if(currentPrimeDetailViewPage>1){currentPrimeDetailViewPage--;renderPrimeDetailContractsTable(sortPrimeDetailData(parsedData.filter((e=>e["Legal Business Name"]===specificPrimeName)),currentPrimeDetailSort.column,currentPrimeDetailSort.order),currentPrimeDetailViewPage)}}),document.getElementById("nextPageBtnPrimeDetailView")&&(document.getElementById("nextPageBtnPrimeDetailView").onclick=()=>{const e=parsedData.filter((e=>e["Legal Business Name"]===specificPrimeName)),t=Math.ceil(e.length/ITEMS_PER_PAGE_MODAL_TABLE);if(currentPrimeDetailViewPage<t){currentPrimeDetailViewPage++;renderPrimeDetailContractsTable(sortPrimeDetailData(e,currentPrimeDetailSort.column,currentPrimeDetailSort.order),currentPrimeDetailViewPage)}})}function sortPrimeDetailData(e,t,a){return[...e].sort(((e,r)=>{let n,o;switch(t){case"id":n=e["Procurement Instrument Identifier"]||"",o=r["Procurement Instrument Identifier"]||"";break;case"agency":n=e["Contracting Agency Name"]||"",o=r["Contracting Agency Name"]||"";break;case"office":n=e["Contracting Office Name"]||"",o=r["Contracting Office Name"]||"";break;case"naicsCode":n=String(e["NAICS Code"]||""),o=String(r["NAICS Code"]||"");break;case"naicsDesc":n=e["NAICS Description"]||"",o=r["NAICS Description"]||"";break;case"value":n=parseCurrencyValue(e["Base and All Options Value (Total Contract Value)"]),o=parseCurrencyValue(r["Base and All Options Value (Total Contract Value)"]);break;case"endDate":n=new Date(e["Completion Date"]||0).getTime(),o=new Date(r["Completion Date"]||0).getTime();break;default:return 0}return"string"==typeof n&&(n=n.toLowerCase()),"string"==typeof o&&(o=o.toLowerCase()),n<o?"asc"===a?-1:1:n>o?"asc"===a?1:-1:0}))}function setUnifiedSearchTerm(e,t="primeName"){unifiedSearchInput.value=e,applyFilter(e,t,e)}function applyInitialTheme(){if(document.documentElement.classList.remove("dark"),localStorage.removeItem("theme"),themeIconSun&&themeIconMoon&&(themeIconSun.classList.remove("hidden"),themeIconMoon.classList.add("hidden")),parsedData&&parsedData.length>0&&!currentFilterState.isActive)updateChartDefaults();else{const e=getComputedStyle(document.documentElement),t=e.getPropertyValue("--text-secondary").trim(),a=e.getPropertyValue("--border-level-2").trim();Chart.defaults.color=t,Chart.defaults.borderColor=a,getChartColors()}}function updateChartDefaults(){document.documentElement.classList.contains("dark");const e=getComputedStyle(document.documentElement),t=e.getPropertyValue("--text-secondary").trim(),a=e.getPropertyValue("--border-level-2").trim();Chart.defaults.color=t,Chart.defaults.borderColor=a,Object.keys(charts).forEach((e=>{if(charts[e]&&charts[e].update)try{charts[e].options.scales&&(charts[e].options.scales.x&&(charts[e].options.scales.x.ticks=charts[e].options.scales.x.ticks||{},charts[e].options.scales.x.ticks.color=t,charts[e].options.scales.x.grid=charts[e].options.scales.x.grid||{},charts[e].options.scales.x.grid.color=a),charts[e].options.scales.y&&(charts[e].options.scales.y.ticks=charts[e].options.scales.y.ticks||{},charts[e].options.scales.y.ticks.color=t,charts[e].options.scales.y.grid=charts[e].options.scales.y.grid||{},charts[e].options.scales.y.grid.color=a)),charts[e].options.plugins&&charts[e].options.plugins.legend&&(charts[e].options.plugins.legend.labels=charts[e].options.plugins.legend.labels||{},charts[e].options.plugins.legend.labels.color=t),charts[e].update("none")}catch(t){console.warn(`Error updating chart ${e}:`,t)}})),updateD3VisualizationColors()}function updateD3VisualizationColors(){d3.selectAll("#sankeyChart text").style("fill",getCSSVariable("--text-primary")),d3.selectAll("#contractingOfficeRelationshipMap text").style("fill",getCSSVariable("--text-primary")),d3.selectAll("#primeSpecializationHeatmap text").style("fill",getCSSVariable("--text-primary")),d3.selectAll(".legend text").style("fill",getCSSVariable("--text-primary"))}function showShareToast(e){const t=document.getElementById("shareToast");t?(t.textContent=e,t.classList.remove("hidden"),setTimeout((()=>{t.classList.add("hidden")}),2e3)):alert(e)}function fallbackCopyToClipboard(e){const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.left="-999999px",t.style.top="-999999px",document.body.appendChild(t),t.focus(),t.select();try{showShareToast(document.execCommand("copy")?"Link copied to clipboard!":"Please copy the URL from your browser bar")}catch(e){console.error("Fallback copy failed: ",e),showShareToast("Please copy the URL from your browser bar")}document.body.removeChild(t)}function applyFiltersFromURL(){const e=new URLSearchParams(window.location.search),t=e.get("search"),a=e.get("filterType"),r=e.get("filterValue");if(a&&r){const e=decodeURIComponent(r.replace(/\+/g," "));unifiedSearchInput.value=e,applyFilter(e,a,e)}else if(t){const e=decodeURIComponent(t.replace(/\+/g," "));unifiedSearchInput.value=e,applyFilter(e)}unifiedSearchInput.value&&""!==unifiedSearchInput.value.trim()?document.getElementById("primeProfilesSection").classList.add("highlight-section"):document.getElementById("primeProfilesSection").classList.remove("highlight-section")}csvFileInput.addEventListener("change",(function(e){const t=e.target.files[0];t?(fileNameDisplay.textContent=t.name,showProcessingBriefly(),Papa.parse(t,{header:!0,dynamicTyping:!0,skipEmptyLines:!0,complete:e=>{e.errors&&e.errors.length>0?showErrorMessage("CSV Error: "+e.errors[0].message):e.data&&e.data.length>0?(showSuccessMessage("File processed!",!1),processAndInitialize(e.data),manualUploadSection&&(manualUploadSection.classList.add("hidden"),manualUploadSection.style.display="none"),s3LoadErrorDiv.classList.add("hidden")):showErrorMessage("No data in file.")},error:e=>showErrorMessage("CSV Parse Fail: "+e.message)})):fileNameDisplay.textContent="No file"})),themeToggleBtn&&themeToggleBtn.addEventListener("click",(()=>{document.documentElement.classList.toggle("dark"),document.documentElement.classList.contains("dark")?(localStorage.setItem("theme","dark"),themeIconSun&&themeIconSun.classList.add("hidden"),themeIconMoon&&themeIconMoon.classList.remove("hidden")):(localStorage.setItem("theme","light"),themeIconSun&&themeIconSun.classList.remove("hidden"),themeIconMoon&&themeIconMoon.classList.add("hidden")),getChartColors(),updateChartDefaults()})),shareViewBtn.addEventListener("click",(()=>{const e=new URL(window.location.href);e.searchParams.delete("search"),e.searchParams.delete("filterType"),e.searchParams.delete("filterValue");const t=unifiedSearchInput.value.trim();isViewingSpecificPrime&&specificPrimeName?(e.searchParams.set("filterType","primeName"),e.searchParams.set("filterValue",specificPrimeName)):t&&e.searchParams.set("search",t),navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(e.toString()).then((()=>{showShareToast("Link copied to clipboard!")})).catch((t=>{console.error("Failed to copy URL: ",t),fallbackCopyToClipboard(e.toString())})):fallbackCopyToClipboard(e.toString())})),document.getElementById("resetMapBtn").addEventListener("click",(()=>{contractorMap&&(contractorMap.setView([39.8283,-98.5795],3),console.log("Map view reset"))})),document.getElementById("resetSankeyBtn").addEventListener("click",(()=>{unifiedSearchInput.value="",clearAllFilters(),renderSankeyChart(parsedData)})),document.getElementById("clearSearchBtn").addEventListener("click",(()=>{unifiedSearchInput.value="",clearAllFilters()})),document.getElementById("globalResetBtn").addEventListener("click",(()=>{unifiedSearchInput.value="",clearAllFilters(),contractorMap&&contractorMap.setView([39.8283,-98.5795],3)}));let currentOpportunityData=[],currentOpportunityPage=1;const itemsPerOpportunityPage=10;let currentOpportunitySortConfig={field:"value",order:"desc"};function createContractOpportunityForecast(e){console.log("Creating opportunity forecast chart with",e.length,"records");const t=["#213a45","#5e6276","#856c85","#b38595","#d99184","#ccb9b3"];let a=document.querySelector(".chart-container:has(#contractOpportunityForecastChart)");if(!a){Array.from(document.querySelectorAll(".chart-container")).filter((e=>e.querySelector(".chart-no-data")));if(a=Array.from(document.querySelectorAll(".dashboard-card")).find((e=>e.textContent.includes("Upcoming Contract Expirations")&&e.querySelector(".chart-container")))?.querySelector(".chart-container"),!a)return void console.error("Cannot find opportunity forecast chart container");console.log("Recreating opportunity forecast canvas element"),a.innerHTML='<canvas id="contractOpportunityForecastChart"></canvas>'}if(charts.contractOpportunityForecastChart){try{charts.contractOpportunityForecastChart.destroy()}catch(e){console.warn("Error destroying previous chart:",e)}charts.contractOpportunityForecastChart=null}const r=new Date,n={},o={};for(let e=0;e<24;e++){const t=new Date(r);t.setMonth(r.getMonth()+e);const a=`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}`;n[a]={total:0,agencies:{},contracts:[]}}e.forEach((e=>{if(!e["Completion Date"])return;const t=new Date(e["Completion Date"]);if(isNaN(t.getTime()))return;if(t<r)return;if(12*(t.getFullYear()-r.getFullYear())+(t.getMonth()-r.getMonth())>24)return;const a=`${t.getFullYear()}-${(t.getMonth()+1).toString().padStart(2,"0")}`;if(!n[a])return;const i=e["Contracting Agency Name"]||"Unknown",s=parseCurrencyValue(e["Base and All Options Value (Total Contract Value)"]);n[a].total+=s,n[a].agencies[i]||(n[a].agencies[i]=0),n[a].agencies[i]+=s,o[i]||(o[i]=0),o[i]+=s,n[a].contracts.push({prime:e["Legal Business Name"],agency:e["Contracting Agency Name"],office:e["Contracting Office Name"],piid:e["Procurement Instrument Identifier"],naics:e["NAICS Code"],naicsDesc:e["NAICS Description"],value:s,endDate:t})}));if(!Object.values(n).some((e=>e.total>0)))return console.log("No expiring contracts to display"),void(a.innerHTML='\n      <div class="chart-no-data">\n        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">\n          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />\n        </svg>\n        <span>No data available for current selection.</span>\n      </div>\n    ');if(!document.getElementById("contractOpportunityForecastChart")&&(console.error("Canvas element still not found after recreation attempts"),a.innerHTML='<canvas id="contractOpportunityForecastChart"></canvas>',!document.getElementById("contractOpportunityForecastChart")))return void console.error("Failed to create canvas element - cannot continue");const i=Object.keys(n).sort(),s=window.innerWidth<=1024?3:5,c=Object.entries(o).sort(((e,t)=>t[1]-e[1])).slice(0,s).map((e=>e[0])),l=c.map(((e,a)=>{const r=i.map((t=>n[t].agencies[e]||0)),o=t[a%t.length];return{label:e,data:r,backgroundColor:o,borderColor:o,borderWidth:1,borderRadius:4}})),d=i.map((e=>n[e].total-c.reduce(((t,a)=>t+(n[e].agencies[a]||0)),0)));d.some((e=>e>0))&&l.push({label:"Other Agencies",data:d,backgroundColor:t[3],borderColor:t[3],borderWidth:1,borderRadius:4});const p={labels:i.map((e=>{const[t,a]=e.split("-");try{return new Date(parseInt(t),parseInt(a)-1,1).toLocaleDateString("en-US",{month:"short",year:"2-digit"})}catch(t){return console.warn("Error formatting date label:",t),e}})),datasets:l},u={responsive:!0,maintainAspectRatio:!1,plugins:{tooltip:{callbacks:{label:function(e){return`${e.dataset.label}: ${formatCurrency(e.raw)}`},footer:function(e){e[0].dataIndex;return`Total Value: ${formatCurrency(e.reduce(((e,t)=>e+t.raw),0))}`}}},title:{display:!1},legend:{position:"bottom",labels:{boxWidth:10,font:{size:9}}}},scales:{x:{stacked:!0,ticks:{maxRotation:45,minRotation:45,font:{size:8}},grid:{display:!1}},y:{stacked:!0,ticks:{callback:function(e){return formatCurrency(e)},font:{size:9}},grid:{display:!1}}},onClick:function(e,t){if(t.length>0){const e=t[0].index,a=i[e];updateOpportunityDetailsTable(a,n[a])}}};try{createChart("contractOpportunityForecastChart","bar",p,u),console.log("Opportunity forecast chart created successfully")}catch(e){console.error("Error creating opportunity forecast chart:",e),a.innerHTML='\n      <div class="chart-no-data">\n        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">\n          <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />\n        </svg>\n        <span>Error creating chart. Please try refreshing the page.</span>\n      </div>\n    '}}function initializeOpportunityTableControls(){console.log("Initializing opportunity table controls");const e=document.getElementById("opportunitySortSelect");e?e.addEventListener("change",(function(){try{const[e,t]=this.value.split("-");currentOpportunitySortConfig={field:e,order:t},currentOpportunityPage=1,renderOpportunityTable()}catch(e){console.error("Error handling sort change:",e)}})):console.warn("Sort select element not found");const t=document.getElementById("prevOpportunityPageBtn"),a=document.getElementById("nextOpportunityPageBtn");t?t.addEventListener("click",(function(){currentOpportunityPage>1&&(currentOpportunityPage--,renderOpportunityTable())})):console.warn("Previous page button not found"),a?a.addEventListener("click",(function(){const e=Math.ceil(currentOpportunityData.length/itemsPerOpportunityPage);currentOpportunityPage<e&&(currentOpportunityPage++,renderOpportunityTable())})):console.warn("Next page button not found"),document.addEventListener("refreshOpportunityControls",(function(){console.log("Refreshing opportunity controls due to DOM changes"),initializeOpportunityTableControls()}))}function renderOpportunityTable(){const e=document.getElementById("contractExpirationTableBody");if(!e||!currentOpportunityData.length)return;const t=sortOpportunityData(currentOpportunityData,currentOpportunitySortConfig),a=Math.ceil(t.length/itemsPerOpportunityPage),r=(currentOpportunityPage-1)*itemsPerOpportunityPage,n=r+itemsPerOpportunityPage,o=t.slice(r,n),i=document.getElementById("currentOpportunityPage"),s=document.getElementById("totalOpportunityPages"),c=document.getElementById("prevOpportunityPageBtn"),l=document.getElementById("nextOpportunityPageBtn");i&&(i.textContent=currentOpportunityPage),s&&(s.textContent=a),c&&(c.disabled=currentOpportunityPage<=1),l&&(l.disabled=currentOpportunityPage>=a);const d=document.getElementById("opportunityPagination");d&&(d.style.display=a<=1?"none":"flex");let p="";o.forEach((e=>{p+=`\n      <tr>\n        <td class="px-2 py-1 whitespace-nowrap">${e.prime||"N/A"}</td>\n        <td class="px-2 py-1 whitespace-nowrap">${e.agency||"N/A"}</td>\n        <td class="px-2 py-1 whitespace-nowrap">${e.office||"N/A"}</td>\n        <td class="px-2 py-1 whitespace-nowrap">${createAwardLink(e.piid)}</td>\n        <td class="px-2 py-1 whitespace-nowrap">${e.naics||"N/A"}</td>\n        <td class="px-2 py-1 whitespace-normal max-w-xs truncate" title="${e.naicsDesc||""}">${e.naicsDesc?e.naicsDesc.substring(0,30)+(e.naicsDesc.length>30?"...":""):"N/A"}</td>\n        <td class="px-2 py-1 whitespace-nowrap">${formatCurrency(e.value)}</td>\n        <td class="px-2 py-1 whitespace-nowrap">${formatDate(e.endDate)}</td>\n      </tr>\n    `})),0===o.length&&(p='<tr><td colspan="8" class="px-2 py-4 text-center">No contracts found for this month</td></tr>'),e.innerHTML=p,window.opportunityControlsInitialized||(initializeOpportunityTableControls(),window.opportunityControlsInitialized=!0)}function updateOpportunityDetailsTable(e,t){document.getElementById("specializationDetailsSection").classList.add("hidden");const a=document.getElementById("contractExpirationDetails");a&&a.classList.remove("hidden");const[r,n]=e.split("-"),o=new Date(parseInt(r),parseInt(n)-1,1).toLocaleDateString("en-US",{month:"long"}),i=document.getElementById("selectedMonth");i&&(i.textContent=`${o} ${r}`);const s=document.getElementById("totalOpportunities"),c=document.getElementById("totalOpportunitiesValue");s&&(s.textContent=t.contracts.length.toLocaleString()),c&&(c.textContent=formatCurrency(t.total)),currentOpportunityData=[...t.contracts],currentOpportunityPage=1,0===currentOpportunityData.length&&console.log("No contract data for this month:",e),renderOpportunityTable(),setTimeout((()=>{a.scrollIntoView({behavior:"smooth",block:"start"})}),100)}function initializeOpportunityTableControls(){console.log("Initializing opportunity table controls");const e=document.getElementById("opportunitySortSelect");e?e.addEventListener("change",(function(){const[e,t]=this.value.split("-");currentOpportunitySortConfig={field:e,order:t},currentOpportunityPage=1,renderOpportunityTable()})):console.warn("Sort select element not found");const t=document.getElementById("prevOpportunityPageBtn"),a=document.getElementById("nextOpportunityPageBtn");t?t.addEventListener("click",(function(){currentOpportunityPage>1&&(currentOpportunityPage--,renderOpportunityTable())})):console.warn("Previous page button not found"),a?a.addEventListener("click",(function(){const e=Math.ceil(currentOpportunityData.length/itemsPerOpportunityPage);currentOpportunityPage<e&&(currentOpportunityPage++,renderOpportunityTable())})):console.warn("Next page button not found")}function updateOpportunityDetailsTable(e,t){document.getElementById("specializationDetailsSection").classList.add("hidden");const a=document.getElementById("contractExpirationDetails");a&&a.classList.remove("hidden");const[r,n]=e.split("-"),o=new Date(parseInt(r),parseInt(n)-1,1).toLocaleDateString("en-US",{month:"long"}),i=document.getElementById("selectedMonth");i&&(i.textContent=`${o} ${r}`);const s=document.getElementById("totalOpportunities"),c=document.getElementById("totalOpportunitiesValue");s&&(s.textContent=t.contracts.length.toLocaleString()),c&&(c.textContent=formatCurrency(t.total)),currentOpportunityData=[...t.contracts],currentOpportunityPage=1,renderOpportunityTable(),setTimeout((()=>{a.scrollIntoView({behavior:"smooth",block:"start"})}),100)}function closeAllDetailSections(){document.getElementById("specializationDetailsSection").classList.add("hidden"),document.getElementById("contractExpirationDetails").classList.add("hidden")}function addCloseButtonsToDetailSections(){const e=document.querySelector("#specializationDetailsSection .flex.justify-between");if(e&&!e.querySelector(".detail-close-btn")){const t=document.createElement("button");t.innerHTML="&times;",t.className="detail-close-btn px-2 py-1 bg-[var(--surface-level-2)] text-[var(--text-secondary)] rounded hover:bg-[var(--surface-level-3)] ml-2",t.addEventListener("click",(function(){document.getElementById("specializationDetailsSection").classList.add("hidden")})),e.appendChild(t)}const t=document.querySelector("#expirationDetailsTitle");if(t&&t.parentNode&&!t.parentNode.querySelector(".detail-close-btn")){const e=document.createElement("button");e.innerHTML="&times;",e.className="detail-close-btn px-2 py-1 bg-[var(--surface-level-2)] text-[var(--text-secondary)] rounded hover:bg-[var(--surface-level-3)] absolute top-4 right-4",e.addEventListener("click",(function(){document.getElementById("contractExpirationDetails").classList.add("hidden")})),t.parentNode.style.position="relative",t.parentNode.appendChild(e)}}const handleVisualResizeDebounced=_.debounce((function(){if(document.getElementById("primeSpecializationHeatmap")&&document.getElementById("contractOpportunityForecastChart")){window.innerWidth;document.querySelectorAll("#specializationDetailsSection, #contractExpirationDetails").forEach((e=>{}))}}),250);function initializeResponsiveHeatmap(){const e=_.debounce((function(){if(parsedData&&parsedData.length>0){console.log("Window resized - adjusting heatmap text only if needed");const e=d3.select("#primeSpecializationHeatmap");if(!e.empty()){const t=window.innerWidth<=1024;e.selectAll("text").style("font-size",t?"6px":"7px")}}}),250);window.addEventListener("resize",e)}function sortOpportunityData(e,t){return[...e].sort(((e,a)=>{let r,n;switch(t.field){case"value":r=e.value,n=a.value;break;case"date":r=new Date(e.endDate).getTime(),n=new Date(a.endDate).getTime();break;case"prime":r=e.prime||"",n=a.prime||"";break;default:return 0}return"string"==typeof r&&"string"==typeof n&&(r=r.toLowerCase(),n=n.toLowerCase()),"asc"===t.order?r<n?-1:r>n?1:0:r>n?-1:r<n?1:0}))}window.addEventListener("resize",handleVisualResizeDebounced);let currentSpecializationData={prime:null,naics:null,naicsDescription:null,specializationIndex:0,totalValue:0,contracts:[]},currentSpecPage=1;const itemsPerSpecPage=10;function createPrimeSpecializationHeatmap(e){const t=["#213a45","#5e6276","#856c85","#b38595","#d99184","#ccb9b3"],a={};e.forEach((e=>{if(e["Legal Business Name"]){const t=parseCurrencyValue(e["Base and All Options Value (Total Contract Value)"]);a[e["Legal Business Name"]]=(a[e["Legal Business Name"]]||0)+t}}));const r=Object.entries(a).sort(((e,t)=>t[1]-e[1])).slice(0,10).map((e=>e[0])),n={};e.forEach((e=>{if(e["NAICS Code"]){const t=String(e["NAICS Code"]);n[t]=(n[t]||0)+parseCurrencyValue(e["Base and All Options Value (Total Contract Value)"])}}));const o=Object.entries(n).sort(((e,t)=>t[1]-e[1])).slice(0,10).map((e=>e[0])),i={};e.forEach((e=>{e["NAICS Code"]&&e["NAICS Description"]&&(i[String(e["NAICS Code"])]=e["NAICS Description"])}));const s=Object.values(a).reduce(((e,t)=>e+t),0),c={};o.forEach((e=>{c[e]=n[e]/s}));const l={};r.forEach((e=>{l[e]={},o.forEach((t=>{l[e][t]=0}))})),e.forEach((e=>{const t=e["Legal Business Name"],a=String(e["NAICS Code"]);if(r.includes(t)&&o.includes(a)){const r=parseCurrencyValue(e["Base and All Options Value (Total Contract Value)"]);l[t][a]+=r}}));const d={},p=[];r.forEach((e=>{d[e]={};const t=a[e];o.forEach((a=>{const r=l[e][a]/t/c[a];d[e][a]=r,p.push({prime:e,naics:a,description:i[a],value:l[e][a],index:r})}))}));const u=5,m=2,g=40,h=90,f=document.getElementById("primeSpecializationHeatmap");if(!f)return;const y=f.parentElement.clientWidth||900,C=f.parentElement.clientHeight||450,S=y-h-m-5,E=C-u-g-5;d3.select(f).selectAll("*").remove();const v=d3.select(f).attr("width","100%").attr("height","100%").attr("viewBox",`0 0 ${y} ${C}`).attr("preserveAspectRatio","none").append("g").attr("transform",`translate(${h},${u})`),A=d3.scaleBand().range([0,S]).domain(o).padding(.02),x=d3.scaleBand().range([0,E]).domain(r).padding(.02),b=p.map((e=>e.index)),N=Math.min(...b)||0,I=Math.max(...b)||3,w=[N,N+.25*(I-N),N+.5*(I-N),N+.75*(I-N),I],T=[t[0],t[1],t[2],t[3],t[4]],D=d3.scaleLinear().domain(w).range(T);v.append("g").attr("class","x-axis").style("font-size","8px").style("color","var(--text-primary)").attr("transform",`translate(0,${E})`).call(d3.axisBottom(A).tickSize(0)).selectAll("text").style("text-anchor","middle").style("fill","var(--text-primary)").attr("transform","translate(0,5)"),v.append("g").attr("class","y-axis").style("font-size","8px").style("color","var(--text-primary)").call(d3.axisLeft(x).tickSize(0).tickFormat((e=>e.length>10?e.substring(0,10)+"...":e))).selectAll("text").style("fill","var(--text-primary)").attr("dx","-3").select((function(){return this.parentNode.parentNode})).select(".domain").remove(),d3.selectAll(".heatmap-tooltip").remove();const L=d3.select("body").append("div").attr("class","tooltip heatmap-tooltip").style("opacity",0).style("background-color","var(--surface-level-1)").style("border","1px solid var(--border-level-2)").style("border-radius","5px").style("padding","8px").style("color","var(--text-primary)").style("position","absolute").style("z-index",1e3).style("font-size","11px").style("pointer-events","none").style("display","none");v.selectAll().data(p).enter().append("rect").attr("x",(e=>A(e.naics))).attr("y",(e=>x(e.prime))).attr("width",A.bandwidth()).attr("height",x.bandwidth()).style("fill",(e=>D(e.index))).style("stroke","var(--border-level-2)").style("stroke-width",.5).style("opacity",.9).style("cursor","pointer").on("mouseover",(function(e,a){d3.select(this).style("stroke",t[5]).style("stroke-width",1.5).style("opacity",1),L.transition().duration(200).style("opacity",.9).style("display","block"),L.html(`\n        <strong>${a.prime}</strong><br/>\n        <span>${a.naics} - ${a.description}</span><br/>\n        <span>Specialization Index: ${a.index.toFixed(2)}</span><br/>\n        <span>Contract Value: ${formatCurrency(a.value)}</span>\n      `).style("left",e.pageX+10+"px").style("top",e.pageY-28+"px")})).on("mouseout",(function(){d3.select(this).style("stroke","var(--border-level-2)").style("stroke-width",.5).style("opacity",.9),L.transition().duration(500).style("opacity",0).on("end",(()=>L.style("display","none")))})).on("click",(function(e,t){showSpecializationDetails(t.prime,t.naics,t.description,t.index,t.value)}));const P=200,O=v.append("g").attr("transform",`translate(${S/2-100}, ${E+35})`),M=d3.scaleLinear().domain([N,I]).range([0,P]),k=d3.axisBottom(M).tickSize(3).ticks(3).tickFormat((e=>e.toFixed(1))).tickPadding(3);O.append("defs").append("linearGradient").attr("id","linear-gradient").selectAll("stop").data([{offset:"0%",color:T[0]},{offset:"25%",color:T[1]},{offset:"50%",color:T[2]},{offset:"75%",color:T[3]},{offset:"100%",color:T[4]}]).enter().append("stop").attr("offset",(e=>e.offset)).attr("stop-color",(e=>e.color)),O.append("rect").attr("width",P).attr("height",10).style("fill","url(#linear-gradient)"),O.append("g").attr("transform","translate(0,10)").style("font-size","7px").call(k),O.append("text").attr("x",0).attr("y",30).attr("text-anchor","start").style("font-size","7px").style("fill","var(--text-primary)").text("Less"),O.append("text").attr("x",P).attr("y",30).attr("text-anchor","end").style("font-size","7px").style("fill","var(--text-primary)").text("More"),v.selectAll(".naics-tooltip").data(o).enter().append("title").attr("class","naics-tooltip").text((e=>`${e} - ${i[e]}`)),v.append("text").attr("x",S/2).attr("y",E+60).attr("text-anchor","middle").style("font-size","7px").style("font-style","italic").style("fill","var(--text-primary)").text("Click any cell for details"),initializeSpecializationControls()}function initializeSpecializationControls(){const e=document.getElementById("filterBySelectionBtn");e&&e.addEventListener("click",(function(){if(currentSpecializationData.prime&&currentSpecializationData.naics){customFilterByPrimeAndNaics(currentSpecializationData.prime,currentSpecializationData.naics)}}));const t=document.getElementById("prevSpecPageBtn"),a=document.getElementById("nextSpecPageBtn");t&&t.addEventListener("click",(function(){currentSpecPage>1&&(currentSpecPage--,renderSpecializationTable())})),a&&a.addEventListener("click",(function(){const e=Math.ceil(currentSpecializationData.contracts.length/itemsPerSpecPage);currentSpecPage<e&&(currentSpecPage++,renderSpecializationTable())}))}function customFilterByPrimeAndNaics(e,t){unifiedSearchInput&&(unifiedSearchInput.value=e);const a=parsedData.filter((a=>a["Legal Business Name"]===e&&String(a["NAICS Code"])===t));if(a.length>0){const r=`Prime: ${e}, NAICS: ${t}`;updateDashboardTitle(`Filtered by ${r} (${a.length.toLocaleString()} results)`),initializeCoreVisuals(a,!0),initializePrimeProfilesSection(a),"function"==typeof initializeContractExpirationCalendarSection&&initializeContractExpirationCalendarSection(a),initializeContractorMap(a),renderSankeyChart(a),updateActiveFilterIndicator(r,a.length),unifiedSearchSuggestions&&(unifiedSearchSuggestions.innerHTML="",unifiedSearchSuggestions.classList.add("hidden"))}}function showSpecializationDetails(e,t,a,r,n){const o=[];parsedData.forEach((a=>{a["Legal Business Name"]===e&&String(a["NAICS Code"])===t&&o.push({piid:a["Procurement Instrument Identifier"],agency:a["Contracting Agency Name"],office:a["Contracting Office Name"],value:parseCurrencyValue(a["Base and All Options Value (Total Contract Value)"]),startDate:formatDate(a["Period of Performance Start Date"]),endDate:formatDate(a["Completion Date"])})})),o.sort(((e,t)=>t.value-e.value)),currentSpecializationData={prime:e,naics:t,naicsDescription:a,specializationIndex:r,totalValue:n,contracts:o},currentSpecPage=1,document.getElementById("contractExpirationDetails").classList.add("hidden");const i=document.getElementById("specializationDetailsSection");i&&i.classList.remove("hidden");const s=document.getElementById("specDetailsPrime"),c=document.getElementById("specDetailsNaics"),l=document.getElementById("specDetailsIndex"),d=document.getElementById("specDetailsIndexNote"),p=document.getElementById("specDetailsTotalValue"),u=document.getElementById("specDetailsContractCount");s&&(s.textContent=e),c&&(c.textContent=`${t} - ${a}`),l&&(l.textContent=r.toFixed(2),l.className=r>1?"text-md font-bold text-[var(--accent)]":"text-md font-bold"),d&&(d.textContent=r>1?"Above average specialization":"Below average specialization"),p&&(p.textContent=formatCurrency(n)),u&&(u.textContent=o.length),renderSpecializationTable(),setTimeout((()=>{i.scrollIntoView({behavior:"smooth",block:"start"})}),100)}function renderSpecializationTable(){const e=document.getElementById("specializationContractsTable");if(!e)return;const t=(currentSpecPage-1)*itemsPerSpecPage,a=t+itemsPerSpecPage,r=currentSpecializationData.contracts.slice(t,a),n=Math.ceil(currentSpecializationData.contracts.length/itemsPerSpecPage),o=document.getElementById("currentSpecPage"),i=document.getElementById("totalSpecPages"),s=document.getElementById("prevSpecPageBtn"),c=document.getElementById("nextSpecPageBtn");o&&(o.textContent=currentSpecPage),i&&(i.textContent=n),s&&(s.disabled=currentSpecPage<=1),c&&(c.disabled=currentSpecPage>=n);const l=document.getElementById("specDetailsPagination");l&&(l.style.display=n<=1?"none":"flex");let d="";r.forEach((e=>{d+=`\n      <tr>\n        <td class="px-2 py-1 whitespace-nowrap">${createAwardLink(e.piid)}</td>\n        <td class="px-2 py-1 whitespace-nowrap">${e.agency||"N/A"}</td>\n        <td class="px-2 py-1 whitespace-nowrap">${e.office||"N/A"}</td>\n        <td class="px-2 py-1 whitespace-nowrap">${formatCurrency(e.value)}</td>\n        <td class="px-2 py-1 whitespace-nowrap">${e.startDate||"N/A"}</td>\n        <td class="px-2 py-1 whitespace-nowrap">${e.endDate||"N/A"}</td>\n      </tr>\n    `})),e.innerHTML=d||'<tr><td colspan="6" class="px-2 py-4 text-center">No contracts found</td></tr>'}let relationshipMapSimulation=null,isSimulationPaused=!1,originalNodePositions=new Map;function createContractingOfficeRelationshipMap(e){if(d3.selectAll(".d3-relationship-tooltip").remove(),console.log("Starting relationship map render with",e.length,"records"),!e||0===e.length)return console.warn("No data provided to relationship map"),void showRelationshipMapError("No data available for relationship visualization");const t=e.some((e=>e["Legal Business Name"])),a=e.some((e=>e["Contracting Agency Name"]||e["Contracting Department Name"]));if(!t||!a)return console.warn("Insufficient relationship data - missing contractors or agencies"),void showRelationshipMapError("Insufficient data for relationship visualization");const r=["#213a45","#5e6276","#856c85","#b38595","#d99184","#ccb9b3"];try{const t=e.length;let a,n,o,i;t<50?(a=3,n=5,o=8,i=8):t<200?(a=4,n=7,o=10,i=10):(a=5,n=10,o=15,i=15);const s={},c={},l={},d={},p={},u={};e.forEach((e=>{const t=e["Contracting Department Name"],a=e["Contracting Agency Name"],r=e["Contracting Office Name"],n=e["Legal Business Name"];if(!n)return;d[n]||(d[n]={id:n,type:"contractor",value:0,connections:0});const o=parseCurrencyValue(e["Base and All Options Value (Total Contract Value)"]);d[n].value+=o,t&&(s[t]||(s[t]={id:t,type:"department",value:0,connections:0}),s[t].value+=o),a&&(c[a]||(c[a]={id:a,type:"agency",value:0,connections:0}),c[a].value+=o,t&&(p[a]=t)),r&&(l[r]||(l[r]={id:r,type:"office",value:0,connections:0}),l[r].value+=o,a&&(u[r]=a))}));const m=Object.values(s).sort(((e,t)=>t.value-e.value)),g=Object.values(c).sort(((e,t)=>t.value-e.value)),h=Object.values(l).sort(((e,t)=>t.value-e.value)),f=Object.values(d).sort(((e,t)=>t.value-e.value)),y=m.slice(0,Math.min(a,m.length)),C=g.slice(0,Math.min(n,g.length)),S=h.slice(0,Math.min(o,h.length)),E=f.slice(0,Math.min(i,f.length));console.log(`Relationship map entities: ${y.length} depts, ${C.length} agencies, ${S.length} offices, ${E.length} contractors`);const v=[],A=y.map((e=>e.id)),x=C.map((e=>e.id)),b=S.map((e=>e.id)),N=E.map((e=>e.id));x.forEach((e=>{const t=p[e];t&&A.includes(t)&&v.push({source:t,target:e,value:c[e].value,type:"dept-agency"})})),b.forEach((e=>{const t=u[e];t&&x.includes(t)&&v.push({source:t,target:e,value:l[e].value,type:"agency-office"})})),0===b.length&&x.length>0?(console.log("No offices found, creating direct agency-contractor links"),e.forEach((e=>{const t=e["Legal Business Name"],a=e["Contracting Agency Name"];if(!t||!N.includes(t))return;if(!a||!x.includes(a))return;const r=parseCurrencyValue(e["Base and All Options Value (Total Contract Value)"]);let n=v.find((e=>e.source===a&&e.target===t));n?n.value+=r:v.push({source:a,target:t,value:r,type:"agency-contractor"})}))):e.forEach((e=>{const t=e["Legal Business Name"],a=e["Contracting Office Name"];if(!t||!N.includes(t))return;if(!a||!b.includes(a))return;const r=parseCurrencyValue(e["Base and All Options Value (Total Contract Value)"]);let n=v.find((e=>e.source===a&&e.target===t));n?n.value+=r:v.push({source:a,target:t,value:r,type:"office-contractor"})})),0===v.length&&A.length>0&&(console.log("No office or agency links found, creating direct department-contractor links"),e.forEach((e=>{const t=e["Legal Business Name"],a=e["Contracting Department Name"];if(!t||!N.includes(t))return;if(!a||!A.includes(a))return;const r=parseCurrencyValue(e["Base and All Options Value (Total Contract Value)"]);let n=v.find((e=>e.source===a&&e.target===t));n?n.value+=r:v.push({source:a,target:t,value:r,type:"dept-contractor"})})));const I=[...y,...C,...S,...E];if(console.log(`Final relationship map: ${I.length} nodes, ${v.length} links`),I.length<2||0===v.length)return console.warn(`Insufficient entities for visualization: ${I.length} nodes, ${v.length} links`),void showRelationshipMapError("Not enough related entities found for meaningful visualization");renderRelationshipVisualization(I,v,r)}catch(e){console.error("Error in relationship map:",e),showRelationshipMapError(`Error rendering relationship map: ${e.message}`)}}function showRelationshipMapError(e){const t=document.getElementById("contractingOfficeRelationshipMap");if(t){d3.select(t).selectAll("*").remove();const a=d3.select(t),r=t.parentElement,n=r?r.clientWidth:900,o=400;a.attr("width",n).attr("height",o).attr("viewBox",`0 0 ${n} ${o}`).attr("preserveAspectRatio","xMidYMid meet"),a.append("rect").attr("width","100%").attr("height","100%").attr("fill","var(--surface-level-1)").attr("opacity",.1),a.append("text").attr("x","50%").attr("y","40%").attr("text-anchor","middle").attr("dominant-baseline","middle").style("font-size","48px").style("fill","var(--text-tertiary)").style("opacity",.5).text("🔗"),a.append("text").attr("x","50%").attr("y","55%").attr("text-anchor","middle").attr("dominant-baseline","middle").style("font-size","14px").style("fill","var(--text-secondary)").text(e),a.append("text").attr("x","50%").attr("y","65%").attr("text-anchor","middle").attr("dominant-baseline","middle").style("font-size","11px").style("fill","var(--text-tertiary)").style("font-style","italic").text("Try searching for a larger agency or removing filters")}}function renderRelationshipVisualization(e,t,a){const r=d3.select("#contractingOfficeRelationshipMap");r.selectAll("*").remove();const n=document.getElementById("contractingOfficeRelationshipMap").parentElement,o=n?n.clientWidth:900,i=window.innerWidth>=1024,s=i?700:600;r.attr("width",o).attr("height",s).attr("viewBox",`0 0 ${o} ${s}`).attr("preserveAspectRatio","xMidYMid meet");const c=r.append("g").attr("class","control-panel").attr("transform","translate(10, 10)"),l=(c.append("rect").attr("width",200).attr("height",60).attr("fill","var(--surface-level-1)").attr("stroke","var(--border-level-2)").attr("stroke-width",1).attr("rx",5).attr("opacity",.95),c.append("g").attr("class","pause-btn").attr("transform","translate(10, 15)").style("cursor","pointer"));l.append("rect").attr("width",80).attr("height",25).attr("fill","var(--accent)").attr("rx",3);const d=l.append("text").attr("x",40).attr("y",16).attr("text-anchor","middle").attr("fill","var(--on-accent)").style("font-size","10px").style("font-weight","500").text("Pause Physics"),p=c.append("g").attr("class","reset-btn").attr("transform","translate(100, 15)").style("cursor","pointer");p.append("rect").attr("width",80).attr("height",25).attr("fill","var(--surface-level-2)").attr("stroke","var(--border-level-2)").attr("stroke-width",1).attr("rx",3),p.append("text").attr("x",40).attr("y",16).attr("text-anchor","middle").attr("fill","var(--text-primary)").style("font-size","10px").style("font-weight","500").text("Reset Layout"),c.append("text").attr("x",10).attr("y",52).attr("fill","var(--text-secondary)").style("font-size","9px").text("Pause physics to arrange nodes manually");const u=r.append("g").attr("class","network-container").attr("transform",`translate(${o/2}, ${(s+70)/2})`),m=d3.select("body").append("div").attr("class","tooltip d3-relationship-tooltip").style("opacity",0).style("background-color","var(--surface-level-1)").style("border","1px solid var(--border-level-2)").style("border-radius","5px").style("padding","10px").style("color","var(--text-primary)").style("position","absolute").style("z-index",1e3).style("font-size","12px").style("pointer-events","none").style("display","none"),g=e.map((e=>Object.assign({},e))),h=[];function f(e){switch(e.type){case"department":default:return a[0];case"agency":return a[1];case"office":return a[2];case"contractor":return a[5]}}function y(e){return"dept-agency"===e.type?a[0]:"agency-office"===e.type?a[1]:"dept-contractor"===e.type?a[0]:"agency-contractor"===e.type?a[1]:a[2]}t.forEach((e=>{const t=g.find((t=>t.id===e.source)),a=g.find((t=>t.id===e.target));t&&a&&h.push({source:t,target:a,value:e.value,type:e.type})}));const C=d3.scaleLinear().domain([0,d3.max(h,(e=>e.value))||1]).range([1,8]),S=d3.scaleSqrt().domain([0,d3.max(g,(e=>e.value))||1]).range([6,20]);relationshipMapSimulation=d3.forceSimulation(g).force("link",d3.forceLink(h).id((e=>e.id)).distance((e=>"dept-agency"===e.type?100:"agency-office"===e.type?130:"dept-contractor"===e.type?150:"agency-contractor"===e.type?140:180)).strength(.5)).force("charge",d3.forceManyBody().strength(-500)).force("center",d3.forceCenter(0,0)).force("collide",d3.forceCollide((e=>S(e.value)+30))).force("x",d3.forceX().strength(.08)).force("y",d3.forceY().strength(.08)),relationshipMapSimulation.on("end",(()=>{originalNodePositions.clear(),g.forEach((e=>{originalNodePositions.set(e.id,{x:e.x,y:e.y})}))}));const E=u.append("g").attr("class","links").selectAll("line").data(h).enter().append("line").attr("stroke-width",(e=>C(e.value))).attr("stroke",(e=>y(e))).attr("stroke-opacity",.6).attr("stroke-dasharray",(e=>"dept-agency"===e.type?"5,5":"none")).on("mouseover",(function(e,t){d3.select(this).attr("stroke",a[4]).attr("stroke-opacity",1),m.style("display","block").transition().duration(200).style("opacity",.9),m.html(`\n        <strong>${t.source.id}</strong> → <strong>${t.target.id}</strong><br/>\n        <span>Total Value: ${formatCurrency(t.value)}</span>\n      `).style("left",e.pageX+10+"px").style("top",e.pageY-28+"px")})).on("mouseout",(function(e,t){d3.select(this).attr("stroke",y(t)).attr("stroke-opacity",.6),m.transition().duration(200).style("opacity",0).on("end",(()=>m.style("display","none")))})),v=u.append("g").attr("class","nodes").selectAll("g").data(g).enter().append("g").call(d3.drag().on("start",(function(e,t){isSimulationPaused||e.active||relationshipMapSimulation.alphaTarget(.3).restart();t.fx=t.x,t.fy=t.y,m.style("display","none").style("opacity",0)})).on("drag",(function(e,t){t.fx=e.x,t.fy=e.y,isSimulationPaused&&(t.x=e.x,t.y=e.y,d3.select(this).attr("transform",`translate(${t.x},${t.y})`),E.filter((e=>e.source===t||e.target===t)).attr("x1",(e=>e.source.x)).attr("y1",(e=>e.source.y)).attr("x2",(e=>e.target.x)).attr("y2",(e=>e.target.y)))})).on("end",(function(e,t){isSimulationPaused||e.active||relationshipMapSimulation.alphaTarget(0)}))).on("click",(function(e,t){m.style("display","none"),m.style("opacity",0),setTimeout((()=>{let e="primeName";"contractor"===t.type?e="primeName":"office"===t.type?e="officeName":"agency"===t.type?e="agencyName":"department"===t.type&&(e="departmentName"),setUnifiedSearchTerm(t.id,e)}),100)}));function A(e,t,a){const r=[];for(let n=0;n<5;n++)r.push([e+a*Math.sin(2*Math.PI*n/5),t-a*Math.cos(2*Math.PI*n/5)]);return r.map((e=>e.join(","))).join(" ")}v.each((function(e){const t=d3.select(this);if("department"===e.type)t.append("polygon").attr("points",(function(){return A(0,0,S(e.value))})).attr("fill",f(e)).attr("stroke","white").attr("stroke-width",1.5);else if("agency"===e.type)t.append("polygon").attr("points",(function(){const t=S(e.value);return`0,${-t} ${.866*t},${.5*t} ${.866*-t},${.5*t}`})).attr("fill",f(e)).attr("stroke","white").attr("stroke-width",1.5);else if("office"===e.type){const a=S(e.value);t.append("rect").attr("x",-a/2).attr("y",-a/2).attr("width",a).attr("height",a).attr("fill",f(e)).attr("stroke","white").attr("stroke-width",1.5)}else t.append("circle").attr("r",S(e.value)).attr("fill",f(e)).attr("stroke","white").attr("stroke-width",1.5)})),v.append("rect").attr("class","text-background").attr("x",(e=>{const t=S(e.value);return"department"===e.type||"agency"===e.type?t+3:t+1})).attr("y",-10).attr("width",0).attr("height",20).attr("fill","var(--background)").attr("opacity",.85).attr("rx",3).attr("ry",3);v.append("text").attr("dx",(e=>{const t=S(e.value);return"department"===e.type||"agency"===e.type?t+5:t+3})).attr("dy",".35em").text((e=>{const t=e.id,a=i?40:25,r=i?37:22;return t.length>a?t.substring(0,r)+"...":t})).style("font-size","10px").style("fill",getCSSVariable("--text-primary")).style("pointer-events","none").each((function(e){const t=this.getComputedTextLength();d3.select(this.parentNode).select("rect.text-background").attr("width",t+6)})),v.on("mouseover",(function(e,t){d3.select(this).select("circle, rect, polygon").attr("stroke",a[4]).attr("stroke-width",2),m.style("display","block").transition().duration(200).style("opacity",.9);const r=t.type.charAt(0).toUpperCase()+t.type.slice(1);m.html(`\n      <strong>${r}:</strong> ${t.id}<br/>\n      <span>Total Value: ${formatCurrency(t.value)}</span>\n    `).style("left",e.pageX+10+"px").style("top",e.pageY-28+"px")})).on("mouseout",(function(){d3.select(this).select("circle, rect, polygon").attr("stroke","white").attr("stroke-width",1.5),m.transition().duration(200).style("opacity",0).on("end",(()=>m.style("display","none")))})),l.on("click",(function(){isSimulationPaused=!isSimulationPaused,isSimulationPaused?(relationshipMapSimulation.stop(),d.text("Resume Physics"),l.select("rect").attr("fill","var(--surface-level-2)"),d.attr("fill","var(--text-primary)")):(relationshipMapSimulation.alpha(.3).restart(),d.text("Pause Physics"),l.select("rect").attr("fill","var(--accent)"),d.attr("fill","var(--on-accent)"))})),p.on("click",(function(){g.forEach((e=>{const t=originalNodePositions.get(e.id);t&&(e.fx=null,e.fy=null,e.x=t.x,e.y=t.y)})),isSimulationPaused=!1,relationshipMapSimulation.alpha(1).restart(),d.text("Pause Physics"),l.select("rect").attr("fill","var(--accent)"),d.attr("fill","var(--on-accent)")}));const x=90,b=20,N=r.append("g").attr("class","legend").attr("transform",`translate(${b}, ${x})`);[{type:"department",label:"Departments",shape:"pentagon",color:a[0]},{type:"agency",label:"Agencies",shape:"triangle",color:a[1]},{type:"office",label:"Offices",shape:"square",color:a[2]},{type:"contractor",label:"Prime Contractors",shape:"circle",color:a[5]}].forEach(((e,t)=>{const a=25*t,r=N.append("g").attr("transform",`translate(0, ${a})`);"circle"===e.shape?r.append("circle").attr("r",6).attr("cx",6).attr("cy",0).attr("fill",e.color):"square"===e.shape?r.append("rect").attr("x",0).attr("y",-6).attr("width",12).attr("height",12).attr("fill",e.color):"triangle"===e.shape?r.append("polygon").attr("points","6,0 12,10 0,10").attr("transform","translate(0, -8)").attr("fill",e.color):"pentagon"===e.shape&&r.append("polygon").attr("points",A(6,0,6)).attr("fill",e.color),r.append("text").attr("x",20).attr("y",4).text(e.label).style("font-size","12px").style("fill",getCSSVariable("--text-primary"))}));const I=r.append("g").attr("class","line-legend").attr("transform",`translate(${b}, ${x+120})`);I.append("line").attr("x1",0).attr("y1",0).attr("x2",30).attr("y2",0).attr("stroke-width",3).attr("stroke",a[0]).attr("stroke-dasharray","5,5"),I.append("text").attr("x",40).attr("y",4).text("Dept → Agency").style("font-size","10px").style("fill",getCSSVariable("--text-primary")),I.append("line").attr("x1",0).attr("y1",20).attr("x2",30).attr("y2",20).attr("stroke-width",3).attr("stroke",a[1]),I.append("text").attr("x",40).attr("y",24).text("Agency → Office").style("font-size","10px").style("fill",getCSSVariable("--text-primary")),I.append("line").attr("x1",0).attr("y1",40).attr("x2",30).attr("y2",40).attr("stroke-width",3).attr("stroke",a[2]),I.append("text").attr("x",40).attr("y",44).text("Office → Contractor").style("font-size","10px").style("fill",getCSSVariable("--text-primary")),relationshipMapSimulation.on("tick",(()=>{isSimulationPaused||(g.forEach((e=>{const t=S(e.value)+40;e.x=Math.max(-o/2+t,Math.min(o/2-t,e.x)),e.y=Math.max(-s/2+t+35,Math.min(s/2-t-35,e.y))})),E.attr("x1",(e=>e.source.x)).attr("y1",(e=>e.source.y)).attr("x2",(e=>e.target.x)).attr("y2",(e=>e.target.y)),v.attr("transform",(e=>`translate(${e.x},${e.y})`)))})),relationshipMapSimulation.alpha(1).restart()}function adjustChartsVisibility(e=!1){const t=document.getElementById("marketShareChartCard"),a=document.getElementById("primeContractorsChartCard"),r=document.querySelector(".grid.grid-cols-1.md\\:grid-cols-2.lg\\:grid-cols-3.gap-4.md\\:gap-6");if(e){t&&t.classList.add("hidden"),a&&a.classList.add("hidden"),r&&(r.classList.remove("lg:grid-cols-3"),r.classList.add("lg:grid-cols-2"));Array.from(r.children).filter((e=>!e.classList.contains("hidden"))).forEach(((e,t)=>{e.style.order=t}))}else t&&t.classList.remove("hidden"),a&&a.classList.remove("hidden"),r&&(r.classList.remove("lg:grid-cols-2"),r.classList.add("lg:grid-cols-3")),Array.from(r.children).forEach((e=>{e.style.order=""}))}function setupMobileQuickPicks(){if(window.innerWidth>1024)return;document.querySelectorAll(".sidebar-content > div").forEach((e=>{const t=e.querySelector(".flex.flex-wrap");if(!t)return;const a=document.createElement("span");a.className="text-xs px-2 py-1 bg-[var(--surface-level-2)] hover:bg-[var(--surface-level-3)] rounded text-[var(--text-secondary)] cursor-pointer",a.textContent="More...",a.style.whiteSpace="nowrap",a.addEventListener("click",(function(){const e=t.querySelectorAll("button");let a=!1;e.forEach(((e,t)=>{t>=5&&(e.style.display="none"===e.style.display?"inline-flex":"none",a="none"!==e.style.display)})),this.textContent=a?"Less...":"More..."})),t.appendChild(a)}))}document.addEventListener("DOMContentLoaded",(function(){getChartColors(),initializeChartDefaults();"dark"===localStorage.getItem("theme")&&(document.documentElement.classList.add("dark"),themeIconSun&&themeIconSun.classList.add("hidden"),themeIconMoon&&themeIconMoon.classList.remove("hidden"));const e=document.getElementById("dashboardSidebar"),t=document.getElementById("dashboardMainContent"),a=document.getElementById("toggleSidebarBtn"),r=document.getElementById("mobileSidebarToggle"),n=window.innerWidth>=1025;n||(t.style.marginLeft="0",t.style.width="100%"),window.addEventListener("resize",(function(){window.innerWidth>=1025!==n&&location.reload()})),"function"==typeof addCloseButtonsToDetailSections&&addCloseButtonsToDetailSections(),"function"==typeof closeAllDetailSections&&closeAllDetailSections();document.getElementById("contractExpirationDetails")&&"function"==typeof initializeOpportunityTableControls&&initializeOpportunityTableControls(),"ontouchstart"in window&&document.querySelectorAll("button, .filter-btn").forEach((e=>{e.addEventListener("touchstart",(function(){this.classList.add("active-touch")})),e.addEventListener("touchend",(function(){this.classList.remove("active-touch")}))})),"function"==typeof handleVisualResizeDebounced&&window.addEventListener("resize",handleVisualResizeDebounced),initializeResponsiveHeatmap(),addResizeListener(),document.addEventListener("click",(function(t){!n&&e&&e.classList.contains("expanded")&&!e.contains(t.target)&&t.target!==r&&t.target!==a&&e.classList.remove("expanded")})),document.addEventListener("keydown",(function(t){"Escape"===t.key&&e&&e.classList.contains("expanded")&&e.classList.remove("expanded")})),loadDataFromS3(),setTimeout((function(){var e=document.getElementById("page-loader");e&&(e.style.opacity="0",e.style.pointerEvents="none",setTimeout((function(){e.style.display="none"}),300))}),3e3)})),document.addEventListener("DOMContentLoaded",(function(){setupMobileQuickPicks()}));
</script>
</html>