<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Federal Contractor Directory | Subhoo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base Styles with Material Design Influence */
        :root {
            /* Brand Colors */
            --color-primary: #342f3a;
            --color-primary-dark: #211c26;
            --color-primary-light: #49434e;
            --color-secondary: #5f5864;
            --color-tertiary: #756f7b;
            --color-quaternary: #8c8692;
            
            /* Chart Colors */
            --chart-color-1: #213a45;
            --chart-color-2: #5e6276;
            --chart-color-3: #856c85;
            --chart-color-4: #b38595;
            --chart-color-5: #d99184;
            --chart-color-6: #ccb9b3;
            
            /* UI Colors */
            --surface: #ffffff;
            --background: #f8f9fa;
            --text-primary: #212121;
            --text-secondary: #616161;
            --text-tertiary: #9e9e9e;
            --divider: rgba(0, 0, 0, 0.12);
            --shadow-color: rgba(0, 0, 0, 0.1);
            
            /* Elevation */
            --shadow-1: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --shadow-2: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
            --shadow-3: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
            
            /* Spacing */
            --spacing-xs: 4px;
            --spacing-s: 8px;
            --spacing-m: 16px;
            --spacing-l: 24px;
            --spacing-xl: 32px;
            --spacing-xxl: 48px;
            
            /* Typography */
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-size-xs: 12px;
            --font-size-s: 14px;
            --font-size-m: 16px;
            --font-size-l: 18px;
            --font-size-xl: 20px;
            --font-size-xxl: 24px;
            --font-size-xxxl: 32px;
            
            /* Animation */
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
            --transition-slow: 350ms ease;
            
            /* Border Radius */
            --radius-s: 4px;
            --radius-m: 8px;
            --radius-l: 12px;
            --radius-xl: 16px;
            --radius-xxl: 24px;
            --radius-circle: 50%;
        }

        /* Dark Mode */
        @media (prefers-color-scheme: dark) {
            :root {
                --surface: #1e1e1e;
                --background: #121212;
                --text-primary: #e0e0e0;
                --text-secondary: #a0a0a0;
                --text-tertiary: #757575;
                --divider: rgba(255, 255, 255, 0.12);
                --shadow-color: rgba(0, 0, 0, 0.25);
            }
        }

        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            font-family: var(--font-family);
            font-size: var(--font-size-m);
            line-height: 1.5;
            color: var(--text-primary);
            background-color: var(--background);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
        }

        body {
            display: flex;
            flex-direction: column;
        }

        /* Layout */
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-m);
        }

        .header {
            background-color: var(--color-primary);
            color: white;
            padding: var(--spacing-l) 0;
            box-shadow: var(--shadow-1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: var(--font-size-xxl);
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
        }

        .header p {
            font-size: var(--font-size-m);
            opacity: 0.85;
        }

        .main-content {
            flex: 1;
            width: 100%;
            padding: var(--spacing-l) 0;
            overflow-y: auto;
        }

        /* Card Styles */
        .contractor-card {
            background-color: var(--surface);
            border-radius: var(--radius-m);
            box-shadow: var(--shadow-1);
            padding: var(--spacing-l);
            margin-bottom: var(--spacing-l);
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
            position: relative;
            overflow: hidden;
            border-left: 4px solid var(--color-secondary);
        }

        .contractor-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-2);
        }

        .contractor-card h3 {
            color: var(--color-primary);
            font-size: var(--font-size-l);
            font-weight: 600;
            margin-bottom: var(--spacing-m);
            padding-bottom: var(--spacing-s);
            border-bottom: 1px solid var(--divider);
        }

        .contractor-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: var(--spacing-m);
            margin-bottom: var(--spacing-m);
        }

        .contractor-detail {
            margin-bottom: var(--spacing-s);
        }

        .contractor-detail strong {
            display: block;
            color: var(--text-secondary);
            font-size: var(--font-size-s);
            font-weight: 500;
            margin-bottom: var(--spacing-xs);
        }

        .contractor-tags {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-s);
            margin-bottom: var(--spacing-m);
        }

        .tag {
            background-color: var(--color-primary-light);
            color: white;
            font-size: var(--font-size-xs);
            padding: var(--spacing-xs) var(--spacing-m);
            border-radius: var(--radius-l);
            font-weight: 500;
        }

        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: var(--color-primary);
            color: white;
            border: none;
            border-radius: var(--radius-m);
            padding: var(--spacing-s) var(--spacing-l);
            font-size: var(--font-size-s);
            font-weight: 500;
            cursor: pointer;
            transition: background-color var(--transition-fast);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: var(--shadow-1);
        }

        .btn:hover {
            background-color: var(--color-primary-dark);
            box-shadow: var(--shadow-2);
        }

        .btn i {
            margin-right: var(--spacing-s);
        }

        /* Search & Filters */
        .search-section {
            background-color: var(--surface);
            border-radius: var(--radius-m);
            box-shadow: var(--shadow-1);
            padding: var(--spacing-l);
            margin-bottom: var(--spacing-xl);
        }

        .search-input-wrapper {
            position: relative;
            margin-bottom: var(--spacing-l);
        }

        .search-icon {
            position: absolute;
            left: var(--spacing-m);
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
        }

        #searchInput {
            width: 100%;
            padding: var(--spacing-m) var(--spacing-m) var(--spacing-m) var(--spacing-xxl);
            border: 1px solid var(--divider);
            border-radius: var(--radius-m);
            font-size: var(--font-size-m);
            background-color: var(--surface);
            color: var(--text-primary);
            transition: box-shadow var(--transition-fast), border-color var(--transition-fast);
        }

        #searchInput:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(52, 47, 58, 0.2);
        }

        #searchInput::placeholder {
            color: var(--text-tertiary);
        }

        .filters-row {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-m);
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-label {
            display: block;
            font-size: var(--font-size-s);
            font-weight: 500;
            margin-bottom: var(--spacing-xs);
            color: var(--text-secondary);
        }

        select {
            width: 100%;
            padding: var(--spacing-s) var(--spacing-m);
            border: 1px solid var(--divider);
            border-radius: var(--radius-m);
            background-color: var(--surface);
            color: var(--text-primary);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23616161' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right var(--spacing-m) center;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(52, 47, 58, 0.2);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--spacing-s);
            margin-top: var(--spacing-xl);
        }

        .page-button {
            height: 36px;
            min-width: 36px;
            border: 1px solid var(--divider);
            background-color: var(--surface);
            color: var(--text-primary);
            border-radius: var(--radius-m);
            font-size: var(--font-size-s);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color var(--transition-fast), color var(--transition-fast);
        }

        .page-button.active {
            background-color: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .page-button:hover:not(.active):not(:disabled) {
            background-color: rgba(52, 47, 58, 0.1);
        }

        .page-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: var(--spacing-m);
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-normal), visibility var(--transition-normal);
        }

        .modal.open {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--surface);
            border-radius: var(--radius-l);
            box-shadow: var(--shadow-3);
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            transform: translateY(20px);
            transition: transform var(--transition-normal);
        }

        .modal.open .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            padding: var(--spacing-l);
            border-bottom: 1px solid var(--divider);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            background-color: var(--surface);
            z-index: 10;
        }

        .modal-title {
            font-size: var(--font-size-xl);
            font-weight: 600;
            color: var(--color-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-tertiary);
            font-size: var(--font-size-xl);
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-circle);
            transition: background-color var(--transition-fast);
        }

        .modal-close:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-primary);
        }

        .modal-body {
            padding: var(--spacing-l);
        }

        .modal-section {
            margin-bottom: var(--spacing-xl);
        }

        .modal-section-title {
            font-size: var(--font-size-l);
            font-weight: 600;
            margin-bottom: var(--spacing-m);
            color: var(--color-primary);
            padding-bottom: var(--spacing-xs);
            border-bottom: 1px solid var(--divider);
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            margin-top: var(--spacing-m);
            border-radius: var(--radius-m);
            box-shadow: var(--shadow-1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--surface);
        }

        th, td {
            padding: var(--spacing-m);
            text-align: left;
            border-bottom: 1px solid var(--divider);
        }

        th {
            font-weight: 600;
            color: var(--text-secondary);
            background-color: rgba(52, 47, 58, 0.05);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background-color: rgba(52, 47, 58, 0.03);
        }

        /* Value Formatting */
        .value-large {
            font-size: var(--font-size-l);
            font-weight: 600;
            color: var(--color-primary);
        }

        .chip {
            display: inline-block;
            background-color: rgba(52, 47, 58, 0.1);
            color: var(--text-primary);
            padding: var(--spacing-xs) var(--spacing-s);
            border-radius: var(--radius-l);
            font-size: var(--font-size-xs);
            margin-right: var(--spacing-xs);
            margin-bottom: var(--spacing-xs);
        }

        /* Loading State */
        .loading-container {
            padding: var(--spacing-xxl);
            text-align: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(52, 47, 58, 0.1);
            border-left-color: var(--color-primary);
            border-radius: 50%;
            animation: spinner 1s linear infinite;
            margin: 0 auto var(--spacing-l);
        }

        @keyframes spinner {
            to { transform: rotate(360deg); }
        }

        .no-results {
            text-align: center;
            padding: var(--spacing-xxl);
            color: var(--text-secondary);
            font-size: var(--font-size-l);
        }

        /* Error State */
        .error {
            background-color: #ffebee;
            color: #c62828;
            padding: var(--spacing-l);
            border-radius: var(--radius-m);
            margin-bottom: var(--spacing-l);
            display: flex;
            align-items: center;
        }

        .error i {
            font-size: var(--font-size-xl);
            margin-right: var(--spacing-m);
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .contractor-details {
                grid-template-columns: 1fr;
            }

            .filters-row {
                flex-direction: column;
                gap: var(--spacing-s);
            }

            .table-container {
                margin-left: calc(-1 * var(--spacing-m));
                margin-right: calc(-1 * var(--spacing-m));
                width: calc(100% + var(--spacing-m) * 2);
                border-radius: 0;
            }

            .pagination {
                flex-wrap: wrap;
            }

            .modal-content {
                max-height: 100vh;
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <h1>Federal Contractor Directory</h1>
            <p>Browse our database of federal prime contractors with active subcontracting plans</p>
        </div>
    </header>
    
    <main class="main-content">
        <div class="container">
            <section class="search-section">
                <div class="search-input-wrapper">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchInput" placeholder="Search by contractor name, NAICS, agency, etc.">
                </div>
                
                <div class="filters-row">
                    <div class="filter-group">
                        <label for="naicsFilter" class="filter-label">NAICS Code</label>
                        <select id="naicsFilter">
                            <option value="">All NAICS Codes</option>
                            <!-- Will be populated by JavaScript -->
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="agencyFilter" class="filter-label">Agency</label>
                        <select id="agencyFilter">
                            <option value="">All Agencies</option>
                            <!-- Will be populated by JavaScript -->
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="stateFilter" class="filter-label">State</label>
                        <select id="stateFilter">
                            <option value="">All States</option>
                            <!-- Will be populated by JavaScript -->
                        </select>
                    </div>
                </div>
            </section>
            
            <section id="contractorsContainer">
                <div class="loading-container">
                    <div class="spinner"></div>
                    <p>Loading contractors...</p>
                </div>
            </section>
            
            <div id="pagination" class="pagination"></div>
        </div>
    </main>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
        // JavaScript for the contractor directory
        document.addEventListener('DOMContentLoaded', function() {
            loadContractorData();
        });
        
        // Global variables
        let allContractors = [];
        let filteredContractors = [];
        let currentPage = 1;
        const contractorsPerPage = 10;
        
        // Load CSV data from S3
        async function loadContractorData() {
            try {
                // Define the S3 URL for the CSV file
                const S3_CSV_URL = 'https://subhoodata.s3.us-east-1.amazonaws.com/data/sba24.csv';
                
                // Fetch data from S3
                const response = await fetch(S3_CSV_URL);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch data: ${response.status} ${response.statusText}`);
                }
                
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        console.log("CSV data loaded successfully:", results.data.length, "rows");
                        processContractorData(results.data);
                    },
                    error: function(error) {
                        document.getElementById('contractorsContainer').innerHTML = `
                            <div class="error">
                                <i class="fas fa-exclamation-circle"></i>
                                <span>Error parsing CSV data: ${error.message}</span>
                            </div>
                        `;
                        console.error("CSV parsing error:", error);
                    }
                });
            } catch (error) {
                document.getElementById('contractorsContainer').innerHTML = `
                    <div class="error">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>Error loading data: ${error.message}</span>
                    </div>
                `;
                console.error("Data loading error:", error);
            }
        }
        
        // Process and display data
        function processContractorData(data) {
            // Aggregate by contractor
            const contractorsMap = {};
            
            data.forEach(contract => {
                const contractorName = contract['Legal Business Name'];
                if (!contractorName) return;
                
                if (!contractorsMap[contractorName]) {
                    contractorsMap[contractorName] = {
                        name: contractorName,
                        uei: contract['Unique Entity ID'],
                        contracts: [],
                        totalValue: 0,
                        naicsCodes: new Set(),
                        naicsDescriptions: new Map(),
                        agencies: new Set(),
                        locations: new Set()
                    };
                }
                
                // Add contract
                contractorsMap[contractorName].contracts.push(contract);
                
                // Update contractor stats
                const value = parseFloat(contract['Base and All Options Value (Total Contract Value)']) || 0;
                contractorsMap[contractorName].totalValue += value;
                
                if (contract['NAICS Code']) {
                    contractorsMap[contractorName].naicsCodes.add(contract['NAICS Code']);
                    
                    // Store NAICS description if available
                    if (contract['NAICS Description']) {
                        contractorsMap[contractorName].naicsDescriptions.set(
                            contract['NAICS Code'], 
                            contract['NAICS Description']
                        );
                    }
                }
                
                if (contract['Contracting Agency Name']) {
                    contractorsMap[contractorName].agencies.add(contract['Contracting Agency Name']);
                }
                
                if (contract['Principal Place of Performance State Code']) {
                    contractorsMap[contractorName].locations.add(contract['Principal Place of Performance State Code']);
                }
            });
            
            // Convert to array and sort by total value
            allContractors = Object.values(contractorsMap).sort((a, b) => b.totalValue - a.totalValue);
            
            // Initially show all contractors
            filteredContractors = [...allContractors];
            
            // Populate filters
            populateFilters(data);
            
            // Display first page
            displayContractors();
            
            // Set up event listeners for filters and search
            setupEventListeners();
        }
        
        // Populate filter dropdowns
        function populateFilters(data) {
            const naicsCodes = new Map();
            const agencies = new Set();
            const states = new Set();
            
            data.forEach(contract => {
                if (contract['NAICS Code'] && contract['NAICS Description']) {
                    naicsCodes.set(contract['NAICS Code'], contract['NAICS Description']);
                }
                
                if (contract['Contracting Agency Name']) {
                    agencies.add(contract['Contracting Agency Name']);
                }
                
                if (contract['Principal Place of Performance State Code']) {
                    states.add(contract['Principal Place of Performance State Code']);
                }
            });
            
            // Populate NAICS dropdown
            const naicsFilter = document.getElementById('naicsFilter');
            Array.from(naicsCodes.entries())
                .sort((a, b) => a[0] - b[0])
                .forEach(([code, description]) => {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = `${code} - ${description}`;
                    naicsFilter.appendChild(option);
                });
            
            // Populate agency dropdown
            const agencyFilter = document.getElementById('agencyFilter');
            Array.from(agencies)
                .sort()
                .forEach(agency => {
                    const option = document.createElement('option');
                    option.value = agency;
                    option.textContent = agency;
                    agencyFilter.appendChild(option);
                });
            
            // Populate state dropdown
            const stateFilter = document.getElementById('stateFilter');
            Array.from(states)
                .sort()
                .forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state;
                    stateFilter.appendChild(option);
                });
        }
        
        // Format currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                maximumFractionDigits: 0
            }).format(value);
        }
        
        // Display contractors with pagination
        function displayContractors() {
            const container = document.getElementById('contractorsContainer');
            
            // Calculate page range
            const startIndex = (currentPage - 1) * contractorsPerPage;
            const endIndex = Math.min(startIndex + contractorsPerPage, filteredContractors.length);
            
            // Create HTML
            let html = '';
            
            if (filteredContractors.length === 0) {
                html = `
                    <div class="no-results">
                        <i class="fas fa-search" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem; display: block;"></i>
                        <p>No contractors match your search criteria.</p>
                    </div>
                `;
            } else {
                // Add results summary
                html += `
                    <div style="margin-bottom: var(--spacing-l); color: var(--text-secondary);">
                        Showing ${startIndex + 1}-${endIndex} of ${filteredContractors.length} contractors
                    </div>
                `;
                
                // Add contractor cards
                for (let i = startIndex; i < endIndex; i++) {
                    const contractor = filteredContractors[i];
                    
                    // Get primary NAICS codes (top 3 by contract value)
                    const primaryNaicsCodes = getPrimaryNaicsCodes(contractor, 3);
                    
                    // Get top agencies (top 2)
                    const topAgencies = getTopAgencies(contractor, 2);
                    
                    html += `
                        <div class="contractor-card">
                            <h3>${contractor.name}</h3>
                            
                            <div class="contractor-details">
                                <div class="contractor-detail">
                                    <strong>Total Contract Value</strong>
                                    <span class="value-large">${formatCurrency(contractor.totalValue)}</span>
                                </div>
                                
                                <div class="contractor-detail">
                                    <strong>Contract Count</strong>
                                    <span>${contractor.contracts.length}</span>
                                </div>
                                
                                <div class="contractor-detail">
                                    <strong>Top Agencies</strong>
                                    <div>
                                        ${topAgencies.map(agency => `
                                            <span class="chip">${agency.name.length > 25 ? agency.name.substring(0, 25) + '...' : agency.name}</span>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <div class="contractor-detail">
                                    <strong>Performance Locations</strong>
                                    <div>
                                        ${Array.from(contractor.locations).slice(0, 5).map(location => `
                                            <span class="chip">${location}</span>
                                        `).join('')}
                                        ${contractor.locations.size > 5 ? `<span class="chip">+${contractor.locations.size - 5} more</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn view-details" data-contractor="${encodeURIComponent(contractor.name)}">
                                <i class="fas fa-search-plus"></i> View Details
                            </button>
                        </div>
                    `;
                }
            }
            
            container.innerHTML = html;
            
            // Create pagination
            createPagination();
            
            // Add event listeners to detail buttons
            document.querySelectorAll('.view-details').forEach(button => {
                button.addEventListener('click', function() {
                    const contractorName = decodeURIComponent(this.getAttribute('data-contractor'));
                    showContractorDetails(contractorName);
                });
            });
        }
        
        // Get primary NAICS codes for a contractor
        function getPrimaryNaicsCodes(contractor, limit) {
            // Create a map to track total value by NAICS code
            const naicsValues = new Map();
            
            // Calculate total value for each NAICS code
            contractor.contracts.forEach(contract => {
                const naicsCode = contract['NAICS Code'];
                if (!naicsCode) return;
                
                const value = parseFloat(contract['Base and All Options Value (Total Contract Value)']) || 0;
                naicsValues.set(naicsCode, (naicsValues.get(naicsCode) || 0) + value);
            });
            
            // Sort NAICS codes by value and get top ones
            return Array.from(naicsValues.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, limit)
                .map(([code, value]) => ({
                    code: code,
                    description: contractor.naicsDescriptions.get(code) || '',
                    value: value
                }));
        }
        
        // Get top agencies for a contractor
        function getTopAgencies(contractor, limit) {
            // Create a map to track total value by agency
            const agencyValues = new Map();
            
            // Calculate total value for each agency
            contractor.contracts.forEach(contract => {
                const agency = contract['Contracting Agency Name'];
                if (!agency) return;
                
                const value = parseFloat(contract['Base and All Options Value (Total Contract Value)']) || 0;
                agencyValues.set(agency, (agencyValues.get(agency) || 0) + value);
            });
            
            // Sort agencies by value and get top ones
            return Array.from(agencyValues.entries())
                .sort((a, b) => b[1] - a[1])
                .slice(0, limit)
                .map(([name, value]) => ({
                    name: name,
                    value: value
                }));
        }
        
        // Create pagination controls
        function createPagination() {
            const paginationDiv = document.getElementById('pagination');
            const totalPages = Math.ceil(filteredContractors.length / contractorsPerPage);
            
            let paginationHtml = '';
            
            // Previous button
            paginationHtml += `
                <button class="page-button" ${currentPage === 1 ? 'disabled' : ''} data-page="prev">
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;
            
            // Page numbers
            const maxPageButtons = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPageButtons / 2));
            let endPage = Math.min(totalPages, startPage + maxPageButtons - 1);
            
            if (endPage - startPage + 1 < maxPageButtons) {
                startPage = Math.max(1, endPage - maxPageButtons + 1);
            }
            
            if (startPage > 1) {
                paginationHtml += `
                    <button class="page-button" data-page="1">1</button>
                    ${startPage > 2 ? '<span class="page-button" style="border:none;">...</span>' : ''}
                `;
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHtml += `
                    <button class="page-button ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</button>
                `;
            }
            
            if (endPage < totalPages) {
                paginationHtml += `
                    ${endPage < totalPages - 1 ? '<span class="page-button" style="border:none;">...</span>' : ''}
                    <button class="page-button" data-page="${totalPages}">${totalPages}</button>
                `;
            }
            
            // Next button
            paginationHtml += `
                <button class="page-button" ${currentPage === totalPages ? 'disabled' : ''} data-page="next">
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;
            
            paginationDiv.innerHTML = paginationHtml;
            
            // Add event listeners to pagination buttons
            document.querySelectorAll('.page-button').forEach(button => {
                button.addEventListener('click', function() {
                    if (this.disabled || this.style.border === 'none') return;
                    
                    const page = this.getAttribute('data-page');
                    
                    if (page === 'prev') {
                        currentPage--;
                    } else if (page === 'next') {
                        currentPage++;
                    } else {
                        currentPage = parseInt(page);
                    }
                    
                    displayContractors();
                    window.scrollTo(0, 0);
                });
            });
        }
        
        // Show detailed contractor information
        function showContractorDetails(contractorName) {
            const contractor = allContractors.find(c => c.name === contractorName);
            
            if (!contractor) return;
            
            // Sort contracts by value
            const sortedContracts = [...contractor.contracts].sort((a, b) => {
                const valueA = parseFloat(a['Base and All Options Value (Total Contract Value)']) || 0;
                const valueB = parseFloat(b['Base and All Options Value (Total Contract Value)']) || 0;
                return valueB - valueA;
            });
            
            // Create a modal with detailed information
            const modal = document.createElement('div');
            modal.className = 'modal';
            
            // Create table rows for contracts
            let contractsHtml = '';
            sortedContracts.forEach(contract => {
                const value = parseFloat(contract['Base and All Options Value (Total Contract Value)']) || 0;
                
                contractsHtml += `
                    <tr>
                        <td>${contract['Procurement Instrument Identifier'] || 'N/A'}</td>
                        <td>${contract['Contracting Agency Name'] || 'N/A'}</td>
                        <td>${contract['NAICS Code'] || 'N/A'} - ${contract['NAICS Description'] || 'N/A'}</td>
                        <td>${formatCurrency(value)}</td>
                        <td>${formatDate(contract['Period of Performance Start Date'])} - ${formatDate(contract['Completion Date'])}</td>
                    </tr>
                `;
            });
            
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">${contractor.name}</h2>
                        <button class="modal-close" aria-label="Close">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="modal-body">
                        <div class="modal-section">
                            <div class="contractor-details">
                                <div class="contractor-detail">
                                    <strong>UEI</strong>
                                    <span>${contractor.uei || 'N/A'}</span>
                                </div>
                                
                                <div class="contractor-detail">
                                    <strong>Total Contract Value</strong>
                                    <span class="value-large">${formatCurrency(contractor.totalValue)}</span>
                                </div>
                                
                                <div class="contractor-detail">
                                    <strong>Contract Count</strong>
                                    <span>${contractor.contracts.length}</span>
                                </div>
                                
                                <div class="contractor-detail">
                                    <strong>NAICS Codes</strong>
                                    <div>
                                        ${Array.from(contractor.naicsCodes).map(code => `
                                            <span class="chip">${code}</span>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <div class="contractor-detail">
                                    <strong>Agencies</strong>
                                    <div>
                                        ${Array.from(contractor.agencies).map(agency => `
                                            <span class="chip">${agency}</span>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <div class="contractor-detail">
                                    <strong>Performance Locations</strong>
                                    <div>
                                        ${Array.from(contractor.locations).map(location => `
                                            <span class="chip">${location}</span>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="modal-section">
                            <h3 class="modal-section-title">Active Contracts (${contractor.contracts.length})</h3>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Contract ID</th>
                                            <th>Agency</th>
                                            <th>NAICS</th>
                                            <th>Value</th>
                                            <th>Period of Performance</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${contractsHtml}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Animate modal opening
            setTimeout(() => {
                modal.classList.add('open');
            }, 10);
            
            // Add event listener to close the modal
            modal.querySelector('.modal-close').addEventListener('click', closeModal);
            
            // Close modal when clicking outside content
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    closeModal();
                }
            });
            
            // Close modal function
            function closeModal() {
                modal.classList.remove('open');
                setTimeout(() => {
                    document.body.removeChild(modal);
                }, 300);
            }
            
            // Prevent body scrolling when modal is open
            document.body.style.overflow = 'hidden';
            
            // Restore body scrolling when modal is closed
            modal.addEventListener('transitionend', function(e) {
                if (e.propertyName === 'opacity' && !modal.classList.contains('open')) {
                    document.body.style.overflow = '';
                }
            });
        }
        
        // Helper function to format date
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            
            try {
                const date = new Date(dateStr);
                return new Intl.DateTimeFormat('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                }).format(date);
            } catch (e) {
                return dateStr;
            }
        }
        
        // Set up event listeners for search and filters
        function setupEventListeners() {
            const searchInput = document.getElementById('searchInput');
            const naicsFilter = document.getElementById('naicsFilter');
            const agencyFilter = document.getElementById('agencyFilter');
            const stateFilter = document.getElementById('stateFilter');
            
            // Function to apply all filters
            function applyFilters() {
                const searchTerm = searchInput.value.toLowerCase();
                const naicsCode = naicsFilter.value;
                const agency = agencyFilter.value;
                const state = stateFilter.value;
                
                filteredContractors = allContractors.filter(contractor => {
                    // Search term
                    if (searchTerm) {
                        const searchMatch = 
                            contractor.name.toLowerCase().includes(searchTerm) ||
                            Array.from(contractor.naicsCodes).some(code => code.toString().toLowerCase().includes(searchTerm)) ||
                            Array.from(contractor.agencies).some(a => a.toLowerCase().includes(searchTerm)) ||
                            contractor.contracts.some(c => c['NAICS Description']?.toLowerCase().includes(searchTerm));
                        
                        if (!searchMatch) return false;
                    }
                    
                    // NAICS filter
                    if (naicsCode && !contractor.naicsCodes.has(parseInt(naicsCode))) {
                        return false;
                    }
                    
                    // Agency filter
                    if (agency && !contractor.agencies.has(agency)) {
                        return false;
                    }
                    
                    // State filter
                    if (state && !contractor.locations.has(state)) {
                        return false;
                    }
                    
                    return true;
                });
                
                // Reset to first page and display
                currentPage = 1;
                displayContractors();
            }
            
            // Add event listeners with debounce for search
            let debounceTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(applyFilters, 300);
            });
            
            // Add change listeners for dropdowns
            naicsFilter.addEventListener('change', applyFilters);
            agencyFilter.addEventListener('change', applyFilters);
            stateFilter.addEventListener('change', applyFilters);
        }
    </script>
</body>
</html>