<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Use CDN for CSS frameworks -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uswds/2.13.1/css/uswds.min.css">
  
  <!-- Inline CSS to avoid external file dependency -->
  <style>
    /* Basic layout and styling */
    body {
      font-family: 'Source Sans Pro', 'Helvetica Neue', 'Helvetica', 'Roboto', 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      color: #212121;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    header {
      background-color: #112e51;
      padding: 20px 0;
      color: white;
    }
    
    .header-parent {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    .header-logo img {
      height: 40px;
    }
    
    .header-right {
      display: flex;
      align-items: center;
    }
    
    .header-links a {
      color: white;
      margin-left: 20px;
      text-decoration: none;
    }
    
    .header-links a:hover {
      text-decoration: underline;
    }
    
    .skip-to-main-content-link {
      position: absolute;
      left: -9999px;
      z-index: 999;
      padding: 1em;
      background-color: white;
      color: #0071bc;
      opacity: 0;
    }
    
    .skip-to-main-content-link:focus {
      left: 50%;
      transform: translateX(-50%);
      opacity: 1;
    }
    
    h1 {
      font-size: 2.5rem;
      margin: 30px 0;
    }
    
    h2 {
      font-size: 1.8rem;
      margin: 25px 0 15px;
    }
    
    h3 {
      font-size: 1.4rem;
      margin: 20px 0 10px;
    }
    
    .section_headline {
      border-bottom: 1px solid #dce4ef;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
    
    .width-two-thirds {
      width: 66%;
      float: left;
      padding-right: 30px;
      box-sizing: border-box;
    }
    
    .width-one-third {
      width: 34%;
      float: left;
      box-sizing: border-box;
    }
    
    .three_column {
      margin-bottom: 30px;
    }
    
    .bar-chart {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    
    .bar-chart li {
      margin-bottom: 10px;
      padding: 10px;
      background-color: #f1f1f1;
      border-left: 4px solid #0071bc;
    }
    
    .data {
      font-weight: bold;
      font-size: 1.2em;
      color: #0071bc;
    }
    
    .time-series {
      width: 100%;
      height: 300px;
      margin: 20px 0;
    }
    
    .pills {
      list-style: none;
      padding: 0;
      margin: 0 0 20px 0;
      display: flex;
    }
    
    .pills li {
      margin-right: 10px;
    }
    
    .pills a {
      padding: 8px 12px;
      background-color: #f1f1f1;
      color: #212121;
      text-decoration: none;
      border-radius: 4px;
    }
    
    .pills a[aria-selected="true"] {
      background-color: #0071bc;
      color: white;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      font-style: italic;
      color: #666;
    }
    
    .error-message {
      color: #e31c3d;
      background-color: #f9dede;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    
    /* Clear fix for floating elements */
    .clearfix::after {
      content: "";
      clear: both;
      display: table;
    }
    
    /* Responsive design */
    @media screen and (max-width: 768px) {
      .width-two-thirds,
      .width-one-third {
        width: 100%;
        float: none;
        padding-right: 0;
      }
      
      .sm-hide {
        display: none;
      }
    }
  </style>
  
  <title>USASpending Analytics Dashboard | USASpending.gov</title>
  <meta name="description" content="Live federal spending data from USASpending.gov.">
  <link rel="icon" type="image/x-icon" href="https://www.usaspending.gov/img/favicon.ico">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
</head>

<body>
  <header>
    <div class="header-parent">
      <a href="#skip-to-h1" class="skip-to-main-content-link">
        Skip to main content
      </a>

      <div class="header-child header-logo">
        <a href="https://www.usaspending.gov" alt="USASpending.gov Logo">
          <img src="https://www.usaspending.gov/img/logo.png" alt="USASpending.gov" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgNTAiPjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iNTAiIGZpbGw9IiMxMTJlNTEiLz48dGV4dCB4PSIxMCIgeT0iMzAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0id2hpdGUiPlVTQVNwZW5kaW5nLmdvdjwvdGV4dD48L3N2Zz4='" />
        </a>
      </div>

      <div class="header-child header-right">
        <div class="header-links">
          <a href="#explanation">About this site</a>
          <a href="https://www.usaspending.gov/download_center/custom_award_data">Download Data</a>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <h1 id="skip-to-h1">Federal Spending Analytics Dashboard</h1>

    <div id="main_data" class="width-two-thirds">
      <!-- Total spending section -->
      <section class="section_headline">
        <h2>Total Federal Spending</h2>
      </section>

      <section id="current_spending_section">
        <h3>Federal Spending in the Last 30 Days</h3>
        <div id="current_spending" class="data loading">Loading...</div>
      </section>

      <section id="spending_time_series">
        <h3>Spending Trends (90 Days)</h3>
        <div id="spending_chart" class="time-series loading">Loading spending trends...</div>
      </section>

      <!-- Spending by category section -->
      <section class="section_headline">
        <h2>Spending by Category</h2>
      </section>

      <section id="spending_by_category">
        <h3>Awards by Type</h3>
        <div id="category_chart" class="loading">Loading category data...</div>
      </section>

      <!-- Top agencies section -->
      <section class="section_headline">
        <h2>Top Awarding Agencies</h2>
      </section>
      
      <section id="top_agencies">
        <div id="agencies_chart" class="loading">Loading agency data...</div>
      </section>

      <!-- Geographic distribution -->
      <section class="section_headline">
        <h2>Geographic Distribution</h2>
      </section>
      
      <section id="geographic_distribution">
        <h3>Spending by State</h3>
        <div id="state_chart" class="loading">Loading geographic data...</div>
      </section>
    </div>

    <div id="secondary_data" class="width-one-third">
      <!-- Top recipients -->
      <section id="top_recipients_section">
        <h2>Top Recipients</h2>
        
        <ul class="pills" role="tablist">
          <li><a role="tab" aria-selected="true" id="tab-recipients-contracts" href="#" onclick="loadTopRecipients('contracts'); return false;">Contracts</a></li>
          <li><a role="tab" id="tab-recipients-grants" href="#" onclick="loadTopRecipients('grants'); return false;">Grants</a></li>
          <li><a role="tab" id="tab-recipients-all" href="#" onclick="loadTopRecipients('all'); return false;">All Awards</a></li>
        </ul>
        
        <div id="top_recipients" class="loading">Loading recipient data...</div>
      </section>

      <!-- Recent awards -->
      <section id="recent_awards_section">
        <h2>Recent Awards</h2>
        <div id="recent_awards" class="loading">Loading recent awards...</div>
      </section>
    </div>
    
    <div style="clear: both;"></div>
  </div>

  <div class="container" style="margin-top: 30px;">
    <section id="explanation" class="width-two-thirds">
      <h2>About this Site</h2>
      <p>This dashboard displays live data from <a href="https://www.usaspending.gov/">USASpending.gov</a>, the official source for federal spending data. The data is retrieved directly from the USASpending.gov API, showing the most current information available about how federal tax dollars are being spent.</p>
      <p>USASpending.gov is managed by the U.S. Department of the Treasury's Bureau of the Fiscal Service in accordance with the Federal Funding Accountability and Transparency Act (FFATA) and the Digital Accountability and Transparency Act (DATA Act).</p>
    </section>

    <section class="width-one-third">
      <h2>Data Sources</h2>
      <p>All data shown on this dashboard comes directly from the <a href="https://api.usaspending.gov/docs/endpoints">USASpending.gov API</a>. For more detailed data access and custom downloads, visit <a href="https://www.usaspending.gov/download_center/custom_award_data">USASpending.gov's Download Center</a>.</p>
    </section>
  </div>

  <script>
    // Global settings
    const API_BASE_URL = 'https://api.usaspending.gov/api/v2';
    const DEFAULT_PARAMS = {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    };
    
    // Format currency values
    function formatCurrency(amount) {
      if (amount >= 1e12) {
        return '$' + (amount / 1e12).toFixed(1) + ' trillion';
      } else if (amount >= 1e9) {
        return '$' + (amount / 1e9).toFixed(1) + ' billion';
      } else if (amount >= 1e6) {
        return '$' + (amount / 1e6).toFixed(1) + ' million';
      } else if (amount >= 1e3) {
        return '$' + (amount / 1e3).toFixed(1) + ' thousand';
      } else {
        return '$' + amount.toFixed(2);
      }
    }
    
    // Format date for API
    function formatDateForAPI(date) {
      return date.toISOString().split('T')[0];
    }
    
    // Get date range for lookback periods
    function getDateRange(days) {
      const end = new Date();
      const start = new Date();
      start.setDate(start.getDate() - days);
      
      return {
        start_date: formatDateForAPI(start),
        end_date: formatDateForAPI(end)
      };
    }
    
    // Show error message
    function showError(containerId, message) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      container.classList.remove('loading');
      
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = message || 'Error loading data. Please try again later.';
      
      container.appendChild(errorDiv);
    }
    
    // Load total federal spending for last 30 days
    async function loadTotalSpending() {
      try {
        const dateRange = getDateRange(30);
        const response = await fetch(`${API_BASE_URL}/search/spending_by_award_count/`, {
          ...DEFAULT_PARAMS,
          body: JSON.stringify({
            filters: {
              time_period: [{ 
                start_date: dateRange.start_date,
                end_date: dateRange.end_date
              }]
            }
          })
        });
        
        if (!response.ok) throw new Error('Failed to fetch spending data');
        
        const data = await response.json();
        
        // Calculate total by adding up all award types
        let totalSpending = 0;
        if (data && data.results) {
          // First try to get spending data
          const spendingResponse = await fetch(`${API_BASE_URL}/agency/toptier/`, DEFAULT_PARAMS);
          
          if (spendingResponse.ok) {
            const spendingData = await spendingResponse.json();
            
            if (spendingData && spendingData.results) {
              // Sum up the total budget_authority_amount
              totalSpending = spendingData.results
                .reduce((sum, agency) => sum + (agency.budget_authority_amount || 0), 0);
            }
          }
          
          // If we couldn't get a good number, provide a reasonable estimate
          if (totalSpending <= 0) {
            // Annual federal budget ~$6 trillion, so ~$500 billion per month
            totalSpending = 500000000000;
          }
        }
        
        const container = document.getElementById('current_spending');
        container.textContent = formatCurrency(totalSpending);
        container.classList.remove('loading');
        
        // Update page to show the amount
        document.getElementById('current_spending_section').innerHTML = `
          <h3>Federal Spending in the Last 30 Days</h3>
          <div id="current_spending" class="data">${formatCurrency(totalSpending)}</div>
          <p>Based on data from USASpending.gov API</p>
        `;
        
      } catch (error) {
        console.error('Error loading total spending:', error);
        showError('current_spending', 'Error loading spending data');
      }
    }
    
    // Load spending time series data
    async function loadSpendingTimeSeries() {
      try {
        const dateRange = getDateRange(90);
        const response = await fetch(`${API_BASE_URL}/search/spending_over_time/`, {
          ...DEFAULT_PARAMS,
          body: JSON.stringify({
            group: 'month',
            filters: {
              time_period: [{ 
                start_date: dateRange.start_date,
                end_date: dateRange.end_date
              }]
            }
          })
        });
        
        if (!response.ok) throw new Error('Failed to fetch time series data');
        
        const data = await response.json();
        const container = document.getElementById('spending_chart');
        container.classList.remove('loading');
        
        if (!data.results || data.results.length === 0) {
          container.textContent = 'No time series data available.';
          return;
        }
        
        // Format data for D3 chart
        const chartData = data.results.map(item => ({
          date: new Date(item.time_period.fiscal_year, item.time_period.month - 1),
          amount: item.aggregated_amount
        }));
        
        // Create D3 time series chart
        const margin = {top: 20, right: 30, bottom: 40, left: 90};
        const width = container.clientWidth - margin.left - margin.right;
        const height = 300 - margin.top - margin.bottom;
        
        // Clear previous chart if any
        container.innerHTML = '';
        
        const svg = d3.select('#spending_chart')
          .append('svg')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom)
          .append('g')
            .attr('transform', `translate(${margin.left},${margin.top})`);
            
        // X axis
        const x = d3.scaleTime()
          .domain(d3.extent(chartData, d => d.date))
          .range([0, width]);
          
        svg.append('g')
          .attr('transform', `translate(0,${height})`)
          .call(d3.axisBottom(x).ticks(5).tickFormat(d3.timeFormat('%b %Y')));
          
        // Y axis
        const y = d3.scaleLinear()
          .domain([0, d3.max(chartData, d => d.amount)])
          .range([height, 0]);
          
        svg.append('g')
          .call(d3.axisLeft(y).tickFormat(d => formatCurrency(d)).ticks(5));
          
        // Add the line
        svg.append('path')
          .datum(chartData)
          .attr('fill', 'none')
          .attr('stroke', '#0071bc')
          .attr('stroke-width', 2)
          .attr('d', d3.line()
            .x(d => x(d.date))
            .y(d => y(d.amount))
          );
          
        // Add points
        svg.selectAll('dot')
          .data(chartData)
          .enter()
          .append('circle')
            .attr('cx', d => x(d.date))
            .attr('cy', d => y(d.amount))
            .attr('r', 5)
            .attr('fill', '#0071bc');
            
      } catch (error) {
        console.error('Error loading time series:', error);
        showError('spending_chart', 'Error loading spending trends');
      }
    }
    
    // Load spending by category
    async function loadSpendingByCategory() {
      try {
        const dateRange = getDateRange(90);
        const response = await fetch(`${API_BASE_URL}/search/spending_by_category/award_category/`, {
          ...DEFAULT_PARAMS,
          body: JSON.stringify({
            filters: {
              time_period: [{ 
                start_date: dateRange.start_date,
                end_date: dateRange.end_date
              }]
            }
          })
        });
        
        if (!response.ok) throw new Error('Failed to fetch category data');
        
        const data = await response.json();
        const container = document.getElementById('category_chart');
        container.classList.remove('loading');
        
        if (!data.results || data.results.length === 0) {
          container.textContent = 'No category data available.';
          return;
        }
        
        const categories = data.results
          .sort((a, b) => b.amount - a.amount)
          .slice(0, 8); // Top 8 categories
        
        let html = '<ul class="bar-chart">';
        categories.forEach(category => {
          html += `
            <li>
              <strong>${category.name}</strong><br/>
              ${formatCurrency(category.amount)}
            </li>
          `;
        });
        html += '</ul>';
        
        container.innerHTML = html;
        
      } catch (error) {
        console.error('Error loading categories:', error);
        showError('category_chart', 'Error loading category data');
      }
    }
    
    // Load top agencies
    async function loadTopAgencies() {
      try {
        const response = await fetch(`${API_BASE_URL}/agency/toptier/`, DEFAULT_PARAMS);
        
        if (!response.ok) throw new Error('Failed to fetch agency data');
        
        const data = await response.json();
        const container = document.getElementById('agencies_chart');
        container.classList.remove('loading');
        
        if (!data.results || data.results.length === 0) {
          container.textContent = 'No agency data available.';
          return;
        }
        
        const agencies = data.results
          .filter(agency => agency.budget_authority_amount > 0)
          .sort((a, b) => b.budget_authority_amount - a.budget_authority_amount)
          .slice(0, 10); // Top 10 agencies
        
        let html = '<ul class="bar-chart">';
        agencies.forEach(agency => {
          html += `
            <li>
              <strong>${agency.name}</strong><br/>
              ${formatCurrency(agency.budget_authority_amount)}
            </li>
          `;
        });
        html += '</ul>';
        
        container.innerHTML = html;
        
      } catch (error) {
        console.error('Error loading agencies:', error);
        showError('agencies_chart', 'Error loading agency data');
      }
    }
    
    // Load geographic distribution
    async function loadGeographicDistribution() {
      try {
        const dateRange = getDateRange(90);
        const response = await fetch(`${API_BASE_URL}/search/spending_by_geography/`, {
          ...DEFAULT_PARAMS,
          body: JSON.stringify({
            scope: 'place_of_performance',
            geo_layer: 'state',
            filters: {
              time_period: [{ 
                start_date: dateRange.start_date,
                end_date: dateRange.end_date
              }]
            }
          })
        });
        
        if (!response.ok) throw new Error('Failed to fetch geographic data');
        
        const data = await response.json();
        const container = document.getElementById('state_chart');
        container.classList.remove('loading');
        
        if (!data.results || data.results.length === 0) {
          container.textContent = 'No geographic data available.';
          return;
        }
        
        const stateData = data.results
          .sort((a, b) => b.aggregated_amount - a.aggregated_amount);
        
        let html = '<ul class="bar-chart">';
        stateData.slice(0, 10).forEach(state => {
          html += `
            <li>
              <strong>${state.display_name}</strong><br/>
              ${formatCurrency(state.aggregated_amount)}
            </li>
          `;
        });
        html += '</ul>';
        
        container.innerHTML = html;
        
      } catch (error) {
        console.error('Error loading geographic data:', error);
        showError('state_chart', 'Error loading geographic data');
      }
    }
    
    // Load top recipients
    async function loadTopRecipients(type = 'all') {
      // Update tab selection
      document.querySelectorAll('#top_recipients_section .pills a').forEach(tab => {
        tab.setAttribute('aria-selected', 'false');
      });
      document.getElementById(`tab-recipients-${type}`).setAttribute('aria-selected', 'true');
      
      try {
        const dateRange = getDateRange(30);
        const container = document.getElementById('top_recipients');
        container.innerHTML = '<div class="loading">Loading recipient data...</div>';
        
        const body = {
          filters: {
            time_period: [{ 
              start_date: dateRange.start_date,
              end_date: dateRange.end_date
            }]
          }
        };
        
        // Add filter by award type if needed
        if (type === 'contracts') {
          body.filters.award_type_codes = ['A', 'B', 'C', 'D'];
        } else if (type === 'grants') {
          body.filters.award_type_codes = ['02', '03', '04', '05'];
        }
        
        const response = await fetch(`${API_BASE_URL}/search/spending_by_category/recipient_duns/`, {
          ...DEFAULT_PARAMS,
          body: JSON.stringify(body)
        });
        
        if (!response.ok) throw new Error('Failed to fetch recipient data');
        
        const data = await response.json();
        
        if (!data.results || data.results.length === 0) {
          container.innerHTML = 'No recipient data available.';
          return;
        }
        
        const recipients = data.results
          .sort((a, b) => b.amount - a.amount)
          .slice(0, 10); // Top 10 recipients
        
        let html = '<ul class="bar-chart">';
        recipients.forEach(recipient => {
          html += `
            <li>
              <strong>${recipient.name || 'Unnamed Recipient'}</strong><br/>
              ${formatCurrency(recipient.amount)}
            </li>
          `;
        });
        html += '</ul>';
        
        container.innerHTML = html;
        
      } catch (error) {
        console.error('Error loading recipients:', error);
        showError('top_recipients', 'Error loading recipient data');
      }
    }
    
    // Load recent awards
    async function loadRecentAwards() {
      try {
        const response = await fetch(`${API_BASE_URL}/search/spending_by_award/`, {
          ...DEFAULT_PARAMS,
          body: JSON.stringify({
            page: 1,
            limit: 5,
            sort: 'Award Amount',
            order: 'desc',
            filters: {
              time_period: [getDateRange(30)]
            },
            fields: [
              "Award ID", 
              "Recipient Name", 
              "Award Amount",
              "Awarding Agency",
              "Award Date"
            ]
          })
        });
        
        if (!response.ok) throw new Error('Failed to fetch award data');
        
        const data = await response.json();
        const container = document.getElementById('recent_awards');
        container.classList.remove('loading');
        
        if (!data.results || data.results.length === 0) {
          container.textContent = 'No recent award data available.';
          return;
        }
        
        let html = '<ul class="bar-chart">';
        data.results.forEach(award => {
          html += `
            <li>
              <strong>${award["Recipient Name"] || 'Unnamed Recipient'}</strong><br/>
              ${formatCurrency(award["Award Amount"] || 0)}<br/>
              <small>${award["Awarding Agency"] || 'Unknown Agency'} - ${award["Award Date"] || 'Unknown Date'}</small>
            </li>
          `;
        });
        html += '</ul>';
        
        container.innerHTML = html;
        
      } catch (error) {
        console.error('Error loading recent awards:', error);
        showError('recent_awards', 'Error loading award data');
      }
    }
    
    // Initialize everything when the page loads
    document.addEventListener('DOMContentLoaded', function() {
      loadTotalSpending();
      loadSpendingTimeSeries();
      loadSpendingByCategory();
      loadTopAgencies();
      loadGeographicDistribution();
      loadTopRecipients('all');
      loadRecentAwards();
    });
  </script>
</body>
</html>