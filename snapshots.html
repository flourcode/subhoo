<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Federal Agency Snapshot Generator</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; max-width: 900px; margin: auto; background: #f9f9f9; }
    h2, h3 { color: #2b3e50; }
    .section { margin-bottom: 2rem; background: #fff; padding: 1.5rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    ul { padding-left: 1.2rem; }
    li { margin-bottom: 0.5rem; }
    .loading { color: #555; font-style: italic; }
    .error { color: #d9534f; }
    .api-info { font-size: 0.85rem; color: #666; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #eee; }
    .date-info { font-size: 0.9rem; color: #666; margin-bottom: 1rem; }
    .header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 1rem; }
    .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
    .status-indicator.loading { background-color: #f0ad4e; }
    .status-indicator.success { background-color: #5cb85c; }
    .status-indicator.error { background-color: #d9534f; }
    .status-text { font-size: 0.8rem; color: #777; }
    .header-right { text-align: right; }
    .controls { 
      background: #fff; 
      padding: 1rem; 
      border-radius: 8px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      margin-bottom: 1.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
    }
    .control-group {
      display: flex;
      flex-direction: column;
      min-width: 200px;
    }
    .control-group label {
      font-size: 0.8rem;
      color: #555;
      margin-bottom: 0.25rem;
    }
    select {
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: white;
      font-size: 0.9rem;
    }
    .btn { 
      background-color: #5bc0de; 
      color: white; 
      border: none; 
      padding: 0.5rem 1rem; 
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 0.9rem;
      height: fit-content;
      align-self: flex-end;
    }
    .btn:hover { background-color: #46b8da; }
    .agency-title {
      font-size: 1.2rem;
      margin-top: 0;
      color: #2b3e50;
    }
    .title-area {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .fiscal-year {
      font-size: 0.9rem;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="header">
    <h2>ðŸ“Š Federal Agency Snapshot Generator</h2>
    <div class="header-right">
      <div class="status">
        <span class="status-indicator" id="status-indicator"></span>
        <span class="status-text" id="status-text">Select an agency</span>
      </div>
      <div class="date-info" id="date-info">Data will load after selection</div>
    </div>
  </div>

  <div class="controls">
    <div class="control-group">
      <label for="agency-select">Select Agency:</label>
      <select id="agency-select">
        <option value="" selected disabled>Loading agencies...</option>
      </select>
    </div>
    <div class="control-group" id="subagency-container" style="display: none;">
      <label for="subagency-select">Select Sub-Agency:</label>
      <select id="subagency-select">
        <option value="" selected disabled>Select an agency first</option>
      </select>
    </div>
    <button id="load-data-btn" class="btn" disabled>Load Data</button>
  </div>

  <div class="title-area">
    <h3 class="agency-title" id="agency-title">Select an agency to view data</h3>
    <span class="fiscal-year">FY24â€“FY25</span>
  </div>

  <div id="summary" class="section">
    <h3>Total Obligations</h3>
    <p id="total">Select an agency to load data</p>
  </div>

  <div class="section">
    <h3>Top 5 Prime Recipients</h3>
    <ul id="top-recipients">
      <li>Select an agency to load data</li>
    </ul>
  </div>

  <div class="section">
    <h3>Top 5 NAICS Codes</h3>
    <ul id="top-naics">
      <li>Select an agency to load data</li>
    </ul>
  </div>

  <div class="section">
    <h3>Top 5 Awarding Offices</h3>
    <ul id="top-offices">
      <li>Select an agency to load data</li>
    </ul>
  </div>

  <div class="api-info">
    <p>Data provided by the <a href="https://api.usaspending.gov/docs/endpoints" target="_blank">USAspending.gov API</a>.</p>
  </div>

  <script>
    // Date range for FY24-FY25
    const TIME_PERIOD = [{ start_date: "2023-10-01", end_date: "2025-09-30" }];
    
    // Common major agencies with their toptier codes
    const COMMON_AGENCIES = [
      { name: "Department of Defense", code: "097" },
      { name: "Department of Health and Human Services", code: "075" },
      { name: "Department of Homeland Security", code: "070" },
      { name: "Department of Veterans Affairs", code: "036" },
      { name: "Department of Treasury", code: "020" },
      { name: "Department of Education", code: "091" },
      { name: "Department of Transportation", code: "069" },
      { name: "Department of Justice", code: "015" },
      { name: "Department of Agriculture", code: "012" },
      { name: "Department of Energy", code: "089" },
      { name: "Department of State", code: "019" },
      { name: "Department of Housing and Urban Development", code: "086" },
      { name: "Department of Labor", code: "016" },
      { name: "Department of Commerce", code: "013" },
      { name: "Department of the Interior", code: "014" },
      { name: "Environmental Protection Agency", code: "068" },
      { name: "National Aeronautics and Space Administration", code: "080" },
      { name: "Small Business Administration", code: "073" },
      { name: "Social Security Administration", code: "028" },
      { name: "General Services Administration", code: "047" }
    ];
    
    // UI Elements
    const agencySelect = document.getElementById('agency-select');
    const subagencySelect = document.getElementById('subagency-select');
    const subagencyContainer = document.getElementById('subagency-container');
    const loadDataBtn = document.getElementById('load-data-btn');
    const agencyTitle = document.getElementById('agency-title');
    
    // Current selection
    let selectedAgency = null;
    let selectedSubagency = null;
    
    // Update status indicators
    function updateStatus(status, message) {
      const indicator = document.getElementById('status-indicator');
      const text = document.getElementById('status-text');
      
      indicator.className = 'status-indicator ' + status;
      text.textContent = message;
      
      // Update date info
      if (status === 'success') {
        const now = new Date();
        document.getElementById('date-info').textContent = 'As of: ' + now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
      }
    }
    
    // Handle API errors
    function handleError(section, error) {
      console.error(`Error in ${section}:`, error);
      const element = document.getElementById(section === 'total' ? 'total' : `top-${section}`);
      element.className = 'error';
      element.innerHTML = `Error loading data: ${error.message || 'API request failed'}`;
      updateStatus('error', 'Some data failed to load');
    }
    
    // Initialize agency dropdown
    function initAgencyDropdown() {
      // Clear existing options
      agencySelect.innerHTML = '';
      
      // Add default option
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.disabled = true;
      defaultOption.selected = true;
      defaultOption.textContent = 'Select an agency';
      agencySelect.appendChild(defaultOption);
      
      // Add agency options
      COMMON_AGENCIES.forEach(agency => {
        const option = document.createElement('option');
        option.value = agency.code;
        option.textContent = agency.name;
        agencySelect.appendChild(option);
      });
      
      // Enable the select
      agencySelect.disabled = false;
    }
    
    // Fetch sub-agencies for a top-tier agency
    async function fetchSubagencies(toptierCode) {
      try {
        updateStatus('loading', 'Loading sub-agencies...');
        
        const res = await fetch(`https://api.usaspending.gov/api/v2/agency/${toptierCode}/sub_agency/`, {
          method: "GET",
          headers: { "Content-Type": "application/json" }
        });
        
        if (!res.ok) {
          throw new Error(`HTTP error! Status: ${res.status}`);
        }
        
        const data = await res.json();
        
        // Clear existing options
        subagencySelect.innerHTML = '';
        
        // Add default option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'View entire agency';
        subagencySelect.appendChild(defaultOption);
        
        if (data && data.results && data.results.length > 0) {
          // Add all sub-agencies
          data.results.forEach(subagency => {
            const option = document.createElement('option');
            option.value = subagency.name; // Using name as the subagency identifier
            option.textContent = subagency.name;
            subagencySelect.appendChild(option);
          });
          
          // Show the subagency dropdown
          subagencyContainer.style.display = 'flex';
        } else {
          // Hide the dropdown if no subagencies
          subagencyContainer.style.display = 'none';
        }
        
        updateStatus('success', 'Ready to load data');
        loadDataBtn.disabled = false;
        
      } catch (error) {
        console.error('Error fetching subagencies:', error);
        updateStatus('error', 'Failed to load sub-agencies');
        subagencyContainer.style.display = 'none';
        loadDataBtn.disabled = false; // Still allow data loading for main agency
      }
    }

    // Fetch total obligations
    async function fetchTotals() {
      try {
        const agencyFilter = {
          type: "awarding",
          tier: "toptier",
          toptier_code: selectedAgency
        };
        
        // Add subagency if selected
        if (selectedSubagency) {
          agencyFilter.name = selectedSubagency;
        }
        
        const res = await fetch("https://api.usaspending.gov/api/v2/search/spending_by_award/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            filters: {
              time_period: TIME_PERIOD,
              award_type_codes: ["A", "B", "C", "D"],
              agencies: [agencyFilter]
            },
            fields: ["Award ID", "Recipient Name", "Award Amount", "Action Date"],
            limit: 1,
            page: 1
          })
        });
        
        if (!res.ok) {
          throw new Error(`HTTP error! Status: ${res.status}`);
        }
        
        const result = await res.json();
        const element = document.getElementById("total");
        
        if (result && result.page_metadata && result.page_metadata.total) {
          const totalAmount = parseFloat(result.page_metadata.total);
          element.textContent = `$${totalAmount.toLocaleString()}`;
          element.className = '';
        } else {
          element.textContent = "No data available";
          element.className = '';
        }
        
        return true;
      } catch (error) {
        handleError('total', error);
        return false;
      }
    }

    // Fetch recipient data
    async function fetchRecipients() {
      try {
        const agencyFilter = {
          type: "awarding",
          tier: "toptier",
          toptier_code: selectedAgency
        };
        
        // Add subagency if selected
        if (selectedSubagency) {
          agencyFilter.name = selectedSubagency;
        }
        
        const res = await fetch("https://api.usaspending.gov/api/v2/search/spending_by_category/recipient/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            filters: {
              time_period: TIME_PERIOD,
              award_type_codes: ["A", "B", "C", "D"],
              agencies: [agencyFilter]
            },
            limit: 5
          })
        });
        
        if (!res.ok) {
          throw new Error(`HTTP error! Status: ${res.status}`);
        }

        const json = await res.json();
        const ul = document.getElementById("top-recipients");
        ul.innerHTML = "";
        ul.className = '';

        if (!json || !json.results || json.results.length === 0) {
          ul.innerHTML = "<li>No data available</li>";
          return false;
        }

        json.results.forEach(item => {
          const li = document.createElement("li");
          li.textContent = `${item.name || 'Unnamed'} â€“ $${parseFloat(item.amount || 0).toLocaleString()}`;
          ul.appendChild(li);
        });
        
        return true;
      } catch (error) {
        handleError('recipients', error);
        return false;
      }
    }

    // Fetch NAICS data
    async function fetchNaics() {
      try {
        const agencyFilter = {
          type: "awarding",
          tier: "toptier",
          toptier_code: selectedAgency
        };
        
        // Add subagency if selected
        if (selectedSubagency) {
          agencyFilter.name = selectedSubagency;
        }
        
        const res = await fetch("https://api.usaspending.gov/api/v2/search/spending_by_category/naics/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            filters: {
              time_period: TIME_PERIOD,
              award_type_codes: ["A", "B", "C", "D"],
              agencies: [agencyFilter]
            },
            limit: 5
          })
        });
        
        if (!res.ok) {
          throw new Error(`HTTP error! Status: ${res.status}`);
        }

        const json = await res.json();
        const ul = document.getElementById("top-naics");
        ul.innerHTML = "";
        ul.className = '';

        if (!json || !json.results || json.results.length === 0) {
          ul.innerHTML = "<li>No data available</li>";
          return false;
        }

        json.results.forEach(item => {
          const name = item.name || item.naics_description || 'Unnamed NAICS';
          const code = item.code || item.naics || '';
          const displayName = code ? `${code} - ${name}` : name;
          const li = document.createElement("li");
          li.textContent = `${displayName} â€“ $${parseFloat(item.amount || 0).toLocaleString()}`;
          ul.appendChild(li);
        });
        
        return true;
      } catch (error) {
        handleError('naics', error);
        return false;
      }
    }

    // Fetch awarding offices
    async function fetchOffices() {
      try {
        const agencyFilter = {
          type: "awarding",
          tier: "toptier",
          toptier_code: selectedAgency
        };
        
        // Add subagency if selected
        if (selectedSubagency) {
          agencyFilter.name = selectedSubagency;
        }
        
        const res = await fetch("https://api.usaspending.gov/api/v2/search/spending_by_category/awarding_subagency/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            filters: {
              time_period: TIME_PERIOD,
              award_type_codes: ["A", "B", "C", "D"],
              agencies: [agencyFilter]
            },
            limit: 5
          })
        });
        
        if (!res.ok) {
          throw new Error(`HTTP error! Status: ${res.status}`);
        }

        const json = await res.json();
        const ul = document.getElementById("top-offices");
        ul.innerHTML = "";
        ul.className = '';

        if (!json || !json.results || json.results.length === 0) {
          ul.innerHTML = "<li>No data available</li>";
          return false;
        }

        json.results.forEach(item => {
          const li = document.createElement("li");
          li.textContent = `${item.name || 'Unnamed Office'} â€“ $${parseFloat(item.amount || 0).toLocaleString()}`;
          ul.appendChild(li);
        });
        
        return true;
      } catch (error) {
        handleError('offices', error);
        return false;
      }
    }

    // Load data based on current selection
    async function loadData() {
      // Update title
      const agencyName = agencySelect.options[agencySelect.selectedIndex].textContent;
      let titleText = agencyName;
      
      if (selectedSubagency) {
        titleText += ` - ${selectedSubagency}`;
      }
      
      agencyTitle.textContent = titleText;
      
      // Reset data sections
      document.getElementById("total").textContent = "Loading...";
      document.getElementById("total").className = "loading";
      
      document.getElementById("top-recipients").innerHTML = "<li>Loading...</li>";
      document.getElementById("top-recipients").className = "loading";
      
      document.getElementById("top-naics").innerHTML = "<li>Loading...</li>";
      document.getElementById("top-naics").className = "loading";
      
      document.getElementById("top-offices").innerHTML = "<li>Loading...</li>";
      document.getElementById("top-offices").className = "loading";
      
      updateStatus('loading', 'Loading agency data...');
      loadDataBtn.disabled = true;
      
      try {
        // Start all fetches in parallel
        const results = await Promise.all([
          fetchTotals(),
          fetchRecipients(),
          fetchNaics(),
          fetchOffices()
        ]);
        
        // Check if all requests were successful
        if (results.every(result => result)) {
          updateStatus('success', 'Data loaded successfully');
        } else {
          updateStatus('error', 'Some data failed to load');
        }
      } catch (error) {
        console.error('Error loading data:', error);
        updateStatus('error', 'Failed to load data');
      } finally {
        loadDataBtn.disabled = false;
      }
    }

    // Set up event listeners
    agencySelect.addEventListener('change', function() {
      selectedAgency = this.value;
      selectedSubagency = null;
      
      if (selectedAgency) {
        // Try to fetch subagencies
        fetchSubagencies(selectedAgency);
      } else {
        subagencyContainer.style.display = 'none';
        loadDataBtn.disabled = true;
      }
    });
    
    subagencySelect.addEventListener('change', function() {
      selectedSubagency = this.value || null;
    });
    
    loadDataBtn.addEventListener('click', loadData);

    // Initialize the agency dropdown when page loads
    window.addEventListener('load', function() {
      initAgencyDropdown();
      updateStatus('', 'Select an agency to view data');
    });
  </script>
</body>
</html>