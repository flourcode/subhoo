<!DOCTYPE html>
<html lang="en" class=""> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamlined Federal Business Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
	<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

<!-- MarkerCluster -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <style>
        :root {
            font-family: Inter, sans-serif;
            font-feature-settings: 'liga' 1, 'calt' 1;

            /* 5-Color Palette */
            --ice-cold: #a0d2eb;
            --freeze-purple: #ffffff;
            --medium-purple: #d0bdf4;
            --purple-pain: #8458B3;
            --heavy-purple: #a28089;

            /* Light Mode Colors (Using the palette) */
            --background: var(--freeze-purple);
            --on-accent: #ffffff;
            --accent: var(--purple-pain);
            --accent-secondary: rgba(132, 88, 179, 0.15);
            --gradient-bg-start: rgba(132, 88, 179, 0.08);
            --gradient-bg-end: rgba(132, 88, 179, 0);
            --text-primary: #272727;
            --text-secondary: #272727;
            --text-tertiary: #272727;
            --border-level-1: rgba(160, 210, 235, 0.3);
            --border-level-2: rgba(160, 210, 235, 0.5);
            --border-level-3: rgba(160, 210, 235, 0.8);
            --surface-level-1: rgba(229, 234, 245, 0.8);
            --surface-level-2: rgba(208, 189, 244, 0.15);
            --surface-level-3: rgba(208, 189, 244, 0.3);

            /* Chart Colors */
            --chart-accent-1: var(--purple-pain);
            --chart-accent-2: var(--ice-cold);
            --chart-accent-3: var(--medium-purple);
            --chart-accent-4: var(--heavy-purple);
            --chart-accent-5: #b4a7d6;

            /* General variables */
            --header-font-weight: 600;
            --button-font-weight: 500;
            --space-m: 12px; 
        }
        html.dark {
            /* Dark Mode Colors */
            --background: #1a202c;
            --on-accent: #ffffff; 
            --accent: var(--purple-pain);
            --accent-secondary: rgba(132, 88, 179, 0.3);
            --gradient-bg-start: rgba(132, 88, 179, 0.12);
            --gradient-bg-end: rgba(132, 88, 179, 0);
            --text-primary: var(--freeze-purple);
            --text-secondary: var(--ice-cold);
            --text-tertiary: var(--medium-purple);
            --border-level-1: rgba(160, 210, 235, 0.2);
            --border-level-2: rgba(160, 210, 235, 0.3);
            --border-level-3: rgba(160, 210, 235, 0.5);
            --surface-level-1: #2d3748;
            --surface-level-2: #374151; 
            --surface-level-3: #4a5568;

            /* Chart Specific Dark Mode Colors */
            --chart-accent-1: var(--purple-pain);
            --chart-accent-2: var(--ice-cold);
            --chart-accent-3: var(--medium-purple);
            --chart-accent-4: var(--heavy-purple);
            --chart-accent-5: #b4a7d6;
        }

        body {
            background-color: var(--background);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .chart-container {
            position: relative;
            height: 300px; 
            width: 100%;
        }
        .chart-no-data {
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-primary); 
            background-color: var(--surface-level-1); 
            border: 1px dashed var(--border-level-2); 
            border-radius: 0.375rem; 
            text-align: center;
            padding: 1rem;
        }
        .chart-no-data svg { 
            width: 3rem; 
            height: 3rem; 
            margin-bottom: 0.5rem; 
            color: var(--text-tertiary); 
        }
        .spinner { 
            border: 4px solid var(--surface-level-3);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: var(--accent); 
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .calendar-day-header {
            font-weight: var(--header-font-weight);
            text-align: center;
            padding: 5px 0;
            background-color: var(--accent); 
            color: var(--on-accent);
            border-radius: 4px;
        }
        .calendar-event {
            padding: 3px 5px;
            background-color: var(--accent); 
            color: var(--on-accent);
            border-radius: 3px;
            margin-bottom: 3px;
            font-size: 0.6875rem; 
            cursor: default; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        html.dark .calendar-event {
            background-color: var(--accent);
        }
        .calendar-day-cell {
            cursor: pointer;
            transition: background-color 0.2s;
            min-width: 60px; 
            border-color: var(--border-level-1);
            background-color: var(--background);
        }

        /* For actual numbered empty days */
        .calendar-day-cell.bg-white { 
            background-color: var(--surface-level-1) !important; 
        }
        html.dark .calendar-day-cell.bg-white { 
            background-color: var(--surface-level-1) !important;
        }
        
        /* For FILLER days at the start/end of the month grid */
        .calendar-day-cell.bg-gray-50 { 
            background-color: var(--surface-level-1) !important;
        }
        html.dark .calendar-day-cell.bg-gray-50 {
            background-color: var(--surface-level-1) !important;
        }
        
        /* Event day styles - All densities now use the same color */
        .calendar-day-cell.bg-blue-50,
        .calendar-day-cell.bg-blue-100,
        .calendar-day-cell.bg-blue-200 { 
            background-color: var(--accent-secondary) !important;
        } 
        html.dark .calendar-day-cell.bg-blue-50,
        html.dark .calendar-day-cell.bg-blue-100,
        html.dark .calendar-day-cell.bg-blue-200 { 
            background-color: var(--accent-secondary) !important;
        } 

        .calendar-day-cell:hover:not(.bg-gray-50) {
            background-color: var(--medium-purple) !important; 
        }
        html.dark .calendar-day-cell:hover:not(.bg-gray-50) {
            background-color: var(--surface-level-3) !important;
        }

        .calendar-grid-wrapper { 
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; 
        }
        .calendar-grid-wrapper .grid { 
            min-width: 450px; 
        }

        .event-tooltip {
            position: absolute;
            background-color: var(--background);
            border: 1px solid var(--border-level-2);
            color: var(--text-primary);
            border-radius: 4px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-width: 300px;
            display: none;
        }
        .metric-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            justify-content: center;
        }
        .filter-btn {
            padding: 4px 8px;
            background-color: var(--surface-level-2); 
            border: 1px solid var(--border-level-2); 
            color: var(--text-secondary);
            border-radius: 4px; 
            cursor: pointer;
            font-size: 12px; 
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .filter-btn.active {
            background-color: var(--accent) !important; 
            color: var(--on-accent) !important;
            border-color: var(--accent) !important; 
        }
        .filter-btn:focus, button:focus, input[type="text"]:focus, select:focus { 
            outline: none;
            box-shadow: 0 0 0 3px rgba(132, 88, 179, 0.4);
        }
        #processingIndicator.flex { 
            display: flex;
        }
        #unifiedSearchSuggestions {
            position: absolute;
            background-color: var(--background);
            border: 1px solid var(--border-level-2); 
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem; 
            max-height: 240px; 
            overflow-y: auto;
            width: calc(100% - 2px); 
            z-index: 50; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); 
        }
        .suggestion-item {
            padding: 0.5rem 0.75rem; 
            cursor: pointer;
            color: var(--text-primary);
        }
        .suggestion-item:hover {
            background-color: var(--surface-level-2); 
        }
        .suggestion-item .type-label {
            font-size: 0.75rem; 
            color: var(--text-tertiary); 
            margin-left: 0.5rem; 
            background-color: var(--surface-level-1); 
            padding: 0.125rem 0.375rem; 
            border-radius: 0.25rem; 
        }
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 1rem;
        }
        .modal-content {
            background-color: var(--background);
            color: var(--text-primary);
            border-radius: 0.5rem; 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); 
            padding: 1.5rem; 
            max-width: 90vw; 
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        .modal-content-lg { max-width: 60rem; } 
        .modal-content-md { max-width: 48rem; } 

        .modal-close-btn {
            position: absolute;
            top: 0.75rem; 
            right: 0.75rem; 
            background: none;
            border: none;
            font-size: 1.5rem; 
            color: var(--text-tertiary); 
            cursor: pointer;
            padding: 0.25rem; 
        }
        .modal-close-btn:hover {
            color: var(--text-primary); 
        }
        .table-responsive {
            display: block;
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .table-responsive thead th { 
            position: sticky;
            top: 0;
            z-index: 10; 
            background-color: var(--surface-level-1);
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-level-2);
        }
        .table-responsive th { 
            cursor: pointer;
        }
        .table-responsive th:hover {
            background-color: var(--surface-level-2); 
        }
        .table-responsive tbody {
            background-color: var(--background);
        }
        .table-responsive td {
            border-bottom: 1px solid var(--border-level-1);
        }
        .dashboard-card {
            transition: box-shadow 0.3s ease-in-out;
            background-color: var(--surface-level-1); 
            border: 1px solid var(--border-level-1);
            border-radius: 0.5rem;
        }
        .dashboard-card:hover {
            box-shadow: 0 10px 15px -3px rgba(132, 88, 179, 0.1), 0 4px 6px -2px rgba(132, 88, 179, 0.05); 
        }
        #activeFilterIndicator {
            background-color: var(--accent-secondary); 
            color: var(--accent);
            border: 1px solid var(--accent);
        }
        #activeFilterIndicator button {
            background-color: var(--accent);
            color: var(--on-accent);
        }
        #activeFilterIndicator button:hover {
            background-color: rgba(132, 88, 179, 0.8); 
        }
    </style>
</head>
<body class="text-[var(--text-primary)] p-2 sm:p-4 md:p-8">
    <div id="globalProcessingIndicator" class="hidden">
        <div class="global-spinner"></div>
        <span class="text-sm text-[var(--text-secondary)]">Processing...</span>
    </div>

    <div class="dashboard-container max-w-7xl mx-auto">
        <header class="mb-4 md:mb-6 flex justify-between items-center">
            <h1 class="text-2xl sm:text-3xl font-bold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Prime Finder from Subhoo.com</h1>
            <div class="flex items-center space-x-2">
                <button id="shareViewBtn" title="Share Current View" class="p-2 rounded-md bg-[var(--surface-level-2)] hover:bg-[var(--surface-level-3)] transition-colors duration-150 focus:outline-none focus:ring-2 ring-[var(--accent)]">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[var(--text-secondary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
                    </svg>
                </button>
                <button id="themeToggleBtn" title="Toggle Light/Dark Mode" class="p-2 rounded-md bg-[var(--surface-level-2)] hover:bg-[var(--surface-level-3)] transition-colors duration-150 focus:outline-none focus:ring-2 ring-[var(--accent)] hidden">
                    <svg id="themeIconSun" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[var(--text-secondary)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                    <svg id="themeIconMoon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[var(--text-secondary)] hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                </button>
            </div>
        </header>

<section id="explainerSection" class="bg-[var(--surface-level-1)] p-4 md:p-6 rounded-lg shadow-md mb-4 md:mb-6 border border-[var(--border-level-1)]">
  <h2 class="text-xl md:text-2xl font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Welcome!</h2>
  
  <p class="text-sm md:text-base text-[var(--text-secondary)] mb-2">
    This dashboard visualizes data from the SBA's <em>Directory of Federal Government Prime Contractors with Subcontracting Plans</em>, helping small businesses discover subcontracting opportunities with federal prime contractors.
  </p>
  
  <p class="text-sm md:text-base text-[var(--text-secondary)] mb-2">
    ✔ <strong>Search & Explore:</strong> Find contractors with small business subcontracting requirements.  
    <br>✔ <strong>Direct Links:</strong> Access contractor profiles and award details on FPDS.
    <br>✔ <strong>Contract Calendar:</strong> View upcoming contract expirations to time your outreach.
    <br>✔ <strong>Detailed Data:</strong> See contractor name, location, agency, NAICS & PSC codes, contract value, and performance dates.
  </p>
  
  <p class="text-sm md:text-base text-[var(--text-secondary)]">
    Use this tool to identify potential partners, learn their subcontracting processes, and follow their instructions to get involved. All data is sourced from the Federal Procurement Data System (FPDS-NG).
  </p>
            <div id="processingIndicator" class="hidden items-center text-[var(--text-secondary)] mt-4">
                <div class="spinner"></div>
                <span class="ml-2 text-sm">Processing data...</span>
            </div>
            <div id="s3LoadError" class="text-red-600 bg-red-100 dark:bg-red-900 dark:text-red-300 p-3 rounded-md mt-3 hidden text-sm"></div>
            <div id="manual-upload-section" class="hidden mt-4 border-t border-[var(--border-level-1)] pt-4">
                <h3 class="text-lg font-semibold text-[var(--text-primary)] mb-2" style="font-weight: var(--header-font-weight);">Manual CSV Upload</h3>
                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-4 mb-4">
                    <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                    <label for="csvFileInput" class="w-full sm:w-auto px-4 py-2 bg-[var(--accent)] text-[var(--on-accent)] rounded-md cursor-pointer hover:bg-opacity-90 transition-colors duration-150 ease-in-out focus:ring-2 focus:ring-offset-2 ring-[var(--accent)] focus:outline-none" style="font-weight: var(--button-font-weight);">Choose CSV File</label>
                    <span id="file-name-display" class="text-sm text-[var(--text-secondary)] p-2 border border-[var(--border-level-2)] rounded-md min-w-[200px] w-full sm:w-auto">No file selected</span>
                </div>
                <div id="errorMessage" class="text-red-600 bg-red-100 dark:bg-red-900 dark:text-red-300 p-3 rounded-md hidden mb-2 text-sm"></div>
                <div id="successMessage" class="text-green-600 bg-green-100 dark:bg-green-900 dark:text-green-300 p-3 rounded-md hidden mb-2 text-sm"></div>
            </div>
        </section>

        <main id="dashboardContent" class="hidden">
            <section id="statisticsSection" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4 mb-4 md:mb-6">
                <div class="stat-card bg-[var(--surface-level-1)] p-3 md:p-4 rounded-lg shadow hover:shadow-lg transition-shadow duration-150 border border-[var(--border-level-1)]">
                    <div class="text-2xl md:text-3xl font-bold text-[var(--accent)]" id="totalContractsValue">0</div>
                    <div class="text-xs md:text-sm text-[var(--text-secondary)]">Total Contracts</div>
                </div>
                <div class="stat-card bg-[var(--surface-level-1)] p-3 md:p-4 rounded-lg shadow hover:shadow-lg transition-shadow duration-150 border border-[var(--border-level-1)]">
                    <div class="text-2xl md:text-3xl font-bold text-[var(--accent)]" id="totalValueValue">$0</div>
                    <div class="text-sm text-[var(--text-secondary)]">Total Contract Value</div>
                </div>
                <div class="stat-card bg-[var(--surface-level-1)] p-3 md:p-4 rounded-lg shadow hover:shadow-lg transition-shadow duration-150 border border-[var(--border-level-1)]">
                    <div class="text-2xl md:text-3xl font-bold text-[var(--accent)]" id="avgContractValue">$0</div>
                    <div class="text-sm text-[var(--text-secondary)]">Average Contract Value</div>
                </div>
                <div class="stat-card bg-[var(--surface-level-1)] p-3 md:p-4 rounded-lg shadow hover:shadow-lg transition-shadow duration-150 border border-[var(--border-level-1)]">
                    <div class="text-2xl md:text-3xl font-bold text-[var(--accent)]" id="uniquePrimesValue">0</div>
                    <div class="text-sm text-[var(--text-secondary)]">Unique Prime Contractors</div>
                </div>
            </section>
            
            <section id="searchAndFilterSection" class="bg-[var(--surface-level-1)] p-4 md:p-6 rounded-lg shadow-md mb-4 md:mb-6 border border-[var(--border-level-1)]">
                <h2 class="text-lg md:text-xl font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Search & Filter Contracts</h2>
                <div class="relative">
                    <input type="text" id="unifiedSearchInput" class="w-full p-3 border border-[var(--border-level-2)] rounded-md shadow-sm focus:ring-2 ring-[var(--accent)] focus:border-[var(--accent)] bg-[var(--background)] text-[var(--text-primary)]" placeholder="Search by Prime, NAICS, Department, Agency, Office, State...">
                    <div id="unifiedSearchSuggestions" class="hidden bg-[var(--background)] border-[var(--border-level-2)]">
                    </div>
                </div>
                                
                <div id="activeFilterIndicator" class="p-3 rounded-md mt-4 hidden flex flex-col sm:flex-row justify-between items-center text-sm">
                </div>
            </section>
            
            <section id="coreChartsSection" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-2 gap-4 md:gap-6 mb-4 md:mb-6">
                <div id="primeContractorsChartCard" class="dashboard-card p-4 md:p-6">
                    <h2 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Top Prime Contractors by Value</h2>
                    <div class="chart-container">
                        <canvas id="primeContractorsChart"></canvas>
                    </div>
                </div>
                <div class="dashboard-card p-4 md:p-6">
                    <h2 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Department Contract Distribution</h2>
                    <div class="chart-container">
                        <canvas id="departmentChart"></canvas>
                    </div>
                </div>
                <div class="dashboard-card p-4 md:p-6">
                    <h2 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Top NAICS by Contract Value</h2>
                    <div class="chart-container">
                        <canvas id="naicsChart_main"></canvas>
                    </div>
                </div>
                <div class="dashboard-card p-4 md:p-6 hidden">
                    <h2 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Contract Type Breakdown</h2>
                    <div class="chart-container">
                        <canvas id="contractTypeChart_main"></canvas>
                    </div>
                </div>
                <div class="dashboard-card p-4 md:p-6"> 
                    <h2 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Contract Distribution by State</h2>
                    <div class="metric-filters" id="stateChartFilters_main">
                        <button class="filter-btn active" data-filter="count" data-chart="stateContractsChart_main">By Count</button>
                        <button class="filter-btn" data-filter="value" data-chart="stateContractsChart_main">By Value</button>
                    </div>
                    <div class="chart-container" style="height: 320px;"> 
                        <canvas id="stateContractsChart_main"></canvas>
                    </div>
                </div>
                <div class="dashboard-card p-4 md:p-6 hidden">
                    <h2 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Top Contracting Agencies by Value</h2>
                    <div class="chart-container">
                        <canvas id="topAgenciesChart"></canvas>
                    </div>
                </div>
                <div id="marketShareChartCard" class="dashboard-card p-4 md:p-6"> 
                    <h2 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Prime Market Share (for current filter)</h2>
                    <div class="chart-container">
                        <canvas id="marketShareChart"></canvas>
                    </div>
                </div>
                <div class="dashboard-card p-4 md:p-6"> 
                    <h2 class="text-md md:text-lg font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Contract Timeline Forecast</h2>
                    <div class="chart-container">
                        <canvas id="timelineChart"></canvas> 
                    </div>
                </div>
            </section>
            <section id="contractorMapSection" class="bg-[var(--surface-level-1)] p-4 rounded-lg shadow-md mb-4 border border-[var(--border-level-1)]">
  <h2 class="text-lg font-semibold text-[var(--accent)] mb-2">Contractor Headquarters Map</h2>
  <div id="contractorMap" style="height: 500px; width: 100%;" class="rounded border border-[var(--border-level-2)]"></div>
</section>

            <section id="primeProfilesSection" class="bg-[var(--surface-level-1)] p-4 md:p-6 rounded-lg shadow-md mb-4 md:mb-6 border border-[var(--border-level-1)]">
                <h2 class="text-lg md:text-xl font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Prime Contractor Profiles</h2>
                <p class="text-xs md:text-sm text-[var(--text-secondary)] mb-3">Displaying profiles based on current search/filter. Click a prime name to filter the entire dashboard to that prime. Use search below to refine this list.</p>
                <div class="mb-4">
                    <input type="text" id="primeProfilesSearchInput" class="w-full md:w-1/2 lg:w-1/3 p-2 border border-[var(--border-level-2)] rounded-md focus:ring-2 ring-[var(--accent)] focus:border-[var(--accent)] bg-[var(--background)] text-[var(--text-primary)]" placeholder="Filter displayed profiles by name...">
                </div>
                <div id="primeProfilesContainer" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3 md:gap-4 max-h-[70vh] overflow-y-auto"></div>
            </section>

            <section id="primeDetailViewSection" class="bg-[var(--surface-level-1)] p-4 md:p-6 rounded-lg shadow-md mb-4 md:mb-6 hidden border border-[var(--border-level-1)]">
                <h2 id="primeDetailTitle" class="text-xl md:text-2xl font-bold text-[var(--accent)] mb-4" style="font-weight: var(--header-font-weight);">Prime Contractor Details</h2>
                <div id="primeDetailStats" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 text-sm md:text-base">
                </div>
                <h3 class="text-lg font-semibold text-[var(--text-primary)] mt-6 mb-2" style="font-weight: var(--header-font-weight);">Contracts List for this Prime</h3>
                <div id="primeDetailContractsTableContainer" class="table-responsive max-h-96 overflow-y-auto">
                </div>
            </section>
            
            <section id="contractExpirationCalendarSection" class="bg-[var(--surface-level-1)] p-4 md:p-6 rounded-lg shadow-md mb-4 md:mb-6 border border-[var(--border-level-1)]">
                <h2 class="text-lg md:text-xl font-semibold text-[var(--accent)]" style="font-weight: var(--header-font-weight);">Contract Expiration Calendar</h2>
                <p class="text-xs md:text-sm text-[var(--text-secondary)] mb-3">Displaying calendar based on current search/filter. Click a day with events for details.</p>
                <div class="calendar-container min-h-[400px] border border-[var(--border-level-2)] rounded-md p-2 md:p-4">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <div class="flex items-center gap-1">
                            <button id="calendarPrevBtn" class="px-3 py-1 bg-[var(--surface-level-2)] rounded hover:bg-[var(--surface-level-3)] transition-colors duration-150 ease-in-out focus:ring-2 ring-offset-2 ring-[var(--accent)] focus:outline-none text-[var(--text-secondary)]" style="font-weight: var(--button-font-weight);">&lt;</button>
                            <h3 id="calendarTitle" class="text-md md:text-lg font-semibold mx-2 text-[var(--text-primary)]">Month Year</h3>
                            <button id="calendarNextBtn" class="px-3 py-1 bg-[var(--surface-level-2)] rounded hover:bg-[var(--surface-level-3)] transition-colors duration-150 ease-in-out focus:ring-2 ring-offset-2 ring-[var(--accent)] focus:outline-none text-[var(--text-secondary)]" style="font-weight: var(--button-font-weight);">&gt;</button>
                        </div>
                        <div class="flex items-center gap-2 text-xs md:text-sm">
                            <label for="calendarMonthSelect" class="sr-only">Month</label>
                            <select id="calendarMonthSelect" class="p-1 border border-[var(--border-level-2)] rounded-md focus:ring-2 ring-[var(--accent)] focus:border-[var(--accent)] bg-[var(--background)] text-[var(--text-primary)]"></select>
                            <label for="calendarYearSelect" class="sr-only">Year</label>
                            <select id="calendarYearSelect" class="p-1 border border-[var(--border-level-2)] rounded-md focus:ring-2 ring-[var(--accent)] focus:border-[var(--accent)] bg-[var(--background)] text-[var(--text-primary)]"></select>
                        </div>
                    </div>
                    <div class="calendar-grid-wrapper">
                        <div id="calendarGrid" class="grid grid-cols-7 gap-1 text-xs md:text-sm"></div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="genericModal" class="modal-backdrop hidden">
        <div id="genericModalContent" class="modal-content">
            <button id="genericModalCloseBtn" class="modal-close-btn">&times;</button>
            <h2 id="genericModalTitle" class="text-xl font-semibold text-[var(--accent)] mb-4" style="font-weight: var(--header-font-weight);">Modal Title</h2>
            <div id="genericModalBody" class="text-[var(--text-secondary)]">
            </div>
        </div>
    </div>

    <div class="event-tooltip"></div>

    <div id="shareToast" class="fixed bottom-5 right-5 bg-[var(--accent)] text-[var(--on-accent)] py-2 px-4 rounded-md shadow-lg hidden transition-opacity duration-300">
        Link copied to clipboard!
    </div>
<script>
// --- DOM Elements ---
const processingIndicator = document.getElementById('processingIndicator'); 
const manualUploadSection = document.getElementById('manual-upload-section');
const dashboardContent = document.getElementById('dashboardContent');
const csvFileInput = document.getElementById('csvFileInput');
const fileNameDisplay = document.getElementById('file-name-display');
const errorMessageDiv = document.getElementById('errorMessage');
const successMessageDiv = document.getElementById('successMessage');
const s3LoadErrorDiv = document.getElementById('s3LoadError');
const unifiedSearchInput = document.getElementById('unifiedSearchInput'); 
const unifiedSearchSuggestions = document.getElementById('unifiedSearchSuggestions'); 
const activeFilterIndicator = document.getElementById('activeFilterIndicator');

const primeProfilesContainer = document.getElementById('primeProfilesContainer');
const primeProfilesSearchInput = document.getElementById('primeProfilesSearchInput');
const calendarPrevBtn = document.getElementById('calendarPrevBtn');
const calendarNextBtn = document.getElementById('calendarNextBtn');
const calendarTitleEl = document.getElementById('calendarTitle');
const calendarGridEl = document.getElementById('calendarGrid');
const calendarMonthSelect = document.getElementById('calendarMonthSelect');
const calendarYearSelect = document.getElementById('calendarYearSelect');
const globalTooltipEl = document.querySelector('.event-tooltip');

// Modal Elements
const genericModal = document.getElementById('genericModal');
const genericModalContent = document.getElementById('genericModalContent');
const genericModalTitle = document.getElementById('genericModalTitle');
const genericModalBody = document.getElementById('genericModalBody');
const genericModalCloseBtn = document.getElementById('genericModalCloseBtn');

// Prime Detail View Section Elements
const primeDetailViewSection = document.getElementById('primeDetailViewSection');
const primeDetailTitle = document.getElementById('primeDetailTitle');
const primeDetailStats = document.getElementById('primeDetailStats');
const primeDetailContractsTableContainer = document.getElementById('primeDetailContractsTableContainer');

// Theme Toggle and Share Buttons
const themeToggleBtn = document.getElementById('themeToggleBtn');
const themeIconSun = document.getElementById('themeIconSun');
const themeIconMoon = document.getElementById('themeIconMoon');
const shareViewBtn = document.getElementById('shareViewBtn');
const shareToast = document.getElementById('shareToast');


// --- Global Variables ---
let parsedData = [];
const charts = {}; 
const S3_CSV_URL = 'https://subhoodata.s3.us-east-1.amazonaws.com/data/sbaall.csv';
let currentMainStateChartFilter = 'count';
const ITEMS_PER_PAGE_MODAL_TABLE = 10; 
let currentCalendarDate = new Date(); 
let currentPrimeDetailViewPage = 1; 
let isViewingSpecificPrime = false; 
let specificPrimeName = null;      
let currentPrimeDetailSort = { column: 'endDate', order: 'desc' }; 
let currentCalendarModalSort = { column: 'prime', order: 'asc' }; 


// --- Chart Color Palette (Derived from CSS Variables) ---
let chartPrimaryColor, chartSecondaryColor, chartTertiaryColor, chartNeutralColor, chartAccentColor;
let chartGrays = []; 

function getChartColors() {
    const styles = getComputedStyle(document.documentElement);
    chartPrimaryColor = styles.getPropertyValue('--purple-pain').trim() || '#8458B3'; 
    chartSecondaryColor = styles.getPropertyValue('--ice-cold').trim() || '#a0d2eb'; 
    chartTertiaryColor = styles.getPropertyValue('--medium-purple').trim() || '#d0bdf4';
    chartNeutralColor = styles.getPropertyValue('--heavy-purple').trim() || '#a28089'; 
    
    chartGrays = [
        styles.getPropertyValue('--medium-purple').trim() || '#d0bdf4',
        styles.getPropertyValue('--heavy-purple').trim() || '#a28089',
        '#b4a7d6' // Secondary gray
    ];
    chartAccentColor = styles.getPropertyValue('--heavy-purple').trim() || '#a28089'; 
}


// --- Utility Functions ---
function formatCurrency(value) {
    if (isNaN(parseFloat(value))) { 
        return '$0';
    }
    const num = parseFloat(value);

    if (Math.abs(num) >= 1.0e+9) { 
        return '$' + (num / 1.0e+9).toFixed(1) + 'B';
    }
    if (Math.abs(num) >= 1.0e+6) { 
        return '$' + (num / 1.0e+6).toFixed(1) + 'M';
    }
    if (Math.abs(num) >= 1.0e+3) { 
        return '$' + (num / 1.0e+3).toFixed(1) + 'K';
    }
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0 
    }).format(num);
}

function parseCurrencyValue(valueStr) { if (!valueStr) return 0; return parseFloat(String(valueStr).replace(/[$,\s]/g, '')) || 0; }
function formatDate(dateStr) { if (!dateStr) return ''; const date = new Date(dateStr); return isNaN(date.getTime()) ? '' : new Intl.DateTimeFormat('en-US', { year: 'numeric', month: 'short', day: 'numeric' }).format(date); }

function createAwardLink(piid) {
    if (!piid || typeof piid !== 'string' || piid.trim() === '' || piid.toLowerCase() === 'n/a') {
        return piid || 'N/A'; 
    }
    const encodedPiid = encodeURIComponent(piid.trim());
    return `<a href="https://www.fpds.gov/ezsearch/fpdsportal?indexName=awardfull&templateName=1.5.3&s=FPDS&q=${encodedPiid}&x=18&y=15" target="_blank" rel="noopener noreferrer" class="text-[var(--accent)] hover:underline">${piid}</a>`;
}

function createEntityLink(entityId, entityName) {
    if (!entityId || typeof entityId !== 'string' || entityId.trim() === '' || entityId.toLowerCase() === 'n/a') {
        return entityName || entityId || 'N/A'; 
    }
    const encodedEntityId = encodeURIComponent(entityId.trim());
    return `<a href="https://www.fpds.gov/ezsearch/fpdsportal?s=FPDS&q=${encodedEntityId}&x=0&y=0" target="_blank" rel="noopener noreferrer" class="text-[var(--accent)] hover:underline">${entityName || entityId}</a>`;
}


function showProcessingBriefly() { processingIndicator.classList.remove('hidden'); processingIndicator.classList.add('flex'); }
function hideProcessing() { processingIndicator.classList.add('hidden'); processingIndicator.classList.remove('flex');}

function showErrorMessage(message, isAutoloadError = false) {
    if (isAutoloadError) {
        manualUploadSection.classList.remove('hidden');
        s3LoadErrorDiv.textContent = `S3 Auto-load failed: ${message}. Please use manual upload option above.`;
        s3LoadErrorDiv.classList.remove('hidden');
    } else {
        errorMessageDiv.textContent = message; errorMessageDiv.classList.remove('hidden');
        successMessageDiv.classList.add('hidden');
    }
    hideProcessing(); 
}

function showSuccessMessage(message, isAutoloadSuccess = false) {
    if (isAutoloadSuccess) {
        s3LoadErrorDiv.classList.add('hidden');
    } else {
        successMessageDiv.textContent = message; successMessageDiv.classList.remove('hidden');
        errorMessageDiv.classList.add('hidden');
    }
    hideProcessing(); 
}

// --- Modal Management (Only for Calendar Day Details now) ---
function openModal(title, contentHTML, sizeClass = 'modal-content-md') {
    genericModalTitle.textContent = title;
    genericModalBody.innerHTML = contentHTML;
    genericModalContent.className = `modal-content ${sizeClass}`; 
    genericModal.classList.remove('hidden');
    genericModal.classList.add('flex');
}

function closeModal() {
    genericModal.classList.add('hidden');
    genericModal.classList.remove('flex');
    genericModalBody.innerHTML = ''; 
}
genericModalCloseBtn.addEventListener('click', closeModal);
genericModal.addEventListener('click', (event) => { 
    if (event.target === genericModal) {
        closeModal();
    }
});


// --- Data Processing and Chart Initialization ---
function cleanupCharts() { Object.keys(charts).forEach(key => { if (charts[key]) { charts[key].destroy(); charts[key] = null; } }); }

function processAndInitialize(data) {
    try {
        if (!data || data.length === 0) { 
            showErrorMessage('No data to display. Please try manual upload or check the S3 source.', true); 
            return; 
        }
        parsedData = data; 
        activeFilterIndicator.classList.add('hidden');
        dashboardContent.classList.remove('hidden');
        manualUploadSection.classList.add('hidden'); 
        s3LoadErrorDiv.classList.add('hidden'); 
        primeDetailViewSection.classList.add('hidden'); 

        getChartColors(); 
        cleanupCharts(); 
        initializeCoreVisuals(parsedData); 
        setupUnifiedSearch(); 
        initializePrimeProfilesSection(parsedData); 
        initializeContractExpirationCalendarSection(parsedData); 
		initializeContractorMap(data);
        showSuccessMessage('Data loaded and dashboard initialized.', true); 
        
        applyInitialTheme(); 
        applyFiltersFromURL(); 

    } catch (error) {
        console.error("Error during processAndInitialize:", error);
        showErrorMessage("An error occurred while initializing the dashboard. Please try refreshing.", false); 
    } finally {
        hideProcessing(); 
    }
}

// --- S3 Data Loading ---
function loadDataFromS3() { 
    showProcessingBriefly(); 
    fetch(S3_CSV_URL, { mode: 'cors', cache: 'no-cache', headers: { 'Accept': 'text/csv' } })
    .then(response => {
        if (!response.ok) {
            let errorDetail = `HTTP error ${response.status}`;
            if (response.status === 0) errorDetail = "Network error or CORS issue.";
            else if (response.status === 403) errorDetail = "Access Forbidden (403).";
            else if (response.status === 404) errorDetail = "File Not Found (404).";
            throw new Error(`S3 Load Error: ${errorDetail}`);
        }
        return response.text();
    })
    .then(csvText => {
        if (!csvText || csvText.trim() === '') { showErrorMessage('S3 file is empty.', true); return; }
        Papa.parse(csvText, {
            header: true,
            dynamicTyping: true, 
            skipEmptyLines: true,
            complete: results => {
                if (results.errors && results.errors.length > 0) { showErrorMessage('Error parsing CSV from S3: ' + results.errors[0].message, true); return; }
                if (results.data && results.data.length > 0) processAndInitialize(results.data);
                else showErrorMessage('No data parsed from S3 file.', true);
            },
            error: error => showErrorMessage('Error parsing CSV data from S3: ' + error.message, true)
        });
    })
    .catch(error => {
        let errorMsg = error.message; 
        if (navigator.onLine === false && !errorMsg.includes("offline")) errorMsg += " You may also be offline.";
        showErrorMessage(errorMsg, true); 
    });
}
function loadCompanyMapFromS3() {
  Papa.parse("https://subhoodata.s3.us-east-1.amazonaws.com/data/companies.csv", {
    header: true,
    download: true,
    skipEmptyLines: true,
    complete: function(results) {
      if (results && results.data && results.data.length > 0) {
        initializeContractorMap(results.data);
      } else {
        console.error("companies.csv is empty or invalid.");
      }
    },
    error: function(err) {
      console.error("Failed to load companies.csv from S3:", err);
    }
  });
}

function initializeContractorMap(data) {
  const map = L.map('contractorMap').setView([39.8283, -98.5795], 4); // Centered on USA
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://carto.com/">CARTO</a>',
  subdomains: 'abcd',
  maxZoom: 19
}).addTo(map);

  const markers = L.markerClusterGroup();

  data.forEach(row => {
    if (row.Location && row["Company Name"]) {
      const [latStr, lngStr] = row.Location.split(',').map(s => s.trim());
      const lat = parseFloat(latStr);
      const lng = parseFloat(lngStr);
      if (!isNaN(lat) && !isNaN(lng)) {
        const marker = L.marker([lat, lng]);
        marker.bindPopup(`<strong>${row["Company Name"]}</strong><br>${row.City}, ${row.State}`);
		marker.bindTooltip(row["Company Name"], { permanent: false, direction: 'top' });
		markers.addLayer(marker);
      }
    }
  });

  map.addLayer(markers);
	setTimeout(() => {
    map.invalidateSize();
  }, 200);
}
// --- Unified Search, Suggestions, and Filtering Logic ---
function applyFilter(searchTerm, filterType = null, filterValue = null) { 
    try {
        let filteredData;
        let displaySearchTerm = searchTerm; 
        
        const marketShareCard = document.getElementById('marketShareChartCard');
        const primeContractorsCard = document.getElementById('primeContractorsChartCard');

        if (filterType === 'primeName') {
            isViewingSpecificPrime = true; 
            specificPrimeName = filterValue || searchTerm; 
            const primeToFilter = specificPrimeName;
            filteredData = parsedData.filter(record => (record['Legal Business Name']?.toLowerCase() || '') === primeToFilter.toLowerCase());
            displaySearchTerm = `Prime: ${primeToFilter}`;
            renderPrimeDetailView(primeToFilter, filteredData); // This will show the section
            // Visibility of general prime charts handled in initializeCoreVisuals
        } else if (filterType) { 
            isViewingSpecificPrime = false; 
            specificPrimeName = null;
            primeDetailViewSection.classList.add('hidden'); // Hide prime detail for other filters
            if(marketShareCard) marketShareCard.classList.remove('hidden');
            if(primeContractorsCard) primeContractorsCard.classList.remove('hidden');

            const termToMatch = (filterValue || searchTerm).toLowerCase(); 
            filteredData = parsedData.filter(record => {
                let recordValue = '';
                switch (filterType) {
                    case 'naicsCode': recordValue = String(record['NAICS Code'] || '').toLowerCase(); break;
                    case 'naicsDesc': recordValue = record['NAICS Description']?.toLowerCase() || ''; break;
                    case 'departmentName': recordValue = record['Contracting Department Name']?.toLowerCase() || ''; break; 
                    case 'agencyName': recordValue = record['Contracting Agency Name']?.toLowerCase() || ''; break;
                    case 'officeName': recordValue = record['Contracting Office Name']?.toLowerCase() || ''; break;
                    case 'stateCode': recordValue = record['Principal Place of Performance State Code']?.toLowerCase() || ''; break;
                    case 'contractType': recordValue = record['Award or Indefinite Delivery Vehicle Type']?.toLowerCase() || ''; break; 
                    default: return false;
                }
                if (filterValue) return recordValue === termToMatch; 
                return recordValue.includes(termToMatch); 
            });
            displaySearchTerm = `${filterType.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}: ${filterValue || searchTerm}`; 
        } else { // General keyword search 
            isViewingSpecificPrime = false; 
            specificPrimeName = null;
            primeDetailViewSection.classList.add('hidden');
            if(marketShareCard) marketShareCard.classList.remove('hidden');
            if(primeContractorsCard) primeContractorsCard.classList.remove('hidden');

            if (!searchTerm || searchTerm.trim() === '') {
                clearAllFilters(); 
                return;
            }
            const keywords = searchTerm.toLowerCase().split(' ').filter(k => k);
            filteredData = parsedData.filter(record => {
                return keywords.every(keyword => {
                    const primeName = record['Legal Business Name']?.toLowerCase() || '';
                    const naicsCode = String(record['NAICS Code'] || '').toLowerCase();
                    const naicsDesc = record['NAICS Description']?.toLowerCase() || '';
                    const departmentName = record['Contracting Department Name']?.toLowerCase() || '';
                    const agencyName = record['Contracting Agency Name']?.toLowerCase() || '';
                    const officeName = record['Contracting Office Name']?.toLowerCase() || '';
                    const stateCode = record['Principal Place of Performance State Code']?.toLowerCase() || '';
                    return primeName.includes(keyword) || naicsCode.includes(keyword) ||
                           naicsDesc.includes(keyword) || departmentName.includes(keyword) ||
                           agencyName.includes(keyword) || officeName.includes(keyword) ||
                           (keyword.length === 2 && stateCode === keyword) ||
                           (keyword.length > 2 && stateCode.includes(keyword));
                });
            });
        }

        initializeCoreVisuals(filteredData, isViewingSpecificPrime); 
        initializePrimeProfilesSection(filteredData); 
        initializeContractExpirationCalendarSection(filteredData);
        updateActiveFilterIndicator(displaySearchTerm, filteredData.length);
        unifiedSearchSuggestions.innerHTML = ''; 
        unifiedSearchSuggestions.classList.add('hidden');
    } catch (error) {
        console.error("Error during filter application:", error);
    }
}


function clearAllFilters() {
    try {
        unifiedSearchInput.value = '';
        activeFilterIndicator.classList.add('hidden');
        unifiedSearchSuggestions.innerHTML = '';
        unifiedSearchSuggestions.classList.add('hidden');
        primeDetailViewSection.classList.add('hidden'); 
        isViewingSpecificPrime = false; 
        specificPrimeName = null;
        
        const marketShareCard = document.getElementById('marketShareChartCard');
        const primeContractorsCard = document.getElementById('primeContractorsChartCard');
        if(marketShareCard) marketShareCard.classList.remove('hidden');
        if(primeContractorsCard) primeContractorsCard.classList.remove('hidden');

        initializeCoreVisuals(parsedData, false); 
        initializePrimeProfilesSection(parsedData); 
        initializeContractExpirationCalendarSection(parsedData); 
    } catch (error) {
        console.error("Error during clearing filters:", error);
    }
}

function updateActiveFilterIndicator(searchTerm, count) {
    if (searchTerm && searchTerm.trim() !== '') {
        activeFilterIndicator.innerHTML = `<span>Filtered by: <strong>"${searchTerm}"</strong> (${count.toLocaleString()} results)</span> 
                                         <button class="bg-[var(--accent)] text-[var(--on-accent)] px-3 py-1 rounded-md text-sm hover:bg-opacity-90 focus:ring-2 focus:ring-offset-2 focus:ring-[var(--accent)] focus:outline-none" onclick="clearAllFilters()">Clear All Filters</button>`;
        activeFilterIndicator.classList.remove('hidden');
    } else {
        activeFilterIndicator.classList.add('hidden');
    }
}

function selectSearchSuggestion(term, type, originalValue) { 
    unifiedSearchInput.value = originalValue; 
    applyFilter(originalValue, type, originalValue); 
    unifiedSearchSuggestions.innerHTML = '';
    unifiedSearchSuggestions.classList.add('hidden');
}

function setupUnifiedSearch() {
    unifiedSearchInput.addEventListener('input', _.debounce(function() {
        const searchTerm = this.value.toLowerCase().trim();
        unifiedSearchSuggestions.innerHTML = ''; 

        if (searchTerm.length < 2) {
            unifiedSearchSuggestions.classList.add('hidden');
            return;
        }

        const suggestions = new Map(); 
        const maxSuggestions = 15;

        parsedData.forEach(record => {
            if (suggestions.size >= maxSuggestions) return;

            const checkAndAdd = (value, type, displayValue = null) => {
                if (suggestions.size >= maxSuggestions) return;
                const originalVal = value; 
                const valStr = String(value || '').toLowerCase();
                if (valStr.includes(searchTerm)) {
                    const key = `${type}-${originalVal}`; 
                    if (!suggestions.has(key)) {
                        let highlightedTerm = displayValue || originalVal;
                        if (typeof highlightedTerm === 'string') {
                             const index = valStr.indexOf(searchTerm);
                             if (index !== -1) {
                                 highlightedTerm = highlightedTerm.substring(0, index) +
                                                  `<strong>${highlightedTerm.substring(index, index + searchTerm.length)}</strong>` +
                                                  highlightedTerm.substring(index + searchTerm.length);
                             }
                        }
                        suggestions.set(key, { termForDisplayHTML: highlightedTerm, type: type, originalValue: originalVal });
                    }
                }
            };
            
            checkAndAdd(record['Legal Business Name'], 'primeName');
            checkAndAdd(String(record['NAICS Code'] || ''), 'naicsCode');
            
            const descWords = (record['NAICS Description'] || '').split(/\s+/); 
            descWords.forEach(word => {
                if (word.toLowerCase().includes(searchTerm) && word.length > 2) { 
                     checkAndAdd(word, 'naicsDesc', word); 
                }
            });
            checkAndAdd(record['Contracting Department Name'], 'departmentName');
            checkAndAdd(record['Contracting Agency Name'], 'agencyName');
            checkAndAdd(record['Contracting Office Name'], 'officeName');
            checkAndAdd(record['Principal Place of Performance State Code'], 'stateCode');
        });

        if (suggestions.size > 0) {
            unifiedSearchSuggestions.classList.remove('hidden');
            Array.from(suggestions.values()).forEach(sugg => {
                const item = document.createElement('div');
                item.className = 'suggestion-item hover:bg-[var(--surface-level-2)]'; 
                item.innerHTML = (typeof sugg.termForDisplayHTML === 'string' && sugg.termForDisplayHTML.length > 60 ? sugg.termForDisplayHTML.substring(0, 57) + '...' : sugg.termForDisplayHTML);
                
                const typeLabel = document.createElement('span');
                typeLabel.className = 'type-label bg-[var(--surface-level-1)] text-[var(--text-tertiary)]'; 
                let displayType = sugg.type;
                if (sugg.type === 'primeName') displayType = 'Prime';
                else if (sugg.type === 'naicsCode') displayType = 'NAICS';
                else if (sugg.type === 'naicsDesc') displayType = 'NAICS Keyword';
                else if (sugg.type === 'departmentName') displayType = 'Dept.';
                else if (sugg.type === 'agencyName') displayType = 'Agency';
                else if (sugg.type === 'officeName') displayType = 'Office';
                else if (sugg.type === 'stateCode') displayType = 'State';
                typeLabel.textContent = displayType;
                item.appendChild(typeLabel);

                item.onclick = () => selectSearchSuggestion(sugg.termForDisplayHTML, sugg.type, sugg.originalValue); 
                unifiedSearchSuggestions.appendChild(item);
            });
        } else {
            unifiedSearchSuggestions.classList.remove('hidden'); 
            unifiedSearchSuggestions.innerHTML = `<div class="p-2 text-sm text-[var(--text-tertiary)]">No specific suggestions. Press Enter to search all fields.</div>`;
        }
    }, 300));

    unifiedSearchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            applyFilter(this.value.trim()); 
            unifiedSearchSuggestions.innerHTML = '';
            unifiedSearchSuggestions.classList.add('hidden');
        }
    });

    document.addEventListener('click', function(event) {
        if (!unifiedSearchInput.contains(event.target) && !unifiedSearchSuggestions.contains(event.target)) {
            unifiedSearchSuggestions.classList.add('hidden');
        }
    });
}


// --- Initialize Core Visualizations ---
function initializeCoreVisuals(data, isPrimeView = false) { 
    updateStatistics(data);
    
    const marketShareCard = document.getElementById('marketShareChartCard');
    const primeContractorsCard = document.getElementById('primeContractorsChartCard');

    if (isPrimeView) {
        if (charts.marketShareChart) { charts.marketShareChart.destroy(); charts.marketShareChart = null; }
        if (marketShareCard && marketShareCard.querySelector('.chart-container')) marketShareCard.querySelector('.chart-container').innerHTML = `<div class="chart-no-data">Market share not applicable for single prime view.</div>`;
        
        if (charts.primeContractorsChart) { charts.primeContractorsChart.destroy(); charts.primeContractorsChart = null; }
        if (primeContractorsCard && primeContractorsCard.querySelector('.chart-container')) primeContractorsCard.querySelector('.chart-container').innerHTML = `<div class="chart-no-data">Top primes not applicable for single prime view.</div>`;
    } else {
        if (marketShareCard && !marketShareCard.querySelector('canvas#marketShareChart')) { 
            marketShareCard.querySelector('.chart-container').innerHTML = `<canvas id="marketShareChart"></canvas>`;
        }
        createMarketShareChart(data); 
        
        if (primeContractorsCard && !primeContractorsCard.querySelector('canvas#primeContractorsChart')) { 
            primeContractorsCard.querySelector('.chart-container').innerHTML = `<canvas id="primeContractorsChart"></canvas>`;
        }
        createPrimeContractorsChart(data);
    }
    
    createDepartmentChart(data); 
    createNaicsChart_main(data);
    createContractTypeChart_main(data);
    createStateContractsChart_main(data, currentMainStateChartFilter);
    createTopAgenciesChart(data); 
    createTimelineChart(data); 
}

// --- Statistics Update ---
function updateStatistics(data) { 
    if (!data || data.length === 0) {
        ['totalContractsValue', 'totalValueValue', 'avgContractValue', 'uniquePrimesValue'].forEach(id => document.getElementById(id).textContent = '0');
        return;
    }
    document.getElementById('totalContractsValue').textContent = data.length.toLocaleString();
    let totalValue = 0, contractsWithValue = 0;
    data.forEach(r => { const v = parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']); if (v>0) {totalValue+=v; contractsWithValue++;}});
    document.getElementById('totalValueValue').textContent = formatCurrency(totalValue);
    document.getElementById('avgContractValue').textContent = formatCurrency(contractsWithValue > 0 ? totalValue / contractsWithValue : 0);
    document.getElementById('uniquePrimesValue').textContent = new Set(data.map(r => r['Legal Business Name']).filter(Boolean)).size.toLocaleString();
}

// --- Chart Creation Functions ---
function createChart(canvasId, type, data, options, noDataMessage = "No data available for current selection.") { 
    const canvasElement = document.getElementById(canvasId);
    if (!canvasElement) {
        return; 
    }
    const chartContainer = canvasElement.parentElement; 
    
    let isEmpty = true;
    if (data && data.datasets && data.datasets.length > 0) {
        isEmpty = data.datasets.every(ds => !ds.data || ds.data.length === 0 || ds.data.every(val => val === 0 || val === null));
    } else if (type === 'pie' || type === 'doughnut') { 
        if (data && data.datasets && data.datasets[0] && data.datasets[0].data) {
           isEmpty = data.datasets[0].data.every(val => val === 0);
        }
    }

    if (isEmpty) {
        chartContainer.innerHTML = `<div class="chart-no-data">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                                        </svg>
                                        <span>${noDataMessage}</span>
                                    </div>`;
        if (charts[canvasId]) {
            charts[canvasId].destroy();
            charts[canvasId] = null;
        }
        return;
    } else {
        if (chartContainer.querySelector('.chart-no-data')) {
            chartContainer.innerHTML = `<canvas id="${canvasId}"></canvas>`;
        }
    }
    
    const ctx = document.getElementById(canvasId).getContext('2d');
    if (charts[canvasId]) charts[canvasId].destroy();
    charts[canvasId] = new Chart(ctx, { type, data, options });
}

function createPrimeContractorsChart(data) { 
    const canvasElement = document.getElementById('primeContractorsChart');
    if (!canvasElement) return; 

    const primeValues = {};
    data.forEach(r => { if (r['Legal Business Name']) primeValues[r['Legal Business Name']] = (primeValues[r['Legal Business Name']] || 0) + parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']); });
    const sorted = Object.entries(primeValues).sort((a,b)=>b[1]-a[1]).slice(0,10);
    const chartData = { 
        labels: sorted.map(i=>i[0]), 
        datasets: [{ 
            label: 'Contract Value', 
            data: sorted.map(i=>i[1]), 
            backgroundColor: (context) => {
                const index = context.dataIndex;
                if (index === 0) return chartPrimaryColor;
                if (index === 1) return chartSecondaryColor;
                return chartTertiaryColor;
            }
        }] 
    };
    const chartOptions = { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false}, tooltip:{callbacks:{label:c=>formatCurrency(c.raw)}}}, scales: {x:{ticks:{callback:v=>formatCurrency(v)}}, y:{ticks:{autoSkip:false, callback:function(v){const l=this.getLabelForValue(v); return l.length>18?l.substring(0,15)+'...':l;}}}},
        onClick: (event, elements) => {
            if (elements.length > 0) {
                const primeName = chartData.labels[elements[0].index];
                setUnifiedSearchTerm(primeName, 'primeName'); 
            }
        }
    };
    createChart('primeContractorsChart', 'bar', chartData, chartOptions);
}

function createDepartmentChart(data) { 
    const deptValues = {};
    data.forEach(r => { if (r['Contracting Department Name']) deptValues[r['Contracting Department Name']] = (deptValues[r['Contracting Department Name']] || 0) + parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']); });
    const sorted = Object.entries(deptValues).sort((a,b)=>b[1]-a[1]).slice(0,10);
    
    const departmentColors = [
        chartPrimaryColor,
        chartSecondaryColor,
        chartTertiaryColor,
        chartNeutralColor
    ];
    
    // Add additional colors if needed
    while (departmentColors.length < sorted.length) {
        departmentColors.push(chartGrays[departmentColors.length % chartGrays.length]);
    }

    const chartData = { 
        labels: sorted.map(i=>i[0]), 
        datasets: [{ data: sorted.map(i=>i[1]), backgroundColor: departmentColors }] 
    };
    const chartOptions = { 
        responsive: true, maintainAspectRatio: false, 
        plugins: { 
            legend: {position:'right', labels:{boxWidth:12,font:{size:10}}}, 
            tooltip:{callbacks:{label:c=>`${c.label||''}: ${formatCurrency(c.raw)}`}}
        },
        onClick: (event, elements) => {
            if (elements.length > 0) {
                const departmentName = chartData.labels[elements[0].index];
                setUnifiedSearchTerm(departmentName, 'departmentName'); 
            }
        }
    };
    createChart('departmentChart', 'pie', chartData, chartOptions);
}

function createNaicsChart_main(data) { 
    const naicsValues = {}, naicsDesc = {};
    data.forEach(r => {
        if (r['NAICS Code']) {
            const naicsKey = String(r['NAICS Code']);
            naicsValues[naicsKey] = (naicsValues[naicsKey] || 0) + parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
            if (!naicsDesc[naicsKey]) naicsDesc[naicsKey] = r['NAICS Description'] || '';
        }
    });
    const sorted = Object.entries(naicsValues).sort((a,b)=>b[1]-a[1]).slice(0,10);
    const chartData = { 
        labels: sorted.map(i=>i[0]), 
        displayLabels: sorted.map(i=>`${i[0]} - ${naicsDesc[i[0]] ? naicsDesc[i[0]].substring(0,20) : ''}...`), 
        datasets: [{ 
            label: 'Contract Value', 
            data: sorted.map(i=>i[1]), 
            backgroundColor: (context) => {
                const index = context.dataIndex;
                if (index === 0) return chartPrimaryColor;
                if (index === 1) return chartSecondaryColor;
                return chartTertiaryColor;
            }
        }] 
    };
    const chartOptions = { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false}, tooltip:{callbacks:{label:c=>formatCurrency(c.raw)}}}, scales: {x:{ticks:{callback:v=>formatCurrency(v)}}},
        onClick: (event, elements) => {
            if (elements.length > 0) {
                const naicsCode = chartData.labels[elements[0].index]; 
                setUnifiedSearchTerm(naicsCode, 'naicsCode'); 
            }
        }
    };
    chartOptions.data = { labels: chartData.displayLabels, datasets: chartData.datasets}; 
    createChart('naicsChart_main', 'bar', chartOptions.data , chartOptions);
}

function createContractTypeChart_main(data) { 
    const contractTypes = {};
    data.forEach(r => { if (r['Award or Indefinite Delivery Vehicle Type']) contractTypes[r['Award or Indefinite Delivery Vehicle Type']] = (contractTypes[r['Award or Indefinite Delivery Vehicle Type']] || 0) + 1; });
    
    const sortedContractTypes = Object.entries(contractTypes).sort((a,b) => b[1] - a[1]);

    const contractTypeColors = [
        chartPrimaryColor,
        chartSecondaryColor,
        chartTertiaryColor,
        chartNeutralColor
    ];
    
    // Add additional colors if needed
    while (contractTypeColors.length < sortedContractTypes.length) {
        contractTypeColors.push(chartGrays[contractTypeColors.length % chartGrays.length]);
    }

    const chartData = { 
        labels: sortedContractTypes.map(item => item[0]), 
        datasets: [{ data: sortedContractTypes.map(item => item[1]), backgroundColor: contractTypeColors }] 
    };
    const chartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: {position:'right', labels:{boxWidth:12,font:{size:10}}}, tooltip:{callbacks:{label:c=>`${c.label||''}: ${c.raw.toLocaleString()}`}}},
        onClick: (event, elements) => {
            if (elements.length > 0) {
                const contractType = chartData.labels[elements[0].index];
                setUnifiedSearchTerm(contractType, 'contractType'); 
            }
        }
    };
    createChart('contractTypeChart_main', 'doughnut', chartData, chartOptions);
}

function createStateContractsChart_main(data, filterType = 'count') { 
    const stateData = {}; 
    data.forEach(r => {
        const state = r['Principal Place of Performance State Code'];
        if (state) {
            if (!stateData[state]) stateData[state] = { count: 0, value: 0 };
            stateData[state].count++;
            stateData[state].value += parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
        }
    });
    const sorted = Object.entries(stateData).sort((a,b) => b[1][filterType] - a[1][filterType]).slice(0,10);
    const chartData = { 
        labels: sorted.map(i=>i[0]), 
        datasets: [{ 
            label: filterType === 'count' ? 'Number of Contracts' : 'Total Contract Value', 
            data: sorted.map(i=>i[1][filterType]), 
            backgroundColor: (context) => {
                const index = context.dataIndex;
                if (index === 0) return chartPrimaryColor;
                if (index === 1) return chartSecondaryColor;
                return chartTertiaryColor;
            }
        }] 
    };
    const chartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false}, tooltip:{callbacks:{label:c=> filterType === 'count' ? c.raw.toLocaleString() : formatCurrency(c.raw)}}}, scales: {y:{ticks:{callback:v=> filterType==='count'?v.toLocaleString():formatCurrency(v)}}},
        onClick: (event, elements) => {
            if (elements.length > 0) {
                const stateCode = chartData.labels[elements[0].index];
                setUnifiedSearchTerm(stateCode, 'stateCode'); 
            }
        }
    };
    createChart('stateContractsChart_main', 'bar', chartData, chartOptions);
}

function createTopAgenciesChart(data) {
    const agencyValues = {};
    data.forEach(r => {
        const agency = r['Contracting Agency Name']; 
        if (agency) {
            agencyValues[agency] = (agencyValues[agency] || 0) + parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
        }
    });
    const sortedAgencies = Object.entries(agencyValues).sort((a, b) => b[1] - a[1]).slice(0, 10);
    const chartData = { 
        labels: sortedAgencies.map(item => item[0]), 
        datasets: [{ 
            label: 'Contract Value', 
            data: sortedAgencies.map(item => item[1]), 
            backgroundColor: (context) => {
                const index = context.dataIndex;
                if (index === 0) return chartPrimaryColor;
                if (index === 1) return chartSecondaryColor;
                return chartTertiaryColor;
            }
        }] 
    }; 
    const chartOptions = { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => formatCurrency(ctx.raw) } } }, scales: { x: { ticks: { callback: val => formatCurrency(val) } }, y: { ticks: { autoSkip: false, callback: function(val) { const label = this.getLabelForValue(val); return label.length > 20 ? label.substring(0, 17) + '...' : label; } } } },
        onClick: (event, elements) => {
            if (elements.length > 0) {
                const agencyName = chartData.labels[elements[0].index];
                setUnifiedSearchTerm(agencyName, 'agencyName'); 
            }
        }
    };
    createChart('topAgenciesChart', 'bar', chartData, chartOptions);
}

function createTimelineChart(data) {
    const startYears = {}; 
    const endYears = {};
    data.forEach(record => {
        if (record['Period of Performance Start Date']) { 
            const d = new Date(record['Period of Performance Start Date']); 
            if (!isNaN(d.getTime())) { 
                const y = d.getFullYear(); 
                if (y > 2000 && y < 2030) startYears[y] = (startYears[y] || 0) + 1; 
            }
        }
        if (record['Completion Date']) { 
            const d = new Date(record['Completion Date']); 
            if (!isNaN(d.getTime())) { 
                const y = d.getFullYear(); 
                if (y > 2000 && y < 2030) endYears[y] = (endYears[y] || 0) + 1; 
            }
        }
    });
    const allYears = new Set([...Object.keys(startYears), ...Object.keys(endYears)].map(Number));
    const sortedYears = Array.from(allYears).sort((a,b) => a-b);
    
    const labels = [], startCounts = [], endCounts = [];
    sortedYears.forEach(year => { 
        labels.push(year.toString()); 
        startCounts.push(startYears[year] || 0); 
        endCounts.push(endYears[year] || 0); 
    });

    createChart('timelineChart', 'line', 
        { 
            labels, 
            datasets: [ 
                { 
                    label: 'Contracts Starting', 
                    data: startCounts, 
                    borderColor: chartSecondaryColor, 
                    backgroundColor: `${chartSecondaryColor}33`, /* 20% opacity */
                    fill: true, 
                    tension: 0.4,
                    pointRadius: 0, 
                    pointHitRadius: 10, 
                    pointHoverRadius: 5 
                }, 
                { 
                    label: 'Contracts Ending', 
                    data: endCounts, 
                    borderColor: chartPrimaryColor, 
                    backgroundColor: `${chartPrimaryColor}33`, /* 20% opacity */
                    fill: true, 
                    tension: 0.4,
                    pointRadius: 0,
                    pointHitRadius: 10,
                    pointHoverRadius: 5
                }  
            ] 
        },
        { 
            responsive: true, maintainAspectRatio: false, 
            plugins: { 
                legend: { display: true, position: 'top'},
                tooltip: { callbacks: { label: ctx => `${ctx.dataset.label || ''}: ${ctx.parsed.y.toLocaleString()}` } } 
            }, 
            scales: { y: { beginAtZero: true, ticks: { callback: val => val.toLocaleString() } } } 
        }
    );
}


function createMarketShareChart(data) {
    const canvasElement = document.getElementById('marketShareChart');
    if (!canvasElement) return; 

    const primeValues = {};
    data.forEach(r => {
        if (r['Legal Business Name']) {
            primeValues[r['Legal Business Name']] = (primeValues[r['Legal Business Name']] || 0) + parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
        }
    });
    const sortedPrimes = Object.entries(primeValues).sort((a, b) => b[1] - a[1]);
    
    const chartLabels = [];
    const chartValues = [];
    const backgroundColors = [
        chartPrimaryColor,
        chartSecondaryColor,
        chartTertiaryColor,
        chartNeutralColor,
        chartGrays[0]
    ];

    sortedPrimes.forEach((item, index) => {
        if (index < 5) {
            chartLabels.push(item[0]);
            chartValues.push(item[1]);
        }
    });
    
    if (sortedPrimes.length > 5) {
        const otherPrimesValue = sortedPrimes.slice(5).reduce((sum, item) => sum + item[1], 0);
        if (otherPrimesValue > 0) {
            chartLabels.push('Others');
            chartValues.push(otherPrimesValue);
        }
    }


    createChart('marketShareChart', 'pie',
        { labels: chartLabels, datasets: [{ data: chartValues, backgroundColor: backgroundColors }] }, 
        { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: { size: 10 } } }, tooltip: { callbacks: { label: ctx => `${ctx.label || ''}: ${formatCurrency(ctx.raw)} (${((ctx.raw / chartValues.reduce((a,b)=>a+b,0)) * 100).toFixed(1)}%)` } } } }
    );
}


// --- Prime Profiles Section & Detail View ---
function initializePrimeProfilesSection(data) { 
    const profiles = {};
    data.forEach(r => {
        const name = r['Legal Business Name']; if (!name) return;
        if (!profiles[name]) profiles[name] = { name: name, contracts: 0, totalValue: 0, naics: new Set(), agencies: new Set(), uei: r['Unique Entity ID'] }; 
        profiles[name].contracts++; profiles[name].totalValue += parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
        if(r['NAICS Code']) profiles[name].naics.add(String(r['NAICS Code'])); 
        if(r['Contracting Agency Name']) profiles[name].agencies.add(r['Contracting Agency Name']);
    });
    function renderCards(filterTerm = '') {
        primeProfilesContainer.innerHTML = ''; let count = 0;
        Object.values(profiles)
            .filter(p => filterTerm === '' || p.name.toLowerCase().includes(filterTerm.toLowerCase()))
            .sort((a,b) => b.totalValue - a.totalValue)
            .forEach(p => { 
                count++;
                const card = document.createElement('div');
                card.className = 'p-3 md:p-4 bg-[var(--surface-level-2)] rounded-lg border border-[var(--border-level-1)] shadow hover:shadow-lg transition-shadow duration-150'; 
                card.innerHTML = `
                    <h4 class="font-semibold text-[var(--accent)] truncate cursor-pointer hover:underline" title="${p.name}" onclick="setUnifiedSearchTerm('${p.name.replace(/'/g, "\\'")}', 'primeName')">${p.name}</h4>
                    <p class="text-xs md:text-sm">Contracts: ${p.contracts.toLocaleString()}</p>
                    <p class="text-xs md:text-sm">Value: ${formatCurrency(p.totalValue)}</p>
                    <p class="text-xs mt-1 truncate" title="Top NAICS: ${Array.from(p.naics).slice(0,3).join(', ')}">Top NAICS: ${Array.from(p.naics).slice(0,3).join(', ')}</p>
                    <p class="text-xs mt-1 truncate" title="Top Agencies: ${Array.from(p.agencies).slice(0,2).join(', ')}">Top Agencies: ${Array.from(p.agencies).slice(0,2).join(', ')}</p>
                    <button class="mt-2 text-xs bg-[var(--accent)] text-[var(--on-accent)] px-2 py-1 rounded hover:bg-opacity-90 transition-colors duration-150 ease-in-out focus:ring-2 focus:ring-offset-2 ring-[var(--accent)] focus:outline-none" style="font-weight: var(--button-font-weight);" onclick="setUnifiedSearchTerm('${p.name.replace(/'/g, "\\'")}', 'primeName')">Filter Dashboard by this Prime</button>`; 
                primeProfilesContainer.appendChild(card);
        });
        if(count === 0) primeProfilesContainer.innerHTML = `<p class="p-4 col-span-full text-center text-[var(--text-secondary)]">No primes match current filters or profile search.</p>`;
    }
    primeProfilesSearchInput.addEventListener('input', _.debounce(() => renderCards(primeProfilesSearchInput.value), 300));
    renderCards(); 
}

function renderPrimeDetailView(primeName, primeSpecificData) {
    if (!primeName || primeSpecificData.length === 0) {
        primeDetailViewSection.classList.add('hidden');
        return;
    }

    primeDetailTitle.textContent = `Details for: ${primeName}`;
    const primeRecord = primeSpecificData[0]; 
    const primeUEI = primeRecord ? primeRecord['Unique Entity ID'] : 'N/A';
    const parentUEI = primeRecord ? primeRecord['Ultimate Parent Unique Entity ID'] : 'N/A';
    const parentName = primeRecord ? primeRecord['Ultimate Parent Legal Business Name'] : 'N/A';

    let totalValue = 0;
    primeSpecificData.forEach(c => {
        totalValue += parseCurrencyValue(c['Base and All Options Value (Total Contract Value)']);
    });

    primeDetailStats.innerHTML = `
        <p><strong>UEI:</strong> ${createEntityLink(primeUEI, primeUEI)}</p> 
        ${parentName && parentName !== 'N/A' ? `<p><strong>Parent:</strong> ${createEntityLink(parentUEI, parentName)}</p>` : ''}
        <p><strong>Total Contracts (current view):</strong> ${primeSpecificData.length.toLocaleString()}</p>
        <p><strong>Total Value (current view):</strong> ${formatCurrency(totalValue)}</p>
        <p><strong>Avg. Contract Value (current view):</strong> ${formatCurrency(primeSpecificData.length > 0 ? totalValue / primeSpecificData.length : 0)}</p>
    `;
    
    currentPrimeDetailViewPage = 1; 
    renderPrimeDetailContractsTable(primeSpecificData, currentPrimeDetailViewPage); 
    primeDetailViewSection.classList.remove('hidden');
}

function renderPrimeDetailContractsTable(contracts, page) {
    const start = (page - 1) * ITEMS_PER_PAGE_MODAL_TABLE;
    const end = start + ITEMS_PER_PAGE_MODAL_TABLE;
    
    // Sort contracts before slicing for pagination
    const sortedContracts = sortPrimeDetailData(contracts, currentPrimeDetailSort.column, currentPrimeDetailSort.order);
    const pageContracts = sortedContracts.slice(start, end);
    
    let tableHTML = `<div class="table-responsive"><table class="min-w-full divide-y divide-[var(--border-level-1)] text-xs">
        <thead class="bg-[var(--surface-level-2)]"><tr>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]" data-sort-prime="id">PIID ${currentPrimeDetailSort.column === 'id' ? (currentPrimeDetailSort.order === 'asc' ? '▲' : '▼') : ''}</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]" data-sort-prime="agency">Agency ${currentPrimeDetailSort.column === 'agency' ? (currentPrimeDetailSort.order === 'asc' ? '▲' : '▼') : ''}</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]" data-sort-prime="office">Office ${currentPrimeDetailSort.column === 'office' ? (currentPrimeDetailSort.order === 'asc' ? '▲' : '▼') : ''}</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]" data-sort-prime="naicsCode">NAICS ${currentPrimeDetailSort.column === 'naicsCode' ? (currentPrimeDetailSort.order === 'asc' ? '▲' : '▼') : ''}</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]" data-sort-prime="naicsDesc">NAICS Desc. ${currentPrimeDetailSort.column === 'naicsDesc' ? (currentPrimeDetailSort.order === 'asc' ? '▲' : '▼') : ''}</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]" data-sort-prime="value">Value ${currentPrimeDetailSort.column === 'value' ? (currentPrimeDetailSort.order === 'asc' ? '▲' : '▼') : ''}</th>
            <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]" data-sort-prime="endDate">End Date ${currentPrimeDetailSort.column === 'endDate' ? (currentPrimeDetailSort.order === 'asc' ? '▲' : '▼') : ''}</th>
        </tr></thead><tbody class="bg-[var(--background)] divide-y divide-[var(--border-level-1)]">`;
    
    pageContracts.forEach(c => {
        tableHTML += `<tr>
            <td class="px-2 py-1 whitespace-nowrap">${createAwardLink(c['Procurement Instrument Identifier'])}</td>
            <td class="px-2 py-1 whitespace-nowrap">${c['Contracting Agency Name'] || 'N/A'}</td>
            <td class="px-2 py-1 whitespace-nowrap">${c['Contracting Office Name'] || 'N/A'}</td>
            <td class="px-2 py-1">${c['NAICS Code'] || 'N/A'}</td>
            <td class="px-2 py-1 whitespace-normal max-w-xs truncate" title="${c['NAICS Description'] || ''}">${c['NAICS Description'] ? c['NAICS Description'].substring(0,50) + (c['NAICS Description'].length > 50 ? '...' : '') : 'N/A'}</td>
            <td class="px-2 py-1 whitespace-nowrap">${formatCurrency(parseCurrencyValue(c['Base and All Options Value (Total Contract Value)']))}</td>
            <td class="px-2 py-1 whitespace-nowrap">${formatDate(c['Completion Date'])}</td>
        </tr>`;
    });
    tableHTML += `</tbody></table></div>`;
    
    const totalPages = Math.ceil(contracts.length / ITEMS_PER_PAGE_MODAL_TABLE);
    if (totalPages > 1) {
         tableHTML += `<div class="mt-3 flex justify-between items-center text-xs">
            <button id="prevPageBtnPrimeDetailView" class="px-2 py-1 border border-[var(--border-level-2)] rounded ${page === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-[var(--surface-level-2)] transition-colors'}" ${page === 1 ? 'disabled' : ''}>Previous</button>
            <span>Page ${page} of ${totalPages}</span>
            <button id="nextPageBtnPrimeDetailView" class="px-2 py-1 border border-[var(--border-level-2)] rounded ${page === totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-[var(--surface-level-2)] transition-colors'}" ${page === totalPages ? 'disabled' : ''}>Next</button>
        </div>`;
    }
    
    primeDetailContractsTableContainer.innerHTML = tableHTML;

    document.querySelectorAll('#primeDetailContractsTableContainer th[data-sort-prime]').forEach(th => {
        th.onclick = () => { 
            const sortColumn = th.dataset.sortPrime;
            if (currentPrimeDetailSort.column === sortColumn) {
                currentPrimeDetailSort.order = currentPrimeDetailSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                currentPrimeDetailSort.column = sortColumn;
                currentPrimeDetailSort.order = 'asc';
            }
            currentPrimeDetailViewPage = 1; 
            // Re-fetch the original primeSpecificData for sorting, not just the 'contracts' (which might be a page)
            const primeSpecificDataForSort = parsedData.filter(r => r['Legal Business Name'] === specificPrimeName);
            const sortedContracts = sortPrimeDetailData(primeSpecificDataForSort, currentPrimeDetailSort.column, currentPrimeDetailSort.order);
            renderPrimeDetailContractsTable(sortedContracts, currentPrimeDetailViewPage);
        };
    });

    if (document.getElementById('prevPageBtnPrimeDetailView')) {
        document.getElementById('prevPageBtnPrimeDetailView').onclick = () => {
            if (currentPrimeDetailViewPage > 1) { 
                currentPrimeDetailViewPage--; 
                const primeSpecificDataForSort = parsedData.filter(r => r['Legal Business Name'] === specificPrimeName);
                const sortedContracts = sortPrimeDetailData(primeSpecificDataForSort, currentPrimeDetailSort.column, currentPrimeDetailSort.order);
                renderPrimeDetailContractsTable(sortedContracts, currentPrimeDetailViewPage); 
            }
        };
    }
    if (document.getElementById('nextPageBtnPrimeDetailView')) {
        document.getElementById('nextPageBtnPrimeDetailView').onclick = () => {
            const primeSpecificDataForSort = parsedData.filter(r => r['Legal Business Name'] === specificPrimeName);
            const totalPagesForButton = Math.ceil(primeSpecificDataForSort.length / ITEMS_PER_PAGE_MODAL_TABLE);
            if (currentPrimeDetailViewPage < totalPagesForButton) { 
                currentPrimeDetailViewPage++; 
                const sortedContracts = sortPrimeDetailData(primeSpecificDataForSort, currentPrimeDetailSort.column, currentPrimeDetailSort.order);
                renderPrimeDetailContractsTable(sortedContracts, currentPrimeDetailViewPage); 
            }
        };
    }
}

function sortPrimeDetailData(data, column, order) {
    return [...data].sort((a, b) => {
        let valA, valB;
        switch (column) {
            case 'id':
                valA = a['Procurement Instrument Identifier'] || '';
                valB = b['Procurement Instrument Identifier'] || '';
                break;
            case 'agency':
                valA = a['Contracting Agency Name'] || '';
                valB = b['Contracting Agency Name'] || '';
                break;
            case 'office':
                valA = a['Contracting Office Name'] || '';
                valB = b['Contracting Office Name'] || '';
                break;
            case 'naicsCode':
                valA = String(a['NAICS Code'] || '');
                valB = String(b['NAICS Code'] || '');
                break;
            case 'naicsDesc':
                valA = a['NAICS Description'] || '';
                valB = b['NAICS Description'] || '';
                break;
            case 'value':
                valA = parseCurrencyValue(a['Base and All Options Value (Total Contract Value)']);
                valB = parseCurrencyValue(b['Base and All Options Value (Total Contract Value)']);
                break;
            case 'endDate':
                valA = new Date(a['Completion Date'] || 0).getTime();
                valB = new Date(b['Completion Date'] || 0).getTime();
                break;
            default:
                return 0;
        }

        if (typeof valA === 'string') valA = valA.toLowerCase();
        if (typeof valB === 'string') valB = valB.toLowerCase();
        
        if (valA < valB) return order === 'asc' ? -1 : 1;
        if (valA > valB) return order === 'asc' ? 1 : -1;
        return 0;
    });
}


function setUnifiedSearchTerm(term, type = 'primeName') { 
    unifiedSearchInput.value = term;
    applyFilter(term, type, term); 
}


// --- Contract Expiration Calendar Section --- 
function initializeContractExpirationCalendarSection(data) { 
    const events = [];
    data.forEach(r => {
        if (r['Completion Date']) {
            const date = new Date(r['Completion Date']);
            if (!isNaN(date.getTime())) events.push({
                date: date, 
                prime: r['Legal Business Name'], 
                value: parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']), 
                id: r['Procurement Instrument Identifier'] || 'N/A',
                agency: r['Contracting Agency Name'] || 'N/A',
                office: r['Contracting Office Name'] || 'N/A' 
            });
        }
    });
    events.sort((a,b) => a.date - b.date);
    
    calendarYearSelect.innerHTML = ''; 
    calendarMonthSelect.innerHTML = ''; 
    const currentYear = new Date().getFullYear();
    for (let i = currentYear - 5; i <= currentYear + 5; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        calendarYearSelect.appendChild(option);
    }
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    monthNames.forEach((month, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = month;
        calendarMonthSelect.appendChild(option);
    });

    currentCalendarDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
    calendarYearSelect.value = currentCalendarDate.getFullYear();
    calendarMonthSelect.value = currentCalendarDate.getMonth();


    calendarPrevBtn.onclick = () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth()-1); updateCalendarSelectors(); renderCalView(); };
    calendarNextBtn.onclick = () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth()+1); updateCalendarSelectors(); renderCalView(); };
    calendarMonthSelect.onchange = () => { currentCalendarDate.setMonth(parseInt(calendarMonthSelect.value)); renderCalView(); };
    calendarYearSelect.onchange = () => { currentCalendarDate.setFullYear(parseInt(calendarYearSelect.value)); renderCalView(); };

    function updateCalendarSelectors() {
        calendarYearSelect.value = currentCalendarDate.getFullYear();
        calendarMonthSelect.value = currentCalendarDate.getMonth();
    }


    function renderCalView() {
        const year = currentCalendarDate.getFullYear(), month = currentCalendarDate.getMonth();
        calendarTitleEl.textContent = `${new Intl.DateTimeFormat('en-US',{month:'long'}).format(currentCalendarDate)} ${year}`;
        const firstD = new Date(year,month,1), lastD = new Date(year,month+1,0);
        const daysInM = lastD.getDate(), firstDOW = firstD.getDay();
        let html = ''; const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        dayNames.forEach(d => {html += `<div class="calendar-day-header text-xs sm:text-sm">${d}</div>`;});
        for(let i=0; i<firstDOW; i++) html+='<div class="p-1 sm:p-2 border bg-gray-50 dark:bg-gray-800 dark:border-gray-700 min-h-[60px] sm:min-h-[80px]"></div>';
        for(let day=1; day<=daysInM; day++) {
            const currentDateObj = new Date(year, month, day);
            const dEvents = events.filter(e=>e.date.getFullYear()===year && e.date.getMonth()===month && e.date.getDate()===day);
            let dayBgClass = 'bg-white dark:bg-gray-800 dark:border-gray-700';
            if (dEvents.length > 0) dayBgClass = 'bg-blue-50 dark:bg-blue-900 dark:border-blue-700';
            if (dEvents.length > 2) dayBgClass = 'bg-blue-100 dark:bg-blue-800 dark:border-blue-600'; 
            if (dEvents.length > 5) dayBgClass = 'bg-blue-200 dark:bg-blue-700 dark:border-blue-500'; 

            html += `<div class="calendar-day-cell p-1 sm:p-2 border dark:border-gray-700 min-h-[60px] sm:min-h-[80px] relative ${dayBgClass}" 
                         ${dEvents.length > 0 ? `onclick="showCalendarDayDetailsModal(new Date(${year},${month},${day}), JSON.parse(this.dataset.eventsJson))" data-events-json='${JSON.stringify(dEvents).replace(/'/g, "&apos;")}'` : ''}
                         role="button" tabindex="0" aria-label="${dEvents.length > 0 ? dEvents.length + ' contracts ending' : 'No contracts ending'} on ${formatDate(currentDateObj)}">
                        <div class="font-semibold text-right text-gray-700 dark:text-gray-300 text-xs sm:text-sm">${day}</div>`;
            dEvents.slice(0,2).forEach(e => {html+=`<div class="calendar-event" title="${e.prime} (${formatCurrency(e.value)}) - ID: ${e.id}">${e.prime?e.prime.substring(0,8)+(e.prime.length>8?'...':''):'Contract'}</div>`;});
            if(dEvents.length>2) html+=`<div class="text-xs mt-1">${dEvents.length-2} more</div>`;
            html += `</div>`;
        }
        calendarGridEl.innerHTML = html;
    }
    renderCalView(); 
}

function showCalendarDayDetailsModal(dateObj, eventsOnDate) {
    const formattedDate = formatDate(dateObj);
    let currentCalendarPage = 1;
    // currentCalendarModalSort is a global variable

    function sortEvents(events, column, order) { 
        return [...events].sort((a, b) => {
            let valA = a[column];
            let valB = b[column];
            if (column === 'value') {
                valA = parseFloat(valA); 
                valB = parseFloat(valB);
            } else if (typeof valA === 'string') {
                valA = valA.toLowerCase();
                valB = valB.toLowerCase();
            } else if (valA === null || valA === undefined) { 
                return order === 'asc' ? -1 : 1;
            } else if (valB === null || valB === undefined) {
                return order === 'asc' ? 1 : -1;
            }

            if (valA < valB) return order === 'asc' ? -1 : 1;
            if (valA > valB) return order === 'asc' ? 1 : -1;
            return 0;
        });
    }
    
    let sortedEvents = sortEvents(eventsOnDate, currentCalendarModalSort.column, currentCalendarModalSort.order);


    function renderCalendarDayPage(page, sortedData) {
        const start = (page - 1) * ITEMS_PER_PAGE_MODAL_TABLE;
        const end = start + ITEMS_PER_PAGE_MODAL_TABLE;
        const pageEvents = sortedData.slice(start, end);

        let tableHTML = `<div class="table-responsive"><table class="min-w-full divide-y divide-[var(--border-level-1)] text-xs">
            <thead class="bg-[var(--surface-level-2)]"><tr> 
                <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]" data-sort-cal="id">PIID ${currentCalendarModalSort.column === 'id' ? (currentCalendarModalSort.order === 'asc' ? '▲' : '▼') : ''}</th>
                <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]" data-sort-cal="prime">Prime ${currentCalendarModalSort.column === 'prime' ? (currentCalendarModalSort.order === 'asc' ? '▲' : '▼') : ''}</th>
                <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]" data-sort-cal="agency">Agency ${currentCalendarModalSort.column === 'agency' ? (currentCalendarModalSort.order === 'asc' ? '▲' : '▼') : ''}</th>
                <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]" data-sort-cal="office">Office ${currentCalendarModalSort.column === 'office' ? (currentCalendarModalSort.order === 'asc' ? '▲' : '▼') : ''}</th>
                <th class="px-2 py-2 text-left font-medium text-[var(--text-secondary)]" data-sort-cal="value">Value ${currentCalendarModalSort.column === 'value' ? (currentCalendarModalSort.order === 'asc' ? '▲' : '▼') : ''}</th>
            </tr></thead>
            <tbody class="bg-[var(--background)] divide-y divide-[var(--border-level-1)]">`;
        pageEvents.forEach(event => {
            tableHTML += `<tr>
                <td class="px-2 py-1 whitespace-nowrap">${createAwardLink(event.id)}</td>
                <td class="px-2 py-1 whitespace-nowrap">${event.prime || 'N/A'}</td>
                <td class="px-2 py-1 whitespace-nowrap">${event.agency || 'N/A'}</td>
                <td class="px-2 py-1 whitespace-nowrap">${event.office || 'N/A'}</td>
                <td class="px-2 py-1 whitespace-nowrap">${formatCurrency(event.value)}</td>
            </tr>`;
        });
        tableHTML += `</tbody></table></div>`;
        
        const totalPages = Math.ceil(sortedData.length / ITEMS_PER_PAGE_MODAL_TABLE);
        if (totalPages > 1) { 
            tableHTML += `<div class="mt-3 flex justify-between items-center text-xs">
                <button id="prevPageBtnCal" class="px-2 py-1 border border-[var(--border-level-2)] rounded ${page === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-[var(--surface-level-2)] transition-colors'}" ${page === 1 ? 'disabled' : ''}>Previous</button>
                <span>Page ${page} of ${totalPages}</span>
                <button id="nextPageBtnCal" class="px-2 py-1 border border-[var(--border-level-2)] rounded ${page === totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-[var(--surface-level-2)] transition-colors'}" ${page === totalPages ? 'disabled' : ''}>Next</button>
            </div>`;
        }
        
        const tableContainer = document.getElementById('calendarDayTableContainer');
        if (tableContainer) {
            tableContainer.innerHTML = tableHTML;
        } else { 
            genericModalBody.innerHTML = `
                <p class="mb-3 text-sm text-[var(--text-secondary)]">Total Contracts Ending: ${sortedData.length}</p>
                <div id="calendarDayTableContainer">${tableHTML}</div>`;
        }

        document.querySelectorAll('#calendarDayTableContainer th[data-sort-cal]').forEach(th => {
            th.onclick = () => { 
                const sortColumn = th.dataset.sortCal;
                if (currentCalendarModalSort.column === sortColumn) {
                    currentCalendarModalSort.order = currentCalendarModalSort.order === 'asc' ? 'desc' : 'asc';
                } else {
                    currentCalendarModalSort.column = sortColumn;
                    currentCalendarModalSort.order = 'asc';
                }
                currentCalendarPage = 1; 
                sortedEvents = sortEvents(eventsOnDate, currentCalendarModalSort.column, currentCalendarModalSort.order); 
                renderCalendarDayPage(currentCalendarPage, sortedEvents);
            };
        });


        if (document.getElementById('prevPageBtnCal')) {
            document.getElementById('prevPageBtnCal').onclick = () => {
                if (currentCalendarPage > 1) { currentCalendarPage--; renderCalendarDayPage(currentCalendarPage, sortedEvents); }
            };
        }
        if (document.getElementById('nextPageBtnCal')) {
            document.getElementById('nextPageBtnCal').onclick = () => {
                if (currentCalendarPage < totalPages) { currentCalendarPage++; renderCalendarDayPage(currentCalendarPage, sortedEvents); }
            };
        }
    }
    
    const initialModalHTML = `
        <p class="mb-3 text-sm text-[var(--text-secondary)]">Total Contracts Ending: ${eventsOnDate.length}</p>
        <div id="calendarDayTableContainer">
        </div>`;

    openModal(`Contract Expirations for ${formattedDate}`, initialModalHTML, 'modal-content-lg'); 
    renderCalendarDayPage(currentCalendarPage, sortedEvents); 
}


// --- Event Listeners for Chart Filters ---
document.getElementById('stateChartFilters_main').addEventListener('click', function(e) { 
    if (e.target.classList.contains('filter-btn')) {
        const filterType = e.target.dataset.filter;
        currentMainStateChartFilter = filterType;
        this.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
        applyFilter(unifiedSearchInput.value.trim()); 
    }
});

// --- File Input Handling ---
csvFileInput.addEventListener('change', function(e) { 
    const file = e.target.files[0]; if (!file) { fileNameDisplay.textContent = 'No file'; return; }
    fileNameDisplay.textContent = file.name; showProcessingBriefly();
    Papa.parse(file, {
        header: true, dynamicTyping: true, skipEmptyLines: true,
        complete: results => {
            if (results.errors && results.errors.length > 0) { showErrorMessage('CSV Error: ' + results.errors[0].message); return; }
            if (results.data && results.data.length > 0) {
                showSuccessMessage('File processed!', false); processAndInitialize(results.data);
                s3LoadErrorDiv.classList.add('hidden'); 
            } else showErrorMessage('No data in file.');
        },
        error: error => showErrorMessage('CSV Parse Fail: ' + error.message)
    });
});

// --- Theme Toggle & Share View Logic ---
function applyInitialTheme() {
    document.documentElement.classList.remove('dark');
    localStorage.removeItem('theme'); 
    
    if (themeIconSun && themeIconMoon) { 
        themeIconSun.classList.remove('hidden');
        themeIconMoon.classList.add('hidden');
    }
    updateChartDefaults();
}

function updateChartDefaults() {
    const isDarkMode = document.documentElement.classList.contains('dark');
    const styles = getComputedStyle(document.documentElement);
    const textColor = styles.getPropertyValue('--text-secondary').trim(); 
    const gridColor = styles.getPropertyValue('--border-level-2').trim(); 

    Chart.defaults.color = textColor;
    Chart.defaults.borderColor = gridColor;
    
    if (parsedData && parsedData.length > 0) { 
        if (isViewingSpecificPrime && specificPrimeName) {
            applyFilter(specificPrimeName, 'primeName', specificPrimeName);
        } else {
            applyFilter(unifiedSearchInput.value.trim());
        }
    }
}


if (themeToggleBtn) {
    themeToggleBtn.addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
        if (document.documentElement.classList.contains('dark')) {
            localStorage.setItem('theme', 'dark');
            if(themeIconSun) themeIconSun.classList.add('hidden');
            if(themeIconMoon) themeIconMoon.classList.remove('hidden');
        } else {
            localStorage.setItem('theme', 'light');
            if(themeIconSun) themeIconSun.classList.remove('hidden');
            if(themeIconMoon) themeIconMoon.classList.add('hidden');
        }
        getChartColors(); 
        updateChartDefaults();
    });
}


shareViewBtn.addEventListener('click', () => {
    const url = new URL(window.location.href);
    url.searchParams.delete('search'); 
    url.searchParams.delete('filterType'); 
    url.searchParams.delete('filterValue'); 

    const currentSearchTermInBar = unifiedSearchInput.value.trim();

    if (isViewingSpecificPrime && specificPrimeName) { 
        url.searchParams.set('filterType', 'primeName');
        url.searchParams.set('filterValue', specificPrimeName);
    } else if (currentSearchTermInBar) { 
        url.searchParams.set('search', currentSearchTermInBar);
    }
    
    navigator.clipboard.writeText(url.toString()).then(() => {
        shareToast.classList.remove('hidden');
        setTimeout(() => {
            shareToast.classList.add('hidden');
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy URL: ', err);
        alert('Failed to copy link. Please copy the URL from your browser bar.');
    });
});

function applyFiltersFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    const searchParam = urlParams.get('search');
    const filterTypeParam = urlParams.get('filterType');
    const filterValueParam = urlParams.get('filterValue');

    if (filterTypeParam && filterValueParam) {
        unifiedSearchInput.value = filterValueParam; 
        applyFilter(filterValueParam, filterTypeParam, filterValueParam);
    } else if (searchParam) {
        unifiedSearchInput.value = searchParam;
        applyFilter(searchParam); 
    }
}


// --- Page Load ---
document.addEventListener('DOMContentLoaded', () => {
    loadDataFromS3(); 
	loadCompanyMapFromS3();
});
</script>
</body>
</html>