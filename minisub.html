<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamlined Federal Business Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            height: 300px; /* Default height, can be overridden */
            width: 100%;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .calendar-day-header {
            font-weight: 600;
            text-align: center;
            padding: 5px 0;
            background-color: #2980b9; /* Tailwind: bg-blue-600 */
            color: white;
            border-radius: 4px;
        }
         .calendar-event {
            padding: 3px 5px;
            background-color: #3498db;
            color: white;
            border-radius: 3px;
            margin-bottom: 3px;
            font-size: 11px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .calendar-event:hover {
            background-color: #2980b9;
        }
        .event-tooltip {
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-width: 300px;
            display: none;
        }
        /* Styles for filter buttons on charts */
        .metric-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            justify-content: center; /* Center filter buttons */
        }
        .filter-btn {
            padding: 4px 8px; /* Smaller padding */
            background-color: #f1f1f1; /* Tailwind: bg-gray-200 */
            border: 1px solid #ddd; /* Tailwind: border border-gray-300 */
            border-radius: 4px; /* Tailwind: rounded */
            cursor: pointer;
            font-size: 12px; /* Smaller font */
            transition: background-color 0.2s;
        }
        .filter-btn.active {
            background-color: #2980b9; /* Tailwind: bg-blue-600 */
            color: white;
            border-color: #2980b9; /* Tailwind: border-blue-600 */
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">
    <div class="dashboard-container max-w-7xl mx-auto">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Federal Business Development Dashboard</h1>
            <p class="text-gray-600">Prime to Subcontractor Teaming Opportunities</p>
        </header>

        <section id="fileInputSection" class="bg-white p-6 rounded-lg shadow-md mb-6">
            <div id="autoload-section" class="mb-1">
                <div id="processingIndicator" class="hidden items-center text-gray-700">
                    <div class="spinner"></div>
                    <span class="ml-2">Processing data...</span>
                </div>
                <p id="autoload-status" class="hidden"></p> 
            </div>
            <div id="manual-upload-section" class="hidden">
                <h3 class="text-xl font-semibold text-gray-700 mb-2">Upload Federal Contractor CSV Data</h3>
                <p class="text-sm text-gray-600 mb-4">If auto-loading fails or you want to use a different file, you can manually upload <code>sbaall.csv</code></p>
                <div class="flex items-center gap-4 mb-4">
                    <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                    <label for="csvFileInput" class="px-4 py-2 bg-blue-500 text-white rounded-md cursor-pointer hover:bg-blue-600 transition-colors">Choose CSV File</label>
                    <span id="file-name-display" class="text-sm text-gray-700 p-2 border border-gray-300 rounded-md min-w-[200px]">No file selected</span>
                </div>
                <div id="errorMessage" class="text-red-600 bg-red-100 p-3 rounded-md hidden mb-2">Error processing file.</div>
                <div id="successMessage" class="text-green-600 bg-green-100 p-3 rounded-md hidden mb-2">File processed successfully.</div>
                <div class="mt-4">
                    <a href="https://subhoodata.s3.us-east-1.amazonaws.com/data/sbaall.csv" download class="text-blue-500 hover:text-blue-600 hover:underline text-sm">Download sbaall.csv from S3</a>
                </div>
            </div>
        </section>

        <main id="dashboardContent" class="hidden">
            <section id="statisticsSection" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="stat-card bg-white p-4 rounded-lg shadow">
                    <div class="text-3xl font-bold text-blue-600" id="totalContractsValue">0</div>
                    <div class="text-sm text-gray-500">Total Contracts</div>
                </div>
                <div class="stat-card bg-white p-4 rounded-lg shadow">
                    <div class="text-3xl font-bold text-blue-600" id="totalValueValue">$0</div>
                    <div class="text-sm text-gray-500">Total Contract Value</div>
                </div>
                <div class="stat-card bg-white p-4 rounded-lg shadow">
                    <div class="text-3xl font-bold text-blue-600" id="avgContractValue">$0</div>
                    <div class="text-sm text-gray-500">Average Contract Value</div>
                </div>
                <div class="stat-card bg-white p-4 rounded-lg shadow">
                    <div class="text-3xl font-bold text-blue-600" id="uniquePrimesValue">0</div>
                    <div class="text-sm text-gray-500">Unique Prime Contractors</div>
                </div>
            </section>

            <section id="advancedFiltersSection" class="bg-white p-6 rounded-lg shadow-md mb-6">
                <details class="group">
                    <summary class="flex justify-between items-center font-semibold text-gray-700 cursor-pointer hover:text-blue-600">
                        Advanced Filtering Options
                        <span class="text-sm text-blue-500 group-open:rotate-180 transition-transform duration-300 transform">&#9660;</span>
                    </summary>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="filter-group">
                            <label for="naicsFilter" class="block text-sm font-medium text-gray-700 mb-1">NAICS Code</label>
                            <select id="naicsFilter" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">All NAICS Codes</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="agencyFilter" class="block text-sm font-medium text-gray-700 mb-1">Department/Agency</label>
                            <select id="agencyFilter" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">All Departments/Agencies</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="stateFilter" class="block text-sm font-medium text-gray-700 mb-1">State</label>
                            <select id="stateFilter" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">All States</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end gap-3">
                        <button id="clearFiltersBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">Clear Filters</button>
                        <button id="applyFiltersBtn" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">Apply Filters</button>
                    </div>
                </details>
            </section>
            <div id="activeFilterIndicator" class="bg-blue-100 text-blue-700 p-3 rounded-md mb-6 hidden flex justify-between items-center">
                <span>Filtered by: [Prime Name]</span>
                <button class="clear-filter-btn-tailwind bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600">Clear Filter</button>
            </div>

            <section id="primeSearchSection" class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">Prime Contractor Search</h2>
                <input type="text" id="primeSearchInput" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 mb-3" placeholder="Search for a prime contractor...">
                <div id="searchResults" class="max-h-60 overflow-y-auto border border-gray-200 rounded-md"></div>
            </section>

            <section id="coreChartsSection" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="dashboard-card bg-white p-6 rounded-lg shadow">
                    <h2 class="text-lg font-semibold text-gray-700 mb-3 text-center">Top Prime Contractors by Contract Value</h2>
                    <div class="chart-container">
                        <canvas id="primeContractorsChart"></canvas>
                    </div>
                </div>
                <div class="dashboard-card bg-white p-6 rounded-lg shadow">
                    <h2 class="text-lg font-semibold text-gray-700 mb-3 text-center">Department Contract Distribution</h2>
                    <div class="chart-container">
                        <canvas id="departmentChart"></canvas>
                    </div>
                </div>
                <div class="dashboard-card bg-white p-6 rounded-lg shadow">
                    <h2 class="text-lg font-semibold text-gray-700 mb-3 text-center">Top NAICS by Contract Value</h2>
                    <div class="chart-container">
                        <canvas id="naicsChart_main"></canvas>
                    </div>
                </div>
                <div class="dashboard-card bg-white p-6 rounded-lg shadow">
                    <h2 class="text-lg font-semibold text-gray-700 mb-3 text-center">Contract Type Breakdown</h2>
                    <div class="chart-container">
                        <canvas id="contractTypeChart_main"></canvas>
                    </div>
                </div>
                <div class="dashboard-card bg-white p-6 rounded-lg shadow lg:col-span-2"> <h2 class="text-lg font-semibold text-gray-700 mb-1 text-center">Contract Distribution by State</h2>
                    <div class="metric-filters" id="stateChartFilters_main">
                        <button class="filter-btn active" data-filter="count" data-chart="stateContractsChart_main">By Count</button>
                        <button class="filter-btn" data-filter="value" data-chart="stateContractsChart_main">By Value</button>
                    </div>
                    <div class="chart-container" style="height: 320px;"> <canvas id="stateContractsChart_main"></canvas>
                    </div>
                </div>
            </section>
            
            <section id="primeProfilesSection" class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">Prime Contractor Profiles</h2>
                <div class="mb-4">
                    <input type="text" id="primeProfilesSearchInput" class="w-full md:w-1/2 lg:w-1/3 p-2 border border-gray-300 rounded-md" placeholder="Search prime contractors in profiles...">
                </div>
                <div id="primeProfilesContainer" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 max-h-[70vh] overflow-y-auto"></div>
            </section>

            <section id="recompeteCalendarSection" class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">Recompete Opportunity Calendar</h2>
                <div class="calendar-container min-h-[400px] border border-gray-200 rounded-md p-4">
                    <div class="flex justify-between items-center mb-4">
                        <button id="calendarPrevBtn" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">&lt;</button>
                        <h3 id="calendarTitle" class="text-lg font-semibold">Month Year</h3>
                        <button id="calendarNextBtn" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">&gt;</button>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-1 text-sm"></div>
                </div>
            </section>
            </main>
    </div>
    <div class="event-tooltip"></div>

<script>
// --- DOM Elements ---
const processingIndicator = document.getElementById('processingIndicator');
const manualUploadSection = document.getElementById('manual-upload-section');
const dashboardContent = document.getElementById('dashboardContent');
const csvFileInput = document.getElementById('csvFileInput');
const fileNameDisplay = document.getElementById('file-name-display');
const errorMessageDiv = document.getElementById('errorMessage');
const successMessageDiv = document.getElementById('successMessage');

const primeProfilesContainer = document.getElementById('primeProfilesContainer');
const primeProfilesSearchInput = document.getElementById('primeProfilesSearchInput');
const calendarPrevBtn = document.getElementById('calendarPrevBtn');
const calendarNextBtn = document.getElementById('calendarNextBtn');
const calendarTitleEl = document.getElementById('calendarTitle');
const calendarGridEl = document.getElementById('calendarGrid');
const globalTooltipEl = document.querySelector('.event-tooltip');

// --- Global Variables ---
let parsedData = [];
const charts = {}; 
let activeFilter = null; 
const S3_CSV_URL = 'https://subhoodata.s3.us-east-1.amazonaws.com/data/sbaall.csv';
let currentMainStateChartFilter = 'count'; // For the new main page state chart

// --- Utility Functions ---
function formatCurrency(value) { return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value); }
function parseCurrencyValue(valueStr) { if (!valueStr) return 0; return parseFloat(String(valueStr).replace(/[$,\s]/g, '')) || 0; }
function formatDate(dateStr) { if (!dateStr) return ''; const date = new Date(dateStr); return isNaN(date.getTime()) ? '' : new Intl.DateTimeFormat('en-US', { year: 'numeric', month: 'short', day: 'numeric' }).format(date); }

function showProcessingBriefly() { processingIndicator.classList.remove('hidden'); }
function hideProcessing() { processingIndicator.classList.add('hidden'); }

function showErrorMessage(message, isAutoloadError = false) {
    if (isAutoloadError) {
        manualUploadSection.classList.remove('hidden');
        const fileInputSection = document.getElementById('fileInputSection');
        let s3ErrorDiv = document.getElementById('s3LoadError');
        if (!s3ErrorDiv) {
            s3ErrorDiv = document.createElement('div'); s3ErrorDiv.id = 's3LoadError';
            s3ErrorDiv.className = 'text-red-600 bg-red-100 p-3 rounded-md mb-2';
            fileInputSection.insertBefore(s3ErrorDiv, manualUploadSection);
        }
        s3ErrorDiv.textContent = `S3 Auto-load failed: ${message}. Please use manual upload.`;
    } else {
        errorMessageDiv.textContent = message; errorMessageDiv.classList.remove('hidden');
        successMessageDiv.classList.add('hidden');
    }
    hideProcessing();
}

function showSuccessMessage(message, isAutoloadSuccess = false) {
    if (isAutoloadSuccess) {
        const s3ErrorDiv = document.getElementById('s3LoadError');
        if (s3ErrorDiv) s3ErrorDiv.classList.add('hidden');
    } else {
        successMessageDiv.textContent = message; successMessageDiv.classList.remove('hidden');
        errorMessageDiv.classList.add('hidden');
    }
    hideProcessing();
}

// --- Data Processing and Chart Initialization ---
function cleanupCharts() { Object.keys(charts).forEach(key => { if (charts[key]) { charts[key].destroy(); charts[key] = null; } }); }

function processAndInitialize(data) {
    if (!data || data.length === 0) { showErrorMessage('No data to display. Please try manual upload or check the S3 source.', true); return; }
    parsedData = data; activeFilter = null;
    document.getElementById('activeFilterIndicator').classList.add('hidden');
    dashboardContent.classList.remove('hidden');
    manualUploadSection.classList.remove('highlight-section');
    cleanupCharts(); populateFilterOptions(); initializeCoreVisuals(parsedData);
    setupPrimeSearch(parsedData); initializePrimeProfilesSection(parsedData);
    initializeRecompeteCalendarSection(parsedData);
    showSuccessMessage('Data loaded and dashboard initialized.', true);
    hideProcessing();
}

// --- S3 Data Loading ---
function loadDataFromS3() {
    showProcessingBriefly();
    fetch(S3_CSV_URL, { mode: 'cors', cache: 'no-cache', headers: { 'Accept': 'text/csv' } })
    .then(response => {
        if (!response.ok) {
            let errorDetail = `HTTP error ${response.status}`;
            if (response.status === 0) errorDetail = "Network error or CORS issue.";
            else if (response.status === 403) errorDetail = "Access Forbidden (403).";
            else if (response.status === 404) errorDetail = "File Not Found (404).";
            throw new Error(`Failed to fetch data from S3. ${errorDetail}`);
        }
        return response.text();
    })
    .then(csvText => {
        if (!csvText || csvText.trim() === '') { showErrorMessage('S3 file is empty.', true); return; }
        Papa.parse(csvText, {
            header: true, dynamicTyping: true, skipEmptyLines: true,
            complete: results => {
                if (results.errors && results.errors.length > 0) { showErrorMessage('Error parsing CSV from S3: ' + results.errors[0].message, true); return; }
                if (results.data && results.data.length > 0) processAndInitialize(results.data);
                else showErrorMessage('No data parsed from S3 file.', true);
            },
            error: error => showErrorMessage('Error parsing CSV data from S3: ' + error.message, true)
        });
    })
    .catch(error => {
        let errorMsg = error.message; 
        if (navigator.onLine === false && !errorMsg.includes("offline")) errorMsg += " You appear to be offline.";
        showErrorMessage(errorMsg, true);
    });
}

// --- Populate Filter Dropdowns (Simplified) ---
function populateFilterOptions() {
    const naicsCodes = new Set(), agencies = new Set(), states = new Set();
    parsedData.forEach(r => {
        if (r['NAICS Code']) naicsCodes.add(`${r['NAICS Code']}|${(r['NAICS Description'] || '').substring(0, 50)}`);
        if (r['Contracting Department Name']) agencies.add(r['Contracting Department Name']);
        if (r['Principal Place of Performance State Code']) states.add(r['Principal Place of Performance State Code']);
    });
    const populateSelect = (id, set, defaultText, formatter) => {
        const el = document.getElementById(id); el.innerHTML = `<option value="">${defaultText}</option>`;
        Array.from(set).sort().forEach(item => {
            const opt = document.createElement('option');
            if (formatter) { const { value, text } = formatter(item); opt.value = value; opt.textContent = text; }
            else { opt.value = item; opt.textContent = item || 'N/S'; }
            el.appendChild(opt);
        });
    };
    populateSelect('naicsFilter', naicsCodes, 'All NAICS', item => { const [c,d]=item.split('|'); return {value:c, text:`${c} - ${d}`};});
    populateSelect('agencyFilter', agencies, 'All Agencies');
    populateSelect('stateFilter', states, 'All States');
}

// --- Apply Advanced Filters (Simplified) ---
function applyAdvancedFilters() {
    const filters = {
        naics: document.getElementById('naicsFilter').value,
        agency: document.getElementById('agencyFilter').value,
        state: document.getElementById('stateFilter').value,
    };
    let filteredData = parsedData.filter(r => 
        (!filters.naics || r['NAICS Code'] == filters.naics) &&
        (!filters.agency || r['Contracting Department Name'] === filters.agency) &&
        (!filters.state || r['Principal Place of Performance State Code'] === filters.state)
    );
    initializeCoreVisuals(filteredData); 
    initializePrimeProfilesSection(filteredData);
    initializeRecompeteCalendarSection(filteredData);
    updateActiveFilterIndicator(filteredData.length < parsedData.length, filteredData.length);
}

function clearAdvancedFilters() {
    document.getElementById('naicsFilter').value = ''; document.getElementById('agencyFilter').value = ''; document.getElementById('stateFilter').value = '';
    initializeCoreVisuals(parsedData); initializePrimeProfilesSection(parsedData); initializeRecompeteCalendarSection(parsedData);
    updateActiveFilterIndicator(false);
}

function updateActiveFilterIndicator(isFiltered, count) {
    const ind = document.getElementById('activeFilterIndicator');
    if (isFiltered) {
        ind.innerHTML = `<span>Filtered: ${count.toLocaleString()} of ${parsedData.length.toLocaleString()}</span> <button class="clear-filter-btn-tailwind" onclick="clearAdvancedFilters()">Clear</button>`;
        ind.classList.remove('hidden');
    } else ind.classList.add('hidden');
}

// --- Initialize Core Visualizations ---
function initializeCoreVisuals(data) {
    updateStatistics(data);
    createPrimeContractorsChart(data);
    createDepartmentChart(data);
    createNaicsChart_main(data); // New main page chart
    createContractTypeChart_main(data); // New main page chart
    createStateContractsChart_main(data, currentMainStateChartFilter); // New main page chart
}

// --- Statistics Update ---
function updateStatistics(data) {
    if (!data || data.length === 0) { /* ... (same as before) ... */ return; }
    document.getElementById('totalContractsValue').textContent = data.length.toLocaleString();
    let totalValue = 0, contractsWithValue = 0;
    data.forEach(r => { const v = parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']); if (v>0) {totalValue+=v; contractsWithValue++;}});
    document.getElementById('totalValueValue').textContent = formatCurrency(totalValue);
    document.getElementById('avgContractValue').textContent = formatCurrency(contractsWithValue > 0 ? totalValue / contractsWithValue : 0);
    document.getElementById('uniquePrimesValue').textContent = new Set(data.map(r => r['Legal Business Name']).filter(Boolean)).size.toLocaleString();
}

// --- Chart Creation Functions ---
function createChart(canvasId, type, data, options) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    if (charts[canvasId]) charts[canvasId].destroy();
    charts[canvasId] = new Chart(ctx, { type, data, options });
}

function createPrimeContractorsChart(data) {
    const primeValues = {};
    data.forEach(r => { if (r['Legal Business Name']) primeValues[r['Legal Business Name']] = (primeValues[r['Legal Business Name']] || 0) + parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']); });
    const sorted = Object.entries(primeValues).sort((a,b)=>b[1]-a[1]).slice(0,10);
    createChart('primeContractorsChart', 'bar', 
        { labels: sorted.map(i=>i[0]), datasets: [{ label: 'Contract Value', data: sorted.map(i=>i[1]), backgroundColor: 'rgba(54, 162, 235, 0.7)' }] },
        { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false}, tooltip:{callbacks:{label:c=>formatCurrency(c.raw)}}}, scales: {x:{ticks:{callback:v=>formatCurrency(v).slice(0,-3)+'k'}}, y:{ticks:{autoSkip:false, callback:function(v){const l=this.getLabelForValue(v); return l.length>18?l.substring(0,15)+'...':l;}}}}}
    );
}

function createDepartmentChart(data) {
    const deptValues = {};
    data.forEach(r => { if (r['Contracting Department Name']) deptValues[r['Contracting Department Name']] = (deptValues[r['Contracting Department Name']] || 0) + parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']); });
    const sorted = Object.entries(deptValues).sort((a,b)=>b[1]-a[1]).slice(0,10);
    createChart('departmentChart', 'pie',
        { labels: sorted.map(i=>i[0]), datasets: [{ data: sorted.map(i=>i[1]), backgroundColor: ['#3B82F6','#EF4444','#F59E0B','#10B981','#8B5CF6','#EC4899','#6366F1','#FBBF24','#22C55E','#D946EF'] }] },
        { responsive: true, maintainAspectRatio: false, plugins: { legend: {position:'right', labels:{boxWidth:12,font:{size:10}}}, tooltip:{callbacks:{label:c=>`${c.label||''}: ${formatCurrency(c.raw)}`}}}}
    );
}

// New chart for NAICS on main page
function createNaicsChart_main(data) {
    const naicsValues = {}, naicsDesc = {};
    data.forEach(r => {
        if (r['NAICS Code']) {
            naicsValues[r['NAICS Code']] = (naicsValues[r['NAICS Code']] || 0) + parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
            if (!naicsDesc[r['NAICS Code']]) naicsDesc[r['NAICS Code']] = r['NAICS Description'] || '';
        }
    });
    const sorted = Object.entries(naicsValues).sort((a,b)=>b[1]-a[1]).slice(0,10);
    createChart('naicsChart_main', 'bar',
        { labels: sorted.map(i=>`${i[0]} - ${naicsDesc[i[0]].substring(0,20)}...`), datasets: [{ label: 'Contract Value', data: sorted.map(i=>i[1]), backgroundColor: 'rgba(22, 163, 74, 0.7)' }] }, // Green
        { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false}, tooltip:{callbacks:{label:c=>formatCurrency(c.raw)}}}, scales: {x:{ticks:{callback:v=>formatCurrency(v).slice(0,-3)+'k'}}}}
    );
}

// New chart for Contract Types on main page
function createContractTypeChart_main(data) {
    const contractTypes = {};
    data.forEach(r => { if (r['Award or Indefinite Delivery Vehicle Type']) contractTypes[r['Award or Indefinite Delivery Vehicle Type']] = (contractTypes[r['Award or Indefinite Delivery Vehicle Type']] || 0) + 1; });
    createChart('contractTypeChart_main', 'doughnut',
        { labels: Object.keys(contractTypes), datasets: [{ data: Object.values(contractTypes), backgroundColor: ['#3B82F6','#EF4444','#F59E0B','#10B981','#8B5CF6', '#F472B6', '#6B7280', '#06B6D4', '#F97316', '#84CC16'] }] }, // More colors
        { responsive: true, maintainAspectRatio: false, plugins: { legend: {position:'right', labels:{boxWidth:12,font:{size:10}}}, tooltip:{callbacks:{label:c=>`${c.label||''}: ${c.raw.toLocaleString()}`}}}}
    );
}

// New chart for State Contracts on main page
function createStateContractsChart_main(data, filterType = 'count') {
    const stateData = {}; // Stores { count: X, value: Y } for each state
    data.forEach(r => {
        const state = r['Principal Place of Performance State Code'];
        if (state) {
            if (!stateData[state]) stateData[state] = { count: 0, value: 0 };
            stateData[state].count++;
            stateData[state].value += parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
        }
    });
    const sorted = Object.entries(stateData).sort((a,b) => b[1][filterType] - a[1][filterType]).slice(0,10);
    createChart('stateContractsChart_main', 'bar',
        { labels: sorted.map(i=>i[0]), datasets: [{ label: filterType === 'count' ? 'Number of Contracts' : 'Total Contract Value', data: sorted.map(i=>i[1][filterType]), backgroundColor: 'rgba(139, 92, 246, 0.7)' }] }, // Purple
        { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false}, tooltip:{callbacks:{label:c=> filterType === 'count' ? c.raw.toLocaleString() : formatCurrency(c.raw)}}}, scales: {y:{ticks:{callback:v=> filterType==='count'?v.toLocaleString():formatCurrency(v).slice(0,-3)+'k'}}}}
    );
}


// --- Prime Search (Main Search Bar) ---
function setupPrimeSearch(allData) {
    const searchInput = document.getElementById('primeSearchInput');
    const resultsContainer = document.getElementById('searchResults');
    const filterIndicator = document.getElementById('activeFilterIndicator');

    window.clearPrimeFilterFromIndicator = function() {
        activeFilter = null; filterIndicator.classList.add('hidden');
        applyAdvancedFilters(); // Re-apply general filters
        searchInput.value = ''; resultsContainer.innerHTML = '';
    };
    
    window.applyPrimeFilter = function(primeName) {
        const primeData = parsedData.filter(r => r['Legal Business Name'] === primeName);
        activeFilter = primeName; 
        filterIndicator.innerHTML = `<span>Filtered by Prime: <strong>${primeName}</strong></span> <button class="clear-filter-btn-tailwind bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600" onclick="clearPrimeFilterFromIndicator()">Clear</button>`;
        filterIndicator.classList.remove('hidden');
        initializeCoreVisuals(primeData); 
        initializePrimeProfilesSection(primeData); 
        initializeRecompeteCalendarSection(primeData);
        resultsContainer.innerHTML = ''; searchInput.value = primeName; 
        const advFilterDetails = document.querySelector('#advancedFiltersSection details');
        if (advFilterDetails) advFilterDetails.open = false;
    };
    
    searchInput.addEventListener('input', _.debounce(function() {
        const term = this.value.toLowerCase().trim();
        if (term.length < 2) { resultsContainer.innerHTML = ''; return; }
        const matches = new Map();
        allData.forEach(r => {
            const prime = r['Legal Business Name'];
            if (prime && prime.toLowerCase().includes(term)) {
                if (!matches.has(prime)) matches.set(prime, { name: prime, contracts: 0, totalValue: 0 });
                const m = matches.get(prime); m.contracts++; m.totalValue += parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
            }
        });
        const sorted = Array.from(matches.values()).sort((a,b)=>b.totalValue-a.totalValue).slice(0,10);
        resultsContainer.innerHTML = sorted.length > 0 ? sorted.map(m => `
            <div class="p-3 hover:bg-gray-100 cursor-pointer border-b last:border-b-0" onclick="applyPrimeFilter('${m.name.replace(/'/g, "\\'")}')">
                <strong class="text-blue-600">${m.name}</strong><br>
                <small class="text-gray-600">Contracts: ${m.contracts.toLocaleString()} | Value: ${formatCurrency(m.totalValue)}</small>
            </div>`).join('') : '<div class="p-3 text-gray-500">No matches.</div>';
    }, 300));
}

// --- Prime Profiles Section (Always Visible) ---
function initializePrimeProfilesSection(data) {
    const profiles = {};
    data.forEach(r => {
        const name = r['Legal Business Name']; if (!name) return;
        if (!profiles[name]) profiles[name] = { name: name, contracts: 0, totalValue: 0, naics: new Set() };
        profiles[name].contracts++; profiles[name].totalValue += parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
        if(r['NAICS Code']) profiles[name].naics.add(r['NAICS Code']);
    });
    function renderCards(filterTerm = '') {
        primeProfilesContainer.innerHTML = ''; let count = 0;
        Object.values(profiles)
            .filter(p => filterTerm === '' || p.name.toLowerCase().includes(filterTerm.toLowerCase()))
            .sort((a,b) => b.totalValue - a.totalValue)
            .forEach(p => {
                count++;
                const card = document.createElement('div');
                card.className = 'p-4 bg-gray-50 rounded-lg border shadow hover:shadow-md';
                card.innerHTML = `
                    <h4 class="font-semibold text-blue-700 truncate" title="${p.name}">${p.name}</h4>
                    <p class="text-sm">Contracts: ${p.contracts.toLocaleString()}</p>
                    <p class="text-sm">Value: ${formatCurrency(p.totalValue)}</p>
                    <p class="text-xs mt-1 truncate" title="NAICS: ${Array.from(p.naics).slice(0,3).join(', ')}">NAICS: ${Array.from(p.naics).slice(0,3).join(', ')}</p>
                    <button class="mt-2 text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600" onclick="applyPrimeFilter('${p.name.replace(/'/g, "\\'")}')">Filter Dashboard</button>`;
                primeProfilesContainer.appendChild(card);
        });
        if(count === 0) primeProfilesContainer.innerHTML = `<p class="p-4 col-span-full text-center text-gray-500">No primes match.</p>`;
    }
    primeProfilesSearchInput.addEventListener('input', _.debounce(() => renderCards(primeProfilesSearchInput.value), 300));
    renderCards();
}

// --- Recompete Calendar Section (Always Visible) ---
function initializeRecompeteCalendarSection(data) {
    const events = [];
    data.forEach(r => {
        if (r['Completion Date']) {
            const date = new Date(r['Completion Date']);
            if (!isNaN(date.getTime())) events.push({date:date, prime:r['Legal Business Name'], value:parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']), id:r['Procurement Instrument Identifier']||'N/A'});
        }
    });
    events.sort((a,b) => a.date - b.date);
    let currentCalDate = new Date(); currentCalDate = new Date(currentCalDate.getFullYear(), currentCalDate.getMonth(), 1);
    calendarPrevBtn.onclick = () => { currentCalDate.setMonth(currentCalDate.getMonth()-1); renderCalView(); };
    calendarNextBtn.onclick = () => { currentCalDate.setMonth(currentCalDate.getMonth()+1); renderCalView(); };

    function renderCalView() {
        const year = currentCalDate.getFullYear(), month = currentCalDate.getMonth();
        calendarTitleEl.textContent = `${new Intl.DateTimeFormat('en-US',{month:'long'}).format(currentCalDate)} ${year}`;
        const firstD = new Date(year,month,1), lastD = new Date(year,month+1,0);
        const daysInM = lastD.getDate(), firstDOW = firstD.getDay();
        let html = ''; const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        dayNames.forEach(d => {html += `<div class="calendar-day-header">${d}</div>`;});
        for(let i=0; i<firstDOW; i++) html+='<div class="p-2 border bg-gray-50 min-h-[80px]"></div>';
        for(let day=1; day<=daysInM; day++) {
            const dEvents = events.filter(e=>e.date.getFullYear()===year && e.date.getMonth()===month && e.date.getDate()===day);
            html += `<div class="p-2 border min-h-[80px] relative ${dEvents.length>0?'bg-blue-50':'bg-white'}">
                        <div class="font-semibold text-right text-gray-700">${day}</div>`;
            dEvents.slice(0,2).forEach(e => {html+=`<div class="calendar-event" data-event-details="${e.prime} (${formatCurrency(e.value)}) - ID: ${e.id}">${e.prime?e.prime.substring(0,10)+(e.prime.length>10?'...':''):'Contract'}</div>`;});
            if(dEvents.length>2) html+=`<div class="text-xs mt-1 cursor-pointer hover:underline" data-event-details="${dEvents.length} events.">${dEvents.length-2} more</div>`;
            html += `</div>`;
        }
        calendarGridEl.innerHTML = html;
        setupCalendarEventTooltips(globalTooltipEl);
    }
    renderCalView();
}

function setupCalendarEventTooltips(tooltipEl) {
    document.querySelectorAll('#calendarGrid [data-event-details]').forEach(el => {
        el.onmouseenter = (e) => {
            tooltipEl.innerHTML = el.dataset.eventDetails; tooltipEl.style.display = 'block';
            const rect = el.getBoundingClientRect();
            let top = rect.top+window.scrollY-tooltipEl.offsetHeight-5, left = rect.left+window.scrollX+(rect.width/2)-(tooltipEl.offsetWidth/2);
            if(top<window.scrollY) top=rect.bottom+window.scrollY+5; if(left<window.scrollX)left=window.scrollX+5;
            if(left+tooltipEl.offsetWidth > window.innerWidth) left=window.innerWidth-tooltipEl.offsetWidth-5;
            tooltipEl.style.top=`${top}px`; tooltipEl.style.left=`${left}px`;
        };
        el.onmouseleave = () => { tooltipEl.style.display = 'none'; };
    });
}

// --- Event Listeners for Chart Filters (e.g., State Chart) ---
document.getElementById('stateChartFilters_main').addEventListener('click', function(e) {
    if (e.target.classList.contains('filter-btn')) {
        const filterType = e.target.dataset.filter;
        const chartId = e.target.dataset.chart; // Should be 'stateContractsChart_main'
        if (chartId === 'stateContractsChart_main') {
            currentMainStateChartFilter = filterType; // Update global state for this chart's filter
            this.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            // Determine which data to use (globally filtered or prime-specific)
            const dataToUse = activeFilter ? parsedData.filter(r => r['Legal Business Name'] === activeFilter) : parsedData.filter(record => {
                // Re-apply advanced filters if any are set, otherwise use all parsedData
                const filters = {
                    naics: document.getElementById('naicsFilter').value,
                    agency: document.getElementById('agencyFilter').value,
                    state: document.getElementById('stateFilter').value,
                };
                if (filters.naics && record['NAICS Code'] != filters.naics) return false;
                if (filters.agency && record['Contracting Department Name'] !== filters.agency) return false;
                if (filters.state && record['Principal Place of Performance State Code'] !== filters.state) return false;
                return true;
            });
            createStateContractsChart_main(dataToUse, filterType);
        }
    }
});


// --- File Input Handling ---
csvFileInput.addEventListener('change', function(e) {
    const file = e.target.files[0]; if (!file) { fileNameDisplay.textContent = 'No file'; return; }
    fileNameDisplay.textContent = file.name; showProcessingBriefly();
    Papa.parse(file, {
        header: true, dynamicTyping: true, skipEmptyLines: true,
        complete: results => {
            if (results.errors && results.errors.length > 0) { showErrorMessage('CSV Error: ' + results.errors[0].message); return; }
            if (results.data && results.data.length > 0) {
                showSuccessMessage('File processed!', false); processAndInitialize(results.data);
                const s3ErrDiv = document.getElementById('s3LoadError'); if(s3ErrDiv)s3ErrDiv.classList.add('hidden');
            } else showErrorMessage('No data in file.');
        },
        error: error => showErrorMessage('CSV Parse Fail: ' + error.message)
    });
});

// --- Event Listeners for Advanced Filters & Page Load ---
document.getElementById('applyFiltersBtn').addEventListener('click', applyAdvancedFilters);
document.getElementById('clearFiltersBtn').addEventListener('click', clearAdvancedFilters);
document.addEventListener('DOMContentLoaded', () => loadDataFromS3());

</script>
</body>
</html>
