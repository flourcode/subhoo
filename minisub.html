<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamlined Federal Business Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            height: 300px; 
            width: 100%;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .calendar-day-header {
            font-weight: 600;
            text-align: center;
            padding: 5px 0;
            background-color: #2980b9; 
            color: white;
            border-radius: 4px;
        }
         .calendar-event {
            padding: 3px 5px;
            background-color: #3498db;
            color: white;
            border-radius: 3px;
            margin-bottom: 3px;
            font-size: 11px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .calendar-event:hover {
            background-color: #2980b9;
        }
        .event-tooltip {
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-width: 300px;
            display: none;
        }
        .metric-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            justify-content: center;
        }
        .filter-btn {
            padding: 4px 8px;
            background-color: #f1f1f1; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            cursor: pointer;
            font-size: 12px; 
            transition: background-color 0.2s;
        }
        .filter-btn.active {
            background-color: #2980b9; 
            color: white;
            border-color: #2980b9; 
        }
        #processingIndicator.flex {
            display: flex;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">
    <div class="dashboard-container max-w-7xl mx-auto">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Federal Business Development Dashboard</h1>
        </header>

        <section id="explainerSection" class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h2 class="text-2xl font-semibold text-gray-700 mb-3">Welcome!</h2>
            <p class="text-gray-600 mb-2">
                This dashboard helps you explore federal contracting data to identify potential teaming opportunities. 
                Data is automatically loaded.
            </p>
            <p class="text-gray-600 mb-2">
                <strong>How to Use:</strong> Use the <strong>Search & Filter</strong> bar below to find specific prime contractors, 
                or filter by NAICS code, department, specific contracting agency/office, and/or state. Enter multiple terms to narrow your results (e.g., "Acme Corp 541511 Defense VA DLA").
            </p>
            <p class="text-gray-600 text-sm">
                If data fails to load, a manual upload option will appear. Source CSV:
                <a href="https://subhoodata.s3.us-east-1.amazonaws.com/data/sbaall.csv" download class="text-blue-500 hover:text-blue-600 hover:underline">sbaall.csv</a>.
            </p>
            <div id="processingIndicator" class="hidden items-center text-gray-700 mt-4">
                <div class="spinner"></div>
                <span class="ml-2">Processing data...</span>
            </div>
            <div id="s3LoadError" class="text-red-600 bg-red-100 p-3 rounded-md mt-3 hidden"></div>
            <div id="manual-upload-section" class="hidden mt-4 border-t pt-4">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Manual CSV Upload</h3>
                <div class="flex items-center gap-4 mb-4">
                    <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                    <label for="csvFileInput" class="px-4 py-2 bg-blue-500 text-white rounded-md cursor-pointer hover:bg-blue-600 transition-colors">Choose CSV File</label>
                    <span id="file-name-display" class="text-sm text-gray-700 p-2 border border-gray-300 rounded-md min-w-[200px]">No file selected</span>
                </div>
                <div id="errorMessage" class="text-red-600 bg-red-100 p-3 rounded-md hidden mb-2"></div>
                <div id="successMessage" class="text-green-600 bg-green-100 p-3 rounded-md hidden mb-2"></div>
            </div>
        </section>

        <main id="dashboardContent" class="hidden">
            <section id="statisticsSection" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="stat-card bg-white p-4 rounded-lg shadow">
                    <div class="text-3xl font-bold text-blue-600" id="totalContractsValue">0</div>
                    <div class="text-sm text-gray-500">Total Contracts</div>
                </div>
                <div class="stat-card bg-white p-4 rounded-lg shadow">
                    <div class="text-3xl font-bold text-blue-600" id="totalValueValue">$0</div>
                    <div class="text-sm text-gray-500">Total Contract Value</div>
                </div>
                <div class="stat-card bg-white p-4 rounded-lg shadow">
                    <div class="text-3xl font-bold text-blue-600" id="avgContractValue">$0</div>
                    <div class="text-sm text-gray-500">Average Contract Value</div>
                </div>
                <div class="stat-card bg-white p-4 rounded-lg shadow">
                    <div class="text-3xl font-bold text-blue-600" id="uniquePrimesValue">0</div>
                    <div class="text-sm text-gray-500">Unique Prime Contractors</div>
                </div>
            </section>
            
            <section id="searchAndFilterSection" class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">Search & Filter Contracts</h2>
                <input type="text" id="unifiedSearchInput" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 mb-4" placeholder="Search by Prime, NAICS, Department, Agency, Office, State...">
                                
                <div id="activeFilterIndicator" class="bg-blue-100 text-blue-700 p-3 rounded-md mb-4 hidden flex justify-between items-center">
                    </div>
                </section>

            <section id="coreChartsSection" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mb-6">
                <div class="dashboard-card bg-white p-6 rounded-lg shadow">
                    <h2 class="text-lg font-semibold text-gray-700 mb-3 text-center">Top Prime Contractors by Value</h2>
                    <div class="chart-container">
                        <canvas id="primeContractorsChart"></canvas>
                    </div>
                </div>
                <div class="dashboard-card bg-white p-6 rounded-lg shadow">
                    <h2 class="text-lg font-semibold text-gray-700 mb-3 text-center">Department Contract Distribution</h2>
                    <div class="chart-container">
                        <canvas id="departmentChart"></canvas>
                    </div>
                </div>
                <div class="dashboard-card bg-white p-6 rounded-lg shadow">
                    <h2 class="text-lg font-semibold text-gray-700 mb-3 text-center">Top NAICS by Contract Value</h2>
                    <div class="chart-container">
                        <canvas id="naicsChart_main"></canvas>
                    </div>
                </div>
                <div class="dashboard-card bg-white p-6 rounded-lg shadow">
                    <h2 class="text-lg font-semibold text-gray-700 mb-3 text-center">Contract Type Breakdown</h2>
                    <div class="chart-container">
                        <canvas id="contractTypeChart_main"></canvas>
                    </div>
                </div>
                <div class="dashboard-card bg-white p-6 rounded-lg shadow"> 
                    <h2 class="text-lg font-semibold text-gray-700 mb-1 text-center">Contract Distribution by State</h2>
                    <div class="metric-filters" id="stateChartFilters_main">
                        <button class="filter-btn active" data-filter="count" data-chart="stateContractsChart_main">By Count</button>
                        <button class="filter-btn" data-filter="value" data-chart="stateContractsChart_main">By Value</button>
                    </div>
                    <div class="chart-container" style="height: 320px;"> 
                        <canvas id="stateContractsChart_main"></canvas>
                    </div>
                </div>
                <div class="dashboard-card bg-white p-6 rounded-lg shadow">
                    <h2 class="text-lg font-semibold text-gray-700 mb-3 text-center">Top Contracting Agencies by Value</h2>
                    <div class="chart-container">
                        <canvas id="topAgenciesChart"></canvas>
                    </div>
                </div>
                <div class="dashboard-card bg-white p-6 rounded-lg shadow md:col-span-2 xl:col-span-1"> <h2 class="text-lg font-semibold text-gray-700 mb-3 text-center">Contract Awards Over Time (by Year)</h2>
                     <div class="metric-filters" id="awardsTimeFilters_main">
                        <button class="filter-btn active" data-filter="count" data-chart="awardsOverTimeChart">By Count</button>
                        <button class="filter-btn" data-filter="value" data-chart="awardsOverTimeChart">By Value</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="awardsOverTimeChart"></canvas>
                    </div>
                </div>
                 <div class="dashboard-card bg-white p-6 rounded-lg shadow md:col-span-2 xl:col-span-2"> <h2 class="text-lg font-semibold text-gray-700 mb-3 text-center">Prime Market Share (Top 5 Primes Overall)</h2>
                    <div class="chart-container">
                        <canvas id="marketShareChart"></canvas>
                    </div>
                </div>
            </section>
            
            <section id="primeProfilesSection" class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">Prime Contractor Profiles</h2>
                 <p class="text-sm text-gray-500 mb-3">Displaying profiles based on current search/filter. Use the search below to refine this list further.</p>
                <div class="mb-4">
                    <input type="text" id="primeProfilesSearchInput" class="w-full md:w-1/2 lg:w-1/3 p-2 border border-gray-300 rounded-md" placeholder="Filter displayed profiles by name...">
                </div>
                <div id="primeProfilesContainer" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 max-h-[70vh] overflow-y-auto"></div>
            </section>

            <section id="contractExpirationCalendarSection" class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">Contract Expiration Calendar</h2>
                 <p class="text-sm text-gray-500 mb-3">Displaying calendar based on current search/filter.</p>
                <div class="calendar-container min-h-[400px] border border-gray-200 rounded-md p-4">
                    <div class="flex justify-between items-center mb-4">
                        <button id="calendarPrevBtn" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">&lt;</button>
                        <h3 id="calendarTitle" class="text-lg font-semibold">Month Year</h3>
                        <button id="calendarNextBtn" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">&gt;</button>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-1 text-sm"></div>
                </div>
            </section>
        </main>
    </div>
    <div class="event-tooltip"></div>

<script>
// --- DOM Elements ---
const processingIndicator = document.getElementById('processingIndicator');
const manualUploadSection = document.getElementById('manual-upload-section');
const dashboardContent = document.getElementById('dashboardContent');
const csvFileInput = document.getElementById('csvFileInput');
const fileNameDisplay = document.getElementById('file-name-display');
const errorMessageDiv = document.getElementById('errorMessage');
const successMessageDiv = document.getElementById('successMessage');
const s3LoadErrorDiv = document.getElementById('s3LoadError');
const unifiedSearchInput = document.getElementById('unifiedSearchInput'); 
const activeFilterIndicator = document.getElementById('activeFilterIndicator');

const primeProfilesContainer = document.getElementById('primeProfilesContainer');
const primeProfilesSearchInput = document.getElementById('primeProfilesSearchInput');
const calendarPrevBtn = document.getElementById('calendarPrevBtn');
const calendarNextBtn = document.getElementById('calendarNextBtn');
const calendarTitleEl = document.getElementById('calendarTitle');
const calendarGridEl = document.getElementById('calendarGrid');
const globalTooltipEl = document.querySelector('.event-tooltip');

// --- Global Variables ---
let parsedData = [];
const charts = {}; 
const S3_CSV_URL = 'https://subhoodata.s3.us-east-1.amazonaws.com/data/sbaall.csv';
let currentMainStateChartFilter = 'count';
let currentAwardsTimeFilter = 'count'; // For the new awards over time chart

// --- Utility Functions ---
function formatCurrency(value) { return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value); }
function parseCurrencyValue(valueStr) { if (!valueStr) return 0; return parseFloat(String(valueStr).replace(/[$,\s]/g, '')) || 0; }
function formatDate(dateStr) { if (!dateStr) return ''; const date = new Date(dateStr); return isNaN(date.getTime()) ? '' : new Intl.DateTimeFormat('en-US', { year: 'numeric', month: 'short', day: 'numeric' }).format(date); }

function showProcessingBriefly() { processingIndicator.classList.remove('hidden'); processingIndicator.classList.add('flex'); }
function hideProcessing() { processingIndicator.classList.add('hidden'); processingIndicator.classList.remove('flex');}

function showErrorMessage(message, isAutoloadError = false) {
    if (isAutoloadError) {
        manualUploadSection.classList.remove('hidden');
        s3LoadErrorDiv.textContent = `S3 Auto-load failed: ${message}. Please use manual upload option above.`;
        s3LoadErrorDiv.classList.remove('hidden');
    } else {
        errorMessageDiv.textContent = message; errorMessageDiv.classList.remove('hidden');
        successMessageDiv.classList.add('hidden');
    }
    hideProcessing();
}

function showSuccessMessage(message, isAutoloadSuccess = false) {
    if (isAutoloadSuccess) {
        s3LoadErrorDiv.classList.add('hidden');
    } else {
        successMessageDiv.textContent = message; successMessageDiv.classList.remove('hidden');
        errorMessageDiv.classList.add('hidden');
    }
    hideProcessing();
}

// --- Data Processing and Chart Initialization ---
function cleanupCharts() { Object.keys(charts).forEach(key => { if (charts[key]) { charts[key].destroy(); charts[key] = null; } }); }

function processAndInitialize(data) {
    if (!data || data.length === 0) { showErrorMessage('No data to display. Please try manual upload or check the S3 source.', true); return; }
    parsedData = data; 
    activeFilterIndicator.classList.add('hidden');
    dashboardContent.classList.remove('hidden');
    manualUploadSection.classList.add('hidden'); 
    s3LoadErrorDiv.classList.add('hidden'); 

    cleanupCharts(); 
    initializeCoreVisuals(parsedData);
    setupUnifiedSearch(); 
    initializePrimeProfilesSection(parsedData);
    initializeContractExpirationCalendarSection(parsedData); // Renamed function
    showSuccessMessage('Data loaded and dashboard initialized.', true); 
    hideProcessing();
}

// --- S3 Data Loading ---
function loadDataFromS3() { 
    showProcessingBriefly();
    fetch(S3_CSV_URL, { mode: 'cors', cache: 'no-cache', headers: { 'Accept': 'text/csv' } })
    .then(response => {
        if (!response.ok) {
            let errorDetail = `HTTP error ${response.status}`;
            if (response.status === 0) errorDetail = "Network error or CORS issue.";
            else if (response.status === 403) errorDetail = "Access Forbidden (403).";
            else if (response.status === 404) errorDetail = "File Not Found (404).";
            throw new Error(`S3 Load Error: ${errorDetail}`);
        }
        return response.text();
    })
    .then(csvText => {
        if (!csvText || csvText.trim() === '') { showErrorMessage('S3 file is empty.', true); return; }
        Papa.parse(csvText, {
            header: true,
            dynamicTyping: true, 
            skipEmptyLines: true,
            complete: results => {
                if (results.errors && results.errors.length > 0) { showErrorMessage('Error parsing CSV from S3: ' + results.errors[0].message, true); return; }
                if (results.data && results.data.length > 0) processAndInitialize(results.data);
                else showErrorMessage('No data parsed from S3 file.', true);
            },
            error: error => showErrorMessage('Error parsing CSV data from S3: ' + error.message, true)
        });
    })
    .catch(error => {
        let errorMsg = error.message; 
        if (navigator.onLine === false && !errorMsg.includes("offline")) errorMsg += " You may also be offline.";
        showErrorMessage(errorMsg, true); 
    });
}

// --- Unified Search and Filtering Logic ---
function applyUnifiedSearch(searchTerm) {
    if (!searchTerm || searchTerm.trim() === '') {
        clearAllFilters(); 
        return;
    }
    const keywords = searchTerm.toLowerCase().split(' ').filter(k => k); 
    const filteredData = parsedData.filter(record => {
        return keywords.every(keyword => { 
            const primeName = record['Legal Business Name']?.toLowerCase() || '';
            const naicsCode = String(record['NAICS Code'] || '')?.toLowerCase(); 
            const naicsDesc = record['NAICS Description']?.toLowerCase() || '';
            const departmentName = record['Contracting Department Name']?.toLowerCase() || ''; // Added Department
            const agencyName = record['Contracting Agency Name']?.toLowerCase() || ''; // Added Agency
            const officeName = record['Contracting Office Name']?.toLowerCase() || ''; // Added Office
            const stateCode = record['Principal Place of Performance State Code']?.toLowerCase() || '';

            return primeName.includes(keyword) ||
                   naicsCode.includes(keyword) ||
                   naicsDesc.includes(keyword) ||
                   departmentName.includes(keyword) ||
                   agencyName.includes(keyword) ||
                   officeName.includes(keyword) ||
                   (keyword.length === 2 && stateCode === keyword) || 
                   (keyword.length > 2 && stateCode.includes(keyword)); 
        });
    });

    initializeCoreVisuals(filteredData); 
    initializePrimeProfilesSection(filteredData);
    initializeContractExpirationCalendarSection(filteredData); // Renamed
    updateActiveFilterIndicator(searchTerm, filteredData.length);
}

function clearAllFilters() {
    unifiedSearchInput.value = '';
    activeFilterIndicator.classList.add('hidden');
    initializeCoreVisuals(parsedData); 
    initializePrimeProfilesSection(parsedData); 
    initializeContractExpirationCalendarSection(parsedData); // Renamed
}

function updateActiveFilterIndicator(searchTerm, count) {
    if (searchTerm && searchTerm.trim() !== '') {
        activeFilterIndicator.innerHTML = `<span>Filtered by: <strong>"${searchTerm}"</strong> (${count.toLocaleString()} results)</span> 
                                         <button class="clear-filter-btn-tailwind bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600" onclick="clearAllFilters()">Clear All Filters</button>`;
        activeFilterIndicator.classList.remove('hidden');
    } else {
        activeFilterIndicator.classList.add('hidden');
    }
}

function setupUnifiedSearch() {
    unifiedSearchInput.addEventListener('input', _.debounce(function() {
        applyUnifiedSearch(this.value);
    }, 500)); 
}

// --- Initialize Core Visualizations ---
function initializeCoreVisuals(data) { 
    updateStatistics(data);
    createPrimeContractorsChart(data);
    createDepartmentChart(data);
    createNaicsChart_main(data);
    createContractTypeChart_main(data);
    createStateContractsChart_main(data, currentMainStateChartFilter);
    createTopAgenciesChart(data); // New
    createAwardsOverTimeChart(data, currentAwardsTimeFilter); // New
    createMarketShareChart(data); // New
}

// --- Statistics Update ---
function updateStatistics(data) { 
    if (!data || data.length === 0) { /* ... */ return; }
    document.getElementById('totalContractsValue').textContent = data.length.toLocaleString();
    let totalValue = 0, contractsWithValue = 0;
    data.forEach(r => { const v = parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']); if (v>0) {totalValue+=v; contractsWithValue++;}});
    document.getElementById('totalValueValue').textContent = formatCurrency(totalValue);
    document.getElementById('avgContractValue').textContent = formatCurrency(contractsWithValue > 0 ? totalValue / contractsWithValue : 0);
    document.getElementById('uniquePrimesValue').textContent = new Set(data.map(r => r['Legal Business Name']).filter(Boolean)).size.toLocaleString();
}

// --- Chart Creation Functions ---
function createChart(canvasId, type, data, options) { 
    const ctx = document.getElementById(canvasId).getContext('2d');
    if (charts[canvasId]) charts[canvasId].destroy();
    charts[canvasId] = new Chart(ctx, { type, data, options });
}

function createPrimeContractorsChart(data) { 
    const primeValues = {};
    data.forEach(r => { if (r['Legal Business Name']) primeValues[r['Legal Business Name']] = (primeValues[r['Legal Business Name']] || 0) + parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']); });
    const sorted = Object.entries(primeValues).sort((a,b)=>b[1]-a[1]).slice(0,10);
    createChart('primeContractorsChart', 'bar', 
        { labels: sorted.map(i=>i[0]), datasets: [{ label: 'Contract Value', data: sorted.map(i=>i[1]), backgroundColor: 'rgba(54, 162, 235, 0.7)' }] },
        { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false}, tooltip:{callbacks:{label:c=>formatCurrency(c.raw)}}}, scales: {x:{ticks:{callback:v=>formatCurrency(v).slice(0,-3)+'k'}}, y:{ticks:{autoSkip:false, callback:function(v){const l=this.getLabelForValue(v); return l.length>18?l.substring(0,15)+'...':l;}}}}}
    );
}

function createDepartmentChart(data) { 
    const deptValues = {};
    data.forEach(r => { if (r['Contracting Department Name']) deptValues[r['Contracting Department Name']] = (deptValues[r['Contracting Department Name']] || 0) + parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']); });
    const sorted = Object.entries(deptValues).sort((a,b)=>b[1]-a[1]).slice(0,10);
    createChart('departmentChart', 'pie',
        { labels: sorted.map(i=>i[0]), datasets: [{ data: sorted.map(i=>i[1]), backgroundColor: ['#3B82F6','#EF4444','#F59E0B','#10B981','#8B5CF6','#EC4899','#6366F1','#FBBF24','#22C55E','#D946EF'] }] },
        { responsive: true, maintainAspectRatio: false, plugins: { legend: {position:'right', labels:{boxWidth:12,font:{size:10}}}, tooltip:{callbacks:{label:c=>`${c.label||''}: ${formatCurrency(c.raw)}`}}}}
    );
}

function createNaicsChart_main(data) { 
    const naicsValues = {}, naicsDesc = {};
    data.forEach(r => {
        if (r['NAICS Code']) {
            const naicsKey = String(r['NAICS Code']);
            naicsValues[naicsKey] = (naicsValues[naicsKey] || 0) + parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
            if (!naicsDesc[naicsKey]) naicsDesc[naicsKey] = r['NAICS Description'] || '';
        }
    });
    const sorted = Object.entries(naicsValues).sort((a,b)=>b[1]-a[1]).slice(0,10);
    createChart('naicsChart_main', 'bar',
        { labels: sorted.map(i=>`${i[0]} - ${naicsDesc[i[0]] ? naicsDesc[i[0]].substring(0,20) : ''}...`), datasets: [{ label: 'Contract Value', data: sorted.map(i=>i[1]), backgroundColor: 'rgba(22, 163, 74, 0.7)' }] },
        { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false}, tooltip:{callbacks:{label:c=>formatCurrency(c.raw)}}}, scales: {x:{ticks:{callback:v=>formatCurrency(v).slice(0,-3)+'k'}}}}
    );
}

function createContractTypeChart_main(data) { 
    const contractTypes = {};
    data.forEach(r => { if (r['Award or Indefinite Delivery Vehicle Type']) contractTypes[r['Award or Indefinite Delivery Vehicle Type']] = (contractTypes[r['Award or Indefinite Delivery Vehicle Type']] || 0) + 1; });
    createChart('contractTypeChart_main', 'doughnut',
        { labels: Object.keys(contractTypes), datasets: [{ data: Object.values(contractTypes), backgroundColor: ['#3B82F6','#EF4444','#F59E0B','#10B981','#8B5CF6', '#F472B6', '#6B7280', '#06B6D4', '#F97316', '#84CC16'] }] },
        { responsive: true, maintainAspectRatio: false, plugins: { legend: {position:'right', labels:{boxWidth:12,font:{size:10}}}, tooltip:{callbacks:{label:c=>`${c.label||''}: ${c.raw.toLocaleString()}`}}}}
    );
}

function createStateContractsChart_main(data, filterType = 'count') { 
    const stateData = {}; 
    data.forEach(r => {
        const state = r['Principal Place of Performance State Code'];
        if (state) {
            if (!stateData[state]) stateData[state] = { count: 0, value: 0 };
            stateData[state].count++;
            stateData[state].value += parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
        }
    });
    const sorted = Object.entries(stateData).sort((a,b) => b[1][filterType] - a[1][filterType]).slice(0,10);
    createChart('stateContractsChart_main', 'bar',
        { labels: sorted.map(i=>i[0]), datasets: [{ label: filterType === 'count' ? 'Number of Contracts' : 'Total Contract Value', data: sorted.map(i=>i[1][filterType]), backgroundColor: 'rgba(139, 92, 246, 0.7)' }] },
        { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false}, tooltip:{callbacks:{label:c=> filterType === 'count' ? c.raw.toLocaleString() : formatCurrency(c.raw)}}}, scales: {y:{ticks:{callback:v=> filterType==='count'?v.toLocaleString():formatCurrency(v).slice(0,-3)+'k'}}}}
    );
}

// New Chart: Top Contracting Agencies
function createTopAgenciesChart(data) {
    const agencyValues = {};
    data.forEach(r => {
        const agency = r['Contracting Agency Name']; // Using the more specific agency name
        if (agency) {
            agencyValues[agency] = (agencyValues[agency] || 0) + parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
        }
    });
    const sortedAgencies = Object.entries(agencyValues).sort((a, b) => b[1] - a[1]).slice(0, 10);
    createChart('topAgenciesChart', 'bar',
        { labels: sortedAgencies.map(item => item[0]), datasets: [{ label: 'Contract Value', data: sortedAgencies.map(item => item[1]), backgroundColor: 'rgba(234, 88, 12, 0.7)' }] }, // Orange color
        { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => formatCurrency(ctx.raw) } } }, scales: { x: { ticks: { callback: val => formatCurrency(val).slice(0, -3) + 'k' } }, y: { ticks: { autoSkip: false, callback: function(val) { const label = this.getLabelForValue(val); return label.length > 20 ? label.substring(0, 17) + '...' : label; } } } } }
    );
}

// New Chart: Contract Awards Over Time
function createAwardsOverTimeChart(data, filterType = 'count') {
    const awardsByYear = {}; // { "2023": { count: x, value: y } }
    data.forEach(r => {
        const startDateStr = r['Period of Performance Start Date'];
        if (startDateStr) {
            const startDate = new Date(startDateStr);
            if (!isNaN(startDate.getTime())) {
                const year = startDate.getFullYear();
                if (year > 2000 && year < 2030) { // Filter for reasonable year range
                    if (!awardsByYear[year]) awardsByYear[year] = { count: 0, value: 0 };
                    awardsByYear[year].count++;
                    awardsByYear[year].value += parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
                }
            }
        }
    });
    const sortedYears = Object.keys(awardsByYear).sort((a,b) => parseInt(a) - parseInt(b));
    const chartDataValues = sortedYears.map(year => awardsByYear[year][filterType]);

    createChart('awardsOverTimeChart', 'line',
        { labels: sortedYears, datasets: [{ label: filterType === 'count' ? 'Number of Contracts' : 'Total Contract Value', data: chartDataValues, borderColor: 'rgba(75, 192, 192, 1)', backgroundColor: 'rgba(75, 192, 192, 0.2)', fill: true, tension: 0.1 }] },
        { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'top' } , tooltip: { callbacks: { label: ctx => filterType === 'count' ? ctx.raw.toLocaleString() : formatCurrency(ctx.raw) } } }, scales: { y: { beginAtZero: true, ticks: { callback: val => filterType === 'count' ? val.toLocaleString() : formatCurrency(val).slice(0,-3)+'k' } } } }
    );
}

// New Chart: Market Share
function createMarketShareChart(data) {
    const primeValues = {};
    data.forEach(r => {
        if (r['Legal Business Name']) {
            primeValues[r['Legal Business Name']] = (primeValues[r['Legal Business Name']] || 0) + parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
        }
    });
    const sortedPrimes = Object.entries(primeValues).sort((a, b) => b[1] - a[1]);
    const top5Primes = sortedPrimes.slice(0, 5);
    const otherPrimesValue = sortedPrimes.slice(5).reduce((sum, item) => sum + item[1], 0);
    
    const chartLabels = top5Primes.map(item => item[0]);
    const chartValues = top5Primes.map(item => item[1]);
    if (otherPrimesValue > 0) {
        chartLabels.push('Others');
        chartValues.push(otherPrimesValue);
    }

    createChart('marketShareChart', 'pie',
        { labels: chartLabels, datasets: [{ data: chartValues, backgroundColor: ['#8B5CF6', '#EC4899', '#FBBF24', '#22C55E', '#6366F1', '#A8A29E'] }] }, // Different colors
        { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: { size: 10 } } }, tooltip: { callbacks: { label: ctx => `${ctx.label || ''}: ${formatCurrency(ctx.raw)} (${((ctx.raw / chartValues.reduce((a,b)=>a+b,0)) * 100).toFixed(1)}%)` } } } }
    );
}


// --- Prime Profiles Section ---
function initializePrimeProfilesSection(data) { 
    const profiles = {};
    data.forEach(r => {
        const name = r['Legal Business Name']; if (!name) return;
        if (!profiles[name]) profiles[name] = { name: name, contracts: 0, totalValue: 0, naics: new Set(), agencies: new Set() };
        profiles[name].contracts++; profiles[name].totalValue += parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
        if(r['NAICS Code']) profiles[name].naics.add(String(r['NAICS Code'])); 
        if(r['Contracting Agency Name']) profiles[name].agencies.add(r['Contracting Agency Name']);
    });
    function renderCards(filterTerm = '') {
        primeProfilesContainer.innerHTML = ''; let count = 0;
        Object.values(profiles)
            .filter(p => filterTerm === '' || p.name.toLowerCase().includes(filterTerm.toLowerCase()))
            .sort((a,b) => b.totalValue - a.totalValue)
            .forEach(p => { 
                count++;
                const card = document.createElement('div');
                card.className = 'p-4 bg-gray-50 rounded-lg border shadow hover:shadow-md';
                card.innerHTML = `
                    <h4 class="font-semibold text-blue-700 truncate" title="${p.name}">${p.name}</h4>
                    <p class="text-sm">Contracts: ${p.contracts.toLocaleString()}</p>
                    <p class="text-sm">Value: ${formatCurrency(p.totalValue)}</p>
                    <p class="text-xs mt-1 truncate" title="Top NAICS: ${Array.from(p.naics).slice(0,3).join(', ')}">Top NAICS: ${Array.from(p.naics).slice(0,3).join(', ')}</p>
                    <p class="text-xs mt-1 truncate" title="Top Agencies: ${Array.from(p.agencies).slice(0,2).join(', ')}">Top Agencies: ${Array.from(p.agencies).slice(0,2).join(', ')}</p>
                    <button class="mt-2 text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600" onclick="setUnifiedSearchTerm('${p.name.replace(/'/g, "\\'")}')">View Dashboard for this Prime</button>`;
                primeProfilesContainer.appendChild(card);
        });
        if(count === 0) primeProfilesContainer.innerHTML = `<p class="p-4 col-span-full text-center text-gray-500">No primes match current filters or profile search.</p>`;
    }
    primeProfilesSearchInput.addEventListener('input', _.debounce(() => renderCards(primeProfilesSearchInput.value), 300));
    renderCards(); 
}

function setUnifiedSearchTerm(term) {
    unifiedSearchInput.value = term;
    applyUnifiedSearch(term); 
}


// --- Contract Expiration Calendar Section --- Renamed
function initializeContractExpirationCalendarSection(data) { 
    const events = [];
    data.forEach(r => {
        if (r['Completion Date']) {
            const date = new Date(r['Completion Date']);
            if (!isNaN(date.getTime())) events.push({date:date, prime:r['Legal Business Name'], value:parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']), id:r['Procurement Instrument Identifier']||'N/A'});
        }
    });
    events.sort((a,b) => a.date - b.date);
    let currentCalDate = new Date(); currentCalDate = new Date(currentCalDate.getFullYear(), currentCalDate.getMonth(), 1);
    calendarPrevBtn.onclick = () => { currentCalDate.setMonth(currentCalDate.getMonth()-1); renderCalView(); };
    calendarNextBtn.onclick = () => { currentCalDate.setMonth(currentCalDate.getMonth()+1); renderCalView(); };

    function renderCalView() {
        const year = currentCalDate.getFullYear(), month = currentCalDate.getMonth();
        calendarTitleEl.textContent = `${new Intl.DateTimeFormat('en-US',{month:'long'}).format(currentCalDate)} ${year}`;
        const firstD = new Date(year,month,1), lastD = new Date(year,month+1,0);
        const daysInM = lastD.getDate(), firstDOW = firstD.getDay();
        let html = ''; const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        dayNames.forEach(d => {html += `<div class="calendar-day-header">${d}</div>`;});
        for(let i=0; i<firstDOW; i++) html+='<div class="p-2 border bg-gray-50 min-h-[80px]"></div>';
        for(let day=1; day<=daysInM; day++) {
            const dEvents = events.filter(e=>e.date.getFullYear()===year && e.date.getMonth()===month && e.date.getDate()===day);
            html += `<div class="p-2 border min-h-[80px] relative ${dEvents.length>0?'bg-blue-50':'bg-white'}">
                        <div class="font-semibold text-right text-gray-700">${day}</div>`;
            dEvents.slice(0,2).forEach(e => {html+=`<div class="calendar-event" data-event-details="${e.prime} (${formatCurrency(e.value)}) - ID: ${e.id}">${e.prime?e.prime.substring(0,10)+(e.prime.length>10?'...':''):'Contract'}</div>`;});
            if(dEvents.length>2) html+=`<div class="text-xs mt-1 cursor-pointer hover:underline" data-event-details="${dEvents.length} events.">${dEvents.length-2} more</div>`;
            html += `</div>`;
        }
        calendarGridEl.innerHTML = html;
        setupCalendarEventTooltips(globalTooltipEl);
    }
    renderCalView();
}

function setupCalendarEventTooltips(tooltipEl) { 
    document.querySelectorAll('#calendarGrid [data-event-details]').forEach(el => {
        el.onmouseenter = (e) => {
            tooltipEl.innerHTML = el.dataset.eventDetails; tooltipEl.style.display = 'block';
            const rect = el.getBoundingClientRect();
            let top = rect.top+window.scrollY-tooltipEl.offsetHeight-5, left = rect.left+window.scrollX+(rect.width/2)-(tooltipEl.offsetWidth/2);
            if(top<window.scrollY) top=rect.bottom+window.scrollY+5; if(left<window.scrollX)left=window.scrollX+5;
            if(left+tooltipEl.offsetWidth > window.innerWidth) left=window.innerWidth-tooltipEl.offsetWidth-5;
            tooltipEl.style.top=`${top}px`; tooltipEl.style.left=`${left}px`;
        };
        el.onmouseleave = () => { tooltipEl.style.display = 'none'; };
    });
}

// --- Event Listeners for Chart Filters ---
document.getElementById('stateChartFilters_main').addEventListener('click', function(e) { 
    if (e.target.classList.contains('filter-btn')) {
        const filterType = e.target.dataset.filter;
        currentMainStateChartFilter = filterType;
        this.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
        applyUnifiedSearch(unifiedSearchInput.value); // Re-apply search to update this chart
    }
});

document.getElementById('awardsTimeFilters_main').addEventListener('click', function(e) {
    if (e.target.classList.contains('filter-btn')) {
        const filterType = e.target.dataset.filter;
        currentAwardsTimeFilter = filterType;
        this.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
        applyUnifiedSearch(unifiedSearchInput.value); // Re-apply search to update this chart
    }
});


// --- File Input Handling ---
csvFileInput.addEventListener('change', function(e) { 
    const file = e.target.files[0]; if (!file) { fileNameDisplay.textContent = 'No file'; return; }
    fileNameDisplay.textContent = file.name; showProcessingBriefly();
    Papa.parse(file, {
        header: true, dynamicTyping: true, skipEmptyLines: true,
        complete: results => {
            if (results.errors && results.errors.length > 0) { showErrorMessage('CSV Error: ' + results.errors[0].message); return; }
            if (results.data && results.data.length > 0) {
                showSuccessMessage('File processed!', false); processAndInitialize(results.data);
                s3LoadErrorDiv.classList.add('hidden'); 
            } else showErrorMessage('No data in file.');
        },
        error: error => showErrorMessage('CSV Parse Fail: ' + error.message)
    });
});

// --- Page Load ---
document.addEventListener('DOMContentLoaded', () => loadDataFromS3());

</script>
</body>
</html>
