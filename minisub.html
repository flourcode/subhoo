<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamlined Federal Business Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-treemap@2.3.0/dist/chartjs-chart-treemap.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            height: 300px; 
            width: 100%;
        }
        .modal {
            display: none; 
        }
        .modal.active {
            display: flex; 
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #09f; /* Tailwind: border-blue-500 */
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .calendar-day-header {
            font-weight: 600;
            text-align: center;
            padding: 5px 0;
            background-color: #2980b9; /* Tailwind: bg-blue-600 */
            color: white;
            border-radius: 4px; /* Tailwind: rounded */
        }
         .calendar-event {
            padding: 3px 5px;
            background-color: #3498db; /* Tailwind: bg-blue-500 */
            color: white;
            border-radius: 3px; /* Tailwind: rounded-sm */
            margin-bottom: 3px;
            font-size: 11px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .calendar-event:hover {
            background-color: #2980b9; /* Tailwind: bg-blue-600 */
        }
        .event-tooltip { /* Used by calendar */
            position: absolute;
            background-color: white; /* Tailwind: bg-white */
            border: 1px solid #ddd; /* Tailwind: border border-gray-300 */
            border-radius: 4px; /* Tailwind: rounded */
            padding: 10px; /* Tailwind: p-2.5 */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* Tailwind: shadow-lg */
            z-index: 1000;
            max-width: 300px;
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">
    <div class="dashboard-container max-w-7xl mx-auto">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Federal Business Development Dashboard</h1>
            <p class="text-gray-600">Prime to Subcontractor Teaming Opportunities</p>
        </header>

        <section id="fileInputSection" class="bg-white p-6 rounded-lg shadow-md mb-6">
            <div id="autoload-section" class="mb-1">
                <div id="processingIndicator" class="hidden items-center text-gray-700"> <div class="spinner"></div>
                    <span class="ml-2">Processing data...</span>
                </div>
                <p id="autoload-status" class="hidden"></p> 
            </div>
            
            <div id="manual-upload-section" class="hidden"> <h3 class="text-xl font-semibold text-gray-700 mb-2">Upload Federal Contractor CSV Data</h3>
                <p class="text-sm text-gray-600 mb-4">If auto-loading fails or you want to use a different file, you can manually upload <code>sbaall.csv</code></p>
                
                <div class="flex items-center gap-4 mb-4">
                    <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                    <label for="csvFileInput" class="px-4 py-2 bg-blue-500 text-white rounded-md cursor-pointer hover:bg-blue-600 transition-colors">Choose CSV File</label>
                    <span id="file-name-display" class="text-sm text-gray-700 p-2 border border-gray-300 rounded-md min-w-[200px]">No file selected</span>
                </div>
                
                <div id="errorMessage" class="text-red-600 bg-red-100 p-3 rounded-md hidden mb-2">Error processing file.</div>
                <div id="successMessage" class="text-green-600 bg-green-100 p-3 rounded-md hidden mb-2">File processed successfully.</div>
                
                <div class="mt-4">
                    <a href="https://subhoodata.s3.us-east-1.amazonaws.com/data/sbaall.csv" download class="text-blue-500 hover:text-blue-600 hover:underline text-sm">Download sbaall.csv from S3</a>
                </div>
            </div>
        </section>

        <main id="dashboardContent" class="hidden">
            <section id="statisticsSection" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="stat-card bg-white p-4 rounded-lg shadow">
                    <div class="text-3xl font-bold text-blue-600" id="totalContractsValue">0</div>
                    <div class="text-sm text-gray-500">Total Contracts</div>
                </div>
                <div class="stat-card bg-white p-4 rounded-lg shadow">
                    <div class="text-3xl font-bold text-blue-600" id="totalValueValue">$0</div>
                    <div class="text-sm text-gray-500">Total Contract Value</div>
                </div>
                <div class="stat-card bg-white p-4 rounded-lg shadow">
                    <div class="text-3xl font-bold text-blue-600" id="avgContractValue">$0</div>
                    <div class="text-sm text-gray-500">Average Contract Value</div>
                </div>
                <div class="stat-card bg-white p-4 rounded-lg shadow">
                    <div class="text-3xl font-bold text-blue-600" id="uniquePrimesValue">0</div>
                    <div class="text-sm text-gray-500">Unique Prime Contractors</div>
                </div>
            </section>

            <section id="advancedFiltersSection" class="bg-white p-6 rounded-lg shadow-md mb-6">
                <details class="group">
                    <summary class="flex justify-between items-center font-semibold text-gray-700 cursor-pointer hover:text-blue-600">
                        Advanced Filtering Options
                        <span class="text-sm text-blue-500 group-open:rotate-180 transition-transform duration-300 transform">&#9660;</span>
                    </summary>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="filter-group">
                            <label for="naicsFilter" class="block text-sm font-medium text-gray-700 mb-1">NAICS Code</label>
                            <select id="naicsFilter" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">All NAICS Codes</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="agencyFilter" class="block text-sm font-medium text-gray-700 mb-1">Department/Agency</label>
                            <select id="agencyFilter" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">All Departments/Agencies</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="stateFilter" class="block text-sm font-medium text-gray-700 mb-1">State</label>
                            <select id="stateFilter" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">All States</option>
                            </select>
                        </div>
                        </div>
                    <div class="mt-6 flex justify-end gap-3">
                        <button id="clearFiltersBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">Clear Filters</button>
                        <button id="applyFiltersBtn" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">Apply Filters</button>
                    </div>
                </details>
            </section>
            <div id="activeFilterIndicator" class="bg-blue-100 text-blue-700 p-3 rounded-md mb-6 hidden flex justify-between items-center">
                <span>Filtered by: [Prime Name]</span>
                <button class="clear-filter-btn-tailwind bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600">Clear Filter</button>
            </div>

            <section id="primeSearchSection" class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">Prime Contractor Search</h2>
                <input type="text" id="primeSearchInput" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 mb-3" placeholder="Search for a prime contractor...">
                <div id="searchResults" class="max-h-60 overflow-y-auto border border-gray-200 rounded-md">
                    </div>
            </section>

            <section id="coreChartsSection" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="dashboard-card bg-white p-6 rounded-lg shadow">
                    <h2 class="text-lg font-semibold text-gray-700 mb-3">Top Prime Contractors by Contract Value</h2>
                    <div class="chart-container">
                        <canvas id="primeContractorsChart"></canvas>
                    </div>
                </div>
                <div class="dashboard-card bg-white p-6 rounded-lg shadow">
                    <h2 class="text-lg font-semibold text-gray-700 mb-3">Department Contract Distribution</h2>
                    <div class="chart-container">
                        <canvas id="departmentChart"></canvas>
                    </div>
                </div>
            </section>
            
            <section id="primeProfilesSection" class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">Prime Contractor Profiles</h2>
                <div class="mb-4">
                    <input type="text" id="primeProfilesSearchInput" class="w-full md:w-1/2 lg:w-1/3 p-2 border border-gray-300 rounded-md" placeholder="Search prime contractors in profiles...">
                </div>
                <div id="primeProfilesContainer" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 max-h-[70vh] overflow-y-auto">
                    </div>
            </section>

            <section id="recompeteCalendarSection" class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-3">Recompete Opportunity Calendar</h2>
                <div class="calendar-container min-h-[400px] border border-gray-200 rounded-md p-4">
                    <div class="flex justify-between items-center mb-4">
                        <button id="calendarPrevBtn" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">&lt;</button>
                        <h3 id="calendarTitle" class="text-lg font-semibold">Month Year</h3>
                        <button id="calendarNextBtn" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">&gt;</button>
                    </div>
                    <div id="calendarGrid" class="grid grid-cols-7 gap-1 text-sm">
                        </div>
                </div>
            </section>

            <section id="progressiveDisclosureButtons" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                <button id="showNaicsAnalysisBtn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-4 rounded-lg shadow transition-colors w-full">NAICS Analysis</button>
                <button id="showMoreChartsBtn" class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-3 px-4 rounded-lg shadow transition-colors w-full">More Overview Charts</button>
            </section>
            
        </main>
    </div>

    <div id="detailModal" class="modal fixed inset-0 bg-gray-800 bg-opacity-75 items-center justify-center p-4 z-50">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="modal-header flex justify-between items-center mb-4 pb-4 border-b border-gray-200">
                <h2 class="modal-title text-xl font-semibold text-gray-800" id="modalTitle">Details</h2>
                <button class="modal-close text-gray-500 hover:text-gray-700 text-2xl" id="modalCloseBtn">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <p class="text-gray-700">Loading details...</p>
            </div>
            <div class="modal-footer mt-6 pt-4 border-t border-gray-200 flex justify-end">
                <button class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors" id="modalCloseBtnAction">Close</button>
            </div>
        </div>
    </div>
    <div class="event-tooltip"></div> <script>
// --- DOM Elements ---
const processingIndicator = document.getElementById('processingIndicator');
const autoloadStatus = document.getElementById('autoload-status'); // Still exists, but mostly hidden
const manualUploadSection = document.getElementById('manual-upload-section');
const dashboardContent = document.getElementById('dashboardContent');
const csvFileInput = document.getElementById('csvFileInput');
const fileNameDisplay = document.getElementById('file-name-display');
const errorMessageDiv = document.getElementById('errorMessage');
const successMessageDiv = document.getElementById('successMessage'); // Still exists, but mostly hidden

const detailModal = document.getElementById('detailModal');
const modalTitle = document.getElementById('modalTitle');
const modalBody = document.getElementById('modalBody');
const modalCloseBtn = document.getElementById('modalCloseBtn');
const modalCloseBtnAction = document.getElementById('modalCloseBtnAction');

// Elements for always-visible sections
const primeProfilesContainer = document.getElementById('primeProfilesContainer');
const primeProfilesSearchInput = document.getElementById('primeProfilesSearchInput');
const calendarPrevBtn = document.getElementById('calendarPrevBtn');
const calendarNextBtn = document.getElementById('calendarNextBtn');
const calendarTitleEl = document.getElementById('calendarTitle');
const calendarGridEl = document.getElementById('calendarGrid');
const globalTooltipEl = document.querySelector('.event-tooltip');


// --- Global Variables ---
let parsedData = [];
const charts = {}; 
let activeFilter = null; 
const S3_CSV_URL = 'https://subhoodata.s3.us-east-1.amazonaws.com/data/sbaall.csv';

// --- Utility Functions ---
function formatCurrency(value) {
    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
}
function parseCurrencyValue(valueStr) {
    if (!valueStr) return 0;
    return parseFloat(String(valueStr).replace(/[$,\s]/g, '')) || 0;
}
function formatDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return isNaN(date.getTime()) ? '' : new Intl.DateTimeFormat('en-US', { year: 'numeric', month: 'short', day: 'numeric' }).format(date);
}

function showProcessingBriefly() { // Renamed to reflect its new role
    processingIndicator.classList.remove('hidden');
    // No autoloadStatus update needed here as it's hidden
}

function hideProcessing() {
    processingIndicator.classList.add('hidden');
}

function showErrorMessage(message, isAutoloadError = false) { // Autoload errors will now primarily trigger manual upload section
    if (isAutoloadError) {
        // autoloadStatus.textContent = `Error: ${message}`; // This is hidden
        // autoloadStatus.classList.add('text-red-600'); // This is hidden
        manualUploadSection.classList.remove('hidden');
        // manualUploadSection.classList.add('highlight-section'); // Optional: re-add if needed
        // Display a more direct error message if S3 fails
        const fileInputSection = document.getElementById('fileInputSection');
        let s3ErrorDiv = document.getElementById('s3LoadError');
        if (!s3ErrorDiv) {
            s3ErrorDiv = document.createElement('div');
            s3ErrorDiv.id = 's3LoadError';
            s3ErrorDiv.className = 'text-red-600 bg-red-100 p-3 rounded-md mb-2';
            fileInputSection.insertBefore(s3ErrorDiv, manualUploadSection);
        }
        s3ErrorDiv.textContent = `S3 Auto-load failed: ${message}. Please use manual upload.`;

    } else { // For manual upload errors
        errorMessageDiv.textContent = message;
        errorMessageDiv.classList.remove('hidden');
        successMessageDiv.classList.add('hidden'); // Hide manual success if error
    }
    hideProcessing();
}

// Success messages are generally hidden now for S3 auto-load
function showSuccessMessage(message, isAutoloadSuccess = false) {
    if (isAutoloadSuccess) {
        // autoloadStatus.textContent = message; // Hidden
        // autoloadStatus.classList.add('text-green-600'); // Hidden
        // Hide the S3 error message if it was shown
        const s3ErrorDiv = document.getElementById('s3LoadError');
        if (s3ErrorDiv) s3ErrorDiv.classList.add('hidden');

    } else { // For manual upload success
        successMessageDiv.textContent = message;
        successMessageDiv.classList.remove('hidden');
        errorMessageDiv.classList.add('hidden');
    }
    hideProcessing();
}


// --- Data Processing and Chart Initialization ---
function cleanupCharts() {
    Object.keys(charts).forEach(key => {
        if (charts[key]) {
            charts[key].destroy();
            charts[key] = null;
        }
    });
}

function processAndInitialize(data) {
    if (!data || data.length === 0) {
        showErrorMessage('No data to display. Please try manual upload or check the S3 source.', true);
        return;
    }
    
    parsedData = data;
    activeFilter = null; 
    document.getElementById('activeFilterIndicator').classList.add('hidden');
    
    dashboardContent.classList.remove('hidden');
    manualUploadSection.classList.remove('highlight-section'); 

    cleanupCharts();
    populateFilterOptions();
    initializeCoreVisuals(parsedData); 
    setupPrimeSearch(parsedData);
    initializePrimeProfilesSection(parsedData); // Initialize always-visible Prime Profiles
    initializeRecompeteCalendarSection(parsedData); // Initialize always-visible Calendar

    showSuccessMessage('Data loaded and dashboard initialized.', true); 
    hideProcessing();
}

// --- S3 Data Loading ---
function loadDataFromS3() {
    showProcessingBriefly(); // Show spinner briefly
    fetch(S3_CSV_URL, { mode: 'cors', cache: 'no-cache', headers: { 'Accept': 'text/csv' } })
    .then(response => {
        if (!response.ok) {
            let errorDetail = `HTTP error ${response.status}`;
            if (response.status === 0) errorDetail = "Network error or CORS issue.";
            else if (response.status === 403) errorDetail = "Access Forbidden (403).";
            else if (response.status === 404) errorDetail = "File Not Found (404).";
            throw new Error(`Failed to fetch data from S3. ${errorDetail}`);
        }
        return response.text();
    })
    .then(csvText => {
        if (!csvText || csvText.trim() === '') {
            showErrorMessage('S3 file is empty or contains no data.', true);
            return;
        }
        // showProcessingBriefly(); // Parsing is usually fast
        Papa.parse(csvText, {
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: function(results) {
                if (results.errors && results.errors.length > 0) {
                    showErrorMessage('Error parsing CSV from S3: ' + results.errors[0].message, true);
                    return;
                }
                if (results.data && results.data.length > 0) {
                    processAndInitialize(results.data);
                } else {
                    showErrorMessage('No data could be parsed from the S3 file.', true);
                }
            },
            error: function(error) {
                showErrorMessage('Error parsing CSV data from S3: ' + error.message, true);
            }
        });
    })
    .catch(error => {
        let errorMsg = error.message; 
        if (navigator.onLine === false && !errorMsg.includes("offline")) {
            errorMsg += " You also appear to be offline.";
        }
        showErrorMessage(errorMsg, true);
    });
}

// --- Populate Filter Dropdowns (Simplified) ---
function populateFilterOptions() {
    const naicsCodes = new Set();
    const agencies = new Set();
    const states = new Set();
    
    parsedData.forEach(record => {
        if (record['NAICS Code']) naicsCodes.add(`${record['NAICS Code']}|${(record['NAICS Description'] || '').substring(0, 50)}`);
        if (record['Contracting Department Name']) agencies.add(record['Contracting Department Name']);
        if (record['Principal Place of Performance State Code']) states.add(record['Principal Place of Performance State Code']);
    });

    const populateSelect = (selectId, optionsSet, defaultOptionText, valueFormatter) => {
        const selectElement = document.getElementById(selectId);
        selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`;
        Array.from(optionsSet).sort().forEach(item => {
            const option = document.createElement('option');
            if (valueFormatter) {
                const { value, text } = valueFormatter(item);
                option.value = value; option.textContent = text;
            } else {
                option.value = item; option.textContent = item || 'Not Specified';
            }
            selectElement.appendChild(option);
        });
    };

    populateSelect('naicsFilter', naicsCodes, 'All NAICS Codes', item => {
        const [code, desc] = item.split('|'); return { value: code, text: `${code} - ${desc}` };
    });
    populateSelect('agencyFilter', agencies, 'All Departments/Agencies');
    populateSelect('stateFilter', states, 'All States');
}

// --- Apply Advanced Filters (Simplified) ---
function applyAdvancedFilters() {
    const filters = {
        naics: document.getElementById('naicsFilter').value,
        agency: document.getElementById('agencyFilter').value,
        state: document.getElementById('stateFilter').value,
    };

    let filteredData = parsedData.filter(record => {
        if (filters.naics && record['NAICS Code'] != filters.naics) return false;
        if (filters.agency && record['Contracting Department Name'] !== filters.agency) return false;
        if (filters.state && record['Principal Place of Performance State Code'] !== filters.state) return false;
        return true;
    });
    
    initializeCoreVisuals(filteredData); 
    initializePrimeProfilesSection(filteredData); // Update Prime Profiles with filtered data
    initializeRecompeteCalendarSection(filteredData); // Update Calendar with filtered data
    updateActiveFilterIndicator(filteredData.length < parsedData.length, filteredData.length);
}

function clearAdvancedFilters() {
    document.getElementById('naicsFilter').value = '';
    document.getElementById('agencyFilter').value = '';
    document.getElementById('stateFilter').value = '';
    
    initializeCoreVisuals(parsedData);
    initializePrimeProfilesSection(parsedData);
    initializeRecompeteCalendarSection(parsedData);
    updateActiveFilterIndicator(false);
}

function updateActiveFilterIndicator(isFiltered, count) {
    const indicator = document.getElementById('activeFilterIndicator');
    if (isFiltered) {
        indicator.innerHTML = `<span>Filtered: ${count.toLocaleString()} of ${parsedData.length.toLocaleString()} contracts</span> <button class="clear-filter-btn-tailwind bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600" onclick="clearAdvancedFilters()">Clear Filters</button>`;
        indicator.classList.remove('hidden');
    } else {
        indicator.classList.add('hidden');
    }
}

// --- Initialize Core Visualizations ---
function initializeCoreVisuals(data) {
    updateStatistics(data);
    createPrimeContractorsChart(data);
    createDepartmentChart(data);
}

// --- Statistics Update ---
function updateStatistics(data) {
    if (!data || data.length === 0) { /* ... (same as before) ... */ return; }
    document.getElementById('totalContractsValue').textContent = data.length.toLocaleString();
    let totalValue = 0, contractsWithValue = 0;
    data.forEach(record => {
        const value = parseCurrencyValue(record['Base and All Options Value (Total Contract Value)']);
        if (value > 0) { totalValue += value; contractsWithValue++; }
    });
    document.getElementById('totalValueValue').textContent = formatCurrency(totalValue);
    const avgValue = contractsWithValue > 0 ? totalValue / contractsWithValue : 0;
    document.getElementById('avgContractValue').textContent = formatCurrency(avgValue);
    const uniquePrimes = new Set(data.map(r => r['Legal Business Name']).filter(Boolean));
    document.getElementById('uniquePrimesValue').textContent = uniquePrimes.size.toLocaleString();
}

// --- Chart Creation Functions ---
function createChart(canvasId, type, data, options) {
    const ctx = document.getElementById(canvasId).getContext('2d');
    if (charts[canvasId]) charts[canvasId].destroy();
    charts[canvasId] = new Chart(ctx, { type, data, options });
}

function createPrimeContractorsChart(data) {
    const primeValues = {};
    data.forEach(record => {
        const prime = record['Legal Business Name'];
        if (prime) primeValues[prime] = (primeValues[prime] || 0) + parseCurrencyValue(record['Base and All Options Value (Total Contract Value)']);
    });
    const sortedPrimes = Object.entries(primeValues).sort((a, b) => b[1] - a[1]).slice(0, 10);
    createChart('primeContractorsChart', 'bar', 
        { labels: sortedPrimes.map(item => item[0]), datasets: [{ label: 'Contract Value', data: sortedPrimes.map(item => item[1]), backgroundColor: 'rgba(54, 162, 235, 0.7)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1 }] },
        { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => formatCurrency(ctx.raw) } } }, scales: { x: { ticks: { callback: val => formatCurrency(val).slice(0,-3)+'k' } }, y: { ticks: { autoSkip: false, callback: function(val) { const label = this.getLabelForValue(val); return label.length > 20 ? label.substring(0, 17) + '...' : label; } } } } }
    );
}

function createDepartmentChart(data) {
    const deptValues = {};
    data.forEach(record => {
        const dept = record['Contracting Department Name'];
        if (dept) deptValues[dept] = (deptValues[dept] || 0) + parseCurrencyValue(record['Base and All Options Value (Total Contract Value)']);
    });
    const sortedDepts = Object.entries(deptValues).sort((a, b) => b[1] - a[1]).slice(0, 10);
    createChart('departmentChart', 'pie',
        { labels: sortedDepts.map(item => item[0]), datasets: [{ data: sortedDepts.map(item => item[1]), backgroundColor: ['#3B82F6','#EF4444','#F59E0B','#10B981','#8B5CF6','#EC4899','#6366F1', '#FBBF24', '#22C55E', '#D946EF'], borderWidth: 1 }] },
        { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: { size: 10 } } }, tooltip: { callbacks: { label: ctx => `${ctx.label || ''}: ${formatCurrency(ctx.raw)}` } } } }
    );
}

// --- Prime Search (Main Search Bar) ---
function setupPrimeSearch(allData) {
    const searchInput = document.getElementById('primeSearchInput');
    const resultsContainer = document.getElementById('searchResults');
    const filterIndicator = document.getElementById('activeFilterIndicator');

    window.clearPrimeFilterFromIndicator = function() { // Used by the "Clear Filter" button in the indicator
        activeFilter = null;
        filterIndicator.classList.add('hidden');
        // Instead of just full data, re-apply advanced filters if any are set
        applyAdvancedFilters(); // This will use parsedData if no advanced filters are selected
        searchInput.value = '';
        resultsContainer.innerHTML = '';
    };
    
    window.applyPrimeFilter = function(primeName) { // Called from search results or profile cards
        const primeData = parsedData.filter(record => record['Legal Business Name'] === primeName);
        activeFilter = primeName; 
        filterIndicator.innerHTML = `<span>Filtered by Prime: <strong>${primeName}</strong></span> <button class="clear-filter-btn-tailwind bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600" onclick="clearPrimeFilterFromIndicator()">Clear Filter</button>`;
        filterIndicator.classList.remove('hidden');
        
        // Update visuals based ONLY on this prime, ignoring other advanced filters for this specific view.
        // OR, decide if prime filter should combine with advanced filters. Current logic implies prime filter overrides.
        initializeCoreVisuals(primeData); 
        initializePrimeProfilesSection(primeData); // Show only this prime in profiles
        initializeRecompeteCalendarSection(primeData); // Show calendar for this prime

        resultsContainer.innerHTML = ''; 
        searchInput.value = primeName; 
        
        const advancedFilterDetails = document.querySelector('#advancedFiltersSection details');
        if (advancedFilterDetails) advancedFilterDetails.open = false;
        closeModal(); // Close any open modal
    };
    
    searchInput.addEventListener('input', _.debounce(function() {
        const searchTerm = this.value.toLowerCase().trim();
        if (searchTerm.length < 2) {
            resultsContainer.innerHTML = ''; return;
        }
        const matches = new Map();
        allData.forEach(record => { // Search against allData or currently filtered data? For now, allData.
            const prime = record['Legal Business Name'];
            if (prime && prime.toLowerCase().includes(searchTerm)) {
                if (!matches.has(prime)) matches.set(prime, { name: prime, contracts: 0, totalValue: 0 });
                const mData = matches.get(prime);
                mData.contracts++; mData.totalValue += parseCurrencyValue(record['Base and All Options Value (Total Contract Value)']);
            }
        });
        const sortedMatches = Array.from(matches.values()).sort((a, b) => b.totalValue - a.totalValue).slice(0, 10);
        resultsContainer.innerHTML = sortedMatches.length > 0 ? sortedMatches.map(match => `
            <div class="p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-200 last:border-b-0" onclick="applyPrimeFilter('${match.name.replace(/'/g, "\\'")}')">
                <strong class="text-blue-600">${match.name}</strong><br>
                <small class="text-gray-600">Contracts: ${match.contracts.toLocaleString()} | Value: ${formatCurrency(match.totalValue)}</small>
            </div>`).join('') : '<div class="p-3 text-gray-500">No matching prime contractors found.</div>';
    }, 300));
}

// --- Prime Profiles Section (Always Visible) ---
function initializePrimeProfilesSection(data) {
    const profiles = {};
    data.forEach(record => {
        const primeName = record['Legal Business Name'];
        if (!primeName) return;
        if (!profiles[primeName]) profiles[primeName] = { name: primeName, contracts: 0, totalValue: 0, naics: new Set() };
        profiles[primeName].contracts++;
        profiles[primeName].totalValue += parseCurrencyValue(record['Base and All Options Value (Total Contract Value)']);
        if(record['NAICS Code']) profiles[primeName].naics.add(record['NAICS Code']);
    });

    function renderPrimeCards(filterTerm = '') {
        primeProfilesContainer.innerHTML = '';
        let count = 0;
        Object.values(profiles)
            .filter(p => filterTerm === '' || p.name.toLowerCase().includes(filterTerm.toLowerCase()))
            .sort((a,b) => b.totalValue - a.totalValue) // Default sort by total value
            .forEach(profile => { // Display all matches, or paginate if too many
                count++;
                const card = document.createElement('div');
                card.className = 'p-4 bg-gray-50 rounded-lg border border-gray-200 shadow hover:shadow-md transition-shadow';
                card.innerHTML = `
                    <h4 class="font-semibold text-blue-700 truncate" title="${profile.name}">${profile.name}</h4>
                    <p class="text-sm text-gray-600">Contracts: ${profile.contracts.toLocaleString()}</p>
                    <p class="text-sm text-gray-600">Total Value: ${formatCurrency(profile.totalValue)}</p>
                    <p class="text-xs text-gray-500 mt-1 truncate" title="Top NAICS: ${Array.from(profile.naics).slice(0,3).join(', ')}">Top NAICS: ${Array.from(profile.naics).slice(0,3).join(', ')}</p>
                    <button class="mt-2 text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300" onclick="applyPrimeFilter('${profile.name.replace(/'/g, "\\'")}')">View Dashboard for this Prime</button>
                `;
                primeProfilesContainer.appendChild(card);
        });
        if(count === 0) primeProfilesContainer.innerHTML = `<p class="text-gray-500 p-4 col-span-full text-center">No prime contractors match your criteria.</p>`;
    }
    
    primeProfilesSearchInput.addEventListener('input', _.debounce(() => renderPrimeCards(primeProfilesSearchInput.value), 300));
    renderPrimeCards(); // Initial render
}


// --- Recompete Calendar Section (Always Visible) ---
function initializeRecompeteCalendarSection(data) {
    const contractEvents = [];
    data.forEach(record => {
        if (record['Completion Date']) {
            const completionDate = new Date(record['Completion Date']);
            if (!isNaN(completionDate.getTime())) {
                contractEvents.push({
                    date: completionDate,
                    prime: record['Legal Business Name'],
                    value: parseCurrencyValue(record['Base and All Options Value (Total Contract Value)']),
                    id: record['Procurement Instrument Identifier'] || 'N/A'
                });
            }
        }
    });
    contractEvents.sort((a, b) => a.date - b.date);

    let currentCalendarDate = new Date();
    currentCalendarDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);

    calendarPrevBtn.onclick = () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); renderCalendarMonthView(); };
    calendarNextBtn.onclick = () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); renderCalendarMonthView(); };

    function renderCalendarMonthView() {
        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();
        calendarTitleEl.textContent = `${new Intl.DateTimeFormat('en-US', { month: 'long' }).format(currentCalendarDate)} ${year}`;
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const firstDayOfWeek = firstDay.getDay(); 

        let html = '';
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        dayNames.forEach(day => { html += `<div class="calendar-day-header">${day}</div>`; });

        for (let i = 0; i < firstDayOfWeek; i++) { html += '<div class="p-2 border bg-gray-50 min-h-[60px] md:min-h-[80px]"></div>'; }

        for (let day = 1; day <= daysInMonth; day++) {
            const dayEvents = contractEvents.filter(event => 
                event.date.getFullYear() === year && event.date.getMonth() === month && event.date.getDate() === day
            );
            html += `<div class="p-2 border min-h-[60px] md:min-h-[80px] relative ${dayEvents.length > 0 ? 'bg-blue-50' : 'bg-white'}">
                        <div class="font-semibold text-right text-gray-700">${day}</div>`;
            dayEvents.slice(0, 2).forEach(event => { // Show max 2 events directly, more via tooltip/click
                html += `<div class="calendar-event" data-event-details="${event.prime} (${formatCurrency(event.value)}) - ID: ${event.id}">
                            ${event.prime ? event.prime.substring(0,10)+(event.prime.length > 10 ? '...' : '') : 'Contract'}
                         </div>`;
            });
            if (dayEvents.length > 2) {
                html += `<div class="text-xs text-gray-500 mt-1 cursor-pointer hover:underline" data-event-details="${dayEvents.length} events on this day. Click for details (not implemented).">+${dayEvents.length - 2} more</div>`;
            }
            html += `</div>`;
        }
        calendarGridEl.innerHTML = html;
        setupCalendarEventTooltips(globalTooltipEl); // Use the single global tooltip
    }
    renderCalendarMonthView();
}

function setupCalendarEventTooltips(tooltipElement) {
    document.querySelectorAll('#calendarGrid .calendar-event[data-event-details], #calendarGrid div[data-event-details]').forEach(el => {
        el.onmouseenter = (e) => {
            tooltipElement.innerHTML = el.dataset.eventDetails;
            tooltipElement.style.display = 'block';
            const rect = el.getBoundingClientRect();
            // Position tooltip above the element
            let top = rect.top + window.scrollY - tooltipElement.offsetHeight - 5;
            let left = rect.left + window.scrollX + (rect.width / 2) - (tooltipElement.offsetWidth / 2);

            // Adjust if tooltip goes off-screen
            if (top < window.scrollY) top = rect.bottom + window.scrollY + 5;
            if (left < window.scrollX) left = window.scrollX + 5;
            if (left + tooltipElement.offsetWidth > window.innerWidth) left = window.innerWidth - tooltipElement.offsetWidth - 5;
            
            tooltipElement.style.top = `${top}px`;
            tooltipElement.style.left = `${left}px`;
        };
        el.onmouseleave = () => {
            tooltipElement.style.display = 'none';
        };
    });
}


// --- Modal Handling & Content Generation for Remaining Buttons ---
function openModal(title, contentGenerator) {
    modalTitle.textContent = title;
    modalBody.innerHTML = '<div class="flex justify-center items-center h-32"><div class="spinner"></div><span class="ml-2 text-gray-600">Loading content...</span></div>'; // Basic loader
    detailModal.classList.add('active');
    // Use a slight delay to ensure modal is rendered before heavy content generation
    setTimeout(() => {
        modalBody.innerHTML = ''; // Clear loader
        contentGenerator(modalBody); 
    }, 50);
}

function closeModal() {
    detailModal.classList.remove('active');
    modalBody.innerHTML = ''; 
    Object.keys(charts).forEach(key => {
        if (key.startsWith('modal_')) { 
            if (charts[key]) charts[key].destroy();
            delete charts[key];
        }
    });
}
modalCloseBtn.addEventListener('click', closeModal);
modalCloseBtnAction.addEventListener('click', closeModal);
detailModal.addEventListener('click', (e) => { if (e.target === detailModal) closeModal(); });

// NAICS Analysis (in Modal)
document.getElementById('showNaicsAnalysisBtn').addEventListener('click', () => {
    openModal('NAICS Code Analysis', (container) => {
        const canvasId = 'modal_naicsAnalysisChart'; 
        container.innerHTML = `
            <p class="text-gray-600 mb-4">Top NAICS codes by contract value.</p>
            <div class="chart-container h-96 mb-4"><canvas id="${canvasId}"></canvas></div>
            <div class="mt-6">
                <h3 class="text-md font-semibold text-gray-700 mb-2">NAICS Code Details Lookup</h3>
                <div class="mb-3 md:flex md:gap-2">
                    <select id="modal_naicsDetailSelector" class="w-full md:w-2/3 p-2 border border-gray-300 rounded-md shadow-sm mb-2 md:mb-0">
                        <option value="">Select a NAICS Code</option>
                    </select>
                    <button id="modal_filterByNaicsBtn" class="w-full md:w-1/3 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Filter Dashboard by this NAICS</button>
                </div>
                <div id="modal_naicsDetailContent" class="bg-gray-50 p-3 rounded-md min-h-[100px]"><p class="text-gray-500">Select a NAICS code to view details.</p></div>
            </div>`;
        
        const naicsValues = {}, naicsDescriptions = {};
        parsedData.forEach(r => {
            if (r['NAICS Code']) {
                naicsValues[r['NAICS Code']] = (naicsValues[r['NAICS Code']] || 0) + parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
                if (!naicsDescriptions[r['NAICS Code']]) naicsDescriptions[r['NAICS Code']] = r['NAICS Description'] || '';
            }
        });
        const sortedNAICS = Object.entries(naicsValues).sort((a,b)=>b[1]-a[1]).slice(0,10);
        createChart(canvasId, 'bar', 
            { labels: sortedNAICS.map(item => `${item[0]} - ${naicsDescriptions[item[0]].substring(0,20)}...`), datasets: [{ label: 'Contract Value', data: sortedNAICS.map(item => item[1]), backgroundColor: 'rgba(22, 163, 74, 0.7)' }] },
            { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false}, tooltip: {callbacks:{label:c=>formatCurrency(c.raw)}}}, scales: {x:{ticks:{callback:v=>formatCurrency(v).slice(0,-3)+'k'}}}});

        const naicsDetailSelector = document.getElementById('modal_naicsDetailSelector');
        const uniqueNaics = new Set();
        parsedData.forEach(r => { if(r['NAICS Code']) uniqueNaics.add(`${r['NAICS Code']}|${(r['NAICS Description'] || '').substring(0,50)}`)});
        Array.from(uniqueNaics).sort().forEach(item => {
            const [code, desc] = item.split('|');
            const option = document.createElement('option'); option.value = code; option.textContent = `${code} - ${desc}`;
            naicsDetailSelector.appendChild(option);
        });
        
        naicsDetailSelector.addEventListener('change', function() { /* ... (same detail display logic as before) ... */ 
            const selectedCode = this.value;
            const detailContent = document.getElementById('modal_naicsDetailContent');
            if (!selectedCode) {
                detailContent.innerHTML = '<p class="text-gray-500">Select a NAICS code to view details.</p>'; return;
            }
            const naicsSpecificData = parsedData.filter(r => r['NAICS Code'] == selectedCode);
            const primeBreakdown = {};
            naicsSpecificData.forEach(r => {
                const prime = r['Legal Business Name'];
                if(prime) primeBreakdown[prime] = (primeBreakdown[prime] || 0) + parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
            });
            const sortedPrimesInNaics = Object.entries(primeBreakdown).sort((a,b) => b[1] - a[1]).slice(0,5);
            let html = `<h4 class="font-semibold mb-1">Top Primes for NAICS ${selectedCode}:</h4><ul class="list-disc list-inside text-sm">`;
            sortedPrimesInNaics.forEach(([prime, val]) => { html += `<li>${prime}: ${formatCurrency(val)}</li>`; });
            html += `</ul>`;
            if(sortedPrimesInNaics.length === 0) html = `<p class="text-gray-500">No prime contractor data for this NAICS code.</p>`;
            detailContent.innerHTML = html;
        });
        document.getElementById('modal_filterByNaicsBtn').onclick = () => {
            const selectedNaics = naicsDetailSelector.value;
            if (selectedNaics) {
                document.getElementById('naicsFilter').value = selectedNaics;
                applyAdvancedFilters();
                closeModal();
            }
        };
    });
});

// More Overview Charts (in Modal)
document.getElementById('showMoreChartsBtn').addEventListener('click', () => {
    openModal('Additional Overview Charts', (container) => {
        container.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Contract Type Breakdown</h3>
                    <div class="chart-container h-72"><canvas id="modal_contractTypeChart"></canvas></div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Contract Value Range Distribution</h3>
                    <div class="chart-container h-72"><canvas id="modal_valueRangeChart"></canvas></div>
                </div>
            </div>`;
        const contractTypes = {};
        parsedData.forEach(r => { if(r['Award or Indefinite Delivery Vehicle Type']) contractTypes[r['Award or Indefinite Delivery Vehicle Type']] = (contractTypes[r['Award or Indefinite Delivery Vehicle Type']] || 0) + 1; });
        createChart('modal_contractTypeChart', 'doughnut',
            { labels: Object.keys(contractTypes), datasets: [{ data: Object.values(contractTypes), backgroundColor: ['#3B82F6','#EF4444','#F59E0B','#10B981','#8B5CF6', '#F472B6', '#6B7280'] }] },
            { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels:{font:{size:10}} } } }
        );
        const ranges = [ { min: 0, max: 100000, label: '< $100K' }, { min: 100000, max: 1000000, label: '$100K-$1M' }, { min: 1000000, max: 10000000, label: '$1M-$10M' }, { min: 10000000, max: 100000000, label: '$10M-$100M' }, { min: 100000000, max: Infinity, label: '> $100M' } ];
        const rangeCounts = Array(ranges.length).fill(0);
        parsedData.forEach(r => {
            const value = parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
            for (let i = 0; i < ranges.length; i++) if (value >= ranges[i].min && value < ranges[i].max) { rangeCounts[i]++; break; }
        });
        createChart('modal_valueRangeChart', 'bar',
            { labels: ranges.map(r => r.label), datasets: [{ label: 'Contracts', data: rangeCounts, backgroundColor: '#F59E0B' }] },
            { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: {y: {beginAtZero: true}} }
        );
    });
});


// --- File Input Handling ---
csvFileInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) { fileNameDisplay.textContent = 'No file selected'; return; }
    fileNameDisplay.textContent = file.name;
    showProcessingBriefly();
    Papa.parse(file, {
        header: true, dynamicTyping: true, skipEmptyLines: true,
        complete: function(results) {
            if (results.errors && results.errors.length > 0) { showErrorMessage('Error parsing CSV: ' + results.errors[0].message); return; }
            if (results.data && results.data.length > 0) {
                showSuccessMessage('File processed successfully!', false); // Manual success
                processAndInitialize(results.data);
                // autoloadStatus.classList.add('hidden'); // Ensure S3 status is hidden
                const s3ErrorDiv = document.getElementById('s3LoadError');
                if (s3ErrorDiv) s3ErrorDiv.classList.add('hidden'); // Hide S3 error if manual is successful
            } else { showErrorMessage('No data in uploaded file.'); }
        },
        error: function(error) { showErrorMessage('CSV parsing failed: ' + error.message); }
    });
});

// --- Event Listeners for Advanced Filters ---
document.getElementById('applyFiltersBtn').addEventListener('click', applyAdvancedFilters);
document.getElementById('clearFiltersBtn').addEventListener('click', clearAdvancedFilters);

// --- Page Load ---
document.addEventListener('DOMContentLoaded', function() {
    loadDataFromS3(); 
});

</script>
</body>
</html>
