<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streamlined Federal Business Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.2.0/chartjs-plugin-datalabels.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            height: 300px; 
            width: 100%;
        }
        /* Removed .chart-container-modal as prime detail modal is gone */
        .chart-no-data {
            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #6b7280; 
            background-color: #f9fafb; 
            border: 1px dashed #d1d5db; 
            border-radius: 0.375rem; 
            text-align: center;
            padding: 1rem;
        }
        .chart-no-data svg { 
            width: 3rem; 
            height: 3rem; 
            margin-bottom: 0.5rem; 
            color: #9ca3af; 
        }
        .spinner, .global-spinner { 
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        #globalProcessingIndicator { 
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 2000; 
            display: flex;
            align-items: center;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .calendar-day-header {
            font-weight: 600;
            text-align: center;
            padding: 5px 0;
            background-color: #2980b9; 
            color: white;
            border-radius: 4px;
        }
         .calendar-event {
            padding: 3px 5px;
            background-color: #3498db;
            color: white;
            border-radius: 3px;
            margin-bottom: 3px;
            font-size: 0.6875rem; 
            cursor: default; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .calendar-day-cell { 
            cursor: pointer;
            transition: background-color 0.2s;
            min-width: 60px; 
        }
        .calendar-day-cell:hover:not(.bg-gray-50) { 
             background-color: #eff6ff !important; 
        }
        .calendar-grid-wrapper { 
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; 
        }
        .calendar-grid-wrapper .grid { 
            min-width: 450px; 
        }

        .event-tooltip {
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-width: 300px;
            display: none;
        }
        .metric-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            justify-content: center;
        }
        .filter-btn {
            padding: 4px 8px;
            background-color: #f1f1f1; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            cursor: pointer;
            font-size: 12px; 
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .filter-btn.active {
            background-color: #2980b9; 
            color: white;
            border-color: #2980b9; 
        }
        .filter-btn:focus, button:focus, input[type="text"]:focus, select:focus { 
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4); 
        }
        #processingIndicator.flex { 
            display: flex;
        }
        #unifiedSearchSuggestions {
            position: absolute;
            background-color: white;
            border: 1px solid #d1d5db; 
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem; 
            max-height: 240px; 
            overflow-y: auto;
            width: calc(100% - 2px); 
            z-index: 50; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); 
        }
        .suggestion-item {
            padding: 0.5rem 0.75rem; 
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #f3f4f6; 
        }
        .suggestion-item .type-label {
            font-size: 0.75rem; 
            color: #6b7280; 
            margin-left: 0.5rem; 
            background-color: #e5e7eb; 
            padding: 0.125rem 0.375rem; 
            border-radius: 0.25rem; 
        }
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 1rem;
        }
        .modal-content {
            background-color: white;
            border-radius: 0.5rem; 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); 
            padding: 1.5rem; 
            max-width: 90vw; 
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        .modal-content-lg { max-width: 60rem; } 
        .modal-content-md { max-width: 48rem; } 

        .modal-close-btn {
            position: absolute;
            top: 0.75rem; 
            right: 0.75rem; 
            background: none;
            border: none;
            font-size: 1.5rem; 
            color: #9ca3af; 
            cursor: pointer;
            padding: 0.25rem; 
        }
        .modal-close-btn:hover {
            color: #374151; 
        }
        .table-responsive {
            display: block;
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .table-responsive thead th { 
            position: sticky;
            top: 0;
            z-index: 10; 
            background-color: #f9fafb; 
        }
        .table-responsive th { 
            cursor: pointer;
        }
        .table-responsive th:hover {
            background-color: #e5e7eb; 
        }
        .dashboard-card {
            transition: box-shadow 0.3s ease-in-out;
        }
        .dashboard-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); 
        }
    </style>
</head>
<body class="bg-gray-100 p-2 sm:p-4 md:p-8">
    <div id="globalProcessingIndicator" class="hidden">
        <div class="global-spinner"></div>
        <span class="text-sm text-gray-700">Processing...</span>
    </div>

    <div class="dashboard-container max-w-7xl mx-auto">
        <header class="mb-4 md:mb-6">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Federal Business Development Dashboard</h1>
        </header>

        <section id="explainerSection" class="bg-white p-4 md:p-6 rounded-lg shadow-md mb-4 md:mb-6">
            <h2 class="text-xl md:text-2xl font-semibold text-gray-700 mb-3">Welcome!</h2>
            <p class="text-sm md:text-base text-gray-600 mb-2">
                This dashboard helps you explore federal contracting data to identify potential teaming opportunities. 
                Data is automatically loaded.
            </p>
            <p class="text-sm md:text-base text-gray-600 mb-2">
                <strong>How to Use:</strong> Use the <strong>Search & Filter</strong> bar below. As you type, suggestions for Prime Names, NAICS, Agencies, etc., will appear. Click a suggestion to filter the dashboard, or press Enter to search with your typed term(s).
            </p>
            <p class="text-xs md:text-sm text-gray-600">
                If data fails to load, a manual upload option will appear. Source CSV:
                <a href="https://subhoodata.s3.us-east-1.amazonaws.com/data/sbaall.csv" download class="text-blue-500 hover:text-blue-600 hover:underline">sbaall.csv</a>.
            </p>
            <div id="processingIndicator" class="hidden items-center text-gray-700 mt-4">
                <div class="spinner"></div>
                <span class="ml-2 text-sm">Processing data...</span>
            </div>
            <div id="s3LoadError" class="text-red-600 bg-red-100 p-3 rounded-md mt-3 hidden text-sm"></div>
            <div id="manual-upload-section" class="hidden mt-4 border-t pt-4">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Manual CSV Upload</h3>
                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 sm:gap-4 mb-4">
                    <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                    <label for="csvFileInput" class="w-full sm:w-auto px-4 py-2 bg-blue-500 text-white rounded-md cursor-pointer hover:bg-blue-600 transition-colors duration-150 ease-in-out focus:ring-2 focus:ring-offset-2 focus:ring-blue-400 focus:outline-none">Choose CSV File</label>
                    <span id="file-name-display" class="text-sm text-gray-700 p-2 border border-gray-300 rounded-md min-w-[200px] w-full sm:w-auto">No file selected</span>
                </div>
                <div id="errorMessage" class="text-red-600 bg-red-100 p-3 rounded-md hidden mb-2 text-sm"></div>
                <div id="successMessage" class="text-green-600 bg-green-100 p-3 rounded-md hidden mb-2 text-sm"></div>
            </div>
        </section>

        <main id="dashboardContent" class="hidden">
            <section id="statisticsSection" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4 mb-4 md:mb-6">
                <div class="stat-card bg-white p-3 md:p-4 rounded-lg shadow hover:shadow-lg transition-shadow duration-150">
                    <div class="text-2xl md:text-3xl font-bold text-blue-600" id="totalContractsValue">0</div>
                    <div class="text-xs md:text-sm text-gray-500">Total Contracts</div>
                </div>
                <div class="stat-card bg-white p-3 md:p-4 rounded-lg shadow hover:shadow-lg transition-shadow duration-150">
                    <div class="text-2xl md:text-3xl font-bold text-blue-600" id="totalValueValue">$0</div>
                    <div class="text-sm text-gray-500">Total Contract Value</div>
                </div>
                <div class="stat-card bg-white p-3 md:p-4 rounded-lg shadow hover:shadow-lg transition-shadow duration-150">
                    <div class="text-2xl md:text-3xl font-bold text-blue-600" id="avgContractValue">$0</div>
                    <div class="text-sm text-gray-500">Average Contract Value</div>
                </div>
                <div class="stat-card bg-white p-3 md:p-4 rounded-lg shadow hover:shadow-lg transition-shadow duration-150">
                    <div class="text-2xl md:text-3xl font-bold text-blue-600" id="uniquePrimesValue">0</div>
                    <div class="text-sm text-gray-500">Unique Prime Contractors</div>
                </div>
            </section>
            
            <section id="searchAndFilterSection" class="bg-white p-4 md:p-6 rounded-lg shadow-md mb-4 md:mb-6">
                <h2 class="text-lg md:text-xl font-semibold text-gray-700 mb-3">Search & Filter Contracts</h2>
                <div class="relative">
                    <input type="text" id="unifiedSearchInput" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-2 focus:ring-blue-400 focus:border-blue-400" placeholder="Search by Prime, NAICS, Department, Agency, Office, State...">
                    <div id="unifiedSearchSuggestions" class="hidden">
                        </div>
                </div>
                                
                <div id="activeFilterIndicator" class="bg-blue-100 text-blue-700 p-3 rounded-md mt-4 hidden flex flex-col sm:flex-row justify-between items-center text-sm">
                    </div>
            </section>

            <section id="coreChartsSection" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 md:gap-6 mb-4 md:mb-6">
                <div class="dashboard-card bg-white p-4 md:p-6 rounded-lg shadow">
                    <h2 class="text-md md:text-lg font-semibold text-gray-700 mb-3 text-center">Top Prime Contractors by Value</h2>
                    <div class="chart-container">
                        <canvas id="primeContractorsChart"></canvas>
                    </div>
                </div>
                <div class="dashboard-card bg-white p-4 md:p-6 rounded-lg shadow">
                    <h2 class="text-md md:text-lg font-semibold text-gray-700 mb-3 text-center">Department Contract Distribution</h2>
                    <div class="chart-container">
                        <canvas id="departmentChart"></canvas>
                    </div>
                </div>
                <div class="dashboard-card bg-white p-4 md:p-6 rounded-lg shadow">
                    <h2 class="text-md md:text-lg font-semibold text-gray-700 mb-3 text-center">Top NAICS by Contract Value</h2>
                    <div class="chart-container">
                        <canvas id="naicsChart_main"></canvas>
                    </div>
                </div>
                <div class="dashboard-card bg-white p-4 md:p-6 rounded-lg shadow">
                    <h2 class="text-md md:text-lg font-semibold text-gray-700 mb-3 text-center">Contract Type Breakdown</h2>
                    <div class="chart-container">
                        <canvas id="contractTypeChart_main"></canvas>
                    </div>
                </div>
                <div class="dashboard-card bg-white p-4 md:p-6 rounded-lg shadow"> 
                    <h2 class="text-md md:text-lg font-semibold text-gray-700 mb-1 text-center">Contract Distribution by State</h2>
                    <div class="metric-filters" id="stateChartFilters_main">
                        <button class="filter-btn active" data-filter="count" data-chart="stateContractsChart_main">By Count</button>
                        <button class="filter-btn" data-filter="value" data-chart="stateContractsChart_main">By Value</button>
                    </div>
                    <div class="chart-container" style="height: 320px;"> 
                        <canvas id="stateContractsChart_main"></canvas>
                    </div>
                </div>
                <div class="dashboard-card bg-white p-4 md:p-6 rounded-lg shadow">
                    <h2 class="text-md md:text-lg font-semibold text-gray-700 mb-3 text-center">Top Contracting Agencies by Value</h2>
                    <div class="chart-container">
                        <canvas id="topAgenciesChart"></canvas>
                    </div>
                </div>
                <div class="dashboard-card bg-white p-4 md:p-6 rounded-lg shadow md:col-span-2 xl:col-span-1"> 
                     <h2 class="text-md md:text-lg font-semibold text-gray-700 mb-3 text-center">Contract Timeline Forecast</h2>
                    <div class="chart-container">
                        <canvas id="timelineChart"></canvas> 
                    </div>
                </div>
                 <div class="dashboard-card bg-white p-4 md:p-6 rounded-lg shadow md:col-span-2 xl:col-span-2"> 
                    <h2 class="text-md md:text-lg font-semibold text-gray-700 mb-3 text-center">Prime Market Share (for current filter)</h2>
                    <div class="chart-container">
                        <canvas id="marketShareChart"></canvas>
                    </div>
                </div>
            </section>
            
            <section id="primeProfilesSection" class="bg-white p-4 md:p-6 rounded-lg shadow-md mb-4 md:mb-6">
                <h2 class="text-lg md:text-xl font-semibold text-gray-700 mb-3">Prime Contractor Profiles</h2>
                 <p class="text-xs md:text-sm text-gray-500 mb-3">Displaying profiles based on current search/filter. Click a prime name to filter the entire dashboard to that prime. Use search below to refine this list further.</p>
                <div class="mb-4">
                    <input type="text" id="primeProfilesSearchInput" class="w-full md:w-1/2 lg:w-1/3 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:border-blue-400" placeholder="Filter displayed profiles by name...">
                </div>
                <div id="primeProfilesContainer" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-3 md:gap-4 max-h-[70vh] overflow-y-auto"></div>
            </section>

            <section id="contractExpirationCalendarSection" class="bg-white p-4 md:p-6 rounded-lg shadow-md mb-4 md:mb-6">
                <h2 class="text-lg md:text-xl font-semibold text-gray-700 mb-3">Contract Expiration Calendar</h2>
                 <p class="text-xs md:text-sm text-gray-500 mb-3">Displaying calendar based on current search/filter. Click a day with events for details.</p>
                <div class="calendar-container min-h-[400px] border border-gray-200 rounded-md p-2 md:p-4">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <div class="flex items-center gap-1">
                            <button id="calendarPrevBtn" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 transition-colors duration-150 ease-in-out focus:ring-2 focus:ring-offset-2 focus:ring-blue-400 focus:outline-none">&lt;</button>
                            <h3 id="calendarTitle" class="text-md md:text-lg font-semibold mx-2">Month Year</h3>
                            <button id="calendarNextBtn" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 transition-colors duration-150 ease-in-out focus:ring-2 focus:ring-offset-2 focus:ring-blue-400 focus:outline-none">&gt;</button>
                        </div>
                        <div class="flex items-center gap-2 text-xs md:text-sm">
                            <label for="calendarMonthSelect" class="sr-only">Month</label>
                            <select id="calendarMonthSelect" class="p-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:border-blue-400"></select>
                            <label for="calendarYearSelect" class="sr-only">Year</label>
                            <select id="calendarYearSelect" class="p-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-400 focus:border-blue-400"></select>
                        </div>
                    </div>
                    <div class="calendar-grid-wrapper">
                        <div id="calendarGrid" class="grid grid-cols-7 gap-1 text-xs md:text-sm"></div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="genericModal" class="modal-backdrop hidden">
        <div id="genericModalContent" class="modal-content">
            <button id="genericModalCloseBtn" class="modal-close-btn">&times;</button>
            <h2 id="genericModalTitle" class="text-xl font-semibold text-gray-800 mb-4">Modal Title</h2>
            <div id="genericModalBody" class="text-gray-700">
                </div>
        </div>
    </div>

    <div class="event-tooltip"></div>

<script>
// --- DOM Elements ---
const globalProcessingIndicator = document.getElementById('globalProcessingIndicator'); 
const processingIndicator = document.getElementById('processingIndicator'); 
const manualUploadSection = document.getElementById('manual-upload-section');
const dashboardContent = document.getElementById('dashboardContent');
const csvFileInput = document.getElementById('csvFileInput');
const fileNameDisplay = document.getElementById('file-name-display');
const errorMessageDiv = document.getElementById('errorMessage');
const successMessageDiv = document.getElementById('successMessage');
const s3LoadErrorDiv = document.getElementById('s3LoadError');
const unifiedSearchInput = document.getElementById('unifiedSearchInput'); 
const unifiedSearchSuggestions = document.getElementById('unifiedSearchSuggestions'); 
const activeFilterIndicator = document.getElementById('activeFilterIndicator');

const primeProfilesContainer = document.getElementById('primeProfilesContainer');
const primeProfilesSearchInput = document.getElementById('primeProfilesSearchInput');
const calendarPrevBtn = document.getElementById('calendarPrevBtn');
const calendarNextBtn = document.getElementById('calendarNextBtn');
const calendarTitleEl = document.getElementById('calendarTitle');
const calendarGridEl = document.getElementById('calendarGrid');
const calendarMonthSelect = document.getElementById('calendarMonthSelect');
const calendarYearSelect = document.getElementById('calendarYearSelect');
const globalTooltipEl = document.querySelector('.event-tooltip');

// Modal Elements
const genericModal = document.getElementById('genericModal');
const genericModalContent = document.getElementById('genericModalContent');
const genericModalTitle = document.getElementById('genericModalTitle');
const genericModalBody = document.getElementById('genericModalBody');
const genericModalCloseBtn = document.getElementById('genericModalCloseBtn');


// --- Global Variables ---
let parsedData = [];
const charts = {}; 
const S3_CSV_URL = 'https://subhoodata.s3.us-east-1.amazonaws.com/data/sbaall.csv';
let currentMainStateChartFilter = 'count';
const ITEMS_PER_PAGE_MODAL_TABLE = 10; 
let currentCalendarDate = new Date(); 

// --- Utility Functions ---
function formatCurrency(value) {
    if (isNaN(parseFloat(value))) { 
        return '$0';
    }
    const num = parseFloat(value);

    if (Math.abs(num) >= 1.0e+9) { 
        return '$' + (num / 1.0e+9).toFixed(1) + 'B';
    }
    if (Math.abs(num) >= 1.0e+6) { 
        return '$' + (num / 1.0e+6).toFixed(1) + 'M';
    }
    if (Math.abs(num) >= 1.0e+3) { 
        return '$' + (num / 1.0e+3).toFixed(1) + 'K';
    }
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0 
    }).format(num);
}

function parseCurrencyValue(valueStr) { if (!valueStr) return 0; return parseFloat(String(valueStr).replace(/[$,\s]/g, '')) || 0; }
function formatDate(dateStr) { if (!dateStr) return ''; const date = new Date(dateStr); return isNaN(date.getTime()) ? '' : new Intl.DateTimeFormat('en-US', { year: 'numeric', month: 'short', day: 'numeric' }).format(date); }

function createAwardLink(piid) {
    if (!piid || typeof piid !== 'string' || piid.trim() === '' || piid.toLowerCase() === 'n/a') {
        return piid || 'N/A'; 
    }
    const encodedPiid = encodeURIComponent(piid.trim());
    return `<a href="https://www.fpds.gov/ezsearch/fpdsportal?indexName=awardfull&templateName=1.5.3&s=FPDS&q=${encodedPiid}&x=18&y=15" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hover:underline">${piid}</a>`;
}

function createEntityLink(entityId, entityName) {
    if (!entityId || typeof entityId !== 'string' || entityId.trim() === '' || entityId.toLowerCase() === 'n/a') {
        return entityName || entityId || 'N/A'; 
    }
    const encodedEntityId = encodeURIComponent(entityId.trim());
    return `<a href="https://www.fpds.gov/ezsearch/fpdsportal?s=FPDS&q=${encodedEntityId}&x=0&y=0" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 hover:underline">${entityName || entityId}</a>`;
}

function showGlobalLoader() { globalProcessingIndicator.classList.remove('hidden');}
function hideGlobalLoader() { globalProcessingIndicator.classList.add('hidden'); }

function showProcessingBriefly() { processingIndicator.classList.remove('hidden'); processingIndicator.classList.add('flex'); }
function hideProcessing() { processingIndicator.classList.add('hidden'); processingIndicator.classList.remove('flex');}

function showErrorMessage(message, isAutoloadError = false) {
    if (isAutoloadError) {
        manualUploadSection.classList.remove('hidden');
        s3LoadErrorDiv.textContent = `S3 Auto-load failed: ${message}. Please use manual upload option above.`;
        s3LoadErrorDiv.classList.remove('hidden');
    } else {
        errorMessageDiv.textContent = message; errorMessageDiv.classList.remove('hidden');
        successMessageDiv.classList.add('hidden');
    }
    hideProcessing();
    hideGlobalLoader(); 
}

function showSuccessMessage(message, isAutoloadSuccess = false) {
    if (isAutoloadSuccess) {
        s3LoadErrorDiv.classList.add('hidden');
    } else {
        successMessageDiv.textContent = message; successMessageDiv.classList.remove('hidden');
        errorMessageDiv.classList.add('hidden');
    }
    hideProcessing();
}

// --- Modal Management ---
function openModal(title, contentHTML, sizeClass = 'modal-content-md') {
    genericModalTitle.textContent = title;
    genericModalBody.innerHTML = contentHTML;
    genericModalContent.className = `modal-content ${sizeClass}`; 
    genericModal.classList.remove('hidden');
    genericModal.classList.add('flex');
}

function closeModal() {
    genericModal.classList.add('hidden');
    genericModal.classList.remove('flex');
    genericModalBody.innerHTML = ''; 
    // If modal-specific charts were used, destroy them here
    if(charts.primeDetailNaicsChart) charts.primeDetailNaicsChart.destroy();
    if(charts.primeDetailAgenciesChart) charts.primeDetailAgenciesChart.destroy();
}
genericModalCloseBtn.addEventListener('click', closeModal);
genericModal.addEventListener('click', (event) => { 
    if (event.target === genericModal) {
        closeModal();
    }
});


// --- Data Processing and Chart Initialization ---
function cleanupCharts() { Object.keys(charts).forEach(key => { if (charts[key]) { charts[key].destroy(); charts[key] = null; } }); }

function processAndInitialize(data) {
    if (!data || data.length === 0) { showErrorMessage('No data to display. Please try manual upload or check the S3 source.', true); return; }
    parsedData = data; 
    activeFilterIndicator.classList.add('hidden');
    dashboardContent.classList.remove('hidden');
    manualUploadSection.classList.add('hidden'); 
    s3LoadErrorDiv.classList.add('hidden'); 

    cleanupCharts(); 
    initializeCoreVisuals(parsedData);
    setupUnifiedSearch(); 
    initializePrimeProfilesSection(parsedData);
    initializeContractExpirationCalendarSection(parsedData); 
    showSuccessMessage('Data loaded and dashboard initialized.', true); 
    hideProcessing(); 
    hideGlobalLoader(); 
}

// --- S3 Data Loading ---
function loadDataFromS3() { 
    showProcessingBriefly(); 
    fetch(S3_CSV_URL, { mode: 'cors', cache: 'no-cache', headers: { 'Accept': 'text/csv' } })
    .then(response => {
        if (!response.ok) {
            let errorDetail = `HTTP error ${response.status}`;
            if (response.status === 0) errorDetail = "Network error or CORS issue.";
            else if (response.status === 403) errorDetail = "Access Forbidden (403).";
            else if (response.status === 404) errorDetail = "File Not Found (404).";
            throw new Error(`S3 Load Error: ${errorDetail}`);
        }
        return response.text();
    })
    .then(csvText => {
        if (!csvText || csvText.trim() === '') { showErrorMessage('S3 file is empty.', true); return; }
        Papa.parse(csvText, {
            header: true,
            dynamicTyping: true, 
            skipEmptyLines: true,
            complete: results => {
                if (results.errors && results.errors.length > 0) { showErrorMessage('Error parsing CSV from S3: ' + results.errors[0].message, true); return; }
                if (results.data && results.data.length > 0) processAndInitialize(results.data);
                else showErrorMessage('No data parsed from S3 file.', true);
            },
            error: error => showErrorMessage('Error parsing CSV data from S3: ' + error.message, true)
        });
    })
    .catch(error => {
        let errorMsg = error.message; 
        if (navigator.onLine === false && !errorMsg.includes("offline")) errorMsg += " You may also be offline.";
        showErrorMessage(errorMsg, true); 
    });
}

// --- Unified Search, Suggestions, and Filtering Logic ---
function applyFilter(searchTerm, filterType = null, filterValue = null) { 
    showGlobalLoader(); 
    setTimeout(() => { 
        let filteredData;
        let displaySearchTerm = searchTerm; 

        if (filterType) { 
            const termToMatch = (filterValue || searchTerm).toLowerCase(); 
            filteredData = parsedData.filter(record => {
                let recordValue = '';
                switch (filterType) {
                    case 'primeName': recordValue = record['Legal Business Name']?.toLowerCase() || ''; break;
                    case 'naicsCode': recordValue = String(record['NAICS Code'] || '').toLowerCase(); break;
                    case 'naicsDesc': recordValue = record['NAICS Description']?.toLowerCase() || ''; break;
                    case 'departmentName': recordValue = record['Contracting Department Name']?.toLowerCase() || ''; break; 
                    case 'agencyName': recordValue = record['Contracting Agency Name']?.toLowerCase() || ''; break;
                    case 'officeName': recordValue = record['Contracting Office Name']?.toLowerCase() || ''; break;
                    case 'stateCode': recordValue = record['Principal Place of Performance State Code']?.toLowerCase() || ''; break;
                    case 'contractType': recordValue = record['Award or Indefinite Delivery Vehicle Type']?.toLowerCase() || ''; break; 
                    default: return false;
                }
                if (filterValue) return recordValue === termToMatch; 
                return recordValue.includes(termToMatch); 
            });
            displaySearchTerm = `${filterType.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}: ${filterValue || searchTerm}`; 
        } else { 
            if (!searchTerm || searchTerm.trim() === '') {
                clearAllFilters(); 
                hideGlobalLoader(); 
                return;
            }
            const keywords = searchTerm.toLowerCase().split(' ').filter(k => k);
            filteredData = parsedData.filter(record => {
                return keywords.every(keyword => {
                    const primeName = record['Legal Business Name']?.toLowerCase() || '';
                    const naicsCode = String(record['NAICS Code'] || '').toLowerCase();
                    const naicsDesc = record['NAICS Description']?.toLowerCase() || '';
                    const departmentName = record['Contracting Department Name']?.toLowerCase() || '';
                    const agencyName = record['Contracting Agency Name']?.toLowerCase() || '';
                    const officeName = record['Contracting Office Name']?.toLowerCase() || '';
                    const stateCode = record['Principal Place of Performance State Code']?.toLowerCase() || '';
                    return primeName.includes(keyword) || naicsCode.includes(keyword) ||
                           naicsDesc.includes(keyword) || departmentName.includes(keyword) ||
                           agencyName.includes(keyword) || officeName.includes(keyword) ||
                           (keyword.length === 2 && stateCode === keyword) ||
                           (keyword.length > 2 && stateCode.includes(keyword));
                });
            });
        }

        initializeCoreVisuals(filteredData);
        initializePrimeProfilesSection(filteredData);
        initializeContractExpirationCalendarSection(filteredData);
        updateActiveFilterIndicator(displaySearchTerm, filteredData.length);
        unifiedSearchSuggestions.innerHTML = ''; 
        unifiedSearchSuggestions.classList.add('hidden');
        hideGlobalLoader(); 
    }, 10); 
}


function clearAllFilters() {
    showGlobalLoader();
    setTimeout(() => {
        unifiedSearchInput.value = '';
        activeFilterIndicator.classList.add('hidden');
        unifiedSearchSuggestions.innerHTML = '';
        unifiedSearchSuggestions.classList.add('hidden');
        initializeCoreVisuals(parsedData); 
        initializePrimeProfilesSection(parsedData); 
        initializeContractExpirationCalendarSection(parsedData); 
        hideGlobalLoader();
    }, 10);
}

function updateActiveFilterIndicator(searchTerm, count) {
    if (searchTerm && searchTerm.trim() !== '') {
        activeFilterIndicator.innerHTML = `<span>Filtered by: <strong>"${searchTerm}"</strong> (${count.toLocaleString()} results)</span> 
                                         <button class="clear-filter-btn-tailwind bg-red-500 text-white px-3 py-1 rounded-md text-sm hover:bg-red-600 focus:ring-2 focus:ring-offset-2 focus:ring-red-400 focus:outline-none" onclick="clearAllFilters()">Clear All Filters</button>`;
        activeFilterIndicator.classList.remove('hidden');
    } else {
        activeFilterIndicator.classList.add('hidden');
    }
}

function selectSearchSuggestion(term, type, originalValue) { 
    unifiedSearchInput.value = originalValue; 
    applyFilter(originalValue, type, originalValue); 
    unifiedSearchSuggestions.innerHTML = '';
    unifiedSearchSuggestions.classList.add('hidden');
}

function setupUnifiedSearch() {
    unifiedSearchInput.addEventListener('input', _.debounce(function() {
        const searchTerm = this.value.toLowerCase().trim();
        unifiedSearchSuggestions.innerHTML = ''; 

        if (searchTerm.length < 2) {
            unifiedSearchSuggestions.classList.add('hidden');
            return;
        }

        const suggestions = new Map(); 
        const maxSuggestions = 15;

        parsedData.forEach(record => {
            if (suggestions.size >= maxSuggestions) return;

            const checkAndAdd = (value, type, displayValue = null) => {
                if (suggestions.size >= maxSuggestions) return;
                const originalVal = value; 
                const valStr = String(value || '').toLowerCase();
                if (valStr.includes(searchTerm)) {
                    const key = `${type}-${originalVal}`; 
                    if (!suggestions.has(key)) {
                        let highlightedTerm = displayValue || originalVal;
                        if (typeof highlightedTerm === 'string') {
                             const index = valStr.indexOf(searchTerm);
                             if (index !== -1) {
                                 highlightedTerm = highlightedTerm.substring(0, index) +
                                                  `<strong>${highlightedTerm.substring(index, index + searchTerm.length)}</strong>` +
                                                  highlightedTerm.substring(index + searchTerm.length);
                             }
                        }
                        suggestions.set(key, { termForDisplayHTML: highlightedTerm, type: type, originalValue: originalVal });
                    }
                }
            };
            
            checkAndAdd(record['Legal Business Name'], 'primeName');
            checkAndAdd(String(record['NAICS Code'] || ''), 'naicsCode');
            
            const descWords = (record['NAICS Description'] || '').split(/\s+/); 
            descWords.forEach(word => {
                if (word.toLowerCase().includes(searchTerm) && word.length > 2) { 
                     checkAndAdd(word, 'naicsDesc', word); 
                }
            });
            checkAndAdd(record['Contracting Department Name'], 'departmentName');
            checkAndAdd(record['Contracting Agency Name'], 'agencyName');
            checkAndAdd(record['Contracting Office Name'], 'officeName');
            checkAndAdd(record['Principal Place of Performance State Code'], 'stateCode');
        });

        if (suggestions.size > 0) {
            unifiedSearchSuggestions.classList.remove('hidden');
            Array.from(suggestions.values()).forEach(sugg => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.innerHTML = (typeof sugg.termForDisplayHTML === 'string' && sugg.termForDisplayHTML.length > 60 ? sugg.termForDisplayHTML.substring(0, 57) + '...' : sugg.termForDisplayHTML);
                
                const typeLabel = document.createElement('span');
                typeLabel.className = 'type-label';
                let displayType = sugg.type;
                if (sugg.type === 'primeName') displayType = 'Prime';
                else if (sugg.type === 'naicsCode') displayType = 'NAICS';
                else if (sugg.type === 'naicsDesc') displayType = 'NAICS Keyword';
                else if (sugg.type === 'departmentName') displayType = 'Dept.';
                else if (sugg.type === 'agencyName') displayType = 'Agency';
                else if (sugg.type === 'officeName') displayType = 'Office';
                else if (sugg.type === 'stateCode') displayType = 'State';
                typeLabel.textContent = displayType;
                item.appendChild(typeLabel);

                item.onclick = () => selectSearchSuggestion(sugg.termForDisplayHTML, sugg.type, sugg.originalValue); 
                unifiedSearchSuggestions.appendChild(item);
            });
        } else {
            unifiedSearchSuggestions.classList.remove('hidden'); 
            unifiedSearchSuggestions.innerHTML = `<div class="p-2 text-sm text-gray-500">No specific suggestions. Press Enter to search all fields.</div>`;
        }
    }, 300));

    unifiedSearchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            applyFilter(this.value.trim()); 
            unifiedSearchSuggestions.innerHTML = '';
            unifiedSearchSuggestions.classList.add('hidden');
        }
    });

    document.addEventListener('click', function(event) {
        if (!unifiedSearchInput.contains(event.target) && !unifiedSearchSuggestions.contains(event.target)) {
            unifiedSearchSuggestions.classList.add('hidden');
        }
    });
}


// --- Initialize Core Visualizations ---
function initializeCoreVisuals(data) { 
    updateStatistics(data);
    createPrimeContractorsChart(data);
    createDepartmentChart(data); 
    createNaicsChart_main(data);
    createContractTypeChart_main(data);
    createStateContractsChart_main(data, currentMainStateChartFilter);
    createTopAgenciesChart(data); 
    createTimelineChart(data); 
    createMarketShareChart(data); 
}

// --- Statistics Update ---
function updateStatistics(data) { 
    if (!data || data.length === 0) {
        ['totalContractsValue', 'totalValueValue', 'avgContractValue', 'uniquePrimesValue'].forEach(id => document.getElementById(id).textContent = '0');
        return;
    }
    document.getElementById('totalContractsValue').textContent = data.length.toLocaleString();
    let totalValue = 0, contractsWithValue = 0;
    data.forEach(r => { const v = parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']); if (v>0) {totalValue+=v; contractsWithValue++;}});
    document.getElementById('totalValueValue').textContent = formatCurrency(totalValue);
    document.getElementById('avgContractValue').textContent = formatCurrency(contractsWithValue > 0 ? totalValue / contractsWithValue : 0);
    document.getElementById('uniquePrimesValue').textContent = new Set(data.map(r => r['Legal Business Name']).filter(Boolean)).size.toLocaleString();
}

// --- Chart Creation Functions ---
function createChart(canvasId, type, data, options, noDataMessage = "No data available for current selection.") { 
    const chartContainer = document.getElementById(canvasId).parentElement; 
    
    let isEmpty = true;
    if (data && data.datasets && data.datasets.length > 0) {
        isEmpty = data.datasets.every(ds => !ds.data || ds.data.length === 0 || ds.data.every(val => val === 0 || val === null));
    } else if (type === 'pie' || type === 'doughnut') { 
        if (data && data.datasets && data.datasets[0] && data.datasets[0].data) {
           isEmpty = data.datasets[0].data.every(val => val === 0);
        }
    }

    if (isEmpty) {
        chartContainer.innerHTML = `<div class="chart-no-data">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
                                        </svg>
                                        <span>${noDataMessage}</span>
                                    </div>`;
        if (charts[canvasId]) {
            charts[canvasId].destroy();
            charts[canvasId] = null;
        }
        return;
    } else {
        if (chartContainer.querySelector('.chart-no-data')) {
            chartContainer.innerHTML = `<canvas id="${canvasId}"></canvas>`;
        }
    }
    
    const ctx = document.getElementById(canvasId).getContext('2d');
    if (charts[canvasId]) charts[canvasId].destroy();
    charts[canvasId] = new Chart(ctx, { type, data, options });
}

function createPrimeContractorsChart(data) { 
    const primeValues = {};
    data.forEach(r => { if (r['Legal Business Name']) primeValues[r['Legal Business Name']] = (primeValues[r['Legal Business Name']] || 0) + parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']); });
    const sorted = Object.entries(primeValues).sort((a,b)=>b[1]-a[1]).slice(0,10);
    const chartData = { labels: sorted.map(i=>i[0]), datasets: [{ label: 'Contract Value', data: sorted.map(i=>i[1]), backgroundColor: 'rgba(54, 162, 235, 0.7)' }] };
    const chartOptions = { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false}, tooltip:{callbacks:{label:c=>formatCurrency(c.raw)}}}, scales: {x:{ticks:{callback:v=>formatCurrency(v)}}, y:{ticks:{autoSkip:false, callback:function(v){const l=this.getLabelForValue(v); return l.length>18?l.substring(0,15)+'...':l;}}}},
        onClick: (event, elements) => {
            if (elements.length > 0) {
                const primeName = chartData.labels[elements[0].index];
                unifiedSearchInput.value = primeName; 
                applyFilter(primeName, 'primeName', primeName); 
            }
        }
    };
    createChart('primeContractorsChart', 'bar', chartData, chartOptions);
}

function createDepartmentChart(data) { 
    const deptValues = {};
    data.forEach(r => { if (r['Contracting Department Name']) deptValues[r['Contracting Department Name']] = (deptValues[r['Contracting Department Name']] || 0) + parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']); });
    const sorted = Object.entries(deptValues).sort((a,b)=>b[1]-a[1]).slice(0,10);
    
    const chartData = { 
        labels: sorted.map(i=>i[0]), 
        datasets: [{ data: sorted.map(i=>i[1]), backgroundColor: ['#3B82F6','#EF4444','#F59E0B','#10B981','#8B5CF6','#EC4899','#6366F1','#FBBF24','#22C55E','#D946EF'] }] 
    };
    const chartOptions = { 
        responsive: true, maintainAspectRatio: false, 
        plugins: { 
            legend: {position:'right', labels:{boxWidth:12,font:{size:10}}}, 
            tooltip:{callbacks:{label:c=>`${c.label||''}: ${formatCurrency(c.raw)}`}}
        },
        onClick: (event, elements) => {
            if (elements.length > 0) {
                const departmentName = chartData.labels[elements[0].index];
                unifiedSearchInput.value = departmentName; 
                applyFilter(departmentName, 'departmentName', departmentName); 
            }
        }
    };
    createChart('departmentChart', 'pie', chartData, chartOptions);
}

function createNaicsChart_main(data) { 
    const naicsValues = {}, naicsDesc = {};
    data.forEach(r => {
        if (r['NAICS Code']) {
            const naicsKey = String(r['NAICS Code']);
            naicsValues[naicsKey] = (naicsValues[naicsKey] || 0) + parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
            if (!naicsDesc[naicsKey]) naicsDesc[naicsKey] = r['NAICS Description'] || '';
        }
    });
    const sorted = Object.entries(naicsValues).sort((a,b)=>b[1]-a[1]).slice(0,10);
    const chartData = { labels: sorted.map(i=>i[0]), displayLabels: sorted.map(i=>`${i[0]} - ${naicsDesc[i[0]] ? naicsDesc[i[0]].substring(0,20) : ''}...`), datasets: [{ label: 'Contract Value', data: sorted.map(i=>i[1]), backgroundColor: 'rgba(22, 163, 74, 0.7)' }] };
    const chartOptions = { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false}, tooltip:{callbacks:{label:c=>formatCurrency(c.raw)}}}, scales: {x:{ticks:{callback:v=>formatCurrency(v)}}},
        onClick: (event, elements) => {
            if (elements.length > 0) {
                const naicsCode = chartData.labels[elements[0].index]; // Use the actual code for filtering
                unifiedSearchInput.value = naicsCode; 
                applyFilter(naicsCode, 'naicsCode', naicsCode); 
            }
        }
    };
    // Use displayLabels for rendering the chart labels
    chartOptions.data = { labels: chartData.displayLabels, datasets: chartData.datasets};
    createChart('naicsChart_main', 'bar', chartOptions.data , chartOptions);
}

function createContractTypeChart_main(data) { 
    const contractTypes = {};
    data.forEach(r => { if (r['Award or Indefinite Delivery Vehicle Type']) contractTypes[r['Award or Indefinite Delivery Vehicle Type']] = (contractTypes[r['Award or Indefinite Delivery Vehicle Type']] || 0) + 1; });
    const chartData = { labels: Object.keys(contractTypes), datasets: [{ data: Object.values(contractTypes), backgroundColor: ['#3B82F6','#EF4444','#F59E0B','#10B981','#8B5CF6', '#F472B6', '#6B7280', '#06B6D4', '#F97316', '#84CC16'] }] };
    const chartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: {position:'right', labels:{boxWidth:12,font:{size:10}}}, tooltip:{callbacks:{label:c=>`${c.label||''}: ${c.raw.toLocaleString()}`}}},
        onClick: (event, elements) => {
            if (elements.length > 0) {
                const contractType = chartData.labels[elements[0].index];
                unifiedSearchInput.value = contractType; 
                applyFilter(contractType, 'contractType', contractType); 
            }
        }
    };
    createChart('contractTypeChart_main', 'doughnut', chartData, chartOptions);
}

function createStateContractsChart_main(data, filterType = 'count') { 
    const stateData = {}; 
    data.forEach(r => {
        const state = r['Principal Place of Performance State Code'];
        if (state) {
            if (!stateData[state]) stateData[state] = { count: 0, value: 0 };
            stateData[state].count++;
            stateData[state].value += parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
        }
    });
    const sorted = Object.entries(stateData).sort((a,b) => b[1][filterType] - a[1][filterType]).slice(0,10);
    const chartData = { labels: sorted.map(i=>i[0]), datasets: [{ label: filterType === 'count' ? 'Number of Contracts' : 'Total Contract Value', data: sorted.map(i=>i[1][filterType]), backgroundColor: 'rgba(139, 92, 246, 0.7)' }] };
    const chartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false}, tooltip:{callbacks:{label:c=> filterType === 'count' ? c.raw.toLocaleString() : formatCurrency(c.raw)}}}, scales: {y:{ticks:{callback:v=> filterType==='count'?v.toLocaleString():formatCurrency(v)}}},
        onClick: (event, elements) => {
            if (elements.length > 0) {
                const stateCode = chartData.labels[elements[0].index];
                unifiedSearchInput.value = stateCode; 
                applyFilter(stateCode, 'stateCode', stateCode); 
            }
        }
    };
    createChart('stateContractsChart_main', 'bar', chartData, chartOptions);
}

function createTopAgenciesChart(data) {
    const agencyValues = {};
    data.forEach(r => {
        const agency = r['Contracting Agency Name']; 
        if (agency) {
            agencyValues[agency] = (agencyValues[agency] || 0) + parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
        }
    });
    const sortedAgencies = Object.entries(agencyValues).sort((a, b) => b[1] - a[1]).slice(0, 10);
    const chartData = { labels: sortedAgencies.map(item => item[0]), datasets: [{ label: 'Contract Value', data: sortedAgencies.map(item => item[1]), backgroundColor: 'rgba(234, 88, 12, 0.7)' }] };
    const chartOptions = { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => formatCurrency(ctx.raw) } } }, scales: { x: { ticks: { callback: val => formatCurrency(val) } }, y: { ticks: { autoSkip: false, callback: function(val) { const label = this.getLabelForValue(val); return label.length > 20 ? label.substring(0, 17) + '...' : label; } } } },
        onClick: (event, elements) => {
            if (elements.length > 0) {
                const agencyName = chartData.labels[elements[0].index];
                unifiedSearchInput.value = agencyName; 
                applyFilter(agencyName, 'agencyName', agencyName); 
            }
        }
    };
    createChart('topAgenciesChart', 'bar', chartData, chartOptions);
}

function createTimelineChart(data) {
    const startYears = {}; 
    const endYears = {};
    data.forEach(record => {
        if (record['Period of Performance Start Date']) { 
            const d = new Date(record['Period of Performance Start Date']); 
            if (!isNaN(d.getTime())) { 
                const y = d.getFullYear(); 
                if (y > 2000 && y < 2030) startYears[y] = (startYears[y] || 0) + 1; 
            }
        }
        if (record['Completion Date']) { 
            const d = new Date(record['Completion Date']); 
            if (!isNaN(d.getTime())) { 
                const y = d.getFullYear(); 
                if (y > 2000 && y < 2030) endYears[y] = (endYears[y] || 0) + 1; 
            }
        }
    });
    const allYears = new Set([...Object.keys(startYears), ...Object.keys(endYears)].map(Number));
    const sortedYears = Array.from(allYears).sort((a,b) => a-b);
    
    const labels = [], startCounts = [], endCounts = [];
    sortedYears.forEach(year => { 
        labels.push(year.toString()); 
        startCounts.push(startYears[year] || 0); 
        endCounts.push(endYears[year] || 0); 
    });

    createChart('timelineChart', 'line', 
        { 
            labels, 
            datasets: [ 
                { label: 'Contracts Starting', data: startCounts, borderColor: 'rgba(54, 162, 235, 1)', backgroundColor: 'rgba(54, 162, 235, 0.2)', fill: true, tension: 0.4 }, 
                { label: 'Contracts Ending', data: endCounts, borderColor: 'rgba(255, 99, 132, 1)', backgroundColor: 'rgba(255, 99, 132, 0.2)', fill: true, tension: 0.4 }  
            ] 
        },
        { 
            responsive: true, maintainAspectRatio: false, 
            plugins: { 
                legend: { display: true, position: 'top'},
                tooltip: { callbacks: { label: ctx => `${ctx.dataset.label || ''}: ${ctx.parsed.y.toLocaleString()}` } } 
            }, 
            scales: { y: { beginAtZero: true, ticks: { callback: val => val.toLocaleString() } } } 
        }
    );
}


function createMarketShareChart(data) {
    const primeValues = {};
    data.forEach(r => {
        if (r['Legal Business Name']) {
            primeValues[r['Legal Business Name']] = (primeValues[r['Legal Business Name']] || 0) + parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
        }
    });
    const sortedPrimes = Object.entries(primeValues).sort((a, b) => b[1] - a[1]);
    const top5Primes = sortedPrimes.slice(0, 5);
    const otherPrimesValue = sortedPrimes.slice(5).reduce((sum, item) => sum + item[1], 0);
    
    const chartLabels = top5Primes.map(item => item[0]);
    const chartValues = top5Primes.map(item => item[1]);
    if (otherPrimesValue > 0 && sortedPrimes.length > 5) { 
        chartLabels.push('Others');
        chartValues.push(otherPrimesValue);
    }

    createChart('marketShareChart', 'pie',
        { labels: chartLabels, datasets: [{ data: chartValues, backgroundColor: ['#8B5CF6', '#EC4899', '#FBBF24', '#22C55E', '#6366F1', '#A8A29E'] }] }, 
        { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: { size: 10 } } }, tooltip: { callbacks: { label: ctx => `${ctx.label || ''}: ${formatCurrency(ctx.raw)} (${((ctx.raw / chartValues.reduce((a,b)=>a+b,0)) * 100).toFixed(1)}%)` } } } }
    );
}


// --- Prime Profiles Section ---
function initializePrimeProfilesSection(data) { 
    const profiles = {};
    data.forEach(r => {
        const name = r['Legal Business Name']; if (!name) return;
        if (!profiles[name]) profiles[name] = { name: name, contracts: 0, totalValue: 0, naics: new Set(), agencies: new Set(), uei: r['Unique Entity ID'] }; 
        profiles[name].contracts++; profiles[name].totalValue += parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']);
        if(r['NAICS Code']) profiles[name].naics.add(String(r['NAICS Code'])); 
        if(r['Contracting Agency Name']) profiles[name].agencies.add(r['Contracting Agency Name']);
    });
    function renderCards(filterTerm = '') {
        primeProfilesContainer.innerHTML = ''; let count = 0;
        Object.values(profiles)
            .filter(p => filterTerm === '' || p.name.toLowerCase().includes(filterTerm.toLowerCase()))
            .sort((a,b) => b.totalValue - a.totalValue)
            .forEach(p => { 
                count++;
                const card = document.createElement('div');
                card.className = 'p-3 md:p-4 bg-gray-50 rounded-lg border shadow hover:shadow-lg transition-shadow duration-150'; 
                card.innerHTML = `
                    <h4 class="font-semibold text-blue-700 truncate cursor-pointer hover:underline" title="${p.name}" onclick="setUnifiedSearchTerm('${p.name.replace(/'/g, "\\'")}', 'primeName')">${p.name}</h4>
                    <p class="text-xs md:text-sm">Contracts: ${p.contracts.toLocaleString()}</p>
                    <p class="text-xs md:text-sm">Value: ${formatCurrency(p.totalValue)}</p>
                    <p class="text-xs mt-1 truncate" title="Top NAICS: ${Array.from(p.naics).slice(0,3).join(', ')}">Top NAICS: ${Array.from(p.naics).slice(0,3).join(', ')}</p>
                    <p class="text-xs mt-1 truncate" title="Top Agencies: ${Array.from(p.agencies).slice(0,2).join(', ')}">Top Agencies: ${Array.from(p.agencies).slice(0,2).join(', ')}</p>
                    <button class="mt-2 text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600 transition-colors duration-150 ease-in-out focus:ring-2 focus:ring-offset-2 focus:ring-blue-400 focus:outline-none" onclick="setUnifiedSearchTerm('${p.name.replace(/'/g, "\\'")}', 'primeName')">Filter Dashboard by this Prime</button>`; 
                primeProfilesContainer.appendChild(card);
        });
        if(count === 0) primeProfilesContainer.innerHTML = `<p class="p-4 col-span-full text-center text-gray-500">No primes match current filters or profile search.</p>`;
    }
    primeProfilesSearchInput.addEventListener('input', _.debounce(() => renderCards(primeProfilesSearchInput.value), 300));
    renderCards(); 
}

// Removed showDetailedPrimeProfile as it's no longer used with modals for prime details


function setUnifiedSearchTerm(term, type = 'primeName') { 
    unifiedSearchInput.value = term;
    applyFilter(term, type, term); 
}


// --- Contract Expiration Calendar Section --- 
function initializeContractExpirationCalendarSection(data) { 
    const events = [];
    data.forEach(r => {
        if (r['Completion Date']) {
            const date = new Date(r['Completion Date']);
            if (!isNaN(date.getTime())) events.push({
                date: date, 
                prime: r['Legal Business Name'], 
                value: parseCurrencyValue(r['Base and All Options Value (Total Contract Value)']), 
                id: r['Procurement Instrument Identifier'] || 'N/A',
                agency: r['Contracting Agency Name'] || 'N/A'
            });
        }
    });
    events.sort((a,b) => a.date - b.date);
    
    // Populate Year and Month Selectors
    calendarYearSelect.innerHTML = ''; // Clear previous options
    calendarMonthSelect.innerHTML = ''; // Clear previous options
    const currentYear = new Date().getFullYear();
    for (let i = currentYear - 5; i <= currentYear + 5; i++) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        calendarYearSelect.appendChild(option);
    }
    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    monthNames.forEach((month, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = month;
        calendarMonthSelect.appendChild(option);
    });

    currentCalendarDate = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
    calendarYearSelect.value = currentCalendarDate.getFullYear();
    calendarMonthSelect.value = currentCalendarDate.getMonth();


    calendarPrevBtn.onclick = () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth()-1); updateCalendarSelectors(); renderCalView(); };
    calendarNextBtn.onclick = () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth()+1); updateCalendarSelectors(); renderCalView(); };
    calendarMonthSelect.onchange = () => { currentCalendarDate.setMonth(parseInt(calendarMonthSelect.value)); renderCalView(); };
    calendarYearSelect.onchange = () => { currentCalendarDate.setFullYear(parseInt(calendarYearSelect.value)); renderCalView(); };

    function updateCalendarSelectors() {
        calendarYearSelect.value = currentCalendarDate.getFullYear();
        calendarMonthSelect.value = currentCalendarDate.getMonth();
    }


    function renderCalView() {
        const year = currentCalendarDate.getFullYear(), month = currentCalendarDate.getMonth();
        calendarTitleEl.textContent = `${new Intl.DateTimeFormat('en-US',{month:'long'}).format(currentCalendarDate)} ${year}`;
        const firstD = new Date(year,month,1), lastD = new Date(year,month+1,0);
        const daysInM = lastD.getDate(), firstDOW = firstD.getDay();
        let html = ''; const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        dayNames.forEach(d => {html += `<div class="calendar-day-header text-xs sm:text-sm">${d}</div>`;});
        for(let i=0; i<firstDOW; i++) html+='<div class="p-1 sm:p-2 border bg-gray-50 min-h-[60px] sm:min-h-[80px]"></div>';
        for(let day=1; day<=daysInM; day++) {
            const currentDateObj = new Date(year, month, day);
            const dEvents = events.filter(e=>e.date.getFullYear()===year && e.date.getMonth()===month && e.date.getDate()===day);
            // Visual density indicator
            let dayBgClass = 'bg-white';
            if (dEvents.length > 0) dayBgClass = 'bg-blue-50';
            if (dEvents.length > 2) dayBgClass = 'bg-blue-100'; 
            if (dEvents.length > 5) dayBgClass = 'bg-blue-200'; 

            html += `<div class="calendar-day-cell p-1 sm:p-2 border min-h-[60px] sm:min-h-[80px] relative ${dayBgClass}" 
                         ${dEvents.length > 0 ? `onclick="showCalendarDayDetailsModal(new Date(${year},${month},${day}), JSON.parse(this.dataset.eventsJson))" data-events-json='${JSON.stringify(dEvents).replace(/'/g, "&apos;")}'` : ''}
                         role="button" tabindex="0" aria-label="${dEvents.length > 0 ? dEvents.length + ' contracts ending' : 'No contracts ending'} on ${formatDate(currentDateObj)}">
                        <div class="font-semibold text-right text-gray-700 text-xs sm:text-sm">${day}</div>`;
            dEvents.slice(0,2).forEach(e => {html+=`<div class="calendar-event" title="${e.prime} (${formatCurrency(e.value)}) - ID: ${e.id}">${e.prime?e.prime.substring(0,8)+(e.prime.length>8?'...':''):'Contract'}</div>`;});
            if(dEvents.length>2) html+=`<div class="text-xs mt-1">${dEvents.length-2} more</div>`;
            html += `</div>`;
        }
        calendarGridEl.innerHTML = html;
    }
    renderCalView(); // Initial render
}

function showCalendarDayDetailsModal(dateObj, eventsOnDate) {
    const formattedDate = formatDate(dateObj);
    let currentCalendarPage = 1;
    let currentSort = { column: 'prime', order: 'asc' }; 

    function sortEvents(events, column, order) {
        return [...events].sort((a, b) => {
            let valA = a[column];
            let valB = b[column];
            if (column === 'value') {
                valA = parseFloat(valA); 
                valB = parseFloat(valB);
            } else if (typeof valA === 'string') {
                valA = valA.toLowerCase();
                valB = valB.toLowerCase();
            }
            if (valA < valB) return order === 'asc' ? -1 : 1;
            if (valA > valB) return order === 'asc' ? 1 : -1;
            return 0;
        });
    }
    
    let sortedEvents = sortEvents(eventsOnDate, currentSort.column, currentSort.order);


    function renderCalendarDayPage(page, sortedData) {
        const start = (page - 1) * ITEMS_PER_PAGE_MODAL_TABLE;
        const end = start + ITEMS_PER_PAGE_MODAL_TABLE;
        const pageEvents = sortedData.slice(start, end);

        let tableHTML = `<div class="table-responsive"><table class="min-w-full divide-y divide-gray-200 text-xs">
            <thead class="bg-gray-50"><tr> 
                <th class="px-2 py-2 text-left font-medium" data-sort="id">PIID ${currentSort.column === 'id' ? (currentSort.order === 'asc' ? '▲' : '▼') : ''}</th>
                <th class="px-2 py-2 text-left font-medium" data-sort="prime">Prime ${currentSort.column === 'prime' ? (currentSort.order === 'asc' ? '▲' : '▼') : ''}</th>
                <th class="px-2 py-2 text-left font-medium" data-sort="agency">Agency ${currentSort.column === 'agency' ? (currentSort.order === 'asc' ? '▲' : '▼') : ''}</th>
                <th class="px-2 py-2 text-left font-medium" data-sort="value">Value ${currentSort.column === 'value' ? (currentSort.order === 'asc' ? '▲' : '▼') : ''}</th>
            </tr></thead>
            <tbody class="bg-white divide-y divide-gray-200">`;
        pageEvents.forEach(event => {
            tableHTML += `<tr>
                <td class="px-2 py-1 whitespace-nowrap">${createAwardLink(event.id)}</td>
                <td class="px-2 py-1 whitespace-nowrap">${event.prime}</td>
                <td class="px-2 py-1 whitespace-nowrap">${event.agency}</td>
                <td class="px-2 py-1 whitespace-nowrap">${formatCurrency(event.value)}</td>
            </tr>`;
        });
        tableHTML += `</tbody></table></div>`;
        
        const totalPages = Math.ceil(sortedData.length / ITEMS_PER_PAGE_MODAL_TABLE);
        if (totalPages > 1) { 
            tableHTML += `<div class="mt-3 flex justify-between items-center text-xs">
                <button id="prevPageBtnCal" class="px-2 py-1 border rounded ${page === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100 transition-colors'}" ${page === 1 ? 'disabled' : ''}>Previous</button>
                <span>Page ${page} of ${totalPages}</span>
                <button id="nextPageBtnCal" class="px-2 py-1 border rounded ${page === totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100 transition-colors'}" ${page === totalPages ? 'disabled' : ''}>Next</button>
            </div>`;
        }
        
        const tableContainer = document.getElementById('calendarDayTableContainer');
        if (tableContainer) {
            tableContainer.innerHTML = tableHTML;
        } else { 
            genericModalBody.innerHTML = `
                <p class="mb-3 text-sm text-gray-600">Total Contracts Ending: ${sortedData.length}</p>
                <div id="calendarDayTableContainer">${tableHTML}</div>`;
        }

        document.querySelectorAll('#calendarDayTableContainer th[data-sort]').forEach(th => {
            th.onclick = () => { // Changed from addEventListener to direct onclick to simplify re-binding
                const sortColumn = th.dataset.sort;
                if (currentSort.column === sortColumn) {
                    currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.column = sortColumn;
                    currentSort.order = 'asc';
                }
                currentCalendarPage = 1; 
                sortedEvents = sortEvents(eventsOnDate, currentSort.column, currentSort.order); // Re-sort original eventsOnDate
                renderCalendarDayPage(currentCalendarPage, sortedEvents);
            };
        });


        if (document.getElementById('prevPageBtnCal')) {
            document.getElementById('prevPageBtnCal').onclick = () => {
                if (currentCalendarPage > 1) { currentCalendarPage--; renderCalendarDayPage(currentCalendarPage, sortedEvents); }
            };
        }
        if (document.getElementById('nextPageBtnCal')) {
            document.getElementById('nextPageBtnCal').onclick = () => {
                if (currentCalendarPage < totalPages) { currentCalendarPage++; renderCalendarDayPage(currentCalendarPage, sortedEvents); }
            };
        }
    }
    
    const initialModalHTML = `
        <p class="mb-3 text-sm text-gray-600">Total Contracts Ending: ${eventsOnDate.length}</p>
        <div id="calendarDayTableContainer">
            </div>`;

    openModal(`Contract Expirations for ${formattedDate}`, initialModalHTML, 'modal-content-lg'); 
    renderCalendarDayPage(currentCalendarPage, sortedEvents); 
}


// --- Event Listeners for Chart Filters ---
document.getElementById('stateChartFilters_main').addEventListener('click', function(e) { 
    if (e.target.classList.contains('filter-btn')) {
        const filterType = e.target.dataset.filter;
        currentMainStateChartFilter = filterType;
        this.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');
        applyFilter(unifiedSearchInput.value.trim()); 
    }
});

// --- File Input Handling ---
csvFileInput.addEventListener('change', function(e) { 
    const file = e.target.files[0]; if (!file) { fileNameDisplay.textContent = 'No file'; return; }
    fileNameDisplay.textContent = file.name; showProcessingBriefly();
    Papa.parse(file, {
        header: true, dynamicTyping: true, skipEmptyLines: true,
        complete: results => {
            if (results.errors && results.errors.length > 0) { showErrorMessage('CSV Error: ' + results.errors[0].message); return; }
            if (results.data && results.data.length > 0) {
                showSuccessMessage('File processed!', false); processAndInitialize(results.data);
                s3LoadErrorDiv.classList.add('hidden'); 
            } else showErrorMessage('No data in file.');
        },
        error: error => showErrorMessage('CSV Parse Fail: ' + error.message)
    });
});

// --- Page Load ---
document.addEventListener('DOMContentLoaded', () => loadDataFromS3());

</script>
</body>
</html>
