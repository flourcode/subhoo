<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure ISV Opportunity Interceptor</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            color: #333;
            line-height: 1.6;
        }
        
        /* Header */
        .header {
            background: #0078D4;
            color: white;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .header-stats {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        /* Main Layout */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        /* Filters Bar */
        .filters-bar {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .filters-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .filter-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
            color: #666;
        }
        
        .filter-group input,
        .filter-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #0078D4;
            box-shadow: 0 0 0 2px rgba(0,120,212,0.2);
        }
        
        .filter-chips {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }
        
        .chip {
            background: #e1e1e1;
            padding: 0.25rem 0.75rem;
            border-radius: 16px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .chip:hover {
            background: #d1d1d1;
        }
        
        .chip.active {
            background: #0078D4;
            color: white;
        }
        
        /* Opportunity Cards */
        .opportunities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .opportunity-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .opportunity-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .opportunity-score {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: #fff;
            border: 2px solid #0078D4;
            color: #0078D4;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .opportunity-score.high {
            background: #0078D4;
            color: white;
        }
        
        .opportunity-score.critical {
            background: #D83B01;
            border-color: #D83B01;
            color: white;
        }
        
        .opportunity-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            padding-right: 60px;
        }
        
        .opportunity-agency {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        
        .opportunity-tags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        .tag {
            background: #f0f2f5;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .tag.aws {
            background: #FF9900;
            color: white;
        }
        
        .tag.azure {
            background: #0078D4;
            color: white;
        }
        
        .tag.urgent {
            background: #D83B01;
            color: white;
        }
        
        .opportunity-description {
            font-size: 0.9rem;
            color: #555;
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .opportunity-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: #666;
            padding-top: 1rem;
            border-top: 1px solid #f0f2f5;
        }
        
        .opportunity-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: #0078D4;
            color: white;
        }
        
        .btn-primary:hover {
            background: #106EBE;
        }
        
        .btn-secondary {
            background: #f0f2f5;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #e1e1e1;
        }
        
        /* Loading State */
        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
        }
        
        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f0f2f5;
            border-top: 4px solid #0078D4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Stats Dashboard */
        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .stat-card h3 {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
        }
        
        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: #0078D4;
        }
        
        .stat-card .change {
            font-size: 0.85rem;
            color: #107C10;
            margin-top: 0.25rem;
        }
        
        .stat-card .change.negative {
            color: #D83B01;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 8px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-close {
            font-size: 2rem;
            cursor: pointer;
            color: #666;
            background: none;
            border: none;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .opportunities-grid {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .filter-group {
                min-width: 100%;
            }
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: #107C10;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(400px);
            transition: transform 0.3s;
            z-index: 1001;
        }
        
        .toast.show {
            transform: translateX(0);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div>
                <h1>Azure ISV Opportunity Interceptor</h1>
                <p style="opacity: 0.9; font-size: 0.9rem;">Real-time federal opportunity intelligence</p>
            </div>
            <div class="header-stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalOpps">0</div>
                    <div>Active Opportunities</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="awsAtRisk">0</div>
                    <div>AWS at Risk</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="weeklyGrowth">0%</div>
                    <div>Weekly Growth</div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Quick Stats Dashboard -->
        <div class="stats-dashboard">
            <div class="stat-card">
                <h3>High-Priority Opportunities</h3>
                <div class="value" id="highPriorityCount">0</div>
                <div class="change">↑ 12% from last week</div>
            </div>
            <div class="stat-card">
                <h3>Agencies with Activity</h3>
                <div class="value" id="activeAgencies">0</div>
                <div class="change">New: DoD, VA, DHS</div>
            </div>
            <div class="stat-card">
                <h3>ISV Mentions</h3>
                <div class="value" id="isvMentions">0</div>
                <div class="change">Palantir: 8, C3.ai: 5</div>
            </div>
            <div class="stat-card">
                <h3>Est. Pipeline Value</h3>
                <div class="value" id="pipelineValue">$0M</div>
                <div class="change">↑ $2.5M potential</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters-bar">
            <div class="filters-row">
                <div class="filter-group">
                    <label>Search Keywords</label>
                    <input type="text" id="searchInput" placeholder="e.g., AI, cloud migration, Palantir">
                </div>
                <div class="filter-group">
                    <label>Agency</label>
                    <select id="agencyFilter">
                        <option value="">All Agencies</option>
                        <option value="dod">Department of Defense</option>
                        <option value="va">Veterans Affairs</option>
                        <option value="dhs">Homeland Security</option>
                        <option value="hhs">Health & Human Services</option>
                        <option value="treasury">Treasury</option>
                        <option value="energy">Energy</option>
                        <option value="justice">Justice</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Opportunity Score</label>
                    <select id="scoreFilter">
                        <option value="">All Scores</option>
                        <option value="90">90+ (Critical)</option>
                        <option value="80">80+ (High)</option>
                        <option value="70">70+ (Medium)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>ISV Focus</label>
                    <select id="isvFilter">
                        <option value="">All ISVs</option>
                        <option value="palantir">Palantir</option>
                        <option value="c3ai">C3.ai</option>
                        <option value="databricks">Databricks</option>
                        <option value="snowflake">Snowflake</option>
                        <option value="splunk">Splunk</option>
                    </select>
                </div>
                <div class="filter-group" style="display: flex; align-items: flex-end;">
                    <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                    <button class="btn btn-secondary" onclick="resetFilters()" style="margin-left: 0.5rem;">Reset</button>
                </div>
            </div>
            <div class="filter-chips">
                <span class="chip active" onclick="toggleChip(this, 'aws-risk')">AWS at Risk</span>
                <span class="chip" onclick="toggleChip(this, 'urgent')">Urgent</span>
                <span class="chip" onclick="toggleChip(this, 'ai-ml')">AI/ML</span>
                <span class="chip" onclick="toggleChip(this, 'data-analytics')">Data Analytics</span>
                <span class="chip" onclick="toggleChip(this, 'cloud-migration')">Cloud Migration</span>
                <span class="chip" onclick="toggleChip(this, 'fedramp')">FedRAMP Required</span>
            </div>
        </div>

        <!-- Opportunities Grid -->
        <div id="opportunitiesGrid" class="opportunities-grid">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading live opportunities...</p>
            </div>
        </div>
    </div>

    <!-- Opportunity Detail Modal -->
    <div id="opportunityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Opportunity Details</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        // Configuration
        const CONFIG = {
            refreshInterval: 300000, // 5 minutes
            corsProxies: [
                'https://api.allorigins.win/get?url=',
                'https://corsproxy.io/?',
                'https://api.codetabs.com/v1/proxy?quest='
            ],
            keywords: {
                critical: ['palantir', 'c3.ai', 'c3 ai', 'aws', 'amazon web services', 'databricks', 'snowflake'],
                high: ['artificial intelligence', 'machine learning', 'ai/ml', 'cloud migration', 'data analytics', 'predictive analytics'],
                azure: ['azure', 'microsoft', 'power platform', 'dynamics', 'teams'],
                urgent: ['urgent', 'immediate', 'expedited', 'pilot', 'proof of concept', 'poc', 'prototype']
            },
            agencies: {
                'dod': ['defense', 'dod', 'pentagon', 'military', 'army', 'navy', 'air force', 'space force'],
                'va': ['veterans', 'va', 'vha', 'vba'],
                'dhs': ['homeland', 'dhs', 'cbp', 'ice', 'uscis', 'tsa', 'fema'],
                'hhs': ['health', 'hhs', 'cdc', 'fda', 'nih', 'cms'],
                'treasury': ['treasury', 'irs', 'financial'],
                'energy': ['energy', 'doe', 'nuclear'],
                'justice': ['justice', 'doj', 'fbi', 'dea', 'atf']
            }
        };

        // Global state
        let opportunities = [];
        let filters = {
            search: '',
            agency: '',
            score: 0,
            isv: '',
            tags: ['aws-risk']
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadOpportunities();
            setInterval(loadOpportunities, CONFIG.refreshInterval);
            
            // Set up event listeners
            document.getElementById('searchInput').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') applyFilters();
            });
        });

        // Enhanced CORS fetching with better error handling
        async function fetchWithCORS(url) {
            for (const proxy of CONFIG.corsProxies) {
                try {
                    const proxyUrl = proxy + encodeURIComponent(url);
                    const response = await fetch(proxyUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json, application/xml, text/xml, text/html, */*'
                        }
                    });
                    
                    if (response.ok) {
                        const contentType = response.headers.get('content-type');
                        let data;
                        
                        if (proxy.includes('allorigins')) {
                            // AllOrigins returns JSON with contents
                            const json = await response.json();
                            data = json.contents;
                        } else {
                            data = await response.text();
                        }
                        
                        return data;
                    }
                } catch (error) {
                    console.warn(`Proxy ${proxy} failed:`, error.message);
                }
            }
            throw new Error('All CORS proxies failed');
        }

async function fetchSBAContracts() {
        const s3CsvUrl = 'https://subhoodata.s3.us-east-1.amazonaws.com/data/sba24.csv';
        const sbaContracts = [];
        console.log('Attempting to fetch SBA contracts from S3...');

        try {
            let csvText;
            try {
                const response = await fetch(s3CsvUrl);
                if (!response.ok) {
                    throw new Error(`S3 Load Error for ${s3CsvUrl}: HTTP error ${response.status}`);
                }
                csvText = await response.text();
            } catch (fetchError) {
                console.warn(`Direct fetch for ${s3CsvUrl} failed, trying with CORS proxy. Error: ${fetchError.message}`);
                // Assuming fetchWithCORS is defined elsewhere in your script and handles proxies
                // If fetchWithCORS also fails, this will throw, caught by the outer catch.
                csvText = await fetchWithCORS(s3CsvUrl);
            }

            if (!csvText || csvText.trim() === '') {
                console.warn('SBA CSV file from S3 is empty or could not be fetched.');
                return sbaContracts;
            }

            const parseResult = Papa.parse(csvText, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true
            });

            if (parseResult.errors && parseResult.errors.length > 0) {
                console.error('Error parsing CSV from S3:', parseResult.errors);
                // Provide more specific error feedback to the user if possible
                showToast('CSV parsing error. Check console.', 3000);
                return sbaContracts;
            }

            if (parseResult.data && parseResult.data.length > 0) {
                parseResult.data.forEach((row, index) => {
                    const parseCurrency = (valueStr) => {
                        if (valueStr === null || typeof valueStr === 'undefined') return 0;
                        return parseFloat(String(valueStr).replace(/[$,\s]/g, '')) || 0;
                    };

                    // --- FIX for piid.startsWith error ---
                    // Ensure piid is treated as a string.
                    let piidFromRow = row['Procurement Instrument Identifier'];
                    const piid = piidFromRow !== null && typeof piidFromRow !== 'undefined' ? String(piidFromRow) : `sba-csv-${Date.now()}-${index}`;
                    // --- End of FIX ---

                    const agencyName = row['Contracting Agency Name'] || row['Contracting Department Name'] || 'Federal Agency';
                    const contractorName = row['Legal Business Name'] || 'N/A';
                    const naicsDesc = row['NAICS Description'] || 'Federal Contract';
                    const contractValueStr = row['Base and All Options Value (Total Contract Value)'] || row['Total Contract Value'];
                    const contractValue = parseCurrency(contractValueStr);
                    const title = `${naicsDesc} for ${agencyName} (CSV)`; // Added (CSV) for clarity

                    const description = `Contract opportunity for ${contractorName} with ${agencyName}. NAICS: ${row['NAICS Code'] || 'N/A'}. Value: ${contractValue ? '$' + contractValue.toLocaleString() : 'N/A'}. PIID: ${piid}.`;

                    let oppDate;
                    const startDateVal = row['Period of Performance Start Date'];
                    const completionDateVal = row['Completion Date'];
                    if (startDateVal && !isNaN(new Date(startDateVal).getTime())) {
                        oppDate = new Date(startDateVal);
                    } else if (completionDateVal && !isNaN(new Date(completionDateVal).getTime())) {
                        oppDate = new Date(completionDateVal);
                    } else {
                        oppDate = new Date();
                    }

                    // Check if piid is the generated fallback before attempting trim()
                    const fpdsLink = piid.startsWith('sba-csv-') ? '#' : `https://www.fpds.gov/ezsearch/fpdsportal?indexName=awardfull&templateName=1.5.3&s=FPDS&q=${encodeURIComponent(piid.trim())}`;

                    const sbaOpp = {
                        id: `sba-csv-${piid.replace(/\s+/g, '-')}-${index}`, // Sanitize piid for ID
                        title: title,
                        link: fpdsLink,
                        description: description.substring(0, 400) + (description.length > 400 ? '...' : ''),
                        date: oppDate,
                        source: 'sba24.csv (S3)',
                        type: 'contract-csv',
                        agency: agencyName,
                        value: contractValue ? `${Math.round(contractValue / 1000000)}M` : null,
                        rawRowData: row
                    };

                    if (containsKeywords(sbaOpp.title + ' ' + sbaOpp.description)) {
                        sbaContracts.push(sbaOpp);
                    }
                });
                console.log(`Successfully parsed and filtered ${sbaContracts.length} relevant SBA contracts from S3.`);
            } else {
                console.warn('No data rows parsed from SBA CSV file.');
            }

        } catch (error) { // Outer catch for the entire function
            console.error('Error in fetchSBAContracts:', error);
            showToast('Failed to load SBA contracts. Check console.', 3000);
        }
        return sbaContracts;
    }

// Modified loadOpportunities function to FOCUS ON CSV
    async function loadOpportunities() {
        showToast('Loading opportunities (CSV Only)...', 2000);
        // Clear the grid and show loading spinner
        const grid = document.getElementById('opportunitiesGrid');
        grid.innerHTML = `<div class="loading"><div class="spinner"></div><p>Loading opportunities from CSV...</p></div>`;
        opportunities = []; // Reset opportunities at the start

        try {
            const sbaCsvData = await fetchSBAContracts(); // This should now return deduplicated data

            console.log(`Data received from fetchSBAContracts: ${sbaCsvData ? sbaCsvData.length : 'undefined/null'} items`);

            if (!Array.isArray(sbaCsvData)) {
                console.error("fetchSBAContracts did not return an array. Received:", sbaCsvData);
                // opportunities array is already reset
            } else {
                // Ensure processOpportunities can handle an empty array gracefully
                opportunities = processOpportunities(sbaCsvData);
            }
            
            console.log(`Opportunities after processOpportunities (deduplication and keyword filtering): ${opportunities.length} items`);
            
            updateStats(); // Update header stats like "Total Opps"
            renderOpportunities(); // This will render cards based on the final 'opportunities' list
            
            // The toast should reflect the final count after all processing
            if (opportunities.length > 0) {
                showToast(`Loaded ${opportunities.length} unique opportunities from CSV.`, 3000);
            } else {
                showToast('No relevant opportunities found or loaded from CSV after processing.', 3000);
            }

        } catch (error) {
            console.error('Error in loadOpportunities (CSV focused):', error);
            showToast('Error loading CSV opportunities. Check console.', 3000);
            grid.innerHTML = '<div class="loading"><p>Could not load opportunities from CSV. Please check console for errors.</p></div>';
            // opportunities array is already reset
            updateStats(); 
            renderOpportunities(); // Render empty/error state
        }
    }
    // Make sure the DOM is loaded before trying to load opportunities
    document.addEventListener('DOMContentLoaded', function() {
        // Initial load
        loadOpportunities();
        // You might want to disable or adjust the interval for now
        // setInterval(loadOpportunities, CONFIG.refreshInterval); 
        
        document.getElementById('searchInput').addEventListener('keyup', function(e) {
            if (e.key === 'Enter') applyFilters();
        });
    });
// Updated function to fetch SBA contracts from S3 CSV with extensive logging
async function fetchSBAContracts() {
    const s3CsvUrl = 'https://subhoodata.s3.us-east-1.amazonaws.com/data/sba24.csv';
    const rawSbaOpportunities = [];
    console.log('LOG: Starting fetchSBAContracts...');

    try {
        let csvText;
        try {
            console.log(`LOG: Attempting direct fetch from ${s3CsvUrl}`);
            const response = await fetch(s3CsvUrl);
            if (!response.ok) {
                console.warn(`LOG: Direct fetch failed - Status: ${response.status}`);
                throw new Error(`S3 Load Error for ${s3CsvUrl}: HTTP error ${response.status}`);
            }
            csvText = await response.text();
            console.log(`LOG: Direct fetch successful. CSV text length: ${csvText ? csvText.length : 'N/A'}`);
        } catch (fetchError) {
            console.warn(`LOG: Direct fetch error: ${fetchError.message}. Trying with CORS proxy.`);
            csvText = await fetchWithCORS(s3CsvUrl); // Assumes fetchWithCORS is defined
            console.log(`LOG: Fetch via CORS proxy. CSV text length: ${csvText ? csvText.length : 'N/A'}`);
        }

        if (!csvText || csvText.trim() === '') {
            console.warn('LOG: SBA CSV file is empty or could not be fetched. Returning empty array.');
            return [];
        }
        console.log('LOG: CSV text successfully retrieved. First 500 chars:', csvText.substring(0, 500));


        const parseResult = Papa.parse(csvText, {
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true
        });
        console.log('LOG: Papa.parse completed.');

        if (parseResult.errors && parseResult.errors.length > 0) {
            console.error('LOG: Error parsing CSV from S3:', parseResult.errors);
            showToast('CSV parsing error. Check console.', 3000);
            return [];
        }

        console.log(`LOG: Papa.parse successful. Number of data rows: ${parseResult.data ? parseResult.data.length : 'N/A'}`);

        if (parseResult.data && parseResult.data.length > 0) {
            parseResult.data.forEach((row, index) => {
                // Log first few rows to inspect their structure
                if (index < 3) {
                    console.log(`LOG: CSV Row ${index} data:`, JSON.stringify(row));
                }

                const parseCurrency = (valueStr) => {
                    if (valueStr === null || typeof valueStr === 'undefined') return 0;
                    return parseFloat(String(valueStr).replace(/[$,\s]/g, '')) || 0;
                };

                let piidFromRow = row['Procurement Instrument Identifier'];
                const originalPiid = piidFromRow !== null && typeof piidFromRow !== 'undefined' ? String(piidFromRow).trim() : `temp-row-id-${Date.now()}-${index}`;
                const opportunityId = `sba-csv-${originalPiid.replace(/\s+/g, '-')}`;

                const agencyName = row['Contracting Agency Name'] || row['Contracting Department Name'] || 'Federal Agency (CSV)';
                const contractorName = row['Legal Business Name'] || 'N/A (CSV)';
                const naicsDesc = row['NAICS Description'] || 'Federal Contract (CSV)';
                const contractValueStr = row['Base and All Options Value (Total Contract Value)'] || row['Total Contract Value'];
                const contractValue = parseCurrency(contractValueStr);
                const title = `${naicsDesc} for ${agencyName}`;
                const description = `Contract for ${contractorName} with ${agencyName}. NAICS: ${row['NAICS Code'] || 'N/A'}. Value: ${contractValue ? '$' + contractValue.toLocaleString() : 'N/A'}. PIID: ${originalPiid}.`;

                let oppDate;
                // ... (date logic remains the same) ...
                const startDateVal = row['Period of Performance Start Date'];
                const completionDateVal = row['Completion Date'];
                if (startDateVal && !isNaN(new Date(startDateVal).getTime())) {
                    oppDate = new Date(startDateVal);
                } else if (completionDateVal && !isNaN(new Date(completionDateVal).getTime())) {
                    oppDate = new Date(completionDateVal);
                } else {
                    oppDate = new Date();
                }


                const fpdsLink = originalPiid.startsWith('temp-row-id-') ? '#' : `https://www.fpds.gov/ezsearch/fpdsportal?indexName=awardfull&templateName=1.5.3&s=FPDS&q=${encodeURIComponent(originalPiid)}`;

                const sbaOpp = {
                    id: opportunityId,
                    originalPiid: originalPiid,
                    title: title,
                    link: fpdsLink,
                    description: description.substring(0, 400) + (description.length > 400 ? '...' : ''),
                    date: oppDate,
                    source: 'sba24.csv (S3)',
                    type: 'contract-csv',
                    agency: agencyName,
                    value: contractValue ? `${Math.round(contractValue / 1000000)}M` : null,
                    rawRowData: row
                };

                const textForKeywords = sbaOpp.title + ' ' + sbaOpp.description;
                const passesKeywords = containsKeywords(textForKeywords);

                if (index < 5) { // Log keyword check for first 5 items
                    console.log(`LOG: Row ${index} - PIID: ${originalPiid} - Text for keywords: "${textForKeywords.substring(0,100)}..." - Passes Keywords: ${passesKeywords}`);
                }

                if (passesKeywords) {
                    rawSbaOpportunities.push(sbaOpp);
                }
            });
            console.log(`LOG: Parsed and keyword-filtered ${rawSbaOpportunities.length} initial rows from SBA CSV.`);

            // Deduplication step
            if (rawSbaOpportunities.length === 0) {
                console.log("LOG: No opportunities passed keyword filtering. Deduplication skipped.");
                return [];
            }

            const uniqueSbaOpportunitiesBuilder = []; // To hold items with temporary IDs
            const seenPiids = new Map(); // To hold items with real PIIDs

            for (const opp of rawSbaOpportunities) {
                if (opp.originalPiid.startsWith('temp-row-id-')) {
                    uniqueSbaOpportunitiesBuilder.push(opp);
                    continue;
                }
                
                if (!seenPiids.has(opp.originalPiid)) {
                    seenPiids.set(opp.originalPiid, opp);
                } else {
                    const existingOpp = seenPiids.get(opp.originalPiid);
                    const currentOppRawValue = opp.rawRowData['Base and All Options Value (Total Contract Value)'] || opp.rawRowData['Total Contract Value'];
                    const existingOppRawValue = existingOpp.rawRowData['Base and All Options Value (Total Contract Value)'] || existingOpp.rawRowData['Total Contract Value'];

                    const currentOppMonetaryValue = parseCurrency(currentOppRawValue);
                    const existingOppMonetaryValue = parseCurrency(existingOppRawValue);
                    
                    if (currentOppMonetaryValue > existingOppMonetaryValue) {
                        seenPiids.set(opp.originalPiid, opp);
                    }
                }
            }
            
            // Combine temp ID items and unique PIID items
            const combinedOpportunities = [...uniqueSbaOpportunitiesBuilder, ...Array.from(seenPiids.values())];
            
            // Final deduplication by the `id` field (which is `sba-csv-${originalPiid}`)
            // This handles any edge cases, e.g. if a temp-id item somehow had an id matching a real one.
            const finalUniqueOpportunities = Array.from(new Map(combinedOpportunities.map(op => [op.id, op])).values());

            console.log(`LOG: Deduplicated to ${finalUniqueOpportunities.length} unique SBA opportunities.`);
            return finalUniqueOpportunities;

        } else {
            console.warn('LOG: No data rows found after parsing SBA CSV file.');
            return [];
        }
    } catch (error) {
        console.error('LOG: Error in fetchSBAContracts:', error);
        showToast('Failed to load SBA contracts. Check console.', 3000);
        return [];
    }
}
        async function fetchNewsFeeds() {
            const items = [];
            
            // Use more reliable RSS feeds and APIs
            const sources = [
                {
                    url: 'https://www.fedscoop.com/feed/',
                    type: 'rss'
                },
                {
                    url: 'https://api.rss2json.com/v1/api.json?rss_url=https%3A%2F%2Ffederalnewsnetwork.com%2Fcategory%2Ftechnology%2Ffeed%2F',
                    type: 'json'
                }
            ];
            
            for (const source of sources) {
                try {
                    if (source.type === 'json') {
                        // Direct JSON API - no CORS issues
                        const response = await fetch(source.url);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.items) {
                                data.items.forEach((item, index) => {
                                    if (index >= 10) return;
                                    if (containsKeywords(item.title + ' ' + item.description)) {
                                        items.push({
                                            id: `news-json-${Date.now()}-${index}`,
                                            title: item.title,
                                            link: item.link,
                                            description: cleanText(item.description).substring(0, 400) + '...',
                                            date: new Date(item.pubDate),
                                            source: 'Federal News Network',
                                            type: 'news'
                                        });
                                    }
                                });
                            }
                        }
                    } else {
                        // RSS feed with CORS proxy
                        const xmlText = await fetchWithCORS(source.url);
                        const parser = new DOMParser();
                        const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                        
                        if (!xmlDoc.querySelector('parsererror')) {
                            const entries = xmlDoc.querySelectorAll('item, entry');
                            
                            entries.forEach((entry, index) => {
                                if (index >= 10) return;
                                
                                try {
                                    const title = entry.querySelector('title')?.textContent || '';
                                    const link = entry.querySelector('link')?.textContent || '';
                                    const description = entry.querySelector('description')?.textContent || '';
                                    
                                    if (title && containsKeywords(title + ' ' + description)) {
                                        items.push({
                                            id: `news-rss-${Date.now()}-${index}`,
                                            title: cleanText(title),
                                            link: link.trim(),
                                            description: cleanText(description).substring(0, 400) + '...',
                                            date: new Date(),
                                            source: 'FedScoop',
                                            type: 'news'
                                        });
                                    }
                                } catch (e) {
                                    console.warn('Error parsing entry:', e);
                                }
                            });
                        }
                    }
                } catch (error) {
                    console.warn(`Failed to fetch ${source.url}:`, error);
                }
            }
            
            // Reddit API - very reliable, no CORS issues
            try {
                const subreddits = ['fednews', 'governmentit', 'usajobs'];
                for (const subreddit of subreddits) {
                    const response = await fetch(`https://www.reddit.com/r/${subreddit}/hot.json?limit=15`);
                    if (response.ok) {
                        const data = await response.json();
                        data.data?.children?.forEach(child => {
                            const post = child.data;
                            if (containsKeywords(post.title + ' ' + (post.selftext || ''))) {
                                items.push({
                                    id: `reddit-${post.id}`,
                                    title: post.title,
                                    link: `https://reddit.com${post.permalink}`,
                                    description: post.selftext ? cleanText(post.selftext).substring(0, 300) + '...' : 'View discussion on Reddit',
                                    date: new Date(post.created_utc * 1000),
                                    source: `r/${post.subreddit}`,
                                    type: 'discussion'
                                });
                            }
                        });
                    }
                }
            } catch (error) {
                console.warn('Reddit API error:', error);
            }
            
            return items;
        }

        async function fetchContractData() {
            const contracts = [];
            
            try {
                // Use USASpending.gov API - NO AUTH REQUIRED
                const today = new Date();
                const thirtyDaysAgo = new Date(today.setDate(today.getDate() - 30));
                
                const usaSpendingBody = {
                    filters: {
                        time_period: [{
                            start_date: thirtyDaysAgo.toISOString().split('T')[0],
                            end_date: new Date().toISOString().split('T')[0]
                        }],
                        award_type_codes: ["A", "B", "C", "D"],
                        keywords: ["information technology", "cloud", "data", "artificial intelligence", "AI", "ML", "analytics"],
                        award_amounts: [{
                            lower_bound: 1000000  // $1M+ contracts
                        }]
                    },
                    fields: ["Award ID", "Recipient Name", "Description", "Award Amount", "Awarding Agency", "Start Date", "End Date", "Place of Performance State Code"],
                    page: 1,
                    limit: 25,
                    sort: "Award Amount",
                    order: "desc"
                };
                
                const response = await fetch('https://api.usaspending.gov/api/v2/search/spending_by_award/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(usaSpendingBody)
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    data.results?.forEach(award => {
                        contracts.push({
                            id: `contract-${award['Award ID']}`,
                            title: award['Description'] || `Federal IT Contract - ${award['Award ID']}`,
                            description: `${award['Awarding Agency']} awarded to ${award['Recipient Name']}. ${award['Description'] || 'Technology services contract.'}`,
                            agency: award['Awarding Agency'],
                            value: `${Math.round(award['Award Amount'] / 1000000)}M`,
                            date: new Date(award['Start Date']),
                            source: 'USASpending.gov',
                            type: 'contract',
                            link: `https://www.usaspending.gov/award/${award['Award ID']}`
                        });
                    });
                }
            } catch (error) {
                console.warn('USASpending API error:', error);
            }
            
            // Also try beta.SAM.gov public opportunities endpoint
            try {
                // SAM.gov public search - no auth needed for basic search
                const samUrl = 'https://sam.gov/api/prod/sgs/v1/search/?index=opp&q=information+technology+cloud+data&page=0&sort=-modifiedDate&mode=search&is_active=true';
                
                const samResponse = await fetchWithCORS(samUrl);
                const samData = JSON.parse(samResponse);
                
                if (samData._embedded?.results) {
                    samData._embedded.results.forEach(opp => {
                        if (opp.title && containsKeywords(opp.title + ' ' + (opp.description || ''))) {
                            contracts.push({
                                id: `sam-${opp._id}`,
                                title: opp.title,
                                description: opp.description?.substring(0, 500) || 'Federal contracting opportunity',
                                agency: opp.organizationName || 'Federal Agency',
                                date: new Date(opp.modifiedDate || opp.postedDate),
                                source: 'SAM.gov',
                                type: 'contract',
                                link: `https://sam.gov/opp/${opp._id}/view`
                            });
                        }
                    });
                }
            } catch (error) {
                console.warn('SAM.gov public API error:', error);
            }
            
            // Try grants.gov RSS feed for additional opportunities
            try {
                const grantsUrl = 'https://www.grants.gov/rss/GG_NewOppByAgency.xml';
                const grantsXml = await fetchWithCORS(grantsUrl);
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(grantsXml, 'text/xml');
                const items = xmlDoc.querySelectorAll('item');
                
                items.forEach((item, index) => {
                    if (index >= 10) return;
                    
                    const title = item.querySelector('title')?.textContent || '';
                    const description = item.querySelector('description')?.textContent || '';
                    
                    if (containsKeywords(title + ' ' + description)) {
                        contracts.push({
                            id: `grant-${Date.now()}-${index}`,
                            title: cleanText(title),
                            description: cleanText(description),
                            date: new Date(item.querySelector('pubDate')?.textContent || new Date()),
                            source: 'Grants.gov',
                            type: 'grant',
                            link: item.querySelector('link')?.textContent || ''
                        });
                    }
                });
            } catch (error) {
                console.warn('Grants.gov RSS error:', error);
            }
            
            return contracts;
        }

        async function fetchGitHubActivity() {
            const items = [];
            
            try {
                // Search for federal government repositories with recent activity
                const queries = [
                    'org:usds+org:gsa+org:18f+org:nasa+org:fema+pushed:>2025-01-01',
                    'org:department-of-veterans-affairs+org:usajobs+org:uscis+pushed:>2025-01-01',
                    'topic:government+topic:federal+stars:>10+pushed:>2025-01-01'
                ];
                
                for (const query of queries) {
                    const response = await fetch(`https://api.github.com/search/repositories?q=${encodeURIComponent(query)}&sort=updated&order=desc&per_page=10`);
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        data.items?.forEach(repo => {
                            // Only include if it contains relevant keywords
                            const repoText = `${repo.name} ${repo.description || ''} ${repo.topics?.join(' ') || ''}`.toLowerCase();
                            
                            if (containsKeywords(repoText)) {
                                items.push({
                                    id: `github-${repo.id}`,
                                    title: `${repo.full_name} - Federal Open Source`,
                                    description: `${repo.description || 'Government open source project'}. Language: ${repo.language || 'Various'}. Stars: ${repo.stargazers_count}`,
                                    date: new Date(repo.updated_at),
                                    source: 'GitHub',
                                    type: 'github',
                                    link: repo.html_url,
                                    agency: detectAgencyFromGitHub(repo.owner.login, repo.full_name)
                                });
                            }
                        });
                    }
                }
                
                // Also check for federal contractor activity
                const contractorOrgs = ['boozallen', 'mitre', 'saic', 'caci', 'leidos'];
                for (const org of contractorOrgs) {
                    try {
                        const response = await fetch(`https://api.github.com/users/${org}/repos?sort=updated&per_page=5`);
                        if (response.ok) {
                            const repos = await response.json();
                            
                            repos.forEach(repo => {
                                const repoText = `${repo.name} ${repo.description || ''}`.toLowerCase();
                                if (repoText.includes('federal') || repoText.includes('government') || repoText.includes('dod') || repoText.includes('usaf')) {
                                    items.push({
                                        id: `github-contractor-${repo.id}`,
                                        title: `${repo.full_name} - Federal Contractor Project`,
                                        description: repo.description || 'Federal contractor development',
                                        date: new Date(repo.updated_at),
                                        source: 'GitHub',
                                        type: 'github-contractor',
                                        link: repo.html_url
                                    });
                                }
                            });
                        }
                    } catch (error) {
                        console.warn(`Failed to fetch ${org} repos:`, error);
                    }
                }
                
            } catch (error) {
                console.warn('GitHub API error:', error);
            }
            
            return items;
        }
        
        function detectAgencyFromGitHub(owner, fullName) {
            const mapping = {
                'usds': 'USDS',
                'gsa': 'GSA',
                '18f': 'GSA/18F',
                'nasa': 'NASA',
                'fema': 'DHS/FEMA',
                'department-of-veterans-affairs': 'VA',
                'usajobs': 'OPM',
                'uscis': 'DHS/USCIS'
            };
            
            return mapping[owner.toLowerCase()] || 'Federal';
        }

        // Processing functions
        function processOpportunities(rawItems) {
            return rawItems
                .map(item => ({
                    ...item,
                    score: calculateOpportunityScore(item),
                    agency: detectAgency(item),
                    tags: extractTags(item),
                    competitors: detectCompetitors(item),
                    azureAdvantage: identifyAzureAdvantage(item)
                }))
                .sort((a, b) => b.score - a.score);
        }

        function calculateOpportunityScore(item) {
            let score = 50; // Base score
            
            const text = `${item.title} ${item.description}`.toLowerCase();
            
            // Critical keywords (competitor mentions)
            CONFIG.keywords.critical.forEach(keyword => {
                if (text.includes(keyword)) score += 15;
            });
            
            // High priority keywords
            CONFIG.keywords.high.forEach(keyword => {
                if (text.includes(keyword)) score += 10;
            });
            
            // Urgent indicators
            CONFIG.keywords.urgent.forEach(keyword => {
                if (text.includes(keyword)) score += 10;
            });
            
            // Azure mentions (negative score - already captured)
            CONFIG.keywords.azure.forEach(keyword => {
                if (text.includes(keyword)) score -= 20;
            });
            
            // Recent opportunities score higher
            const daysSincePost = (new Date() - item.date) / (1000 * 60 * 60 * 24);
            if (daysSincePost < 3) score += 10;
            if (daysSincePost < 7) score += 5;
            
            // Contract opportunities score higher
            if (item.type === 'contract') score += 10;
            
            return Math.min(Math.max(score, 0), 100);
        }

        function detectAgency(item) {
            const text = `${item.title} ${item.description} ${item.agency || ''}`.toLowerCase();
            
            for (const [key, keywords] of Object.entries(CONFIG.agencies)) {
                for (const keyword of keywords) {
                    if (text.includes(keyword)) {
                        return key.toUpperCase();
                    }
                }
            }
            
            return 'Other';
        }

        function extractTags(item) {
            const tags = [];
            const text = `${item.title} ${item.description}`.toLowerCase();
            
            // Check for AWS mentions
            if (CONFIG.keywords.critical.some(k => text.includes(k))) {
                tags.push('aws-risk');
            }
            
            // Check for urgent
            if (CONFIG.keywords.urgent.some(k => text.includes(k))) {
                tags.push('urgent');
            }
            
            // Technology tags
            if (text.includes('ai') || text.includes('artificial intelligence') || text.includes('machine learning')) {
                tags.push('ai-ml');
            }
            
            if (text.includes('data') && (text.includes('analytics') || text.includes('analysis'))) {
                tags.push('data-analytics');
            }
            
            if (text.includes('cloud') && text.includes('migrat')) {
                tags.push('cloud-migration');
            }
            
            if (text.includes('fedramp')) {
                tags.push('fedramp');
            }
            
            return tags;
        }

        function detectCompetitors(item) {
            const competitors = [];
            const text = `${item.title} ${item.description}`.toLowerCase();
            
            if (text.includes('palantir')) competitors.push('Palantir');
            if (text.includes('c3.ai') || text.includes('c3 ai')) competitors.push('C3.ai');
            if (text.includes('aws') || text.includes('amazon web services')) competitors.push('AWS');
            if (text.includes('databricks')) competitors.push('Databricks');
            if (text.includes('snowflake')) competitors.push('Snowflake');
            
            return competitors;
        }

        function identifyAzureAdvantage(item) {
            const advantages = [];
            const text = `${item.title} ${item.description}`.toLowerCase();
            
            if (text.includes('fedramp high')) {
                advantages.push('Azure Government has FedRAMP High authorization');
            }
            
            if (text.includes('il5') || text.includes('secret')) {
                advantages.push('Azure Government Secret regions available');
            }
            
            if (text.includes('teams') || text.includes('collaboration')) {
                advantages.push('Native Teams integration');
            }
            
            if (text.includes('power platform') || text.includes('low-code')) {
                advantages.push('Power Platform for rapid development');
            }
            
            if (text.includes('ai') || text.includes('openai')) {
                advantages.push('Azure OpenAI Service with government compliance');
            }
            
            return advantages;
        }

        // UI Functions
        function renderOpportunities() {
            const grid = document.getElementById('opportunitiesGrid');
            const filtered = filterOpportunities();
            
            if (filtered.length === 0) {
                grid.innerHTML = '<div class="loading"><p>No opportunities match your filters</p></div>';
                return;
            }
            
            grid.innerHTML = filtered.map(opp => `
                <div class="opportunity-card">
                    <div class="opportunity-score ${opp.score >= 90 ? 'critical' : opp.score >= 80 ? 'high' : ''}">${opp.score}</div>
                    <h3 class="opportunity-title">${opp.title}</h3>
                    <div class="opportunity-agency">${opp.agency} • ${formatDate(opp.date)}</div>
                    <div class="opportunity-tags">
                        ${opp.tags.map(tag => `<span class="tag ${tag === 'aws-risk' ? 'aws' : tag === 'urgent' ? 'urgent' : ''}">${formatTag(tag)}</span>`).join('')}
                        ${opp.competitors.map(comp => `<span class="tag aws">${comp}</span>`).join('')}
                    </div>
                    <p class="opportunity-description">${opp.description}</p>
                    <div class="opportunity-meta">
                        <span>${opp.source} ${opp.value ? `• ${opp.value}` : ''}</span>
                        <div class="opportunity-actions">
                            <button class="btn btn-primary" onclick="showOpportunityDetails('${opp.id}')">View Details</button>
                            <button class="btn btn-secondary" onclick="generatePlaybook('${opp.id}')">Generate Playbook</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function filterOpportunities() {
            return opportunities.filter(opp => {
                // Search filter
                if (filters.search) {
                    const searchText = `${opp.title} ${opp.description}`.toLowerCase();
                    if (!searchText.includes(filters.search.toLowerCase())) return false;
                }
                
                // Agency filter
                if (filters.agency && opp.agency !== filters.agency.toUpperCase()) return false;
                
                // Score filter
                if (filters.score && opp.score < filters.score) return false;
                
                // ISV filter
                if (filters.isv) {
                    const hasISV = opp.competitors.some(comp => 
                        comp.toLowerCase().includes(filters.isv.toLowerCase())
                    );
                    if (!hasISV) return false;
                }
                
                // Tag filters
                if (filters.tags.length > 0) {
                    const hasRequiredTags = filters.tags.every(tag => opp.tags.includes(tag));
                    if (!hasRequiredTags) return false;
                }
                
                return true;
            });
        }

        function updateStats() {
            // Update header stats
            document.getElementById('totalOpps').textContent = opportunities.length;
            document.getElementById('awsAtRisk').textContent = opportunities.filter(o => o.tags.includes('aws-risk')).length;
            document.getElementById('weeklyGrowth').textContent = '+15%';
            
            // Update dashboard stats
            document.getElementById('highPriorityCount').textContent = opportunities.filter(o => o.score >= 80).length;
            document.getElementById('activeAgencies').textContent = new Set(opportunities.map(o => o.agency)).size;
            document.getElementById('isvMentions').textContent = opportunities.filter(o => o.competitors.length > 0).length;
            
            // Calculate pipeline value
            const pipelineValue = opportunities.reduce((total, opp) => {
                if (opp.value) {
                    const value = parseFloat(opp.value.replace(/[$M]/g, ''));
                    return total + (value || 0);
                }
                return total;
            }, 0);
            document.getElementById('pipelineValue').textContent = `${Math.round(pipelineValue)}M`;
        }

        // Filter functions
        function applyFilters() {
            filters.search = document.getElementById('searchInput').value;
            filters.agency = document.getElementById('agencyFilter').value;
            filters.score = parseInt(document.getElementById('scoreFilter').value) || 0;
            filters.isv = document.getElementById('isvFilter').value;
            
            renderOpportunities();
            showToast('Filters applied', 2000);
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('agencyFilter').value = '';
            document.getElementById('scoreFilter').value = '';
            document.getElementById('isvFilter').value = '';
            
            filters = {
                search: '',
                agency: '',
                score: 0,
                isv: '',
                tags: ['aws-risk']
            };
            
            // Reset chips
            document.querySelectorAll('.chip').forEach(chip => {
                chip.classList.toggle('active', chip.textContent.includes('AWS at Risk'));
            });
            
            renderOpportunities();
            showToast('Filters reset', 2000);
        }

        function toggleChip(chip, tag) {
            chip.classList.toggle('active');
            
            if (chip.classList.contains('active')) {
                if (!filters.tags.includes(tag)) {
                    filters.tags.push(tag);
                }
            } else {
                filters.tags = filters.tags.filter(t => t !== tag);
            }
            
            renderOpportunities();
        }

        // Modal functions
        function showOpportunityDetails(oppId) {
            const opp = opportunities.find(o => o.id === oppId);
            if (!opp) return;
            
            const modal = document.getElementById('opportunityModal');
            document.getElementById('modalTitle').textContent = opp.title;
            
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div style="display: grid; gap: 1.5rem;">
                    <div>
                        <h3>Overview</h3>
                        <p>${opp.description}</p>
                        <p><strong>Agency:</strong> ${opp.agency}</p>
                        <p><strong>Posted:</strong> ${formatDate(opp.date)}</p>
                        ${opp.value ? `<p><strong>Estimated Value:</strong> ${opp.value}</p>` : ''}
                        <p><strong>Opportunity Score:</strong> ${opp.score}/100</p>
                    </div>
                    
                    ${opp.competitors.length > 0 ? `
                    <div>
                        <h3>Competitor Analysis</h3>
                        <p><strong>Mentioned Competitors:</strong> ${opp.competitors.join(', ')}</p>
                        <p>This opportunity mentions AWS-aligned ISVs, presenting a potential displacement opportunity.</p>
                    </div>
                    ` : ''}
                    
                    ${opp.azureAdvantage.length > 0 ? `
                    <div>
                        <h3>Azure Competitive Advantages</h3>
                        <ul>
                            ${opp.azureAdvantage.map(adv => `<li>${adv}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                    
                    <div>
                        <h3>Recommended Actions</h3>
                        <ol>
                            <li>Contact the contracting officer for additional details</li>
                            <li>Identify Azure ISV partners with similar capabilities</li>
                            <li>Prepare competitive positioning against ${opp.competitors.join(', ') || 'incumbents'}</li>
                            <li>Schedule technical discovery session with agency stakeholders</li>
                        </ol>
                    </div>
                    
                    <div>
                        <h3>Suggested ISV Partners</h3>
                        <ul>
                            ${suggestISVPartners(opp).map(partner => `<li>${partner}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <a href="${opp.link}" target="_blank" class="btn btn-primary">View Original Source</a>
                        <button class="btn btn-secondary" onclick="generatePlaybook('${opp.id}')">Generate Playbook</button>
                        <button class="btn btn-secondary" onclick="exportOpportunity('${opp.id}')">Export to CRM</button>
                    </div>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('opportunityModal').style.display = 'none';
        }

        // Playbook generation
        function generatePlaybook(oppId) {
            const opp = opportunities.find(o => o.id === oppId);
            if (!opp) return;
            
            const playbook = `
                <h2>Azure ISV Engagement Playbook</h2>
                <h3>${opp.title}</h3>
                
                <h4>Executive Summary</h4>
                <p>${opp.agency} has posted an opportunity that currently favors AWS-aligned ISVs. This presents a displacement opportunity for Azure.</p>
                
                <h4>Competitive Intelligence</h4>
                <ul>
                    <li>Current vendors mentioned: ${opp.competitors.join(', ') || 'None identified'}</li>
                    <li>Opportunity score: ${opp.score}/100</li>
                    <li>Key requirements: ${opp.tags.map(t => formatTag(t)).join(', ')}</li>
                </ul>
                
                <h4>Azure Win Strategy</h4>
                <ol>
                    <li><strong>Compliance Advantage:</strong> Emphasize Azure Government's FedRAMP High and IL5 capabilities</li>
                    <li><strong>Integration Story:</strong> Highlight native integration with M365, Teams, and Power Platform</li>
                    <li><strong>Cost Optimization:</strong> Present Azure Hybrid Benefit and reserved instance savings</li>
                    <li><strong>ISV Ecosystem:</strong> Showcase Azure-native alternatives to incumbent solutions</li>
                </ol>
                
                <h4>Recommended ISV Partners</h4>
                <ul>
                    ${suggestISVPartners(opp).map(partner => `<li>${partner}</li>`).join('')}
                </ul>
                
                <h4>Next Steps</h4>
                <ol>
                    <li>Schedule discovery call with ${opp.agency} technical team</li>
                    <li>Coordinate with suggested ISV partners for joint value prop</li>
                    <li>Prepare technical proof of concept addressing key requirements</li>
                    <li>Draft white paper on Azure advantages for this use case</li>
                </ol>
                
                <h4>Sample Outreach Email</h4>
                <div style="background: #f0f2f5; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
                    <p>Subject: Azure Solutions for ${opp.agency} ${opp.tags.includes('ai-ml') ? 'AI/ML' : 'Technology'} Initiative</p>
                    <p>Dear [Contracting Officer],</p>
                    <p>I noticed your recent posting regarding ${opp.title}. Microsoft Azure Government and our ISV partners have extensive experience delivering similar solutions with enhanced security and compliance features.</p>
                    <p>We'd welcome the opportunity to discuss how Azure's government-specific capabilities could benefit this initiative.</p>
                    <p>Best regards,<br>[Your Name]<br>Azure Federal ISV Team</p>
                </div>
            `;
            
            // Create a new modal for the playbook
            const modal = document.getElementById('opportunityModal');
            document.getElementById('modalTitle').textContent = 'Generated Playbook';
            document.getElementById('modalBody').innerHTML = playbook + `
                <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                    <button class="btn btn-primary" onclick="downloadPlaybook('${oppId}')">Download as PDF</button>
                    <button class="btn btn-secondary" onclick="copyPlaybook()">Copy to Clipboard</button>
                </div>
            `;
            modal.style.display = 'block';
            
            showToast('Playbook generated successfully', 3000);
        }

        function suggestISVPartners(opp) {
            const partners = [];
            const text = `${opp.title} ${opp.description}`.toLowerCase();
            
            if (text.includes('data') || text.includes('analytics')) {
                partners.push('Databricks on Azure', 'Synapse Analytics Partners', 'Informatica');
            }
            
            if (text.includes('ai') || text.includes('machine learning')) {
                partners.push('H2O.ai on Azure', 'DataRobot', 'Dataiku');
            }
            
            if (text.includes('security') || text.includes('cyber')) {
                partners.push('Sentinel Partners', 'CrowdStrike on Azure', 'Palo Alto Prisma');
            }
            
            if (text.includes('database') || text.includes('data warehouse')) {
                partners.push('SingleStore on Azure', 'MongoDB Atlas on Azure', 'Redis Enterprise');
            }
            
            return partners.length > 0 ? partners : ['Generic Azure Marketplace ISVs'];
        }

        // Export functions
        function exportOpportunity(oppId) {
            const opp = opportunities.find(o => o.id === oppId);
            if (!opp) return;
            
            // Create CRM-ready format
            const crmData = {
                name: opp.title,
                agency: opp.agency,
                estimatedValue: opp.value || 'TBD',
                competitors: opp.competitors.join(', '),
                score: opp.score,
                source: opp.source,
                link: opp.link,
                azureAdvantages: opp.azureAdvantage.join('; '),
                suggestedPartners: suggestISVPartners(opp).join(', '),
                tags: opp.tags.join(', '),
                dateFound: new Date().toISOString()
            };
            
            // Copy to clipboard as JSON
            navigator.clipboard.writeText(JSON.stringify(crmData, null, 2));
            showToast('Opportunity data copied to clipboard for CRM import', 3000);
        }

        function downloadPlaybook(oppId) {
            showToast('PDF download would be implemented with a backend service', 3000);
        }

        function copyPlaybook() {
            const playbookContent = document.getElementById('modalBody').innerText;
            navigator.clipboard.writeText(playbookContent);
            showToast('Playbook copied to clipboard', 3000);
        }

        // Utility functions
        function formatDate(date) {
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            
            return date.toLocaleDateString();
        }

        function formatTag(tag) {
            const tagMap = {
                'aws-risk': 'AWS at Risk',
                'urgent': 'Urgent',
                'ai-ml': 'AI/ML',
                'data-analytics': 'Data Analytics',
                'cloud-migration': 'Cloud Migration',
                'fedramp': 'FedRAMP Required'
            };
            
            return tagMap[tag] || tag;
        }

        function containsKeywords(text) {
            const lowerText = text.toLowerCase();
            const allKeywords = [
                ...CONFIG.keywords.critical,
                ...CONFIG.keywords.high,
                ...CONFIG.keywords.azure,
                ...CONFIG.keywords.urgent
            ];
            
            return allKeywords.some(keyword => lowerText.includes(keyword));
        }

        function cleanText(text) {
            const temp = document.createElement('div');
            temp.innerHTML = text;
            return temp.textContent || temp.innerText || '';
        }

        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        // Handle clicks outside modal
        window.onclick = function(event) {
            const modal = document.getElementById('opportunityModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>