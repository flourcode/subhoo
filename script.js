let resizeTimeout,minValueUpdateTimeout,rawData=[],processedData=null,tableSortKey="subaward_amount",tableSortDirection="desc",currentSankeyData=null,currentAgency="dhs",currentFocusNode=null,minContractValue=2e6,activeLevels=["subagency","office","prime","sub"],topNFilterValue=0,currentVizType="sankey",currentSearchTerm="",currentMapFocusState=null,userChangedMinValue=!1,currentNaicsFilter="",currentSubAgencyFilter="",currentOfficeFilter="",currentPrimeFilter="",currentSubFilter="",allExpiringContracts=[],displayedExpiringCount=0,expiringSortKey="endDate",expiringSortDirection="asc";const DEFAULT_MIN_VALUE=2e6,CHOROPLETH_MIN_VALUE=0,itemsPerLoad=10,itemsToAdd=50,expiringAmountThreshold=2e5,nodeTypes=["agency","subagency","office","prime","sub"];let monochromaticPurpleColors={};function initializeColorScale(){const e=getComputedStyle(document.documentElement);monochromaticPurpleColors={agency:e.getPropertyValue("--sankey-node-agency").trim()||"#9993A1",subagency:e.getPropertyValue("--sankey-node-subagency").trim()||"#878094",office:e.getPropertyValue("--sankey-node-office").trim()||"#797484",prime:e.getPropertyValue("--sankey-node-prime").trim()||"#706877",sub:e.getPropertyValue("--sankey-node-sub").trim()||"#615C66"},window.monochromaticPurpleScale=d3.scaleOrdinal().domain(nodeTypes).range([monochromaticPurpleColors.agency,monochromaticPurpleColors.subagency,monochromaticPurpleColors.office,monochromaticPurpleColors.prime,monochromaticPurpleColors.sub])}function restoreFilterSectionStates(){document.querySelectorAll(".filter-section[data-section]").forEach((e=>{const t=e.getAttribute("data-section"),a=localStorage.getItem(`filter-section-${t}`);"open"===a?e.setAttribute("open",""):"closed"===a&&e.removeAttribute("open")}))}function setupResponsiveVisualization(){window.addEventListener("resize",(function(){clearTimeout(resizeTimeout),resizeTimeout=setTimeout((function(){currentVizType?updateVisualization(currentVizType):currentSankeyData&&drawSankeyDiagram(currentSankeyData)}),250)}));const e=document.querySelector(".visualization");if(e&&window.ResizeObserver){new ResizeObserver((e=>{clearTimeout(resizeTimeout),resizeTimeout=setTimeout((function(){currentVizType?updateVisualization(currentVizType):currentSankeyData&&drawSankeyDiagram(currentSankeyData)}),250)})).observe(e)}}function addCssFixes(){const e=document.createElement("style");e.textContent="\n        .viz-panel { visibility: hidden; opacity: 0; transition: opacity 0.3s ease; }\n        .viz-panel.active { visibility: visible; opacity: 1; transition: opacity 0.3s ease; }\n        .stats-card { cursor: pointer; transition: background-color 0.2s ease; }\n        .stats-card:hover { background-color: var(--color-surface-container-high); }\n        \n        /* NEW: Filter panel height reduction styles */\n        .filter-section summary {\n            cursor: pointer;\n            user-select: none;\n        }\n        \n        .filter-section summary h3 {\n            display: inline-block;\n            margin: 0;\n            padding-bottom: 4px;\n        }\n        \n        .filter-section summary::marker,\n        .filter-section summary::-webkit-details-marker {\n            color: var(--app-accent-color);\n        }\n        \n        .filter-row {\n            display: flex;\n            flex-wrap: wrap;\n            gap: 8px;\n            margin-bottom: 8px;\n        }\n        \n        .filter-column {\n            flex: 1;\n            min-width: calc(50% - 4px);\n        }\n        \n        @media (max-width: 600px) {\n            .filter-column {\n                width: 100%;\n                min-width: 100%;\n                margin-bottom: 8px;\n            }\n        }\n        \n        .sidebar .filter-section {\n            margin-bottom: 8px;\n            padding-bottom: 8px;\n        }\n        \n        .sidebar label {\n            margin-bottom: 3px;\n            font-size: 0.75rem;\n        }\n        \n        .filter-select {\n            padding: 6px 8px;\n            font-size: 0.85rem;\n            line-height: 1.2;\n        }\n    ",document.head.appendChild(e)}function setupEnhancedFilters(){setupSearchFilter(),setupSubAgencyFilter(),setupOfficeFilter(),setupNaicsFilter(),setupPrimeContractorFilter(),setupSubcontractorFilter()}function setupSubAgencyFilter(){const e=document.getElementById("subagency-filter");e?e.addEventListener("change",(()=>{currentSubAgencyFilter=e.value,rawData&&rawData.length>0&&processData()})):console.warn("SubAgency filter select element (#subagency-filter) not found in HTML.")}function setupSearchFilter(){const e=document.getElementById("data-search");if(!e)return void console.warn("Search input element not found");const t=e.parentElement;if(!t)return void console.warn("Search container not found");t.querySelectorAll('.search-clear-btn, #search-clear-btn, button[aria-label="Clear search"]').forEach((e=>e.remove()));const a=document.createElement("button");a.id="search-clear-btn",a.className="search-clear-btn",a.innerHTML="&times;",a.setAttribute("aria-label","Clear search"),Object.assign(a.style,{position:"absolute",right:"12px",top:"50%",transform:"translateY(-50%)",background:"none",border:"none",fontSize:"1.2rem",color:"var(--color-on-surface-variant)",cursor:"pointer",display:e.value?"block":"none",zIndex:"100"}),a.addEventListener("click",(function(t){t.preventDefault(),t.stopPropagation(),e.value="",a.style.display="none",currentSearchTerm="",rawData&&rawData.length>0&&processData(),e.focus()})),t.appendChild(a);const n=e._inputHandler;n&&e.removeEventListener("input",n);const r=function(){a&&(a.style.display=this.value?"block":"none"),clearTimeout(window.searchDebounceTimeout),window.searchDebounceTimeout=setTimeout((()=>{currentSearchTerm=this.value.trim().toLowerCase(),rawData&&rawData.length>0&&processData()}),350)};e._inputHandler=r,e.addEventListener("input",r)}function setupTopNFilter(){let e=document.getElementById("top-n-selector");if(!e){const t=document.createElement("div");t.className="filter-section top-n-filter";const a=document.createElement("h3");a.textContent="Top Subcontracts",t.appendChild(a);const n=document.createElement("label");n.setAttribute("for","top-n-selector"),n.textContent="Show only top contracts:",t.appendChild(n),e=document.createElement("select"),e.id="top-n-selector",e.className="filter-select",e.setAttribute("aria-label","Select number of top subcontracts");[{value:0,text:"Show All"},{value:10,text:"Top 10"},{value:25,text:"Top 25"},{value:50,text:"Top 50"},{value:100,text:"Top 100"}].forEach((t=>{const a=document.createElement("option");a.value=t.value,a.textContent=t.text,e.appendChild(a)})),t.appendChild(e);const r=document.querySelector(".sidebar");if(r){const e=document.getElementById("reset-filters");e?r.insertBefore(t,e):r.appendChild(t)}}e.addEventListener("change",(()=>{topNFilterValue=parseInt(e.value,10)||0,!processedData||"sankey"!==currentVizType&&"network"!==currentVizType&&"treemap"!==currentVizType||updateVisualization(currentVizType)}))}function setupOfficeFilter(){const e=document.getElementById("office-filter");e?e.addEventListener("change",(()=>{currentOfficeFilter=e.value,rawData&&rawData.length>0&&processData()})):console.warn("Office filter select element (#office-filter) not found in HTML.")}function setupNaicsFilter(){let e=document.getElementById("naics-filter");if(!e){const t=document.createElement("div");t.className="filter-section naics-filter";const a=document.createElement("h3");a.textContent="NAICS Filter",t.appendChild(a);const n=document.createElement("label");n.setAttribute("for","naics-filter"),n.textContent="Filter by NAICS Code:",t.appendChild(n),e=document.createElement("select"),e.id="naics-filter",e.className="filter-select",e.setAttribute("aria-label","Filter by NAICS Code");const r=document.createElement("option");r.value="",r.textContent="All NAICS Codes",e.appendChild(r),t.appendChild(e);const o=document.querySelector(".sidebar");if(o){const e=document.querySelector(".filter-section.office-filter");e?o.insertBefore(t,e.nextSibling):o.appendChild(t)}}e.addEventListener("change",(()=>{currentNaicsFilter=e.value,rawData&&rawData.length>0&&processData()}))}function setupPrimeContractorFilter(){let e=document.getElementById("prime-filter");if(!e){const t=document.createElement("div");t.className="filter-section prime-filter";const a=document.createElement("h3");a.textContent="Prime Contractor",t.appendChild(a);const n=document.createElement("label");n.setAttribute("for","prime-filter"),n.textContent="Filter by Prime Contractor:",t.appendChild(n),e=document.createElement("select"),e.id="prime-filter",e.className="filter-select",e.setAttribute("aria-label","Filter by Prime Contractor");const r=document.createElement("option");r.value="",r.textContent="All Prime Contractors",e.appendChild(r),t.appendChild(e);const o=document.querySelector(".sidebar");if(o){const e=document.querySelector(".filter-section.naics-filter");e?o.insertBefore(t,e.nextSibling):o.appendChild(t)}}e.addEventListener("change",(()=>{currentPrimeFilter=e.value,rawData&&rawData.length>0&&processData()}))}function setupSubcontractorFilter(){let e=document.getElementById("sub-filter");if(!e){const t=document.createElement("div");t.className="filter-section sub-filter";const a=document.createElement("h3");a.textContent="Subcontractor",t.appendChild(a);const n=document.createElement("label");n.setAttribute("for","sub-filter"),n.textContent="Filter by Subcontractor:",t.appendChild(n),e=document.createElement("select"),e.id="sub-filter",e.className="filter-select",e.setAttribute("aria-label","Filter by Subcontractor");const r=document.createElement("option");r.value="",r.textContent="All Subcontractors",e.appendChild(r),t.appendChild(e);const o=document.querySelector(".sidebar");if(o){const e=document.querySelector(".filter-section.prime-filter");e?o.insertBefore(t,e.nextSibling):o.appendChild(t)}}e.addEventListener("change",(()=>{currentSubFilter=e.value,rawData&&rawData.length>0&&processData()}))}function populateFilterDropdowns(){rawData&&0!==rawData.length&&(populateSubAgencyFilter(),populateOfficeFilter(),populateNaicsFilter(),populatePrimeFilter(),populateSubFilter())}function populateSubAgencyFilter(){const e=document.getElementById("subagency-filter");if(!e||!rawData||0===rawData.length)return;const t=new Set;for(rawData.forEach((e=>{const a=e.prime_award_awarding_sub_agency_name?.trim();a&&"null"!==a&&"undefined"!==a&&t.add(a)}));e.options.length>1;)e.remove(1);Array.from(t).sort().forEach((t=>{const a=document.createElement("option");a.value=t,a.textContent=truncateText(t,60),a.title=t,e.appendChild(a)}))}function populateOfficeFilter(){const e=document.getElementById("office-filter");if(!e||!rawData||0===rawData.length)return;const t=new Set;for(rawData.forEach((e=>{const a=e.prime_award_awarding_office_name?.trim();a&&"null"!==a&&"undefined"!==a&&t.add(a)}));e.options.length>1;)e.remove(1);Array.from(t).sort().forEach((t=>{const a=document.createElement("option");a.value=t,a.textContent=truncateText(t,60),a.title=t,e.appendChild(a)}))}function populateNaicsFilter(){const e=document.getElementById("naics-filter");if(!e)return;const t=new Map;for(rawData.forEach((e=>{const a=e.prime_award_naics_code?.toString().trim(),n=e.prime_award_naics_description?.trim()||"No Description";a&&"null"!==a&&"undefined"!==a&&t.set(a,n)}));e.options.length>1;)e.remove(1);Array.from(t.keys()).sort().forEach((a=>{const n=t.get(a),r=document.createElement("option");r.value=a,r.textContent=`${a} - ${n}`,e.appendChild(r)}))}function populatePrimeFilter(){const e=document.getElementById("prime-filter");if(!e)return;const t=new Set;for(rawData.forEach((e=>{const a=e.prime_awardee_name?.trim();a&&"null"!==a&&"undefined"!==a&&t.add(a)}));e.options.length>1;)e.remove(1);Array.from(t).sort().slice(0,100).forEach((t=>{const a=document.createElement("option");a.value=t,a.textContent=t,e.appendChild(a)}))}function populateSubFilter(){const e=document.getElementById("sub-filter");if(!e)return;const t=new Set;for(rawData.forEach((e=>{const a=e.subawardee_name?.trim();a&&"null"!==a&&"undefined"!==a&&t.add(a)}));e.options.length>1;)e.remove(1);Array.from(t).sort().slice(0,100).forEach((t=>{const a=document.createElement("option");a.value=t,a.textContent=t,e.appendChild(a)}))}function updateThemeColor(e){const t=document.querySelector('meta[name="theme-color"]');t&&t.setAttribute("content",e)}function setupVisualizationToggle(){const e=document.querySelectorAll(".viz-toggle-btn");let t="sankey";const a=window.location.hash.replace("#","");a&&["sankey","network","choropleth","treemap"].includes(a)&&(t=a),e.forEach((e=>{if(e.getAttribute("data-viz")===t){e.classList.add("active"),e.setAttribute("aria-pressed","true"),currentVizType=t;document.querySelectorAll(".viz-panel").forEach((e=>{const t=e.getAttribute("data-viz");e.classList.toggle("active",t===currentVizType),e.setAttribute("aria-hidden",t!==currentVizType)}))}else e.classList.remove("active"),e.setAttribute("aria-pressed","false")})),e.forEach((t=>{const a=t.cloneNode(!0);t.parentNode.replaceChild(a,t),a.addEventListener("click",(function(t){const a=this.getAttribute("data-viz"),n=this.getBoundingClientRect(),r=t.clientX-n.left,o=t.clientY-n.top,i=document.createElement("span");i.classList.add("ripple"),i.style.left=`${r}px`,i.style.top=`${o}px`,this.appendChild(i),setTimeout((()=>i.remove()),600),e.forEach((e=>{e.classList.remove("active"),e.setAttribute("aria-pressed","false")})),this.classList.add("active"),this.setAttribute("aria-pressed","true"),window.appInitialized&&updateVisualization(a)}))}))}function updateVisualization(e){const t=currentVizType;if(currentVizType=e,t!==e&&!userChangedMinValue){const t=document.getElementById("min-value"),a=document.getElementById("min-value-display");t&&a&&("choropleth"===e?(t.value=CHOROPLETH_MIN_VALUE,minContractValue=CHOROPLETH_MIN_VALUE,a.textContent=formatCurrency(CHOROPLETH_MIN_VALUE)):"sankey"!==e&&"network"!==e&&"treemap"!==e||(t.value=DEFAULT_MIN_VALUE,minContractValue=DEFAULT_MIN_VALUE,a.textContent=formatCurrency(DEFAULT_MIN_VALUE)))}updateActiveFiltersDisplay(),showLoading();document.querySelectorAll(".viz-panel").forEach((t=>{const a=t.getAttribute("data-viz");t.classList.toggle("active",a===e),t.setAttribute("aria-hidden",a!==e)}));let a=prepareVizData(),n=!1;(!a||!a.nodes||0===a.nodes.length)&&minContractValue>0&&"choropleth"!==e&&(console.warn(`No data found for ${e} with Min Value >= ${formatCurrency(minContractValue)}. Attempting redraw with $0.`),a=prepareVizData(0),a&&a.nodes&&a.nodes.length>0?n=!0:console.warn(`Still no data found for ${e} even with $0 minimum.`));try{switch(e){case"sankey":drawSankeyDiagram(a,n);break;case"network":drawNetworkGraph(a,n);break;case"choropleth":drawChoroplethMap(a);break;default:console.warn(`Unknown viz type: ${e}, defaulting to Sankey.`),drawSankeyDiagram(a,n)}updateLegend(e)}catch(t){console.error(`Error updating visualization to ${e}:`,t);const a=document.querySelector(`.viz-panel[data-viz="${e}"]`);a&&(a.innerHTML=`<div class="error-message"><p>Error rendering ${e}:</p><p>${t.message}</p></div>`)}finally{updateDataTable(),hideLoading()}}function updateDataTable(){const e=document.getElementById("data-table-container");if(!e)return void console.error("Data table container element not found.");e.innerHTML="";const t=[{key:"prime_award_awarding_sub_agency_name",header:"Sub Agency",truncate:20,sortable:!0},{key:"prime_award_awarding_office_name",header:"Office",truncate:30,sortable:!0},{key:"prime_awardee_name",header:"Prime Contractor",truncate:40,sortable:!0},{key:"subawardee_name",header:"Subcontractor",truncate:40,sortable:!0},{key:"subaward_amount",header:"Sub Amount",format:"currency",align:"right",sortable:!0},{key:"subaward_description",header:"Sub Description",truncate:50,sortable:!1},{key:"prime_award_naics_code",header:"NAICS",sortable:!0,align:"left"},{key:"subawardee_business_types",header:"Biz Types",truncate:20,sortable:!0},{key:"usaspending_permalink",header:"USAspending Link",format:"link",align:"center",sortable:!1}],a=document.createElement("div");a.className="data-table-header";const n=getAgencyDisplayName();a.innerHTML=`\n        <h3>Detailed Subaward Data for ${n}</h3>\n        <div class="data-table-controls">\n            <span id="data-count">Loading...</span>\n            <button id="export-csv" class="btn btn-text">Download Contracts List (CSV)</button>\n        </div>\n    `,e.appendChild(a);const r=document.createElement("div");r.className="data-table-wrapper",e.appendChild(r);const o=document.createElement("table");o.className="data-table",r.appendChild(o);let i=getFilteredTableData();if(tableSortKey&&i.length>0){const e=t.find((e=>e.key===tableSortKey));e&&e.sortable&&i.sort(compareValues(tableSortKey,tableSortDirection))}const s=o.createTHead().insertRow();t.forEach((e=>{const t=document.createElement("th");t.textContent=e.header,t.classList.add(`col-${e.key}`),e.align&&(t.style.textAlign=e.align),e.sortable&&(t.classList.add("sortable"),t.dataset.sortKey=e.key,t.onclick=()=>handleHeaderClick(e.key),tableSortKey===e.key&&t.classList.add("asc"===tableSortDirection?"sorted-asc":"sorted-desc")),s.appendChild(t)}));const l=o.createTBody();let c=0;if(i&&0!==i.length){i.slice(0,100).forEach((e=>{const a=l.insertRow();a.onclick=()=>handleRowClick(e),a.style.cursor="pointer",t.forEach((t=>{const n=a.insertCell(),r=e[t.key];let o=null!=r?r:"N/A";if(n.classList.add(`cell-${t.key}`),t.align&&(n.style.textAlign=t.align),n.title=String(r??""),"currency"===t.format)n.textContent=formatCurrency(o);else if("link"===t.format)if(o&&"N/A"!==o&&"string"==typeof o&&o.startsWith("http")){const e=document.createElement("a");e.href=o,e.textContent="View",e.target="_blank",e.rel="noopener noreferrer",e.classList.add("detail-link"),e.onclick=e=>e.stopPropagation(),n.appendChild(e)}else n.textContent="N/A";else{const e=t.truncate;n.textContent=e?truncateText(String(o),e):o}})),c++}))}else;const d=document.getElementById("data-count");d&&(d.textContent=i.length>100?`Showing top ${c} of ${i.length} total`:`Showing ${c} row(s)`);const u=document.getElementById("export-csv");if(u){const e=u.cloneNode(!0);u.parentNode.replaceChild(e,u),e.addEventListener("click",(()=>{exportTableAsCSV(i,`${currentAgency}_subawards_export.csv`)})),e.disabled=!i||0===i.length}}function getFilteredTableData(){if(!rawData||0===rawData.length)return console.warn("No raw data available for table"),[];let e=rawData,t=rawData.length;return currentSearchTerm&&(e=e.filter((e=>[e.prime_award_awarding_agency_name,e.prime_award_awarding_sub_agency_name,e.prime_award_awarding_office_name,e.prime_awardee_name,e.subawardee_name,e.prime_award_naics_code?.toString(),e.prime_award_naics_description].some((e=>e&&"string"==typeof e&&e.toLowerCase().includes(currentSearchTerm))))),t=e.length),currentSubAgencyFilter&&(e=e.filter((e=>e.prime_award_awarding_sub_agency_name===currentSubAgencyFilter)),t=e.length),currentOfficeFilter&&(e=e.filter((e=>e.prime_award_awarding_office_name===currentOfficeFilter)),t=e.length),currentNaicsFilter&&(e=e.filter((e=>e.prime_award_naics_code?.toString()===currentNaicsFilter))),currentPrimeFilter&&(e=e.filter((e=>e.prime_awardee_name===currentPrimeFilter))),currentSubFilter&&(e=e.filter((e=>e.subawardee_name===currentSubFilter))),e=currentMapFocusState?e.filter((e=>(e=>{const t=e.subaward_primary_place_of_performance_state_code||e.place_of_performance_state||e.pop_state||e.prime_award_pop_state;return"string"==typeof t?t.toUpperCase().trim():null})(e)===currentMapFocusState)):e.filter((e=>("number"==typeof e.subaward_amount?e.subaward_amount:parseFloat(String(e.subaward_amount||"0").replace(/[^0-9.-]+/g,""))||0)>=minContractValue)),currentFocusNode&&(e=e.filter((e=>[e.prime_award_awarding_agency_name?`agency-${e.prime_award_awarding_agency_name}`:null,e.prime_award_awarding_sub_agency_name?`subagency-${e.prime_award_awarding_sub_agency_name}`:null,e.prime_award_awarding_office_name?`office-${e.prime_award_awarding_office_name}`:null,e.prime_awardee_name?`prime-${e.prime_awardee_name}`:null,e.subawardee_name?`sub-${e.subawardee_name}`:null].filter(Boolean).includes(currentFocusNode.id))),t=e.length),e}function isNodeConnectedToFocus(e){if(!currentFocusNode||!processedData||!processedData.links)return!0;if(e.id===currentFocusNode.id)return!0;const t=Object.values(processedData.links).flat();for(const a of t){const t=a.source?.id||a.source,n=a.target?.id||a.target;if(!((a.value||0)<minContractValue)&&(t===currentFocusNode.id&&n===e.id||n===currentFocusNode.id&&t===e.id))return!0}return!1}function handleRowClick(e){if(!e||!e.subawardee_name)return void console.warn("Clicked row item missing subawardee name:",e);nodeClicked(null,{id:`sub-${e.subawardee_name}`,name:e.subawardee_name,type:"sub"})}function exportTableAsCSV(e,t="data_export.csv"){if(!e||0===e.length)return void showNotification("No data available to export.","warning");const a=[{key:"prime_award_unique_key",header:"Prime Award Unique Key"},{key:"prime_award_awarding_agency_name",header:"Awarding Agency"},{key:"prime_award_awarding_sub_agency_name",header:"Awarding Sub Agency"},{key:"prime_award_awarding_office_name",header:"Awarding Office"},{key:"prime_awardee_name",header:"Prime Contractor Name"},{key:"subawardee_name",header:"Subcontractor Name"},{key:"subaward_amount",header:"Subaward Amount"},{key:"subaward_description",header:"Subaward Description"},{key:"prime_award_naics_code",header:"Prime NAICS Code"},{key:"prime_award_naics_description",header:"Prime NAICS Description"},{key:"subawardee_business_types",header:"Subcontractor Business Types"},{key:"prime_award_period_of_performance_start_date",header:"Prime PoP Start Date"},{key:"prime_award_period_of_performance_current_end_date",header:"Prime PoP End Date"},{key:"subaward_primary_place_of_performance_state_code",header:"Sub PoP State Code"},{key:"subaward_place_of_performance_cd_current",header:"Sub PoP Congressional District"},{key:"usaspending_permalink",header:"USAspending Link"}],n=e=>{if(null==e)return"";return`"${String(e).replace(/"/g,'""')}"`},r=[a.map((e=>n(e.header))).join(","),...e.map((e=>a.map((t=>n(e[t.key]))).join(",")))].join("\n"),o=new Blob([r],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(o),s=document.createElement("a");s.setAttribute("href",i),s.setAttribute("download",t),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s)}function applyFiltersAndDraw(){if(!processedData)return console.warn("applyFiltersAndDraw: no processedData available."),void d3.select("#chart").html('<div class="empty-message">Processing Data...</div>');const e=prepareVizData();currentFocusNode||(currentSankeyData=e),drawSankeyDiagram(e),updateBreadcrumb()}function prepareVizData(e=null){if(!processedData||!processedData.nodes||!processedData.links)return console.warn("prepareVizData: No processed data available."),{nodes:[],links:[]};const t=null!==e?e:minContractValue;if(null!==e);else{}const a={};Object.keys(processedData.nodes).forEach((e=>{Array.isArray(processedData.nodes[e])?a[e]=processedData.nodes[e].filter((e=>e&&"number"==typeof e.value&&e.value>=t&&activeLevels.includes(e.type))):a[e]=[]}));const n=Object.values(a).flat(),r=new Set(n.map((e=>e.id))),o=[];Object.values(processedData.links).flat().forEach((e=>{e&&"number"==typeof e.value&&e.value>=t&&r.has(e.source)&&r.has(e.target)&&o.push({...e})}));let i=n,s=o;if(currentFocusNode){const e=currentFocusNode.id;if(n.some((t=>t.id===e))){const t=new Map,a=new Set,l=[],c=n.find((t=>t.id===e));l.push(c),t.set(e,c),a.add(e);let d=0;for(;d<l.length;){const e=l[d++];o.forEach((o=>{let i=null;if(o.source===e.id&&r.has(o.target)&&!a.has(o.target)?i=o.target:o.target===e.id&&r.has(o.source)&&!a.has(o.source)&&(i=o.source),i){const e=n.find((e=>e.id===i));e&&(a.add(i),t.set(i,e),l.push(e))}}))}i=Array.from(t.values()),s=o.filter((e=>a.has(e.source)&&a.has(e.target)))}else console.warn(`Focus node ${e} not found after initial filters (value/level).`),i=[],s=[]}let l=i,c=s;if(topNFilterValue>0&&["sankey","network","treemap"].includes(currentVizType)){const e=c.filter((e=>"sub"===e.details?.targetType));if(e.length>0){e.sort(((e,t)=>t.value-e.value));const t=e.slice(0,topNFilterValue);if(t.length<e.length){const e=new Set;t.forEach((t=>{e.add(t.source),e.add(t.target)}));let a=!0;const n=10;let r=0;for(;a&&r<n;){a=!1,r++;c.filter((t=>"sub"!==t.details?.targetType&&e.has(t.target)&&!e.has(t.source))).forEach((t=>{e.has(t.source)||i.some((e=>e.id===t.source))&&(e.add(t.source),a=!0)}))}r===n&&console.warn("Top N Ancestor tracing hit max iterations."),l=i.filter((t=>e.has(t.id))),c=c.filter((a=>"sub"===a.details?.targetType&&t.includes(a)||"sub"!==a.details?.targetType&&e.has(a.source)&&e.has(a.target)))}}else["sankey","network","treemap"].includes(currentVizType)&&(l=i.filter((e=>"sub"!==e.type)),c=c.filter((e=>"sub"!==e.details?.targetType)))}return{nodes:l,links:c}}function drawSankeyDiagram(e){const t=d3.select("#chart");if(t.html(""),!rawData||0===rawData.length)return void t.html('\n            <div class="loading-message">\n                <p>Loading data, please wait...</p>\n            </div>\n        ');if(!e||!Array.isArray(e.nodes)||!Array.isArray(e.links)||0===e.nodes.length||0===e.links.length)return t.html(`\n            <div class="formatted-empty-message">\n                <strong class="message-title">No Data for Sankey Diagram</strong>\n                <p class="message-details">No data above <strong>${formatCurrency(minContractValue)}</strong> matches the current filter combination for this visualization.</p>\n                <p class="message-suggestions">Suggestions:</p>\n                <ul>\n                    <li>Lower the 'Minimum Contract Value' slider.</li>\n                    <li>Adjust 'Visible Node Levels'.</li>\n                    <li>Adjust or clear the 'Search' term / other filters.</li>\n                    <li>Clear any active node focus (click 'All Data').</li>\n                    <li>Click 'Reset All Filters'.</li>\n                </ul>\n            </div>\n        `),void console.warn("drawSankeyDiagram: No valid data to draw.");const a=document.getElementById("chart").getBoundingClientRect(),n=a.width,r=a.height,o=20,i=10,s=n-i-10,l=r-o-20;if(s<=0||l<=0)return console.error("Chart container invalid dimensions."),void t.html('<div class="error-message">Chart area too small to draw.</div>');const c=t.append("svg").attr("width",n).attr("height",r).attr("viewBox",`0 0 ${n} ${r}`).attr("preserveAspectRatio","xMidYMid meet").append("g").attr("transform",`translate(${i},${o})`),d=d3.sankey().nodeId((e=>e.id)).nodeWidth(isMobileDevice()?10:15).nodeSort(null).nodePadding(isMobileDevice()?6:10).extent([[0,0],[s,l]]),u={nodes:e.nodes.map((e=>({...e}))),links:e.links.map((e=>({...e})))};let p;try{const e=new Set(u.nodes.map((e=>e.id)));u.links=u.links.filter((t=>e.has(t.source)&&e.has(t.target))),p=d(u)}catch(e){return console.error("Error calculating Sankey layout:",e),void t.html(`<div class="error-message">Error calculating layout: ${e.message}. Try different filters.</div>`)}const m=c.append("defs");p.links.forEach(((e,t)=>{const a=`link-gradient-${t}`,n=monochromaticPurpleScale(e.source.type)||"#999",r=monochromaticPurpleScale(e.target.type)||"#999",o=m.append("linearGradient").attr("id",a).attr("gradientUnits","userSpaceOnUse").attr("x1",e.source.x1).attr("y1",e.source.y0+(e.source.y1-e.source.y0)/2).attr("x2",e.target.x0).attr("y2",e.target.y0+(e.target.y1-e.target.y0)/2);o.append("stop").attr("offset","0%").attr("stop-color",n).attr("stop-opacity",.8),o.append("stop").attr("offset","100%").attr("stop-color",r).attr("stop-opacity",.8),e.gradientId=a}));c.append("g").attr("class","links").attr("fill","none").selectAll("path.link").data(p.links).join("path").attr("class","link").attr("d",d3.sankeyLinkHorizontal()).attr("stroke-width",(e=>Math.max(1,e.width||1))).attr("stroke",(e=>`url(#${e.gradientId})`)).style("transition","stroke-opacity 0.2s ease").style("stroke-opacity",.3).on("mouseover",(function(e,t){d3.select(this).style("stroke-opacity",.6).attr("stroke-width",(e=>Math.max(2,e.width+1))),d3.selectAll(".node").filter((e=>e.id===t.source.id||e.id===t.target.id)).select("rect").attr("stroke-width",2).attr("stroke","var(--app-accent-color)"),showLinkTooltip(e,t)})).on("mouseout",(function(e,t){d3.select(this).style("stroke-opacity",.3).attr("stroke-width",(e=>Math.max(1,e.width))),d3.selectAll(".node rect").attr("stroke-width",1).attr("stroke","var(--sankey-node-stroke)"),hideTooltip()}));const f=c.append("g").attr("class","nodes").selectAll(".node").data(p.nodes).join("g").attr("class",(e=>`node node-type-${e.type}`)).attr("data-type",(e=>e.type)).attr("transform",(e=>`translate(${e.x0},${e.y0})`)).attr("tabindex",0).attr("role","button").attr("aria-label",(e=>`${e.name}, ${e.type}, ${formatCurrency(e.value)}`)).on("click",nodeClicked).on("mouseover",(function(e,t){d3.select(this).select("rect").attr("stroke-width",2).attr("stroke","var(--app-accent-color)"),d3.selectAll(".link").style("stroke-opacity",(e=>{const a="object"==typeof e.source?e.source.id:e.source,n="object"==typeof e.target?e.target.id:e.target;return a===t.id||n===t.id?.6:.1})),showNodeTooltip(e,t)})).on("mouseout",(function(e,t){const a=currentFocusNode&&t.id===currentFocusNode.id;d3.select(this).select("rect").attr("stroke-width",a?2:1).attr("stroke",a?"var(--app-accent-color)":"var(--sankey-node-stroke)"),d3.selectAll(".link").style("stroke-opacity",.3),hideTooltip()})).on("keydown",(function(e,t){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),nodeClicked(e,t))}));f.append("rect").attr("height",(e=>Math.max(1,e.y1-e.y0))).attr("width",(e=>e.x1-e.x0)).attr("fill",(e=>monochromaticPurpleScale(e.type))).attr("stroke",(e=>currentFocusNode&&e.id===currentFocusNode.id?"var(--app-accent-color)":"var(--sankey-node-stroke)")).attr("stroke-width",(e=>currentFocusNode&&e.id===currentFocusNode.id?2:1)).attr("fill-opacity",.95),f.append("text").attr("x",(e=>e.x0<s/2?e.x1-e.x0+6:-6)).attr("y",(e=>(e.y1-e.y0)/2)).attr("dy","0.35em").attr("text-anchor",(e=>e.x0<s/2?"start":"end")).attr("fill","var(--sankey-node-label-fill, #ccc)").attr("font-family","var(--font-primary)").attr("font-size",isMobileDevice()?"9px":"11px").style("pointer-events","none").style("user-select","none").text((e=>{const t=("agency"===e.type||"subagency"===e.type)&&e.acronym;let a=t?e.acronym:e.name||"";const n=isMobileDevice()?18:30;return!t&&a.length>n&&(a=a.substring(0,n-1)+"…"),a})).each((function(e){e.y1-e.y0<(isMobileDevice()?8:10)&&d3.select(this).remove()}))}function drawNetworkGraph(e,t=!1){const a=d3.select("#network-chart");a.html("");const n=e.nodes,r=e.links;if(!n||0===n.length)return console.warn("drawNetworkGraph: No nodes remain after filtering."),void a.html(`\n             <div class="formatted-empty-message">\n                 <strong class="message-title">No Data for Network Graph</strong>\n                 <p class="message-details">No data matches the current filter combination${minContractValue>0?` above ${formatCurrency(minContractValue)}`:""}.</p>\n                 <p class="message-suggestions">Suggestions:</p><ul>\n                     ${minContractValue>0?"<li>Lower the 'Minimum Contract Value' slider.</li>":""}\n                     <li>Adjust 'Visible Node Levels'.</li><li>Adjust or clear the 'Search' term / other filters.</li>\n                     <li>Clear any active node focus (click 'All Data').</li><li>Click 'Reset All Filters'.</li></ul></div>`);const o=document.getElementById("network-chart").getBoundingClientRect(),i=o.width,s=o.height;if(i<=10||s<=10)return console.error("Network container invalid dimensions."),void a.html('<div class="error-message">Chart container invalid dimensions.</div>');const l=a.append("svg").attr("width",i).attr("height",s).attr("viewBox",`0 0 ${i} ${s}`).attr("preserveAspectRatio","xMidYMid meet").style("cursor","grab"),c=l.append("g"),d=d3.zoom().scaleExtent([.1,8]).on("zoom",(e=>{c.attr("transform",e.transform),l.style("cursor","grabbing");const t=a.select(".reset-zoom-btn").node();t&&(t.style.display=1===e.transform.k&&0===e.transform.x&&0===e.transform.y?"none":"block")})).on("end",(()=>l.style("cursor","grab")));l.call(d);a.append("button").attr("class","reset-zoom-btn").text("Reset View").style("position","absolute").style("top","10px").style("right","10px").style("z-index","10").style("display","none").style("background-color","var(--color-surface-container-high)").style("color","var(--color-on-surface-variant)").style("border","1px solid var(--color-outline-variant)").style("border-radius","20px").style("padding","8px 12px").style("font-size","0.8rem").style("cursor","pointer").on("click",(function(){l.transition().duration(750).call(d.transform,d3.zoomIdentity)}));const u=d3.max(n,(e=>e.value))||1,p=d3.scaleSqrt().domain([0,u]).range([isMobileDevice()?3:4,isMobileDevice()?12:15]),m=n.map((e=>({...e}))),f=r.map((e=>({...e,source:m.find((t=>t.id===e.source)),target:m.find((t=>t.id===e.target))}))),g=d3.forceSimulation(m).force("link",d3.forceLink(f).id((e=>e.id)).distance(isMobileDevice()?45:75).strength(.6)).force("charge",d3.forceManyBody().strength(isMobileDevice()?-90:-130)).force("center",d3.forceCenter(i/2,s/2).strength(.05)).force("collision",d3.forceCollide().radius((e=>p(e.value)+(isMobileDevice()?4:6))).strength(.8)),y=c.append("g").attr("class","links").attr("stroke","var(--sankey-link-color)").attr("stroke-opacity","var(--sankey-link-opacity)").selectAll("line").data(f).join("line").attr("stroke-width",(e=>Math.max(.5,Math.min(5,p(e.value)/3)))).on("mouseover",(function(e,t){d3.select(this).attr("stroke-opacity",.9);showLinkTooltip(e,r.find((e=>e.source===t.source.id&&e.target===t.target.id))||t)})).on("mouseout",(function(){d3.select(this).attr("stroke-opacity","var(--sankey-link-opacity)"),hideTooltip()})),h=c.append("g").attr("class","nodes").selectAll("circle").data(m,(e=>e.id)).join("circle").attr("r",(e=>p(e.value))).attr("fill",(e=>monochromaticPurpleScale(e.type)||"#797484")).attr("stroke","var(--sankey-node-stroke)").attr("stroke-width",1.5).attr("tabindex",0).attr("role","button").attr("aria-label",(e=>`${e.name}, ${e.type}, ${formatCurrency(e.value)}`)).call(d3.drag().on("start",(function(e,t){e.active||g.alphaTarget(.3).restart();t.fx=t.x,t.fy=t.y,d3.select(this).style("cursor","grabbing")})).on("drag",(function(e,t){t.fx=e.x,t.fy=e.y})).on("end",(function(e,t){e.active||g.alphaTarget(0);isTouchDevice()||(t.fx=null,t.fy=null);d3.select(this).style("cursor","pointer")}))).on("click",nodeClicked).on("mouseover",(function(e,t){d3.select(this).attr("stroke-width",3).attr("stroke","var(--app-accent-color)"),showNodeTooltip(e,t),y.attr("stroke-opacity",(e=>{const a=e.source.id,n=e.target.id;return a===t.id||n===t.id?.9:.1})),h.attr("opacity",(e=>{if(e.id===t.id)return 1;return f.some((a=>{const n=a.source.id,r=a.target.id;return n===t.id&&r===e.id||r===t.id&&n===e.id}))?.8:.3}))})).on("mouseout",(function(){d3.select(this).attr("stroke-width",1.5).attr("stroke","var(--sankey-node-stroke)"),hideTooltip(),y.attr("stroke-opacity","var(--sankey-link-opacity)"),h.attr("opacity",1)})).on("keydown",(function(e,t){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),nodeClicked(e,t))})),b=c.append("g").attr("class","labels").selectAll("text.node-label").data(m,(e=>e.id)).join("text").attr("class","node-label").attr("text-anchor","start").style("font-size",isMobileDevice()?"7px":"9px").style("fill","var(--sankey-node-label-fill, #555)").style("pointer-events","none").style("user-select","none").text((e=>window.innerWidth<=768?truncateText(e.name,10):e.name)).attr("dominant-baseline","middle").attr("dx",(e=>p(e.value)+(isMobileDevice()?4:5))).style("display",(e=>{const t=p(e.value);return isMobileDevice()?t<4?"none":"block":t<2?"none":"block"}));g.on("tick",(()=>{y.attr("x1",(e=>e.source.x)).attr("y1",(e=>e.source.y)).attr("x2",(e=>e.target.x)).attr("y2",(e=>e.target.y)),h.attr("cx",(e=>e.x=Math.max(p(e.value),Math.min(i-p(e.value),e.x)))).attr("cy",(e=>e.y=Math.max(p(e.value),Math.min(s-p(e.value),e.y)))),b.attr("x",(e=>e.x)).attr("y",(e=>e.y))}));let w=0;l.on("touchend",(function(e){if(e.defaultPrevented)return;const t=(new Date).getTime(),a=t-w;if(a<400&&a>0){e.preventDefault();const t=d3.pointer(e,l.node());d3.zoomTransform(l.node()).k<2?l.transition().duration(500).call(d.transform,d3.zoomIdentity.translate(i/2,s/2).scale(2.5).translate(-t[0],-t[1])):l.transition().duration(500).call(d.transform,d3.zoomIdentity)}w=t}))}function drawChoroplethMap(){const e=CHOROPLETH_MIN_VALUE,t=d3.select("#map-chart");if(t.html(""),!rawData||0===rawData.length)return console.warn("Cannot draw choropleth map: No rawData available"),void t.html('<div class="formatted-empty-message">...</div>');const a={};let n=0;if(rawData.forEach((t=>{let r=!0;if(currentSearchTerm){[t.prime_award_awarding_agency_name,t.prime_award_awarding_sub_agency_name,t.prime_award_awarding_office_name,t.prime_awardee_name,t.subawardee_name,t.prime_award_naics_code?.toString(),t.prime_award_naics_description].some((e=>e?.toLowerCase().includes(currentSearchTerm)))||(r=!1)}if(r&&currentSubAgencyFilter&&t.prime_award_awarding_sub_agency_name!==currentSubAgencyFilter&&(r=!1),r&&currentOfficeFilter&&t.prime_award_awarding_office_name!==currentOfficeFilter&&(r=!1),r&&currentNaicsFilter&&t.prime_award_naics_code?.toString()!==currentNaicsFilter&&(r=!1),r&&currentPrimeFilter&&t.prime_awardee_name!==currentPrimeFilter&&(r=!1),r&&currentSubFilter&&t.subawardee_name!==currentSubFilter&&(r=!1),!r)return;const o="number"==typeof t.subaward_amount?t.subaward_amount:parseFloat(String(t.subaward_amount||"0").replace(/[^0-9.-]+/g,""))||0;if(o<e)return;const i=t.subaward_primary_place_of_performance_state_code||t.place_of_performance_state||t.pop_state||t.prime_award_pop_state,s=t.subaward_primary_place_of_performance_country_code||t.place_of_performance_country||"USA";if(i&&"string"==typeof i&&2===i.length&&("USA"===s||"US"===s)){const e=i.toUpperCase();a[e]=(a[e]||0)+o,n+=o}})),0===Object.keys(a).length)return console.warn("drawChoroplethMap: No aggregated state data after filtering."),void t.html('<div class="formatted-empty-message">...</div>');const r=t.append("div").attr("class","loading-message").text("Loading map data...");d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json").then((e=>{r.remove();const n=document.getElementById("map-chart").getBoundingClientRect(),o=n.width,i=n.height;if(o<=0||i<=0)return void console.error("Map container invalid");const s=t.append("svg").attr("width",o).attr("height",i).attr("viewBox",`0 0 ${o} ${i}`).attr("preserveAspectRatio","xMidYMid meet").style("display","block").style("width","100%").style("height","100%"),l=s.append("g").attr("class","map-container"),c=d3.zoom().scaleExtent([.5,8]).on("zoom",(e=>l.attr("transform",e.transform)));s.call(c);const d=topojson.feature(e,e.objects.states),u=d3.geoAlbersUsa().fitSize([o,i],d),p=d3.geoPath().projection(u),m=Object.values(a),f=d3.scaleQuantile().domain(m.length>0?m:[0,1]).range(monochromaticPurpleScale.range()),g={"01":"AL","02":"AK","04":"AZ","05":"AR","06":"CA","08":"CO","09":"CT",10:"DE",11:"DC",12:"FL",13:"GA",15:"HI",16:"ID",17:"IL",18:"IN",19:"IA",20:"KS",21:"KY",22:"LA",23:"ME",24:"MD",25:"MA",26:"MI",27:"MN",28:"MS",29:"MO",30:"MT",31:"NE",32:"NV",33:"NH",34:"NJ",35:"NM",36:"NY",37:"NC",38:"ND",39:"OH",40:"OK",41:"OR",42:"PA",44:"RI",45:"SC",46:"SD",47:"TN",48:"TX",49:"UT",50:"VT",51:"VA",53:"WA",54:"WV",55:"WI",56:"WY",72:"PR"};l.append("g").attr("class","states").selectAll("path").data(d.features).join("path").attr("d",p).attr("fill",(e=>{const t=g[e.id],n=a[t]||0;return n>0?f(n):"#eee"})).attr("stroke","#fff").attr("stroke-width",.5).attr("tabindex",0).attr("role","button").attr("aria-label",(e=>{const t=g[e.id],n=a[t]||0;return`${getStateFullName(t)}: ${formatCurrency(n)}`})).classed("focused-state",(e=>g[e.id]===currentMapFocusState)).on("mouseover",(function(e,t){d3.select(this).raise().attr("stroke","#000").attr("stroke-width",1.5);const n=g[t.id],r=a[n]||0;if(r>0||!n)showMapTooltip(e,n||t.properties.name,r);else{const t=d3.select("#tooltip");t.html(`<h4>${getStateFullName(n)}</h4><p><em>No contracts match current filters</em></p>`).classed("visible",!0).attr("aria-hidden","false"),positionTooltip(t,e)}})).on("mouseout",(function(e,t){g[t.id]!==currentMapFocusState?d3.select(this).attr("stroke","#fff").attr("stroke-width",.5):d3.select(this).attr("stroke","var(--app-accent-color)").attr("stroke-width",2),hideTooltip()})).on("click",(function(e,t){const n=g[t.id];if(n){if(console.log(`--- Map State Click: ${n} ---`),l.selectAll("path.focused-state").classed("focused-state",!1).attr("stroke","#fff").attr("stroke-width",.5),currentMapFocusState===n)currentMapFocusState=null,console.log("   Cleared map state focus."),closeInfoPanel();else{currentMapFocusState=n,console.log(`   Set currentMapFocusState to: ${currentMapFocusState}`),d3.select(this).classed("focused-state",!0).attr("stroke","var(--app-accent-color)").attr("stroke-width",2).raise();const e=a[n]||0;e>0&&showEnhancedStateInfoPanel(n,e)}updateBreadcrumb(),updateDataTable()}})),l.append("path").datum(topojson.mesh(e,e.objects.states,((e,t)=>e!==t))).attr("fill","none").attr("stroke","#fff").attr("stroke-width",.5).attr("stroke-linejoin","round").attr("d",p);const y=i-18*monochromaticPurpleScale.range().length-30,h=s.append("g").attr("class","legend choropleth-legend").attr("transform",`translate(15, ${y})`);h.append("text").attr("class","legend-title").attr("x",0).attr("y",-8).style("font-size","10px").style("font-weight","bold").style("fill","var(--color-on-surface)").text("Contract Value (Filtered)");const b=f.quantiles(),w=d3.min(m)||0,v=d3.max(m)||1,_=h.selectAll(".legend-item").data(monochromaticPurpleScale.range()).join("g").attr("class","legend-item").attr("transform",((e,t)=>`translate(0, ${18*t})`));_.append("rect").attr("width",14).attr("height",14).attr("fill",(e=>e)),_.append("text").attr("x",19).attr("y",7).attr("dy","0.35em").style("font-size","9px").style("fill","var(--color-on-surface)").text(((e,t)=>{const a=monochromaticPurpleScale.range().length,n=0===t?w:b[t-1],r=t<b.length?b[t]:v;return 0===b.length?"All Values":0===t?`< ${formatCurrency(r)}`:t===a-1||r<=n?`≥ ${formatCurrency(n)}`:`${formatCurrency(n)} - ${formatCurrency(r)}`}))})).catch((e=>{console.error("Error processing or rendering map GeoJSON data:",e),t.html('<div class="error-message">...</div>')}))}function getDisplayName(e){return"agency"!==e.type&&"subagency"!==e.type||!e.acronym?e.name:e.acronym}function updateActiveFiltersDisplay(){const e=document.getElementById("active-filters");if(!e)return void console.warn("Active filter display container (#active-filters) not found.");const t=`<h2 class="agency-filter-title">${getAgencyDisplayName()} FY25</h2>`;let a="",n=!1;if(a+=`<span class="filter-item"><span class="filter-label">Showing&nbsp;Subcontracts&nbsp;>&nbsp;${formatCurrencyWithSuffix(minContractValue)}</span>`,n=!0,currentSubAgencyFilter&&(a+=`<span class="filter-separator">|</span> <span class="filter-item"><span class="filter-label">SubAgency:</span> <strong>${truncateText(currentSubAgencyFilter,30)}</strong></span>`,n=!0),currentOfficeFilter&&(a+=`<span class="filter-separator">|</span> <span class="filter-item"><span class="filter-label">Office:</span> <strong>${truncateText(currentOfficeFilter,30)}</strong></span>`,n=!0),currentNaicsFilter){const e=document.getElementById("naics-filter");let t=currentNaicsFilter,r=currentNaicsFilter;if(e){const a=Array.from(e.options).find((e=>e.value===currentNaicsFilter));a&&(r=a.textContent,t=a.value)}a+='<span class="filter-separator">|</span> <span class="filter-item" title="<span class="math-inline">{nFT}"><span class="filter-label">NAICS:</span> <strong></span>{nT}</strong></span>',n=!0}currentPrimeFilter&&(a+=`<span class="filter-separator">|</span> <span class="filter-item"><span class="filter-label">Prime:</span> <strong>${truncateText(currentPrimeFilter,30)}</strong></span>`,n=!0),currentSubFilter&&(a+=`<span class="filter-separator">|</span> <span class="filter-item"><span class="filter-label">Sub:</span> <strong>${truncateText(currentSubFilter,30)}</strong></span>`,n=!0),currentSearchTerm&&(a+=`<span class="filter-separator">|</span> <span class="filter-item"><span class="filter-label">Search:</span> <strong>"${truncateText(currentSearchTerm,20)}"</strong></span>`,n=!0);let r=t;n&&(r+=`<div class="other-filters">${a}</div>`),e.innerHTML=r}function updateLegend(e){const t=document.getElementById("legend");if(t)switch(t.innerHTML="",e){case"sankey":case"treemap":if(activeLevels.forEach((e=>{const a=monochromaticPurpleScale(e);if(a){const n=document.createElement("div");n.className="legend-item";const r=document.createElement("div");r.className="legend-color",r.style.backgroundColor=a,r.style.borderRadius="3px";const o=document.createElement("span");o.textContent=capitalizeFirstLetter(e),n.appendChild(r),n.appendChild(o),t.appendChild(n)}else console.warn(`Could not get color from purpleHierarchyColorScale for legend level: ${e}`)})),"treemap"===e){const e=document.createElement("div");e.className="legend-item legend-instruction",e.style.flexBasis="100%",e.style.marginTop="8px",e.innerHTML="<span><strong>Tip:</strong> Click cells to focus data. Click 'All Data' breadcrumb to reset.</span>",t.appendChild(e)}break;case"network":nodeTypes.forEach((e=>{const a=monochromaticPurpleScale(e);if(a&&activeLevels.includes(e)){const n=document.createElement("div");n.className="legend-item";const r=document.createElement("div");r.className="legend-color",r.style.backgroundColor=a,r.style.borderRadius="3px";const o=document.createElement("span");o.textContent=capitalizeFirstLetter(e),n.appendChild(r),n.appendChild(o),t.appendChild(n)}else a||console.warn(`Could not get color from nodeTypeCategoricalColorScale for legend level: ${e}`)}));const a=document.createElement("div");a.className="legend-item size-legend",a.innerHTML="<span>Node size represents contract value</span>",t.appendChild(a);break;case"choropleth":t.innerHTML='<div class="legend-item"><span>Map legend generated within map area</span></div>';break;default:console.warn(`updateLegend: No specific legend logic for vizType: ${e}`)}}function showNodeTooltip(e,t){const a=d3.select("#tooltip");if(!a.node())return;const n=formatCurrency(t.value);let r=`<h4>${t.name}</h4><p><strong>Type:</strong> ${capitalizeFirstLetter(t.type)}</p><p><strong>Value:</strong> ${n}</p>`;r+=isTouchDevice()?"<p><em>Tap to focus on this node</em></p>":"<p><em>Click to focus on this node</em></p>",a.html(r).classed("visible",!0).attr("aria-hidden","false"),positionTooltip(a,e)}function showLinkTooltip(e,t){const a=d3.select("#tooltip");if(!a.node())return;const n=formatCurrency(t.value);let r=`<h4>${t.source.name} → ${t.target.name}</h4><p><strong>Value:</strong> ${n}</p>`;t.details?.naicsCode&&(r+=`<p><strong>NAICS:</strong> ${t.details.naicsCode} - ${t.details.naicsDesc||"N/A"}</p>`),t.details?.percentage&&(r+=`<p><strong>Percentage:</strong> ${t.details.percentage}</p>`),a.html(r).classed("visible",!0).attr("aria-hidden","false"),positionTooltip(a,e)}function hideTooltip(){d3.select("#tooltip").classed("visible",!1).attr("aria-hidden","true")}function positionTooltip(e,t){const a=e.node();if(!a)return;const n=isTouchDevice()?20:15,r=a.offsetWidth,o=a.offsetHeight,i=window.innerWidth,s=window.innerHeight;let l=t.pageX+n,c=t.pageY+n;l+r>i&&(l=Math.max(5,t.pageX-r-n)),c+o>s&&(c=Math.max(5,t.pageY-o-n)),isTouchDevice()&&(c=Math.min(c,s-o-10)),e.style("left",`${l}px`).style("top",`${c}px`)}function showMapTooltip(e,t,a){const n=d3.select("#tooltip");if(!n.node())return;const r=getTopContractorsForState(t,1);let o=`<h4>${getStateFullName(t)}</h4><p><strong>Total Contract Value:</strong> ${formatCurrency(a)}</p>`;r.length>0&&(o+=`<p><strong>Top Contractor:</strong> ${r[0].name}</p>`);const i=getContractCountForState(t);i>0&&(o+=`<p><strong>Contracts:</strong> ${i}</p>`),o+="<p><em>Click for more details</em></p>",n.html(o).classed("visible",!0).attr("aria-hidden","false"),positionTooltip(n,e)}function nodeClicked(e,t){currentFocusNode&&currentFocusNode.id===t.id?(currentFocusNode=null,closeInfoPanel()):(currentFocusNode={id:t.id,name:t.name,type:t.type},showInfoPanel(t),isTouchDevice()&&window.navigator.vibrate&&window.navigator.vibrate(50)),currentVizType?updateVisualization(currentVizType):(console.warn("currentVizType not set, defaulting to Sankey update"),applyFiltersAndDraw()),updateDataTable()}function showInfoPanel(e){const t=document.getElementById("info-panel");if(!t)return;const a=document.getElementById("info-panel-title"),n=document.getElementById("info-panel-content"),r=document.getElementById("info-panel-link");if(!a||!n||!r)return;a.textContent=e?.name||"Details Unavailable",n.innerHTML="",addInfoItem(n,"Type",capitalizeFirstLetter(e?.type||"Unknown")),addInfoItem(n,"Total Value",formatCurrency(e?.value||0));let o="#";if(processedData&&processedData.links&&processedData.nodes)try{const t=Object.values(processedData.links).flat(),a=Object.values(processedData.nodes).flat();let r=t.filter((t=>t?.source===e.id||t?.target===e.id));const i=r.find((e=>e?.details?.permalink&&"#"!==e.details.permalink&&e.details.permalink.startsWith("http")));i?o=i.details.permalink:console.log("No valid permalink found in connected links details.");const s=r.map((t=>{const n=t.source===e.id,r=n?t.target:t.source,o=a.find((e=>e.id===r));return{name:o?.name||r?.split("-").slice(1).join("-")||"Unknown Entity",type:o?.type||r?.split("-")[0]||"unknown",value:t.value||0,relation:n?"outgoing":"incoming",details:t.details}})).sort(((e,t)=>t.value-e.value)),l=s.filter((e=>"incoming"===e.relation)),c=s.filter((e=>"outgoing"===e.relation));if("prime"===e.type)c.length>0?(addInfoSection(n,"Top Subcontractors"),c.slice(0,5).forEach((e=>addInfoItem(n,e.name,formatCurrency(e.value))))):addInfoItem(n,"Subcontractors","None found in current view.");else if("sub"===e.type)l.length>0?(addInfoSection(n,"Prime Contractors"),l.slice(0,5).forEach((e=>addInfoItem(n,e.name,formatCurrency(e.value))))):addInfoItem(n,"Prime Contractors","None found in current view.");else{if(l.length>0){const e=l[0].type;addInfoSection(n,`Top Incoming (${capitalizeFirstLetter(e||"")})`),l.slice(0,5).forEach((e=>addInfoItem(n,e.name,formatCurrency(e.value))))}if(c.length>0){const e=c[0].type;addInfoSection(n,`Top Outgoing (${capitalizeFirstLetter(e||"")})`),c.slice(0,5).forEach((e=>addInfoItem(n,e.name,formatCurrency(e.value))))}0===l.length&&0===c.length&&addInfoItem(n,"Connections","None found in current view.")}}catch(e){console.error("Error processing node details:",e),addInfoItem(n,"Error","Could not load details.")}else console.warn("Processed data not available for detailed info panel."),addInfoItem(n,"Details","Data incomplete.");r.href=o;const i=o&&"#"!==o&&o.startsWith("http");r.style.display=i?"inline-flex":"none",t.classList.add("visible"),t.removeAttribute("inert")}function closeInfoPanel(){const e=document.getElementById("info-panel");e&&(e.classList.remove("visible"),e.setAttribute("inert",""))}function addInfoSection(e,t){const a=document.createElement("dt");a.textContent=t,e.appendChild(a)}function addInfoItem(e,t,a){const n=document.createElement("dt");n.textContent=t;const r=document.createElement("dd");r.textContent=a,e.appendChild(n),e.appendChild(r)}function showEnhancedStateInfoPanel(e,t){const a=document.getElementById("info-panel");if(!a)return;const n=document.getElementById("info-panel-title"),r=document.getElementById("info-panel-content"),o=document.getElementById("info-panel-link");if(!n||!r||!o)return;const i=getStateFullName(e);n.textContent=`${i} Contracts`,r.innerHTML="",addInfoItem(r,"Total Contract Value",formatCurrency(t));const s=getContractCountForState(e);addInfoItem(r,"Total Contracts",s.toLocaleString());const l=getTopContractorsForState(e,5,"prime");l.length>0&&(addInfoSection(r,"Top Prime Contractors"),l.forEach((e=>addInfoItem(r,e.name,formatCurrency(e.value)))));const c=getTopContractorsForState(e,5,"sub");c.length>0&&(addInfoSection(r,"Top Subcontractors"),c.forEach((e=>addInfoItem(r,e.name,formatCurrency(e.value)))));const d=getTopNaicsForState(e,3);d.length>0&&(addInfoSection(r,"Primary Industry Categories"),d.forEach((e=>addInfoItem(r,`${e.code}`,`${e.desc} (${formatCurrency(e.value)})`))));const u=`https://www.usaspending.gov/state/${i.toLowerCase().replace(/\s+/g,"-")}`;o.href=u,o.style.display="inline-flex",a.classList.add("visible"),a.setAttribute("aria-hidden","false")}function showMapTooltip(e,t,a){const n=d3.select("#tooltip");if(!n.node())return;const r=getTopContractorsForState(t,1);let o=`<h4>${getStateFullName(t)}</h4><p><strong>Total Contract Value:</strong> ${formatCurrency(a)}</p>`;r.length>0&&(o+=`<p><strong>Top Contractor:</strong> ${r[0].name}</p>`);const i=getContractCountForState(t);i>0&&(o+=`<p><strong>Contracts:</strong> ${i}</p>`),o+="<p><em>Click for more details</em></p>",n.html(o).classed("visible",!0).attr("aria-hidden","false"),positionTooltip(n,e)}function getTopContractorsForState(e,t=3,a="all"){if(!rawData||0===rawData.length)return[];const n={};rawData.forEach((t=>{const r=t.place_of_performance_state||t.pop_state||t.prime_award_pop_state||t.subaward_primary_place_of_performance_state_code;if(!r||"string"!=typeof r||r.toUpperCase().trim()!==e)return;const o="number"==typeof t.subaward_amount?t.subaward_amount:parseFloat(String(t.subaward_amount||"0").replace(/[^0-9.-]+/g,""))||0;let i=!0;if(currentSearchTerm){[t.prime_award_awarding_agency_name,t.prime_award_awarding_sub_agency_name,t.prime_award_awarding_office_name,t.prime_awardee_name,t.subawardee_name,t.prime_award_naics_code?.toString(),t.prime_award_naics_description].some((e=>e&&"string"==typeof e&&e.toLowerCase().includes(currentSearchTerm)))||(i=!1)}if(i&&currentSubAgencyFilter&&t.prime_award_awarding_sub_agency_name!==currentSubAgencyFilter&&(i=!1),i&&currentOfficeFilter&&t.prime_award_awarding_office_name!==currentOfficeFilter&&(i=!1),i&&currentNaicsFilter&&t.prime_award_naics_code?.toString()!==currentNaicsFilter&&(i=!1),i&&currentPrimeFilter&&t.prime_awardee_name!==currentPrimeFilter&&(i=!1),i&&currentSubFilter&&t.subawardee_name!==currentSubFilter&&(i=!1),o<=0&&(i=!1),!i)return;const s=t.prime_awardee_name?.trim()||"Unknown Prime",l=t.subawardee_name?.trim()||"Unknown Sub";"all"!==a&&"prime"!==a||"Unknown Prime"===s||(n[s]=(n[s]||0)+o),"all"!==a&&"sub"!==a||"Unknown Sub"===l||(n[l]=(n[l]||0)+o)}));return Object.entries(n).map((([e,t])=>({name:e,value:t}))).sort(((e,t)=>t.value-e.value)).slice(0,t)}function getContractCountForState(e){if(!rawData||0===rawData.length)return 0;const t=new Set;return rawData.forEach((a=>{const n=a.place_of_performance_state||a.pop_state||a.prime_award_pop_state||a.subaward_primary_place_of_performance_state_code;if(!n||"string"!=typeof n||n.toUpperCase().trim()!==e)return;let r=!0;if(currentSearchTerm){[a.prime_award_awarding_agency_name,a.prime_award_awarding_sub_agency_name,a.prime_award_awarding_office_name,a.prime_awardee_name,a.subawardee_name,a.prime_award_naics_code?.toString(),a.prime_award_naics_description].some((e=>e&&"string"==typeof e&&e.toLowerCase().includes(currentSearchTerm)))||(r=!1)}r&&currentSubAgencyFilter&&a.prime_award_awarding_sub_agency_name!==currentSubAgencyFilter&&(r=!1),r&&currentOfficeFilter&&a.prime_award_awarding_office_name!==currentOfficeFilter&&(r=!1),r&&currentNaicsFilter&&a.prime_award_naics_code?.toString()!==currentNaicsFilter&&(r=!1),r&&currentPrimeFilter&&a.prime_awardee_name!==currentPrimeFilter&&(r=!1),r&&currentSubFilter&&a.subawardee_name!==currentSubFilter&&(r=!1);if(("number"==typeof a.subaward_amount?a.subaward_amount:parseFloat(String(a.subaward_amount||"0").replace(/[^0-9.-]+/g,""))||0)<=0&&(r=!1),r){const e=a.subaward_unique_key||a.prime_award_unique_key||`${a.prime_awardee_name}-${a.subawardee_name}-${a.action_date}-${subValue}`;t.add(e)}})),t.size}function getTopNaicsForState(e,t=3){if(!rawData||0===rawData.length)return[];const a={};rawData.forEach((t=>{const n=t.place_of_performance_state||t.pop_state||t.prime_award_pop_state||t.subaward_primary_place_of_performance_state_code;if(!n||"string"!=typeof n||n.toUpperCase().trim()!==e)return;let r=!0;if(currentSearchTerm){[t.prime_award_awarding_agency_name,t.prime_award_awarding_sub_agency_name,t.prime_award_awarding_office_name,t.prime_awardee_name,t.subawardee_name,t.prime_award_naics_code?.toString(),t.prime_award_naics_description].some((e=>e&&"string"==typeof e&&e.toLowerCase().includes(currentSearchTerm)))||(r=!1)}r&&currentSubAgencyFilter&&t.prime_award_awarding_sub_agency_name!==currentSubAgencyFilter&&(r=!1),r&&currentOfficeFilter&&t.prime_award_awarding_office_name!==currentOfficeFilter&&(r=!1),r&&currentPrimeFilter&&t.prime_awardee_name!==currentPrimeFilter&&(r=!1),r&&currentSubFilter&&t.subawardee_name!==currentSubFilter&&(r=!1);const o="number"==typeof t.subaward_amount?t.subaward_amount:parseFloat(String(t.subaward_amount||"0").replace(/[^0-9.-]+/g,""))||0;if(o<=0&&(r=!1),r){const e=t.prime_award_naics_code?.toString().trim()||"Unknown",n=t.prime_award_naics_description?.trim()||"Unknown Description";if("Unknown"===e)return;const r=`${e}`;a[r]||(a[r]={code:e,desc:n,value:0}),a[r].value+=o}}));return Object.values(a).sort(((e,t)=>t.value-e.value)).slice(0,t)}function generateInsights(e,t,a){const n=[];if(!(e&&e.stats&&e.nodes&&e.nodes.prime&&e.nodes.sub&&e.links&&e.links.contractorToSubcontractor&&!(a<=0)))return console.warn("generateInsights: Missing required processedData components."),["Insufficient data available for generating insights."];try{const r=e.unfilteredNodes?.prime?.[0];r&&r.value/a>.15&&n.push(`Prime <strong>${truncateText(r.name,30)}</strong> is associated with over 15% (${formatCurrency(r.value)}) of the total subaward value in this view.`);const o=e.unfilteredNodes?.sub?.[0];o&&o.value/a>.15&&n.push(`Sub <strong>${truncateText(o.name,30)}</strong> received over 15% (${formatCurrency(o.value)}) of the total subaward value in this view.`);const i=e.nodes?.prime||[],s=e.links?.contractorToSubcontractor||[];if(i.length>0&&s.length>0){let e={};s.forEach((t=>{t&&t.source&&t.target&&(e[t.source]||(e[t.source]=new Set),e[t.source].add(t.target))}));let t=0,a=[];if(i.forEach((n=>{const r=e[n.id]?.size||0;r>t?(t=r,a=[n.name]):r===t&&t>0&&a.push(n.name)})),t>0){const e=a.map((e=>`<strong>${truncateText(e,30)}</strong>`)).join(", ");n.push(`${e} worked with the most unique subs (${t}) in this filtered view.`)}}if(t&&t.length>0){const e=[...t].sort(((e,t)=>{const a=e.endDate instanceof Date&&!isNaN(e.endDate)?e.endDate.getTime():1/0,n=t.endDate instanceof Date&&!isNaN(t.endDate)?t.endDate.getTime():1/0;return a<n?-1:a>n?1:(t.amount||0)-(e.amount||0)}));n.push("<strong>Potential Contract Expirations (Next ~6 Mo)</strong>");e.slice(0,3).forEach((e=>{const t=e.permalink&&"#"!==e.permalink&&"string"==typeof e.permalink&&e.permalink.startsWith("http")?`<a href="${e.permalink}" class="detail-link" target="_blank" rel="noopener noreferrer" style="margin-left: 5px;" title="View on USAspending.gov">View</a>`:"";n.push(`- ~${e.endDateStr}: <strong>${truncateText(e.prime,25)}</strong> / ${truncateText(e.sub,25)} (${formatCurrency(e.amount)}) ${t}`)}))}else n.push(`No contracts identified as potentially expiring (> ${formatCurrency(expiringAmountThreshold)}) in the next ~6 months for this agency.`)}catch(e){console.error("Error generating insights:",e),n.push("Could not generate all insights due to an error.")}return n.length>0?n:["No specific insights generated for the current view."]}function displayInsights(e){const t=document.getElementById("insights-list");t&&(t.innerHTML="",e&&0!==e.length?e.slice(0,5).forEach((e=>{const a=document.createElement("li");a.innerHTML=e,t.appendChild(a)})):t.innerHTML='<li class="placeholder">No insights available.</li>')}function updateBreadcrumb(){const e=document.getElementById("breadcrumb");if(e)if(e.innerHTML='<a href="#" data-action="reset">All Data</a>',e.classList.remove("visually-hidden"),e.setAttribute("aria-hidden","false"),currentFocusNode){const t=document.createElement("span");t.className="separator",t.textContent=" › ";const a=document.createElement("span");a.textContent=currentFocusNode.name,e.appendChild(t),e.appendChild(a)}else if(currentMapFocusState){const t=document.createElement("span");t.className="separator",t.textContent=" › ";const a=getStateFullName(currentMapFocusState),n=document.createElement("span");n.textContent=a,e.appendChild(t),e.appendChild(n)}else e.classList.add("visually-hidden"),e.setAttribute("aria-hidden","true")}function handleBreadcrumbClick(e){e.target.closest('a[data-action="reset"]')&&(e.preventDefault(),currentFocusNode=null,currentMapFocusState=null,closeInfoPanel(),d3.select("#map-chart .states path.focused-state").classed("focused-state",!1).attr("stroke","#fff").attr("stroke-width",.5),updateBreadcrumb(),currentVizType?updateVisualization(currentVizType):applyFiltersAndDraw(),updateDataTable())}function debounceMinValueUpdate(){clearTimeout(minValueUpdateTimeout),minValueUpdateTimeout=setTimeout((()=>{updateMinValueFilter()}),250)}function updateMinValueFilter(){const e=document.getElementById("min-value"),t=document.getElementById("min-value-display");if(!e||!t)return;minContractValue=parseInt(e.value),t.textContent=formatCurrency(minContractValue),userChangedMinValue=!0;const a=document.querySelector(".visualization");a&&a.offsetHeight,currentVizType?updateVisualization(currentVizType):(console.warn("currentVizType not set on slider change, defaulting to Sankey update"),applyFiltersAndDraw()),updateDataTable()}function toggleLevelFilter(e){const t=e.currentTarget,a=t.getAttribute("data-level"),n=t.classList.toggle("active");n?activeLevels.push(a):activeLevels=activeLevels.filter((e=>e!==a)),activeLevels.sort(((e,t)=>["agency","subagency","office","prime","sub"].indexOf(e)-["agency","subagency","office","prime","sub"].indexOf(t))),t.setAttribute("aria-pressed",n?"true":"false"),currentVizType?updateVisualization(currentVizType):applyFiltersAndDraw(),updateDataTable(),isTouchDevice()&&window.navigator.vibrate&&window.navigator.vibrate(30)}function changeAgency(){const e=document.getElementById("agency-selector");if(!e)return;const t=e.value;console.log(`Agency changing to: ${t}`),minContractValue=DEFAULT_MIN_VALUE,userChangedMinValue=!1;const a=document.getElementById("min-value"),n=document.getElementById("min-value-display");a&&(a.value=minContractValue),n&&(n.textContent=formatCurrencyWithSuffix(minContractValue)),currentFocusNode=null,currentMapFocusState=null,currentSubAgencyFilter="",currentOfficeFilter="",currentNaicsFilter="",currentPrimeFilter="",currentSubFilter="",currentSearchTerm="";const r=document.getElementById("subagency-filter");r&&(r.value="");const o=document.getElementById("office-filter");o&&(o.value="");const i=document.getElementById("naics-filter");i&&(i.value="");const s=document.getElementById("prime-filter");s&&(s.value="");const l=document.getElementById("sub-filter");l&&(l.value="");const c=document.getElementById("data-search");c&&(c.value="");const d=document.getElementById("search-clear-btn");d&&(d.style.display="none"),d3.select("#map-chart .states path.focused-state").classed("focused-state",!1).attr("stroke","#fff").attr("stroke-width",.5),closeInfoPanel(),updateBreadcrumb(),loadAgencyData(t)}function resetFilters(e=!0){currentSearchTerm="";const t=document.getElementById("data-search");t&&(t.value="");const a=document.getElementById("search-clear-btn");a&&(a.style.display="none"),topNFilterValue=0,currentSubAgencyFilter="";const n=document.getElementById("subagency-filter");n&&(n.value=""),currentOfficeFilter="";const r=document.getElementById("office-filter");r&&(r.value=""),currentNaicsFilter="";const o=document.getElementById("naics-filter");o&&(o.value=""),currentPrimeFilter="";const i=document.getElementById("prime-filter");i&&(i.value=""),currentSubFilter="";const s=document.getElementById("sub-filter");s&&(s.value=""),userChangedMinValue=!1;const l=document.getElementById("min-value"),c=document.getElementById("min-value-display");l&&c&&(minContractValue="choropleth"===currentVizType?CHOROPLETH_MIN_VALUE:DEFAULT_MIN_VALUE,l.value=minContractValue,c.textContent=formatCurrencyWithSuffix(minContractValue)),activeLevels=["agency","subagency","office","prime","sub"],document.querySelectorAll("#level-filters button").forEach((e=>{const t=e.getAttribute("data-level");activeLevels.includes(t)?(e.classList.add("active"),e.setAttribute("aria-pressed","true")):(e.classList.remove("active"),e.setAttribute("aria-pressed","false"))})),currentFocusNode=null,closeInfoPanel(),currentMapFocusState=null,d3.select("#map-chart .states path.focused-state").classed("focused-state",!1).attr("stroke","#fff").attr("stroke-width",.5),updateBreadcrumb(),rawData&&rawData.length>0&&e?(console.log("Reset Filters triggering redraw..."),processData()):e&&(updateActiveFiltersDisplay(),updateDataTable()),e&&showNotification("All filters have been reset.","info")}function toggleTheme(e){e&&e.preventDefault();const t=document.body.classList.toggle("light-mode"),a=document.getElementById("theme-toggle"),n=a?a.querySelector(".material-symbols-outlined"):null;a&&n&&(t?(n.textContent="dark_mode",a.setAttribute("aria-label","Switch to Dark Mode"),a.setAttribute("aria-pressed","false"),updateThemeColor("#F4F2F6")):(n.textContent="light_mode",a.setAttribute("aria-label","Switch to Light Mode"),a.setAttribute("aria-pressed","true"),updateThemeColor("#252327"))),currentVizType?updateVisualization(currentVizType):currentSankeyData&&drawSankeyDiagram(currentSankeyData)}function updateStatsDisplay(){const e=document.getElementById("total-value"),t=document.getElementById("naics-donut-chart"),a=document.getElementById("top-primes-bar-chart"),n=document.getElementById("top-subs-bar-chart"),r=document.getElementById("prime-chart-title"),o=document.getElementById("sub-chart-title");if(!processedData||!processedData.stats||!processedData.nodes)return console.warn("Stats display update skipped: processedData not fully ready."),e&&(e.textContent="$0"),t&&(t.innerHTML='<span class="chart-placeholder">No data</span>'),a&&(a.innerHTML='<span class="chart-placeholder">No data</span>'),n&&(n.innerHTML='<span class="chart-placeholder">No data</span>'),r&&(r.innerHTML='0 Primes w/ Subs <span style="font-weight:normal; font-size:0.8em;">(Top 5 by Value)</span>'),void(o&&(o.innerHTML='0 Total Subs <span style="font-weight:normal; font-size:0.8em;">(Top 5 by Value)</span>'));e?e.textContent=formatCurrencyWithSuffix(processedData.stats.totalContractValue):console.warn("Stats element 'total-value' not found."),t&&processedData.stats.filteredNaicsBreakdown&&"function"==typeof drawNaicsDonut&&drawNaicsDonut(processedData.stats.filteredNaicsBreakdown,"naics-donut-chart",5),a&&processedData.nodes.prime&&("function"==typeof drawTopNBarChart?drawTopNBarChart(processedData.nodes.prime,"top-primes-bar-chart","prime-chart-title",processedData.stats.uniquePrimeContractorCount,"prime",5):(console.error("drawTopNBarChart function is not defined."),a&&(a.innerHTML='<span class="chart-placeholder">Chart Error</span>'),r&&(r.innerHTML=`${processedData.stats.uniquePrimeContractorCount.toLocaleString()} Primes w/ Subs <span style="font-weight:normal; font-size:0.8em;">(Top 5 by Filtered Value)</span>`))),n&&processedData.nodes.sub&&("function"==typeof drawTopNBarChart?drawTopNBarChart(processedData.nodes.sub,"top-subs-bar-chart","sub-chart-title",processedData.stats.uniqueSubcontractorCount,"sub",5):(console.error("drawTopNBarChart function is not defined."),n&&(n.innerHTML='<span class="chart-placeholder">Chart Error</span>'),o&&(o.innerHTML=`${processedData.stats.uniqueSubcontractorCount.toLocaleString()} Total Subcontractors <span style="font-weight:normal; font-size:0.8em;">(Top 5 by Filtered Value)</span>`)))}function truncateText(e,t){return e?t<=3?e.length>t?e.substring(0,t):e:e.length>t?e.substring(0,t-3)+"...":e:""}function formatCurrency(e){return"number"!=typeof e||isNaN(e)?"$?":new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(e)}function truncateText(e,t){return e?t<=3?e.length>t?e.substring(0,t):e:e.length>t?e.substring(0,t-3)+"...":e:""}function loadAgencyData(e){showLoading(),currentAgency=e,currentFocusNode=null,rawData=[],processedData=null,currentSankeyData=null;const t=`https://subhoodata.s3.amazonaws.com/data/${e}.csv`;Papa.parse(t,{download:!0,header:!0,skipEmptyLines:!0,dynamicTyping:!0,complete:function(a){if(console.log(`CSV parsing complete for ${e}. Rows: ${a.data.length}`),a.errors?.length>0&&(console.warn("CSV Errors:",a.errors),showNotification(`CSV parsed with ${a.errors.length} errors.`,"warning")),!a.data||0===a.data.length)return console.error(`No data loaded from ${t}`),rawData=[],processedData=null,processData(),hideLoading(),void showNotification(`No data found for ${e}.`,"error");rawData=a.data,populateFilterDropdowns(),processData(),hideLoading()},error:function(t,a){console.error(`Error loading CSV: ${a}`,t),rawData=[],processedData=null,processData(),hideLoading(),showNotification(`Failed to load data for ${e}.`,"error")}})}function processData(){if(!rawData||0===rawData.length)return console.warn("processData called with no rawData."),processedData={nodes:{agency:[],subagency:[],office:[],prime:[],sub:[]},links:{agencyToSub:[],subToOffice:[],officeToContractor:[],contractorToSubcontractor:[]},stats:{totalContractValue:0,totalPrimeContracts:0,totalSubContracts:0,primaryNaics:{code:"N/A",desc:"",value:0},uniquePrimeContractorCount:0,uniqueSubcontractorCount:0,filteredNaicsBreakdown:[]},unfilteredNodes:{prime:[],sub:[]},unfilteredNaics:[]},updateStatsDisplay(),updateDataTable(),displayTopNTable([],"top-primes-container","Top Prime Contractors",10),displayTopNTable([],"top-subs-container","Top Subcontractors",10),displayNaicsTable([],"naics-container","Top NAICS Codes",5),void(currentVizType&&updateVisualization(currentVizType));const e=new Map,t=new Map,a=new Map;rawData.forEach((n=>{const r=n.prime_awardee_name?.trim()||"Unknown Prime Contractor",o=n.subawardee_name?.trim()||"Unknown Subcontractor",i="number"==typeof n.subaward_amount?n.subaward_amount:parseFloat(String(n.subaward_amount||"0").replace(/[^0-9.-]+/g,""))||0,s=n.prime_award_naics_code?.toString().trim()||"Unknown",l=n.prime_award_naics_description?.trim()||"Unknown";if(!(i<=0)&&("Unknown Prime Contractor"!==r&&(e.has(r)||e.set(r,{id:`prime-${r}`,name:r,type:"prime",value:0}),e.get(r).value+=i),"Unknown Subcontractor"!==o&&(t.has(o)||t.set(o,{id:`sub-${o}`,name:o,type:"sub",value:0}),t.get(o).value+=i),s&&"Unknown"!==s&&"N/A"!==s&&""!==s)){const e=`${s} - ${l||"No Description"}`;a.set(e,(a.get(e)||0)+i)}}));const n=Array.from(e.values()).sort(((e,t)=>t.value-e.value)),r=Array.from(t.values()).sort(((e,t)=>t.value-e.value)),o=Array.from(a,(([e,t])=>{const a=e.split(" - ");return{code:a[0],desc:a.slice(1).join(" - ").trim()||"No Description",value:t}})).sort(((e,t)=>t.value-e.value)),i=getFilteredTableData(),s=new Map,l=new Map,c=new Map,d=new Map,u=new Map,p=new Map,m=new Map,f=new Map,g=new Map;let y=0,h=new Set,b=new Set;const w=new Set,v=new Set,_=new Map;i.forEach((e=>{const t=e.prime_award_awarding_agency_name?.trim(),a=e.prime_award_awarding_sub_agency_name?.trim(),n=e.prime_award_awarding_office_name?.trim(),r=e.prime_awardee_name?.trim(),o=e.subawardee_name?.trim(),i=t||"Unknown Agency",C=a||"Unknown Sub-Agency",S=n||"Unknown Office",k=r||"Unknown Prime Contractor",x=o||"Unknown Subcontractor",A="number"==typeof e.subaward_amount?e.subaward_amount:parseFloat(String(e.subaward_amount||"0").replace(/[^0-9.-]+/g,""))||0,E="number"==typeof e.prime_award_amount?e.prime_award_amount:parseFloat(String(e.prime_award_amount||"0").replace(/[^0-9.-]+/g,""))||0,T=e.usaspending_permalink||"#",D=e.prime_award_naics_code?.toString().trim()||"Unknown",N=e.prime_award_naics_description?.trim()||"Unknown Description",$=e.place_of_performance_state||e.pop_state||e.prime_award_pop_state||"Unknown";if(A<=0||"Unknown Agency"===i||"Unknown Sub-Agency"===C||"Unknown Office"===S||"Unknown Prime Contractor"===k||"Unknown Subcontractor"===x)return;y+=A,h.add(`${k}|${S}`),b.add(`${x}|${k}`),"Unknown Prime Contractor"!==k&&w.add(k),"Unknown Subcontractor"!==x&&v.add(x),s.has(i)||s.set(i,{id:`agency-${i}`,name:i,type:"agency",value:0,acronym:extractAcronym(i)}),s.get(i).value+=A;const F=s.get(i).name;"Unknown Sub-Agency"!==C&&(l.has(C)||l.set(C,{id:`subagency-${C}`,name:C,type:"subagency",value:0,parent:F,acronym:extractAcronym(C)}),l.get(C).value+=A);const I=l.has(C)?l.get(C).name:"Unknown Sub-Agency";"Unknown Office"!==S&&"Unknown Sub-Agency"!==I&&(c.has(S)||c.set(S,{id:`office-${S}`,name:S,type:"office",value:0,parent:I}),c.get(S).value+=A);const L=c.has(S)?c.get(S).name:"Unknown Office";"Unknown Prime Contractor"!==k&&"Unknown Office"!==L&&(d.has(k)||d.set(k,{id:`prime-${k}`,name:k,type:"prime",value:0,parent:L,popState:$}),d.get(k).value+=A);const M=d.has(k)?d.get(k).name:"Unknown Prime Contractor";"Unknown Subcontractor"!==x&&"Unknown Prime Contractor"!==M&&(u.has(x)||u.set(x,{id:`sub-${x}`,name:x,type:"sub",value:0,parent:M,popState:$}),u.get(x).value+=A);const V=`agency-${F}`,P="Unknown Sub-Agency"!==C?`subagency-${I}`:null,B="Unknown Office"!==S?`office-${L}`:null,z="Unknown Prime Contractor"!==k?`prime-${M}`:null,U="Unknown Subcontractor"!==x?`sub-${x}`:null;if(V&&P){const e=`${V}|${P}`;p.has(e)||p.set(e,{source:V,target:P,value:0,details:{sourceType:"agency",targetType:"subagency",permalink:T}}),p.get(e).value+=A}if(P&&B){const e=`${P}|${B}`;m.has(e)||m.set(e,{source:P,target:B,value:0,details:{sourceType:"subagency",targetType:"office",permalink:T}}),m.get(e).value+=A}if(B&&z){const e=`${B}|${z}`;f.has(e)||f.set(e,{source:B,target:z,value:0,details:{sourceType:"office",targetType:"prime",naicsCode:D,naicsDesc:N,permalink:T,popState:$}}),f.get(e).value+=A}if(z&&U){const e=`${z}|${U}`,t=E>0?(A/E*100).toFixed(2)+"%":"N/A";g.has(e)||g.set(e,{source:z,target:U,value:0,details:{sourceType:"prime",targetType:"sub",naicsCode:D,naicsDesc:N,subValue:A,primeValue:E,percentage:t,permalink:T,popState:$}}),g.get(e).value+=A}if(D&&"Unknown"!==D&&"N/A"!==D&&""!==D){const e=`${D} - ${N}`;_.set(e,(_.get(e)||0)+A)}}));const C=Array.from(_,(([e,t])=>{const a=e.split(" - ");return{code:a[0],desc:a.slice(1).join(" - ").trim()||"No Description",value:t}})).sort(((e,t)=>t.value-e.value));let S={code:"N/A",desc:"",value:0};C.length>0&&(S=C[0]),processedData={nodes:{agency:Array.from(s.values()),subagency:Array.from(l.values()).sort(((e,t)=>t.value-e.value)),office:Array.from(c.values()).sort(((e,t)=>t.value-e.value)),prime:Array.from(d.values()).sort(((e,t)=>t.value-e.value)),sub:Array.from(u.values()).sort(((e,t)=>t.value-e.value))},links:{agencyToSub:Array.from(p.values()),subToOffice:Array.from(m.values()),officeToContractor:Array.from(f.values()),contractorToSubcontractor:Array.from(g.values())},stats:{totalContractValue:y,totalPrimeContracts:h.size,totalSubContracts:b.size,primaryNaics:S,filteredNaicsBreakdown:C,uniquePrimeContractorCount:w.size,uniqueSubcontractorCount:v.size},unfilteredNodes:{prime:n,sub:r},unfilteredNaics:o},updateStatsDisplay(),updateDataTable(),displayTopNTable(processedData.unfilteredNodes.prime,"top-primes-container","Top Prime Contractors",10),displayTopNTable(processedData.unfilteredNodes.sub,"top-subs-container","Top Subcontractors",10),displayNaicsTable(processedData.unfilteredNaics,"naics-container","Top NAICS Codes",7),updateActiveFiltersDisplay(),"function"==typeof updateExpiringContracts?updateExpiringContracts(rawData):console.warn("updateExpiringContracts function not defined yet.");displayInsights(generateInsights(processedData,allExpiringContracts,processedData.stats.totalContractValue)),currentVizType?updateVisualization(currentVizType):applyFiltersAndDraw()}function setupStatsCardTooltips(){const e=document.querySelectorAll(".stats-card"),t=d3.select("#tooltip");t.node()?e.forEach((e=>{e.addEventListener("mouseover",(function(e){const a=this.querySelector("h4"),n=this.querySelector("p");this.querySelector(".stats-chart-container");if(!a)return;const r=a.textContent;let o=n?n.textContent:"",i=`<h4>${r}</h4>`;if(n&&o&&(i+=`<p><strong>Value:</strong> ${o}</p>`),processedData&&processedData.stats)if(r.includes("NAICS")&&processedData.stats.primaryNaics&&"N/A"!==processedData.stats.primaryNaics.code){const e=processedData.stats.primaryNaics,t=processedData.stats.totalContractValue||0,a=t>0?(e.value/t*100).toFixed(1):0;i=`<h4>${e.code} - ${e.desc||"Primary NAICS"}</h4>`,i+=`<p><strong>Value:</strong> ${formatCurrency(e.value)} (${a}%)</p>`,processedData.stats.filteredNaicsBreakdown&&processedData.stats.filteredNaicsBreakdown.length>1&&(i+='<p style="margin-top: 5px; border-top: 1px solid var(--color-outline-variant); padding-top: 5px;"><strong>Other Top NAICS:</strong><br/>',processedData.stats.filteredNaicsBreakdown.slice(1,4).forEach((e=>{i+=`- ${e.code} (${formatCurrency(e.value)})<br/>`})),i+="</p>")}else if(r.includes("Prime")&&processedData.nodes?.prime){i=`<h4>${a.innerHTML}</h4>`;const e=processedData.nodes.prime.slice(0,3);e.length>0&&(i+='<p style="margin-top: 5px; border-top: 1px solid var(--color-outline-variant); padding-top: 5px;"><strong>Top by Value:</strong><br/>',e.forEach((e=>{i+=`- ${e.name} (${formatCurrency(e.value)})<br/>`})),i+="</p>")}else if(r.includes("Subcontractor")&&processedData.nodes?.sub){i=`<h4>${a.innerHTML}</h4>`;const e=processedData.nodes.sub.slice(0,3);e.length>0&&(i+='<p style="margin-top: 5px; border-top: 1px solid var(--color-outline-variant); padding-top: 5px;"><strong>Top by Value:</strong><br/>',e.forEach((e=>{i+=`- ${e.name} (${formatCurrency(e.value)})<br/>`})),i+="</p>")}t.html(i).classed("visible",!0).attr("aria-hidden","false"),positionTooltip(t,e)})),e.addEventListener("mousemove",(e=>{t.classed("visible")&&positionTooltip(t,e)})),e.addEventListener("mouseout",(()=>{hideTooltip()}))})):console.warn("Tooltip element #tooltip not found")}async function discoverAgencies(){const e=document.getElementById("agency-selector");if(!e)return;e.innerHTML="";const t=[{value:"army",label:"Army"},{value:"navy",label:"Navy"},{value:"usmc",label:"Marine Corps"},{value:"airforce",label:"Air Force"},{value:"dla",label:"DLA"},{value:"disa",label:"DISA"},{value:"mda",label:"MDA"},{value:"socom",label:"USSOCOM"},{value:"uscc",label:"Cyber Command"},{value:"md",label:"Maryland"},{value:"hhs",label:"HHS"},{value:"va",label:"VA"},{value:"dhs",label:"DHS"},{value:"cbp",label:"CBP"},{value:"treasury",label:"Treasury"},{value:"doj",label:"Dept of Justice"},{value:"dol",label:"Dept of Labor"},{value:"doc",label:"Dept of Commerce"},{value:"doe",label:"Dept of Energy"},{value:"ssa",label:"Social Security"},{value:"dos",label:"Dept of State"},{value:"dot",label:"Dept of Transportation"},{value:"usda",label:"USDA"},{value:"gsa",label:"GSA"},{value:"nasa",label:"NASA"}];if(t.length>0){t.forEach((t=>{const a=document.createElement("option");a.value=t.value,a.textContent=t.label,e.appendChild(a)}));const a=t.find((e=>e.value===currentAgency))?currentAgency:t[0].value;currentAgency=a,e.value=a,loadAgencyData(a)}else console.error("No agencies available to populate dropdown.")}function showLoading(){const e=document.getElementById("loading");e&&(e.style.display="flex",e.setAttribute("aria-hidden","false"))}function hideLoading(){const e=document.getElementById("loading");e&&(e.style.display="none",e.setAttribute("aria-hidden","true"))}function getTopPerformanceStates(e=3){if(!rawData||0===rawData.length)return[];const t={};rawData.forEach((e=>{const a="number"==typeof e.subaward_amount?e.subaward_amount:parseFloat(String(e.subaward_amount||"0").replace(/[^0-9.-]+/g,""))||0;if(a<CHOROPLETH_MIN_VALUE)return;const n=e.subaward_primary_place_of_performance_state_code||e.place_of_performance_state||e.pop_state||e.prime_award_pop_state;if(!n||2!==n.length)return;const r=n.toUpperCase();t[r]=(t[r]||0)+a}));return Object.entries(t).map((([e,t])=>({code:e,name:getStateFullName(e),value:t}))).sort(((e,t)=>t.value-e.value)).slice(0,e)}function displayTopNTable(e,t,a,n=5){const r=document.getElementById(t);if(!r)return void console.error(`Container element not found: #${t}`);const o=(Array.isArray(e)?e:[]).slice(0,n);let i=`<h3>${a} for ${getAgencyDisplayName()}</h3>`;if(0===o.length)i+='<p class="empty-message">No data available.</p>';else{const e=o.length>0?o[0].value:1;i+='<table class="analysis-table"><thead><tr><th>Rank</th><th>Name</th><th>Value</th><th class="relative-value-header">Relative Value</th></tr></thead><tbody>',o.forEach(((t,a)=>{const n=e>0?Math.min(100,t.value/e*100):0;i+=`<tr>\n                            <td>${a+1}</td>\n                            <td>${truncateText(t.name||"N/A",40)}</td>\n                            <td>${formatCurrency(t.value||0)}</td>\n                            <td class="spark-bar-cell"> \n                                <div class="spark-bar" style="width: ${n}%;" title="${formatCurrency(t.value||0)}"></div>\n                            </td>\n                          </tr>`})),i+="</tbody></table>"}r.innerHTML=i}function displayNaicsTable(e,t,a,n=5){const r=document.getElementById(t);if(!r)return void console.error(`Container element not found: #${t}`);const o=(Array.isArray(e)?e:[]).slice(0,n);let i=`<h3>${a} for ${getAgencyDisplayName()}</h3>`;if(0===o.length)i+='<p class="empty-message">No NAICS data available.</p>';else{const e=o.length>0?o[0].value:1;i+='<table class="analysis-table"><thead><tr><th>Rank</th><th>NAICS</th><th>Value</th><th class="relative-value-header">Relative Value</th></tr></thead><tbody>',o.forEach(((t,a)=>{const n=e>0?Math.min(100,t.value/e*100):0;i+=`<tr>\n                            <td>${a+1}</td>\n \n                            <td>${t.code||"N/A"}&nbsp;-&nbsp;${t.desc?`<span class="naics-desc">${truncateText(t.desc,60)}</span>`:""}</td>\n                            <td>${formatCurrency(t.value||0)}</td>\n                            <td class="spark-bar-cell">\n                                <div class="spark-bar" style="width: ${n}%;" title="${formatCurrency(t.value||0)}"></div>\n                            </td>\n                          </tr>`})),i+="</tbody></table>"}r.innerHTML=i}function aggregateExpiringValueByMonth(e){const t=new Map,a=new Date;a.setDate(1),a.setHours(0,0,0,0);const n=new Date(a);n.setMonth(a.getMonth()+6);for(let e=0;e<6;e++){const n=new Date(a);n.setMonth(a.getMonth()+e);const r=`${n.toLocaleString("default",{month:"short"})} ${n.getFullYear()}`;t.set(r,0)}e.forEach((e=>{if(e.endDate instanceof Date&&!isNaN(e.endDate)&&e.endDate>=a&&e.endDate<n){const a=`${e.endDate.toLocaleString("default",{month:"short"})} ${e.endDate.getFullYear()}`;t.has(a)&&t.set(a,t.get(a)+e.amount)}}));return Array.from(t.keys()).sort(((e,t)=>new Date(e)-new Date(t))).map((e=>({month:e,value:t.get(e)})))}function drawExpiringValueByMonthChart(e,t){const a=d3.select(`#${t}`);if(a.html(""),!e||0===e.length)return void a.html('<span class="chart-placeholder" style="display: block; text-align: center; padding: 20px; font-style: italic;">No expiring contracts found in the next 6 months.</span>');const n=a.node();if(!n)return;const r=20,o=30,i=40,s=70,l=n.clientWidth-s-o,c=200-r-i;if(l<=0||c<=0)return console.warn(`Container #${t} too small for chart.`),void a.html('<span class="chart-placeholder" style="display: block; text-align: center; padding: 10px;">Chart area too small</span>');const d=a.append("svg").attr("width",l+s+o).attr("height",c+r+i).append("g").attr("transform",`translate(${s},${r})`),u=d3.scaleBand().domain(e.map((e=>e.month))).range([0,l]).padding(.2),p=d3.scaleLinear().domain([0,d3.max(e,(e=>e.value))||1]).nice().range([c,0]),m=d3.axisBottom(u),f=d3.axisLeft(p).ticks(5).tickFormat((e=>formatCurrencyWithSuffix(e)));d.append("g").attr("class","x-axis").attr("transform",`translate(0,${c})`).call(m).selectAll("text").style("text-anchor","end").attr("dx","-.8em").attr("dy",".15em").attr("transform","rotate(-30)").style("font-size","9px").style("fill","var(--color-on-surface-variant)"),d.append("g").attr("class","y-axis").call(f).selectAll("text").style("font-size","10px").style("fill","var(--color-on-surface-variant)"),d.selectAll(".domain").attr("stroke","var(--color-outline-variant)"),d.selectAll(".tick line").attr("stroke","var(--color-outline-variant)");const g=d3.select("#tooltip");d.selectAll(".bar").data(e).enter().append("rect").attr("class","bar").attr("x",(e=>u(e.month))).attr("y",(e=>p(e.value))).attr("width",u.bandwidth()).attr("height",(e=>c-p(e.value))).attr("fill","var(--app-accent-color)").style("cursor","pointer").on("mouseover",(function(e,t){d3.select(this).attr("fill","var(--accent-dark)"),g.node()&&(g.html(`<h4>${t.month}</h4><p>Expiring Value: <strong>${formatCurrency(t.value)}</strong></p>`).classed("visible",!0).attr("aria-hidden","false"),positionTooltip(g,e))})).on("mousemove",(function(e){g.node()&&g.classed("visible")&&positionTooltip(g,e)})).on("mouseout",(function(){d3.select(this).attr("fill","var(--app-accent-color)"),g.node()&&hideTooltip()}))}function updateExpiringContracts(e){const t=document.getElementById("expiring-table-content"),a=document.getElementById("load-more-expiring"),n=document.getElementById("export-expiring-csv"),r=document.getElementById("expiring-title");if(r){const e=getAgencyDisplayName();r.textContent=`Expiring ${e} Contracts`}else console.warn("Expiring contracts title element (#expiring-title) not found.");if(!t||!a||!n)return console.error("Expiring contracts UI elements not found. Cannot update list."),void(t&&(t.innerHTML='<p class="empty-message">Error: UI element missing.</p>'));if(t.innerHTML='<p class="empty-message">Checking data...</p>',a.style.display="none",n.style.display="none",!e||0===e.length)return void(t.innerHTML='<p class="empty-message">No contract data available.</p>');const o=new Date;o.setHours(0,0,0,0);const i=new Date;i.setMonth(o.getMonth()+6),i.setHours(23,59,59,999);try{allExpiringContracts=e.filter((e=>{const t=e.prime_award_period_of_performance_potential_end_date;if(("number"==typeof e.subaward_amount?e.subaward_amount:0)<expiringAmountThreshold)return!1;if(!t||"string"!=typeof t)return!1;let a;return a=t.match(/^\d{4}-\d{2}-\d{2}$/)?new Date(t+"T00:00:00"):(t.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/),new Date(t)),!isNaN(a)&&(a>=o&&a<=i)})).map((e=>{const t=e.prime_award_period_of_performance_potential_end_date;let a,n="Invalid Date";return a=t.match(/^\d{4}-\d{2}-\d{2}$/)?new Date(t+"T00:00:00"):(t.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/),new Date(t)),isNaN(a)||(n=a.toLocaleDateString()),{prime:e.prime_awardee_name||"N/A",sub:e.subawardee_name||"N/A",amount:"number"==typeof e.subaward_amount?e.subaward_amount:0,endDate:isNaN(a)?null:a,endDateStr:n,agency:e.prime_award_awarding_agency_name||"N/A",permalink:e.usaspending_permalink||"#",subAgency:e.prime_award_awarding_sub_agency_name||"N/A",office:e.prime_award_awarding_office_name||"N/A",naicsCode:e.prime_award_naics_code||"N/A",subAwardDesc:e.subaward_description||"N/A"}})).filter((e=>null!==e.endDate)).sort(compareValues(expiringSortKey,expiringSortDirection));try{drawExpiringValueByMonthChart(aggregateExpiringValueByMonth(allExpiringContracts),"expiring-value-by-month-chart")}catch(e){console.error("Error creating expiring value chart:",e),d3.select("#expiring-value-by-month-chart").html('<span class="chart-placeholder error">Could not load chart</span>')}displayedExpiringCount=0,t.innerHTML="",displayExpiringContracts(),allExpiringContracts.length>0?(n.style.display="inline-flex",n.disabled=!1):(n.style.display="none",n.disabled=!0)}catch(e){console.error("Error processing expiring contracts:",e),t.innerHTML='<p class="empty-message">Error processing expiring contracts data.</p>',n.style.display="none"}}document.addEventListener("DOMContentLoaded",(async function(){window.appInitialized=!1;try{document.getElementById("theme-toggle").addEventListener("click",toggleTheme),document.getElementById("agency-selector").addEventListener("change",changeAgency),document.getElementById("min-value").addEventListener("input",debounceMinValueUpdate),document.getElementById("reset-filters").addEventListener("click",(()=>resetFilters(!0))),document.getElementById("info-panel-close").addEventListener("click",closeInfoPanel),document.getElementById("breadcrumb").addEventListener("click",handleBreadcrumbClick);function e(){const e=document.querySelectorAll(".filter-row"),t=window.innerWidth<600;e.forEach((e=>{e.querySelectorAll(".filter-column").forEach((e=>{e.style.width=t?"100%":"calc(50% - 4px)",e.style.marginBottom=t?"8px":"0"}))}))}document.querySelectorAll("#level-filters button").forEach((e=>{e.addEventListener("click",toggleLevelFilter)})),document.querySelectorAll(".filter-section > summary").forEach((e=>{e.addEventListener("click",(function(t){this.parentElement.getAttribute("data-section")||e.querySelector("h3")}))}));const t=document.getElementById("share-button");t?t.addEventListener("click",(async()=>{const e=window.location.href,t={title:document.title,text:"Check out Subhoo - Federal Subcontractor Intelligence!",url:e};if(navigator.share)try{await navigator.share(t)}catch(e){"AbortError"!==e.name&&(console.error("Error sharing:",e),showNotification(`Could not share: ${e.message}`,"error"))}else{console.warn("Web Share API not supported. Attempting to copy URL to clipboard.");try{await navigator.clipboard.writeText(e),showNotification("Link copied to clipboard!","info")}catch(e){console.error("Failed to copy URL to clipboard:",e),showNotification("Sharing not supported & failed to copy link. Please copy the URL manually.","warning")}}})):console.warn("Share button element (#share-button) not found when attaching listener.");const a=document.getElementById("export-expiring-csv");a&&a.addEventListener("click",exportExpiringContractsCSV),e(),window.addEventListener("resize",e),setupVisualizationToggle(),setupResponsiveVisualization(),setTimeout(setupStatsCardTooltips,500),addCssFixes(),setupEnhancedFilters(),restoreFilterSectionStates();const n=document.getElementById("load-more-expiring");n&&n.addEventListener("click",loadMoreExpiringContracts)}catch(r){console.error("Error attaching initial event listeners:",r)}initializeColorScale(),await discoverAgencies(),window.appInitialized=!0}));const expiringTableColumns=[{key:"endDateStr",header:"Potential End",sortable:!0,dataKey:"endDate"},{key:"subAgency",header:"Sub Agency",sortable:!0,truncate:30},{key:"office",header:"Office",sortable:!0,truncate:30},{key:"prime",header:"Prime Contractor",sortable:!0,truncate:35},{key:"sub",header:"Subcontractor",sortable:!0,truncate:35},{key:"amount",header:"Sub Amount",sortable:!0,align:"right",format:"currency"},{key:"subAwardDesc",header:"Sub Description",sortable:!1,truncate:50},{key:"naicsCode",header:"NAICS",sortable:!0},{key:"permalink",header:"USAspending Link",sortable:!1,align:"center",format:"link"}];function displayExpiringContracts(){const e=document.getElementById("expiring-table-content"),t=document.getElementById("load-more-expiring"),a=document.getElementById("export-expiring-csv");if(!e||!t||!a)return console.error("Missing UI elements for displayExpiringContracts."),void(e&&(e.innerHTML='<p class="empty-message">Error: UI element missing.</p>'));const n=0===displayedExpiringCount?itemsPerLoad:displayedExpiringCount,r=allExpiringContracts.slice(0,n);let o="";0===r.length&&0===displayedExpiringCount?(o=`<p class="empty-message">No contracts found potentially expiring > ${formatCurrency(expiringAmountThreshold)} in the next 6 months.</p>`,t.style.display="none",a.style.display="none",a.disabled=!0):0===r.length&&displayedExpiringCount>0?(console.warn("displayExpiringContracts called with 0 items to display but non-zero displayed count."),o=e.innerHTML):(o='<table class="expiring-contracts-table"><thead><tr>',expiringTableColumns.forEach((e=>{let t="",a="",n=e.header;e.align&&(t+=` align-${e.align}`),e.sortable&&(t+=" sortable",a+=` data-sort-key="${e.dataKey||e.key}"`,(e.dataKey||e.key)===expiringSortKey&&(t+=` sorted-${expiringSortDirection}`)),o+=`<th class="${t.trim()}" ${a}>${n}</th>`})),o+="</tr></thead><tbody>",r.forEach((e=>{o+="<tr>",expiringTableColumns.forEach((t=>{let a=e[t.key]??"N/A",n=t.align?`align-${t.align}`:"";const r="string"==typeof e[t.key]||"number"==typeof e[t.key]?`title="${String(e[t.key]).replace(/"/g,"&quot;")}"`:"";if("currency"===t.format)a=formatCurrency(a),n+=" amount";else if("link"===t.format){const e=a&&"#"!==a&&"string"==typeof a&&a.startsWith("http");a=e?`<a href="${a}" class="detail-link" target="_blank" rel="noopener noreferrer" title="View on USAspending.gov">View</a>`:"N/A",n+=" align-center"}else t.truncate&&"function"==typeof truncateText&&(a=truncateText(String(a),t.truncate)),n+=` cell-${t.key}`;o+=`<td class="${n.trim()}" ${r}>${a}</td>`})),o+="</tr>"})),o+="</tbody></table>",displayedExpiringCount=r.length,allExpiringContracts.length>displayedExpiringCount?(t.textContent=`Load More (${allExpiringContracts.length-displayedExpiringCount} remaining)`,t.style.display="inline-flex",t.disabled=!1):t.style.display="none",a.style.display="inline-flex",a.disabled=!1),e.innerHTML=o,attachExpiringTableSortListener()}function loadMoreExpiringContracts(){const e=document.getElementById("load-more-expiring"),t=document.querySelector("#expiring-table-content .expiring-contracts-table tbody");if(!t)return console.error("Cannot find expiring contracts table body to append rows."),void(e&&(e.style.display="none"));if(!e||allExpiringContracts.length<=displayedExpiringCount)return console.warn("Load More called, but no more items or button not found."),void(e&&(e.style.display="none"));e.disabled=!0,e.textContent="Loading...";const a=displayedExpiringCount,n=a+50,r=allExpiringContracts.slice(a,n);if(0===r.length)return e.style.display="none",void(e.disabled=!1);const o=r.map((e=>{let t="<tr>";return expiringTableColumns.forEach((a=>{let n=e[a.key]??"N/A",r=a.align?`align-${a.align}`:"";const o="string"==typeof e[a.key]||"number"==typeof e[a.key]?`title="${String(e[a.key]).replace(/"/g,"&quot;")}"`:"";if("currency"===a.format)n=formatCurrency(n),r+=" amount";else if("link"===a.format){const e=n&&"#"!==n&&"string"==typeof n&&n.startsWith("http");n=e?`<a href="${n}" class="detail-link" target="_blank" rel="noopener noreferrer" title="View on USAspending.gov">View</a>`:"N/A",r+=" align-center"}else a.truncate&&"function"==typeof truncateText&&(n=truncateText(String(n),a.truncate)),r+=` cell-${a.key}`;t+=`<td class="${r.trim()}" ${o}>${n}</td>`})),t+="</tr>",t})).join("");t.insertAdjacentHTML("beforeend",o),displayedExpiringCount=Math.min(n,allExpiringContracts.length),allExpiringContracts.length>displayedExpiringCount?(e.textContent=`Load More (${allExpiringContracts.length-displayedExpiringCount} remaining)`,e.disabled=!1):e.style.display="none"}function handleExpiringHeaderClick(e){const t=e.target.closest("th.sortable");if(!t)return;const a=t.dataset.sortKey;a&&(expiringSortKey===a?expiringSortDirection="asc"===expiringSortDirection?"desc":"asc":(expiringSortKey=a,expiringSortDirection="asc"),allExpiringContracts.sort(compareValues(expiringSortKey,expiringSortDirection)),displayedExpiringCount=0,displayExpiringContracts())}function attachExpiringTableSortListener(){const e=document.getElementById("expiring-table-content");e&&(e.removeEventListener("click",handleExpiringHeaderClick),e.addEventListener("click",handleExpiringHeaderClick))}function exportExpiringContractsCSV(){if(!allExpiringContracts||0===allExpiringContracts.length)return void showNotification("No expiring contracts data to export.","warning");const e=[{key:"endDateStr",header:"Potential End Date"},{key:"agency",header:"Awarding Agency"},{key:"subAgency",header:"Awarding Sub Agency"},{key:"office",header:"Awarding Office"},{key:"prime",header:"Prime Contractor Name"},{key:"sub",header:"Subcontractor Name"},{key:"amount",header:"Subaward Amount"},{key:"subAwardDesc",header:"Subaward Description"},{key:"naicsCode",header:"NAICS Code"},{key:"permalink",header:"USAspending Link"}],t=e=>{if(null==e)return"";const t=String(e);return t.includes('"')||t.includes(",")||t.includes("\n")?`"${t.replace(/"/g,'""')}"`:t},a=[e.map((e=>t(e.header))).join(","),...allExpiringContracts.map((a=>e.map((e=>{let n=a[e.key];return"amount"===e.key&&"number"==typeof n?n:t(n)})).join(",")))].join("\n"),n=new Blob(["\ufeff"+a],{type:"text/csv;charset=utf-8;"}),r=URL.createObjectURL(n),o=document.createElement("a"),i=(new Date).toISOString().slice(0,10);o.setAttribute("href",r),o.setAttribute("download",`expiring_contracts_${currentAgency}_${i}.csv`),o.style.visibility="hidden",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(r),showNotification("Expiring contracts CSV export started.","info")}function showNotification(e,t="info"){let a=document.getElementById("notification-container");a||(a=document.createElement("div"),a.id="notification-container",Object.assign(a.style,{position:"fixed",top:"10px",right:"10px",zIndex:"1000",maxWidth:"90vw"}),document.body.appendChild(a));const n=document.createElement("div");n.className=`notification ${t}`,n.innerHTML=`<div class="notification-content">${e}</div><button class="notification-close" aria-label="Dismiss">&times;</button>`,Object.assign(n.style,{backgroundColor:"error"===t?"var(--md-sys-color-error-container)":"var(--md-sys-color-primary-container)",color:"error"===t?"var(--md-sys-color-on-error-container)":"var(--md-sys-color-on-primary-container)",padding:"10px 16px",marginBottom:"10px",borderRadius:"8px",boxShadow:"var(--md-sys-elevation-2)",display:"flex",justifyContent:"space-between",alignItems:"center",animation:"notification-slide-in 0.3s ease forwards",opacity:"0",transform:"translateX(20px)"});const r=n.querySelector(".notification-close");Object.assign(r.style,{background:"none",border:"none",fontSize:"20px",cursor:"pointer",marginLeft:"10px",opacity:"0.7"});const o=()=>{n.style.animation="notification-slide-out 0.3s ease forwards",setTimeout((()=>n.remove()),300)};if(r.addEventListener("click",o),"error"!==t&&setTimeout((()=>{n.parentNode&&o()}),5e3),a.appendChild(n),setTimeout((()=>{n.style.opacity="1",n.style.transform="translateX(0)"}),10),!document.getElementById("notification-keyframes")){const e=document.createElement("style");e.id="notification-keyframes",e.textContent="\n            @keyframes notification-slide-in {\n                from { opacity: 0; transform: translateX(20px); }\n                to { opacity: 1; transform: translateX(0); }\n            }\n            @keyframes notification-slide-out {\n                from { opacity: 1; transform: translateX(0); }\n                to { opacity: 0; transform: translateX(20px); }\n            }\n        ",document.head.appendChild(e)}}function formatCurrencyWithSuffix(e){if("number"!=typeof e||isNaN(e))try{const t=String(e).replace(/[^\d.-]+/g,"");if(e=parseFloat(t),isNaN(e))return"$0"}catch(e){return"$0"}return Math.abs(e)>=1e9?`$${(e/1e9).toFixed(2)}B`:Math.abs(e)>=1e6?`$${(e/1e6).toFixed(1)}M`:Math.abs(e)>=1e3?`$${(e/1e3).toFixed(0)}K`:new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(e)}function formatCurrency(e){return"number"!=typeof e||isNaN(e)?"$?":new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(e)}function capitalizeFirstLetter(e){return e&&"string"==typeof e?e.charAt(0).toUpperCase()+e.slice(1):""}function truncateText(e,t){return e?e.length>t?e.substring(0,t-3)+"...":e:""}function extractAcronym(e){if(!e||"string"!=typeof e)return null;const t=e.match(/\(([A-Z]{2,})\)$/);return t&&t[1]?t[1]:null}function getStateFullName(e){return{AL:"Alabama",AK:"Alaska",AZ:"Arizona",AR:"Arkansas",CA:"California",CO:"Colorado",CT:"Connecticut",DE:"Delaware",FL:"Florida",GA:"Georgia",HI:"Hawaii",ID:"Idaho",IL:"Illinois",IN:"Indiana",IA:"Iowa",KS:"Kansas",KY:"Kentucky",LA:"Louisiana",ME:"Maine",MD:"Maryland",MA:"Massachusetts",MI:"Michigan",MN:"Minnesota",MS:"Mississippi",MO:"Missouri",MT:"Montana",NE:"Nebraska",NV:"Nevada",NH:"New Hampshire",NJ:"New Jersey",NM:"New Mexico",NY:"New York",NC:"North Carolina",ND:"North Dakota",OH:"Ohio",OK:"Oklahoma",OR:"Oregon",PA:"Pennsylvania",RI:"Rhode Island",SC:"South Carolina",SD:"South Dakota",TN:"Tennessee",TX:"Texas",UT:"Utah",VT:"Vermont",VA:"Virginia",WA:"Washington",WV:"West Virginia",WI:"Wisconsin",WY:"Wyoming",DC:"District of Columbia",PR:"Puerto Rico",VI:"Virgin Islands",GU:"Guam",AS:"American Samoa",MP:"Northern Mariana Islands"}[e]||e}function getAgencyDisplayName(){const e=document.getElementById("agency-selector");if(!e)return currentAgency?currentAgency.toUpperCase():"N/A";const t=e.options[e.selectedIndex];return t?t.textContent:currentAgency?currentAgency.toUpperCase():"N/A"}function compareValues(e,t="asc"){return function(a,n){const r=a.hasOwnProperty(e)?a[e]:null,o=n.hasOwnProperty(e)?n[e]:null;let i=0;if(null==r)i=null==o?0:1;else if(null==o)i=-1;else if("endDate"===e||r instanceof Date&&o instanceof Date){const e=isNaN(r)?null:r.getTime(),t=isNaN(o)?null:o.getTime();i=null===e&&null===t?0:null===e?1:null===t?-1:e-t}else if("subaward_amount"===e||"amount"===e||"number"==typeof r&&"number"==typeof o){const e=Number(r),t=Number(o);i=isNaN(e)&&isNaN(t)?0:isNaN(e)?1:isNaN(t)?-1:e-t}else i=String(r).toLowerCase().localeCompare(String(o).toLowerCase());return"desc"===t?-1*i:i}}function handleHeaderClick(e){e&&(tableSortKey===e?tableSortDirection="asc"===tableSortDirection?"desc":"asc":(tableSortKey=e,tableSortDirection="asc"),updateDataTable())}function isMobileDevice(){return window.innerWidth<=768||"ontouchstart"in window||navigator.maxTouchPoints>0}function isTouchDevice(){return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0}function drawNaicsDonut(e,t,a=5){const n=d3.select(`#${t}`);if(n.html(""),!e||!Array.isArray(e))return console.warn("drawNaicsDonut: Invalid naicsData input",e),void n.html('<span class="chart-placeholder">Invalid data</span>');if(0===e.length)return void n.html('<span class="chart-placeholder">No NAICS data</span>');const r=e.slice(0,a),o=d3.sum(e.slice(a),(e=>e.value)),i=[...r];let s=!1;o>0&&(i.push({code:"Other",desc:"All Other NAICS Codes",value:o}),s=!0);const l=e[0];if(1===i.length&&s)return void n.html('<span class="chart-placeholder">Value primarily in "Other" NAICS</span>');if(0===i.length||!l)return void n.html('<span class="chart-placeholder">No Top NAICS data</span>');const c=n.node();if(!c)return void console.error(`drawNaicsDonut: Container node #${t} not found.`);const d=c.clientWidth,u=Math.max(130,c.clientHeight||130),p=Math.min(d,u)/2-5,m=.68*p;if(d<=0||u<=0||p<=10)return console.warn(`Container #${t} too small or zero dimensions. Width: ${d}, Height: ${u}, Radius: ${p}`),n.style("height","130px"),void n.html('<span class="chart-placeholder">Chart area too small</span>');n.style("height",`${u}px`);const f=n.append("svg").attr("width",d).attr("height",u).style("overflow","hidden").append("g").attr("transform",`translate(${d/2},${u/2})`),g=monochromaticPurpleScale.range(),y=d3.scaleOrdinal(g),h=d3.pie().padAngle(.005).value((e=>e.value)).sort(null),b=d3.arc().innerRadius(m).outerRadius(p),w=d3.arc().innerRadius(.9*p).outerRadius(.9*p),v=(f.selectAll(".arc-path").data(h(i)).join("path").attr("class","arc-path").attr("fill",((e,t)=>y(t%g.length))).attr("d",b).attr("stroke","var(--color-surface)").style("stroke-width","1px"),f.append("text").attr("text-anchor","middle").style("font-family","var(--font-primary)").style("fill","var(--color-on-surface)").attr("dy","-0.3em"));if(v.append("tspan").attr("x",0).attr("dy",0).style("font-size","0.8em").style("fill","var(--color-on-surface-variant)").text("Top NAICS"),v.append("tspan").attr("x",0).attr("dy","1.2em").style("font-size","0.9em").style("font-weight","600").text(l.code),window.innerWidth>600){const e=.07,t=h(i).filter((t=>(t.endAngle-t.startAngle)/(2*Math.PI)>e));if(t.length>0){const e=f.append("g").attr("class","labels"),a="font-size: 0.85em; fill: var(--color-on-surface-variant);";f.append("g").attr("class","lines").selectAll("polyline").data(t).join("polyline").attr("stroke","var(--color-on-surface-variant, #999)").style("fill","none").attr("stroke-width",1).attr("points",(e=>{const t=b.centroid(e),a=w.centroid(e),n=w.centroid(e),r=e.startAngle+(e.endAngle-e.startAngle)/2;return n[0]=(p+5)*(r<Math.PI?1:-1),[t,a,n]}));const n=e.selectAll("text").data(t).join("text").attr("transform",(e=>{const t=w.centroid(e),a=e.startAngle+(e.endAngle-e.startAngle)/2;return t[0]=(p+10)*(a<Math.PI?1:-1),`translate(${t})`})).style("text-anchor",(e=>e.startAngle+(e.endAngle-e.startAngle)/2<Math.PI?"start":"end")).style("font-size","10px").style("fill","var(--color-on-surface)").attr("dy","-0.3em");n.append("tspan").attr("x",0).text((e=>e.data.code)),n.filter((e=>"Other"!==e.data.code)).append("tspan").attr("x",0).attr("dy","1.1em").attr("style",a).text((e=>truncateText(e.data.desc,20)))}}}function drawTopNBarChart(e,t,a,n,r,o=5){const i=d3.select(`#${t}`);i.html("");const s=document.getElementById(a);if(s)if("prime"===r){const e=1===n?"Prime w/ Subs":"Primes w/ Subs";s.innerHTML=`${n.toLocaleString()} ${e}`}else if("sub"===r)s.innerHTML=`${n.toLocaleString()} Total Subs`;else{const e="Items";s.innerHTML=`${n.toLocaleString()} ${e}`}if(!e||0===e.length)return i.html('<span class="chart-placeholder">No data</span>'),void(s&&(s.innerHTML="prime"===r?"0 Primes w/ Subs":"sub"===r?"Total Subs":"0 Items"));const l=e.slice(0,o),c=i.node();if(!c)return;const d=c.clientWidth;let u=Math.max(60,18*l.length+5+5);i.style("height",`${u}px`);const p=i.append("svg").attr("width",d).attr("height",u).attr("viewBox",[0,0,d,u]),m=d3.scaleLinear().domain([0,d3.max(l,(e=>e.value))||1]).nice().range([85,d-10]),f=d3.scaleBand().domain(l.map((e=>e.name))).range([5,u-5]).padding(.15);p.append("g").attr("fill","var(--app-accent-color)").selectAll("rect").data(l).join("rect").attr("x",m(0)).attr("y",(e=>f(e.name))).attr("width",(e=>Math.max(0,m(e.value)-m(0)))).attr("height",f.bandwidth()).style("cursor","pointer").on("mouseover",(function(e,t){const a=d3.select("#tooltip");let n=`<h4>${t.name}</h4><p><strong>Value:</strong> ${formatCurrency(t.value)}</p>`;a.html(n).classed("visible",!0).attr("aria-hidden","false"),positionTooltip(a,e),d3.select(this).attr("fill","var(--primary-dark)")})).on("mouseout",(function(){hideTooltip(),d3.select(this).attr("fill","var(--app-accent-color)")})),p.append("g").attr("class","y-axis-labels").style("font-size","10px").attr("transform","translate(5, 0)").selectAll("text").data(l).join("text").attr("x",0).attr("y",(e=>f(e.name)+f.bandwidth()/2)).attr("dy","0.35em").attr("text-anchor","start").style("fill","var(--color-on-surface)").text((e=>truncateText(e.name,12))).style("cursor","default").append("title").text((e=>e.name))}