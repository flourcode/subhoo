let resizeTimeout,minValueUpdateTimeout,rawData=[],processedData=null,tableSortKey="subaward_amount",tableSortDirection="desc",currentSankeyData=null,currentAgency="dhs",currentFocusNode=null,minContractValue=2e6,activeLevels=["subagency","office","prime","sub"],topNFilterValue=0,currentVizType="sankey",currentSearchTerm="",currentMapFocusState=null,userChangedMinValue=!1,currentNaicsFilter="",currentSubAgencyFilter="",currentOfficeFilter="",currentPrimeFilter="",currentSubFilter="",allExpiringContracts=[],displayedExpiringCount=0,expiringSortKey="endDate",expiringSortDirection="asc";const DEFAULT_MIN_VALUE=2e6,CHOROPLETH_MIN_VALUE=0,itemsPerLoad=10,itemsToAdd=50,expiringAmountThreshold=2e5,nodeTypes=["agency","subagency","office","prime","sub"];let monochromaticPurpleColors={};function initializeColorScale(){const e=getComputedStyle(document.documentElement);monochromaticPurpleColors={agency:e.getPropertyValue("--sankey-node-agency").trim()||"#9993A1",subagency:e.getPropertyValue("--sankey-node-subagency").trim()||"#878094",office:e.getPropertyValue("--sankey-node-office").trim()||"#797484",prime:e.getPropertyValue("--sankey-node-prime").trim()||"#706877",sub:e.getPropertyValue("--sankey-node-sub").trim()||"#615C66"},window.monochromaticPurpleScale=d3.scaleOrdinal().domain(nodeTypes).range([monochromaticPurpleColors.agency,monochromaticPurpleColors.subagency,monochromaticPurpleColors.office,monochromaticPurpleColors.prime,monochromaticPurpleColors.sub])}function restoreFilterSectionStates(){document.querySelectorAll(".filter-section[data-section]").forEach((e=>{const t=e.getAttribute("data-section"),a=localStorage.getItem(`filter-section-${t}`);"open"===a?e.setAttribute("open",""):"closed"===a&&e.removeAttribute("open")}))}function setupResponsiveVisualization(){window.addEventListener("resize",(function(){clearTimeout(resizeTimeout),resizeTimeout=setTimeout((function(){currentVizType?updateVisualization(currentVizType):currentSankeyData&&drawSankeyDiagram(currentSankeyData)}),250)}));const e=document.querySelector(".visualization");if(e&&window.ResizeObserver){new ResizeObserver((e=>{clearTimeout(resizeTimeout),resizeTimeout=setTimeout((function(){currentVizType?updateVisualization(currentVizType):currentSankeyData&&drawSankeyDiagram(currentSankeyData)}),250)})).observe(e)}}function addCssFixes(){const e=document.createElement("style");e.textContent="\n        .viz-panel { visibility: hidden; opacity: 0; transition: opacity 0.3s ease; }\n        .viz-panel.active { visibility: visible; opacity: 1; transition: opacity 0.3s ease; }\n        .stats-card { cursor: pointer; transition: background-color 0.2s ease; }\n        .stats-card:hover { background-color: var(--color-surface-container-high); }\n        \n        /* NEW: Filter panel height reduction styles */\n        .filter-section summary {\n            cursor: pointer;\n            user-select: none;\n        }\n        \n        .filter-section summary h3 {\n            display: inline-block;\n            margin: 0;\n            padding-bottom: 4px;\n        }\n        \n        .filter-section summary::marker,\n        .filter-section summary::-webkit-details-marker {\n            color: var(--app-accent-color);\n        }\n        \n        .filter-row {\n            display: flex;\n            flex-wrap: wrap;\n            gap: 8px;\n            margin-bottom: 8px;\n        }\n        \n        .filter-column {\n            flex: 1;\n            min-width: calc(50% - 4px);\n        }\n        \n        @media (max-width: 600px) {\n            .filter-column {\n                width: 100%;\n                min-width: 100%;\n                margin-bottom: 8px;\n            }\n        }\n        \n        .sidebar .filter-section {\n            margin-bottom: 8px;\n            padding-bottom: 8px;\n        }\n        \n        .sidebar label {\n            margin-bottom: 3px;\n            font-size: 0.75rem;\n        }\n        \n        .filter-select {\n            padding: 6px 8px;\n            font-size: 0.85rem;\n            line-height: 1.2;\n        }\n    ",document.head.appendChild(e)}function setupEnhancedFilters(){setupSearchFilter(),setupSubAgencyFilter(),setupOfficeFilter(),setupNaicsFilter(),setupPrimeContractorFilter(),setupSubcontractorFilter()}function setupSubAgencyFilter(){const e=document.getElementById("subagency-filter");e?e.addEventListener("change",(()=>{currentSubAgencyFilter=e.value,rawData&&rawData.length>0&&processData()})):console.warn("SubAgency filter select element (#subagency-filter) not found in HTML.")}function setupSearchFilter(){const e=document.getElementById("data-search");if(!e)return void console.warn("Search input element not found");const t=e.parentElement;if(!t)return void console.warn("Search container not found");t.querySelectorAll('.search-clear-btn, #search-clear-btn, button[aria-label="Clear search"]').forEach((e=>e.remove()));let a=document.getElementById("search-clear-btn");a||(a=document.createElement("button"),a.id="search-clear-btn",a.className="search-clear-btn",a.innerHTML="&times;",a.setAttribute("aria-label","Clear search"),Object.assign(a.style,{position:"absolute",right:"12px",top:"50%",transform:"translateY(-50%)",background:"none",border:"none",fontSize:"1.2rem",color:"var(--color-on-surface-variant)",cursor:"pointer",display:e.value?"block":"none",zIndex:"100"}),t.appendChild(a)),a.onclick=function(t){t.preventDefault(),t.stopPropagation(),e.value="",a.style.display="none",currentSearchTerm="",rawData&&rawData.length>0&&processData(),e.focus()};const n=e._inputHandler;n&&e.removeEventListener("input",n);const r=function(){a&&(a.style.display=this.value?"block":"none"),clearTimeout(window.searchDebounceTimeout),window.searchDebounceTimeout=setTimeout((()=>{currentSearchTerm=this.value.trim().toLowerCase(),rawData&&rawData.length>0&&processData()}),350)};e._inputHandler=r,e.addEventListener("input",r)}function setupTopNFilter(){let e=document.getElementById("top-n-selector");if(!e){const t=document.createElement("div");t.className="filter-section top-n-filter";const a=document.createElement("h3");a.textContent="Top Subcontracts",t.appendChild(a);const n=document.createElement("label");n.setAttribute("for","top-n-selector"),n.textContent="Show only top contracts:",t.appendChild(n),e=document.createElement("select"),e.id="top-n-selector",e.className="filter-select",e.setAttribute("aria-label","Select number of top subcontracts");[{value:0,text:"Show All"},{value:10,text:"Top 10"},{value:25,text:"Top 25"},{value:50,text:"Top 50"},{value:100,text:"Top 100"}].forEach((t=>{const a=document.createElement("option");a.value=t.value,a.textContent=t.text,e.appendChild(a)})),t.appendChild(e);const r=document.querySelector(".sidebar");if(r){const e=document.getElementById("reset-filters");e?r.insertBefore(t,e):r.appendChild(t)}}e.addEventListener("change",(()=>{topNFilterValue=parseInt(e.value,10)||0,!processedData||"sankey"!==currentVizType&&"network"!==currentVizType&&"treemap"!==currentVizType||updateVisualization(currentVizType)}))}function setupOfficeFilter(){const e=document.getElementById("office-filter");e?e.addEventListener("change",(()=>{currentOfficeFilter=e.value,rawData&&rawData.length>0&&processData()})):console.warn("Office filter select element (#office-filter) not found in HTML.")}function setupNaicsFilter(){let e=document.getElementById("naics-filter");if(!e){const t=document.createElement("div");t.className="filter-section naics-filter";const a=document.createElement("h3");a.textContent="NAICS Filter",t.appendChild(a);const n=document.createElement("label");n.setAttribute("for","naics-filter"),n.textContent="Filter by NAICS Code:",t.appendChild(n),e=document.createElement("select"),e.id="naics-filter",e.className="filter-select",e.setAttribute("aria-label","Filter by NAICS Code");const r=document.createElement("option");r.value="",r.textContent="All NAICS Codes",e.appendChild(r),t.appendChild(e);const o=document.querySelector(".sidebar");if(o){const e=document.querySelector(".filter-section.office-filter");e?o.insertBefore(t,e.nextSibling):o.appendChild(t)}}e.addEventListener("change",(()=>{currentNaicsFilter=e.value,rawData&&rawData.length>0&&processData()}))}function setupPrimeContractorFilter(){let e=document.getElementById("prime-filter");if(!e){const t=document.createElement("div");t.className="filter-section prime-filter";const a=document.createElement("h3");a.textContent="Prime Contractor",t.appendChild(a);const n=document.createElement("label");n.setAttribute("for","prime-filter"),n.textContent="Filter by Prime Contractor:",t.appendChild(n),e=document.createElement("select"),e.id="prime-filter",e.className="filter-select",e.setAttribute("aria-label","Filter by Prime Contractor");const r=document.createElement("option");r.value="",r.textContent="All Prime Contractors",e.appendChild(r),t.appendChild(e);const o=document.querySelector(".sidebar");if(o){const e=document.querySelector(".filter-section.naics-filter");e?o.insertBefore(t,e.nextSibling):o.appendChild(t)}}e.addEventListener("change",(()=>{currentPrimeFilter=e.value,rawData&&rawData.length>0&&processData()}))}function setupSubcontractorFilter(){let e=document.getElementById("sub-filter");if(!e){const t=document.createElement("div");t.className="filter-section sub-filter";const a=document.createElement("h3");a.textContent="Subcontractor",t.appendChild(a);const n=document.createElement("label");n.setAttribute("for","sub-filter"),n.textContent="Filter by Subcontractor:",t.appendChild(n),e=document.createElement("select"),e.id="sub-filter",e.className="filter-select",e.setAttribute("aria-label","Filter by Subcontractor");const r=document.createElement("option");r.value="",r.textContent="All Subcontractors",e.appendChild(r),t.appendChild(e);const o=document.querySelector(".sidebar");if(o){const e=document.querySelector(".filter-section.prime-filter");e?o.insertBefore(t,e.nextSibling):o.appendChild(t)}}e.addEventListener("change",(()=>{currentSubFilter=e.value,rawData&&rawData.length>0&&processData()}))}function populateFilterDropdowns(){rawData&&0!==rawData.length&&(populateSubAgencyFilter(),populateOfficeFilter(),populateNaicsFilter(),populatePrimeFilter(),populateSubFilter())}function populateSubAgencyFilter(){const e=document.getElementById("subagency-filter");if(!e||!rawData||0===rawData.length)return;const t=new Set;for(rawData.forEach((e=>{const a=e.prime_award_awarding_sub_agency_name?.trim();a&&"null"!==a&&"undefined"!==a&&t.add(a)}));e.options.length>1;)e.remove(1);Array.from(t).sort().forEach((t=>{const a=document.createElement("option");a.value=t,a.textContent=truncateText(t,60),a.title=t,e.appendChild(a)}))}function populateOfficeFilter(){const e=document.getElementById("office-filter");if(!e||!rawData||0===rawData.length)return;const t=new Set;for(rawData.forEach((e=>{const a=e.prime_award_awarding_office_name?.trim();a&&"null"!==a&&"undefined"!==a&&t.add(a)}));e.options.length>1;)e.remove(1);Array.from(t).sort().forEach((t=>{const a=document.createElement("option");a.value=t,a.textContent=truncateText(t,60),a.title=t,e.appendChild(a)}))}function updateTotalValueCard(e,t=null){const a=document.getElementById("total-value");if(!a)return;a.textContent=formatCurrencyWithSuffix(e);const n=a.parentElement.querySelector("h4");n&&(t?(n.textContent=`${t} Contract Value`,a.classList.add("value-updated"),setTimeout((()=>a.classList.remove("value-updated")),500)):n.textContent="Contract Value")}function populateNaicsFilter(){const e=document.getElementById("naics-filter");if(!e)return;const t=new Map;for(rawData.forEach((e=>{const a=e.prime_award_naics_code?.toString().trim(),n=e.prime_award_naics_description?.trim()||"No Description";a&&"null"!==a&&"undefined"!==a&&t.set(a,n)}));e.options.length>1;)e.remove(1);Array.from(t.keys()).sort().forEach((a=>{const n=t.get(a),r=document.createElement("option");r.value=a,r.textContent=`${a} - ${n}`,e.appendChild(r)}))}function populatePrimeFilter(){const e=document.getElementById("prime-filter");if(!e)return;const t=new Set;for(rawData.forEach((e=>{const a=e.prime_awardee_name?.trim();a&&"null"!==a&&"undefined"!==a&&t.add(a)}));e.options.length>1;)e.remove(1);Array.from(t).sort().slice(0,100).forEach((t=>{const a=document.createElement("option");a.value=t,a.textContent=t,e.appendChild(a)}))}function populateSubFilter(){const e=document.getElementById("sub-filter");if(!e)return;const t=new Set;for(rawData.forEach((e=>{const a=e.subawardee_name?.trim();a&&"null"!==a&&"undefined"!==a&&t.add(a)}));e.options.length>1;)e.remove(1);Array.from(t).sort().slice(0,100).forEach((t=>{const a=document.createElement("option");a.value=t,a.textContent=t,e.appendChild(a)}))}function updateThemeColor(e){const t=document.querySelector('meta[name="theme-color"]');t&&t.setAttribute("content",e)}function setupVisualizationToggle(){const e=document.querySelectorAll(".viz-toggle-btn");let t="sankey";const a=window.location.hash.replace("#","");a&&["sankey","network","choropleth","treemap"].includes(a)&&(t=a),e.forEach((e=>{if(e.getAttribute("data-viz")===t){e.classList.add("active"),e.setAttribute("aria-pressed","true"),currentVizType=t;document.querySelectorAll(".viz-panel").forEach((e=>{const t=e.getAttribute("data-viz");e.classList.toggle("active",t===currentVizType),e.setAttribute("aria-hidden",t!==currentVizType)}))}else e.classList.remove("active"),e.setAttribute("aria-pressed","false")})),e.forEach((t=>{const a=t.cloneNode(!0);t.parentNode.replaceChild(a,t),a.addEventListener("click",(function(t){const a=this.getAttribute("data-viz"),n=this.getBoundingClientRect(),r=t.clientX-n.left,o=t.clientY-n.top,i=document.createElement("span");i.classList.add("ripple"),i.style.left=`${r}px`,i.style.top=`${o}px`,this.appendChild(i),setTimeout((()=>i.remove()),600),e.forEach((e=>{e.classList.remove("active"),e.setAttribute("aria-pressed","false")})),this.classList.add("active"),this.setAttribute("aria-pressed","true"),window.appInitialized&&updateVisualization(a)}))}))}function updateVisualization(e){const t=currentVizType;if(currentVizType=e,t!==e&&!userChangedMinValue){const t=document.getElementById("min-value"),a=document.getElementById("min-value-display");t&&a&&("choropleth"===e?(t.value=CHOROPLETH_MIN_VALUE,minContractValue=CHOROPLETH_MIN_VALUE,a.textContent=formatCurrency(CHOROPLETH_MIN_VALUE)):"sankey"!==e&&"network"!==e&&"treemap"!==e||(t.value=DEFAULT_MIN_VALUE,minContractValue=DEFAULT_MIN_VALUE,a.textContent=formatCurrency(DEFAULT_MIN_VALUE)))}updateActiveFiltersDisplay(),showLoading();document.querySelectorAll(".viz-panel").forEach((t=>{const a=t.getAttribute("data-viz");t.classList.toggle("active",a===e),t.setAttribute("aria-hidden",a!==e)}));let a=prepareVizData(),n=!1;(!a||!a.nodes||0===a.nodes.length)&&minContractValue>0&&"choropleth"!==e&&(console.warn(`No data found for ${e} with Min Value >= ${formatCurrency(minContractValue)}. Attempting redraw with $0.`),a=prepareVizData(0),a&&a.nodes&&a.nodes.length>0?n=!0:console.warn(`Still no data found for ${e} even with $0 minimum.`));try{switch(e){case"sankey":drawSankeyDiagram(a,n);break;case"network":drawNetworkGraph(a,n);break;case"choropleth":drawChoroplethMap(a);break;default:console.warn(`Unknown viz type: ${e}, defaulting to Sankey.`),drawSankeyDiagram(a,n)}updateLegend(e)}catch(t){console.error(`Error updating visualization to ${e}:`,t);const a=document.querySelector(`.viz-panel[data-viz="${e}"]`);a&&(a.innerHTML=`<div class="error-message"><p>Error rendering ${e}:</p><p>${t.message}</p></div>`)}finally{updateDataTable(),hideLoading()}}function updateDataTable(){console.log("Updating data table view...");const e=document.getElementById("data-table-container");if(!e)return void console.error("Data table container element not found.");e.innerHTML="";const t=[{key:"prime_award_awarding_sub_agency_name",header:"Sub Agency",truncate:20,sortable:!0},{key:"prime_award_awarding_office_name",header:"Office",truncate:30,sortable:!0},{key:"prime_awardee_name",header:"Prime Contractor",truncate:40,sortable:!0},{key:"subawardee_name",header:"Subcontractor",truncate:40,sortable:!0},{key:"subaward_amount",header:"Amount",format:"currency",align:"right",sortable:!0},{key:"subaward_description",header:"Description",truncate:50,sortable:!1},{key:"prime_award_naics_code",header:"NAICS",sortable:!0,align:"left"},{key:"subawardee_business_types",header:"Biz Types",truncate:20,sortable:!0},{key:"usaspending_permalink",header:"USAspending Link",format:"link",align:"center",sortable:!1}],a=document.createElement("div");a.className="data-table-header";const n=getAgencyDisplayName();a.innerHTML=`\n        <h3>Detailed Award Data for ${n}</h3>\n        <div class="data-table-controls">\n            <span id="data-count">Loading...</span>\n            <button id="export-csv" class="btn btn-text">Download Contracts List (CSV)</button>\n        </div>\n    `,e.appendChild(a);const r=document.createElement("div");r.className="data-table-wrapper",e.appendChild(r);const o=document.createElement("table");o.className="data-table",r.appendChild(o),console.log("Current filters before getFilteredTableData:"),console.log(`  - CurrentMapFocusState: ${currentMapFocusState||"None"}`),console.log(`  - CurrentAgency: ${currentAgency||"None"} (isPrimeData: ${currentAgency&&currentAgency.endsWith("_primes")})`),console.log(`  - MinContractValue: ${minContractValue}`),console.log(`  - Search Term: "${currentSearchTerm||""}"`);let i=getFilteredTableData();if(console.log(`Retrieved ${i.length} rows after filtering`),0===i.length&&currentMapFocusState){console.log(`No rows found with state filter: ${currentMapFocusState}. Checking raw data for this state...`);const e=currentAgency&&currentAgency.endsWith("_primes");let t=0;rawData.forEach((a=>{const n=e?a.primary_place_of_performance_state_code||a.place_of_performance_state||a.pop_state:a.subaward_primary_place_of_performance_state_code||a.place_of_performance_state||a.pop_state||a.prime_award_pop_state;n&&"string"==typeof n&&n.toUpperCase().trim()===currentMapFocusState&&t++})),console.log(`Found ${t} raw data rows with state code: ${currentMapFocusState}`)}if(tableSortKey&&i.length>0){const e=t.find((e=>e.key===tableSortKey));e&&e.sortable&&(console.log(`Sorting table display by ${tableSortKey} (${tableSortDirection})`),i.sort(compareValues(tableSortKey,tableSortDirection)))}const s=o.createTHead().insertRow();t.forEach((e=>{const t=document.createElement("th");t.textContent=e.header,t.classList.add(`col-${e.key}`),e.align&&(t.style.textAlign=e.align),e.sortable&&(t.classList.add("sortable"),t.dataset.sortKey=e.key,t.onclick=()=>handleHeaderClick(e.key),tableSortKey===e.key&&t.classList.add("asc"===tableSortDirection?"sorted-asc":"sorted-desc")),s.appendChild(t)}));const l=o.createTBody();let c=0;if(i&&0!==i.length){i.slice(0,100).forEach((e=>{const a=l.insertRow();a.onclick=()=>handleRowClick(e),a.style.cursor="pointer",t.forEach((t=>{const n=a.insertCell(),r=e[t.key];let o=null!=r?r:"N/A";if(n.classList.add(`cell-${t.key}`),t.align&&(n.style.textAlign=t.align),n.title=String(r??""),"currency"===t.format)n.textContent=formatCurrency(o);else if("link"===t.format)if(o&&"N/A"!==o&&"string"==typeof o&&o.startsWith("http")){const e=document.createElement("a");e.href=o,e.textContent="View",e.target="_blank",e.rel="noopener noreferrer",e.classList.add("detail-link"),e.onclick=e=>e.stopPropagation(),n.appendChild(e)}else n.textContent="N/A";else{const e=t.truncate;n.textContent=e?truncateText(String(o),e):o}})),c++}))}else console.log("updateDataTable: No data to display in the table for current filters.");const d=document.getElementById("data-count");d&&(d.textContent=i.length>100?`Showing top ${c} of ${i.length} total`:`Showing ${c} row(s)`);const u=document.getElementById("export-csv");if(u){const e=u.cloneNode(!0);u.parentNode.replaceChild(e,u),e.addEventListener("click",(()=>{console.log("Exporting full filtered data."),exportTableAsCSV(i,`${currentAgency}_subawards_export.csv`)})),e.disabled=!i||0===i.length}console.log(`Data table updated: ${c} rows displayed (sorted by ${tableSortKey||"default"}).`)}function getFilteredTableData(){if(!rawData||0===rawData.length)return console.warn("No raw data available for table"),[];const e=currentAgency&&currentAgency.endsWith("_primes");console.log(`--- Filtering table data (isPrimeData: ${e}) ---`),console.log(`   Search: "${currentSearchTerm}"`),console.log(`   MinVal Slider: ${formatCurrency(minContractValue)}`),console.log(`   StateFocus: ${currentMapFocusState||"None"}`),console.log(`   NodeFocus: ${currentFocusNode?.id||"None"}`),console.log(`   SubAgency: ${currentSubAgencyFilter||"None"}`),console.log(`   Office: ${currentOfficeFilter||"None"}`),console.log(`   NAICS: ${currentNaicsFilter||"None"}`),console.log(`   Prime: ${currentPrimeFilter||"None"}`),console.log(`   Sub: ${currentSubFilter||"None"}`);let t=rawData,a=rawData.length;if(currentSearchTerm&&(t=t.filter((t=>[t.prime_award_awarding_agency_name,t.prime_award_awarding_sub_agency_name,t.prime_award_awarding_office_name,t.prime_awardee_name,e?null:t.subawardee_name,t.subaward_description,t.prime_award_base_transaction_description,t.prime_award_naics_code?.toString(),t.prime_award_naics_description].filter(Boolean).some((e=>e&&"string"==typeof e&&e.toLowerCase().includes(currentSearchTerm))))),console.log(`   Rows after Search filter: ${t.length} (from ${a})`),a=t.length),currentMapFocusState){if(console.log(`   Applying State focus filter: ${currentMapFocusState}`),t.length>0){const e=t[0];console.log("Sample row state fields:",{primary_place_of_performance_state_code:e.primary_place_of_performance_state_code,place_of_performance_state:e.place_of_performance_state,pop_state:e.pop_state,award_pop_state:e.award_pop_state,subaward_primary_place_of_performance_state_code:e.subaward_primary_place_of_performance_state_code,prime_award_pop_state:e.prime_award_pop_state,extracted_state:getNormalizedStateCode(e)})}t=t.filter((e=>getNormalizedStateCode(e)===currentMapFocusState)),console.log(`   Rows after State focus filter: ${t.length} (from ${a})`),a=t.length}else console.log(`   Applying Minimum Value filter: >= ${formatCurrency(minContractValue)}`),t=t.filter((e=>("number"==typeof e.subaward_amount?e.subaward_amount:parseFloat(String(e.subaward_amount||"0").replace(/[^0-9.-]+/g,""))||0)>=minContractValue)),console.log(`   Rows after Min Value filter: ${t.length} (from ${a})`),a=t.length;return console.log(`--- getFilteredTableData FINAL returning ${t.length} rows. ---`),t}function debugStateData(){if(!rawData||0===rawData.length)return void console.log("No raw data available to debug state codes");const e=currentAgency&&currentAgency.endsWith("_primes");console.log(`Debugging state data for ${currentAgency} (Prime data: ${e})`);const t={},a={},n={};if(rawData.length>0){console.log("Sample row field names:");const e=rawData[0],t=Object.keys(e).filter((e=>e.toLowerCase().includes("state")||e.toLowerCase().includes("performance")||e.toLowerCase().includes("pop")));console.log(t)}return rawData.forEach(((e,r)=>{const o=[{field:"primary_place_of_performance_state_code",value:e.primary_place_of_performance_state_code},{field:"place_of_performance_state",value:e.place_of_performance_state},{field:"pop_state",value:e.pop_state},{field:"prime_award_pop_state",value:e.prime_award_pop_state},{field:"subaward_primary_place_of_performance_state_code",value:e.subaward_primary_place_of_performance_state_code},{field:"award_pop_state",value:e.award_pop_state}];let i=null,s=null;for(const e of o)if(e.value&&"string"==typeof e.value&&""!==e.value.trim()){i=e.value.toUpperCase().trim(),s=e.field,a[e.field]=(a[e.field]||0)+1;break}if(i){t[i]=(t[i]||0)+1;const a=e.primary_place_of_performance_city_name||e.place_of_performance_city||e.pop_city||e.subaward_primary_place_of_performance_city_name;if(a&&"string"==typeof a&&""!==a.trim()&&r<100){const e=["norfolk","virginia beach","richmond","alexandria"],t=["honolulu","hilo","kailua"],r=a.toLowerCase().trim();e.includes(r)&&"VA"!==i&&(n[`${a} (${i})`]=s),t.includes(r)&&"HI"!==i&&(n[`${a} (${i})`]=s)}}})),console.log("State code distribution:"),console.log(t),console.log("Fields used for state codes:"),console.log(a),Object.keys(n).length>0&&(console.log("Potentially mismatched cities and states:"),console.log(n)),{stateCounts:t,fieldsUsed:a,mismatchedCities:n}}function getNormalizedStateCode(e){const t=[e.primary_place_of_performance_state_code,e.award_pop_state,e.place_of_performance_state,e.pop_state,e.subaward_primary_place_of_performance_state_code,e.prime_award_pop_state];for(const e of t)if(e&&"string"==typeof e&&""!==e.trim())return e.toUpperCase().trim();return null}function isNodeConnectedToFocus(e){if(!currentFocusNode||!processedData||!processedData.links)return!0;if(e.id===currentFocusNode.id)return!0;const t=Object.values(processedData.links).flat();for(const a of t){const t=a.source?.id||a.source,n=a.target?.id||a.target;if(!((a.value||0)<minContractValue)&&(t===currentFocusNode.id&&n===e.id||n===currentFocusNode.id&&t===e.id))return!0}return!1}function handleRowClick(e){if(!e||!e.subawardee_name)return void console.warn("Clicked row item missing subawardee name:",e);nodeClicked(null,{id:`sub-${e.subawardee_name}`,name:e.subawardee_name,type:"sub"})}function exportTableAsCSV(e,t="data_export.csv"){if(!e||0===e.length)return void showNotification("No data available to export.","warning");const a=[{key:"prime_award_unique_key",header:"Prime Award Unique Key"},{key:"prime_award_awarding_agency_name",header:"Awarding Agency"},{key:"prime_award_awarding_sub_agency_name",header:"Awarding Sub Agency"},{key:"prime_award_awarding_office_name",header:"Awarding Office"},{key:"prime_awardee_name",header:"Prime Contractor Name"},{key:"subawardee_name",header:"Subcontractor Name"},{key:"subaward_amount",header:"Subaward Amount"},{key:"subaward_description",header:"Subaward Description"},{key:"prime_award_naics_code",header:"Prime NAICS Code"},{key:"prime_award_naics_description",header:"Prime NAICS Description"},{key:"subawardee_business_types",header:"Subcontractor Business Types"},{key:"prime_award_period_of_performance_start_date",header:"Prime PoP Start Date"},{key:"prime_award_period_of_performance_current_end_date",header:"Prime PoP End Date"},{key:"subaward_primary_place_of_performance_state_code",header:"Sub PoP State Code"},{key:"subaward_place_of_performance_cd_current",header:"Sub PoP Congressional District"},{key:"usaspending_permalink",header:"USAspending Link"}],n=e=>{if(null==e)return"";return`"${String(e).replace(/"/g,'""')}"`},r=[a.map((e=>n(e.header))).join(","),...e.map((e=>a.map((t=>n(e[t.key]))).join(",")))].join("\n"),o=new Blob([r],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(o),s=document.createElement("a");s.setAttribute("href",i),s.setAttribute("download",t),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s)}function applyFiltersAndDraw(){if(!processedData)return console.warn("applyFiltersAndDraw: no processedData available."),void d3.select("#chart").html('<div class="empty-message">Processing Data...</div>');const e=prepareVizData();currentFocusNode||(currentSankeyData=e),drawSankeyDiagram(e),updateBreadcrumb()}function prepareVizData(e=null){if(!processedData||!processedData.nodes||!processedData.links)return console.warn("prepareVizData: No processed data available."),{nodes:[],links:[]};const t=currentAgency&&currentAgency.endsWith("_primes"),a=null!==e?e:minContractValue;if(null!==e);else{}const n={};Object.keys(processedData.nodes).forEach((e=>{Array.isArray(processedData.nodes[e])?n[e]=t&&0===a&&!currentOfficeFilter&&"prime"===e?processedData.nodes[e].filter((e=>e&&activeLevels.includes(e.type))):processedData.nodes[e].filter((e=>e&&"number"==typeof e.value&&e.value>=a&&activeLevels.includes(e.type))):n[e]=[]}));const r=Object.values(n).flat(),o=new Set(r.map((e=>e.id)));let i=[];if(t&&0===a&&!currentOfficeFilter){const e=new Map;Object.values(processedData.links).flat().forEach((t=>{if(t&&t.details&&"prime"===t.details.targetType){const a=t.target;e.has(a)||e.set(a,[]),e.get(a).push({...t})}})),e.forEach(((e,t)=>{o.has(t)&&e.forEach((e=>{o.has(e.source)&&i.push(e)}))})),Object.values(processedData.links).flat().forEach((e=>{if(e&&e.details&&"prime"!==e.details.targetType&&o.has(e.source)&&o.has(e.target)){const t=`${e.source}|${e.target}`;i.some((e=>`${e.source}|${e.target}`===t))||i.push({...e})}}))}else Object.values(processedData.links).flat().forEach((e=>{e&&"number"==typeof e.value&&e.value>=a&&o.has(e.source)&&o.has(e.target)&&i.push({...e})}));let s=r,l=i;if(currentFocusNode){const e=currentFocusNode.id;if(r.some((t=>t.id===e))){const t=new Map,a=new Set,n=[],c=r.find((t=>t.id===e));n.push(c),t.set(e,c),a.add(e);let d=0;for(;d<n.length;){const e=n[d++];i.forEach((i=>{let s=null;if(i.source===e.id&&o.has(i.target)&&!a.has(i.target)?s=i.target:i.target===e.id&&o.has(i.source)&&!a.has(i.source)&&(s=i.source),s){const e=r.find((e=>e.id===s));e&&(a.add(s),t.set(s,e),n.push(e))}}))}s=Array.from(t.values()),l=i.filter((e=>a.has(e.source)&&a.has(e.target)))}else console.warn(`Focus node ${e} not found after initial filters (value/level).`),s=[],l=[]}let c=s,d=l;if(topNFilterValue>0&&["sankey","network","treemap"].includes(currentVizType)){const e=d.filter((e=>"sub"===e.details?.targetType));if(e.length>0){e.sort(((e,t)=>t.value-e.value));const t=e.slice(0,topNFilterValue);if(t.length<e.length){const e=new Set;t.forEach((t=>{e.add(t.source),e.add(t.target)}));let a=!0;const n=10;let r=0;for(;a&&r<n;){a=!1,r++;d.filter((t=>"sub"!==t.details?.targetType&&e.has(t.target)&&!e.has(t.source))).forEach((t=>{e.has(t.source)||s.some((e=>e.id===t.source))&&(e.add(t.source),a=!0)}))}r===n&&console.warn("Top N Ancestor tracing hit max iterations."),c=s.filter((t=>e.has(t.id))),d=d.filter((a=>"sub"===a.details?.targetType&&t.includes(a)||"sub"!==a.details?.targetType&&e.has(a.source)&&e.has(a.target)))}}else["sankey","network","treemap"].includes(currentVizType)&&(c=s.filter((e=>"sub"!==e.type)),d=d.filter((e=>"sub"!==e.details?.targetType)))}return{nodes:c,links:d}}function drawSankeyDiagram(e,t=!1){const a=d3.select("#chart");a.html("");currentAgency&&currentAgency.endsWith("_primes");if(!rawData||0===rawData.length)return void a.html('\n            <div class="loading-message">\n                <p>Loading data, please wait...</p>\n            </div>\n        ');if(!e||!Array.isArray(e.nodes)||!Array.isArray(e.links)||0===e.nodes.length||0===e.links.length)return a.html(`\n            <div class="formatted-empty-message">\n                <strong class="message-title">No Data for Sankey Diagram</strong>\n                <p class="message-details">No data above <strong>${formatCurrency(minContractValue)}</strong> matches the current filter combination for this visualization.</p>\n                <p class="message-suggestions">Suggestions:</p>\n                <ul>\n                    <li>Lower the 'Minimum Contract Value' slider.</li>\n                    <li>Adjust 'Visible Node Levels'.</li>\n                    <li>Adjust or clear the 'Search' term / other filters.</li>\n                    <li>Clear any active node focus (click 'All Data').</li>\n                    <li>Click 'Reset All Filters'.</li>\n                </ul>\n            </div>\n        `),void console.warn("drawSankeyDiagram: No valid data to draw.");const n=document.getElementById("chart").getBoundingClientRect(),r=n.width,o=n.height,i=20,s=10,l=r-s-10,c=o-i-20;if(l<=0||c<=0)return console.error("Chart container invalid dimensions."),void a.html('<div class="error-message">Chart area too small to draw.</div>');const d=a.append("svg").attr("width",r).attr("height",o).attr("viewBox",`0 0 ${r} ${o}`).attr("preserveAspectRatio","xMidYMid meet").append("g").attr("transform",`translate(${s},${i})`),u=d3.sankey().nodeId((e=>e.id)).nodeWidth(isMobileDevice()?10:15).nodeSort(null).nodePadding(isMobileDevice()?6:10).extent([[0,0],[l,c]]),p={nodes:e.nodes.map((e=>({...e}))),links:e.links.map((e=>({...e})))};let m;try{const e=new Set(p.nodes.map((e=>e.id)));p.links=p.links.filter((t=>e.has(t.source)&&e.has(t.target))),m=u(p)}catch(e){return console.error("Error calculating Sankey layout:",e),void a.html(`<div class="error-message">Error calculating layout: ${e.message}. Try different filters.</div>`)}const f=d.append("defs");m.links.forEach(((e,t)=>{const a=`link-gradient-${t}`,n=monochromaticPurpleScale(e.source.type)||"#999",r=monochromaticPurpleScale(e.target.type)||"#999",o=f.append("linearGradient").attr("id",a).attr("gradientUnits","userSpaceOnUse").attr("x1",e.source.x1).attr("y1",e.source.y0+(e.source.y1-e.source.y0)/2).attr("x2",e.target.x0).attr("y2",e.target.y0+(e.target.y1-e.target.y0)/2);o.append("stop").attr("offset","0%").attr("stop-color",n).attr("stop-opacity",.8),o.append("stop").attr("offset","100%").attr("stop-color",r).attr("stop-opacity",.8),e.gradientId=a}));d.append("g").attr("class","links").attr("fill","none").selectAll("path.link").data(m.links).join("path").attr("class","link").attr("d",d3.sankeyLinkHorizontal()).attr("stroke-width",(e=>Math.max(1,e.width||1))).attr("stroke",(e=>`url(#${e.gradientId})`)).style("transition","stroke-opacity 0.2s ease").style("stroke-opacity",.3).on("mouseover",(function(e,t){d3.select(this).style("stroke-opacity",.6).attr("stroke-width",(e=>Math.max(2,e.width+1))),d3.selectAll(".node").filter((e=>e.id===t.source.id||e.id===t.target.id)).select("rect").attr("stroke-width",2).attr("stroke","var(--app-accent-color)"),showLinkTooltip(e,t)})).on("mouseout",(function(e,t){d3.select(this).style("stroke-opacity",.3).attr("stroke-width",(e=>Math.max(1,e.width))),d3.selectAll(".node rect").attr("stroke-width",1).attr("stroke","var(--sankey-node-stroke)"),hideTooltip()}));const g=d.append("g").attr("class","nodes").selectAll(".node").data(m.nodes).join("g").attr("class",(e=>`node node-type-${e.type}`)).attr("data-type",(e=>e.type)).attr("transform",(e=>`translate(${e.x0},${e.y0})`)).attr("tabindex",0).attr("role","button").attr("aria-label",(e=>`${e.name}, ${e.type}, ${formatCurrency(e.value)}`)).on("click",nodeClicked).on("mouseover",(function(e,t){d3.select(this).select("rect").attr("stroke-width",2).attr("stroke","var(--app-accent-color)"),d3.selectAll(".link").style("stroke-opacity",(e=>{const a="object"==typeof e.source?e.source.id:e.source,n="object"==typeof e.target?e.target.id:e.target;return a===t.id||n===t.id?.6:.1})),showNodeTooltip(e,t)})).on("mouseout",(function(e,t){const a=currentFocusNode&&t.id===currentFocusNode.id;d3.select(this).select("rect").attr("stroke-width",a?2:1).attr("stroke",a?"var(--app-accent-color)":"var(--sankey-node-stroke)"),d3.selectAll(".link").style("stroke-opacity",.3),hideTooltip()})).on("keydown",(function(e,t){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),nodeClicked(e,t))}));g.append("rect").attr("height",(e=>Math.max(1,e.y1-e.y0))).attr("width",(e=>e.x1-e.x0)).attr("fill",(e=>monochromaticPurpleScale(e.type))).attr("stroke",(e=>currentFocusNode&&e.id===currentFocusNode.id?"var(--app-accent-color)":"var(--sankey-node-stroke)")).attr("stroke-width",(e=>currentFocusNode&&e.id===currentFocusNode.id?2:1)).attr("fill-opacity",.95),g.append("text").attr("x",(e=>e.x0<l/2?e.x1-e.x0+6:-6)).attr("y",(e=>(e.y1-e.y0)/2)).attr("dy","0.35em").attr("text-anchor",(e=>e.x0<l/2?"start":"end")).attr("fill","var(--sankey-node-label-fill, #ccc)").attr("font-family","var(--font-primary)").attr("font-size",isMobileDevice()?"9px":"11px").style("pointer-events","none").style("user-select","none").text((e=>{const t=("agency"===e.type||"subagency"===e.type)&&e.acronym;let a=t?e.acronym:e.name||"";const n=isMobileDevice()?18:30;return!t&&a.length>n&&(a=a.substring(0,n-1)+"…"),a})).each((function(e){e.y1-e.y0<(isMobileDevice()?8:10)&&d3.select(this).remove()}))}function drawNetworkGraph(e,t=!1){const a=d3.select("#network-chart");a.html("");const n=currentAgency&&currentAgency.endsWith("_primes");if(t||n){const e=a.append("div").attr("class","viz-notifications").style("position","absolute").style("top","10px").style("left","0").style("right","0").style("text-align","center").style("z-index","10");n&&e.append("div").attr("class","prime-data-indicator").style("color","var(--color-on-surface-variant)").style("font-size","12px").style("font-style","italic").style("margin-bottom","5px").text(""),t&&e.append("div").attr("class","min-value-override-indicator").style("color","var(--color-on-surface-variant)").style("font-size","12px").style("font-style","italic").text(`Showing contracts below minimum filter (${formatCurrency(minContractValue)}) to display data`)}const r=e.nodes,o=e.links;if(!r||0===r.length)return console.warn("drawNetworkGraph: No nodes remain after filtering."),void a.html(`\n             <div class="formatted-empty-message">\n                 <strong class="message-title">No Data for Network Graph</strong>\n                 <p class="message-details">No data matches the current filter combination${minContractValue>0?` above ${formatCurrency(minContractValue)}`:""}.</p>\n                 <p class="message-suggestions">Suggestions:</p><ul>\n                     ${minContractValue>0?"<li>Lower the 'Minimum Contract Value' slider.</li>":""}\n                     <li>Adjust 'Visible Node Levels'.</li><li>Adjust or clear the 'Search' term / other filters.</li>\n                     <li>Clear any active node focus (click 'All Data').</li><li>Click 'Reset All Filters'.</li></ul></div>`);const i=document.getElementById("network-chart").getBoundingClientRect(),s=i.width,l=i.height;if(s<=10||l<=10)return console.error("Network container invalid dimensions."),void a.html('<div class="error-message">Chart container invalid dimensions.</div>');const c=a.append("svg").attr("width",s).attr("height",l).attr("viewBox",`0 0 ${s} ${l}`).attr("preserveAspectRatio","xMidYMid meet").style("cursor","grab"),d=c.append("g"),u=d3.zoom().scaleExtent([.1,8]).on("zoom",(e=>{d.attr("transform",e.transform),c.style("cursor","grabbing");const t=a.select(".reset-zoom-btn").node();t&&(t.style.display=1===e.transform.k&&0===e.transform.x&&0===e.transform.y?"none":"block")})).on("end",(()=>c.style("cursor","grab")));c.call(u);a.append("button").attr("class","reset-zoom-btn").text("Reset View").style("position","absolute").style("top","10px").style("right","10px").style("z-index","10").style("display","none").style("background-color","var(--color-surface-container-high)").style("color","var(--color-on-surface-variant)").style("border","1px solid var(--color-outline-variant)").style("border-radius","20px").style("padding","8px 12px").style("font-size","0.8rem").style("cursor","pointer").on("click",(function(){c.transition().duration(750).call(u.transform,d3.zoomIdentity)}));const p=d3.max(r,(e=>e.value))||1,m=d3.scaleSqrt().domain([0,p]).range([isMobileDevice()?3:4,isMobileDevice()?12:15]),f=r.map((e=>({...e}))),g=o.map((e=>({...e,source:f.find((t=>t.id===("object"==typeof e.source?e.source.id:e.source))),target:f.find((t=>t.id===("object"==typeof e.target?e.target.id:e.target)))}))).filter((e=>e.source&&e.target)),y=d3.forceSimulation(f).force("link",d3.forceLink(g).id((e=>e.id)).distance(isMobileDevice()?45:75).strength(.6)).force("charge",d3.forceManyBody().strength(isMobileDevice()?-90:-130)).force("center",d3.forceCenter(s/2,l/2).strength(.05)).force("collision",d3.forceCollide().radius((e=>m(e.value)+(isMobileDevice()?4:6))).strength(.8)),h=d.append("g").attr("class","links").attr("stroke","var(--sankey-link-color)").attr("stroke-opacity","var(--sankey-link-opacity)").selectAll("line").data(g).join("line").attr("stroke-width",(e=>Math.max(.5,Math.min(5,m(e.value)/3)))).on("mouseover",(function(e,t){d3.select(this).attr("stroke-opacity",.9);showLinkTooltip(e,o.find((e=>("object"==typeof e.source?e.source.id:e.source)===t.source.id&&("object"==typeof e.target?e.target.id:e.target)===t.target.id))||t)})).on("mouseout",(function(){d3.select(this).attr("stroke-opacity","var(--sankey-link-opacity)"),hideTooltip()})),b=d.append("g").attr("class","nodes").selectAll("circle").data(f,(e=>e.id)).join("circle").attr("r",(e=>m(e.value))).attr("fill",(e=>monochromaticPurpleScale(e.type)||"#797484")).attr("stroke","var(--sankey-node-stroke)").attr("stroke-width",1.5).attr("tabindex",0).attr("role","button").attr("aria-label",(e=>`${e.name}, ${e.type}, ${formatCurrency(e.value)}`)).call(d3.drag().on("start",(function(e,t){e.active||y.alphaTarget(.3).restart();t.fx=t.x,t.fy=t.y,d3.select(this).style("cursor","grabbing")})).on("drag",(function(e,t){t.fx=e.x,t.fy=e.y})).on("end",(function(e,t){e.active||y.alphaTarget(0);isTouchDevice()||(t.fx=null,t.fy=null);d3.select(this).style("cursor","pointer")}))).on("click",nodeClicked).on("mouseover",(function(e,t){d3.select(this).attr("stroke-width",3).attr("stroke","var(--app-accent-color)"),showNodeTooltip(e,t),h.attr("stroke-opacity",(e=>{const a=e.source.id,n=e.target.id;return a===t.id||n===t.id?.9:.1})),b.attr("opacity",(e=>{if(e.id===t.id)return 1;return g.some((a=>{const n=a.source.id,r=a.target.id;return n===t.id&&r===e.id||r===t.id&&n===e.id}))?.8:.3}))})).on("mouseout",(function(){d3.select(this).attr("stroke-width",1.5).attr("stroke","var(--sankey-node-stroke)"),hideTooltip(),h.attr("stroke-opacity","var(--sankey-link-opacity)"),b.attr("opacity",1)})).on("keydown",(function(e,t){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),nodeClicked(e,t))})),w=d.append("g").attr("class","labels").selectAll("text.node-label").data(f,(e=>e.id)).join("text").attr("class","node-label").attr("text-anchor","start").style("font-size",isMobileDevice()?"7px":"9px").style("fill","var(--sankey-node-label-fill, #555)").style("pointer-events","none").style("user-select","none").text((e=>window.innerWidth<=768?truncateText(e.name,10):e.name)).attr("dominant-baseline","middle").attr("dx",(e=>m(e.value)+(isMobileDevice()?4:5))).style("display",(e=>{const t=m(e.value);return isMobileDevice()?t<4?"none":"block":t<2?"none":"block"}));y.on("tick",(()=>{h.attr("x1",(e=>e.source.x)).attr("y1",(e=>e.source.y)).attr("x2",(e=>e.target.x)).attr("y2",(e=>e.target.y)),b.attr("cx",(e=>e.x=Math.max(m(e.value),Math.min(s-m(e.value),e.x)))).attr("cy",(e=>e.y=Math.max(m(e.value),Math.min(l-m(e.value),e.y)))),w.attr("x",(e=>e.x)).attr("y",(e=>e.y))}));let v=0;c.on("touchend",(function(e){if(e.defaultPrevented)return;const t=(new Date).getTime(),a=t-v;if(a<400&&a>0){e.preventDefault();const t=d3.pointer(e,c.node());d3.zoomTransform(c.node()).k<2?c.transition().duration(500).call(u.transform,d3.zoomIdentity.translate(s/2,l/2).scale(2.5).translate(-t[0],-t[1])):c.transition().duration(500).call(u.transform,d3.zoomIdentity)}v=t}))}function drawChoroplethMap(){const e=CHOROPLETH_MIN_VALUE,t=d3.select("#map-chart");t.html("");const a=currentAgency&&currentAgency.endsWith("_primes");if(!rawData||0===rawData.length)return console.warn("Cannot draw choropleth map: No rawData available"),void t.html('<div class="formatted-empty-message">...</div>');a&&t.append("div").attr("class","prime-data-indicator").style("position","absolute").style("top","10px").style("left","0").style("right","0").style("text-align","center").style("color","var(--color-on-surface-variant)").style("font-size","12px").style("font-style","italic").style("z-index","10").style("background-color","rgba(0, 0, 0, 0.1)").style("padding","3px").text("");const n={};let r=0,o=0;if(rawData.forEach((t=>{const a=getNormalizedStateCode(t);if(!a)return;const i="number"==typeof t.subaward_amount?t.subaward_amount:parseFloat(String(t.subaward_amount||"0").replace(/[^0-9.-]+/g,""))||0;i<e||(n[a]=(n[a]||0)+i,r+=i,o++)})),console.log(`Choropleth aggregated ${o} records across ${Object.keys(n).length} states. Total value: ${formatCurrency(r)}`),Object.keys(n).length>0){const e=Object.entries(n).sort(((e,t)=>t[1]-e[1])).slice(0,5);console.log("Top 5 states by value:"),e.forEach((([e,t])=>{console.log(`  ${e}: ${formatCurrency(t)}`)}))}const i=t.append("div").attr("class","loading-message").text("Loading map data...");d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json").then((e=>{i.remove();const r=document.getElementById("map-chart").getBoundingClientRect(),o=r.width,s=r.height;if(o<=0||s<=0)return void console.error("Map container invalid");const l=t.append("svg").attr("width",o).attr("height",s).attr("viewBox",`0 0 ${o} ${s}`).attr("preserveAspectRatio","xMidYMid meet").style("display","block").style("width","100%").style("height","100%"),c=l.append("g").attr("class","map-container"),d=d3.zoom().scaleExtent([.5,8]).on("zoom",(e=>c.attr("transform",e.transform)));l.call(d),a&&l.append("text").attr("x",o/2).attr("y",15).attr("text-anchor","middle").attr("class","prime-data-indicator").attr("fill","var(--color-on-surface-variant)").attr("font-size","12px").attr("font-style","italic").text("");const u=topojson.feature(e,e.objects.states),p=d3.geoAlbersUsa().fitSize([o,s],u),m=d3.geoPath().projection(p),f=Object.values(n),g=d3.scaleQuantile().domain(f.length>0?f:[0,1]).range(monochromaticPurpleScale.range()),y={"01":"AL","02":"AK","04":"AZ","05":"AR","06":"CA","08":"CO","09":"CT",10:"DE",11:"DC",12:"FL",13:"GA",15:"HI",16:"ID",17:"IL",18:"IN",19:"IA",20:"KS",21:"KY",22:"LA",23:"ME",24:"MD",25:"MA",26:"MI",27:"MN",28:"MS",29:"MO",30:"MT",31:"NE",32:"NV",33:"NH",34:"NJ",35:"NM",36:"NY",37:"NC",38:"ND",39:"OH",40:"OK",41:"OR",42:"PA",44:"RI",45:"SC",46:"SD",47:"TN",48:"TX",49:"UT",50:"VT",51:"VA",53:"WA",54:"WV",55:"WI",56:"WY",72:"PR"};c.append("g").attr("class","states").selectAll("path").data(u.features).join("path").attr("d",m).attr("fill",(e=>{const t=y[e.id],a=n[t]||0;return a>0?g(a):"#eee"})).attr("stroke","#fff").attr("stroke-width",.5).attr("tabindex",0).attr("role","button").attr("aria-label",(e=>{const t=y[e.id],a=n[t]||0;return`${getStateFullName(t)}: ${formatCurrency(a)}`})).classed("focused-state",(e=>y[e.id]===currentMapFocusState)).on("mouseover",(function(e,t){d3.select(this).raise().attr("stroke","#000").attr("stroke-width",1.5);const a=y[t.id],r=n[a]||0;if(r>0||!a)showMapTooltip(e,a||t.properties.name,r);else{const t=d3.select("#tooltip");t.html(`<h4>${getStateFullName(a)}</h4><p><em>No contracts match current filters</em></p>`).classed("visible",!0).attr("aria-hidden","false"),positionTooltip(t,e)}})).on("mouseout",(function(e,t){y[t.id]!==currentMapFocusState?d3.select(this).attr("stroke","#fff").attr("stroke-width",.5):d3.select(this).attr("stroke","var(--app-accent-color)").attr("stroke-width",2),hideTooltip()})).on("click",(function(e,t){const a=y[t.id];if(a){if(console.log(`--- Map State Click: ${a} ---`),console.log(`   Current agency: ${currentAgency}, isPrimeData: ${currentAgency&&currentAgency.endsWith("_primes")}`),c.selectAll("path.focused-state").classed("focused-state",!1).attr("stroke","#fff").attr("stroke-width",.5),currentMapFocusState===a)console.log(`   Clearing state focus from ${a}`),currentMapFocusState=null,closeInfoPanel(),updateTotalValueCard(processedData.stats.totalContractValue);else{currentMapFocusState=a,console.log(`   Set currentMapFocusState to: ${currentMapFocusState}`),d3.select(this).classed("focused-state",!0).attr("stroke","var(--app-accent-color)").attr("stroke-width",2).raise();const e=n[a]||0;e>0&&(showEnhancedStateInfoPanel(a,e),updateTotalValueCard(e,getStateFullName(a)))}updateBreadcrumb(),console.log(`   Updating data table for state: ${currentMapFocusState||"None"}`),updateDataTable()}})),c.append("path").datum(topojson.mesh(e,e.objects.states,((e,t)=>e!==t))).attr("fill","none").attr("stroke","#fff").attr("stroke-width",.5).attr("stroke-linejoin","round").attr("d",m);const h=s-18*monochromaticPurpleScale.range().length-30,b=l.append("g").attr("class","legend choropleth-legend").attr("transform",`translate(15, ${h})`),w=a?"Prime Contract Value":"Contract Value (Filtered)";b.append("text").attr("class","legend-title").attr("x",0).attr("y",-8).style("font-size","10px").style("font-weight","bold").style("fill","var(--color-on-surface)").text(w);const v=g.quantiles(),_=d3.min(f)||0,C=d3.max(f)||1,S=b.selectAll(".legend-item").data(monochromaticPurpleScale.range()).join("g").attr("class","legend-item").attr("transform",((e,t)=>`translate(0, ${18*t})`));S.append("rect").attr("width",14).attr("height",14).attr("fill",(e=>e)),S.append("text").attr("x",19).attr("y",7).attr("dy","0.35em").style("font-size","9px").style("fill","var(--color-on-surface)").text(((e,t)=>{const a=monochromaticPurpleScale.range().length,n=0===t?_:v[t-1],r=t<v.length?v[t]:C;return 0===v.length?"All Values":0===t?`< ${formatCurrency(r)}`:t===a-1||r<=n?`≥ ${formatCurrency(n)}`:`${formatCurrency(n)} - ${formatCurrency(r)}`}))})).catch((e=>{console.error("Error processing or rendering map GeoJSON data:",e),t.html(`\n            <div class="error-message">\n                <p>Error loading map data: ${e.message}</p>\n                <p>Please try refreshing the page.</p>\n            </div>\n        `)}))}function getDisplayName(e){return"agency"!==e.type&&"subagency"!==e.type||!e.acronym?e.name:e.acronym}function updateActiveFiltersDisplay(){const e=document.getElementById("active-filters");if(!e)return void console.warn("Active filter display container (#active-filters) not found.");const t=getAgencyDisplayName(),a=currentAgency&&currentAgency.endsWith("_primes"),n=formatCurrencyWithSuffix(minContractValue),r=(new Date).getFullYear(),o=`<h2 class="agency-filter-title">${t} ${a?'<span class="prime-data-badge">PRIME CONTRACTS</span>':`FY${r}`}</h2>`;let i="",s=!1;if(i+=`<span class="filter-item"><span class="filter-label">Showing&nbsp;${a?"Contracts":"Subcontracts"}&nbsp;>&nbsp;${n}</span>`,s=!0,currentSubAgencyFilter&&(i+=`<span class="filter-separator">|</span> <span class="filter-item"><span class="filter-label">SubAgency:</span> <strong>${truncateText(currentSubAgencyFilter,30)}</strong></span>`,s=!0),currentOfficeFilter&&(i+=`<span class="filter-separator">|</span> <span class="filter-item"><span class="filter-label">Office:</span> <strong>${truncateText(currentOfficeFilter,30)}</strong></span>`,s=!0),currentNaicsFilter){const e=document.getElementById("naics-filter");let t=currentNaicsFilter,a=currentNaicsFilter;if(e){const n=Array.from(e.options).find((e=>e.value===currentNaicsFilter));n&&(a=n.textContent,t=n.value)}i+=`<span class="filter-separator">|</span> <span class="filter-item" title="${a}"><span class="filter-label">NAICS:</span> <strong>${t}</strong></span>`,s=!0}currentPrimeFilter&&!a&&(i+=`<span class="filter-separator">|</span> <span class="filter-item"><span class="filter-label">Prime:</span> <strong>${truncateText(currentPrimeFilter,30)}</strong></span>`,s=!0),currentSubFilter&&!a&&(i+=`<span class="filter-separator">|</span> <span class="filter-item"><span class="filter-label">Sub:</span> <strong>${truncateText(currentSubFilter,30)}</strong></span>`,s=!0),currentSearchTerm&&(i+=`<span class="filter-separator">|</span> <span class="filter-item"><span class="filter-label">Search:</span> <strong>"${truncateText(currentSearchTerm,20)}"</strong></span>`,s=!0);let l=o;s&&(l+=`<div class="other-filters">${i}</div>`),e.innerHTML=l,console.log(`Updated Active Filters Display. Agency=${t}, Type=${a?"Prime Contracts":"Subawards"}, View=${currentVizType}`)}function updateLegend(e){const t=document.getElementById("legend");if(t)switch(t.innerHTML="",e){case"sankey":case"treemap":if(activeLevels.forEach((e=>{const a=monochromaticPurpleScale(e);if(a){const n=document.createElement("div");n.className="legend-item";const r=document.createElement("div");r.className="legend-color",r.style.backgroundColor=a,r.style.borderRadius="3px";const o=document.createElement("span");o.textContent=capitalizeFirstLetter(e),n.appendChild(r),n.appendChild(o),t.appendChild(n)}else console.warn(`Could not get color from purpleHierarchyColorScale for legend level: ${e}`)})),"treemap"===e){const e=document.createElement("div");e.className="legend-item legend-instruction",e.style.flexBasis="100%",e.style.marginTop="8px",e.innerHTML="<span><strong>Tip:</strong> Click cells to focus data. Click 'All Data' breadcrumb to reset.</span>",t.appendChild(e)}break;case"network":nodeTypes.forEach((e=>{const a=monochromaticPurpleScale(e);if(a&&activeLevels.includes(e)){const n=document.createElement("div");n.className="legend-item";const r=document.createElement("div");r.className="legend-color",r.style.backgroundColor=a,r.style.borderRadius="3px";const o=document.createElement("span");o.textContent=capitalizeFirstLetter(e),n.appendChild(r),n.appendChild(o),t.appendChild(n)}else a||console.warn(`Could not get color from nodeTypeCategoricalColorScale for legend level: ${e}`)}));const a=document.createElement("div");a.className="legend-item size-legend",a.innerHTML="<span>Node size represents contract value</span>",t.appendChild(a);break;case"choropleth":t.innerHTML='<div class="legend-item"><span>Map legend generated within map area</span></div>';break;default:console.warn(`updateLegend: No specific legend logic for vizType: ${e}`)}}function showNodeTooltip(e,t){const a=d3.select("#tooltip");if(!a.node())return;const n=formatCurrency(t.value);let r=`<h4>${t.name}</h4><p><strong>Type:</strong> ${capitalizeFirstLetter(t.type)}</p><p><strong>Value:</strong> ${n}</p>`;r+=isTouchDevice()?"<p><em>Tap to focus on this node</em></p>":"<p><em>Click to focus on this node</em></p>",a.html(r).classed("visible",!0).attr("aria-hidden","false"),positionTooltip(a,e)}function showLinkTooltip(e,t){const a=d3.select("#tooltip");if(!a.node())return;const n=formatCurrency(t.value);let r=`<h4>${t.source.name} → ${t.target.name}</h4><p><strong>Value:</strong> ${n}</p>`;t.details?.naicsCode&&(r+=`<p><strong>NAICS:</strong> ${t.details.naicsCode} - ${t.details.naicsDesc||"N/A"}</p>`),t.details?.percentage&&(r+=`<p><strong>Percentage:</strong> ${t.details.percentage}</p>`),a.html(r).classed("visible",!0).attr("aria-hidden","false"),positionTooltip(a,e)}function hideTooltip(){d3.select("#tooltip").classed("visible",!1).attr("aria-hidden","true")}function positionTooltip(e,t){const a=e.node();if(!a)return;const n=isTouchDevice()?20:15,r=a.offsetWidth,o=a.offsetHeight,i=window.innerWidth,s=window.innerHeight;let l=t.pageX+n,c=t.pageY+n;l+r>i&&(l=Math.max(5,t.pageX-r-n)),c+o>s&&(c=Math.max(5,t.pageY-o-n)),isTouchDevice()&&(c=Math.min(c,s-o-10)),e.style("left",`${l}px`).style("top",`${c}px`)}function showMapTooltip(e,t,a){const n=d3.select("#tooltip");if(!n.node())return;const r=getTopContractorsForState(t,1);let o=`<h4>${getStateFullName(t)}</h4><p><strong>Total Contract Value:</strong> ${formatCurrency(a)}</p>`;r.length>0&&(o+=`<p><strong>Top Contractor:</strong> ${r[0].name}</p>`);const i=getContractCountForState(t);i>0&&(o+=`<p><strong>Contracts:</strong> ${i}</p>`),o+="<p><em>Click for more details</em></p>",n.html(o).classed("visible",!0).attr("aria-hidden","false"),positionTooltip(n,e)}function nodeClicked(e,t){currentFocusNode&&currentFocusNode.id===t.id?(currentFocusNode=null,closeInfoPanel()):(currentFocusNode={id:t.id,name:t.name,type:t.type},showInfoPanel(t),isTouchDevice()&&window.navigator.vibrate&&window.navigator.vibrate(50)),currentVizType?updateVisualization(currentVizType):(console.warn("currentVizType not set, defaulting to Sankey update"),applyFiltersAndDraw()),updateDataTable()}function showInfoPanel(e){const t=document.getElementById("info-panel");if(!t)return void console.error("Info panel element not found.");const a=document.getElementById("info-panel-title"),n=document.getElementById("info-panel-content"),r=document.getElementById("info-panel-link");if(!a||!n||!r)return console.error("Info panel child elements (title, content, link) not found! Check IDs in index.html."),void(t&&(t.innerHTML='<p style="padding: 10px; color: red;">Error: Panel structure incomplete.</p>'));if(t.style.display="block",!(e&&e.id&&e.name&&e.type))return console.warn("showInfoPanel called with invalid node data:",e),a.textContent="Details Unavailable",n.innerHTML="<p>Error: Invalid node data provided.</p>",r.style.display="none",t.removeAttribute("inert"),void t.classList.add("visible");if(a.textContent=e.name,n.innerHTML="",addInfoItem(n,"Type",capitalizeFirstLetter(e.type)),addInfoItem(n,"Total Value",formatCurrency(e.value||0)),processedData&&processedData.links&&processedData.nodes)try{const t=Object.values(processedData.links).flat(),a=Object.values(processedData.nodes).flat();const r=t.filter((t=>{const a="object"==typeof t?.source?t.source.id:t?.source,n="object"==typeof t?.target?t.target.id:t?.target;return t&&(a===e.id||n===e.id)})).map((t=>{const n="object"==typeof t.source?t.source.id:t.source,r="object"==typeof t.target?t.target.id:t.target,o=n===e.id,i=o?r:n,s=a.find((e=>e&&e.id===i));return{name:s?.name||i?.split("-").slice(1).join("-")||"Unknown Entity",type:s?.type||i?.split("-")[0]||"unknown",value:t.value||0,relation:o?"outgoing":"incoming",details:t.details||{}}})).sort(((e,t)=>t.value-e.value)),o=r.filter((e=>"incoming"===e.relation)),i=r.filter((e=>"outgoing"===e.relation)),s=(e,t)=>{e.length>0&&(addInfoSection(n,t),e.slice(0,5).forEach((e=>addInfoItem(n,e.name,formatCurrency(e.value)))))};"prime"===e.type?s(i,"Top Subcontractors"):"sub"===e.type?s(o,"Top Prime Contractors"):(s(o,"Top Incoming"),s(i,"Top Outgoing"),0===o.length&&i.length)}catch(e){console.error("Error processing node connection details:",e),addInfoItem(n,"Error","Could not load connection details.")}else console.warn("Processed data not available for detailed info panel connections."),addInfoItem(n,"Connections","Processing...");if("prime"===e.type||"sub"===e.type){const t=e.name;if(t&&"N/A"!==t&&!t.toLowerCase().includes("unknown")){const e=encodeURIComponent(t);addInfoSection(n,"External Links");const a=document.createElement("dd");a.classList.add("info-panel-context-links"),a.innerHTML=`\n                <a href="https://www.google.com/search?q=${e}+careers" target="_blank" rel="noopener noreferrer" title="Search Careers for ${t}" class="context-link">\n                    <span class="material-symbols-outlined" aria-hidden="true">work</span> Careers\n                </a>\n                <a href="https://news.google.com/search?q=${e}" target="_blank" rel="noopener noreferrer" title="Search News for ${t}" class="context-link">\n                    <span class="material-symbols-outlined" aria-hidden="true">feed</span> News\n                </a>\n                <a href="https://www.linkedin.com/search/results/companies/?keywords=${e}" target="_blank" rel="noopener noreferrer" title="Search LinkedIn for ${t}" class="context-link">\n                    <span class="material-symbols-outlined" aria-hidden="true">business_center</span> LinkedIn\n                </a>\n            `,n.appendChild(a)}}let o="#";if(processedData&&processedData.links)try{const t=Object.values(processedData.links).flat().find((t=>(t?.source===e.id||t?.target===e.id)&&t?.details?.permalink&&"string"==typeof t.details.permalink&&"#"!==t.details.permalink&&t.details.permalink.startsWith("http")));if(t)o=t.details.permalink;else{const t=rawData?.find((t=>`prime-${t?.prime_awardee_name}`===e.id||`sub-${t?.subawardee_name}`===e.id||`office-${t?.prime_award_awarding_office_name}`===e.id||`subagency-${t?.prime_award_awarding_sub_agency_name}`===e.id||`agency-${t?.prime_award_awarding_agency_name}`===e.id));t?.usaspending_permalink&&"string"==typeof t.usaspending_permalink&&t.usaspending_permalink.startsWith("http")?o=t.usaspending_permalink:console.log("No valid permalink found for info panel link.")}}catch(e){console.error("Error finding permalink for info panel:",e),o="#"}const i=o&&"#"!==o&&o.startsWith("http");r.href=i?o:"#",r.style.display=i?"inline-flex":"none",i?(r.setAttribute("target","_blank"),r.setAttribute("rel","noopener noreferrer")):(r.removeAttribute("target"),r.removeAttribute("rel")),t.removeAttribute("inert"),t.classList.add("visible")}function closeInfoPanel(){const e=document.getElementById("info-panel");e&&(e.classList.remove("visible"),e.setAttribute("inert",""))}function addInfoSection(e,t){const a=document.createElement("dt");a.textContent=t,e.appendChild(a)}function addInfoItem(e,t,a){const n=document.createElement("dt");n.textContent=t;const r=document.createElement("dd");r.textContent=a,e.appendChild(n),e.appendChild(r)}function showEnhancedStateInfoPanel(e,t){console.log(`Showing enhanced state info panel for state: ${e} with value: ${formatCurrency(t)}`);const a=document.getElementById("info-panel");if(!a)return void console.error("Info panel not found in the DOM");const n=document.getElementById("info-panel-title"),r=document.getElementById("info-panel-content"),o=document.getElementById("info-panel-link");if(!n||!r||!o)return void console.error("Info panel elements not found");const i=currentAgency&&currentAgency.endsWith("_primes");let s=0;rawData.forEach((t=>{getNormalizedStateCode(t)===e&&s++})),console.log(`Found ${s} records with state code: ${e}`);const l=getStateFullName(e);n.textContent=`${l} ${i?"Prime Contracts":"Contracts"}`,r.innerHTML="",addInfoItem(r,"Total Contract Value",formatCurrency(t));const c=getContractCountForState(e);addInfoItem(r,"Total Contracts",c.toLocaleString()),console.log(`getContractCountForState returned ${c} contracts for state ${e}`);const d=getTopContractorsForState(e,5,"prime");if(console.log(`getTopContractorsForState returned ${d.length} prime contractors for state ${e}`),d.length>0?(addInfoSection(r,"Top Prime Contractors"),d.forEach((e=>addInfoItem(r,e.name,formatCurrency(e.value))))):console.log("No top prime contractors found for state"),!i){const t=getTopContractorsForState(e,5,"sub");console.log(`getTopContractorsForState returned ${t.length} sub contractors for state ${e}`),t.length>0?(addInfoSection(r,"Top Subcontractors"),t.forEach((e=>addInfoItem(r,e.name,formatCurrency(e.value))))):console.log("No top subcontractors found for state")}const u=getTopNaicsForState(e,3);console.log(`getTopNaicsForState returned ${u.length} NAICS codes for state ${e}`),u.length>0?(addInfoSection(r,"Primary Industry Categories"),u.forEach((e=>addInfoItem(r,`${e.code}`,`${e.desc} (${formatCurrency(e.value)})`)))):console.log("No top NAICS codes found for state");const p=`https://www.usaspending.gov/state/${l.toLowerCase().replace(/\s+/g,"-")}`;o.href=p,o.style.display="inline-flex",a.classList.add("visible"),a.removeAttribute("inert"),console.log("Info panel displayed successfully")}function showMapTooltip(e,t,a){const n=d3.select("#tooltip");if(!n.node())return;const r=getTopContractorsForState(t,1);let o=`<h4>${getStateFullName(t)}</h4><p><strong>Total Contract Value:</strong> ${formatCurrency(a)}</p>`;r.length>0&&(o+=`<p><strong>Top Contractor:</strong> ${r[0].name}</p>`);const i=getContractCountForState(t);i>0&&(o+=`<p><strong>Contracts:</strong> ${i}</p>`),o+="<p><em>Click for more details</em></p>",n.html(o).classed("visible",!0).attr("aria-hidden","false"),positionTooltip(n,e)}function getContractCountForState(e){if(!rawData||0===rawData.length)return 0;const t=currentAgency&&currentAgency.endsWith("_primes"),a=new Set;return rawData.forEach((n=>{if(getNormalizedStateCode(n)!==e)return;let r=!0;if(currentSearchTerm){[n.prime_award_awarding_agency_name,n.prime_award_awarding_sub_agency_name,n.prime_award_awarding_office_name,n.prime_awardee_name,t?null:n.subawardee_name,n.prime_award_naics_code?.toString(),n.prime_award_naics_description].filter(Boolean).some((e=>e&&"string"==typeof e&&e.toLowerCase().includes(currentSearchTerm)))||(r=!1)}r&&currentSubAgencyFilter&&n.prime_award_awarding_sub_agency_name!==currentSubAgencyFilter&&(r=!1),r&&currentOfficeFilter&&n.prime_award_awarding_office_name!==currentOfficeFilter&&(r=!1),r&&currentNaicsFilter&&n.prime_award_naics_code?.toString()!==currentNaicsFilter&&(r=!1),r&&currentPrimeFilter&&n.prime_awardee_name!==currentPrimeFilter&&(r=!1),!t&&r&&currentSubFilter&&n.subawardee_name!==currentSubFilter&&(r=!1);const o="number"==typeof n.subaward_amount?n.subaward_amount:parseFloat(String(n.subaward_amount||"0").replace(/[^0-9.-]+/g,""))||0;if(o<=0&&(r=!1),r){const e=t?n.award_id_piid||n.contract_award_unique_key||`${n.prime_awardee_name}-${n.action_date}-${o}`:n.subaward_unique_key||n.prime_award_unique_key||`${n.prime_awardee_name}-${n.subawardee_name}-${n.action_date}-${o}`;a.add(e)}})),a.size}function getTopNaicsForState(e,t=3){if(!rawData||0===rawData.length)return[];const a=currentAgency&&currentAgency.endsWith("_primes"),n={};rawData.forEach((t=>{if(getNormalizedStateCode(t)!==e)return;let r=!0;if(currentSearchTerm){[t.prime_award_awarding_agency_name,t.prime_award_awarding_sub_agency_name,t.prime_award_awarding_office_name,t.prime_awardee_name,a?null:t.subawardee_name,t.prime_award_naics_code?.toString(),t.prime_award_naics_description].filter(Boolean).some((e=>e&&"string"==typeof e&&e.toLowerCase().includes(currentSearchTerm)))||(r=!1)}r&&currentSubAgencyFilter&&t.prime_award_awarding_sub_agency_name!==currentSubAgencyFilter&&(r=!1),r&&currentOfficeFilter&&t.prime_award_awarding_office_name!==currentOfficeFilter&&(r=!1),r&&currentPrimeFilter&&t.prime_awardee_name!==currentPrimeFilter&&(r=!1),!a&&r&&currentSubFilter&&t.subawardee_name!==currentSubFilter&&(r=!1);const o="number"==typeof t.subaward_amount?t.subaward_amount:parseFloat(String(t.subaward_amount||"0").replace(/[^0-9.-]+/g,""))||0;if(o<=0&&(r=!1),r){const e=t.prime_award_naics_code?.toString().trim()||"Unknown",a=t.prime_award_naics_description?.trim()||"Unknown Description";if("Unknown"===e)return;const r=`${e}`;n[r]||(n[r]={code:e,desc:a,value:0}),n[r].value+=o}}));return Object.values(n).sort(((e,t)=>t.value-e.value)).slice(0,t)}function generateInsights(e,t,a){const n=[];if(!(e&&e.stats&&e.nodes&&e.nodes.prime&&e.nodes.sub&&e.links&&e.links.contractorToSubcontractor&&!(a<=0)))return console.warn("generateInsights: Missing required processedData components."),["Insufficient data available for generating insights."];try{const r=e.unfilteredNodes?.prime?.[0];r&&r.value/a>.15&&n.push(`Prime <strong>${truncateText(r.name,30)}</strong> is associated with over 15% (${formatCurrency(r.value)}) of the total subaward value in this view.`);const o=e.unfilteredNodes?.sub?.[0];o&&o.value/a>.15&&n.push(`Sub <strong>${truncateText(o.name,30)}</strong> received over 15% (${formatCurrency(o.value)}) of the total subaward value in this view.`);const i=e.nodes?.prime||[],s=e.links?.contractorToSubcontractor||[];if(i.length>0&&s.length>0){let e={};s.forEach((t=>{t&&t.source&&t.target&&(e[t.source]||(e[t.source]=new Set),e[t.source].add(t.target))}));let t=0,a=[];if(i.forEach((n=>{const r=e[n.id]?.size||0;r>t?(t=r,a=[n.name]):r===t&&t>0&&a.push(n.name)})),t>0){const e=a.map((e=>`<strong>${truncateText(e,30)}</strong>`)).join(", ");n.push(`${e} worked with the most unique subs (${t}) in this filtered view.`)}}if(t&&t.length>0){const e=[...t].sort(((e,t)=>{const a=e.endDate instanceof Date&&!isNaN(e.endDate)?e.endDate.getTime():1/0,n=t.endDate instanceof Date&&!isNaN(t.endDate)?t.endDate.getTime():1/0;return a<n?-1:a>n?1:(t.amount||0)-(e.amount||0)}));n.push("<strong>Potential Contract Expirations (Next ~6 Mo)</strong>");e.slice(0,3).forEach((e=>{const t=e.permalink&&"#"!==e.permalink&&"string"==typeof e.permalink&&e.permalink.startsWith("http")?`<a href="${e.permalink}" class="detail-link" target="_blank" rel="noopener noreferrer" style="margin-left: 5px;" title="View on USAspending.gov">View</a>`:"";n.push(`- ~${e.endDateStr}: <strong>${truncateText(e.prime,25)}</strong> / ${truncateText(e.sub,25)} (${formatCurrency(e.amount)}) ${t}`)}))}else n.push(`No contracts identified as potentially expiring (> ${formatCurrency(expiringAmountThreshold)}) in the next ~6 months for this agency.`)}catch(e){console.error("Error generating insights:",e),n.push("Could not generate all insights due to an error.")}return n.length>0?n:["No specific insights generated for the current view."]}function displayInsights(e){const t=document.getElementById("insights-list");t&&(t.innerHTML="",e&&0!==e.length?e.slice(0,5).forEach((e=>{const a=document.createElement("li");a.innerHTML=e,t.appendChild(a)})):t.innerHTML='<li class="placeholder">No insights available.</li>')}function updateBreadcrumb(){const e=document.getElementById("breadcrumb");if(e)if(e.innerHTML='<a href="#" data-action="reset">All Data</a>',e.classList.remove("visually-hidden"),e.setAttribute("aria-hidden","false"),currentFocusNode){const t=document.createElement("span");t.className="separator",t.textContent=" › ";const a=document.createElement("span");a.textContent=currentFocusNode.name,e.appendChild(t),e.appendChild(a)}else if(currentMapFocusState){const t=document.createElement("span");t.className="separator",t.textContent=" › ";const a=getStateFullName(currentMapFocusState),n=document.createElement("span");n.textContent=a,e.appendChild(t),e.appendChild(n)}else e.classList.add("visually-hidden"),e.setAttribute("aria-hidden","true")}function handleBreadcrumbClick(e){e.target.closest('a[data-action="reset"]')&&(e.preventDefault(),currentFocusNode=null,currentMapFocusState=null,closeInfoPanel(),d3.select("#map-chart .states path.focused-state").classed("focused-state",!1).attr("stroke","#fff").attr("stroke-width",.5),updateBreadcrumb(),currentVizType?updateVisualization(currentVizType):applyFiltersAndDraw(),updateDataTable())}function debounceMinValueUpdate(){clearTimeout(minValueUpdateTimeout),minValueUpdateTimeout=setTimeout((()=>{updateMinValueFilter()}),250)}function updateMinValueFilter(){const e=document.getElementById("min-value"),t=document.getElementById("min-value-display");if(!e||!t)return;minContractValue=parseInt(e.value),t.textContent=formatCurrency(minContractValue),userChangedMinValue=!0;const a=document.querySelector(".visualization");a&&a.offsetHeight,currentVizType?updateVisualization(currentVizType):(console.warn("currentVizType not set on slider change, defaulting to Sankey update"),applyFiltersAndDraw()),updateDataTable()}function toggleLevelFilter(e){const t=e.currentTarget,a=t.getAttribute("data-level"),n=t.classList.toggle("active");n?activeLevels.push(a):activeLevels=activeLevels.filter((e=>e!==a)),activeLevels.sort(((e,t)=>["agency","subagency","office","prime","sub"].indexOf(e)-["agency","subagency","office","prime","sub"].indexOf(t))),t.setAttribute("aria-pressed",n?"true":"false"),currentVizType?updateVisualization(currentVizType):applyFiltersAndDraw(),updateDataTable(),isTouchDevice()&&window.navigator.vibrate&&window.navigator.vibrate(30)}function changeAgency(){const e=document.getElementById("agency-selector");if(!e)return;const t=e.value;console.log(`Agency changing to: ${t}`),minContractValue=DEFAULT_MIN_VALUE,userChangedMinValue=!1;const a=document.getElementById("min-value"),n=document.getElementById("min-value-display");a&&(a.value=minContractValue),n&&(n.textContent=formatCurrencyWithSuffix(minContractValue)),currentFocusNode=null,currentMapFocusState=null,currentSubAgencyFilter="",currentOfficeFilter="",currentNaicsFilter="",currentPrimeFilter="",currentSubFilter="",currentSearchTerm="";const r=document.getElementById("subagency-filter");r&&(r.value="");const o=document.getElementById("office-filter");o&&(o.value="");const i=document.getElementById("naics-filter");i&&(i.value="");const s=document.getElementById("prime-filter");s&&(s.value="");const l=document.getElementById("sub-filter");l&&(l.value="");const c=document.getElementById("data-search");c&&(c.value="");const d=document.getElementById("search-clear-btn");d&&(d.style.display="none"),d3.select("#map-chart .states path.focused-state").classed("focused-state",!1).attr("stroke","#fff").attr("stroke-width",.5),closeInfoPanel(),updateBreadcrumb(),loadAgencyData(t)}function resetFilters(e=!0){currentSearchTerm="";const t=document.getElementById("data-search");t&&(t.value="");const a=document.getElementById("search-clear-btn");a&&(a.style.display="none"),topNFilterValue=0,currentSubAgencyFilter="";const n=document.getElementById("subagency-filter");n&&(n.value=""),currentOfficeFilter="";const r=document.getElementById("office-filter");r&&(r.value=""),currentNaicsFilter="";const o=document.getElementById("naics-filter");o&&(o.value=""),currentPrimeFilter="";const i=document.getElementById("prime-filter");i&&(i.value=""),currentSubFilter="";const s=document.getElementById("sub-filter");s&&(s.value=""),userChangedMinValue=!1;const l=document.getElementById("min-value"),c=document.getElementById("min-value-display");l&&c&&(minContractValue="choropleth"===currentVizType?CHOROPLETH_MIN_VALUE:DEFAULT_MIN_VALUE,l.value=minContractValue,c.textContent=formatCurrencyWithSuffix(minContractValue)),activeLevels=["agency","subagency","office","prime","sub"],document.querySelectorAll("#level-filters button").forEach((e=>{const t=e.getAttribute("data-level");activeLevels.includes(t)?(e.classList.add("active"),e.setAttribute("aria-pressed","true")):(e.classList.remove("active"),e.setAttribute("aria-pressed","false"))})),currentFocusNode=null,closeInfoPanel(),currentMapFocusState=null,d3.select("#map-chart .states path.focused-state").classed("focused-state",!1).attr("stroke","#fff").attr("stroke-width",.5),updateBreadcrumb(),rawData&&rawData.length>0&&e?(console.log("Reset Filters triggering redraw..."),processData()):e&&(updateActiveFiltersDisplay(),updateDataTable()),e&&showNotification("All filters have been reset.","info"),processedData&&processedData.stats&&updateTotalValueCard(processedData.stats.totalContractValue)}function toggleTheme(e){e&&e.preventDefault();const t=document.body.classList.toggle("light-mode"),a=document.getElementById("theme-toggle"),n=a?a.querySelector(".material-symbols-outlined"):null;a&&n&&(t?(n.textContent="dark_mode",a.setAttribute("aria-label","Switch to Dark Mode"),a.setAttribute("aria-pressed","false"),updateThemeColor("#F4F2F6")):(n.textContent="light_mode",a.setAttribute("aria-label","Switch to Light Mode"),a.setAttribute("aria-pressed","true"),updateThemeColor("#252327"))),currentVizType?updateVisualization(currentVizType):currentSankeyData&&drawSankeyDiagram(currentSankeyData)}function updateStatsDisplay(){const e=document.getElementById("total-value"),t=document.getElementById("naics-donut-chart"),a=document.getElementById("top-primes-bar-chart"),n=document.getElementById("top-subs-bar-chart"),r=document.getElementById("prime-chart-title"),o=document.getElementById("sub-chart-title");if(!processedData||!processedData.stats||!processedData.nodes)return console.warn("Stats display update skipped: processedData not fully ready."),e&&(e.textContent="$0"),t&&(t.innerHTML='<span class="chart-placeholder">No data</span>'),a&&(a.innerHTML='<span class="chart-placeholder">No data</span>'),n&&(n.innerHTML='<span class="chart-placeholder">No data</span>'),r&&(r.innerHTML='0 Primes w/ Subs <span style="font-weight:normal; font-size:0.8em;">(Top 5 by Value)</span>'),void(o&&(o.innerHTML='0 Total Subs <span style="font-weight:normal; font-size:0.8em;">(Top 5 by Value)</span>'));e?e.textContent=formatCurrencyWithSuffix(processedData.stats.totalContractValue):console.warn("Stats element 'total-value' not found."),t&&processedData.stats.filteredNaicsBreakdown&&"function"==typeof drawNaicsDonut&&drawNaicsDonut(processedData.stats.filteredNaicsBreakdown,"naics-donut-chart",5),a&&processedData.nodes.prime&&("function"==typeof drawTopNBarChart?drawTopNBarChart(processedData.nodes.prime,"top-primes-bar-chart","prime-chart-title",processedData.stats.uniquePrimeContractorCount,"prime",5):(console.error("drawTopNBarChart function is not defined."),a&&(a.innerHTML='<span class="chart-placeholder">Chart Error</span>'),r&&(r.innerHTML=`${processedData.stats.uniquePrimeContractorCount.toLocaleString()} Primes w/ Subs <span style="font-weight:normal; font-size:0.8em;">(Top 5 by Filtered Value)</span>`))),n&&processedData.nodes.sub&&("function"==typeof drawTopNBarChart?drawTopNBarChart(processedData.nodes.sub,"top-subs-bar-chart","sub-chart-title",processedData.stats.uniqueSubcontractorCount,"sub",5):(console.error("drawTopNBarChart function is not defined."),n&&(n.innerHTML='<span class="chart-placeholder">Chart Error</span>'),o&&(o.innerHTML=`${processedData.stats.uniqueSubcontractorCount.toLocaleString()} Total Subcontractors <span style="font-weight:normal; font-size:0.8em;">(Top 5 by Filtered Value)</span>`)))}function truncateText(e,t){return e?t<=3?e.length>t?e.substring(0,t):e:e.length>t?e.substring(0,t-3)+"...":e:""}function formatCurrency(e){return"number"!=typeof e||isNaN(e)?"$?":new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(e)}function formatCurrencyWithSuffix(e){if("number"!=typeof e||isNaN(e))try{const t=String(e).replace(/[^\d.-]+/g,"");if(e=parseFloat(t),isNaN(e))return"$0"}catch(e){return"$0"}return Math.abs(e)>=1e9?`$${(e/1e9).toFixed(1)}B`:Math.abs(e)>=1e6?`$${(e/1e6).toFixed(1)}M`:Math.abs(e)>=1e3?`$${(e/1e3).toFixed(1)}K`:new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(e)}function truncateText(e,t){return e?t<=3?e.length>t?e.substring(0,t):e:e.length>t?e.substring(0,t-3)+"...":e:""}function loadAgencyData(e){console.log(`Loading data for agency: ${e}`),showLoading(),currentAgency=e,currentFocusNode=null,rawData=[],processedData=null,currentSankeyData=null;const t=e.endsWith("_primes"),a=`https://subhoodata.s3.amazonaws.com/data/${e}.csv`;console.log(`Attempting to load: ${a}`),Papa.parse(a,{download:!0,header:!0,skipEmptyLines:!0,dynamicTyping:!0,complete:function(n){if(console.log(`CSV parsing complete for ${e}. Rows: ${n.data.length}`),n.errors?.length>0&&(console.warn("CSV Errors:",n.errors),showNotification(`CSV parsed with ${n.errors.length} errors.`,"warning")),!n.data||0===n.data.length)return console.error(`No data loaded from ${a}`),rawData=[],processedData=null,processData(),hideLoading(),void showNotification(`No data found for ${e}.`,"error");t?(console.log("Adapting prime contract data to subaward format"),rawData=adaptPrimeContractData(n.data)):rawData=n.data,populateFilterDropdowns(),processData(),hideLoading()},error:function(t,a){console.error(`Error loading CSV: ${a}`,t),rawData=[],processedData=null,processData(),hideLoading(),showNotification(`Failed to load data for ${e}.`,"error")}})}function processData(){const e=currentAgency&&currentAgency.endsWith("_primes");if(!rawData||0===rawData.length)return console.warn("processData called with no rawData."),processedData={nodes:{agency:[],subagency:[],office:[],prime:[],sub:[]},links:{agencyToSub:[],subToOffice:[],officeToContractor:[],contractorToSubcontractor:[]},stats:{totalContractValue:0,totalPrimeContracts:0,totalSubContracts:0,primaryNaics:{code:"N/A",desc:"",value:0},uniquePrimeContractorCount:0,uniqueSubcontractorCount:0,filteredNaicsBreakdown:[]},unfilteredNodes:{prime:[],sub:[]},unfilteredNaics:[]},updateStatsDisplay(),updateDataTable(),displayTopNTable([],"top-primes-container","Top Prime Contractors",10),displayTopNTable([],"top-subs-container",e?"No Subcontractor Data":"Top Subcontractors",10),displayNaicsTable([],"naics-container","Top NAICS Codes",5),void(currentVizType&&updateVisualization(currentVizType));const t=new Map,a=new Map,n=new Map;rawData.forEach((r=>{const o=r.prime_awardee_name?.trim()||"Unknown Prime Contractor",i=e?null:r.subawardee_name?.trim()||"Unknown Subcontractor",s="number"==typeof r.subaward_amount?r.subaward_amount:parseFloat(String(r.subaward_amount||"0").replace(/[^0-9.-]+/g,""))||0,l=r.prime_award_naics_code?.toString().trim()||"Unknown",c=r.prime_award_naics_description?.trim()||"Unknown";if(!(s<=0)&&("Unknown Prime Contractor"!==o&&(t.has(o)||t.set(o,{id:`prime-${o}`,name:o,type:"prime",value:0}),t.get(o).value+=s),!e&&i&&"Unknown Subcontractor"!==i&&(a.has(i)||a.set(i,{id:`sub-${i}`,name:i,type:"sub",value:0}),a.get(i).value+=s),l&&"Unknown"!==l&&"N/A"!==l&&""!==l)){const e=`${l} - ${c||"No Description"}`;n.set(e,(n.get(e)||0)+s)}}));const r=Array.from(t.values()).sort(((e,t)=>t.value-e.value)),o=Array.from(a.values()).sort(((e,t)=>t.value-e.value)),i=Array.from(n,(([e,t])=>{const a=e.split(" - ");return{code:a[0],desc:a.slice(1).join(" - ").trim()||"No Description",value:t}})).sort(((e,t)=>t.value-e.value)),s=getFilteredTableData(),l=new Map,c=new Map,d=new Map,u=new Map,p=new Map,m=new Map,f=new Map,g=new Map,y=new Map;let h=0,b=new Set,w=new Set;const v=new Set,_=new Set,C=new Map;s.forEach((t=>{const a=t.prime_award_awarding_agency_name?.trim(),n=t.prime_award_awarding_sub_agency_name?.trim(),r=t.prime_award_awarding_office_name?.trim(),o=t.prime_awardee_name?.trim(),i=e?null:t.subawardee_name?.trim(),s=a||"Unknown Agency",S=n||"Unknown Sub-Agency",k=r||"Unknown Office",x=o||"Unknown Prime Contractor",A=e?null:i||"Unknown Subcontractor",D="number"==typeof t.subaward_amount?t.subaward_amount:parseFloat(String(t.subaward_amount||"0").replace(/[^0-9.-]+/g,""))||0,T="number"==typeof t.prime_award_amount?t.prime_award_amount:parseFloat(String(t.prime_award_amount||"0").replace(/[^0-9.-]+/g,""))||0,E=t.usaspending_permalink||"#",N=t.prime_award_naics_code?.toString().trim()||"Unknown",$=t.prime_award_naics_description?.trim()||"Unknown Description",F=t.subaward_primary_place_of_performance_state_code||t.primary_place_of_performance_state_code||t.place_of_performance_state||t.pop_state||t.prime_award_pop_state||"Unknown";if(D<=0||"Unknown Agency"===s||"Unknown Sub-Agency"===S||"Unknown Office"===k||"Unknown Prime Contractor"===x||"Unknown Subcontractor"===A&&!e)return;h+=D,b.add(`${x}|${k}`),e||w.add(`${A}|${x}`),"Unknown Prime Contractor"!==x&&v.add(x),e||"Unknown Subcontractor"===A||_.add(A),l.has(s)||l.set(s,{id:`agency-${s}`,name:s,type:"agency",value:0,acronym:extractAcronym(s)}),l.get(s).value+=D;const I=l.get(s).name;"Unknown Sub-Agency"!==S&&(c.has(S)||c.set(S,{id:`subagency-${S}`,name:S,type:"subagency",value:0,parent:I,acronym:extractAcronym(S)}),c.get(S).value+=D);const M=c.has(S)?c.get(S).name:"Unknown Sub-Agency";"Unknown Office"!==k&&"Unknown Sub-Agency"!==M&&(d.has(k)||d.set(k,{id:`office-${k}`,name:k,type:"office",value:0,parent:M}),d.get(k).value+=D);const L=d.has(k)?d.get(k).name:"Unknown Office";"Unknown Prime Contractor"!==x&&"Unknown Office"!==L&&(u.has(x)||u.set(x,{id:`prime-${x}`,name:x,type:"prime",value:0,parent:L,popState:F}),u.get(x).value+=D);const V=u.has(x)?u.get(x).name:"Unknown Prime Contractor";e||"Unknown Subcontractor"===A||"Unknown Prime Contractor"===V||(p.has(A)||p.set(A,{id:`sub-${A}`,name:A,type:"sub",value:0,parent:V,popState:F}),p.get(A).value+=D);const P=`agency-${I}`,z="Unknown Sub-Agency"!==S?`subagency-${M}`:null,B="Unknown Office"!==k?`office-${L}`:null,U="Unknown Prime Contractor"!==x?`prime-${V}`:null,O=e||"Unknown Subcontractor"===A?null:`sub-${A}`;if(P&&z){const e=`${P}|${z}`;m.has(e)||m.set(e,{source:P,target:z,value:0,details:{sourceType:"agency",targetType:"subagency",permalink:E}}),m.get(e).value+=D}if(z&&B){const e=`${z}|${B}`;f.has(e)||f.set(e,{source:z,target:B,value:0,details:{sourceType:"subagency",targetType:"office",permalink:E}}),f.get(e).value+=D}if(B&&U){const e=`${B}|${U}`;g.has(e)||g.set(e,{source:B,target:U,value:0,details:{sourceType:"office",targetType:"prime",naicsCode:N,naicsDesc:$,permalink:E,popState:F}}),g.get(e).value+=D}if(!e&&U&&O){const e=`${U}|${O}`,t=T>0?(D/T*100).toFixed(2)+"%":"N/A";y.has(e)||y.set(e,{source:U,target:O,value:0,details:{sourceType:"prime",targetType:"sub",naicsCode:N,naicsDesc:$,subValue:D,primeValue:T,percentage:t,permalink:E,popState:F}}),y.get(e).value+=D}if(N&&"Unknown"!==N&&"N/A"!==N&&""!==N){const e=`${N} - ${$}`;C.set(e,(C.get(e)||0)+D)}}));const S=Array.from(C,(([e,t])=>{const a=e.split(" - ");return{code:a[0],desc:a.slice(1).join(" - ").trim()||"No Description",value:t}})).sort(((e,t)=>t.value-e.value));let k={code:"N/A",desc:"",value:0};S.length>0&&(k=S[0]),processedData={nodes:{agency:Array.from(l.values()),subagency:Array.from(c.values()).sort(((e,t)=>t.value-e.value)),office:Array.from(d.values()).sort(((e,t)=>t.value-e.value)),prime:Array.from(u.values()).sort(((e,t)=>t.value-e.value)),sub:Array.from(p.values()).sort(((e,t)=>t.value-e.value))},links:{agencyToSub:Array.from(m.values()),subToOffice:Array.from(f.values()),officeToContractor:Array.from(g.values()),contractorToSubcontractor:Array.from(y.values())},stats:{totalContractValue:h,totalPrimeContracts:b.size,totalSubContracts:w.size,primaryNaics:k,filteredNaicsBreakdown:S,uniquePrimeContractorCount:v.size,uniqueSubcontractorCount:_.size,isPrimeContractData:e},unfilteredNodes:{prime:r,sub:o},unfilteredNaics:i},updateStatsDisplay(),updateDataTable(),displayTopNTable(processedData.unfilteredNodes.prime,"top-primes-container","Top Prime Contractors",10),e?document.getElementById("top-subs-container").innerHTML='\n        <h3>Subcontractor Data</h3>\n        \x3c!-- Empty element to maintain spacing but hide notification --\x3e\n        <div style="height: 20px;"></div>\n    ':displayTopNTable(processedData.unfilteredNodes.sub,"top-subs-container","Top Subcontractors",10),displayNaicsTable(processedData.unfilteredNaics,"naics-container","Top NAICS Codes",7),updateActiveFiltersDisplay(),"function"==typeof updateExpiringContracts?updateExpiringContracts(rawData):console.warn("updateExpiringContracts function not defined yet.");displayInsights(generateInsights(processedData,allExpiringContracts,processedData.stats.totalContractValue)),currentVizType?updateVisualization(currentVizType):applyFiltersAndDraw()}function setupStatsCardTooltips(){const e=document.querySelectorAll(".stats-card"),t=d3.select("#tooltip");t.node()?e.forEach((e=>{e.addEventListener("mouseover",(function(e){const a=this.querySelector("h4"),n=this.querySelector("p");this.querySelector(".stats-chart-container");if(!a)return;const r=a.textContent;let o=n?n.textContent:"",i=`<h4>${r}</h4>`;if(n&&o&&(i+=`<p><strong>Value:</strong> ${o}</p>`),processedData&&processedData.stats)if(r.includes("NAICS")&&processedData.stats.primaryNaics&&"N/A"!==processedData.stats.primaryNaics.code){const e=processedData.stats.primaryNaics,t=processedData.stats.totalContractValue||0,a=t>0?(e.value/t*100).toFixed(1):0;i=`<h4>${e.code} - ${e.desc||"Primary NAICS"}</h4>`,i+=`<p><strong>Value:</strong> ${formatCurrency(e.value)} (${a}%)</p>`,processedData.stats.filteredNaicsBreakdown&&processedData.stats.filteredNaicsBreakdown.length>1&&(i+='<p style="margin-top: 5px; border-top: 1px solid var(--color-outline-variant); padding-top: 5px;"><strong>Other Top NAICS:</strong><br/>',processedData.stats.filteredNaicsBreakdown.slice(1,4).forEach((e=>{i+=`- ${e.code} (${formatCurrency(e.value)})<br/>`})),i+="</p>")}else if(r.includes("Prime")&&processedData.nodes?.prime){i=`<h4>${a.innerHTML}</h4>`;const e=processedData.nodes.prime.slice(0,3);e.length>0&&(i+='<p style="margin-top: 5px; border-top: 1px solid var(--color-outline-variant); padding-top: 5px;"><strong>Top by Value:</strong><br/>',e.forEach((e=>{i+=`- ${e.name} (${formatCurrency(e.value)})<br/>`})),i+="</p>")}else if(r.includes("Subcontractor")&&processedData.nodes?.sub){i=`<h4>${a.innerHTML}</h4>`;const e=processedData.nodes.sub.slice(0,3);e.length>0&&(i+='<p style="margin-top: 5px; border-top: 1px solid var(--color-outline-variant); padding-top: 5px;"><strong>Top by Value:</strong><br/>',e.forEach((e=>{i+=`- ${e.name} (${formatCurrency(e.value)})<br/>`})),i+="</p>")}t.html(i).classed("visible",!0).attr("aria-hidden","false"),positionTooltip(t,e)})),e.addEventListener("mousemove",(e=>{t.classed("visible")&&positionTooltip(t,e)})),e.addEventListener("mouseout",(()=>{hideTooltip()}))})):console.warn("Tooltip element #tooltip not found")}async function discoverAgencies(){console.log("Discovering agencies (including prime contract data)...");const e=document.getElementById("agency-selector");if(!e)return;e.innerHTML="";const t=[{value:"",label:"--- Subaward Data ---",disabled:!0},{value:"army",label:"Army"},{value:"navy",label:"Navy"},{value:"usmc",label:"Marine Corps"},{value:"airforce",label:"Air Force"},{value:"dla",label:"DLA"},{value:"disa",label:"DISA"},{value:"mda",label:"MDA"},{value:"socom",label:"USSOCOM"},{value:"uscc",label:"Cyber Command"},{value:"md",label:"Maryland"},{value:"hhs",label:"HHS"},{value:"va",label:"VA"},{value:"dhs",label:"DHS"},{value:"cbp",label:"CBP"},{value:"treasury",label:"Treasury"},{value:"epa",label:"EPA"},{value:"faa",label:"FAA"},{value:"doj",label:"Dept of Justice"},{value:"dol",label:"Dept of Labor"},{value:"doc",label:"Dept of Commerce"},{value:"doe",label:"Dept of Energy"},{value:"ssa",label:"Social Security"},{value:"dos",label:"Dept of State"},{value:"dot",label:"Dept of Transportation"},{value:"usda",label:"USDA"},{value:"gsa",label:"GSA"},{value:"nasa",label:"NASA"},{value:"",label:"--- Prime Contracts (Huge Files!) ---",disabled:!0},{value:"va_primes",label:"VA - Prime Contracts"},{value:"dhs_primes",label:"DHS - Prime Contracts"},{value:"epa_primes",label:"EPA - Prime Contracts"},{value:"army_primes",label:"Army - Prime Contracts"},{value:"navy_primes",label:"Navy - Prime Contracts"},{value:"usmc_primes",label:"Marine Corps - Prime Contracts"},{value:"socom_primes",label:"USSOCOM - Prime Contracts"}];if(t.length>0){t.forEach((t=>{const a=document.createElement("option");a.value=t.value,a.textContent=t.label,t.disabled&&(a.disabled=!0),e.appendChild(a)}));const a=t.filter((e=>e.value&&!e.disabled)),n=a.find((e=>e.value===currentAgency))?currentAgency:a.length>0?a[0].value:"";currentAgency=n,e.value=n,loadAgencyData(n)}else console.error("No agencies available to populate dropdown.")}function showLoading(){const e=document.getElementById("loading");e&&(e.style.display="flex",e.setAttribute("aria-hidden","false"))}function hideLoading(){const e=document.getElementById("loading");e&&(e.style.display="none",e.setAttribute("aria-hidden","true"))}function getTopPerformanceStates(e=3){if(!rawData||0===rawData.length)return[];currentAgency&&currentAgency.endsWith("_primes");const t={};rawData.forEach((e=>{const a="number"==typeof e.subaward_amount?e.subaward_amount:parseFloat(String(e.subaward_amount||"0").replace(/[^0-9.-]+/g,""))||0;if(a<CHOROPLETH_MIN_VALUE)return;const n=e.subaward_primary_place_of_performance_state_code||e.primary_place_of_performance_state_code||e.place_of_performance_state||e.pop_state||e.prime_award_pop_state;if(!n||2!==n.length)return;const r=n.toUpperCase();t[r]=(t[r]||0)+a}));return Object.entries(t).map((([e,t])=>({code:e,name:getStateFullName(e),value:t}))).sort(((e,t)=>t.value-e.value)).slice(0,e)}function getTopContractorsForState(e,t=3,a="all"){if(!rawData||0===rawData.length)return[];const n=currentAgency&&currentAgency.endsWith("_primes"),r={};if(rawData.forEach((t=>{if(getNormalizedStateCode(t)!==e)return;const o="number"==typeof t.subaward_amount?t.subaward_amount:parseFloat(String(t.subaward_amount||"0").replace(/[^0-9.-]+/g,""))||0;let i=!0;if(currentSearchTerm){[t.prime_award_awarding_agency_name,t.prime_award_awarding_sub_agency_name,t.prime_award_awarding_office_name,t.prime_awardee_name,n?null:t.subawardee_name,t.prime_award_naics_code?.toString(),t.prime_award_naics_description].filter(Boolean).some((e=>e&&"string"==typeof e&&e.toLowerCase().includes(currentSearchTerm)))||(i=!1)}if(i&&currentSubAgencyFilter&&t.prime_award_awarding_sub_agency_name!==currentSubAgencyFilter&&(i=!1),i&&currentOfficeFilter&&t.prime_award_awarding_office_name!==currentOfficeFilter&&(i=!1),i&&currentNaicsFilter&&t.prime_award_naics_code?.toString()!==currentNaicsFilter&&(i=!1),i&&currentPrimeFilter&&t.prime_awardee_name!==currentPrimeFilter&&(i=!1),!n&&i&&currentSubFilter&&t.subawardee_name!==currentSubFilter&&(i=!1),o<=0&&(i=!1),!i)return;const s=t.prime_awardee_name?.trim()||"Unknown Prime",l=n?null:t.subawardee_name?.trim()||"Unknown Sub";"all"!==a&&"prime"!==a||"Unknown Prime"===s||(r[s]=(r[s]||0)+o),n||"all"!==a&&"sub"!==a||"Unknown Sub"===l||(r[l]=(r[l]||0)+o)})),n&&"sub"===a)return[];return Object.entries(r).map((([e,t])=>({name:e,value:t}))).sort(((e,t)=>t.value-e.value)).slice(0,t)}function displayTopNTable(e,t,a,n=5){const r=document.getElementById(t);if(!r)return void console.error(`Container element not found: #${t}`);const o=(Array.isArray(e)?e:[]).slice(0,n);let i=`<h3>${a} for ${getAgencyDisplayName()}</h3>`;if(0===o.length)i+='<p class="empty-message">No data available.</p>';else{const e=o.length>0?o[0].value:1;i+='<table class="analysis-table"><thead><tr><th>Rank</th><th>Name</th><th>Value</th><th class="relative-value-header">Relative Value</th></tr></thead><tbody>',o.forEach(((t,a)=>{const n=e>0?Math.min(100,t.value/e*100):0;i+=`<tr>\n                            <td>${a+1}</td>\n                            <td>${truncateText(t.name||"N/A",40)}</td>\n                            <td>${formatCurrency(t.value||0)}</td>\n                            <td class="spark-bar-cell"> \n                                <div class="spark-bar" style="width: ${n}%;" title="${formatCurrency(t.value||0)}"></div>\n                            </td>\n                          </tr>`})),i+="</tbody></table>"}r.innerHTML=i}function displayNaicsTable(e,t,a,n=5){const r=document.getElementById(t);if(!r)return void console.error(`Container element not found: #${t}`);const o=(Array.isArray(e)?e:[]).slice(0,n);let i=`<h3>${a} for ${getAgencyDisplayName()}</h3>`;if(0===o.length)i+='<p class="empty-message">No NAICS data available.</p>';else{const e=o.length>0?o[0].value:1;i+='<table class="analysis-table"><thead><tr><th>Rank</th><th>NAICS</th><th>Value</th><th class="relative-value-header">Relative Value</th></tr></thead><tbody>',o.forEach(((t,a)=>{const n=e>0?Math.min(100,t.value/e*100):0;i+=`<tr>\n                            <td>${a+1}</td>\n \n                            <td>${t.code||"N/A"}&nbsp;-&nbsp;${t.desc?`<span class="naics-desc">${truncateText(t.desc,60)}</span>`:""}</td>\n                            <td>${formatCurrency(t.value||0)}</td>\n                            <td class="spark-bar-cell">\n                                <div class="spark-bar" style="width: ${n}%;" title="${formatCurrency(t.value||0)}"></div>\n                            </td>\n                          </tr>`})),i+="</tbody></table>"}r.innerHTML=i}function aggregateExpiringValueByMonth(e){const t=new Map,a=new Date;a.setDate(1),a.setHours(0,0,0,0);const n=new Date(a);n.setMonth(a.getMonth()+6);for(let e=0;e<6;e++){const n=new Date(a);n.setMonth(a.getMonth()+e);const r=`${n.toLocaleString("default",{month:"short"})} ${n.getFullYear()}`;t.set(r,0)}e.forEach((e=>{if(e.endDate instanceof Date&&!isNaN(e.endDate)&&e.endDate>=a&&e.endDate<n){const a=`${e.endDate.toLocaleString("default",{month:"short"})} ${e.endDate.getFullYear()}`;t.has(a)&&t.set(a,t.get(a)+e.amount)}}));return Array.from(t.keys()).sort(((e,t)=>new Date(e)-new Date(t))).map((e=>({month:e,value:t.get(e)})))}function drawExpiringValueByMonthChart(e,t){const a=d3.select(`#${t}`);if(a.html(""),!e||0===e.length)return void a.html('<span class="chart-placeholder" style="display: block; text-align: center; padding: 20px; font-style: italic;">No expiring contracts found in the next 6 months.</span>');const n=a.node();if(!n)return;const r=20,o=30,i=40,s=70,l=n.clientWidth-s-o,c=200-r-i;if(l<=0||c<=0)return console.warn(`Container #${t} too small for chart.`),void a.html('<span class="chart-placeholder" style="display: block; text-align: center; padding: 10px;">Chart area too small</span>');const d=a.append("svg").attr("width",l+s+o).attr("height",c+r+i).append("g").attr("transform",`translate(${s},${r})`),u=d3.scaleBand().domain(e.map((e=>e.month))).range([0,l]).padding(.2),p=d3.scaleLinear().domain([0,d3.max(e,(e=>e.value))||1]).nice().range([c,0]),m=d3.axisBottom(u),f=d3.axisLeft(p).ticks(5).tickFormat((e=>formatCurrencyWithSuffix(e)));d.append("g").attr("class","x-axis").attr("transform",`translate(0,${c})`).call(m).selectAll("text").style("text-anchor","end").attr("dx","-.8em").attr("dy",".15em").attr("transform","rotate(-30)").style("font-size","9px").style("fill","var(--color-on-surface-variant)"),d.append("g").attr("class","y-axis").call(f).selectAll("text").style("font-size","10px").style("fill","var(--color-on-surface-variant)"),d.selectAll(".domain").attr("stroke","var(--color-outline-variant)"),d.selectAll(".tick line").attr("stroke","var(--color-outline-variant)");const g=d3.select("#tooltip");d.selectAll(".bar").data(e).enter().append("rect").attr("class","bar").attr("x",(e=>u(e.month))).attr("y",(e=>p(e.value))).attr("width",u.bandwidth()).attr("height",(e=>c-p(e.value))).attr("fill","var(--app-accent-color)").style("cursor","pointer").on("mouseover",(function(e,t){d3.select(this).attr("fill","var(--accent-dark)"),g.node()&&(g.html(`<h4>${t.month}</h4><p>Expiring Value: <strong>${formatCurrency(t.value)}</strong></p>`).classed("visible",!0).attr("aria-hidden","false"),positionTooltip(g,e))})).on("mousemove",(function(e){g.node()&&g.classed("visible")&&positionTooltip(g,e)})).on("mouseout",(function(){d3.select(this).attr("fill","var(--app-accent-color)"),g.node()&&hideTooltip()}))}function updateExpiringContracts(e){const t=document.getElementById("expiring-table-content"),a=document.getElementById("load-more-expiring"),n=document.getElementById("export-expiring-csv"),r=document.getElementById("expiring-title");if(r){const e=getAgencyDisplayName();r.textContent=`Expiring ${e} Contracts`}else console.warn("Expiring contracts title element (#expiring-title) not found.");if(!t||!a||!n)return console.error("Expiring contracts UI elements not found. Cannot update list."),void(t&&(t.innerHTML='<p class="empty-message">Error: UI element missing.</p>'));if(t.innerHTML='<p class="empty-message">Checking data...</p>',a.style.display="none",n.style.display="none",!e||0===e.length)return void(t.innerHTML='<p class="empty-message">No contract data available.</p>');const o=new Date;o.setHours(0,0,0,0);const i=new Date;i.setMonth(o.getMonth()+6),i.setHours(23,59,59,999);try{allExpiringContracts=e.filter((e=>{const t=e.prime_award_period_of_performance_potential_end_date;if(("number"==typeof e.subaward_amount?e.subaward_amount:0)<expiringAmountThreshold)return!1;if(!t||"string"!=typeof t)return!1;let a;return a=t.match(/^\d{4}-\d{2}-\d{2}$/)?new Date(t+"T00:00:00"):(t.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/),new Date(t)),!isNaN(a)&&(a>=o&&a<=i)})).map((e=>{const t=e.prime_award_period_of_performance_potential_end_date;let a,n="Invalid Date";return a=t.match(/^\d{4}-\d{2}-\d{2}$/)?new Date(t+"T00:00:00"):(t.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/),new Date(t)),isNaN(a)||(n=a.toLocaleDateString()),{prime:e.prime_awardee_name||"N/A",sub:e.subawardee_name||"N/A",amount:"number"==typeof e.subaward_amount?e.subaward_amount:0,endDate:isNaN(a)?null:a,endDateStr:n,agency:e.prime_award_awarding_agency_name||"N/A",permalink:e.usaspending_permalink||"#",subAgency:e.prime_award_awarding_sub_agency_name||"N/A",office:e.prime_award_awarding_office_name||"N/A",naicsCode:e.prime_award_naics_code||"N/A",subAwardDesc:e.subaward_description||"N/A"}})).filter((e=>null!==e.endDate)).sort(compareValues(expiringSortKey,expiringSortDirection));try{drawExpiringValueByMonthChart(aggregateExpiringValueByMonth(allExpiringContracts),"expiring-value-by-month-chart")}catch(e){console.error("Error creating expiring value chart:",e),d3.select("#expiring-value-by-month-chart").html('<span class="chart-placeholder error">Could not load chart</span>')}displayedExpiringCount=0,t.innerHTML="",displayExpiringContracts(),allExpiringContracts.length>0?(n.style.display="inline-flex",n.disabled=!1):(n.style.display="none",n.disabled=!0)}catch(e){console.error("Error processing expiring contracts:",e),t.innerHTML='<p class="empty-message">Error processing expiring contracts data.</p>',n.style.display="none"}}document.addEventListener("DOMContentLoaded",(async function(){window.appInitialized=!1;try{document.getElementById("theme-toggle").addEventListener("click",toggleTheme),document.getElementById("agency-selector").addEventListener("change",changeAgency),document.getElementById("min-value").addEventListener("input",debounceMinValueUpdate),document.getElementById("reset-filters").addEventListener("click",(()=>resetFilters(!0))),document.getElementById("info-panel-close").addEventListener("click",closeInfoPanel),document.getElementById("breadcrumb").addEventListener("click",handleBreadcrumbClick);function e(){const e=document.querySelectorAll(".filter-row"),t=window.innerWidth<600;e.forEach((e=>{e.querySelectorAll(".filter-column").forEach((e=>{e.style.width=t?"100%":"calc(50% - 4px)",e.style.marginBottom=t?"8px":"0"}))}))}document.querySelectorAll("#level-filters button").forEach((e=>{e.addEventListener("click",toggleLevelFilter)})),document.querySelectorAll(".filter-section > summary").forEach((e=>{e.addEventListener("click",(function(t){this.parentElement.getAttribute("data-section")||e.querySelector("h3")}))}));const t=document.getElementById("share-button");t?t.addEventListener("click",(async()=>{const e=window.location.href,t={title:document.title,text:"Check out Subhoo - Federal Subcontractor Intelligence!",url:e};if(navigator.share)try{await navigator.share(t)}catch(e){"AbortError"!==e.name&&(console.error("Error sharing:",e),showNotification(`Could not share: ${e.message}`,"error"))}else{console.warn("Web Share API not supported. Attempting to copy URL to clipboard.");try{await navigator.clipboard.writeText(e),showNotification("Link copied to clipboard!","info")}catch(e){console.error("Failed to copy URL to clipboard:",e),showNotification("Sharing not supported & failed to copy link. Please copy the URL manually.","warning")}}})):console.warn("Share button element (#share-button) not found when attaching listener.");const a=document.getElementById("export-expiring-csv");a&&a.addEventListener("click",exportExpiringContractsCSV),e(),window.addEventListener("resize",e),setupVisualizationToggle(),setupResponsiveVisualization(),setTimeout(setupStatsCardTooltips,500),addCssFixes(),setupEnhancedFilters(),restoreFilterSectionStates();const n=document.getElementById("load-more-expiring");n&&n.addEventListener("click",loadMoreExpiringContracts)}catch(r){console.error("Error attaching initial event listeners:",r)}initializeColorScale(),await discoverAgencies(),window.appInitialized=!0}));const expiringTableColumns=[{key:"endDateStr",header:"Potential End",sortable:!0,dataKey:"endDate"},{key:"subAgency",header:"Sub Agency",sortable:!0,truncate:30},{key:"office",header:"Office",sortable:!0,truncate:30},{key:"prime",header:"Prime Contractor",sortable:!0,truncate:35},{key:"sub",header:"Subcontractor",sortable:!0,truncate:35},{key:"amount",header:"Amount",sortable:!0,align:"right",format:"currency"},{key:"subAwardDesc",header:"Description",sortable:!1,truncate:50},{key:"naicsCode",header:"NAICS",sortable:!0},{key:"permalink",header:"USAspending Link",sortable:!1,align:"center",format:"link"}];function displayExpiringContracts(){const e=document.getElementById("expiring-table-content"),t=document.getElementById("load-more-expiring"),a=document.getElementById("export-expiring-csv");if(!e||!t||!a)return console.error("Missing UI elements for displayExpiringContracts."),void(e&&(e.innerHTML='<p class="empty-message">Error: UI element missing.</p>'));const n=0===displayedExpiringCount?itemsPerLoad:displayedExpiringCount,r=allExpiringContracts.slice(0,n);let o="";0===r.length&&0===displayedExpiringCount?(o=`<p class="empty-message">No contracts found potentially expiring > ${formatCurrency(expiringAmountThreshold)} in the next 6 months.</p>`,t.style.display="none",a.style.display="none",a.disabled=!0):0===r.length&&displayedExpiringCount>0?(console.warn("displayExpiringContracts called with 0 items to display but non-zero displayed count."),o=e.innerHTML):(o='<table class="expiring-contracts-table"><thead><tr>',expiringTableColumns.forEach((e=>{let t="",a="",n=e.header;e.align&&(t+=` align-${e.align}`),e.sortable&&(t+=" sortable",a+=` data-sort-key="${e.dataKey||e.key}"`,(e.dataKey||e.key)===expiringSortKey&&(t+=` sorted-${expiringSortDirection}`)),o+=`<th class="${t.trim()}" ${a}>${n}</th>`})),o+="</tr></thead><tbody>",r.forEach((e=>{o+="<tr>",expiringTableColumns.forEach((t=>{let a=e[t.key]??"N/A",n=t.align?`align-${t.align}`:"";const r="string"==typeof e[t.key]||"number"==typeof e[t.key]?`title="${String(e[t.key]).replace(/"/g,"&quot;")}"`:"";if("currency"===t.format)a=formatCurrency(a),n+=" amount";else if("link"===t.format){const e=a&&"#"!==a&&"string"==typeof a&&a.startsWith("http");a=e?`<a href="${a}" class="detail-link" target="_blank" rel="noopener noreferrer" title="View on USAspending.gov">View</a>`:"N/A",n+=" align-center"}else t.truncate&&"function"==typeof truncateText&&(a=truncateText(String(a),t.truncate)),n+=` cell-${t.key}`;o+=`<td class="${n.trim()}" ${r}>${a}</td>`})),o+="</tr>"})),o+="</tbody></table>",displayedExpiringCount=r.length,allExpiringContracts.length>displayedExpiringCount?(t.textContent=`Load More (${allExpiringContracts.length-displayedExpiringCount} remaining)`,t.style.display="inline-flex",t.disabled=!1):t.style.display="none",a.style.display="inline-flex",a.disabled=!1),e.innerHTML=o,attachExpiringTableSortListener()}function loadMoreExpiringContracts(){const e=document.getElementById("load-more-expiring"),t=document.querySelector("#expiring-table-content .expiring-contracts-table tbody");if(!t)return console.error("Cannot find expiring contracts table body to append rows."),void(e&&(e.style.display="none"));if(!e||allExpiringContracts.length<=displayedExpiringCount)return console.warn("Load More called, but no more items or button not found."),void(e&&(e.style.display="none"));e.disabled=!0,e.textContent="Loading...";const a=displayedExpiringCount,n=a+50,r=allExpiringContracts.slice(a,n);if(0===r.length)return e.style.display="none",void(e.disabled=!1);const o=r.map((e=>{let t="<tr>";return expiringTableColumns.forEach((a=>{let n=e[a.key]??"N/A",r=a.align?`align-${a.align}`:"";const o="string"==typeof e[a.key]||"number"==typeof e[a.key]?`title="${String(e[a.key]).replace(/"/g,"&quot;")}"`:"";if("currency"===a.format)n=formatCurrency(n),r+=" amount";else if("link"===a.format){const e=n&&"#"!==n&&"string"==typeof n&&n.startsWith("http");n=e?`<a href="${n}" class="detail-link" target="_blank" rel="noopener noreferrer" title="View on USAspending.gov">View</a>`:"N/A",r+=" align-center"}else a.truncate&&"function"==typeof truncateText&&(n=truncateText(String(n),a.truncate)),r+=` cell-${a.key}`;t+=`<td class="${r.trim()}" ${o}>${n}</td>`})),t+="</tr>",t})).join("");t.insertAdjacentHTML("beforeend",o),displayedExpiringCount=Math.min(n,allExpiringContracts.length),allExpiringContracts.length>displayedExpiringCount?(e.textContent=`Load More (${allExpiringContracts.length-displayedExpiringCount} remaining)`,e.disabled=!1):e.style.display="none"}function handleExpiringHeaderClick(e){const t=e.target.closest("th.sortable");if(!t)return;const a=t.dataset.sortKey;a&&(expiringSortKey===a?expiringSortDirection="asc"===expiringSortDirection?"desc":"asc":(expiringSortKey=a,expiringSortDirection="asc"),allExpiringContracts.sort(compareValues(expiringSortKey,expiringSortDirection)),displayedExpiringCount=0,displayExpiringContracts())}function attachExpiringTableSortListener(){const e=document.getElementById("expiring-table-content");e&&(e.removeEventListener("click",handleExpiringHeaderClick),e.addEventListener("click",handleExpiringHeaderClick))}function exportExpiringContractsCSV(){if(!allExpiringContracts||0===allExpiringContracts.length)return void showNotification("No expiring contracts data to export.","warning");const e=[{key:"endDateStr",header:"Potential End Date"},{key:"agency",header:"Awarding Agency"},{key:"subAgency",header:"Awarding Sub Agency"},{key:"office",header:"Awarding Office"},{key:"prime",header:"Prime Contractor Name"},{key:"sub",header:"Subcontractor Name"},{key:"amount",header:"Subaward Amount"},{key:"subAwardDesc",header:"Subaward Description"},{key:"naicsCode",header:"NAICS Code"},{key:"permalink",header:"USAspending Link"}],t=e=>{if(null==e)return"";const t=String(e);return t.includes('"')||t.includes(",")||t.includes("\n")?`"${t.replace(/"/g,'""')}"`:t},a=[e.map((e=>t(e.header))).join(","),...allExpiringContracts.map((a=>e.map((e=>{let n=a[e.key];return"amount"===e.key&&"number"==typeof n?n:t(n)})).join(",")))].join("\n"),n=new Blob(["\ufeff"+a],{type:"text/csv;charset=utf-8;"}),r=URL.createObjectURL(n),o=document.createElement("a"),i=(new Date).toISOString().slice(0,10);o.setAttribute("href",r),o.setAttribute("download",`expiring_contracts_${currentAgency}_${i}.csv`),o.style.visibility="hidden",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(r),showNotification("Expiring contracts CSV export started.","info")}function showNotification(e,t="info"){let a=document.getElementById("notification-container");a||(a=document.createElement("div"),a.id="notification-container",Object.assign(a.style,{position:"fixed",top:"10px",right:"10px",zIndex:"1000",maxWidth:"90vw"}),document.body.appendChild(a));const n=document.createElement("div");n.className=`notification ${t}`,n.innerHTML=`<div class="notification-content">${e}</div><button class="notification-close" aria-label="Dismiss">&times;</button>`,Object.assign(n.style,{backgroundColor:"error"===t?"var(--md-sys-color-error-container)":"var(--md-sys-color-primary-container)",color:"error"===t?"var(--md-sys-color-on-error-container)":"var(--md-sys-color-on-primary-container)",padding:"10px 16px",marginBottom:"10px",borderRadius:"8px",boxShadow:"var(--md-sys-elevation-2)",display:"flex",justifyContent:"space-between",alignItems:"center",animation:"notification-slide-in 0.3s ease forwards",opacity:"0",transform:"translateX(20px)"});const r=n.querySelector(".notification-close");Object.assign(r.style,{background:"none",border:"none",fontSize:"20px",cursor:"pointer",marginLeft:"10px",opacity:"0.7"});const o=()=>{n.style.animation="notification-slide-out 0.3s ease forwards",setTimeout((()=>n.remove()),300)};if(r.addEventListener("click",o),"error"!==t&&setTimeout((()=>{n.parentNode&&o()}),5e3),a.appendChild(n),setTimeout((()=>{n.style.opacity="1",n.style.transform="translateX(0)"}),10),!document.getElementById("notification-keyframes")){const e=document.createElement("style");e.id="notification-keyframes",e.textContent="\n            @keyframes notification-slide-in {\n                from { opacity: 0; transform: translateX(20px); }\n                to { opacity: 1; transform: translateX(0); }\n            }\n            @keyframes notification-slide-out {\n                from { opacity: 1; transform: translateX(0); }\n                to { opacity: 0; transform: translateX(20px); }\n            }\n        ",document.head.appendChild(e)}}function formatCurrencyWithSuffix(e){if("number"!=typeof e||isNaN(e))try{const t=String(e).replace(/[^\d.-]+/g,"");if(e=parseFloat(t),isNaN(e))return"$0"}catch(e){return"$0"}return Math.abs(e)>=1e9?`$${(e/1e9).toFixed(2)}B`:Math.abs(e)>=1e6?`$${(e/1e6).toFixed(1)}M`:Math.abs(e)>=1e3?`$${(e/1e3).toFixed(0)}K`:new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(e)}function formatCurrency(e){return"number"!=typeof e||isNaN(e)?"$?":new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(e)}function capitalizeFirstLetter(e){return e&&"string"==typeof e?e.charAt(0).toUpperCase()+e.slice(1):""}function truncateText(e,t){return e?e.length>t?e.substring(0,t-3)+"...":e:""}function extractAcronym(e){if(!e||"string"!=typeof e)return null;const t=e.match(/\(([A-Z]{2,})\)$/);return t&&t[1]?t[1]:null}function getStateFullName(e){return{AL:"Alabama",AK:"Alaska",AZ:"Arizona",AR:"Arkansas",CA:"California",CO:"Colorado",CT:"Connecticut",DE:"Delaware",FL:"Florida",GA:"Georgia",HI:"Hawaii",ID:"Idaho",IL:"Illinois",IN:"Indiana",IA:"Iowa",KS:"Kansas",KY:"Kentucky",LA:"Louisiana",ME:"Maine",MD:"Maryland",MA:"Massachusetts",MI:"Michigan",MN:"Minnesota",MS:"Mississippi",MO:"Missouri",MT:"Montana",NE:"Nebraska",NV:"Nevada",NH:"New Hampshire",NJ:"New Jersey",NM:"New Mexico",NY:"New York",NC:"North Carolina",ND:"North Dakota",OH:"Ohio",OK:"Oklahoma",OR:"Oregon",PA:"Pennsylvania",RI:"Rhode Island",SC:"South Carolina",SD:"South Dakota",TN:"Tennessee",TX:"Texas",UT:"Utah",VT:"Vermont",VA:"Virginia",WA:"Washington",WV:"West Virginia",WI:"Wisconsin",WY:"Wyoming",DC:"District of Columbia",PR:"Puerto Rico",VI:"Virgin Islands",GU:"Guam",AS:"American Samoa",MP:"Northern Mariana Islands"}[e]||e}function getAgencyDisplayName(){const e=document.getElementById("agency-selector");if(!e)return currentAgency?currentAgency.toUpperCase():"N/A";const t=e.options[e.selectedIndex];return t?t.textContent:currentAgency?currentAgency.toUpperCase():"N/A"}function compareValues(e,t="asc"){return function(a,n){const r=a.hasOwnProperty(e)?a[e]:null,o=n.hasOwnProperty(e)?n[e]:null;let i=0;if(null==r)i=null==o?0:1;else if(null==o)i=-1;else if("endDate"===e||r instanceof Date&&o instanceof Date){const e=isNaN(r)?null:r.getTime(),t=isNaN(o)?null:o.getTime();i=null===e&&null===t?0:null===e?1:null===t?-1:e-t}else if("subaward_amount"===e||"amount"===e||"number"==typeof r&&"number"==typeof o){const e=Number(r),t=Number(o);i=isNaN(e)&&isNaN(t)?0:isNaN(e)?1:isNaN(t)?-1:e-t}else i=String(r).toLowerCase().localeCompare(String(o).toLowerCase());return"desc"===t?-1*i:i}}function handleHeaderClick(e){e&&(tableSortKey===e?tableSortDirection="asc"===tableSortDirection?"desc":"asc":(tableSortKey=e,tableSortDirection="asc"),updateDataTable())}function isMobileDevice(){return window.innerWidth<=768||"ontouchstart"in window||navigator.maxTouchPoints>0}function isTouchDevice(){return"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0}function drawNaicsDonut(e,t,a=5){const n=d3.select(`#${t}`);if(n.html(""),!e||!Array.isArray(e))return console.warn("drawNaicsDonut: Invalid naicsData input",e),void n.html('<span class="chart-placeholder">Invalid data</span>');if(0===e.length)return void n.html('<span class="chart-placeholder">No NAICS data</span>');const r=e.slice(0,a),o=d3.sum(e.slice(a),(e=>e.value)),i=[...r];let s=!1;o>0&&(i.push({code:"Other",desc:"All Other NAICS Codes",value:o}),s=!0);const l=e[0];if(1===i.length&&s)return void n.html('<span class="chart-placeholder">Value primarily in "Other" NAICS</span>');if(0===i.length||!l)return void n.html('<span class="chart-placeholder">No Top NAICS data</span>');const c=n.node();if(!c)return void console.error(`drawNaicsDonut: Container node #${t} not found.`);const d=c.clientWidth,u=Math.max(130,c.clientHeight||130),p=Math.min(d,u)/2-5,m=.68*p;if(d<=0||u<=0||p<=10)return console.warn(`Container #${t} too small or zero dimensions. Width: ${d}, Height: ${u}, Radius: ${p}`),n.style("height","130px"),void n.html('<span class="chart-placeholder">Chart area too small</span>');n.style("height",`${u}px`);const f=n.append("svg").attr("width",d).attr("height",u).style("overflow","hidden").append("g").attr("transform",`translate(${d/2},${u/2})`),g=monochromaticPurpleScale.range(),y=d3.scaleOrdinal(g),h=d3.pie().padAngle(.005).value((e=>e.value)).sort(null),b=d3.arc().innerRadius(m).outerRadius(p),w=d3.arc().innerRadius(.9*p).outerRadius(.9*p),v=(f.selectAll(".arc-path").data(h(i)).join("path").attr("class","arc-path").attr("fill",((e,t)=>y(t%g.length))).attr("d",b).attr("stroke","var(--color-surface)").style("stroke-width","1px"),f.append("text").attr("text-anchor","middle").style("font-family","var(--font-primary)").style("fill","var(--color-on-surface)").attr("dy","-0.3em"));if(v.append("tspan").attr("x",0).attr("dy",0).style("font-size","0.8em").style("fill","var(--color-on-surface-variant)").text("Top NAICS"),v.append("tspan").attr("x",0).attr("dy","1.2em").style("font-size","0.9em").style("font-weight","600").text(l.code),window.innerWidth>600){const e=.07,t=h(i).filter((t=>(t.endAngle-t.startAngle)/(2*Math.PI)>e));if(t.length>0){const e=f.append("g").attr("class","labels"),a="font-size: 0.85em; fill: var(--color-on-surface-variant);";f.append("g").attr("class","lines").selectAll("polyline").data(t).join("polyline").attr("stroke","var(--color-on-surface-variant, #999)").style("fill","none").attr("stroke-width",1).attr("points",(e=>{const t=b.centroid(e),a=w.centroid(e),n=w.centroid(e),r=e.startAngle+(e.endAngle-e.startAngle)/2;return n[0]=(p+5)*(r<Math.PI?1:-1),[t,a,n]}));const n=e.selectAll("text").data(t).join("text").attr("transform",(e=>{const t=w.centroid(e),a=e.startAngle+(e.endAngle-e.startAngle)/2;return t[0]=(p+10)*(a<Math.PI?1:-1),`translate(${t})`})).style("text-anchor",(e=>e.startAngle+(e.endAngle-e.startAngle)/2<Math.PI?"start":"end")).style("font-size","10px").style("fill","var(--color-on-surface)").attr("dy","-0.3em");n.append("tspan").attr("x",0).text((e=>e.data.code)),n.filter((e=>"Other"!==e.data.code)).append("tspan").attr("x",0).attr("dy","1.1em").attr("style",a).text((e=>truncateText(e.data.desc,20)))}}}function drawTopNBarChart(e,t,a,n,r,o=5){const i=d3.select(`#${t}`);i.html("");const s=document.getElementById(a);if(s)if("prime"===r){const e=1===n?"Prime w/ Subs":"Primes w/ Subs";s.innerHTML=`${n.toLocaleString()} ${e}`}else if("sub"===r)s.innerHTML=`${n.toLocaleString()} Total Subs`;else{const e="Items";s.innerHTML=`${n.toLocaleString()} ${e}`}if(!e||0===e.length)return i.html('<span class="chart-placeholder">No data</span>'),void(s&&(s.innerHTML="prime"===r?"0 Primes w/ Subs":"sub"===r?"Total Subs":"0 Items"));const l=e.slice(0,o),c=i.node();if(!c)return;const d=c.clientWidth;let u=Math.max(60,18*l.length+5+5);i.style("height",`${u}px`);const p=i.append("svg").attr("width",d).attr("height",u).attr("viewBox",[0,0,d,u]),m=d3.scaleLinear().domain([0,d3.max(l,(e=>e.value))||1]).nice().range([85,d-10]),f=d3.scaleBand().domain(l.map((e=>e.name))).range([5,u-5]).padding(.15);p.append("g").attr("fill","var(--app-accent-color)").selectAll("rect").data(l).join("rect").attr("x",m(0)).attr("y",(e=>f(e.name))).attr("width",(e=>Math.max(0,m(e.value)-m(0)))).attr("height",f.bandwidth()).style("cursor","pointer").on("mouseover",(function(e,t){const a=d3.select("#tooltip");let n=`<h4>${t.name}</h4><p><strong>Value:</strong> ${formatCurrency(t.value)}</p>`;a.html(n).classed("visible",!0).attr("aria-hidden","false"),positionTooltip(a,e),d3.select(this).attr("fill","var(--primary-dark)")})).on("mouseout",(function(){hideTooltip(),d3.select(this).attr("fill","var(--app-accent-color)")})),p.append("g").attr("class","y-axis-labels").style("font-size","10px").attr("transform","translate(5, 0)").selectAll("text").data(l).join("text").attr("x",0).attr("y",(e=>f(e.name)+f.bandwidth()/2)).attr("dy","0.35em").attr("text-anchor","start").style("fill","var(--color-on-surface)").text((e=>truncateText(e.name,12))).style("cursor","default").append("title").text((e=>e.name))}function adaptPrimeContractData(e){if(!e||!Array.isArray(e))return console.error("Invalid prime contract data provided"),[];const t=new Map;return e.forEach((e=>{const a=e.award_id_piid||e.contract_award_unique_key||e.award_id;if(!a)return;const n="number"==typeof e.current_total_value_of_award?e.current_total_value_of_award:parseFloat(String(e.current_total_value_of_award||"0").replace(/[^0-9.-]+/g,""))||0;n<0||t.has(a)||t.set(a,{...e,processed_contract_value:n})})),Array.from(t.values()).map((e=>{const t=e.processed_contract_value||0;return{prime_awardee_name:e.recipient_name||"Unknown Prime Contractor",prime_award_awarding_agency_name:e.awarding_agency_name||"Unknown Agency",prime_award_awarding_sub_agency_name:e.awarding_sub_agency_name||"Unknown Sub-Agency",prime_award_awarding_office_name:e.awarding_office_name||"Unknown Office",prime_award_naics_code:e.naics_code||"Unknown",prime_award_naics_description:e.naics_description||"Unknown",prime_award_period_of_performance_potential_end_date:e.period_of_performance_current_end_date||null,subawardee_name:null,subaward_amount:t,subaward_primary_place_of_performance_state_code:e.primary_place_of_performance_state_code||"Unknown",subaward_place_of_performance_cd_current:e.prime_award_transaction_place_of_performance_cd_current||"Unknown",usaspending_permalink:e.usaspending_permalink||"#",subaward_description:e.transaction_description||e.award_description||e.prime_award_base_transaction_description||"No description available",subawardee_business_types:"Prime Contract",is_prime_contract:!0,contract_id:e.award_id_piid||e.contract_award_unique_key||e.award_id||"unknown"}}))}